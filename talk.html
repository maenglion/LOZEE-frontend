<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    :root {
  --primary-color: #6e8efb;
  --secondary-color: #354157;
  --background-color: #2a3340;
  --text-color: #fff;
  --input-background: #f0f0f0;
  --bot-bubble-bg: #f0f0f0;
  --bot-bubble-text: #333;
  --user-bubble-bg: #6e8efb; /* ì‚¬ìš©ì ë§í’ì„ ì€ ì›ë˜ ì´ ìƒ‰ì´ì—ˆìŠµë‹ˆë‹¤ */
  --user-bubble-text: #fff;   /* ì‚¬ìš©ì ë§í’ì„  ê¸€ì”¨ë„ í°ìƒ‰ */
  --gnb-height: 56px;
  --chat-input-height: 70px;
  --gemini-purple: #7B68EE; /* GNB ì œëª© ë° ë©”ë‰´ í† ê¸€ ì›ë˜ ìƒ‰ìƒ */
  --volume-meter-default-bg: var(--primary-color);
  --meter-top-margin: 8px;
  --gnb-dropdown-border-color: #4a5568;
}

body {
  margin: 0;
  padding-top: var(--gnb-height);
  font-family: 'KoPub World Dotum', sans-serif;
  /* ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ ì ìš© */
  background: linear-gradient(135deg, var(--background-color-gradient-start), var(--background-color-gradient-end));
  color: var(--text-color); /* ì£¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ, í°ìƒ‰ ìœ ì§€ ë˜ëŠ” ì–´ë‘ìš´ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
  display: flex;
  flex-direction: column;
  height: 100vh;
  box-sizing: border-box;
  overflow: hidden;
}

/* GNB ë° ì±„íŒ… ì…ë ¥ì°½ ë°°ê²½ì€ ê·¸ë¼ë°ì´ì…˜ê³¼ ì–´ìš¸ë¦¬ë„ë¡ ë°˜íˆ¬ëª… í°ìƒ‰ ë˜ëŠ” ë‹¨ìƒ‰ìœ¼ë¡œ ì¡°ì • ê°€ëŠ¥ */
#gnb {
  /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
  background-color: rgba(255, 255, 255, 0.15); /* ì˜ˆì‹œ: ì•½ê°„ íˆ¬ëª…í•œ í°ìƒ‰ ë°°ê²½ */
  backdrop-filter: blur(10px); /* (ì„ íƒì‚¬í•­) ë¸”ëŸ¬ íš¨ê³¼ë¡œ ê³ ê¸‰ìŠ¤ëŸ¬ì›€ ì¶”ê°€ */
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* ê·¸ë¦¼ì ì•½ê°„ ì—°í•˜ê²Œ */
}
#gnb-title {
  color: #ffffff; /* GNB ë°°ê²½ì´ ë°ì•„ì§€ë©´ ì œëª© ìƒ‰ìƒ ë³€ê²½ ê°€ëŠ¥ */
}
#menu-toggle {
    color: #ffffff; /* GNB ë°°ê²½ì´ ë°ì•„ì§€ë©´ ë©”ë‰´ í† ê¸€ ìƒ‰ìƒ ë³€ê²½ ê°€ëŠ¥ */
}

#chat-input-container {
  /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
  background-color: rgba(255, 255, 255, 0.2); /* ì˜ˆì‹œ: ì•½ê°„ íˆ¬ëª…í•œ í°ìƒ‰ ë°°ê²½ */
  backdrop-filter: blur(5px);
}

#chat-input {
  /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
  background-color: var(--input-background); /* ì´ë¯¸ í°ìƒ‰ ê³„ì—´ */
  color: #333; /* ì…ë ¥ ê¸€ì”¨ëŠ” ì–´ë‘¡ê²Œ */
  border: 1px solid #d0d0d0; /* í…Œë‘ë¦¬ ì•½ê°„ ì—°í•˜ê²Œ */
}

/* ë“œë¡­ë‹¤ìš´ ë©”ë‰´, ìŒëŸ‰ ë°” ë“±ë„ í•„ìš”ì‹œ ìƒ‰ìƒ ì¡°ì • */
#dropdown-menu {
    background-color: rgba(40, 50, 65, 0.9); /* ì•½ê°„ ì–´ë‘ìš´ ë°˜íˆ¬ëª… ë°°ê²½ ìœ ì§€ */
    backdrop-filter: blur(5px);
}
#dropdown-menu a {
    border-bottom: 1px solid var(--gnb-dropdown-border-color);
}
#dropdown-menu a:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

/* ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë©”ì‹œì§€ ë²„ë¸” ë°°ê²½ìƒ‰ ë³€ê²½ */
.bubble.system-error {
    background-color: #ffe0e0; /* ì—°í•œ í•‘í¬/ë¹¨ê°• */
    color: #c0392b; /* ì–´ë‘ìš´ ë¹¨ê°• ê¸€ì”¨ */
    border: 1px solid #e74c3c;
}

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* GNB (í–„ë²„ê±° ë©”ë‰´) */
    #gnb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--background-color);
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gemini-purple);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gemini-purple);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--background-color);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.25);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 500px;
    }

    #dropdown-menu a {
      display: block;
      color: var(--text-color);
      text-decoration: none;
      padding: 12px 16px;
      font-size: 0.95em;
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child { border-bottom: none; }
    #dropdown-menu a:hover {
      background-color: var(--secondary-color);
    }

    /* ìŒëŸ‰ ë°” */
    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: 6px;
      background-color: var(--secondary-color);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-meter { width:100%; height:100%; }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-default-bg);
      border-radius: 3px;
      transition: width 0.05s linear;
    }

    /* ì±„íŒ… ì˜ì—­ */
    #chat-container {
      flex-grow: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + 6px + 16px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: var(--chat-input-height);
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.5;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background-color: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.bot {
      background-color: var(--bot-bubble-bg);
      color: var(--bot-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.user.interim { opacity:.7; }
    .bubble.system-error { /* ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        background-color: #ffdddd;
        color: #d32f2f;
        align-self: center;
        max-width: 80%;
        text-align: center;
        font-size: 0.9em;
        border: 1px solid #d32f2f;
    }


    /* ì…ë ¥ ì˜ì—­ */
    #chat-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-height);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background-color: var(--secondary-color);
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 22px;
      border: 1px solid var(--gnb-dropdown-border-color);
      font-size: 1em;
      background-color: var(--input-background);
      color: #333;
      height: 44px;
      box-sizing: border-box;
    }
    #chat-input::placeholder { color: #777; }

    #mic-button,
    #send-button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: var(--text-color);
      font-size: 1.3em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover,
    #send-button:hover { background-color: #5a7edf; }
    #mic-button.disabled,
    #send-button.disabled {
      opacity:.5;
      cursor:default;
      background-color: #999;
    }
    #send-button.loading { background:#999; cursor:default; }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-container::-webkit-scrollbar-thumb { background: var(--gnb-dropdown-border-color); border-radius: 4px; }
    #chat-container::-webkit-scrollbar-thumb:hover { background: #5a7edf; }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (ì¤€ë¹„ì¤‘)</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ìµœê·¼ ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ì£¼ì œë³„ ëŒ€í™” ëª©ë¡</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ì†Œê°œ</a>
    </div>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>

  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off"/>
    <button id="send-button" title="ë©”ì‹œì§€ ì „ì†¡">â®</button>
  </div>

  <script src="./js/gpt-dialog.js"></script>
  <script src="./js/tts.js"></script>

<script>
// â”€â”€ 1. ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸° ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let chatContainer, chatInput, sendButton, micButton;
  let playTTSFunction, currentDefaultVoice, lsSelectedVoice;
  let recognition, isRecognizing = false;
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  // ëŒ€í™” ê¸°ë¡ ë° ì‚¬ìš©ì ì •ë³´
  let chatHistory = [];
  let userAge, userName, userId, userDisease, selectedTopic;

  // ì„ í˜¸ë„ ìˆœìœ„ ë§¤ê¸°ê¸°(AHP)ìš©
  let isInRankingMode = false, rankingType = null;
  let itemsToRank = [], comparisonPairs = [], currentPairIndex = 0;
  let comparisonScores = {}, MAX_ITEMS_TO_RANK = 5;

 // â”€â”€ 2. ìœ í‹¸ í•¨ìˆ˜: ë§í’ì„ , ë¡œë”©, ì¤‘ê°„ ê²°ê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function appendBubble(content, role, choices = null) {
    const el = document.createElement('div');
    el.className = `bubble ${role}`;
    if (typeof content === 'string') el.textContent = content;
    else el.appendChild(content);
    if (role === 'system-error') el.classList.add('system-error');
    if (choices) {
      const box = document.createElement('div');
      choices.forEach(ch => {
        const btn = document.createElement('button');
        btn.textContent = ch.text;
        btn.onclick = () => {
          box.querySelectorAll('button').forEach(b=>b.disabled=true);
          ch.action(ch.value);
        };
        box.appendChild(btn);
      });
      el.appendChild(box);
    }
    chatContainer.appendChild(el);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function setLoading(flag) {
    sendButton.disabled = flag;
    if (micButton) micButton.disabled = flag && !isRecognizing;
    sendButton.classList.toggle('loading', flag);
  }

  function showInterim(text) {
    let el = document.querySelector('.bubble.user.interim');
    if (!el) {
      el = document.createElement('div');
      el.className = 'bubble user interim';
      chatContainer.appendChild(el);
    }
    el.textContent = text;
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
// â”€â”€ 3. AHP ì„ í˜¸ë„ ìˆœìœ„ ë§¤ê¸°ê¸° ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startRankingProcess(type) {
    isInRankingMode = true; rankingType = type;
    itemsToRank = []; comparisonPairs = []; currentPairIndex = 0;
    comparisonScores = {};
    appendBubble(`ë¬´ì—‡ì„ ${type==='likes'?'ì œì¼ ì¢‹ì•„':'ì œì¼ ì‹«ì–´'}í•˜ëŠ”ì§€ ${MAX_ITEMS_TO_RANK}ê°œ ì •ë„ ì‰¼í‘œë¡œ ì•Œë ¤ì¤„ë˜?`, 'bot');
    playTTSFunction?.(`ë¬´ì—‡ì„ ${type==='likes'?'ì œì¼ ì¢‹ì•„':'ì œì¼ ì‹«ì–´'}í•˜ëŠ”ì§€ ${MAX_ITEMS_TO_RANK}ê°œ ì •ë„ ì‰¼í‘œë¡œ ì•Œë ¤ì¤„ë˜?`, lsSelectedVoice);
  }

  function handleRankingItemInput(text) {
    itemsToRank = text.split(',').map(s=>s.trim()).filter(Boolean).slice(0,MAX_ITEMS_TO_RANK);
    if (itemsToRank.length < 2) {
      appendBubble(`ìµœì†Œ ë‘ ê°œ ì´ìƒ ë§í•´ì¤˜ì•¼ ìˆœìœ„ë¥¼ ì •í•  ìˆ˜ ìˆì–´.`, 'bot');
      return;
    }
    itemsToRank.forEach(item=>comparisonScores[item]=0);
    for(let i=0;i<itemsToRank.length;i++){
      for(let j=i+1;j<itemsToRank.length;j++){
        comparisonPairs.push([itemsToRank[i], itemsToRank[j]]);
      }
    }
    askNextComparison();
  }

  function askNextComparison() {
    if (currentPairIndex >= comparisonPairs.length) return finishRanking();
    const [a,b] = comparisonPairs[currentPairIndex];
    appendBubble(`${a}ê³¼ ${b}, ì–´ëŠ ìª½ì´ ë” ${rankingType==='likes'?'ì¢‹ì•„':'ì‹«ì–´'}?`, 'bot', [
      { text: a, value: a, action: choice=>recordChoice(choice,b) },
      { text: b, value: b, action: choice=>recordChoice(choice,a) },
    ]);
  }

  function recordChoice(chosen, other) {
    appendBubble(chosen, 'user');
    comparisonScores[chosen]++;
    currentPairIndex++;
    askNextComparison();
  }

  function finishRanking() {
    const sorted = [...itemsToRank].sort((x,y)=>comparisonScores[y]-comparisonScores[x]);
    let text = `ë„¤ ì„ í˜¸ë„ ìˆœìœ„:\n` + sorted.map((it,i)=>`${i+1}. ${it}`).join('\n');
    appendBubble(text, 'bot');
    playTTSFunction?.(text, lsSelectedVoice);
    
    // ëŒ€í™”ë¡œ ì—°ê²°í•  ì„ íƒì§€
    setTimeout(()=>{
      appendBubble(`ì´ ì¤‘ì—ì„œ ë” ì´ì•¼ê¸°í•˜ê³  ì‹¶ì€ ê²ƒì€?`, 'bot', sorted.slice(0,3).map((it,i)=>({
        text: `${i+1}. ${it}`, value: it, action:item=>discussRankedItem(item,i+1)
      })).concat([{ text:'ë‹¤ë¥¸ ì´ì•¼ê¸°', action:()=>{isInRankingMode=false;} }]));
    },500);
    isInRankingMode=false;
  }

  function discussRankedItem(item, rank) {
    appendBubble(`${item} ì´ì•¼ê¸°í•´ë³¼ê²Œ!`, 'user');
    const topic = { type:'ranked_preference', preference_type: rankingType, item, rank };
    localStorage.setItem('lozee_last_active_topic',JSON.stringify(topic));
    const first = window.LOZEE_DIALOG.getFirstQuestion(userAge,topic);
    appendBubble(first,'bot');
    playTTSFunction?.(first, lsSelectedVoice);
    chatHistory.push({role:'bot', content:first, timestamp: new Date().toISOString()});
  }

  async function handleUserText(rawText) {
  const text = rawText.trim();
  if (!text) return;

  appendBubble(text, 'user');
  setLoading(true);

  // â”€â”€ a) â€œì—¬ê¸´ ì—†ì–´(ì§ì ‘ ë§í• ë˜ìš”)â€ íë¦„ â”€â”€
  if (awaitingManualTopic) {
    // ì‚¬ìš©ìê°€ â€œíŠ¹ë³„í•œ ì£¼ì œ ì—†ìŒâ€ ì˜ì‚¬ í‘œí˜„
    if (/ì—†|ëª¨ë¥´ê² /.test(text)) {
      appendBubble(
        "ì•„ì§ ë”±íˆ ë§í•˜ê³  ì‹¶ì€ ì£¼ì œê°€ ì—†ë‹¤ë©´,\në„¤ê°€ ì¢‹ì•„í•˜ëŠ” ê²ƒë“¤ ìˆœìœ„ë¥¼ ë§¤ê²¨ë³¼ê¹Œ?",
        'bot',
        [
          { text: "ì¢‹ì•„í•˜ëŠ” ê²ƒ ìˆœìœ„ ë§¤ê²¨ë³¼ë˜", action: () => startRankingProcess("likes") },
          { text: "ë‹¤ë¥¸ ì´ì•¼ê¸° í• ë˜",       action: () => { awaitingManualTopic = false; initConversation(); } }
        ]
      );
    }
    // ì‚¬ìš©ìê°€ ì§ì ‘ ì£¼ì œ ì…ë ¥
    else {
      selectedTopic = { displayText: text };
      awaitingManualTopic = false;
      initConversation();
    }

    setLoading(false);
    return;
  }

  // â”€â”€ b) ë­í‚¹ ëª¨ë“œ ì²˜ë¦¬ â”€â”€
  if (isInRankingMode) {
    handleRankingFlow(text);
    setLoading(false);
    return;
  }

  // â”€â”€ c) ì¼ë°˜ ìƒë‹´ ëŒ€í™” â”€â”€
  await sendToGptAndRender(text);
  setLoading(false);
  }


  // â”€â”€ 4. ëŒ€í™” ì²˜ë¦¬(handleUserText) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleUserText(raw) {
    const text = raw.trim();
    if (!text) return;
    // ë­í‚¹ ëª¨ë“œ
    if (isInRankingMode && comparisonPairs.length===0) {
      appendBubble(text,'user');
      return handleRankingItemInput(text);
    }
    // ì¼ë°˜ ëŒ€í™”
    document.querySelector('.bubble.user.interim')?.remove();
    appendBubble(text,'user');
    chatHistory.push({role:'user',content:text,timestamp:new Date().toISOString()});
    setLoading(true);

    // ë­í‚¹ ì‹œì‘ í‚¤ì›Œë“œ
    if (text.includes('ì£¼ì œ ì—†ì–´')) {
      appendBubble('ì¢‹ì•„í•˜ëŠ” ê±° ìˆœìœ„ ë§¤ê²¨ë³¼ê¹Œ? ì•„ë‹ˆë©´ ì‹«ì–´í•˜ëŠ” ê±°?', 'bot', [
        { text:'ì¢‹ì•„í•˜ëŠ” ê±°', action:()=>startRankingProcess('likes') },
        { text:'ì‹«ì–´í•˜ëŠ” ê±°', action:()=>startRankingProcess('dislikes') }
      ]);
      setLoading(false);
      return;
    }

    try {
      const res = await window.LOZEE_DIALOG.getGptResponse(text, { userId,userAge,userName,userDisease,chatHistory:chatHistory.slice(-10) });
      if (!res.ok) {
        throw new Error(`Status ${res.status}`);
      }
      const data = await res.json();
      function handleRankingFlow(userInput) {
       // a) ì•„ì´í…œ ëª©ë¡ ì…ë ¥ ë‹¨ê³„
        if (!itemsToRank.length) {
        handleRankingItemInput(userInput);
        return;
     }
       // b) ë¹„êµ ì§ˆë¬¸ ë‹¨ê³„
        if (comparisonPairs.length) {
         // â€¦ ê¸°ì¡´ askNextComparison / handleComparisonChoice ë¡œì§ â€¦
         // handleComparisonChoice ë‚´ë¶€ì—ì„œ currentPairIndex++, askNextComparison() í˜¸ì¶œ
        return;
     }
        // c) ìˆœìœ„ ì™„ë£Œ í›„ í›„ì† í† ë¡  ì„ íƒì§€ ë³´ì—¬ì£¼ê¸°
        // â€¦ finishRanking() ë¡œì§ â€¦
     }

      // ë¶„ì„ ë°ì´í„° í¬í•¨
      const msg = data.text || 'ì‘ë‹µì´ ì—†ì–´ìš”.';
      appendBubble(msg,'bot');
      const entry = { role:'bot', content:msg, timestamp:new Date().toISOString() };
      if (data.analysis) entry.analysis = data.analysis;
      chatHistory.push(entry);
      localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));

      // ê°ì • ê°•ë„ ìˆ«ì ìŠ¤ì¼€ì¼ ì§ˆë¬¸
      const intent = window.LOZEE_DIALOG.detectIntent(text);
      if (intent==='emotion') {
        const scaleQ = `${userName}ì•„, ì§€ê¸ˆ ê¸°ë¶„ì„ 1~10 ìˆ«ìë¡œ í‘œí˜„í•œë‹¤ë©´ ëª‡ ì ì¼ê¹Œ?`;
        appendBubble(scaleQ,'bot');
        playTTSFunction?.(scaleQ, lsSelectedVoice);
      } else {
        playTTSFunction?.(msg, lsSelectedVoice);
      }
    } catch (e) {
      console.error(e);
      appendBubble('ì£„ì†¡í•´ìš”, ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.','system-error');
    } finally {
      setLoading(false);
      chatInput.value = '';
      chatInput.focus();
    }
  }

  // â”€â”€ 5. STT/TTS ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initSTT() {
    if (!SpeechRecognition) {
      micButton.disabled=true;
      appendBubble('ìŒì„± ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.','system-error');
      return;
    }
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'ko-KR';

    recognition.onstart = ()=>{ isRecognizing=true; micButton.textContent='ğŸ’¬'; };
    recognition.onend   = ()=>{ isRecognizing=false; micButton.textContent='ğŸ¤'; setLoading(false); };
    recognition.onresult= e=>{
      let interim='', fin='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        if(e.results[i].isFinal) fin+=e.results[i][0].transcript;
        else interim+=e.results[i][0].transcript;
      }
      if (interim) showInterim(interim);
      if (fin) { document.querySelector('.bubble.user.interim')?.remove(); handleUserText(fin); }
    };
    recognition.onerror = ()=>{ appendBubble('ìŒì„± ì¸ì‹ ì˜¤ë¥˜','system-error'); };

    micButton.onclick = async ()=>{
      if (isRecognizing) recognition.stop();
      else {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({audio:true});
          recognition.start();
        } catch {
          appendBubble('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš”.','system-error');
        }
      }
    };
  }

    // â”€â”€ 6. ì´ˆê¸°í™”(INIT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initializeApp() {
    // DOM
    chatContainer = document.getElementById('chat-container');
    chatInput     = document.getElementById('chat-input');
    sendButton    = document.getElementById('send-button');
    micButton     = document.getElementById('mic-button');
    const manualBtn = document.getElementById('btn-manual-topic');
    const pickBtn   = document.getElementById('btn-let-lozee-pick');
    manualBtn.addEventListener('click', () => {
       // â€œì§ì ‘ ë§í• ê²Œìš”â€ íë¦„: ì›í•˜ëŠ” ì£¼ì œ ì§ì ‘ ì…ë ¥ ìœ ë„
        appendBubble("ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ë‹ˆ?", "bot");
       // ë‹¤ìŒ ì…ë ¥ì´ â€œì£¼ì œê°€ ì—†ì–´â€ì¼ ê²½ìš° ë­í‚¹ìœ¼ë¡œ ë¶„ê¸°
      awaitingManualTopic = true;
    });

    pickBtn.addEventListener('click', () => {
       // â€œë¡œì§€ì•¼ ê³¨ë¼ì¤˜!â€ íë¦„: ë¡œì§€ ì†Œê°œ + ì¢‹ì•„í•˜ëŠ”/ì‹«ì–´í•˜ëŠ” ê²ƒ ë¬»ê¸°
       appendBubble("ë‚˜ LOZEEì•¼! ë„¤ê°€ ì–´ë–¤ ê±¸ ì¢‹ì•„í•˜ëŠ”ì§€, ì‹«ì–´í•˜ëŠ”ì§€ ì•Œë ¤ì£¼ë©´\në„ ë” ì˜ ë„ìš¸ ìˆ˜ ìˆì–´. ë¨¼ì € ë„¤ê°€ ì¢‹ì•„í•˜ëŠ” ê²ƒ 5ê°€ì§€ë¥¼ ë§í•´ì¤„ë˜?", "bot");
       startRankingProcess("likes");
    });
    // GNB
    const menuToggle   = document.getElementById('menu-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const gnb          = document.getElementById('gnb');
    if (menuToggle && dropdownMenu && gnb) {
      menuToggle.addEventListener('click', () => {
        dropdownMenu.classList.toggle('show');
      });
      document.addEventListener('click', (e) => {
        if (!gnb.contains(e.target) && dropdownMenu.classList.contains('show')) {
          dropdownMenu.classList.remove('show');
        }
      });
    }

    // TTS
    if (window.LOZEE_TTS?.playTTSFromText) {
      playTTSFunction = window.LOZEE_TTS.playTTSFromText;
      currentDefaultVoice = window.LOZEE_TTS.DEFAULT_VOICE;
    } else playTTSFunction = async()=>{};

    lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || currentDefaultVoice;

    // ì‚¬ìš©ì ì •ë³´
    userAge   = localStorage.getItem('lozee_userage');
    userName  = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    userId    = localStorage.getItem('lozee_userid')   || `user_${Date.now()}`;
    userDisease = JSON.parse(localStorage.getItem('lozee_userdisease')||'[]');
    selectedTopic = JSON.parse(localStorage.getItem('selectedTopic')||'{}');
    chatHistory   = JSON.parse(localStorage.getItem('lozee_conversation_history')||'[]');

    // í™”ë©´ ë³µì›
    chatHistory.forEach(msg=>appendBubble(msg.content,msg.role));

    // ì´ë²¤íŠ¸
    sendButton.onclick = ()=>{ if (chatInput.value.trim()) handleUserText(chatInput.value); };
    chatInput.onkeydown = e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); handleUserText(chatInput.value);}};

    initSTT();

    // ì²« ì§ˆë¬¸
    if (!chatHistory.length) {
      const first = window.LOZEE_DIALOG.getFirstQuestion(userAge, selectedTopic);
      appendBubble(first,'bot');
      playTTSFunction?.(first, lsSelectedVoice);
      chatHistory.push({role:'bot',content:first,timestamp:new Date().toISOString()});
      localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
    }
  }

  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>