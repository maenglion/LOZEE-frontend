<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE와 대화</title>
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS 스타일은 이전 버전(v3.19)과 동일하게 유지됩니다. */
    body { display: flex; flex-direction: column; min-height: 100vh; background-color: #ffffff; color: #333; font-family: 'KoPubWorld Dotum', sans-serif; margin: 0; }
    #main-header { background-color: #0095FF; color: white; padding: 1rem; text-align: center; font-size: 20px; font-weight: bold; flex-shrink: 0; }
    #chat-container { flex: 1; display: flex; flex-direction: column; overflow-y: hidden; width: 100%; max-width: 700px; margin: 0 auto; box-sizing: border-box; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; font-size: 16px; white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user { background-color: #fff9c4; color: #333; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .ai { background-color: #0095FF; color: white; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 5px; }
    .bubble.ai.error { background-color: #ff7373; color: white; }
    #loading-indicator-talk { text-align: center; padding: 10px; display: none; color: #555; font-style: italic; }
    #talk-btn-container { padding: 15px 0; background-color: #ffffff; flex-shrink: 0; text-align: center; border-top: 1px solid #eee; }
    #talk-btn { font-family: 'KoPubWorld Dotum', sans-serif; width: 80px; height: 80px; border-radius: 50%; background-color: #b6b6b6; border: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); color: white; font-size: 36px; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; transition: transform 0.2s ease, background-color 0.3s; }
    #talk-btn.active { background-color: #0095FF; transform: scale(1.1); }
    #talk-btn.recording-in-progress { background-color: #e06c75; transform: scale(1.1); }
    #talk-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: scale(1.0); }
    #topic-selection { display: none; background: #f0f0f0; padding: 20px; border-top: 1px solid #ddd; text-align: center; flex-shrink: 0; }
    #topic-selection h3 { font-size: 18px; color: #333; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
    .topic-option { font-family: 'KoPubWorld Dotum', sans-serif; padding: 10px 15px; margin: 8px auto; background: white; border: 1px solid #0095FF; color: #0095FF; border-radius: 10px; cursor: pointer; max-width: 320px; font-size: 15px; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
    .topic-option:hover { background-color: #0095FF; color: white; }
    #waiting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);  display: none;  justify-content: center; align-items: center; z-index: 1000;  color: white; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer;  }
  </style>
</head>
<body>
  <header id="main-header">LOZEE와 대화하기</header>
  <div id="chat-container">
    <div id="chat-window"></div>
    <div id="topic-selection">
      <h3>이야기를 이어가고 싶은 주제를 골라볼래?</h3>
      <div id="topic-options"></div>
    </div>
  </div>
  <div id="loading-indicator-talk">AI 응답 준비 중...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="말하기">🎤</button>
  </div>
  <div id="waiting-overlay">
    <p><span id="waitingUserName"></span>님, 잠시 기다리는 중...<br><small>(화면을 클릭하면 다시 시작할 수 있어요)</small></p>
  </div>

  <script type="module">
    // 외부 모듈 임포트
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    console.log("talk.html 스크립트 시작 (v3.20 - 초기화 로깅 및 안정성 강화)");

    // DOM 요소 참조 (null 가능성 방지 위해 함수 내부 또는 DOMContentLoaded 후 접근 고려)
    let talkBtn, chatWindow, topicSelectionBox, topicOptionsContainer, loadingIndicatorTalk, waitingOverlay, waitingUserNameSpan;

    // localStorage 값 가져오기
    const currentUserName = localStorage.getItem('lozee_username') || "친구";
    const currentUserId = localStorage.getItem('lozee_username'); 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';
    
    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try { selectedEmotions = JSON.parse(selectedEmotionsString); } 
        catch (e) { console.error("선택된 감정 localStorage 파싱 오류:", e); selectedEmotions = []; }
    }

    const simplified = (() => {
      const age = parseInt(currentUserAge || "0", 10);
      const disease = (currentUserDisease || "").toLowerCase();
      const needsSimple = age < 15 || ["아스퍼거", "asd", "adhd", "사회적의사소통장애"].some(d => disease.includes(d));
      const isVeryYoung = age < 10;
      console.log(`[Simplified Language Check] Age: ${age}, Disease: "${disease}", NeedsSimple: ${needsSimple}, IsVeryYoung: ${isVeryYoung}`);
      return { useSimpleLanguage: needsSimple, useUltraSimpleLanguage: isVeryYoung };
    })();
    
    // 나머지 전역 변수들
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer;
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTimeValue; 

    const ADMIN_SECRET_PHRASE = "맹고양이";
    const ADMIN_EMAIL = "maengnanyoung@gmail.com";

    let totalCharacterCount = 0;
    let conversationStartTime = null;
    const ANALYSIS_CHAR_THRESHOLD = 800; 
    const ANALYSIS_TIME_THRESHOLD_SECONDS = 180; 
    let analysisRedirectInProgress = false;
    
    let currentSegmentDuration = 40000; 
    let maxTotalRecordingTime = 600000;  
    let autoSegmentStartTime = null;     
    let currentSegmentInAutoChain = 0;   
    let autoStopTimer = null; 
    const API_DISCONNECT_DELAY_MS = 100; 

    function getRecordingPolicyByAge(age) { /* (v3.19와 동일) */ }
    function appendMessage(text, role = 'ai', isError = false) { /* (v3.19와 동일) */ }
    function disableTalkButton(disable = true, reason = "") { 
        if (talkBtn) { // talkBtn이 null이 아닐 때만 실행
            talkBtn.disabled = disable;
        }
        console.log(`[disableTalkButton] ${disable ? '비활성화' : '활성화'}${reason ? ` (${reason})` : ''}`);
    }
    async function loadRecentTopics() { /* (v3.19와 동일) */ }
    function showTopicBox(topics) { /* (v3.19와 동일) */ }
    function startSilenceTimer() { /* (v3.19와 동일) */ }
    function resetSilenceTimer() { 
        clearTimeout(silenceTimer);
        if (topicSelectionBox && topicSelectionBox.style.display === 'none' && talkBtn && !talkBtn.disabled && !analysisRedirectInProgress) {
            console.log("[Timer] 침묵 타이머 리셋 및 재시작."); 
            startSilenceTimer();
        } else { 
            console.log("[Timer] 침묵 타이머 리셋 (조건 미충족으로 시작 안함)."); 
        }
    }
    function checkAndRedirectToAnalysis() { /* (v3.19와 동일) */ }
    async function handleUserInteraction(userText, context = {}) { /* (v3.19와 동일) */ }
    async function startRecording() { /* (v3.19와 동일) */ }
    function stopRecording(isManualStop = false) { /* (v3.19와 동일) */ }
    
    function setupEventListeners() {
        console.log("[setupEventListeners] 이벤트 리스너 설정 시도.");
        if (talkBtn) {
            talkBtn.addEventListener('click', async () => { 
              if (analysisRedirectInProgress) { return; }
              if (waitingOverlay) waitingOverlay.style.display = 'none'; 
              
              if (!firstInteractionDone && !onboardingComplete && initialGreetingText) { 
                firstInteractionDone = true; disableTalkButton(true, "초기 인사말 TTS 중"); 
                if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'block';
                try { await playTTSFromText(initialGreetingText, currentVoiceId); } 
                catch (error) {
                  const errorBubble = appendMessage( error.name === 'NotAllowedError' ? "(목소리를 들으려면 화면을 다시 한번 클릭하거나 마이크 버튼을 눌러주세요.)" : "(초기 안내 음성 재생 중 문제가 발생했습니다.)", "ai", true);
                  if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble); 
                } finally { 
                    if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none'; 
                    disableTalkButton(false, "초기 인사말 TTS 완료/실패"); 
                    resetSilenceTimer(); 
                }
                return; 
              }

              if (!isRecording) {
                autoSegmentStartTime = null; 
                currentSegmentInAutoChain = 0; 
                startRecording(); 
              } else { 
                stopRecording(true); 
              }
            });
            console.log("[setupEventListeners] talkBtn 클릭 리스너 설정 완료.");
        } else {
            console.error("[setupEventListeners] talkBtn 요소를 찾을 수 없어 클릭 리스너를 설정할 수 없습니다.");
        }

        if (waitingOverlay) {
            waitingOverlay.addEventListener('click', () => { 
                if (analysisRedirectInProgress) return;
                waitingOverlay.style.display = 'none';
                resetSilenceTimer(); 
            });
            console.log("[setupEventListeners] waitingOverlay 클릭 리스너 설정 완료.");
        } else {
            console.error("[setupEventListeners] waitingOverlay 요소를 찾을 수 없습니다.");
        }
    }

    async function initializeChat() { 
      console.log("--- [initializeChat] 함수 시작됨 ---");

      // DOM 요소 참조 초기화
      talkBtn = document.getElementById('talk-btn');
      chatWindow = document.getElementById('chat-window');
      topicSelectionBox = document.getElementById('topic-selection');
      topicOptionsContainer = document.getElementById('topic-options');
      loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
      waitingOverlay = document.getElementById('waiting-overlay');
      waitingUserNameSpan = document.getElementById('waitingUserName');

      console.log("[initializeChat] DOM 요소 참조 완료.");
      if (!talkBtn) console.error("[initializeChat] talkBtn 요소가 null입니다!");
      if (!chatWindow) console.error("[initializeChat] chatWindow 요소가 null입니다!");


      if (talkBtn) {
          talkBtn.innerHTML = '🎤';
          talkBtn.classList.remove('active', 'recording-in-progress');
      }
      disableTalkButton(true, "초기화 중");
      
      console.log("[initializeChat] localStorage 값 확인:");
      console.log(`  currentUserName: "${currentUserName}"`);
      console.log(`  currentUserId: "${currentUserId}"`);
      console.log(`  currentVoiceId: "${currentVoiceId}"`);
      console.log(`  currentUserAge: "${currentUserAge}"`);
      console.log(`  currentUserDisease: "${currentUserDisease}"`);
      console.log(`  onboardingComplete: ${onboardingComplete}, userTypedIntro: "${userTypedIntro ? userTypedIntro.substring(0,10)+'...' : '없음'}"`);

      if (!currentUserId || !currentVoiceId) { 
          const errorMsg = `필수 사용자 정보(ID 또는 목소리)가 없어 대화를 시작할 수 없습니다. [ID: ${currentUserId}, Voice: ${currentVoiceId}] 설정 페이지로 돌아가거나 앱을 다시 시작해주세요.`;
          console.error("[initializeChat] 치명적 오류 - 필수 정보 누락:", errorMsg); 
          const errorBubble = appendMessage(errorMsg, 'ai', true);
          if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble);
          if(loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none'; 
          disableTalkButton(true, "사용자 정보 없음 (필수 값 누락)");
          console.log("--- [initializeChat] 중단 (필수 정보 누락) ---");
          return;
      }
      console.log("[initializeChat] 필수 사용자 정보 (ID, Voice) 확인 완료.");

      try {
        console.log("[initializeChat] try 블록 진입.");
        if (onboardingComplete && userTypedIntro) { 
            console.log("[initializeChat] 케이스 1: 온보딩 완료, 사용자 첫마디 입력됨.");
            appendMessage(userTypedIntro, 'user'); 
            if (!conversationStartTime) conversationStartTime = Date.now();
            await handleUserInteraction(userTypedIntro, { initialUserMessage: userTypedIntro, initialUserEmotions: selectedEmotions, isFirstChatAfterOnboarding: true });
            localStorage.removeItem('lozee_onboarding_complete'); 
            localStorage.removeItem('lozee_user_typed_intro'); 
            firstInteractionDone = true; 
        } else if (onboardingComplete && !userTypedIntro) { 
            console.log("[initializeChat] 케이스 2: 온보딩 완료, 사용자 첫 음성 입력 대기.");
            initialGreetingText = `만나서 반가워요, ${currentUserName}님! 이제 대화를 시작할 준비가 되었어요. 아래 마이크 버튼을 눌러 지금 어떤지 말씀해주세요.`;
            console.log(`[initializeChat] 생성된 초기 인사말 (케이스 2): "${initialGreetingText.substring(0,30)}..."`);
            const aiGreetingBubble = appendMessage(initialGreetingText, 'ai');
            if(aiGreetingBubble && chatWindow) chatWindow.appendChild(aiGreetingBubble);
            if(loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'block';
            try { await playTTSFromText(initialGreetingText, currentVoiceId); } catch(e) { console.error("온보딩 후 첫 인사 TTS 오류:", e); } 
            finally { if(loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none'; }
            disableTalkButton(false, "온보딩 후 첫 음성 입력 대기");
            firstInteractionDone = true; 
        } else { 
            const urlParams = new URLSearchParams(window.location.search);
            const topicFromUrl = urlParams.get('topic');
            if (topicFromUrl) { 
              console.log(`[initializeChat] 케이스 3: URL에서 토픽 가져옴 ("${topicFromUrl}").`);
              appendMessage(`"${topicFromUrl}"에 대해 이야기하고 싶어요.`, 'user');
              if (!conversationStartTime) conversationStartTime = Date.now();
              await handleUserInteraction(`"${topicFromUrl}" 관련해서 이야기 시작해줘.`);
              firstInteractionDone = true; 
            } else { 
              console.log("[initializeChat] 케이스 4: 일반 시작. getInitialGreeting 호출 시도.");
              initialGreetingText = await getInitialGreeting(currentUserName, hasVisited, lastSummary, currentUserAge, currentUserDisease);
              console.log(`[initializeChat] getInitialGreeting 반환 값: "${initialGreetingText ? initialGreetingText.substring(0,30)+'...' : '없음/null'}"`);
              if (!initialGreetingText || initialGreetingText.trim() === "") {
                  console.warn("[initializeChat] getInitialGreeting이 비어있는 문자열 또는 null을 반환. 기본 인사말로 대체.");
                  initialGreetingText = `${currentUserName}님, 안녕하세요! 어떤 이야기를 나누고 싶으신가요?`;
              }
              const aiGreetingBubble = appendMessage(initialGreetingText, 'ai');
              if(aiGreetingBubble && chatWindow) chatWindow.appendChild(aiGreetingBubble);
              disableTalkButton(false, "초기화 완료, 첫 클릭 대기"); 
            }
        }
        if (!hasVisited) { 
            localStorage.setItem('lozee_hasVisited', 'true'); 
            hasVisited = true; 
            console.log("[initializeChat] 첫 방문으로 기록됨 (lozee_hasVisited = true).");
        }
        console.log("[initializeChat] try 블록 성공적으로 완료.");
      } catch (error) { 
          console.error("[initializeChat] try 블록 내에서 예외 발생:", error);
          const errorBubble = appendMessage("채팅 시작 중 문제가 발생했어요. 페이지를 새로고침 해보세요.", 'ai', true);
          if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble);
          disableTalkButton(true, "초기화 오류");
      } finally {
        console.log("--- [initializeChat] finally 블록 실행됨. 채팅 초기화 시도 완료 ---");
        if (!analysisRedirectInProgress) resetSilenceTimer(); 
      }
    }

    // DOMContentLoaded 이벤트 발생 시 주요 로직 실행
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded 이벤트 발생. 초기화 로직 실행 준비.");
        // DOM 요소 참조를 여기서 한 번 더 수행하여 null 방지
        talkBtn = document.getElementById('talk-btn');
        chatWindow = document.getElementById('chat-window');
        topicSelectionBox = document.getElementById('topic-selection');
        topicOptionsContainer = document.getElementById('topic-options');
        loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
        waitingOverlay = document.getElementById('waiting-overlay');
        waitingUserNameSpan = document.getElementById('waitingUserName');
        
        if (!talkBtn || !chatWindow || !topicSelectionBox || !topicOptionsContainer || !loadingIndicatorTalk || !waitingOverlay || !waitingUserNameSpan) {
            console.error("DOMContentLoaded: 필수 DOM 요소 중 하나 이상을 찾을 수 없습니다. 일부 기능이 작동하지 않을 수 있습니다.");
        }

        setupEventListeners(); // 이벤트 리스너 설정
        initializeChat();    // 채팅 초기화 로직 호출
    });

  </script>
</body>
</html>
