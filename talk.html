<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE 상담</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display:flex; flex-direction:column; height:100vh; margin:0; font-family:'KoPubWorld Dotum',sans-serif; }
    #main-header { background:#0095FF; color:#fff; padding:1rem; text-align:center; font-size:1.25rem; }
    #chat-window { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .bubble { max-width:80%; padding:0.75rem 1rem; border-radius:1rem; line-height:1.4; white-space:pre-wrap; }
    .user { background:#fff9c4; color:#333; align-self:flex-end; border-bottom-right-radius:0.25rem; }
    .ai   { background:#0095FF;  color:#fff; align-self:flex-start; border-bottom-left-radius:0.25rem; }
    #silence-banner { text-align:center; padding:0.5rem; background:#f0f0f0; color:#666; font-size:0.9rem; display:none; }
    #loading-indicator { display:none; text-align:center; padding:0.5rem; color:#555; font-style:italic; }
  </style>
</head>
<body>
  <header id="main-header">LOZEE 상담</header>
  <div id="chat-window"></div>
  <div id="silence-banner">말씀하시면 바로 들어드려요</div>
  <div id="loading-indicator">처리 중...</div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    // 상태 머신 정의
    const State = { READY:'READY', RECORD:'RECORD', SILENCE:'SILENCE', PROCESS:'PROCESS' };
    let currentState = State.READY;
    let silenceTimer;

    const chatWindow = document.getElementById('chat-window');
    const banner     = document.getElementById('silence-banner');
    const loading    = document.getElementById('loading-indicator');

    // TTS 음성
    const ttsVoice = localStorage.getItem('lozee_tts_voice') || 'ko-KR-Chirp3-HD-Vindemiatrix';

    // 메시지 추가
    function appendMessage(text, role) {
      const div = document.createElement('div'); div.className = `bubble ${role}`; div.textContent = text;
      chatWindow.appendChild(div); chatWindow.scrollTop = chatWindow.scrollHeight; return div;
    }
    function showBanner(on) { banner.style.display = on ? 'block' : 'none'; }
    function showLoading(on) { loading.style.display = on ? 'block' : 'none'; }

    // 상태 전환
    function transition(to) {
      clearTimeout(silenceTimer);
      currentState = to;
      showBanner(to === State.SILENCE);
      console.log('State →', to);
    }

    // GPT 호출 처리
    async function handleUserTurn(text, systemPrompt='') {
      appendMessage(text, 'user');
      showLoading(true);
      const res = await getGptResponse(text, systemPrompt);
      const aiText = typeof res==='string' ? res : (res.error||res.rephrasing||'응답이 없습니다.');
      appendMessage(aiText, 'ai');
      await playTTSFromText(aiText, ttsVoice);
      showLoading(false);
    }

    // AudioWorklet VAD setup
    let audioCtx, micStream, vadNode;
    (async()=>{
      audioCtx = new AudioContext();
      await audioCtx.audioWorklet.addModule('vad-processor.js');
      const mic = await navigator.mediaDevices.getUserMedia({ audio:true });
      micStream = mic;
      const source = audioCtx.createMediaStreamSource(mic);
      vadNode = new AudioWorkletNode(audioCtx,'vad-processor');
      source.connect(vadNode); vadNode.port.onmessage = e=>{
        if(e.data.speaking) onVoiceStart(); else onVoiceEnd();
      };
    })();

    // Web Speech API interim STT
    const recognition = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
    recognition.continuous = true; recognition.interimResults = true; recognition.lang='ko-KR';
    let userBubble;
    recognition.onresult = e=>{
      let interim='', final='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        const r=e.results[i][0].transcript;
        if(e.results[i].isFinal) final+=r; else interim+=r;
      }
      if(interim) userBubble.textContent = interim;
      if(final) {
        userBubble.textContent = final;
      }
    };

    // 음성 시작/끝 이벤트
    function onVoiceStart(){
      if(currentState===State.READY||currentState===State.SILENCE){
        transition(State.RECORD);
        // 새 버블 준비
        userBubble = appendMessage('...', 'user');
        recognition.start();
      }
    }
    function onVoiceEnd(){
      if(currentState===State.RECORD){
        transition(State.SILENCE);
        recognition.stop();
        // 20초 뒤 안내 및 처리
        silenceTimer = setTimeout(async()=>{
          // 안내 한번
          appendMessage('지금 말씀하시면 언제든 다시 시작할게요', 'ai');
          await playTTSFromText('지금 말씀하시면 언제든 다시 시작할게요', ttsVoice);
          transition(State.READY);
        },20000);
      }
    }

    // 초기 인사 및 첫 인트로 처리
    window.addEventListener('DOMContentLoaded', async()=>{
      const name = localStorage.getItem('lozee_username')||'친구';
      const greeting = await getInitialGreeting(name);
      appendMessage(greeting,'ai'); await playTTSFromText(greeting,ttsVoice);

      // 감정 태그 + 인트로
      const emo = localStorage.getItem('lozee_emotion_tag')||'';
      const intro = localStorage.getItem('lozee_user_intro')||'';
      if(intro){
        const sys = emo?`유저 감정: ${emo}.` : '';
        await handleUserTurn(intro, sys);
        localStorage.removeItem('lozee_user_intro');
      }

      transition(State.READY);
    });
  </script>
</body>
</html>
