<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEE ìƒë‹´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { display:flex; flex-direction:column; height:100vh; margin:0; font-family:'KoPubWorld Dotum',sans-serif; }
    #main-header { background:#0095FF; color:#fff; padding:1rem; text-align:center; font-size:1.25rem; }
    #status-bar { display:flex; align-items:center; justify-content:center; gap:1rem; background:#eef; padding:0.5rem; }
    #mic-indicator { font-size:0.9rem; }
    #vu-meter { width:100px; height:20px; background:#ccc; border-radius:4px; }
    #chat-window { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .bubble { max-width:80%; padding:0.75rem 1rem; border-radius:1rem; line-height:1.4; white-space:pre-wrap; }
    .user { background:#fff9c4; color:#333; align-self:flex-end; border-bottom-right-radius:0.25rem; }
    .ai   { background:#0095FF; color:#fff; align-self:flex-start; border-bottom-left-radius:0.25rem; }
    #loading-indicator { display:none; text-align:center; padding:0.5rem; color:#555; font-style:italic; }
  </style>
</head>
<body>
  <header id="main-header">LOZEE ìƒë‹´</header>
  <div id="status-bar">
    <div id="mic-indicator">ğŸ”µ ëŒ€ê¸° ì¤‘</div>
    <canvas id="vu-meter"></canvas>
  </div>
  <div id="chat-window"></div>
  <div id="loading-indicator">ì²˜ë¦¬ ì¤‘...</div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getGptResponse } from './js/gpt-dialog.js';

    const State = { READY:'READY', RECORD:'RECORD' };
    let currentState = State.READY;
    let recognition, userPlaceholder, currentTTS;

    const chatWindow    = document.getElementById('chat-window');
    const micIndicator  = document.getElementById('mic-indicator');
    const vuCanvas      = document.getElementById('vu-meter');
    const loading       = document.getElementById('loading-indicator');
    const ttsVoice      = localStorage.getItem('lozee_tts_voice') || 'ko-KR-Chirp3-HD-Vindemiatrix';

    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return div;
    }
    function setMic(text) { micIndicator.textContent = text; }
    function showLoading(on) { loading.style.display = on ? 'block' : 'none'; }

    async function handleUserTurn(text) {
      showLoading(true);
      appendMessage(text, 'user');
      // STT ì¤‘ë‹¨
      try { recognition.stop(); } catch(e) {}
      if (currentTTS) { currentTTS.pause(); currentTTS = null; }

      const res = await getGptResponse(text).catch(() => ({ error:'ì˜¤ë¥˜ ë°œìƒ' }));
      showLoading(false);
      let reply = typeof res === 'string' ? res : res.error || res.rephrasing;
      appendMessage(reply, 'ai');

      // AI TTS ì¬ìƒ, ëë‚˜ë©´ STT ì¬ì‹œì‘
      currentTTS = await playTTSFromText(reply, ttsVoice);
      currentTTS.onended = () => {
        try { recognition.start(); setMic('ğŸ”´ ë“£ê³  ìˆì–´ìš”'); } catch(e) {}
      };
    }

    async function initSTT() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupVUMeter(stream);
      } catch {
        appendMessage('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ai');
        return;
      }

      recognition = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
      recognition.lang = 'ko-KR'; recognition.continuous = true; recognition.interimResults = true;

      recognition.onresult = e => {
        let interim='', finalText='';
        for (let i=e.resultIndex;i<e.results.length;i++){
          let t=e.results[i][0].transcript;
          e.results[i].isFinal? finalText+=t : interim+=t;
        }
        // interim í‘œì‹œ
        if (interim) {
          if (!userPlaceholder) userPlaceholder = appendMessage('', 'user');
          userPlaceholder.textContent = interim;
        }
        // final ì²˜ë¦¬
        if (finalText) {
          if (userPlaceholder) { userPlaceholder.remove(); userPlaceholder=null; }
          handleUserTurn(finalText);
        }
      };

      recognition.onerror = e => console.warn('STT ì˜¤ë¥˜', e);

      recognition.onstart = () => setMic('ğŸ”´ ë“£ê³  ìˆì–´ìš”');
      recognition.onend = () => setMic('ğŸ”µ ëŒ€ê¸° ì¤‘');

      recognition.start(); setMic('ğŸ”´ ë“£ê³  ìˆì–´ìš”');
    }

    function setupVUMeter(stream) {
      const ctx=new AudioContext(),src=ctx.createMediaStreamSource(stream);
      const analyser=ctx.createAnalyser(); analyser.fftSize=64; src.connect(analyser);
      const data=new Uint8Array(analyser.frequencyBinCount);
      const dib=vuCanvas.getContext('2d'); const cw=vuCanvas.width,ch=vuCanvas.height;
      (function draw(){ analyser.getByteFrequencyData(data);
        dib.clearRect(0,0,cw,ch);
        const w=cw/data.length;
        data.forEach((v,i)=>dib.fillRect(i*w,ch-(v/ch)*ch,w-1,(v/ch)*ch));
        requestAnimationFrame(draw);
      })();
    }

    window.addEventListener('DOMContentLoaded', initSTT);
  </script>
</body>
</html>
