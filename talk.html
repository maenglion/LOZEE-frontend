<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE와 대화</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; background: #fff; color: #333; display: flex; flex-direction: column; height: 100vh; }
    /* Chat Header */
    #main-header { background-color: #0095FF; color: white; padding: 1rem; text-align: center; font-size: 1.25rem; }
    /* Volume Meter (top) */
    #meter-container { display: flex; align-items: center; justify-content: center; padding: 0.5rem 0; background: #f4f4f4; }
    #volume-meter { width: 80%; height: 8px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
    #volume-level { height: 100%; background: #0095FF; width: 0; transition: width 0.1s ease; }
    /* Chat Window */
    #chat-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
    .bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; white-space: pre-wrap; }
    .user { background: #fff9c4; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
    .ai { background: #0095FF; color: #fff; align-self: flex-start; border-bottom-left-radius: 0.25rem; }
  </style>
</head>
<body>
  <header id="main-header">LOZEE와 대화하기</header>
  <div id="meter-container">
    <div id="volume-meter"><div id="volume-level"></div></div>
  </div>
  <div id="chat-container"></div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';
    import { getSTTFromAudio } from './js/stt.js';

    const chatContainer = document.getElementById('chat-container');
    const meterLevel = document.getElementById('volume-level');

    function appendMessage(text, role) {
      const el = document.createElement('div');
      el.className = `bubble ${role}`;
      el.textContent = text;
      chatContainer.appendChild(el);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function initConversation() {
      const userName = localStorage.getItem('lozee_username') || '친구';
      const greeting = await getInitialGreeting(userName);
      appendMessage(greeting, 'ai');
      await playTTSFromText(greeting);
    }

    function initVAD() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        const dataArr = new Uint8Array(analyser.fftSize);
        let recording = false;
        let recorder;

        function analyze() {
          analyser.getByteTimeDomainData(dataArr);
          let sum = 0;
          dataArr.forEach(v => sum += Math.pow(v/128 - 1, 2));
          const vol = Math.sqrt(sum / dataArr.length);
          meterLevel.style.width = `${Math.min(vol * 200, 100)}%`;

          if (vol > 0.05 && !recording) {
            recording = true;
            recorder = new MediaRecorder(stream);
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.start();
          }

          if (vol < 0.02 && recording) {
            recording = false;
            recorder.onstop = async () => {
              const blob = new Blob(chunks, { type: chunks[0].type });
              try {
                const transcript = await getSTTFromAudio(blob);
                appendMessage(transcript, 'user');
                const aiResp = await getGptResponse(transcript);
                appendMessage(aiResp, 'ai');
                await playTTSFromText(aiResp);
              } catch (err) {
                console.error(err);
              }
            };
            recorder.stop();
          }

          requestAnimationFrame(analyze);
        }
        analyze();
      }).catch(console.error);
    }

    // 시작
    initConversation();
    initVAD();
  </script>
</body>
</html>
