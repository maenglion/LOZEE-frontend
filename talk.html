<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜ì´ì§€ ì œëª©</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 

    <link rel="stylesheet" href="gnb.css">

<style>
  :root {
      --primary-color: #6e8efb;
      --secondary-color: #5a7edf;
      --background-color: #ffffff;
      --text-color: #333333;
      
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --assistant-bubble-bg: #F5E7A1; /* ë¡œì§€ ë§í’ì„  ë°°ê²½ìƒ‰ ë³€ê²½ */
      --assistant-bubble-text: #333333;

      --input-area-bg: #f8f9fa;
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef;
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px;
      --meter-top-margin: 8px;

      --analysis-notification-bg: #fff3cd;
      --analysis-notification-text: #856404;

      --chat-input-area-height: 70px;
    }

    body {
      margin: 0;
      font-family: 'KoPub World Dotum', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px;
      transition: width 0.05s linear, background-color 0.05s linear;
    }
    
    #chat-window {
      flex: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
      padding-bottom: calc(var(--chat-input-area-height) + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.assistant_feedback { 
      background: #e9ecef; 
      color: #495057;
      align-self: center; 
      font-size: 0.9em;
      border-radius: 8px;
    }
    .bubble.thinking { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-style: italic;
      opacity: 0.8;
    }


    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    #topic-area {
      display: none !important; 
    }

    #input-area {
      padding: 0 30px; 
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; 
      align-items: center;
      gap: 8px;
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px;
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px;
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn {
      width: 44px;
      min-width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording {
      background: #e74c3c;
    }
    #send-btn.loading {
        background:#cccccc;
        cursor:default;
    }
    
    @media (max-width: 600px) {
      #input-area { padding: 0 20px; } 
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
    }

    .chat-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
      align-items: flex-start;
      max-width: 80%;
      align-self: flex-start;
    }

    .chat-option-btn {
      background-color: #f1f1f1;
      color: #333333;
      border: 1px solid #dcdcdc;;
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .chat-option-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-1px);
    }
    .chat-option-btn.selected {
      background-color: #E4D2FD;
      color: #333;
      border-color: #c3b2e0; 
      font-weight: bold;
    }
    .chat-option-btn:disabled {
      background-color: #f8f8f8;
      color: #aaaaaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
  </style>
</head>
<body>
   <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">â˜°</button>
    <div id="dropdown-menu">
      <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
      <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
      <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
      <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
    </div>
</nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-window"></div>
  <div id="input-area">
    <button id="mic-button">ğŸ¤</button>
    <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
    <button id="send-btn">â¤</button>
  </div>

  <script type="module">
    import './js/firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { saveSessionLog } from './js/firebase-utils.js';
    import { counselingTopicsByAge } from './js/counseling_topics.js';



    // ìƒíƒœ ë³€ìˆ˜
    let skipTTS = false;
    let hasGreeted = false;
    let isProcessing = false;
    let chatHistory = [];
    let selectedMain = null;
    let meta = { lastInputTimestamp: Date.now(), fillerCount: 0, clickedOption: false, presentedIndices:[] };
    let isPlayingTTS = false; 
    let conversationStartTime = null;
    let analysisNotificationShown = false;
    // ë‹µë³€ì˜ ì–‘ ì œì–´ 
    let messageCountForPreferenceCheck = 0;
    let gptVerbosityPreference = 'default'; // 'short', 'default', 'verbose'
    let preferenceSetTimestamp = 0;
    const PREFERENCE_DURATION = 10 * 60 * 1000; // 10ë¶„ (ë°€ë¦¬ì´ˆ ë‹¨ìœ„)
    let preferenceCheckDoneThisSession = false; // í•œ ì„¸ì…˜ì—ì„œ í•œ ë²ˆë§Œ ë¬¼ì–´ë³´ë„ë¡ (ì„ íƒ ì‚¬í•­)

    // UI ìš”ì†Œ
    const chatWindow = document.getElementById('chat-window');
    const topicArea = document.getElementById('topic-area'); 
    const inputArea = document.getElementById('input-area');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const micButton = document.getElementById('mic-button');
    const menuToggle = document.getElementById('menu-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const meterLevel = document.getElementById('volume-level');

    // GNB ë©”ë‰´ í† ê¸€
    menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
    document.addEventListener('click', e => {
      if (!document.getElementById('gnb').contains(e.target)) {
        dropdownMenu.classList.remove('show');
      }
    });

    // ì‚¬ìš©ì ì •ë³´
    const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
    const voc = getKoreanVocativeParticle(userName);

    // ì´ˆê¸°í™” ë¡œì§
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âœ… js/firebase-config.js ëª¨ë“ˆ ë¡œë“œë¨');
      console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
      
      conversationStartTime = Date.now(); 

      const greeting = getInitialGreeting(userName + voc, hasGreeted);
      appendMessage(greeting, 'assistant');
      
      // ì²« TTSëŠ” ì‚¬ìš©ì ì¸í„°ë™ì…˜ ìœ ë„ í›„ ì¬ìƒí•˜ëŠ” ê²ƒì´ ì¢‹ìœ¼ë¯€ë¡œ, ì¼ë‹¨ ì£¼ì„ ì²˜ë¦¬
      // try {
      //   await playTTSWithControl(greeting);
      // } catch (error) {
      //   console.warn("ì²« TTS ìë™ ì¬ìƒ ì‹œë„ ì¤‘ ì˜¤ë¥˜(ë¬´ì‹œ ê°€ëŠ¥):", error);
      // }
      console.log("ì²« ì¸ì‚¬ TTSëŠ” ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„ ì¬ìƒë˜ë„ë¡ ë¡œì§ ë³€ê²½ì„ ê³ ë ¤í•˜ì„¸ìš”. (í˜„ì¬ ìë™ ì¬ìƒ ì•ˆ í•¨)");
      
      hasGreeted = true;
      showMainTopics();
    });

    // ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜
    function appendMessage(text, role) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + role; 
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showAnalysis() {
      if (analysisNotificationShown) return; // ì´ë¯¸ ì•Œë¦¼ì´ í‘œì‹œë˜ì—ˆìœ¼ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
      const notification = document.createElement('div');
      notification.className = 'analysis-notification';
      notification.textContent = 'ğŸŸ¡ë¶„ì„ ì™„ë£Œ';
      notification.onclick = () => {
        // ë¶„ì„ ê²°ê³¼ë¥¼ localStorage ë“±ì— ì €ì¥í•˜ì—¬ analysis.htmlì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ë‹¬
        // ì˜ˆ: localStorage.setItem('currentAnalysisDataForPage', JSON.stringify(chatHistory));
        location.href = 'analysis.html';
      }
      chatWindow.appendChild(notification);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      analysisNotificationShown = true; 
    }

    // TTS ì œì–´ ì¬ìƒ í•¨ìˆ˜
    async function playTTSWithControl(txt) {
      stopCurrentTTS();
      if (skipTTS) {
        skipTTS = false;
        return Promise.resolve(); 
      }
      isPlayingTTS = true;
      try {
        await playTTSFromText(txt, localStorage.getItem('lozee_voice'));
      } catch (error) {
        console.error("playTTSWithControl ë‚´ TTS ì¬ìƒ ì˜¤ë¥˜:", error);
      } finally {
        isPlayingTTS = false;
      }
    }

    // ì˜¤ë””ì˜¤ ë¶„ì„ ê´€ë ¨
    let audioContext, analyser, source, dataArray, animId, streamRef;
    const LOW = { r:0, g:200, b:0 }; const MID = { r:255, g:200, b:0 }; const HIGH = { r:255, g:69, b:0 };
    function interp(c1, c2, f) { return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;}
    function setupAudioAnalysis(stream) { if (audioContext && audioContext.state !== 'closed') audioContext.close(); audioContext = new AudioContext(); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; source = audioContext.createMediaStreamSource(stream); source.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); streamRef = stream; draw(); }
    function draw() { animId = requestAnimationFrame(draw); if (!analyser || !dataArray) return; analyser.getByteFrequencyData(dataArray); let sum = dataArray.reduce((a, v) => a + v, 0); let avg = sum / dataArray.length; let norm = Math.min(100, Math.max(0, (avg / 140) * 100)); meterLevel.style.width = norm + '%'; let col = norm <= 50 ? interp(LOW, MID, norm / 50) : interp(MID, HIGH, (norm - 50) / 50); meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${col})`; if (norm > 10 && isRec && isPlayingTTS && !skipTTS) { console.log("ì‚¬ìš©ì ìŒì„± ê°ì§€, TTS ì¤‘ë‹¨ ì‹œë„"); stopCurrentTTS(); skipTTS = true; } }
    function stopAudio() { if (animId) cancelAnimationFrame(animId); if (source) source.disconnect(); if (streamRef) streamRef.getTracks().forEach(track => track.stop()); if (audioContext && audioContext.state !== 'closed') { audioContext.close(); } audioContext = null; meterLevel.style.width = '0%'; meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-container-bg'); }

    // STT (Web Speech API)
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog, isRec = false;
    if (SpeechRecognitionAPI) {
      recog = new SpeechRecognitionAPI(); 
      recog.continuous = false; 
      recog.interimResults = false; 
      recog.lang = 'ko-KR';
      recog.onstart = () => { isRec = true; micButton.classList.add('recording'); };
      recog.onend = () => { isRec = false; micButton.classList.remove('recording'); stopAudio(); };
      recog.onresult = event => { let transcript = ''; for (let i = event.resultIndex; i < event.results.length; i++) { if (event.results[i].isFinal) { transcript += event.results[i][0].transcript; } } if (transcript) { console.log("STT ê²°ê³¼:", transcript); sendMessage(transcript, 'stt'); } };
      recog.onerror = event => { console.error('Speech recognition error:', event.error); appendMessage('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error, 'assistant_feedback'); isRec = false; micButton.classList.remove('recording'); stopAudio(); };
      micButton.onclick = async () => { if (isRec) { recog.stop(); } else { stopCurrentTTS(); skipTTS = true; try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); setupAudioAnalysis(stream); recog.start(); } catch (e) { console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', e); appendMessage('ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'assistant_feedback'); } } };
    } else { micButton.disabled = true; appendMessage('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'assistant_feedback'); }

    // í† í”½ í”Œë¡œìš° - ì„ íƒì°½
    function displayOptionsInChat(optionsArray, onSelectCallback, context = null) 
    { console.log("displayOptionsInChat í•¨ìˆ˜ ì‹œì‘ë¨, ì˜µì…˜ ë°°ì—´:", optionsArray); 
    const optionsContainer = document.createElement('div'); optionsContainer.className = 'chat-options-container'; 
    const buttons = []; optionsArray.forEach(optionObject => { let buttonText; let displayTextForCallback; 
      if (typeof optionObject === 'string') { buttonText = optionObject; displayTextForCallback = optionObject; console.log("ì˜µì…˜ ë²„íŠ¼ ìƒì„± ì¤‘ (ë¬¸ìì—´):", optionObject); } else if (optionObject && typeof optionObject.displayText !== 'undefined') { buttonText = optionObject.icon ? `${optionObject.icon} ${optionObject.displayText}` : optionObject.displayText; displayTextForCallback = optionObject.displayText; console.log("ì˜µì…˜ ë²„íŠ¼ ìƒì„± ì¤‘ (ê°ì²´):", optionObject.displayText); } else { console.warn("displayOptionsInChat: ì˜ëª»ëœ í˜•ì‹ì˜ ì˜µì…˜ì…ë‹ˆë‹¤.", optionObject); return; } const button = document.createElement('button'); button.className = 'chat-option-btn'; button.textContent = buttonText; button.onclick = () => { buttons.forEach(btn => { btn.disabled = true; if (btn === button) { btn.classList.add('selected'); } }); onSelectCallback(displayTextForCallback, context); }; optionsContainer.appendChild(button); buttons.push(button); }); chatWindow.appendChild(optionsContainer); console.log("ì˜µì…˜ ì»¨í…Œì´ë„ˆê°€ chatWindowì— ì¶”ê°€ë¨"); chatWindow.scrollTop = chatWindow.scrollHeight; }

    // í† í”½ í”Œë¡œìš° - ì£¼ì œ
    function showMainTopics() {
    console.log("showMainTopics í•¨ìˆ˜ ì‹œì‘ë¨");
    appendMessage('ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³¼ê¹Œ?', 'assistant');
    const currentAgeGroup = getAgeGroup();
    const ageGroupData = counselingTopicsByAge[currentAgeGroup];
    let topicsWithOptions = [];
    if (ageGroupData) {
        topicsWithOptions = Object.keys(ageGroupData).map(categoryName => {
            let icon = 'ğŸ’¬';
            if (ageGroupData[categoryName] && ageGroupData[categoryName].length > 0 && ageGroupData[categoryName][0].icon) {
                icon = ageGroupData[categoryName][0].icon;
            }
            return { icon: icon, displayText: categoryName };
        });
    } else {
        console.warn(`counselingTopicsByAgeì— '${currentAgeGroup}'ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
    }
    topicsWithOptions.push({ icon: 'ğŸ—£ï¸', displayText: 'ììœ ì£¼ì œ' });
    console.log("displayOptionsInChatì— ì „ë‹¬ë  ë°°ì—´:", topicsWithOptions); 

    // displayOptionsInChat í˜¸ì¶œê³¼ ì½œë°± í•¨ìˆ˜ ì •ì˜
    displayOptionsInChat(topicsWithOptions, (selectedTopicText) => { // => ë°”ë¡œ ë‹¤ìŒì— {
        selectedMain = selectedTopicText; 
        appendMessage(selectedMain + ' ì´ì•¼ê¸°ë¥¼ ì„ íƒí–ˆêµ¬ë‚˜!', 'assistant'); 
        
        if (selectedMain === 'ììœ ì£¼ì œ') {
            const message = 'ë„¤ê°€ ì •í•˜ë©´ ë¼. ì–´ë–¤ ì´ì•¼ê¸°ê°€ í•˜ê³  ì‹¶ì–´?';
            appendMessage(message, 'assistant');
            // if (topicArea) topicArea.style.display = 'none !important'; // ì´ ìœ„ì¹˜ ë˜ëŠ” ì•„ë˜ showMainTopics ëìœ¼ë¡œ
            inputArea.style.display = 'flex'; 
            chatInput.focus(); 
        } else {
            setTimeout(showSubTopics, 300); 
        }
    }); // displayOptionsInChat í˜¸ì¶œ ê´„í˜¸ ë‹«ê³  ì„¸ë¯¸ì½œë¡ 
    // ì´ì „ì— #topic-areaë¥¼ ìˆ¨ê¸°ëŠ” ì½”ë“œê°€ ìˆì—ˆë‹¤ë©´, showMainTopics í•¨ìˆ˜ì˜ ë§ˆì§€ë§‰ì— ë‘ëŠ” ê²ƒì´ ì ì ˆí•©ë‹ˆë‹¤.
    if (topicArea) { // topicAreaê°€ nullì´ ì•„ë‹ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        topicArea.style.display = 'none !important';
    }
}
   
    function showSubTopics() { if (!selectedMain) { console.warn("showSubTopics í˜¸ì¶œë˜ì—ˆìœ¼ë‚˜, selectedMainì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return;  } console.log("showSubTopics í•¨ìˆ˜ ì‹œì‘ë¨, ì„ íƒëœ ë©”ì¸ ì£¼ì œ:", selectedMain); appendMessage('ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì´ì•¼ê¸°í•´ ì¤„ë˜?', 'assistant'); let subtopicOptions; if (selectedMain === 'ììœ ì£¼ì œ') { subtopicOptions = [{ icon: 'ğŸ—£ï¸', displayText: 'ì‘, ììœ ë¡­ê²Œ ì´ì•¼ê¸° ì‹œì‘í•´ì¤˜!' }]; } else { const ageGroupData = counselingTopicsByAge[getAgeGroup()]; const mainTopicData = ageGroupData ? ageGroupData[selectedMain] : undefined; if (mainTopicData && Array.isArray(mainTopicData)) { subtopicOptions = mainTopicData;  } else { console.warn(`'${selectedMain}'ì— ëŒ€í•œ í•˜ìœ„ ì£¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.`); subtopicOptions = [{ icon: 'ğŸ’¬', displayText: 'ëŒ€í™”ë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ëì–´.' }]; } if (!subtopicOptions || !subtopicOptions.length) {  subtopicOptions = [{ icon: 'â–¶ï¸', displayText: 'ë°”ë¡œ ëŒ€í™” ì‹œì‘í• ê¹Œ?' }]; } } console.log("displayOptionsInChatì— ì „ë‹¬ë  í•˜ìœ„ ì£¼ì œ ë°°ì—´ (ìˆ˜ì • í›„):", subtopicOptions); displayOptionsInChat(subtopicOptions, (selectedSubtopicText) => { startChat(selectedSubtopicText); }); if (topicArea) topicArea.style.display = 'none !important'; }

    function startChat(initText) { console.log("startChat í•¨ìˆ˜ ì‹œì‘ë¨, ì´ˆê¸° ë©”ì‹œì§€:", initText); if (topicArea) topicArea.style.display = 'none !important'; inputArea.style.display = 'flex'; sendMessage(initText, 'topic_selection_init'); /* ì£¼ì œ ì„ íƒ ì™„ë£Œ í›„ ì‹œì‘ë˜ëŠ” ë©”ì‹œì§€ì´ë¯€ë¡œ inputMethod ë³€ê²½ */ }   

    function getAgeGroup() { if (userAge <= 10) return '7-10'; if (userAge <= 15) return '11-15'; return '30+'; }  

    // Stuck Detection
    function detectStuck(txt, his, meta) { const now = Date.now(); if (meta.lastInputTimestamp && (now - meta.lastInputTimestamp) > 300000) return true; if (meta.fillerCount >= 3) return true; const recentUserMessages = his.filter(m => m.role === 'user').slice(-5); if (recentUserMessages.length === 5 && recentUserMessages.every(m => m.content.trim().length < 5)) return true; if (meta.clickedOption) return false; return false; }
    
    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    async function sendMessage(text, inputMethod = 'text') { 
      if (!text || String(text).trim() === '' || isProcessing) return;
      isProcessing = true;
      sendBtn.classList.add('loading');

      if (inputMethod !== 'topic_selection_init') { 
        appendMessage(text, 'user');
      }
      chatHistory.push({ role: 'user', content: text }); 
      chatInput.value = '';

      const thinkingBubble = document.createElement('div');
      thinkingBubble.className = 'bubble assistant thinking'; 
      thinkingBubble.textContent = 'ìƒê°ì¤‘ì´ì•¼...'; 
      chatWindow.appendChild(thinkingBubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const res = await getGptResponse(text, { chatHistory }); 
        thinkingBubble.remove(); 

        if (!res.ok) {
            const errorData = await res.text();
            console.error(`GPT API ì‘ë‹µ ì˜¤ë¥˜ ${res.status}: ${errorData}`);
            appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. (ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜)", "assistant_feedback");
            return; 
        }
        const d = await res.json();
        const cut = d.text.indexOf('{'); 
        const clean = cut >= 0 ? d.text.slice(0, cut).trim() : d.text.trim();
        
        appendMessage(clean, 'assistant'); 

        if (inputMethod === 'stt') { 
            await playTTSWithControl(clean);
        } else if (inputMethod === 'text' && !skipTTS) { 
            // í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œ TTSë¥¼ ì›í•˜ì‹œë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
            // await playTTSWithControl(clean); 
            console.log("í…ìŠ¤íŠ¸ ì…ë ¥ì— ëŒ€í•œ ì‘ë‹µ. TTSëŠ” í˜„ì¬ ì¬ìƒ ì•ˆ í•¨.");
        }
        if (skipTTS) skipTTS = false; 
        
        chatHistory.push({ role: 'assistant', content: clean });
        await saveSessionLog(text, clean, d.analysis || {}); 

        const elapsedTimeInMinutes = (Date.now() - conversationStartTime) / (1000 * 60);
        // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 15ë¶„(elapsedTimeInMinutes >= 10)ìœ¼ë¡œ ë³€ê²½
        if (elapsedTimeInMinutes >= 15 && !analysisNotificationShown) { 
            console.log(`${elapsedTimeInMinutes.toFixed(5)}ë¶„ ê²½ê³¼, ìƒì„¸ ë¶„ì„ ì‹œë„`);
            // ë¶„ì„ ê²°ê³¼ ì €ì¥ ë° ì•Œë¦¼ ë¡œì§ (analysis.htmlì—ì„œ ì‚¬ìš©)
            let detailedAnalysisData = {};
            if (LOZEE_ANALYSIS && LOZEE_ANALYSIS.inferAgeAndLanguage) {
                try {
                    const langAgeResult = await LOZEE_ANALYSIS.inferAgeAndLanguage(chatHistory.map(m=>`${m.role}: ${m.content}`).join('\n'));
                    detailedAnalysisData.ageLanguageAnalysis = langAgeResult;
                } catch (e) { console.error("inferAgeAndLanguage ì˜¤ë¥˜:", e); }
            }
            // ì—¬ê¸°ì— ë‹¤ë¥¸ ë¶„ì„ ê²°ê³¼ë“¤ ì¶”ê°€ ê°€ëŠ¥
            // ì˜ˆ: detailedAnalysisData.emotionTone = await LOZEE_ANALYSIS.getOverallEmotionTone(chatHistory);

            if(Object.keys(detailedAnalysisData).length > 0) {
                localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                    startTime: conversationStartTime,
                    analysisTime: Date.now(),
                    results: detailedAnalysisData
                }));
                showAnalysis(); //"ë¶„ì„ ì™„ë£Œ" ì•Œë¦¼ í‘œì‹œ ë° analysisNotificationShown = true; ë¡œ ì„¤ì •ë¨
            }
        }

      } catch (error) {
        if(thinkingBubble) thinkingBubble.remove(); 
        console.error("sendMessage ë‚´ ì˜¤ë¥˜:", error);
        appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?", "assistant_feedback");
      } finally {
        isProcessing = false;
        sendBtn.classList.remove('loading');
      }
    }   

    // assistantì˜ ë§ì˜ ì–‘
    function askForVerbosityPreference() {
    if (verbosityPromptCount >= 2) return; // ì„¸ì…˜ë‹¹ ìµœëŒ€ 2ë²ˆë§Œ ì§ˆë¬¸

     const options = [
    { displayText: "ë§ì„ ì¢€ ì¤„ì—¬ì¤˜" },
    { displayText: "ì§€ê¸ˆì´ ì ë‹¹í•´" },
    { displayText: "ë‚˜ì—ê²Œ ë” ë§ì€ ì¡°ì–¸ì„ ì¤˜" }
    ];
 
     appendMessage("ì§€ê¸ˆ ë‚´ê°€ í•˜ëŠ” ë§ì´ ë„ˆì—ê²Œ ì ë‹¹í•œì§€ ì•Œë ¤ì¤„ë˜?", 'assistant');
     // await playTTSWithControl("ì§€ê¸ˆ ë‚´ê°€ í•˜ëŠ” ë§ì´ ë„ˆì—ê²Œ ì ë‹¹í•œì§€ ì•Œë ¤ì¤„ë˜?");

    displayOptionsInChat(options, (selectedOption) => {
    appendMessage(selectedOption, 'user'); 

    if (selectedOption === "ë§ì„ ì¢€ ì¤„ì—¬ì¤˜") {
      gptVerbosityPreference = 'short';
    } else if (selectedOption === "ë‚˜ì—ê²Œ ë” ë§ì€ ì¡°ì–¸ì„ ì¤˜") {
      gptVerbosityPreference = 'verbose';
    } else {
      gptVerbosityPreference = 'default';
    }
    
    verbosityPromptCount++; // ì§ˆë¬¸ íšŸìˆ˜ ì¦ê°€
    lastVerbosityPromptTime = Date.now(); // ë§ˆì§€ë§‰ ì§ˆë¬¸ ì‹œê°„ ê¸°ë¡
    
    const followupMessage = "ì•Œë ¤ì¤˜ì„œ ê³ ë§ˆì›Œ! ì´ ì„¤ì •ì€ ì•½ 10ë¶„ê°„ ìœ ì§€ë  ê±°ì•¼. ê³„ì†í•´ì„œ í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸°ë¥¼ í•´ì¤˜.";
    appendMessage(followupMessage, 'assistant');
    // await playTTSWithControl(followupMessage);
    });
   }
  
    // ... (ê¸°ì¡´ isProcessing, appendMessage(user), chatHistory.push(user), thinkingBubble ë“± ë¡œì§) ...
    if (!conversationStartTime) conversationStartTime = Date.now(); // ìµœì´ˆ ëŒ€í™” ì‹œì‘ ì‹œê°„ ê¸°ë¡

    try {
    const elapsedTimeInMinutes = (Date.now() - conversationStartTime) / (1000 * 60);
    
    // getGptResponse í˜¸ì¶œ ì‹œ í˜„ì¬ verbosityì™€ ê²½ê³¼ ì‹œê°„ ì •ë³´ ì „ë‹¬
    const res = await getGptResponse(text, { 
        chatHistory, 
        verbosity: gptVerbosityPreference, 
        elapsedTime: elapsedTimeInMinutes 
    }); 
    
    thinkingBubble.remove(); // ì‘ë‹µ í›„ ìƒê° ì¤‘ í’ì„  ì œê±°

    // ... (ê¸°ì¡´ res.ok ì²´í¬ ë° d, clean ë³€ìˆ˜ ì²˜ë¦¬ ë¡œì§) ...
    
    appendMessage(clean, 'assistant');

    // ... (inputMethodì— ë”°ë¥¸ TTS í˜¸ì¶œ ë¡œì§) ...
    
    chatHistory.push({ role: 'assistant', content: clean });
    assistantMessageCount++; // AI ì‘ë‹µ íšŸìˆ˜ ì¦ê°€
    
    // ... (saveSessionLog, ê¸°ì¡´ ë¶„ì„ ì•Œë¦¼ ë¡œì§ ë“±) ...

    // ë§ ê¸¸ì´ ì„ í˜¸ë„ ì§ˆë¬¸ ì¡°ê±´ ì²´í¬
    if (verbosityPromptCount === 0 && assistantMessageCount >= 5) {
      askForVerbosityPreference();
    } else if (verbosityPromptCount === 1 && (Date.now() - lastVerbosityPromptTime > PREFERENCE_PROMPT_INTERVAL)) {
      askForVerbosityPreference();
    }

    // 20ë¶„ ê²½ê³¼ ì‹œ ë¡œì§€ì˜ ì—­í•  ë³€í™”ëŠ” getSystemPromptì—ì„œ ì²˜ë¦¬ (ì•„ë˜ ì°¸ê³ )

  } catch (error) {
    // ... (ê¸°ì¡´ ì˜¤ë¥˜ ì²˜ë¦¬) ...
  } finally {
    // ... (isProcessing = false ë“±) ...
  }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    sendBtn.addEventListener('click', () => sendMessage(chatInput.value, 'text')); 
    chatInput.addEventListener('keydown', e => {
      meta.lastInputTimestamp = Date.now();
      meta.clickedOption = false;
      // const fillers = ['ìŒ','â€¦','ì–´','ê¸€ì„','ëª¨ë¥´ê² ì–´ìš”','ì˜ ëª¨ë¥´ê² ì–´']; 
      // meta.fillerCount = fillers.some(f => chatInput.value.includes(f)) ? meta.fillerCount + 1 : 0; // í•„ìš”ì‹œ í™œì„±í™”
      
      if (isPlayingTTS) { 
        stopCurrentTTS();
        skipTTS = true;
      }
      
      if (e.key === 'Enter' && !e.isComposing) { 
        e.preventDefault(); 
        sendMessage(chatInput.value, 'text'); 
      }
    });
  </script>
</body>
</html>