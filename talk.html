<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
<style>
  :root {
      --primary-color: #6e8efb;
      --secondary-color: #5a7edf;
      --background-color: #ffffff;
      --text-color: #333333;
      
      --gnb-bg: #354157;
      --gnb-text-color: #ffffff;
      --gnb-title-color: var(--primary-color);
      --gnb-menu-toggle-color: var(--primary-color);
      --gnb-dropdown-bg: var(--gnb-bg);
      --gnb-dropdown-text-color: var(--gnb-text-color);
      --gnb-dropdown-border-color: #4a5568;
      --gnb-dropdown-hover-bg: var(--secondary-color);

      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --ai-bubble-bg: #F5E7A1;;
      --ai-bubble-text: #333333;

      --input-area-bg: #f8f9fa;
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef;
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px;
      --meter-top-margin: 8px;

      /* #topic-area ê´€ë ¨ ë³€ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ */
      /* --topic-button-bg: var(--primary-color); */
      /* --topic-button-text: #ffffff; */
      /* --topic-button-hover-bg: var(--secondary-color); */

      --analysis-notification-bg: #fff3cd;
      --analysis-notification-text: #856404;

      --gnb-height: 56px;
      --chat-input-area-height: 70px;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    #gnb {
      padding: 0 30px; /* ì•ˆì „ì§€ëŒ€ 30px ì ìš© */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--gnb-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gnb-title-color);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gnb-menu-toggle-color);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--gnb-dropdown-bg);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.2);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 300px;
    }

    #dropdown-menu a {
      display: block;
      padding: 12px 16px;
      text-decoration: none;
      color: var(--gnb-dropdown-text-color);
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
      font-size: 0.95em;
    }
    #dropdown-menu a:last-child {
      border-bottom: none;
    }
    #dropdown-menu a:hover {
      background-color: var(--gnb-dropdown-hover-bg);
    }

    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px;
      transition: width 0.05s linear, background-color 0.05s linear;
    }
    
    #chat-window {
      flex: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
      padding-bottom: calc(var(--chat-input-area-height) + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.ai {
      background: var(--ai-bubble-bg);
      color: var(--ai-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    /* ê¸°ì¡´ #topic-areaëŠ” ìƒˆë¡œìš´ UI ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´ë˜ë¯€ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ */
    #topic-area {
      display: none !important; 
    }
    /* .topic-btn, .subtopic-btn ê´€ë ¨ ìŠ¤íƒ€ì¼ë„ #topic-areaë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë¶ˆí•„ìš” */

    #input-area {
      padding: 0 30px; /* ì•ˆì „ì§€ëŒ€ 30px ì ìš© */
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; /* ì´ˆê¸° ìˆ¨ê¹€, startChat()ì—ì„œ flexë¡œ ë³€ê²½ */
      align-items: center;
      gap: 8px;
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px;
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px;
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn {
      width: 44px;
      min-width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording {
      background: #e74c3c;
    }
    #send-btn.loading {
        background:#cccccc;
        cursor:default;
    }
    
    @media (max-width: 600px) {
      #gnb { padding: 0 20px; } /* ëª¨ë°”ì¼ì—ì„œëŠ” GNB íŒ¨ë”© ì•½ê°„ ì¤„ì„ */
      #input-area { padding: 0 20px; } /* ëª¨ë°”ì¼ì—ì„œëŠ” ì…ë ¥ì°½ íŒ¨ë”© ì•½ê°„ ì¤„ì„ */
      #gnb-title { font-size: 1.1em; }
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
      /* #topic-area ê´€ë ¨ ë°˜ì‘í˜• ê·œì¹™ì€ ë” ì´ìƒ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ */
    }

    /* ì±„íŒ…ì°½ ë‚´ ì„ íƒì§€ ì»¨í…Œì´ë„ˆ */
    .chat-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
      align-items: flex-start;
      max-width: 80%;
      align-self: flex-start;
    }

    /* ì±„íŒ…ì°½ ë‚´ ì„ íƒ ë²„íŠ¼ */
    .chat-option-btn {
      background-color: #f1f1f1;
      color: #333333;
      border: 1px solid #dcdcdc;;
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .chat-option-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-1px);
    }

    .chat-option-btn.selected {
      background-color: #E4D2FD;
      color: #333;
      border-color: #c3b2e0; /* ì˜¤íƒ€ ìˆ˜ì • */
      font-weight: bold;
    }

    .chat-option-btn:disabled {
      background-color: #f8f8f8;
      color: #aaaaaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">â˜°</button>
    <div id="dropdown-menu">
      <a href="mypage.html">My Page</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ëŒ€í™” ëª©ë¡</a>
    </div>
  </nav>
  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-window"></div>
  <div id="input-area">
    <button id="mic-button">ğŸ¤</button>
    <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
    <button id="send-btn">â¤</button>
  </div>

  <script type="module">
    import './js/firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js'; // `stopCurrentTTS`ë„ import
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { saveSessionLog } from './js/firebase-utils.js';
    import { counselingTopicsByAge } from './js/counseling_topics.js';

    // ìƒíƒœ
    let skipTTS = false;
    let hasGreeted = false;
    let isProcessing = false;
    let chatHistory = [];
    let selectedMain = null;
    let meta = { lastInputTimestamp: Date.now(), fillerCount: 0, clickedOption: false, presentedIndices:[] };
    let isPlayingTTS = false; // TTS ì¬ìƒ ìƒíƒœ ì¶”ì 

    // UI ìš”ì†Œ
    const chatWindow = document.getElementById('chat-window');
    const topicArea = document.getElementById('topic-area'); // ì´ì œ ì‚¬ìš© ì•ˆ í•  ìˆ˜ ìˆì§€ë§Œ, ë³€ìˆ˜ëŠ” ìœ ì§€ (ì˜¤ë¥˜ ë°©ì§€)
    const inputArea = document.getElementById('input-area');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const micButton = document.getElementById('mic-button');
    const menuToggle = document.getElementById('menu-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const meterLevel = document.getElementById('volume-level');

    // GNB ë©”ë‰´ í† ê¸€
    menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
    document.addEventListener('click', e => {
      if (!document.getElementById('gnb').contains(e.target)) {
        dropdownMenu.classList.remove('show');
      }
    });

    // ì‚¬ìš©ì ì •ë³´ (localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
    const voc = getKoreanVocativeParticle(userName); // gpt-dialog.jsì—ì„œ export í•„ìš”

    // ì´ˆê¸°í™” ë¡œì§ (ë‹¨ì¼ DOMContentLoaded ë¦¬ìŠ¤ë„ˆ)
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âœ… js/firebase-config.js ëª¨ë“ˆ ë¡œë“œë¨');
      console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');

      const greeting = getInitialGreeting(userName + voc, hasGreeted); // gpt-dialog.jsì—ì„œ export í•„ìš”
      appendMessage(greeting, 'ai');
      
      try {
        await playTTSWithControl(greeting);
      } catch (error) {
        console.warn("ì²« TTS ìë™ ì¬ìƒ ì‹¤íŒ¨ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”í•  ìˆ˜ ìˆìŒ):", error);
        // TODO: ì‚¬ìš©ìì—ê²Œ í´ë¦­ ìœ ë„ ë©”ì‹œì§€ í‘œì‹œ ë˜ëŠ” ë‹¤ë¥¸ ëŒ€ì•ˆ ê³ ë ¤
      }
      
      hasGreeted = true;
      showMainTopics();
    });

    // ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜
    function appendMessage(text, role) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + role;
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showAnalysis() {
      const notification = document.createElement('div');
      notification.className = 'analysis-notification';
      notification.textContent = 'ğŸŸ¡ë¶„ì„ ì™„ë£Œ';
      notification.onclick = () => location.href = 'analysis.html'; // analysis.htmlì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”
      chatWindow.appendChild(notification);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // TTS ì œì–´ ì¬ìƒ í•¨ìˆ˜
    async function playTTSWithControl(txt) {
      stopCurrentTTS(); // tts.jsì—ì„œ export í•„ìš”
      if (skipTTS) {
        skipTTS = false;
        return Promise.resolve(); // TTS ê±´ë„ˆë›¸ ë•Œë„ Promise ë°˜í™˜ ì¼ê´€ì„±
      }
      isPlayingTTS = true;
      try {
        await playTTSFromText(txt, localStorage.getItem('lozee_voice')); // tts.jsì—ì„œ export í•„ìš”
      } catch (error) {
        console.error("playTTSWithControl ë‚´ TTS ì¬ìƒ ì˜¤ë¥˜:", error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ isPlayingTTS ìƒíƒœ ì—…ë°ì´íŠ¸
      } finally {
        isPlayingTTS = false;
      }
    }

    // ì˜¤ë””ì˜¤ ë¶„ì„ ê´€ë ¨ (Web Audio API)
    let audioContext, analyser, source, dataArray, animId, streamRef;
    const LOW = { r:0, g:200, b:0 };
    const MID = { r:255, g:200, b:0 };
    const HIGH = { r:255, g:69, b:0 };

    function interp(c1, c2, f) {
      return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;
    }

    function setupAudioAnalysis(stream) {
      if (audioContext) audioContext.close();
      audioContext = new AudioContext();
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      streamRef = stream; // ë‚˜ì¤‘ì— íŠ¸ë™ ì¤‘ì§€ë¥¼ ìœ„í•´ ìŠ¤íŠ¸ë¦¼ ì°¸ì¡° ì €ì¥
      draw();
    }

    function draw() {
      animId = requestAnimationFrame(draw);
      if (!analyser || !dataArray) return;
      analyser.getByteFrequencyData(dataArray);
      let sum = dataArray.reduce((a, v) => a + v, 0);
      let avg = sum / dataArray.length;
      let norm = Math.min(100, Math.max(0, (avg / 140) * 100));
      meterLevel.style.width = norm + '%';
      let col = norm <= 50 ? interp(LOW, MID, norm / 50) : interp(MID, HIGH, (norm - 50) / 50);
      meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${col})`;

      // ì‚¬ìš©ì ìŒì„± ê°ì§€ ì‹œ TTS ì¤‘ë‹¨ (STT í™œì„±í™” ë° TTS ì¬ìƒ ì¤‘ì—ë§Œ)
      if (norm > 10 && isRec && isPlayingTTS && !skipTTS) {
        console.log("ì‚¬ìš©ì ìŒì„± ê°ì§€, TTS ì¤‘ë‹¨ ì‹œë„");
        stopCurrentTTS();
        skipTTS = true;
      }
    }

    function stopAudio() {
      if (animId) cancelAnimationFrame(animId);
      if (source) source.disconnect();
      if (streamRef) streamRef.getTracks().forEach(track => track.stop());
      if (audioContext) audioContext.close();
      meterLevel.style.width = '0%';
      // meterLevel ê¸°ë³¸ ë°°ê²½ìƒ‰ ì„¤ì • (CSS ë³€ìˆ˜ ì‚¬ìš© ê¶Œì¥)
      meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-container-bg');
    }

    // STT (Web Speech API)
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog, isRec = false;

    if (SpeechRecognitionAPI) {
      recog = new SpeechRecognitionAPI();
      recog.continuous = true; // ì—°ì†ì ì¸ ê²°ê³¼ ë°˜í™˜ ì•ˆ í•¨ (í•˜ë‚˜ì˜ ë¬¸ì¥ ì™„ì„± í›„ ê²°ê³¼)
      recog.interimResults = false; // ì¤‘ê°„ ê²°ê³¼ ë°˜í™˜ ì•ˆ í•¨
      recog.lang = 'ko-KR';

      recog.onstart = () => {
        isRec = true;
        micButton.classList.add('recording');
      };
      recog.onend = () => {
        isRec = false;
        micButton.classList.remove('recording');
        stopAudio(); // STT ì¢…ë£Œ ì‹œ ì˜¤ë””ì˜¤ ë¶„ì„ë„ ì¤‘ì§€
      };
      recog.onresult = event => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            transcript += event.results[i][0].transcript;
          }
        }
        if (transcript) {
          console.log("STT ê²°ê³¼:", transcript);
          sendMessage(transcript);
        }
      };
      recog.onerror = event => {
        console.error('Speech recognition error:', event.error);
        appendMessage('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error, 'ai_feedback');
        isRec = false;
        micButton.classList.remove('recording');
        stopAudio();
      };

      micButton.onclick = async () => {
        if (isRec) {
          recog.stop();
        } else {
          stopCurrentTTS(); // í˜„ì¬ TTS ì¤‘ì§€
          skipTTS = true;   // ë‹¤ìŒ AI ì‘ë‹µ TTS ê±´ë„ˆë›°ê¸°

          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupAudioAnalysis(stream); // ì˜¤ë””ì˜¤ ë¶„ì„ ì‹œì‘
            recog.start();
          } catch (e) {
            console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', e);
            appendMessage('ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'ai_feedback');
          }
        }
      };
    } else {
      micButton.disabled = true;
      appendMessage('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'ai_feedback');
    }

    // í† í”½ í”Œë¡œìš° - ì„ íƒì°½ (ì±„íŒ…ì°½ ë‚´ ë²„íŠ¼ í‘œì‹œ)
    function displayOptionsInChat(optionsArray, onSelectCallback, context = null) {
      console.log("displayOptionsInChat í•¨ìˆ˜ ì‹œì‘ë¨, ì˜µì…˜ ë°°ì—´:", optionsArray); // ì˜µì…˜ ë°°ì—´ì˜ ì‹¤ì œ ë‚´ìš© í™•ì¸
      const optionsContainer = document.createElement('div');
      optionsContainer.className = 'chat-options-container';

      const buttons = []; 

  // optionsArrayê°€ { icon: "ğŸ˜Š", displayText: "ì´ì•¼ê¸°" } í˜•íƒœì˜ ê°ì²´ ë°°ì—´ì´ë¼ê³  ê°€ì •
  optionsArray.forEach(optionObject => { // optionText ëŒ€ì‹  optionObjectë¡œ ë³€ê²½
    // optionObjectê°€ ì‹¤ì œë¡œ ê°ì²´ì¸ì§€, í•„ìš”í•œ ì†ì„±(icon, displayText)ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
    if (optionObject && typeof optionObject.displayText !== 'undefined') {
        console.log("ì˜µì…˜ ë²„íŠ¼ ìƒì„± ì¤‘:", optionObject.displayText);
        const button = document.createElement('button');
        button.className = 'chat-option-btn';
        
        // ì´ëª¨ì§€ê°€ ìˆë‹¤ë©´ í•¨ê»˜ í‘œì‹œ, ì—†ë‹¤ë©´ displayTextë§Œ í‘œì‹œ
        button.textContent = optionObject.icon ? `${optionObject.icon} ${optionObject.displayText}` : optionObject.displayText;

        button.onclick = () => {
          buttons.forEach(btn => {
            btn.disabled = true; 
            if (btn === button) {
              btn.classList.add('selected'); 
            }
          });
          onSelectCallback(optionObject.displayText, context); 
        };
        optionsContainer.appendChild(button);
        buttons.push(button);
    } else {
        // optionsArrayì˜ ìš”ì†Œê°€ ì˜ˆìƒí•œ ê°ì²´ í˜•íƒœê°€ ì•„ë‹ ê²½ìš° ë¡œê·¸ë¥¼ ë‚¨ê¸°ê±°ë‚˜ ì˜¤ë¥˜ ì²˜ë¦¬
        console.warn("displayOptionsInChat: ì˜ëª»ëœ í˜•ì‹ì˜ ì˜µì…˜ ê°ì²´ì…ë‹ˆë‹¤.", optionObject);
    }
  });

  chatWindow.appendChild(optionsContainer);
  console.log("ì˜µì…˜ ì»¨í…Œì´ë„ˆê°€ chatWindowì— ì¶”ê°€ë¨");
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

    // í† í”½ í”Œë¡œìš° - ì£¼ì œ (ìˆ˜ì •ëœ ë¡œì§)
    function showMainTopics() {
      console.log("showMainTopics í•¨ìˆ˜ ì‹œì‘ë¨");
      appendMessage('ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³¼ê¹Œ?', 'ai');
  
        const currentAgeGroup = getAgeGroup();
        const ageGroupData = counselingTopicsByAge[currentAgeGroup];
        let topicsWithOptions = []

        if (ageGroupData) {
        topicsWithOptions = Object.keys(ageGroupData).map(categoryName => {
           // ê° ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ì£¼ì œ í•­ëª©ì—ì„œ ì•„ì´ì½˜ì„ ê°€ì ¸ì˜¤ê±°ë‚˜,
           // ì¹´í…Œê³ ë¦¬ ìì²´ì— ëŒ€í‘œ ì•„ì´ì½˜ì„ ì§€ì •í•˜ëŠ” ë°©ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.
           // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ ê¸°ë³¸ ì•„ì´ì½˜ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ì²« ë²ˆì§¸ í•­ëª©ì˜ ì•„ì´ì½˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
           let icon = 'ğŸ’¬'; // ê¸°ë³¸ ì•„ì´ì½˜
           if (ageGroupData[categoryName] && ageGroupData[categoryName].length > 0 && ageGroupData[categoryName][0].icon) {
             icon = ageGroupData[categoryName][0].icon;
           }
           return { icon: icon, displayText: categoryName };
        });
     } else {
       console.warn(`counselingTopicsByAgeì— '${currentAgeGroup}'ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
     }

     topicsWithOptions.push({ icon: 'ğŸ—£ï¸', displayText: 'ììœ ì£¼ì œ' });
  
     console.log("displayOptionsInChatì— ì „ë‹¬ë  ë°°ì—´:", topicsWithOptions); // ìˆ˜ì •ëœ ë°°ì—´ í™•ì¸
     displayOptionsInChat(topicsWithOptions, (selectedTopicText) => {
     selectedMain = selectedTopicText;
     appendMessage(selectedMain + ' ì´ì•¼ê¸°ë¥¼ ì„ íƒí–ˆêµ¬ë‚˜!', 'ai'); 
     setTimeout(showSubTopics, 300);
    });
  if (topicArea) topicArea.style.display = 'none !important';
  }
   
    function showSubTopics() {
      // selectedMainì´ nullì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë°©ì–´ ì½”ë“œ ì¶”ê°€
     if (!selectedMain) {
    console.warn("showSubTopics í˜¸ì¶œë˜ì—ˆìœ¼ë‚˜, selectedMainì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return; 
    }
    console.log("showSubTopics í•¨ìˆ˜ ì‹œì‘ë¨, ì„ íƒëœ ë©”ì¸ ì£¼ì œ:", selectedMain);
    appendMessage('ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì´ì•¼ê¸°í•´ ì¤„ë˜?', 'ai');
  
    let subtopics;
    if (selectedMain === 'ììœ ì£¼ì œ') {
    subtopics = ['ì‘, ììœ ë¡­ê²Œ ì´ì•¼ê¸° ì‹œì‘í•´ì¤˜!'];
    } else {
    const ageGroupTopics = counselingTopicsByAge[getAgeGroup()];
    const mainTopicDetails = ageGroupTopics && ageGroupTopics[selectedMain];
    subtopics = mainTopicDetails ? mainTopicDetails.map(item => item.displayText) : ['ëŒ€í™”ë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ëì–´.'];
    if (!subtopics.length) {
        subtopics = ['ë°”ë¡œ ëŒ€í™” ì‹œì‘í• ê¹Œ?'];
    }
  }

  // displayOptionsInChatì˜ ì½œë°±ì€ ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ "í´ë¦­"í–ˆì„ ë•Œë§Œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
  displayOptionsInChat(subtopics, (selectedSubtopicByUser) => { // ì½œë°± íŒŒë¼ë¯¸í„°ëª… ë³€ê²½
    console.log("í•˜ìœ„ ì£¼ì œ ì„ íƒë¨:", selectedSubtopicByUser); // ë””ë²„ê¹… ë¡œê·¸
    startChat(selectedSubtopicByUser); // ì„ íƒëœ í•˜ìœ„ ì£¼ì œë¡œ ëŒ€í™” ì‹œì‘
  });
  if (topicArea) topicArea.style.display = 'none !important';
}

    function startChat(initText) {
      console.log("startChat í•¨ìˆ˜ ì‹œì‘ë¨, ì´ˆê¸° ë©”ì‹œì§€:", initText);
      if (topicArea) topicArea.style.display = 'none !important';
      inputArea.style.display = 'flex'; // ì…ë ¥ì°½ í‘œì‹œ
      sendMessage(initText);
    }   

    function getAgeGroup() {
      if (userAge <= 10) return '7-10';
      if (userAge <= 15) return '11-15';
      return '30+'; // ê¸°ë³¸ê°’ ë˜ëŠ” ì„±ì¸
    }  

    // Stuck Detection (ì‚¬ìš©ì ìš”ì²­ìœ¼ë¡œ showPreferenceOptionsëŠ” ì œê±°ë¨)
    function detectStuck(txt, his, meta) {
      const now = Date.now();
      if (meta.lastInputTimestamp && (now - meta.lastInputTimestamp) > 300000) return true; // 5ë¶„ ì´ìƒ ì…ë ¥ ì—†ì„ ë•Œ
      if (meta.fillerCount >= 3) return true; // í•„ëŸ¬ 3íšŒ ì´ìƒ
      const recentUserMessages = his.filter(m => m.role === 'user').slice(-5);
      if (recentUserMessages.length === 5 && recentUserMessages.every(m => m.content.trim().length < 5)) return true; // ìµœê·¼ 5íšŒ ì‚¬ìš©ì ë°œí™” ë§¤ìš° ì§§ìŒ
      if (meta.clickedOption) return false; // ì˜µì…˜ í´ë¦­ ì§í›„ëŠ” stuck ì•„ë‹˜
      return false;
    }
    // showPreferenceOptions í•¨ìˆ˜ëŠ” ì œê±°ë¨

    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    async function sendMessage(text) {
      if (!text || String(text).trim() === '' || isProcessing) return;
      isProcessing = true;
      sendBtn.classList.add('loading');

      appendMessage(text, 'user');
      chatHistory.push({ role: 'user', content: text });
      chatInput.value = '';

      try {
        const res = await getGptResponse(text, { chatHistory }); // gpt-dialog.jsì—ì„œ export í•„ìš”
        if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`GPT API ì˜¤ë¥˜ ${res.status}: ${errorData}`);
        }
        const d = await res.json();
        const cut = d.text.indexOf('{'); // ë¶„ì„ JSONì´ í•¨ê»˜ ì˜¬ ê²½ìš° ì˜ë¼ë‚´ê¸°
        const clean = cut >= 0 ? d.text.slice(0, cut).trim() : d.text.trim();
        
        appendMessage(clean, 'ai');
        await playTTSWithControl(clean);
        
        chatHistory.push({ role: 'ai', content: clean });
        await saveSessionLog(text, clean, d.analysis || {}); // firebase-utils.jsì—ì„œ export í•„ìš”

        if (d.analysis) {
          // LOZEE_ANALYSIS.trackEmotionTone(d.analysis); // í•„ìš”ì‹œ í˜¸ì¶œ
          // LOZEE_ANALYSIS.trackSituation(d.analysis); // í•„ìš”ì‹œ í˜¸ì¶œ
          if (LOZEE_ANALYSIS && LOZEE_ANALYSIS.inferAgeAndLanguage) { // lozee-analysis.jsì—ì„œ export í•„ìš”
             await LOZEE_ANALYSIS.inferAgeAndLanguage(chatHistory.map(m=>m.role+':'+m.content).join('\n'));
          }
          showAnalysis(); // ë¶„ì„ ì™„ë£Œ ì•Œë¦¼ í‘œì‹œ
        }
      } catch (error) {
        console.error("sendMessage ë‚´ ì˜¤ë¥˜:", error);
        appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?", "ai_feedback");
      } finally {
        isProcessing = false;
        sendBtn.classList.remove('loading');
      }
    }   

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    sendBtn.addEventListener('click', () => sendMessage(chatInput.value));
    chatInput.addEventListener('keydown', e => {
      meta.lastInputTimestamp = Date.now();
      const fillers = ['ìŒ','â€¦','ì–´','ê¸€ì„','ëª¨ë¥´ê² ì–´ìš”','ì˜ ëª¨ë¥´ê² ì–´'];
      meta.fillerCount = fillers.some(f => chatInput.value.includes(f)) ? meta.fillerCount + 1 : 0;
      meta.clickedOption = false;
      
      stopCurrentTTS();
      skipTTS = true;
      
      if (e.key === 'Enter' && !e.isComposing) { // í•œê¸€ ì…ë ¥ ì™„ë£Œ í›„ Enter í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        e.preventDefault(); // Enter í‚¤ ê¸°ë³¸ ë™ì‘(ì¤„ë°”ê¿ˆ ë“±) ë°©ì§€
        sendMessage(chatInput.value);
      }
    });
  </script>
</body>
</html>