<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ ë²„ì „(v3.19)ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. */
    body { display: flex; flex-direction: column; min-height: 100vh; background-color: #ffffff; color: #333; font-family: 'KoPubWorld Dotum', sans-serif; margin: 0; }
    #main-header { background-color: #0095FF; color: white; padding: 1rem; text-align: center; font-size: 20px; font-weight: bold; flex-shrink: 0; }
    #chat-container { flex: 1; display: flex; flex-direction: column; overflow-y: hidden; width: 100%; max-width: 700px; margin: 0 auto; box-sizing: border-box; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; font-size: 16px; white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user { background-color: #fff9c4; color: #333; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .ai { background-color: #0095FF; color: white; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 5px; }
    .bubble.ai.error { background-color: #ff7373; color: white; }
    #loading-indicator-talk { text-align: center; padding: 10px; display: none; color: #555; font-style: italic; }
    #talk-btn-container { padding: 15px 0; background-color: #ffffff; flex-shrink: 0; text-align: center; border-top: 1px solid #eee; }
    #talk-btn { font-family: 'KoPubWorld Dotum', sans-serif; width: 80px; height: 80px; border-radius: 50%; background-color: #b6b6b6; border: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); color: white; font-size: 36px; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; transition: transform 0.2s ease, background-color 0.3s; }
    #talk-btn.active { background-color: #0095FF; transform: scale(1.1); }
    #talk-btn.recording-in-progress { background-color: #e06c75; transform: scale(1.1); }
    #talk-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: scale(1.0); }
    #topic-selection { display: none; background: #f0f0f0; padding: 20px; border-top: 1px solid #ddd; text-align: center; flex-shrink: 0; }
    #topic-selection h3 { font-size: 18px; color: #333; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
    .topic-option { font-family: 'KoPubWorld Dotum', sans-serif; padding: 10px 15px; margin: 8px auto; background: white; border: 1px solid #0095FF; color: #0095FF; border-radius: 10px; cursor: pointer; max-width: 320px; font-size: 15px; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
    .topic-option:hover { background-color: #0095FF; color: white; }
    #waiting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);  display: none;  justify-content: center; align-items: center; z-index: 1000;  color: white; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer;  }
  </style>
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="chat-container">
    <div id="chat-window"></div>
    <div id="topic-selection">
      <h3>ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ê³  ì‹¶ì€ ì£¼ì œë¥¼ ê³¨ë¼ë³¼ë˜?</h3>
      <div id="topic-options"></div>
    </div>
  </div>
  <div id="loading-indicator-talk">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>
  <div id="waiting-overlay">
    <p><span id="waitingUserName"></span>ë‹˜, ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...<br><small>(í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”)</small></p>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    console.log("talk.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (v3.27 - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬)");

    let talkBtn, chatWindow, topicSelectionBox, topicOptionsContainer, loadingIndicatorTalk, waitingOverlay, waitingUserNameSpan;

    const currentUserName = localStorage.getItem('lozee_username') || "ì¹œêµ¬";
    const currentUserId = localStorage.getItem('lozee_username'); 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';
    
    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try { selectedEmotions = JSON.parse(selectedEmotionsString); } 
        catch (e) { console.error("ì„ íƒëœ ê°ì • localStorage íŒŒì‹± ì˜¤ë¥˜:", e); selectedEmotions = []; }
    }

    const simplified = (() => {
      const age = parseInt(currentUserAge || "0", 10);
      const disease = (currentUserDisease || "").toLowerCase();
      const needsSimple = age < 15 || ["ì•„ìŠ¤í¼ê±°", "asd", "adhd", "ì‚¬íšŒì ì˜ì‚¬ì†Œí†µì¥ì• "].some(d => disease.includes(d));
      const isVeryYoung = age < 10;
      console.log(`[Simplified Language Check] Age: ${age}, Disease: "${disease}", NeedsSimple: ${needsSimple}, IsVeryYoung: ${isVeryYoung}`);
      return { useSimpleLanguage: needsSimple, useUltraSimpleLanguage: isVeryYoung };
    })();
        
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer;
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTimeValue; 

    const ADMIN_SECRET_PHRASE = "ë§¹ê³ ì–‘ì´"; // ì´ì „ ë²„ì „ ê°’ ìœ ì§€
    const ADMIN_EMAIL = "maengnanyoung@gmail.com"; // ì´ì „ ë²„ì „ ê°’ ìœ ì§€

    let totalCharacterCount = 0;
    let conversationStartTime = null;
    const ANALYSIS_CHAR_THRESHOLD = 800; 
    const ANALYSIS_TIME_THRESHOLD_SECONDS = 180; 
    let analysisRedirectInProgress = false;
    
    // ì—°ë ¹ë³„ ë…¹ìŒ ì •ì±… ê´€ë ¨ ë³€ìˆ˜ (v3.19 ë‚´ìš© ìœ ì§€)
    let currentSegmentDuration = 40000; 
    let maxTotalRecordingTime = 600000;  
    let autoSegmentStartTime = null;     
    let currentSegmentInAutoChain = 0;   
    let autoStopTimer = null; 
    const API_DISCONNECT_DELAY_MS = 100;

    // í•¨ìˆ˜ ì •ì˜ë“¤ (v3.26 ë‚´ìš© ìœ ì§€ ë˜ëŠ” ì´ì „ ì™„ì „í•œ ë²„ì „ì—ì„œ ê°€ì ¸ì˜´)
    function getRecordingPolicyByAge(age) { /* (v3.19ì™€ ë™ì¼) */ }
    function appendMessage(text, role = 'ai', isError = false) { /* (v3.19ì™€ ë™ì¼) */ }
    function disableTalkButton(disable = true, reason = "") { /* (v3.25ì™€ ë™ì¼) */ }
    async function loadRecentTopics() { /* (v3.19ì™€ ë™ì¼) */ }
    function showTopicBox(topics) { /* (v3.19ì™€ ë™ì¼) */ }
    function startSilenceTimer() { /* (v3.19ì™€ ë™ì¼) */ }
    function resetSilenceTimer() { /* (v3.25ì™€ ë™ì¼) */ }
    function checkAndRedirectToAnalysis() { /* (v3.19ì™€ ë™ì¼) */ }
    async function handleUserInteraction(userText, context = {}) { /* (v3.25ì™€ ë™ì¼) */ }
    async function startRecording() { /* (v3.19ì™€ ë™ì¼) */ }
    function stopRecording(isManualStop = false) { /* (v3.19ì™€ ë™ì¼) */ }
    
    function setupEventListeners() {
        console.log("[setupEventListeners] í•¨ìˆ˜ ì‹œì‘ë¨.");
        if (!talkBtn) {
            console.error("[setupEventListeners] talkBtnì´ nullì…ë‹ˆë‹¤. ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë¶ˆê°€.");
            return;
        }

        talkBtn.addEventListener('click', async () => {
          console.log(`[talkBtn Click] isRecording: ${isRecording}, firstInteractionDone: ${firstInteractionDone}, onboardingComplete: ${onboardingComplete}, currentSegmentInAutoChain: ${currentSegmentInAutoChain}`);
          if (analysisRedirectInProgress) {
              console.log("[talkBtn Click] ë¶„ì„ í˜ì´ì§€ ì´ë™ ì¤‘, ë™ì‘ ì¤‘ë‹¨.");
              return;
          }
          if (waitingOverlay) waitingOverlay.style.display = 'none';

          // ì´ˆê¸° ì¸ì‚¬ë§ TTS ì¬ìƒ ë¡œì§ (ì²« ë²ˆì§¸ ìœ íš¨ í´ë¦­ ì‹œ)
          if (!firstInteractionDone && !onboardingComplete && initialGreetingText) {
              console.log("[talkBtn Click] ì²« ë²ˆì§¸ ìœ íš¨ í´ë¦­, ì´ˆê¸° ì¸ì‚¬ë§ TTS ì¬ìƒ.");
              firstInteractionDone = true;
              disableTalkButton(true, "ì´ˆê¸° ì¸ì‚¬ë§ TTS ì¤‘");
              if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'block';
              try {
                  await playTTSFromText(initialGreetingText, currentVoiceId);
              } catch (error) {
                  const errorMsg = error.name === 'NotAllowedError' ? "(ëª©ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë ¤ë©´ í™”ë©´ì„ ë‹¤ì‹œ í•œë²ˆ í´ë¦­í•˜ê±°ë‚˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.)" : "(ì´ˆê¸° ì•ˆë‚´ ìŒì„± ì¬ìƒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)";
                  const errorBubble = appendMessage(errorMsg, "ai", true);
                  if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble);
                  console.error("ì´ˆê¸° ì¸ì‚¬ TTS ì‹¤íŒ¨:", error);
              } finally {
                  if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none';
                  disableTalkButton(false, "ì´ˆê¸° ì¸ì‚¬ë§ TTS ì™„ë£Œ/ì‹¤íŒ¨");
                  resetSilenceTimer();
              }
              return;
          }

          // ì¼ë°˜ ë…¹ìŒ ì‹œì‘/ì¤‘ì§€ ë¡œì§
          if (!isRecording) {
              console.log("[talkBtn Click] ë…¹ìŒ ì‹œì‘ ìš”ì²­.");
              autoSegmentStartTime = null; // ìƒˆ ìˆ˜ë™ ë…¹ìŒ ì‹œì‘ ì‹œ ìë™ ì„¸ì…˜ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
              currentSegmentInAutoChain = 0;
              startRecording(); // ì—¬ê¸°ì„œ ì—°ë ¹ë³„ ì •ì±… ì ìš© ë° ìƒˆ autoSegmentStartTime ì„¤ì •ë¨
          } else {
              console.log("[talkBtn Click] ë…¹ìŒ ì¤‘ì§€ ìš”ì²­ (ìˆ˜ë™).");
              stopRecording(true); // ìˆ˜ë™ ì¤‘ì§€ì„ì„ ëª…ì‹œ
          }
        });
        console.log("[setupEventListeners] talkBtn í´ë¦­ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ.");

        if (waitingOverlay) {
            waitingOverlay.addEventListener('click', () => {
                if (analysisRedirectInProgress) return;
                waitingOverlay.style.display = 'none';
                resetSilenceTimer();
                console.log("[waitingOverlay Click] ì˜¤ë²„ë ˆì´ ë‹«í˜, ì¹¨ë¬µ íƒ€ì´ë¨¸ ë¦¬ì…‹.");
            });
            console.log("[setupEventListeners] waitingOverlay í´ë¦­ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ.");
        } else {
            console.warn("[setupEventListeners] waitingOverlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        console.log("[setupEventListeners] í•¨ìˆ˜ ì¢…ë£Œë¨.");
    }

    async function initializeChat() { 
      console.log("--- [initializeChat] í•¨ìˆ˜ ì‹¤í–‰ ì‹œë„ ---");
      try {
        console.log("[initializeChat] ë‚´ë¶€ try ë¸”ë¡ ì§„ì….");

        if (!talkBtn || !chatWindow) {
            console.error("[initializeChat] ì¹˜ëª…ì  ì˜¤ë¥˜: talkBtn ë˜ëŠ” chatWindowê°€ ì—¬ì „íˆ nullì…ë‹ˆë‹¤. DOM ë¡œë“œ ë¬¸ì œ ê°€ëŠ¥ì„±.");
            alert("í˜ì´ì§€ ì´ˆê¸°í™”ì— ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì½”ë“œ: INIT_DOM_FAIL)");
            disableTalkButton(true, "ì´ˆê¸°í™” ì‹¤íŒ¨ (UI ìš”ì†Œ ëˆ„ë½)");
            return;
        }
        console.log("[initializeChat] DOM ìš”ì†Œ (talkBtn, chatWindow) ìœ íš¨ì„± í™•ì¸ ì™„ë£Œ.");

        talkBtn.innerHTML = 'ğŸ¤';
        talkBtn.classList.remove('active', 'recording-in-progress');
        disableTalkButton(true, "ì´ˆê¸°í™” ì¤‘");
        
        console.log("[initializeChat] localStorage ê°’ ë¡œê¹… ì‹œì‘:");
        console.log(`  currentUserName: "${currentUserName}"`);
        console.log(`  currentUserId: "${currentUserId}"`);
        console.log(`  currentVoiceId: "${currentVoiceId}"`);
        console.log(`  currentUserAge: "${currentUserAge}"`);
        console.log(`  currentUserDisease: "${currentUserDisease}"`);
        console.log(`  onboardingComplete: ${onboardingComplete}, userTypedIntro: "${userTypedIntro ? userTypedIntro.substring(0,20)+'...' : 'ì—†ìŒ'}"`);

        if (!currentUserId || !currentVoiceId) { 
            const errorMsg = `í•„ìˆ˜ ì‚¬ìš©ì ì •ë³´(ID ë˜ëŠ” ëª©ì†Œë¦¬)ê°€ ì—†ì–´ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. [ID: ${currentUserId}, Voice: ${currentVoiceId}]`;
            console.error("[initializeChat] ì˜¤ë¥˜ - í•„ìˆ˜ ì •ë³´ ëˆ„ë½:", errorMsg); 
            const errorBubble = appendMessage(errorMsg, 'ai', true);
            if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble);
            if(loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none'; 
            disableTalkButton(true, "ì‚¬ìš©ì ì •ë³´ ì—†ìŒ (í•„ìˆ˜ ê°’ ëˆ„ë½)");
            console.log("--- [initializeChat] ì¤‘ë‹¨ (í•„ìˆ˜ ì •ë³´ ëˆ„ë½) ---");
            return;
        }
        console.log("[initializeChat] í•„ìˆ˜ ì‚¬ìš©ì ì •ë³´ (ID, Voice) í™•ì¸ ì™„ë£Œ.");

        console.log("[initializeChat] ëŒ€í™” ì‹œì‘ ë¡œì§ ì§„ì….");
        if (onboardingComplete && userTypedIntro) { 
            console.log("[initializeChat] ì¼€ì´ìŠ¤ 1: ì˜¨ë³´ë”© ì™„ë£Œ, ì‚¬ìš©ì ì²«ë§ˆë”” ì…ë ¥ë¨. userTypedIntro:", userTypedIntro);
            appendMessage(userTypedIntro, 'user'); 
            if (!conversationStartTime) conversationStartTime = Date.now();
            
            console.log("[initializeChat] handleUserInteraction í˜¸ì¶œ ì§ì „. userTypedIntro:", userTypedIntro);
            await handleUserInteraction(userTypedIntro, { initialUserMessage: userTypedIntro, initialUserEmotions: selectedEmotions, isFirstChatAfterOnboarding: true });
            console.log("[initializeChat] handleUserInteraction í˜¸ì¶œ ì™„ë£Œ (Promise ì´í–‰ë¨).");
            
            localStorage.removeItem('lozee_onboarding_complete'); 
            localStorage.removeItem('lozee_user_typed_intro'); 
            firstInteractionDone = true; 
            console.log("[initializeChat] ì¼€ì´ìŠ¤ 1 ì²˜ë¦¬ ì™„ë£Œ.");
        } else if (onboardingComplete && !userTypedIntro) { 
            console.log("[initializeChat] ì¼€ì´ìŠ¤ 2: ì˜¨ë³´ë”© ì™„ë£Œ, ì‚¬ìš©ì ì²« ìŒì„± ì…ë ¥ ëŒ€ê¸°.");
            initialGreetingText = `ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”, ${currentUserName}ë‹˜! ì´ì œ ëŒ€í™”ë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆì–´ìš”. ì•„ë˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§€ê¸ˆ ì–´ë–¤ì§€ ë§ì”€í•´ì£¼ì„¸ìš”.`;
            const aiGreetingBubble = appendMessage(initialGreetingText, 'ai');
            if(aiGreetingBubble && chatWindow) chatWindow.appendChild(aiGreetingBubble);
            if(loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'block';
            try { await playTTSFromText(initialGreetingText, currentVoiceId); } catch(e) { console.error("ì˜¨ë³´ë”© í›„ ì²« ì¸ì‚¬ TTS ì˜¤ë¥˜:", e); } 
            finally { if(loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none'; }
            disableTalkButton(false, "ì˜¨ë³´ë”© í›„ ì²« ìŒì„± ì…ë ¥ ëŒ€ê¸°");
            firstInteractionDone = true; 
        } else { 
            const urlParams = new URLSearchParams(window.location.search);
            const topicFromUrl = urlParams.get('topic');
            if (topicFromUrl) { 
              console.log(`[initializeChat] ì¼€ì´ìŠ¤ 3: URLì—ì„œ í† í”½ ê°€ì ¸ì˜´ ("${topicFromUrl}").`);
              appendMessage(`"${topicFromUrl}"ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê³  ì‹¶ì–´ìš”.`, 'user');
              if (!conversationStartTime) conversationStartTime = Date.now();
              await handleUserInteraction(`"${topicFromUrl}" ê´€ë ¨í•´ì„œ ì´ì•¼ê¸° ì‹œì‘í•´ì¤˜.`);
              firstInteractionDone = true; 
            } else { 
              console.log("[initializeChat] ì¼€ì´ìŠ¤ 4: ì¼ë°˜ ì‹œì‘. getInitialGreeting í˜¸ì¶œ ì‹œë„.");
              initialGreetingText = await getInitialGreeting(currentUserName, hasVisited, lastSummary, currentUserAge, currentUserDisease);
              if (!initialGreetingText || initialGreetingText.trim() === "") {
                  initialGreetingText = `${currentUserName}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?`;
              }
              const aiGreetingBubble = appendMessage(initialGreetingText, 'ai');
              if(aiGreetingBubble && chatWindow) chatWindow.appendChild(aiGreetingBubble);
              disableTalkButton(false, "ì´ˆê¸°í™” ì™„ë£Œ, ì²« í´ë¦­ ëŒ€ê¸°"); 
            }
        }
        if (!hasVisited) { 
            localStorage.setItem('lozee_hasVisited', 'true'); 
            hasVisited = true; 
            console.log("[initializeChat] ì²« ë°©ë¬¸ìœ¼ë¡œ ê¸°ë¡ë¨.");
        }
        console.log("[initializeChat] try ë¸”ë¡ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ.");

      } catch (error) { 
          console.error("[initializeChat] initializeChat í•¨ìˆ˜ ë‚´ì—ì„œ ì˜ˆì™¸ ë°œìƒ:", error);
          const errorBubble = appendMessage("ì±„íŒ… ì´ˆê¸°í™” ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.", 'ai', true);
          if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble);
          disableTalkButton(true, "ì´ˆê¸°í™” ì‹¬ê°í•œ ì˜¤ë¥˜");
      } finally {
        console.log("--- [initializeChat] finally ë¸”ë¡ ì‹¤í–‰ë¨. ì±„íŒ… ì´ˆê¸°í™” ì‹œë„ ì™„ë£Œ ---");
        if (!(onboardingComplete && userTypedIntro) && !analysisRedirectInProgress) { 
             resetSilenceTimer();
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ. ì´ˆê¸°í™” ë¡œì§ ì‹¤í–‰ ì¤€ë¹„.");
        try {
            talkBtn = document.getElementById('talk-btn');
            chatWindow = document.getElementById('chat-window');
            topicSelectionBox = document.getElementById('topic-selection');
            topicOptionsContainer = document.getElementById('topic-options');
            loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
            waitingOverlay = document.getElementById('waiting-overlay');
            waitingUserNameSpan = document.getElementById('waitingUserName');
            
            console.log("[DOMContentLoaded] DOM ìš”ì†Œ ì°¸ì¡° ì‹œë„ ì™„ë£Œ.");
            if (!talkBtn) console.error("[DOMContentLoaded] talkBtn ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!");
            if (!chatWindow) console.error("[DOMContentLoaded] chatWindow ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!");

            initializeChat();    
            setupEventListeners(); 
            console.log("[DOMContentLoaded] ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ.");

        } catch (e) {
            console.error("DOMContentLoaded ì²˜ë¦¬ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ:", e);
            alert("í˜ì´ì§€ ë¡œë”© ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì½”ë“œ: DOM_LOAD_ERR)");
        }
    });
  </script>
</body>
</html>
