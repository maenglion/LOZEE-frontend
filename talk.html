<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
<style>
  :root {
      --primary-color: #6e8efb; /* index.html ë²„íŠ¼ ë° old talk.html ì£¼ìš”ìƒ‰ ì°¸ê³  */
      --secondary-color: #5a7edf; /* primary-colorì˜ ìœ ì‚¬ìƒ‰ ë˜ëŠ” ë³´ì¡°ìƒ‰ */
      --background-color: #ffffff; /* ìš”ì²­ëœ í°ìƒ‰ ë°°ê²½ */
      --text-color: #333333; /* í°ìƒ‰ ë°°ê²½ ìœ„ì˜ ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
      
      --gnb-bg: #354157; /* old talk.html ì°¸ê³ í•œ GNB ë°°ê²½ìƒ‰ (ì–´ë‘ìš´ ê³„ì—´) */
      --gnb-text-color: #ffffff;
      --gnb-title-color: var(--primary-color); /* GNB íƒ€ì´í‹€ì— ì£¼ì¡°ìƒ‰ ì ìš© */
      --gnb-menu-toggle-color: var(--primary-color);
      --gnb-dropdown-bg: var(--gnb-bg);
      --gnb-dropdown-text-color: var(--gnb-text-color);
      --gnb-dropdown-border-color: #4a5568; /* old talk.html ì°¸ê³  */
      --gnb-dropdown-hover-bg: var(--secondary-color);

      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --ai-bubble-bg: #f0f0f0; /* ë°ì€ íšŒìƒ‰ ë°°ê²½ì˜ AI ë§í’ì„  */
      --ai-bubble-text: #333333;

      --input-area-bg: #f8f9fa; /* ì…ë ¥ ì˜ì—­ ë°°ê²½ (ë§¤ìš° ë°ì€ íšŒìƒ‰) */
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef; /* ìŒëŸ‰ ë°” ë°°ê²½ */
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px; /* talk.html ê¸°ì¡´ ê°’ ìœ ì§€ */
      --meter-top-margin: 8px; /* old talk.html ì°¸ê³  */

      --topic-button-bg: var(--primary-color);
      --topic-button-text: #ffffff;
      --topic-button-hover-bg: var(--secondary-color);

      --analysis-notification-bg: #fff3cd; /* talk.html ê¸°ì¡´ ê°’ ì°¸ê³  */
      --analysis-notification-text: #856404; /* talk.html ê¸°ì¡´ ê°’ ì°¸ê³  */

      --gnb-height: 56px; /* talk.html ë° old talk.html ê³µí†µ */
      --chat-input-area-height: 70px; /* old talk.html ì°¸ê³  (íŒ¨ë”© í¬í•¨ ë†’ì´) */
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height); /* GNB ë†’ì´ë§Œí¼ íŒ¨ë”© */
      font-family: 'KoPub World Dotum', sans-serif; /* old talk.html ë° index.html í°íŠ¸ ì ìš© */
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* GNB (old talk.html ìŠ¤íƒ€ì¼ ê¸°ë°˜) */
    #gnb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--gnb-bg);
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gnb-title-color);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gnb-menu-toggle-color);
      font-size: 24px; /* old talk.html ì•„ì´ì½˜ í¬ê¸° ëŠë‚Œ */
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--gnb-dropdown-bg);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.2);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 300px; /* talk.html ê¸°ì¡´ ê°’ ë˜ëŠ” í•„ìš”ì‹œ ì¡°ì • */
    }

    #dropdown-menu a {
      display: block;
      padding: 12px 16px;
      text-decoration: none;
      color: var(--gnb-dropdown-text-color);
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
      font-size: 0.95em;
    }
    #dropdown-menu a:last-child {
      border-bottom: none;
    }
    #dropdown-menu a:hover {
      background-color: var(--gnb-dropdown-hover-bg);
    }

    /* Volume Meter (old talk.html ìŠ¤íƒ€ì¼ ë° talk.html êµ¬ì¡° ê¸°ë°˜) */
    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px; /* talk.htmlì— ì´ë¯¸ ìˆì—ˆì§€ë§Œ, ì¼ê´€ì„± ìœ„í•´ ëª…ì‹œ */
      transition: width 0.05s linear, background-color 0.05s linear; /* talk.htmlì— background-color transition ì¶”ê°€ */
    }
    
    /* Chat Window (old talk.html ìŠ¤íƒ€ì¼ ì°¸ê³ , talk.html ID ì‚¬ìš©) */
    #chat-window {
      flex: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px); /* GNB ë°‘, ìŒëŸ‰ ë°” ë°‘ */
      padding-bottom: calc(var(--chat-input-area-height) + 10px); /* í•˜ë‹¨ ì…ë ¥ì°½ ë†’ì´ë§Œí¼ ì—¬ë°± */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px; /* ë§í’ì„  ê°„ê²© */
      box-sizing: border-box;
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ (old talk.html ì°¸ê³ ) */
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); } /* í˜ì´ì§€ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ */
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    /* Bubbles (talk.html í´ë˜ìŠ¤ëª… ì‚¬ìš©, old talk.html ìŠ¤íƒ€ì¼ ì ìš©) */
    .bubble {
      max-width: 75%;
      padding: 10px 15px; /* ì•½ê°„ ì¤„ì„ */
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all; /* í•œêµ­ì–´ ê³ ë ¤ */
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.ai { /* talk.htmlì˜ .ai í´ë˜ìŠ¤ */
      background: var(--ai-bubble-bg);
      color: var(--ai-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    /* Analysis Notification (talk.html ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€í•˜ë˜ ìƒ‰ìƒ ë³€ìˆ˜ ì‚¬ìš©) */
    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    /* Topic Area (talk.html êµ¬ì¡° ê¸°ë°˜, old talk.html ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì°¸ê³ ) */
    #topic-area {
      display: none; /* ì´ˆê¸° ìˆ¨ê¹€ */
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 16px; /* ë‚´ë¶€ ì—¬ë°± */
      background: var(--background-color); /* í˜ì´ì§€ ë°°ê²½ê³¼ ë™ì¼í•˜ê²Œ ë˜ëŠ” ë°ì€ íšŒìƒ‰ */
      border-top: 1px solid #e0e0e0;
      /* í•˜ë‹¨ ê³ ì • ì…ë ¥ì°½ ìœ„ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì • í•„ìš”ì‹œ */
      position: fixed;
      bottom: var(--chat-input-area-height);
      left: 0;
      width: 100%;
      box-sizing: border-box;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
    }
    .topic-btn, .subtopic-btn {
      background: var(--topic-button-bg);
      border: none;
      color: var(--topic-button-text);
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s;
    }
    .topic-btn:hover, .subtopic-btn:hover {
      background: var(--topic-button-hover-bg);
    }

    /* Input Area (old talk.html ìŠ¤íƒ€ì¼ ê¸°ë°˜, talk.html ID ì‚¬ìš©, í•˜ë‹¨ ê³ ì •) */
    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; /* ì´ˆê¸° ìˆ¨ê¹€, startChat()ì—ì„œ flexë¡œ ë³€ê²½ */
      align-items: center;
      gap: 8px;
      padding: 0 12px; /* ë‚´ë¶€ ì—¬ë°± old talk.html ì°¸ê³  */
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0; /* old talk.html ê·¸ë¦¼ì ëŒ€ì‹  ê²½ê³„ì„  */
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px; /* old talk.html ë²„íŠ¼/ì…ë ¥ì°½ ë†’ì´ í†µì¼ */
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 10px 16px; /* ë‚´ë¶€ ì—¬ë°± */
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px; /* old talk.html ì°¸ê³  */
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn { /* talk.html ID ì‚¬ìš© */
      width: 44px;
      min-width: 44px; /* ë„ˆë¹„ ê³ ì • */
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em; /* ì•„ì´ì½˜ í¬ê¸° ëŠë‚Œ */
      transition: background-color 0.2s ease;
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording { /* talk.html ê¸°ì¡´ í´ë˜ìŠ¤ ìœ ì§€ */
      background: #e74c3c; /* ë…¹ìŒ ì¤‘ ë¹¨ê°„ìƒ‰ */
    }
    #send-btn.loading { /* old talk.html ì°¸ê³  (í•„ìš”ì‹œ JSì—ì„œ í´ë˜ìŠ¤ ì¶”ê°€) */
        background:#cccccc;
        cursor:default;
    }
    
    /* ë°˜ì‘í˜• (í•„ìš”ì‹œ ì¶”ê°€) */
    @media (max-width: 600px) {
      #gnb-title { font-size: 1.1em; }
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
      #topic-area { bottom: 65px; }
    }

  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">â˜°</button>
    <div id="dropdown-menu">
      <a href="mypage.html">My Page</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ëŒ€í™” ëª©ë¡</a>
    </div>
  </nav>
  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-window"></div>
  <div id="topic-area"></div>
  <div id="input-area">
    <button id="mic-button">ğŸ¤</button>
    <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
    <button id="send-btn">â¤</button>
  </div>
  <script type="module">
    import './js/firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { saveSessionLog } from './js/firebase-utils.js';
    import { counselingTopicsByAge } from './js/counseling_topics.js';

    // ìƒíƒœ
    let skipTTS=false, hasGreeted=false, isProcessing=false;
    let chatHistory=[], selectedMain=null;
    let meta={ lastInputTimestamp:Date.now(), fillerCount:0, clickedOption:false, presentedIndices:[] };
    const userName=localStorage.getItem('lozee_username')||'ì¹œêµ¬';
    const userAge=parseInt(localStorage.getItem('lozee_userage')||0,10);
    const voc=getKoreanVocativeParticle(userName);

    // UI
    const chatWindow=document.getElementById('chat-window');
    const topicArea=document.getElementById('topic-area');
    const inputArea=document.getElementById('input-area');
    const chatInput=document.getElementById('chat-input');
    const sendBtn=document.getElementById('send-btn');
    const micButton=document.getElementById('mic-button');
    const menuToggle=document.getElementById('menu-toggle');
    const dropdownMenu=document.getElementById('dropdown-menu');
    const meterLevel=document.getElementById('volume-level');

    // GNB
    menuToggle.addEventListener('click',()=>dropdownMenu.classList.toggle('show'));
    document.addEventListener('click',e=>{ if(!document.getElementById('gnb').contains(e.target)) dropdownMenu.classList.remove('show'); });

       // ì‚¬ìš©ì ì •ë³´
    const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
    const voc = getKoreanVocativeParticle(userName);

    // ì´ˆê¸°í™” ë¡œì§
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âœ… firebase-config.js ëª¨ë“ˆ ë¡œë“œë¨');
      console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');

      // ì²« ì¸ì‚¬ ë° í† í”½ í‘œì‹œ
      const greeting = getInitialGreeting(userName + voc, hasGreeted);
      appendMessage(greeting, 'ai');
      await playTTSFromText(greeting, localStorage.getItem('lozee_voice'));
      hasGreeted = true;
      showMainTopics();
    });

    // ë©”ì‹œì§€
    function appendMessage(text,role){ const b=document.createElement('div'); b.className='bubble '+role; b.textContent=text; chatWindow.appendChild(b); chatWindow.scrollTop=chatWindow.scrollHeight; }
    function showAnalysis(){ const n=document.createElement('div'); n.className='analysis-notification'; n.textContent='ğŸŸ¡ë¶„ì„ ì™„ë£Œ'; n.onclick=()=>location.href='analysis.html'; chatWindow.appendChild(n); chatWindow.scrollTop=chatWindow.scrollHeight; }
    function playTTSWithControl(txt) {stopCurrentTTS();               // ensure stopCurrentTTS is imported
    if (skipTTS) { skipTTS = false; return; } return playTTSFromText(txt, localStorage.getItem('lozee_voice'));
    }

    // ì˜¤ë””ì˜¤ ë¶„ì„
    let audioContext,analyser,source,dataArray,animId,streamRef;
    const LOW={r:0,g:200,b:0},MID={r:255,g:200,b:0},HIGH={r:255,g:69,b:0};
    function interp(c1,c2,f){return`rgb(${Math.round(c1.r+f*(c2.r-c1.r))},${Math.round(c1.g+f*(c2.g-c1.g))},${Math.round(c1.b+f*(c2.b-c1.b))})`;}
    function setupAudioAnalysis(s){ if(audioContext)audioContext.close();audioContext=new AudioContext();analyser=audioContext.createAnalyser();analyser.fftSize=256;source=audioContext.createMediaStreamSource(s);source.connect(analyser);dataArray=new Uint8Array(analyser.frequencyBinCount);streamRef=s;draw();}
    function draw(){animId=requestAnimationFrame(draw);if(!analyser||!dataArray)return;analyser.getByteFrequencyData(dataArray);let sum=dataArray.reduce((a,v)=>a+v,0);let avg=sum/dataArray.length;let norm=Math.min(100,Math.max(0,(avg/140)*100));meterLevel.style.width=norm+'%';let col=norm<=50?interp(LOW,MID,norm/50):interp(MID,HIGH,(norm-50)/50);meterLevel.style.background=`linear-gradient(to right, var(--background-color), ${col})`;}
    function stopAudio(){ cancelAnimationFrame(animId); if(source)source.disconnect();streamRef.getTracks().forEach(t=>t.stop()); if(audioContext)audioContext.close();meterLevel.style.width='0%';meterLevel.style.background=getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg');}

    // STT
    const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
    let recog,isRec=false;
    if(Rec){ recog=new Rec();recog.continuous=true;recog.interimResults=false;recog.lang='ko-KR';
      recog.onstart=()=>{isRec=true;micButton.classList.add('recording');};
      recog.onend=()=>{isRec=false;micButton.classList.remove('recording');stopAudio();};
      recog.onresult = e => {let txt = ''; for (let i = e.resultIndex; i < e.results.length; i++) { if (e.results[i].isFinal) txt += e.results[i][0].transcript;}
      if (txt) sendMessage(txt);       // <-- handleUserText â†’ sendMessage
      };
      recog.onerror=err=>{console.error(err);appendMessage('ìŒì„± ì¸ì‹ ì˜¤ë¥˜','ai_feedback');isRec=false;micButton.classList.remove('recording');stopAudio();};
      micButton.onclick=async()=>{ if(isRec){recog.stop();}else{try{const s=await navigator.mediaDevices.getUserMedia({audio:true});setupAudioAnalysis(s);recog.start();}catch(e){console.error(e);appendMessage('ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜','ai_feedback');}}};
    } else { micButton.disabled=true;appendMessage('ë¸Œë¼ìš°ì €ì—ì„œ ìŒì„± ì¸ì‹ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.','ai_feedback'); }

    // í† í”½ í”Œë¡œìš°
    function showMainTopics(){appendMessage('ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³¼ê¹Œ?','ai');topicArea.innerHTML='';const t=Object.keys(counselingTopicsByAge[getAgeGroup()]);t.push('ììœ ì£¼ì œ');t.forEach(topic=>{const b=document.createElement('button');b.className='topic-btn';b.textContent=topic;b.onclick=()=>selectMainTopic(topic);topicArea.appendChild(b);});topicArea.style.display='flex';}
    function selectMainTopic(topic){selectedMain=topic;topicArea.style.display='none';appendMessage(topic+' ì´ì•¼ê¸°ë¥¼ ì„ íƒí–ˆì–´!','ai');setTimeout(showSubTopics,300);}    
    function showSubTopics(){appendMessage('ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ?','ai');topicArea.innerHTML='';let subs=selectedMain==='ììœ ì£¼ì œ'?['ììœ ë¡­ê²Œ ì´ì•¼ê¸°í•´ë´']:(counselingTopicsByAge[getAgeGroup()][selectedMain]||[]).map(i=>i.displayText);subs.forEach(sub=>{const b=document.createElement('button');b.className='subtopic-btn';b.textContent=sub;b.onclick=()=>startChat(sub);topicArea.appendChild(b);});topicArea.style.display='flex';}
    function startChat(init){topicArea.style.display='none';inputArea.style.display='flex';sendMessage(init);}   
    function getAgeGroup(){if(userAge<=10)return'8-10';if(userAge<=15)return'11-15';return'30+';}

    // stuck detection
    function detectStuck(txt,his,meta){const now=Date.now();if(meta.lastInputTimestamp&&now-meta.lastInputTimestamp>300000)return true; if(meta.fillerCount>=3)return true;const recent=his.filter(m=>m.role==='user').slice(-5);if(recent.length===5&&recent.every(m=>m.content.trim().length<5))return true; if(meta.clickedOption)return false;return false;}
    function showPreferenceOptions(){const avail=window.LOZEE_DIALOG.preferenceTopics.map((_,i)=>i).filter(i=>!meta.presentedIndices.includes(i));if(!avail.length)return;const idx=avail[Math.floor(Math.random()*avail.length)];meta.presentedIndices.push(idx);const n=document.createElement('div');n.className='analysis-notification';const b=document.createElement('button');b.className='topic-btn';b.textContent=window.LOZEE_DIALOG.preferenceTopics[idx](userName);b.onclick=()=>{meta.clickedOption=true;startChat(b.textContent);};n.appendChild(b);chatWindow.appendChild(n);chatWindow.scrollTop=chatWindow.scrollHeight;}

    async function sendMessage(text){if(!text||isProcessing)return;isProcessing=true;appendMessage(text,'user');chatHistory.push({role:'user',content:text});chatInput.value='';const res=await getGptResponse(text,{chatHistory});const d=await res.json();const cut=d.text.indexOf('{');const clean=cut>=0?d.text.slice(0,cut).trim():d.text;appendMessage(clean,'ai');await playTTSWithControl(clean);chatHistory.push({role:'ai',content:clean});await saveSessionLog(text,clean,d.analysis||{});if(d.analysis){LOZEE_ANALYSIS?.inferAgeAndLanguage&&await LOZEE_ANALYSIS. inferAgeAndLanguage(chatHistory.map(m=>m.role+':'+m.content).join('\n'));}if(d.analysis)showAnalysis();if(d.analysis){}if(d.analysis){}if(d.analysis){}if(d.analysis){}if(d.analysis){};if(d.analysis){};if(d.analysis){};if(d.analysis){};if(d.analysis){};if(d.analysis){};if(d.analysis){};if(d.analysis);if(d.analysis){};if(d.analysis){};if(d.analysis);if(d.analysis);if(d.analysis){};if(d.analysis){};if(d.analysis);if(d.analysis);}   
    // event binding
    sendBtn.addEventListener('click',()=>sendMessage(chatInput.value));
    chatInput.addEventListener('keydown',e=>{meta.lastInputTimestamp=Date.now();const fillers=['ìŒ','â€¦','ì–´','ê¸€ì„','ëª¨ë¥´ê² ì–´ìš”','ì˜ ëª¨ë¥´ê² ì–´'];meta.fillerCount=fillers.some(f=>chatInput.value.includes(f))?meta.fillerCount+1:0;meta.clickedOption=false;skipTTS=true;stopCurrentTTS();if(e.key==='Enter')sendMessage(chatInput.value);});

    // init
    document.addEventListener('DOMContentLoaded',async()=>{const greet=getInitialGreeting(userName+voc,hasGreeted);appendMessage(greet,'ai');await playTTSWithControl(greet);hasGreeted=true;showMainTopics();});
  </script>
</body>
</html>
