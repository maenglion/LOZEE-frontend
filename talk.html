<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEÏôÄ ÎåÄÌôîÌïòÍ∏∞</title>
  <style>
    :root {
      --primary-color: #ffd400;
      --background-color: #2a3340;
      --user-bubble-bg: #3a3f51;
      --ai-bubble-bg: #4f5666;
      --gnb-height: 56px;
      --meter-height: 6px;
    }
    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: Arial, sans-serif;
      background: var(--background-color);
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    /* GNB */
    #gnb {
      position: fixed; top: 0; left: 0;
      width: 100%; height: var(--gnb-height);
      background: #1b1f2a;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #gnb-title { font-size: 1.2em; font-weight: bold; }
    #menu-toggle { background: none; border: none; color: var(--primary-color); font-size: 1.5em; cursor: pointer; }
    #dropdown-menu {
      position: fixed; top: var(--gnb-height); right: 0;
      background: #2a3340;
      max-height: 0; overflow: hidden;
      transition: max-height 0.3s ease-out;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      border-radius: 0 0 0 8px;
      z-index: 999;
    }
    #dropdown-menu.show { max-height: 200px; }
    #dropdown-menu a {
      display: block;
      padding: 12px 16px;
      color: #fff;
      text-decoration: none;
      border-bottom: 1px solid #444;
    }
    #dropdown-menu a:last-child { border-bottom: none; }
    #dropdown-menu a:hover { background: #3a3f51; }
    /* Volume Meter */
    #meter-container {
      position: fixed; top: calc(var(--gnb-height)+8px);
      left: 50%; transform: translateX(-50%);
      width: 60%; max-width: 300px; height: var(--meter-height);
      background: #444;
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%; height: 100%;
      background: var(--primary-color);
      transition: width 0.05s linear;
    }
    /* Chat Window */
    #chat-window {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .bubble {
      max-width: 75%; padding: 12px 16px;
      border-radius: 18px; line-height: 1.5; white-space: pre-wrap;
    }
    .bubble.user {
      align-self: flex-end;
      background: var(--user-bubble-bg);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .bubble.ai {
      align-self: flex-start;
      background: var(--ai-bubble-bg);
      color: #fff;
      border-bottom-left-radius: 4px;
    }
    .analysis-notification {
      align-self: center;
      background: #fff3cd;
      color: #856404;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
    }
    /* Topic Area */
    #topic-area {
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      background: #1b1f2a;
      border-top: 1px solid #444;
    }
    .topic-btn, .subtopic-btn {
      background: var(--primary-color);
      border: none;
      color: #000;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
    }
    /* Input Area */
    #input-area {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #1b1f2a;
      border-top: 1px solid #444;
    }
    #chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #555;
      border-radius: 20px;
      background: #2a3340;
      color: #fff;
      outline: none;
    }
    #mic-button, #send-btn {
      width: 36px; height: 36px;
      border: none; border-radius: 50%;
      background: var(--primary-color);
      color: #000;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    #mic-button.recording { background: #e74c3c; }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">‚ò∞</button>
    <div id="dropdown-menu">
      <a href="mypage.html">My Page</a>
      <a href="index.html">Ï£ºÏ†ú Î≥ÄÍ≤Ω</a>
      <a href="analysis.html">ÎåÄÌôî Î∂ÑÏÑù</a>
      <a href="journal-list.html">ÎåÄÌôî Î™©Î°ù</a>
    </div>
  </nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-window"></div>
  <div id="topic-area"></div>
  <div id="input-area">
    <button id="mic-button">üé§</button>
    <input id="chat-input" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off" />
    <button id="send-btn">‚û§</button>
  </div>

  <script type="module">
    import './js/firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { saveSessionLog } from './js/firebase-utils.js';
    import { counselingTopicsByAge } from './js/counseling_topics.js';

    // ÏÉÅÌÉú
    let skipTTS = false;
    let hasGreeted = false;
    let isProcessing = false;
    let chatHistory = [];
    let selectedMain = null;
    let meta = { lastInputTimestamp: Date.now(), fillerCount: 0, clickedOption: false, presentedIndices: [] };

    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥
    const userName = localStorage.getItem('lozee_username') || 'ÏπúÍµ¨';
    const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
    const voc = getKoreanVocativeParticle(userName);

    // DOM ÏöîÏÜå
    const chatWindow = document.getElementById('chat-window');
    const topicArea  = document.getElementById('topic-area');
    const inputArea  = document.getElementById('input-area');
    const chatInput  = document.getElementById('chat-input');
    const sendBtn    = document.getElementById('send-btn');
    const micButton  = document.getElementById('mic-button');
    const menuToggle = document.getElementById('menu-toggle');
    const dropdown   = document.getElementById('dropdown-menu');
    const meterLevel = document.getElementById('volume-level');

    // GNB ÌÜ†Í∏Ä
    menuToggle.addEventListener('click', () => dropdown.classList.toggle('show'));
    document.addEventListener('click', e => {
      if (!document.getElementById('gnb').contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Î©îÏãúÏßÄ Ï∂úÎ†•
    function appendMessage(text, role) {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${role}`;
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Î∂ÑÏÑù ÏïåÎ¶º
    function showAnalysisNotification() {
      const notif = document.createElement('div');
      notif.className = 'analysis-notification';
      notif.textContent = 'üü° Î∂ÑÏÑù ÏôÑÎ£å';
      notif.onclick = () => location.href = 'analysis.html';
      chatWindow.appendChild(notif);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // TTS Ï†úÏñ¥
    function playTTSWithControl(text) {
      stopCurrentTTS();
      if (skipTTS) { skipTTS = false; return; }
      return playTTSFromText(text, localStorage.getItem('lozee_voice'));
    }

    // ÌÜ†ÌîΩ ÌîåÎ°úÏö∞
    function showMainTopics() {
      appendMessage('Ïñ¥Îñ§ Ïù¥ÏïºÍ∏∞Î•º ÎÇòÎà†Î≥ºÍπå?', 'ai');
      topicArea.innerHTML = '';
      const keys = Object.keys(counselingTopicsByAge[getAgeGroup(userAge)]);
      keys.push('ÏûêÏú†Ï£ºÏ†ú');
      keys.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'topic-btn';
        btn.textContent = t;
        btn.onclick = () => selectMainTopic(t);
        topicArea.appendChild(btn);
      });
      topicArea.style.display = 'flex';
    }
    function selectMainTopic(topic) {
      selectedMain = topic;
      topicArea.style.display = 'none';
      appendMessage(`${topic} Ïù¥ÏïºÍ∏∞Î•º ÏÑ†ÌÉùÌñàÏñ¥!`, 'ai');
      setTimeout(showSubTopics, 300);
    }
    function showSubTopics() {
      appendMessage('Ï°∞Í∏à Îçî Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú?', 'ai');
      topicArea.innerHTML = '';
      const subs = selectedMain === 'ÏûêÏú†Ï£ºÏ†ú'
        ? ['ÏûêÏú†Î°≠Í≤å Ïù¥ÏïºÍ∏∞Ìï¥Î¥ê']
        : counselingTopicsByAge[getAgeGroup(userAge)][selectedMain].map(i => i.displayText);
      subs.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'subtopic-btn';
        btn.textContent = s;
        btn.onclick = () => startChat(s);
        topicArea.appendChild(btn);
      });
      topicArea.style.display = 'flex';
    }
    function startChat(init) {
      topicArea.style.display = 'none';
      inputArea.style.display = 'flex';
      sendMessage(init);
    }
    function getAgeGroup(age) {
      if (age <= 10) return '8-10';
      if (age <= 15) return '11-15';
      return '30+';
    }

    // STT (SpeechRecognition)
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition, isRec = false;
    if (Rec) {
      recognition = new Rec();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'ko-KR';
      recognition.onstart = () => { isRec = true; micButton.classList.add('recording'); };
      recognition.onend   = () => { isRec = false; micButton.classList.remove('recording'); stopAudioAnalysis(); };
      recognition.onresult = e => {
        let txt = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) txt += e.results[i][0].transcript;
        }
        if (txt) sendMessage(txt);
      };
      recognition.onerror = err => { console.error(err); appendMessage('ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò', 'ai'); isRec = false; micButton.classList.remove('recording'); stopAudioAnalysis(); };
      micButton.onclick = async () => {
        if (isRec) recognition.stop();
        else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupAudioAnalysis(stream);
            recognition.start();
          } catch (e) {
            console.error(e);
            appendMessage('ÎßàÏù¥ÌÅ¨ Í∂åÌïú Ïò§Î•ò', 'ai');
          }
        }
      };
    } else {
      micButton.disabled = true;
      appendMessage('ÏùåÏÑ± Ïù∏Ïãù ÏßÄÏõê ÏïàÎê®', 'ai');
    }

    // Ïò§ÎîîÏò§ Î∂ÑÏÑù
    let audioContext, analyser, sourceNode, dataArray, animId, micStream;
    const LOW = { r: 0, g: 200, b: 0 }, MID = { r: 255, g: 200, b: 0 }, HIGH = { r: 255, g: 69, b: 0 };
    function interp(c1, c2, f) { return `rgb(${Math.round(c1.r + f*(c2.r-c1.r))},${Math.round(c1.g + f*(c2.g-c1.g))},${Math.round(c1.b + f*(c2.b-c1.b))})`; }
    function setupAudioAnalysis(stream) {
      micStream = stream;
      audioContext = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioContext.createAnalyser(); analyser.fftSize=256; analyser.smoothingTimeConstant=0.3;
      sourceNode = audioContext.createMediaStreamSource(stream);
      sourceNode.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      drawVolume();
    }
    function drawVolume() {
      animId = requestAnimationFrame(drawVolume);
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a,v)=>a+v,0)/dataArray.length;
      const norm = Math.min(100, Math.max(0, (avg/140)*100));
      meterLevel.style.width = `${norm}%`;
      const col = norm<=50 ? interp(LOW, MID, norm/50) : interp(MID, HIGH, (norm-50)/50);
      meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${col})`;
    }
    function stopAudioAnalysis() {
      cancelAnimationFrame(animId);
      sourceNode.disconnect();
      micStream.getTracks().forEach(t=>t.stop());
      audioContext.close();
      meterLevel.style.width='0%';
    }

    // Î©îÏãúÏßÄ Ï†ÑÏÜ°
    async function sendMessage(text) {
      if (!text || isProcessing) return;
      isProcessing = true;
      appendMessage(text, 'user'); chatHistory.push({role:'user',content:text});
      chatInput.value='';
      const res = await getGptResponse(text, { chatHistory });
      const data = await res.json();
      const cut = data.text.indexOf('{');
      const msg = cut>=0 ? data.text.slice(0,cut).trim() : data.text;
      appendMessage(msg,'ai'); await playTTSWithControl(msg);
      chatHistory.push({role:'assistant',content:msg});
      await saveSessionLog(text, msg, data.analysis||{});
      showAnalysisNotification();
      isProcessing = false;
    }

    // ÏûÖÎ†• Ïù¥Î≤§Ìä∏
    sendBtn.addEventListener('click', ()=> sendMessage(chatInput.value));
    chatInput.addEventListener('keydown', e => {
      meta.lastInputTimestamp = Date.now();
      const fillers = ['Ïùå','‚Ä¶','Ïñ¥','Í∏ÄÏéÑ','Î™®Î•¥Í≤†Ïñ¥Ïöî','Ïûò Î™®Î•¥Í≤†Ïñ¥'];
      meta.fillerCount = fillers.some(f=>chatInput.value.includes(f))? meta.fillerCount+1 : 0;
      meta.clickedOption = false;
      skipTTS = true;
      stopCurrentTTS();
      if (e.key==='Enter') sendMessage(chatInput.value);
    });

    // Ï¥àÍ∏∞Ìôî
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Ï¥àÍ∏∞Ìôî ÏãúÏûë');
      const greeting = getInitialGreeting(userName + voc, hasGreeted);
      appendMessage(greeting,'ai');
      await playTTSWithControl(greeting);
      hasGreeted = true;
      showMainTopics();
    });
  </script>
</body>
</html>
