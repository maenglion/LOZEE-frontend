<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ ë²„ì „(v3.19)ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. */
    body { display: flex; flex-direction: column; min-height: 100vh; background-color: #ffffff; color: #333; font-family: 'KoPubWorld Dotum', sans-serif; margin: 0; }
    #main-header { background-color: #0095FF; color: white; padding: 1rem; text-align: center; font-size: 20px; font-weight: bold; flex-shrink: 0; }
    #chat-container { flex: 1; display: flex; flex-direction: column; overflow-y: hidden; width: 100%; max-width: 700px; margin: 0 auto; box-sizing: border-box; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; font-size: 16px; white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user { background-color: #fff9c4; color: #333; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .ai { background-color: #0095FF; color: white; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 5px; }
    .bubble.ai.error { background-color: #ff7373; color: white; }
    #loading-indicator-talk { text-align: center; padding: 10px; display: none; color: #555; font-style: italic; }
    #talk-btn-container { padding: 15px 0; background-color: #ffffff; flex-shrink: 0; text-align: center; border-top: 1px solid #eee; }
    #talk-btn { font-family: 'KoPubWorld Dotum', sans-serif; width: 80px; height: 80px; border-radius: 50%; background-color: #b6b6b6; border: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); color: white; font-size: 36px; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; transition: transform 0.2s ease, background-color 0.3s; }
    #talk-btn.active { background-color: #0095FF; transform: scale(1.1); }
    #talk-btn.recording-in-progress { background-color: #e06c75; transform: scale(1.1); }
    #talk-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: scale(1.0); }
    #topic-selection { display: none; background: #f0f0f0; padding: 20px; border-top: 1px solid #ddd; text-align: center; flex-shrink: 0; }
    #topic-selection h3 { font-size: 18px; color: #333; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
    .topic-option { font-family: 'KoPubWorld Dotum', sans-serif; padding: 10px 15px; margin: 8px auto; background: white; border: 1px solid #0095FF; color: #0095FF; border-radius: 10px; cursor: pointer; max-width: 320px; font-size: 15px; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
    .topic-option:hover { background-color: #0095FF; color: white; }
    #waiting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);  display: none;  justify-content: center; align-items: center; z-index: 1000;  color: white; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer;  }
  </style>
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="chat-container">
    <div id="chat-window"></div>
    <div id="topic-selection">
      <h3>ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ê³  ì‹¶ì€ ì£¼ì œë¥¼ ê³¨ë¼ë³¼ë˜?</h3>
      <div id="topic-options"></div>
    </div>
  </div>
  <div id="loading-indicator-talk">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>
  <div id="waiting-overlay">
    <p><span id="waitingUserName"></span>ë‹˜, ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...<br><small>(í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”)</small></p>
  </div>

  <script type="module">
    // ì™¸ë¶€ ëª¨ë“ˆ ì„í¬íŠ¸
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    console.log("talk.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (v3.21 - handleUserInteraction ë¡œê¹… ê°•í™”)");

    // DOM ìš”ì†Œ ì°¸ì¡° (null ê°€ëŠ¥ì„± ë°©ì§€ ìœ„í•´ í•¨ìˆ˜ ë‚´ë¶€ ë˜ëŠ” DOMContentLoaded í›„ ì ‘ê·¼ ê³ ë ¤)
    let talkBtn, chatWindow, topicSelectionBox, topicOptionsContainer, loadingIndicatorTalk, waitingOverlay, waitingUserNameSpan;

    // localStorage ê°’ ê°€ì ¸ì˜¤ê¸°
    const currentUserName = localStorage.getItem('lozee_username') || "ì¹œêµ¬";
    const currentUserId = localStorage.getItem('lozee_username'); 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';
    
    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try { selectedEmotions = JSON.parse(selectedEmotionsString); } 
        catch (e) { console.error("ì„ íƒëœ ê°ì • localStorage íŒŒì‹± ì˜¤ë¥˜:", e); selectedEmotions = []; }
    }

    const simplified = (() => {
      const age = parseInt(currentUserAge || "0", 10);
      const disease = (currentUserDisease || "").toLowerCase();
      const needsSimple = age < 15 || ["ì•„ìŠ¤í¼ê±°", "asd", "adhd", "ì‚¬íšŒì ì˜ì‚¬ì†Œí†µì¥ì• "].some(d => disease.includes(d));
      const isVeryYoung = age < 10;
      console.log(`[Simplified Language Check] Age: ${age}, Disease: "${disease}", NeedsSimple: ${needsSimple}, IsVeryYoung: ${isVeryYoung}`);
      return { useSimpleLanguage: needsSimple, useUltraSimpleLanguage: isVeryYoung };
    })();
    
    // ë‚˜ë¨¸ì§€ ì „ì—­ ë³€ìˆ˜ë“¤
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer;
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTimeValue; 

    const ADMIN_SECRET_PHRASE = "ë§¹ê³ ì–‘ì´";
    const ADMIN_EMAIL = "maengnanyoung@gmail.com";

    let totalCharacterCount = 0;
    let conversationStartTime = null;
    const ANALYSIS_CHAR_THRESHOLD = 800; 
    const ANALYSIS_TIME_THRESHOLD_SECONDS = 180; 
    let analysisRedirectInProgress = false;
    
    let currentSegmentDuration = 40000; 
    let maxTotalRecordingTime = 600000;  
    let autoSegmentStartTime = null;     
    let currentSegmentInAutoChain = 0;   
    let autoStopTimer = null; 
    const API_DISCONNECT_DELAY_MS = 100; 

    function getRecordingPolicyByAge(age) { /* (v3.19ì™€ ë™ì¼) */ }
    function appendMessage(text, role = 'ai', isError = false) { /* (v3.19ì™€ ë™ì¼) */ }
    function disableTalkButton(disable = true, reason = "") { 
        if (talkBtn) { 
            talkBtn.disabled = disable;
        }
        console.log(`[disableTalkButton] ${disable ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}${reason ? ` (${reason})` : ''}`);
    }
    async function loadRecentTopics() { /* (v3.19ì™€ ë™ì¼) */ }
    function showTopicBox(topics) { /* (v3.19ì™€ ë™ì¼) */ }
    function startSilenceTimer() { /* (v3.19ì™€ ë™ì¼) */ }
    function resetSilenceTimer() { 
        clearTimeout(silenceTimer);
        if (topicSelectionBox && topicSelectionBox.style.display === 'none' && talkBtn && !talkBtn.disabled && !analysisRedirectInProgress) {
            console.log("[Timer] ì¹¨ë¬µ íƒ€ì´ë¨¸ ë¦¬ì…‹ ë° ì¬ì‹œì‘."); 
            startSilenceTimer();
        } else { 
            console.log("[Timer] ì¹¨ë¬µ íƒ€ì´ë¨¸ ë¦¬ì…‹ (ì¡°ê±´ ë¯¸ì¶©ì¡±ìœ¼ë¡œ ì‹œì‘ ì•ˆí•¨)."); 
        }
    }
    function checkAndRedirectToAnalysis() { /* (v3.19ì™€ ë™ì¼) */ }
    
    async function handleUserInteraction(userText, context = {}) { 
      console.log(`--- [handleUserInteraction] í•¨ìˆ˜ ì‹œì‘ë¨ --- User Text: "${userText ? userText.substring(0,30)+'...' : 'ì—†ìŒ'}"`);
      if (!userText || userText.trim() === "" || analysisRedirectInProgress) {
          console.log("[handleUserInteraction] ì¡°ê±´ ë¯¸ì¶©ì¡± ë˜ëŠ” ë¶„ì„ í˜ì´ì§€ ì´ë™ ì¤‘ìœ¼ë¡œ ë°˜í™˜.");
          // ì´ ê²½ìš°, ë²„íŠ¼ í™œì„±í™”ë‚˜ íƒ€ì´ë¨¸ ë¦¬ì…‹ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ (í˜¸ì¶œë¶€ì—ì„œ ê´€ë¦¬í•´ì•¼ í•¨)
          if (!analysisRedirectInProgress && talkBtn && talkBtn.disabled) { // STT í›„ í˜¸ì¶œëœ ê²½ìš° ë²„íŠ¼ì´ ë¹„í™œì„±í™” ìƒíƒœì¼ ìˆ˜ ìˆìŒ
              disableTalkButton(false, "ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì ì…ë ¥ ë˜ëŠ” ë¶„ì„ ì´ë™ ì¤‘");
              resetSilenceTimer(); // ì´ëŸ° ê²½ìš°ì—ë„ ì¹¨ë¬µ íƒ€ì´ë¨¸ëŠ” ë¦¬ì…‹í•´ì£¼ëŠ” ê²ƒì´ ì•ˆì „
          }
          return;
      }

      if (!conversationStartTime) {
          conversationStartTime = Date.now();
          console.log(`[handleUserInteraction] ëŒ€í™” ì‹œì‘ ì‹œê°„ ê¸°ë¡ë¨: ${new Date(conversationStartTime).toLocaleString()}`);
      }
      
      disableTalkButton(true, "AI ì‘ë‹µ ëŒ€ê¸° ì¤‘"); 
      if (topicSelectionBox) topicSelectionBox.style.display = 'none'; 
      if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'block';

      const gptContext = { userAge: currentUserAge, userDisease: currentUserDisease, useSimpleLanguage: simplified.useSimpleLanguage, useUltraSimpleLanguage: simplified.useUltraSimpleLanguage, ...context };
      console.log("[handleUserInteraction] GPT Context:", gptContext);
      
      try {
        console.log("[handleUserInteraction] getGptResponse í˜¸ì¶œ ì‹œë„...");
        const gptResponse = await getGptResponse(userText, currentUserId, gptContext);
        console.log("[handleUserInteraction] getGptResponse í˜¸ì¶œ ì™„ë£Œ. ì‘ë‹µ:", gptResponse);

        let aiReply = gptResponse?.rephrasing || gptResponse?.error || "ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ì´í•´í•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆì–´ìš”.";
        let isError = !gptResponse?.rephrasing;
        if (gptResponse?.summary) localStorage.setItem('lozee_lastSummary', (lastSummary = gptResponse.summary));
        
        if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none'; 
        const aiBubbleDiv = appendMessage(aiReply, 'ai', isError); 
        if(aiBubbleDiv && chatWindow) { chatWindow.appendChild(aiBubbleDiv); chatWindow.scrollTop = chatWindow.scrollHeight; }
        
        if (!analysisRedirectInProgress) { 
            try { 
                console.log("[handleUserInteraction] playTTSFromText í˜¸ì¶œ ì‹œë„...");
                await playTTSFromText(aiReply, currentVoiceId); 
                console.log("[handleUserInteraction] playTTSFromText í˜¸ì¶œ ì™„ë£Œ.");
            } catch (e) { console.error("TTS ì‹¤íŒ¨:", e); } 
        }
      } catch (error) { 
        console.error("[handleUserInteraction] try ë¸”ë¡ ë‚´ì—ì„œ ì˜ˆì™¸ ë°œìƒ (GPT ë˜ëŠ” TTS ê´€ë ¨):", error);
        if (loadingIndicatorTalk) loadingIndicatorTalk.style.display = 'none';
        const fallbackMsg = "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.";
        const errorBubble = appendMessage(fallbackMsg, 'ai', true);
        if(errorBubble && chatWindow) chatWindow.appendChild(errorBubble);
        if (!analysisRedirectInProgress) {
            try { await playTTSFromText(fallbackMsg, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨ (ì˜¤ë¥˜ ì²˜ë¦¬ ì¤‘):", e); }
        }
      } finally {
        console.log("[handleUserInteraction] finally ë¸”ë¡ ì‹¤í–‰ë¨.");
        if (!analysisRedirectInProgress) { 
            disableTalkButton(false, "AI ì‘ë‹µ/ì˜¤ë¥˜ ì²˜ë¦¬ ì™„ë£Œ"); 
            currentSegmentInAutoChain = 0; 
            resetSilenceTimer(); 
            checkAndRedirectToAnalysis(); 
        }
        console.log("--- [handleUserInteraction] í•¨ìˆ˜ ì¢…ë£Œë¨ ---");
      }
    }

    async function startRecording() { /* (v3.19ì™€ ë™ì¼) */ }
    function stopRecording(isManualStop = false) { /* (v3.19ì™€ ë™ì¼) */ }
    function setupEventListeners() { /* (v3.20ê³¼ ë™ì¼) */ }
    async function initializeChat() { /* (v3.20ê³¼ ë™ì¼) */ }

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ. ì´ˆê¸°í™” ë¡œì§ ì‹¤í–‰ ì¤€ë¹„.");
        talkBtn = document.getElementById('talk-btn');
        chatWindow = document.getElementById('chat-window');
        topicSelectionBox = document.getElementById('topic-selection');
        topicOptionsContainer = document.getElementById('topic-options');
        loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
        waitingOverlay = document.getElementById('waiting-overlay');
        waitingUserNameSpan = document.getElementById('waitingUserName');
        
        if (!talkBtn || !chatWindow || !topicSelectionBox || !topicOptionsContainer || !loadingIndicatorTalk || !waitingOverlay || !waitingUserNameSpan) {
            console.error("DOMContentLoaded: í•„ìˆ˜ DOM ìš”ì†Œ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
        setupEventListeners(); 
        initializeChat();    
    });
  </script>
</body>
</html>
