<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> 
<style>
  :root {
      --primary-color: #6e8efb;
      --secondary-color: #5a7edf;
      --background-color: #ffffff;
      --text-color: #333333;
      
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --assistant-bubble-bg: #F5E7A1; /* ë¡œì§€ ë§í’ì„  ë°°ê²½ìƒ‰ */
      --assistant-bubble-text: #333333;

      --input-area-bg: #f8f9fa;
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef;
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px;
      --meter-top-margin: 8px;

      --analysis-notification-bg: #fff3cd;
      --analysis-notification-text: #856404;

      --gnb-height: 56px; 
      --chat-input-area-height: 70px;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height); 
      font-family: 'KoPub World Dotum', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px;
      transition: width 0.05s linear, background-color 0.05s linear;
    }
    
    #chat-window {
      flex: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
      padding-bottom: calc(var(--chat-input-area-height) + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.assistant_feedback { 
      background: #e9ecef; 
      color: #495057;
      align-self: center; 
      font-size: 0.9em;
      border-radius: 8px;
    }
    .bubble.thinking { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-style: italic;
      opacity: 0.8;
    }

    .manual-save-btn { /* ìˆ˜ë™ ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­) */
      background-color: #4CAF50; /* ì´ˆë¡ìƒ‰ ê³„ì—´ */
      color: white;
      border-color: #388E3C;
    }
  
  .journal-save-notification { /* ì €ë„ ì €ì¥ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
      align-self: center;
      background: #e8f5e9; /* ì—°í•œ ì´ˆë¡ìƒ‰ */
      color: #2e7d32;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
      border: 1px solid #c8e6c9;
  }

    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    #topic-area { 
      display: none !important; 
    }

    #input-area {
      padding: 0 30px; 
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; 
      align-items: center;
      gap: 8px;
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px;
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      min-width: 50px; 
      padding: 10px 16px;
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px;
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn {
      width: 44px;
      min-width: 44px; 
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      transition: background-color 0.2s ease;
      flex-shrink: 0; 
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording {
      background: #e74c3c;
    }
    #send-btn.loading {
        background:#cccccc;
        cursor:default;
    }
    
    @media (max-width: 600px) {
      #input-area { padding: 0 20px; gap: 5px; } 
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
    }
     @media (max-width: 360px) { 
        #input-area { padding: 0 10px; gap: 5px; }
        #mic-button, #send-btn { width: 38px; height: 38px; font-size: 1.1em; }
        #chat-input { height: 38px; }
    }

    .chat-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
      align-items: flex-start;
      max-width: 80%;
      align-self: flex-start;
    }
    .chat-option-btn {
      background-color: #f1f1f1;
      color: #333333;
      border: 1px solid #dcdcdc;;
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .chat-option-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-1px);
    }
    .chat-option-btn.selected {
      background-color: #E4D2FD; 
      color: #333;
      border-color: #c3b2e0; 
      font-weight: bold;
    }
    .chat-option-btn.continue-topic-btn { 
        background-color: #FFDAB9; 
        border-color: #FFA07A;
    }
    .chat-option-btn:disabled {
      background-color: #f8f8f8;
      color: #aaaaaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .chat-option-btn.manual-save-btn {
     background-color: #ff7f7f;
     color: #ffffff;
     border-color: #4f69ff;
     }
</style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav>

    <div id="meter-container"><div id="volume-level"></div></div>
    <div id="chat-window"></div>
    <div id="input-area">
        <button id="mic-button">ğŸ¤</button>
        <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
        <button id="send-btn">â¤</button>
    </div>

    <script type="module">
        import './js/firebase-config.js';
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
        import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
        import LOZEE_ANALYSIS from './js/lozee-analysis.js';
        // â­ saveManualJournalEntry import ì¶”ê°€
        import { saveJournalEntry, saveManualJournalEntry, updateTopicStats, logSessionStart, logSessionEnd } from './js/firebase-utils.js'; 
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let skipTTS = false;
        let hasGreeted = false;
        let isProcessing = false;
        let chatHistory = [];
        let selectedMain = null; 
        let isPlayingTTS = false; 
        let conversationStartTime = null;
       
        let analysisNotificationShown = false; // ìƒì„¸ ë¶„ì„ ì•Œë¦¼ ì—¬ë¶€
        let journalSaveNotificationShown = false; // ì €ë„ ì €ì¥ ì•Œë¦¼ ì—¬ë¶€ (800ì ê¸°ì¤€)
        
        let sessionTimeoutId = null;
        const SESSION_TIMEOUT_DURATION = 5 * 60 * 1000; // 5ë¶„
        let lastAiAnalysisData = null; 
        
        let userTurnCountInSession = 0; 
        let userCharCountInSession = 0; 
        let previousTotalUserCharCountOverall = 0;

        let assistantMessageCount = 0, gptVerbosityPreference = 'default';
        let lastVerbosityPromptTime = 0, verbosityPromptCount = 0; 
        const PREFERENCE_PROMPT_INTERVAL = 10 * 60 * 1000;
        let currentFirestoreSessionId = null; 

        // â”€â”€â”€ ì¶”ê°€ëœ ìƒíƒœ ë³€ìˆ˜: ìˆ˜ë™ ì €ì¥ ëŒ€ê¸°/í™•ì • í”Œë˜ê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let awaitManualSave = false;         // Assistantê°€ â€œë°©ë²•ì„ ì•Œë ¤ì¤„ê¹Œ?â€ ë¼ê³  ë¬¼ì—ˆì„ ë•Œ trueë¡œ ì„¤ì •
        let manualSaveConfirmed = false;     // ì‚¬ìš©ìê°€ â€œë°©ë²•ì„ ì•Œë ¤ì¤˜.â€ ì„ íƒ ì‹œ trueë¡œ ì„¤ì •
        let isMicProcessing = false; // ë§ˆì´í¬ ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸



        // --- UI ìš”ì†Œ ---
        const chatWindow = document.getElementById('chat-window');
        const topicArea = document.getElementById('topic-area'); 
        const inputArea = document.getElementById('input-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const micButton = document.getElementById('mic-button');
        // GNB ë©”ë‰´ í† ê¸€ì€ gnb.jsì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ, talk.html ë‚´ ì§ì ‘ì ì¸ GNB JS ì½”ë“œ ì‚­ì œ
        const meterLevel = document.getElementById('volume-level');

        // --- ì‚¬ìš©ì ì •ë³´ ---
        const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
        const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10); 
        const currentUserEmail = localStorage.getItem('cbtUserEmail');
        const userType = localStorage.getItem('lozee_userType') || '';
        const voc = getKoreanVocativeParticle(userName);

        // --- Firestoreì—ì„œ ì´ì „ ëˆ„ì  ê¸€ì ìˆ˜ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ---
        async function fetchPreviousUserCharCount() {
            if (!currentUserEmail) return 0;
            try {
                const userRef = doc(db, 'users', currentUserEmail);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().totalUserCharCount) {
                    return parseInt(userSnap.data().totalUserCharCount, 10) || 0;
                }
            } catch (error) {
                console.error("Firestoreì—ì„œ ì´ì „ ëˆ„ì  ê¸€ì ìˆ˜ ë¡œë“œ ì˜¤ë¥˜:", error);
            }
            return 0;
        }

        // --- ì´ˆê¸°í™” ë¡œì§ ---
document.addEventListener('DOMContentLoaded', async () => {
            console.log('talk.html: DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
            if (!currentUserEmail) {
                alert("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                window.location.href = 'index.html'; return;
            }
            conversationStartTime = Date.now(); 
            previousTotalUserCharCountOverall = await fetchPreviousUserCharCount();
            resetSessionTimeout(); 

            let startedWithInitTopic = false; // ì´ì–´í•˜ê¸°ë¡œ ì‹œì‘í–ˆëŠ”ì§€ ì—¬ë¶€ í”Œë˜ê·¸
            const initTopicDataString = localStorage.getItem('lozee_talk_init_topic');
            if (initTopicDataString) {
                try {
                    const initTopic = JSON.parse(initTopicDataString);
                    localStorage.removeItem('lozee_talk_init_topic'); 
                    if (initTopic.details) { 
                        selectedMain = initTopic.details; 
                        const initialMessageFromLozee = initTopic.prompt || `ì§€ë‚œë²ˆ '${selectedMain}' ì´ì•¼ê¸°ì— ì´ì–´ì„œ ë” ë‚˜ëˆ ë³¼ê¹Œ? ì–´ë–¤ ì ì´ ê¶ê¸ˆí•˜ê±°ë‚˜ ë” ì´ì•¼ê¸°í•˜ê³  ì‹¶ì–´?`;
                        appendMessage(initialMessageFromLozee, 'assistant');
                        console.log(`talk.html: "${selectedMain}" ì£¼ì œ ì´ì–´í•˜ê¸° ì‹œì‘.`);
                        startChat(initialMessageFromLozee, 'topic_selection_init'); 
                        hasGreeted = true; // ì´ì–´í•˜ê¸°ë„ ì¼ì¢…ì˜ ì¸ì‚¬ë¡œ ê°„ì£¼
                        startedWithInitTopic = true; 
                    }
                } catch (e) { 
                    console.error("ì´ì–´í•˜ê¸° ì£¼ì œ(lozee_talk_init_topic) íŒŒì‹± ì˜¤ë¥˜:", e); 
                    localStorage.removeItem('lozee_talk_init_topic');
                }
            }

            // â­ ì´ì–´í•˜ê¸°ë¡œ ì‹œì‘í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¼ë°˜ì ì¸ ì²«ì¸ì‚¬ ë° ì£¼ì œ ì„ íƒ í‘œì‹œ â­
            if (!startedWithInitTopic) {
                const greeting = getInitialGreeting(userName + voc, hasGreeted);
                appendMessage(greeting, 'assistant');
                hasGreeted = true;
                showMainTopics(); // ì£¼ì œ ì„ íƒ ë²„íŠ¼ í‘œì‹œ
            }
        });


        // --- ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜ ---
        function appendMessage(text, role) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + role; 
            bubble.textContent = text;
            if(chatWindow) { 
            chatWindow.appendChild(bubble); 
            chatWindow.scrollTop = chatWindow.scrollHeight; } 
            else { console.error("appendMessage: chatWindow ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
        }

        // --- â­ ì•Œë¦¼ í•¨ìˆ˜ ë¶„ë¦¬ (ì €ë„ ì €ì¥ / ë¶„ì„ ì™„ë£Œ) â­ ---
        function showJournalSavedNotification(journalId) {
            if (journalSaveNotificationShown) return; // ì´ë¯¸ ì•Œë¦¼ì´ ë–´ìœ¼ë©´ ì¤‘ë³µ ë°©ì§€ (ì„ íƒì )
            const notification = document.createElement('div');
            notification.className = 'journal-save-notification'; // CSS í´ë˜ìŠ¤ ì ìš©
            notification.textContent = 'âœ… ì„¸ì…˜ ì´ì•¼ê¸° ì €ì¥ ì™„ë£Œ! (í´ë¦­í•´ì„œ í™•ì¸)'; 
            notification.onclick = () => { 
                // journal.htmlë¡œ ì´ë™ ì‹œ í•„ìš”í•œ ì •ë³´ ì „ë‹¬ (ì˜ˆ: localStorage ì‚¬ìš©)
                // ì´ì „ì— ì €ì¥ëœ lozee_conversation_analysisëŠ” ê°€ì¥ ìµœê·¼ "ë¶„ì„" ê²°ê³¼ì´ë¯€ë¡œ,
                // ì €ë„ ìƒì„¸ëŠ” Firestoreì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì¢‹ìŒ.
                // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ journal.htmlë¡œ journalIdë§Œ ë„˜ê¹€.
                window.location.href = `journal.html?journalId=${journalId}`; 
            };
            if(chatWindow) chatWindow.appendChild(notification);
            journalSaveNotificationShown = true; // í˜„ì¬ ì„¸ì…˜ì—ì„œ ì €ë„ ì €ì¥ ì•Œë¦¼ í•œ ë²ˆë§Œ
        }
               
        function showAnalysisNotification() { // ê¸°ì¡´ showAnalysis() ì´ë¦„ ë³€ê²½
            if (analysisNotificationShown) return;
            const notification = document.createElement('div');
            notification.className = 'analysis-notification'; // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì‚¬ìš©
            notification.textContent = 'ğŸ“Š ë¶„ì„ ì™„ë£Œ! (í´ë¦­í•´ì„œ í™•ì¸)'; 
            notification.onclick = () => { location.href = 'analysis.html'; };
            if(chatWindow) chatWindow.appendChild(notification);
            analysisNotificationShown = true; 
        }


        // --- TTS ì œì–´ ì¬ìƒ í•¨ìˆ˜ ---
        async function playTTSWithControl(txt) {
            if (isRec && recog && typeof recog.stop === 'function') { 
                 console.log("TTS ì¬ìƒ ì „ STT ëª…ì‹œì  ì¤‘ì§€"); recog.stop(); 
            }
            if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
            else console.warn("stopCurrentTTS í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (skipTTS) { skipTTS = false; return Promise.resolve(); }
            isPlayingTTS = true;
            try {
                if (typeof playTTSFromText === 'function') {
                    await playTTSFromText(txt, localStorage.getItem('lozee_voice'));
                } else { console.warn("playTTSFromText í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");}
            } catch (error) { console.error("playTTSWithControl ë‚´ TTS ì¬ìƒ ì˜¤ë¥˜:", error); } 
            finally { isPlayingTTS = false; }
        }

        // --- ì˜¤ë””ì˜¤ ë¶„ì„ ê´€ë ¨ ---
        let audioContext, analyser, source, dataArray, animId, streamRef;
        const LOW_COLOR = { r:0, g:200, b:0 }; const MID_COLOR = { r:255, g:200, b:0 }; const HIGH_COLOR = { r:255, g:69, b:0 };
        function interp(c1, c2, f) { return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;}
        function setupAudioAnalysis(stream) { if (audioContext && audioContext.state !== 'closed') {audioContext.close().catch(e=>console.warn("ì´ì „ AudioContext ë‹«ê¸° ì˜¤ë¥˜:", e));} audioContext = new AudioContext(); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; source = audioContext.createMediaStreamSource(stream); source.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); streamRef = stream; draw(); }
        function draw() { animId = requestAnimationFrame(draw); if (!analyser || !dataArray) return; analyser.getByteFrequencyData(dataArray); let sum = dataArray.reduce((a, v) => a + v, 0); let avg = dataArray.length > 0 ? sum / dataArray.length : 0; let norm = Math.min(100, Math.max(0, (avg / 140) * 100)); if(meterLevel) {meterLevel.style.width = norm + '%'; meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${norm <= 50 ? interp(LOW_COLOR, MID_COLOR, norm / 50) : interp(MID_COLOR, HIGH_COLOR, (norm - 50) / 50)})`;} if (norm > 10 && isRec && isPlayingTTS && !skipTTS) { console.log("ì‚¬ìš©ì ìŒì„± ê°ì§€, TTS ì¤‘ë‹¨ ì‹œë„"); if (typeof stopCurrentTTS === 'function') stopCurrentTTS(); skipTTS = true; } }
        function stopAudio() { if (animId) cancelAnimationFrame(animId); if (source) source.disconnect(); if (streamRef) streamRef.getTracks().forEach(track => track.stop()); if (audioContext && audioContext.state !== 'closed') { audioContext.close().catch(e=>console.warn("AudioContext ë‹«ê¸° ì˜¤ë¥˜:", e)); } audioContext = null; if(meterLevel) { meterLevel.style.width = '0%'; meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-container-bg'); } }

        // --- STT (Web Speech API) ---
        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recog, isRec = false;
        if (SpeechRecognitionAPI) {
            recog = new SpeechRecognitionAPI(); 
            recog.continuous = true; 
            recog.interimResults = true; 
            recog.lang = 'ko-KR';
            recog.onstart = () => { isRec = true; if(micButton) micButton.classList.add('recording'); };
            recog.onend = () => { isRec = false; if(micButton) micButton.classList.remove('recording'); stopAudio(); };
            recog.onresult = event => { 
                resetSessionTimeout(); 
                let interim_transcript = ''; let final_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) { final_transcript += event.results[i][0].transcript; } 
                    else { interim_transcript += event.results[i][0].transcript; }
                }
                if (chatInput && interim_transcript && !final_transcript && document.activeElement === chatInput) {
                    // ì‚¬ìš©ìê°€ ì§ì ‘ íƒ€ì´í•‘ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ (ì„ íƒì  ê°•í™”)
                    // chatInput.value = interim_transcript; 
                }
                if (final_transcript) { 
                    console.log("STT ìµœì¢… ê²°ê³¼:", final_transcript); 
                    if(chatInput) chatInput.value = ''; 
                    sendMessage(final_transcript.trim(), 'stt'); 
                } 
            };
            recog.onerror = event => { console.error('Speech recognition error:', event.error); appendMessage('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error, 'assistant_feedback'); if(isRec && recog){ try{recog.stop();}catch(e){console.warn("recog.stop() ì˜¤ë¥˜:",e)}} isRec = false; if(micButton) micButton.classList.remove('recording'); stopAudio(); };
            
            // gpt ë§ˆì´í¬ ë²„íŠ¼ ëˆŒë €ì„ ì‹œ ì–¸ì œë‚˜ TTS ì¬ìƒì„ ë°”ë€Œë„ë¡ 20250531 ì˜¤í›„ 8ì‹œ 30ë¶„ ìˆ˜ì • 
                  if (micButton) micButton.onclick = async () => {
           // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           // 1) â€œë§ˆì´í¬ê°€ êº¼ì ¸ ìˆë˜(isRec===false) ìƒíƒœë¼ë©´ â†’ TTS ë¨¼ì € ì¬ìƒâ€
           if (!isRec) {
               // (1) ìµœì‹  assistant ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì™€ì„œ TTSë¡œ ì¬ìƒ
               //    chatHistory ë°°ì—´ì—ì„œ role === 'assistant'ì¸ ë§ˆì§€ë§‰ ìš”ì†Œë¥¼ ì°¾ëŠ”ë‹¤
               const lastAssistant = [...chatHistory].reverse().find(m => m.role === 'assistant');
               if (lastAssistant) {
                   try {
                       // ì¬ìƒ ì¤‘ë‹¨ í”Œë˜ê·¸ ì´ˆê¸°í™”
                       skipTTS = false;
                       await playTTSWithControl(lastAssistant.content);
                   } catch (ttsError) {
                       console.error("ë§ˆì´í¬ ëˆ„ë¦„ ì‹œ TTS ì¬ìƒ ì˜¤ë¥˜:", ttsError);
                   }
               }

               // (2) TTSê°€ ëë‚œ ë’¤ì— STT ëª¨ë“œë¡œ ì§„ì…
               try {
                   if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
                   // TTSë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë©ˆì¶”ê³  skipTTS ì¬ì„¤ì •(ì´ë¯¸ ì¬ìƒì´ ëë‚¬ìœ¼ë¯€ë¡œ)
                   skipTTS = true;
                   const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                   setupAudioAnalysis(stream);
                   if (recog) recog.start();
               } catch (e) {
                   console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', e);
                   appendMessage('ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'assistant_feedback');
               }

           } else {
               // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               // 2) ì´ë¯¸ ìŒì„± ì¸ì‹ ì¤‘(isRec===true)ì´ë¼ë©´ â†’ ê·¸ëƒ¥ ìŒì„± ì¸ì‹ ì¢…ë£Œ
               if (recog) recog.stop();
          }
       };
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 

        } else { 
            if(micButton) micButton.disabled = true; 
            appendMessage('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'assistant_feedback'); 
        }


        // --- â­ ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­ ë¡œì§ ìˆ˜ì • (ì¤‘ë³µ ë°©ì§€) â­ ---
        if(micButton) {
            micButton.onclick = async () => {
                if (isMicProcessing) { // ì´ë¯¸ ë§ˆì´í¬ ì²˜ë¦¬ ì¤‘ì´ë©´
                    appendMessage("ë¡œì§€ì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”... ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ğŸ˜Š", "assistant_feedback");
                    return;
                }
                isMicProcessing = true; // ì²˜ë¦¬ ì‹œì‘ í”Œë˜ê·¸

                if (isRec) { // STT ì¤‘ì´ë©´ ì¢…ë£Œ
                    if(recog) recog.stop(); 
                    isMicProcessing = false; // ì²˜ë¦¬ ì™„ë£Œ
                } else { // STT ì‹œì‘ ì „
                    if (typeof stopCurrentTTS === 'function') stopCurrentTTS(); 
                    skipTTS = true;   
                    try { 
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
                        setupAudioAnalysis(stream); 
                        if(recog) recog.start(); 
                    } catch (e) { 
                        console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', e); 
                        appendMessage('ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'assistant_feedback'); 
                        isMicProcessing = false; // ì˜¤ë¥˜ ì‹œ í”Œë˜ê·¸ í•´ì œ
                    }
                    // STT ì‹œì‘ í›„ isMicProcessingì€ STT onstart/onendì—ì„œ ê´€ë¦¬í•˜ê±°ë‚˜,
                    // STT ê²°ê³¼ ì²˜ë¦¬ í›„ sendMessageì—ì„œ isProcessingì´ falseê°€ ë  ë•Œ í•¨ê»˜ falseë¡œ ì„¤ì •
                    // ì—¬ê¸°ì„œëŠ” STT ì‹œì‘ ìš”ì²­ í›„ ì¼ë‹¨ falseë¡œ ë‘ì–´, STT ì˜¤ë¥˜ ì‹œ ë‹¤ì‹œ ëˆ„ë¥¼ ìˆ˜ ìˆë„ë¡ í•¨ (ë‹¨, STTê°€ ë°”ë¡œ ì‹œì‘ ì•ˆ ë˜ë©´ ë¬¸ì œ ê°€ëŠ¥)
                    // ë” ë‚˜ì€ ë°©ë²•ì€ STT onstartì—ì„œ isMicProcessingì„ trueë¡œ, onend/onerrorì—ì„œ falseë¡œ í•˜ëŠ” ê²ƒ
                    // í˜„ì¬ STT onstartì—ì„œ isRec=true; micButton.classList.add('recording'); í•˜ë¯€ë¡œ,
                    // isRec ìƒíƒœë¥¼ isMicProcessing ëŒ€ì‹  ì‚¬ìš©í•´ë„ ìœ ì‚¬í•˜ê²Œ ë™ì‘ ê°€ëŠ¥
                    // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ isMicProcessingì„ ë¹ ë¥´ê²Œ falseë¡œ ëŒë ¤ ì—¬ëŸ¬ ë²ˆ ëˆ„ë¥´ëŠ” ê²ƒ ìì²´ë¥¼ ë§‰ê¸°ë³´ë‹¤ëŠ”,
                    // ë‹µë³€ ëŒ€ê¸° ì¤‘ì´ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒì— ì´ˆì 
                    setTimeout(() => { isMicProcessing = false; }, 1000); // 1ì´ˆ í›„ ë‹¤ì‹œ ëˆ„ë¥¼ ìˆ˜ ìˆë„ë¡ (ì„ì‹œ)
                } 
            };
        } else { console.error("micButton ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }


        // --- í† í”½ í”Œë¡œìš° ---
 function getTopicsForCurrentUser() {
            // const userType = localStorage.getItem('lozee_userType'); // ì´ë¯¸ ì „ì—­ìœ¼ë¡œ ì„ ì–¸ë¨
            // â­ ë³´í˜¸ì ìœ í˜•ì¼ ë•Œë„ 'ë³¸ì¸ ë‚˜ì´(userAge)'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ counselingTopicsByAge.caregiver ì¡°íšŒ
            const ageForTopicLookup = userAge; // ì•„ì´ ë‚˜ì´ê°€ ì•„ë‹Œ ë³´í˜¸ì ë³¸ì¸ ë‚˜ì´ ì‚¬ìš©
            
            console.log(`getTopicsForCurrentUser - userType: ${userType}, ageForTopicLookup (ë³´í˜¸ìë³¸ì¸ë‚˜ì´ ë˜ëŠ” ë‹¹ì‚¬ìë‚˜ì´): ${ageForTopicLookup}`);

            if (!counselingTopicsByAge) { 
                console.error("counselingTopicsByAge ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (counseling_topics.js í™•ì¸ í•„ìš”)"); 
                return {}; 
            }

            let topicsForUserGroup;
            if (userType === 'directUser' && counselingTopicsByAge.directUser) {
                if (ageForTopicLookup < 11) topicsForUserGroup = counselingTopicsByAge.directUser['10ì„¸ë¯¸ë§Œ'];
                else if (ageForTopicLookup >= 11 && ageForTopicLookup <= 15) topicsForUserGroup = counselingTopicsByAge.directUser['11-15ì„¸'];
                else if (ageForTopicLookup >= 16 && ageForTopicLookup <= 29) topicsForUserGroup = counselingTopicsByAge.directUser['16-29ì„¸'];
                else topicsForUserGroup = counselingTopicsByAge.directUser['30-55ì„¸'] || counselingTopicsByAge.directUser['16-29ì„¸']; // 30-55ì„¸ ë˜ëŠ” ê¸°ë³¸ê°’
            } else if (userType === 'caregiver' && counselingTopicsByAge.caregiver) {
                // ë³´í˜¸ì ì£¼ì œëŠ” ì—°ë ¹ êµ¬ë¶„ ì—†ì´ caregiver ê³µí†µ ì£¼ì œ ì‚¬ìš© ë˜ëŠ” í•„ìš”ì‹œ ì—°ë ¹ëŒ€ ì¶”ê°€
                topicsForUserGroup = counselingTopicsByAge.caregiver; 
            } else {
                console.warn(`ì•Œ ìˆ˜ ì—†ê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì ìœ í˜•(${userType})ì…ë‹ˆë‹¤. ê¸°ë³¸ ì£¼ì œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
                topicsForUserGroup = counselingTopicsByAge.directUser ? (counselingTopicsByAge.directUser['11-15ì„¸'] || {}) : {};
            }
            
            if (!topicsForUserGroup || Object.keys(topicsForUserGroup).length === 0) {
                console.warn(`ì„ íƒëœ ì‚¬ìš©ì ìœ í˜•/ë‚˜ì´ì— ë§ëŠ” ì£¼ì œ ì¹´í…Œê³ ë¦¬ê°€ counseling_topics.jsì— ì •ì˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
                return {};
            }
            console.log("ì„ íƒëœ ì‚¬ìš©ì/ë‚˜ì´ ê·¸ë£¹ ì£¼ì œ:", topicsForUserGroup);
            return topicsForUserGroup;
        }
                
        function displayOptionsInChat(optionsArray, onSelectCallback) { 
            if (!chatWindow) { 
                console.error("displayOptionsInChat: chatWindow ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            const optionsContainer = document.createElement('div'); 
            optionsContainer.className = 'chat-options-container'; 
            const buttons = []; 
            if (!optionsArray || !Array.isArray(optionsArray)) { console.error("displayOptionsInChat: optionsArrayê°€ ìœ íš¨í•œ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤."); 
            return; }
            optionsArray.forEach(optionObject => { 
                let buttonText; let valueToCallback; 
                if (typeof optionObject === 'string') { 
                    buttonText = optionObject; valueToCallback = optionObject;} 
                else if (optionObject && typeof optionObject.displayText !== 'undefined') { 
                    buttonText = optionObject.icon ? `${optionObject.icon} ${optionObject.displayText}` : 
                    optionObject.displayText; valueToCallback = optionObject.displayText; 
                } else { console.warn("displayOptionsInChat: ì˜ëª»ëœ í˜•ì‹ì˜ ì˜µì…˜:", 
                optionObject); 
                return; 
            } 

                const button = document.createElement('button');
                button.className = 'chat-option-btn'; 
                button.textContent = buttonText; 
                if (optionObject && optionObject.isContinuation) { button.classList.add('continue-topic-btn'); }
                if (optionObject && optionObject.isManualSave) { button.classList.add('manual-save-btn');
        }
                
                button.onclick = () => { 
                    buttons.forEach(btn => { 
                        btn.disabled = true; 
                        if (btn === button) { 
                            btn.classList.add('selected'); 
                        } 
                    }); 
                        onSelectCallback(valueToCallback); 
                    }; 
                optionsContainer.appendChild(button); 
                buttons.push(button); 
            }); 
            chatWindow.appendChild(optionsContainer); 
            chatWindow.scrollTop = chatWindow.scrollHeight; 
        }

        function showMainTopics() { 
            console.log("showMainTopics í•¨ìˆ˜ ì‹œì‘ë¨"); 
            appendMessage('ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³¼ê¹Œ?', 'assistant'); 
            const currentUserTopics = getTopicsForCurrentUser(); 
            let topicsWithOptions = []; 

            // "mypage (ë¡œì§€ì™€ì˜ ì•½ì†)"ì—ì„œ ë„˜ì–´ì˜¨ ì´ì–´í•˜ê¸° ì£¼ì œ (íƒ€ì…: 'cognitive_distortion_follow_up' ë“±)
            const continueTopicDataFromPlans = localStorage.getItem('lozee_continue_topic');
            if (continueTopicDataFromPlans) { 
                try { 
                    const topicToContinue = JSON.parse(continueTopicDataFromPlans); 
                    topicsWithOptions.push({ 
                        icon: 'â†ªï¸', 
                        displayText: `[ì•½ì†] ${topicToContinue.details || 'ì´ì „ ìƒê° ì´ì–´ê°€ê¸°'}`, 
                        isContinuation: true, 
                        continueDetails: topicToContinue,
                        type: 'mypage_plan' 
                    }); 
                } catch (e) { console.error("ë¡œì§€ì™€ì˜ ì•½ì† íŒŒì‹± ì˜¤ë¥˜:", e); localStorage.removeItem('lozee_continue_topic');} 
            }
            
            // ì¼ë°˜ ì£¼ì œë“¤ ì¶”ê°€
            if (currentUserTopics && typeof currentUserTopics === 'object' && Object.keys(currentUserTopics).length > 0) { /* ... */ } 
            topicsWithOptions.push({ icon: 'ğŸ—£ï¸', displayText: 'ììœ ì£¼ì œ', isContinuation: false }); 
            
            displayOptionsInChat(topicsWithOptions, (selectedText, fullOptionObject) => { 
                // â­ selectedMain ì„¤ì •ì€ ì—¬ê¸°ì„œ ì´ë£¨ì–´ì§ (ì‚¬ìš©ìê°€ ë²„íŠ¼ í´ë¦­ ì‹œ)
                selectedMain = selectedText; 
                
                if (fullOptionObject && fullOptionObject.isContinuation) { // "ì´ì–´í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ
                    localStorage.removeItem('lozee_continue_topic'); 
                    selectedMain = fullOptionObject.continueDetails.details || selectedText; // ì‹¤ì œ ì£¼ì œëª…ìœ¼ë¡œ selectedMain ì—…ë°ì´íŠ¸
                    appendMessage(selectedMain + ' ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°ˆê²Œ!', 'assistant');
                    const continueMessage = fullOptionObject.continueDetails && fullOptionObject.continueDetails.details 
                        ? `ì €ë²ˆì— ì´ì•¼ê¸°í–ˆë˜ '${selectedMain}'ì— ëŒ€í•´ ê³„ì† ì´ì•¼ê¸°í•´ë³´ì.` 
                        : "ì €ë²ˆì— ë‚˜ëˆ„ë˜ ì´ì•¼ê¸°, ê³„ì†í•´ë³¼ê¹Œ?";
                    startChat(continueMessage, 'topic_selection_init'); 
                } else if (selectedMain === 'ììœ ì£¼ì œ') { 
                    appendMessage(selectedMain + ' ì´ì•¼ê¸°ë¥¼ ì„ íƒí–ˆêµ¬ë‚˜!', 'assistant'); 
                    const message = 'ë„¤ê°€ ì •í•˜ë©´ ë¼. ì–´ë–¤ ì´ì•¼ê¸°ê°€ í•˜ê³  ì‹¶ì–´?'; 
                    appendMessage(message, 'assistant'); 
                    if(inputArea) inputArea.style.display = 'flex'; if(chatInput) chatInput.focus();  
                } else { // ì¼ë°˜ ì£¼ì œ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ
                    appendMessage(selectedMain + ' ì´ì•¼ê¸°ë¥¼ ì„ íƒí–ˆêµ¬ë‚˜!', 'assistant'); 
                    setTimeout(showSubTopics, 300); 
                } 
            }); 
        }
           
        function showSubTopics() { 
            if (!selectedMain) { console.warn("showSubTopics: selectedMainì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"); return; } 
            const currentUserTopicCategories = getTopicsForCurrentUser(); let subtopicOptions = [];
            if (selectedMain === 'ììœ ì£¼ì œ') { startChat('', 'topic_selection_init'); return; } 
            else if (currentUserTopicCategories && currentUserTopicCategories[selectedMain] && Array.isArray(currentUserTopicCategories[selectedMain])) { subtopicOptions = currentUserTopicCategories[selectedMain]; } 
            else { console.warn(`'${selectedMain}' ì¹´í…Œê³ ë¦¬ì— ëŒ€í•œ í•˜ìœ„ ì£¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.`); subtopicOptions = [{ icon: 'ğŸ’¬', displayText: 'ì´ ì£¼ì œì— ëŒ€í•´ ììœ ë¡­ê²Œ ì´ì•¼ê¸°í•´ ì¤„ë˜?' }]; } 
            if (!subtopicOptions || subtopicOptions.length === 0) { console.log(`'${selectedMain}' ì¹´í…Œê³ ë¦¬ì— í•˜ìœ„ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.`); startChat(`'${selectedMain}'ì— ëŒ€í•´ ììœ ë¡­ê²Œ ì´ì•¼ê¸°í•´ì¤˜.`, 'topic_selection_init'); return; } 
            appendMessage('ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì´ì•¼ê¸°í•´ ì¤„ë˜?', 'assistant');
            displayOptionsInChat(subtopicOptions, (selectedSubtopicText) => { startChat(selectedSubtopicText, 'topic_selection_init'); }); 
        }

               function startChat(initText, inputMethod = 'topic_selection_init') { 
            console.log("startChat í•¨ìˆ˜ ì‹œì‘ë¨, ì´ˆê¸° ë©”ì‹œì§€:", initText, "ì…ë ¥ë°©ì‹:", inputMethod, "í˜„ì¬ selectedMain:", selectedMain); 
            // if (topicArea && typeof topicArea.style !== 'undefined') topicArea.style.display = 'none !important'; 
            if (inputArea) inputArea.style.display = 'flex'; 
            
            // â­ ì„¸ì…˜ ì‹œì‘ ë¡œê·¸ëŠ” ì—¬ê¸°ì„œ, selectedMainì´ í™•ì •ëœ í›„ì—, ê·¸ë¦¬ê³  ìƒˆ ì„¸ì…˜ì¼ ë•Œë§Œ
            if(currentUserEmail && selectedMain && !currentFirestoreSessionId && typeof logSessionStart === 'function'){ 
                logSessionStart(currentUserEmail, selectedMain).then(id => {
                    if (id) currentFirestoreSessionId = id;
                    console.log("ìƒˆë¡œìš´ ì„¸ì…˜ ì‹œì‘, ì£¼ì œ:", selectedMain, "ì„¸ì…˜ ID:", currentFirestoreSessionId);
                });
            }
            if (initText && String(initText).trim() !== '') { 
                sendMessage(initText, inputMethod); 
            } else { 
                if (chatInput) chatInput.focus(); 
            }
        }   
         
        
        // --- ë§ ê¸¸ì´ ì„ í˜¸ë„ ì§ˆë¬¸ í•¨ìˆ˜ ---
        function askForVerbosityPreference() {
            if (verbosityPromptCount >= 2) return; 
            const options = [ { displayText: "ë§ì„ ì¢€ ì¤„ì—¬ì¤˜" }, { displayText: "ì§€ê¸ˆì´ ì ë‹¹í•´" }, { displayText: "ë‚˜ì—ê²Œ ë” ë§ì€ ì¡°ì–¸ì„ ì¤˜" } ];
            appendMessage("ì§€ê¸ˆ ë‚´ê°€ í•˜ëŠ” ë§ì´ ë„ˆì—ê²Œ ì ë‹¹í•œì§€ ì•Œë ¤ì¤„ë˜?", 'assistant');
            displayOptionsInChat(options, (selectedOption) => {
                appendMessage(selectedOption, 'user'); 
                if (selectedOption === "ë§ì„ ì¢€ ì¤„ì—¬ì¤˜") gptVerbosityPreference = 'short';
                else if (selectedOption === "ë‚˜ì—ê²Œ ë” ë§ì€ ì¡°ì–¸ì„ ì¤˜") gptVerbosityPreference = 'verbose';
                else gptVerbosityPreference = 'default';
                verbosityPromptCount++; lastVerbosityPromptTime = Date.now(); 
                const followupMessage = "ì•Œë ¤ì¤˜ì„œ ê³ ë§ˆì›Œ! ì´ ì„¤ì •ì€ ì•½ 10ë¶„ê°„ ìœ ì§€ë  ê±°ì•¼. ê³„ì†í•´ì„œ í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸°ë¥¼ í•´ì¤˜.";
                appendMessage(followupMessage, 'assistant');
            });
        }
        
        // --- â­ ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ë° ì €ë„/í†µê³„ ì €ì¥ ë¡œì§ ìˆ˜ì • â­ ---
        function resetSessionTimeout() {
            if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
            sessionTimeoutId = setTimeout(async () => {
                console.log("5ë¶„ ì´ìƒ ëŒ€í™” ì—†ìŒ. ì„¸ì…˜ ì¢…ë£Œ ë° ì €ë„/í†µê³„ ì €ì¥ ì‹œë„.");
                if (currentUserEmail && selectedMain && chatHistory.length > 1) { 
                    const sessionDurationForJournal = Math.round((Date.now() - conversationStartTime) / (1000 * 60));
                    const currentJournalPayload = { 
                        ...(lastAiAnalysisData || {}), 
                        sessionDurationMinutes: sessionDurationForJournal,
                        userCharCountForThisSession: userCharCountInSession 
                    };
                    
                    let savedJournalId = null;
                    if (typeof saveJournalEntry === 'function') {
                        savedJournalId = await saveJournalEntry(currentUserEmail, selectedMain, chatHistory, currentJournalPayload);
                        if (savedJournalId) {
                            // ì €ë„ ì €ì¥ ì„±ê³µ ì‹œ ì•Œë¦¼ì€ ì—¬ê¸°ì„œ í•˜ì§€ ì•Šê³ , ì•„ë˜ ê¸€ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œë§Œ.
                            // ë˜ëŠ”, ì—¬ê¸°ì„œ "ëŒ€í™”ê°€ ë§ˆë¬´ë¦¬ë˜ì–´ ì €ì¥ë˜ì—ˆì–´ìš”" ê°™ì€ ì¼ë°˜ì ì¸ ë©”ì‹œì§€ ê°€ëŠ¥
                        }
                    }
                    if (typeof updateTopicStats === 'function') { await updateTopicStats(currentUserEmail, selectedMain); }
                    
                    // users ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸ (totalUserCharCount, session count)
                    const finalTotalUserCharsToSave = previousTotalUserCharCountOverall + userCharCountInSession;
                    try {
                        const userRef = doc(db, 'users', currentUserEmail);
                        const userSnap = await getDoc(userRef);
                        let updates = { totalUserCharCount: finalTotalUserCharsToSave, lastLogin: serverTimestamp() };
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            if (userType === 'directUser') {
                                updates.totalSessionCount = (userData.totalSessionCount || (userData.directUser ? userData.directUser.totalSessionCount : 0) || 0) + 1;
                            } else if (userType === 'caregiver') {
                                updates.childTotalSessionCount = (userData.childTotalSessionCount || (userData.caregiver ? userData.caregiver.childTotalSessionCount : 0) || 0) + 1;
                            }
                        } else { /* ... (ì‹ ê·œ ì‚¬ìš©ì ì²˜ë¦¬ - index.htmlì—ì„œ ì´ë¯¸ í•¨) ... */ }
                        await setDoc(userRef, updates, { merge: true });
                        previousTotalUserCharCountOverall = finalTotalUserCharsToSave; 
                    } catch (error) { console.error("Firestore ì‚¬ìš©ì ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error); }
                    
                    // ì„¸ì…˜ ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
                    chatHistory = []; lastAiAnalysisData = null; 
                    userTurnCountInSession = 0; userCharCountInSession = 0; 
                    analysisNotificationShown = false; journalSaveNotificationShown = false; // ì•Œë¦¼ í”Œë˜ê·¸ ë¦¬ì…‹
                    assistantMessageCount = 0; verbosityPromptCount = 0;
                    conversationStartTime = Date.now(); 
                    // currentFirestoreSessionId = null; // logSessionStart/End ì‚¬ìš© ì‹œ

                    appendMessage("ê¸´ ì‹œê°„ ëŒ€í™”ê°€ ì—†ì–´ì„œ ì´ë²ˆ ì´ì•¼ê¸°ëŠ” ë§ˆë¬´ë¦¬í•˜ê³  ì €ì¥í–ˆì–´! ì–¸ì œë“  ë‹¤ì‹œ ì´ì•¼ê¸°í•˜ê³  ì‹¶ìœ¼ë©´ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë§ì„ ê±¸ì–´ì¤˜. ğŸ˜Š", "assistant_feedback");
                    if(inputArea) inputArea.style.display = 'none'; 
                    showMainTopics(); 
                } else { 
                    console.log("ì €ì¥í•  ëŒ€í™” ë‚´ìš©ì´ ì—†ê±°ë‚˜ í•„ìˆ˜ ì •ë³´ ë¶€ì¡±. íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹.");
                    resetSessionTimeout(); 
                }
            }, SESSION_TIMEOUT_DURATION);
        }

        // --- â­ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ì €ë„/ë¶„ì„ ì•Œë¦¼ ë¡œì§ ìˆ˜ì •) â­ ---
        async function sendMessage(text, inputMethod = 'text') { 
            if (!selectedMain && inputMethod !== 'topic_selection_init' && text.trim() !== '') {
                appendMessage("ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ë¨¼ì € ì–´ë–¤ ì£¼ì œë¡œ ì´ì•¼ê¸°í• ì§€ ì„ íƒí•´ ì¤„ë˜? ğŸ˜Š", "assistant_feedback");
                showMainTopics(); // ì£¼ì œ ì„ íƒì°½ ë‹¤ì‹œ í‘œì‹œ
                isProcessing = false; if(sendBtn) sendBtn.classList.remove('loading');
                return;
            }
            if (!text || String(text).trim() === '' || isProcessing) return;
            resetSessionTimeout(); 
            isProcessing = true;
            if(sendBtn) sendBtn.classList.add('loading');

            if (!conversationStartTime) conversationStartTime = Date.now();

            if (inputMethod !== 'topic_selection_init') { 
                appendMessage(text, 'user');
                userTurnCountInSession++; 
            }
            chatHistory.push({ role: 'user', content: text }); 
            if (inputMethod !== 'topic_selection_init') {
                 userCharCountInSession += text.length; 
            }

            if (chatInput) chatInput.value = '';
            const thinkingBubble = document.createElement('div'); /* ... */ 
            if (chatWindow) { /* ... */ }
            
            try {
                const elapsedTimeInMinutesForGPT = (Date.now() - conversationStartTime) / (1000 * 60);
                const userDiagnoses = JSON.parse(localStorage.getItem('lozee_diagnoses') || '[]');

                const res = await getGptResponse(text, { chatHistory, verbosity: gptVerbosityPreference, elapsedTime: elapsedTimeInMinutesForGPT, userTraits: userDiagnoses }); 
                if (thinkingBubble) thinkingBubble.remove(); 
                if (!res.ok) {
                    const errorData = await res.text();
                    console.error(`GPT API ì‘ë‹µ ì˜¤ë¥˜ ${res.status}: ${errorData}`);
                    appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. (ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜)", "assistant_feedback");
                    return; // finallyëŠ” ì‹¤í–‰ë¨
                }
                const d = await res.json();
                
                let cleanText = ""; let analysisDataFromGpt = {};
                if (d.text && typeof d.text === 'string') {
                    const jsonStartIndex = d.text.lastIndexOf('{"sentiment":');
                    cleanText = jsonStartIndex !== -1 ? d.text.slice(0, jsonStartIndex).trim() : d.text.trim();
                    const analysisJsonString = jsonStartIndex !== -1 ? d.text.slice(jsonStartIndex) : null;
                    if (analysisJsonString) {
                        try { analysisDataFromGpt = JSON.parse(analysisJsonString); } 
                        catch (e) { console.error("GPT ë¶„ì„ JSON íŒŒì‹± ì˜¤ë¥˜:", e); }
                    }
                }
                lastAiAnalysisData = analysisDataFromGpt; // GPT ë¶„ì„ ê²°ê³¼ ì €ì¥
                    
                appendMessage(cleanText, 'assistant'); 


                chatHistory.push({ role: 'assistant', content: cleanText });
                assistantMessageCount++; 
                    
                // --- AI ì‘ë‹µ ë§í’ì„  í‘œì‹œ ---
                appendMessage(clean, 'assistant');


                // --- â­ ì €ë„ ì €ì¥ ì•Œë¦¼ (800ì ê¸°ì¤€) â­ ---
                if (userCharCountInSession >= 800 && !journalSaveNotificationShown && selectedMain) {
                    // ì´ ì‹œì ì— ì¦‰ì‹œ ì €ì¥í•˜ê³  journalIdë¥¼ ë°›ì•„ì˜¬ ìˆ˜ë„ ìˆì§€ë§Œ,
                    // ì¼ë‹¨ì€ "ì €ì¥ ì¤€ë¹„ ì™„ë£Œ" ì•Œë¦¼ë§Œ ë„ìš°ê³  ì‹¤ì œ ì €ì¥ì€ ì„¸ì…˜ ì¢…ë£Œ ì‹œì—.
                    // ë˜ëŠ”, ì—¬ê¸°ì„œ ë°”ë¡œ ì„ì‹œ ì €ì¥ í›„ IDë¥¼ ë°›ì•„ notificationì— ì—°ê²°í•  ìˆ˜ë„ ìˆìŒ.
                    // í˜„ì¬ëŠ” ì•Œë¦¼ë§Œ ë„ìš°ê³ , ì‹¤ì œ ì €ì¥ì€ íƒ€ì„ì•„ì›ƒ ë¡œì§ì—ì„œ í•¨.
                    const tempJournalDataForNotification = { 
                        ...(lastAiAnalysisData || {}), 
                        sessionDurationMinutes: Math.round((Date.now() - conversationStartTime) / (1000 * 60)),
                        userCharCountForThisSession: userCharCountInSession 
                    };
                    // ì„ì‹œë¡œ ì €ë„ì„ ì €ì¥í•˜ê³  IDë¥¼ ë°›ì•„ì™€ì„œ ì•Œë¦¼ì— ì—°ê²°í•˜ëŠ” ê²ƒì´ ë” ì‚¬ìš©ì ì¹œí™”ì ì¼ ìˆ˜ ìˆìŒ
                    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì•Œë¦¼ë§Œ ë¨¼ì € í‘œì‹œ (ì‹¤ì œ ì €ì¥ì€ íƒ€ì„ì•„ì›ƒ ì‹œ)
                    // ë§Œì•½ ì¦‰ì‹œ ì €ì¥í•˜ê³  IDë¥¼ ë°›ì•„ì˜¤ë ¤ë©´:
                    // const savedJournalId = await saveJournalEntry(currentUserEmail, selectedMain, chatHistory, tempJournalDataForNotification);
                    // if (savedJournalId) showJournalSavedNotification(savedJournalId);
                    
                    // ì§€ê¸ˆì€ "ê³§ ì €ì¥ë ê±°ì•¼" ë¼ëŠ” ëŠë‚Œìœ¼ë¡œ ì•Œë¦¼ë§Œ.
                    const journalNotif = document.createElement('div');
                    journalNotif.className = 'journal-save-notification';
                    journalNotif.textContent = `ğŸ“ ì´ì•¼ê¸°ê°€ ì¶©ë¶„íˆ ìŒ“ì˜€ë„¤! ëŒ€í™”ê°€ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë  ê±°ì•¼.`;
                    if(chatWindow) chatWindow.appendChild(journalNotif);
                    journalSaveNotificationShown = true; // í•œ ì„¸ì…˜ì— í•œ ë²ˆë§Œ
                }


// â”€â”€â”€ â€œë°©ë²•ì„ ì•Œë ¤ì¤„ê¹Œ?â€ ë¬¸êµ¬ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì„ íƒë°•ìŠ¤ ë„ìš°ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (clean.includes("ë°©ë²•ì„ ì•Œë ¤ì¤„ê¹Œ")) {
          // ë‹¤ìŒ Assistant ì‘ë‹µì„ ì €ì¥ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •
          awaitManualSave = false;      // ì•„ì§ â€œë°©ë²•ì„ ì•Œë ¤ì¤˜.â€ ì„ íƒ ì „ì´ë¯€ë¡œ false
          manualSaveConfirmed = false;

          // 2ê°€ì§€ ì„ íƒ ë²„íŠ¼: â€œë°©ë²•ì„ ì•Œë ¤ì¤˜.â€, â€œì•Œë ¤ì£¼ì§€ ì•Šì•„ë„ ë¼.â€
          const optionsForManual = [
            { displayText: "ë°©ë²•ì„ ì•Œë ¤ì¤˜." },
            { displayText: "ì•Œë ¤ì£¼ì§€ ì•Šì•„ë„ ë¼." }
          ];
          displayOptionsInChat(optionsForManual, async (selectedOption) => {
            appendMessage(selectedOption, 'user');
            if (selectedOption === "ë°©ë²•ì„ ì•Œë ¤ì¤˜.") {
              // â€œë°©ë²•ì„ ì•Œë ¤ì¤˜.â€ ì„ íƒ â†’ ë‹¤ìŒ Assistant ì‘ë‹µì„ ì €ì¥ ëŒ€ê¸°
              awaitManualSave = true;
              manualSaveConfirmed = true;
              // AIê°€ ì‹¤ì œë¡œ â€œë°©ë²•â€ì„ ì„¤ëª… ì´ì–´ì„œ ë³´ë‚´ë„ë¡ ë³„ë„ í˜¸ì¶œí•  ìˆ˜ ìˆìŒ
              // ì˜ˆ: sendMessage("ë°©ë²•ì„ ì„¤ëª…í•´ì¤˜.", 'text');
      
              // â”€â”€â”€ â€œawaitManualSave && manualSaveConfirmedâ€ì´ trueì¸ ìƒíƒœì—ì„œ (ë‹¤ìŒë²ˆì— ì˜¤ëŠ”) Assistant ë‹µë³€ì„ ìë™ ì €ì¥ â”€â”€â”€
               if (awaitManualSave && manualSaveConfirmed) {
            try {
                const userId = localStorage.getItem('cbtUserEmail');
                const currentTopic = selectedMain || "ìˆ˜ë™ ì €ì¥"; // selectedMainì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’
                // const contentToSave = clean; // AIì˜ í˜„ì¬ ì‘ë‹µ(clean)ì„ ì €ì¥
                
                // ë§Œì•½ "ë°©ë²•ì„ ì•Œë ¤ì¤˜"ì— ëŒ€í•œ AIì˜ ì´ì „ í„´ ì‘ë‹µì„ ì €ì¥í•˜ê³  ì‹¶ë‹¤ë©´,
                // chatHistoryì—ì„œ í•´ë‹¹ ì‘ë‹µì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” í˜„ì¬ AI ì‘ë‹µ(clean)ì„ ì €ì¥í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
                if (clean) { // ì €ì¥í•  ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ
                    await saveManualJournalEntry(userId, currentTopic, clean); // clean: AIì˜ "ë°©ë²• ì„¤ëª…" ë‚´ìš©
                    appendMessage("âœ… ë¡œì§€ì˜ ì„¤ëª…ì„ ì´ì•¼ê¸°ë¡œ ì˜ ì €ì¥í–ˆì–´!", 'assistant_feedback');
                }
            } catch (err) {
                console.error("ìˆ˜ë™ ì €ì¥ ì˜¤ë¥˜ (sendMessage ë‚´):", err);
                appendMessage("âš ï¸ ì €ì¥ì´ ì˜ ì•ˆ ëœ ê²ƒ ê°™ì•„. ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?", 'assistant_feedback');
            } finally {
                awaitManualSave = false; // í”Œë˜ê·¸ ë¦¬ì…‹
                manualSaveConfirmed = false;
            }
        }

            } else {
              // â€œì•Œë ¤ì£¼ì§€ ì•Šì•„ë„ ë¼.â€ ì„ íƒ â†’ ì €ì¥ í”„ë¡œì„¸ìŠ¤ ì·¨ì†Œ
              awaitManualSave = false;
              manualSaveConfirmed = false;
              appendMessage("ì•Œê² ì–´, ì €ì¥í•˜ì§€ ì•Šì„ê²Œ!", 'assistant');
            }
          });
        }



                // â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìˆ˜ì •ëœ ë¶€ë¶„ â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // skipTTSê°€ falseì¸ ê²½ìš°ì—ëŠ” ì–´ë–¤ ì…ë ¥ ë°©ì‹(text, topic_selection_init, stt)ì´ë“ 
                // ë¬´ì¡°ê±´ TTS ì¬ìƒì„ ì‹œë„í•˜ë„ë¡ ë³€ê²½

                
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìˆ˜ì •ëœ TTS ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 1) ê¸°ì¡´ ì¬ìƒ ì¤‘ì¸ TTSê°€ ìˆë‹¤ë©´ ì¤‘ë‹¨
        if (typeof stopCurrentTTS === 'function') {
            stopCurrentTTS();
        }
        // 2) ì´ í„´ì—ì„œ TTSë¥¼ ì¬ìƒí•˜ë¼ëŠ” í”Œë˜ê·¸ê°€ ì„¸íŠ¸ë˜ì–´ ìˆìœ¼ë©´, playTTSWithControl í˜¸ì¶œ
        //    ë‹¨, ì´ë¯¸ skipTTSê°€ trueë¼ë©´(ì˜ˆ: ë§ˆì´í¬ ëˆ„ë¥¸ ì§í›„ STT ëª¨ë“œë¼ë©´) ì¬ìƒì„ ê±´ë„ˆëœ€
        if (!skipTTS) {
            try {
                isPlayingTTS = true;        // ë‚´ë¶€ì ìœ¼ë¡œ TTS ì¬ìƒ ì¤‘ ìƒíƒœ í‘œì‹œ
                await playTTSWithControl(clean);
            } catch (e) {
                console.error("playTTSWithControl ì˜¤ë¥˜:", e);
            } finally {
                isPlayingTTS = false;
            }
        }
        // 3) í•œ ë²ˆ ì¬ìƒí–ˆê±°ë‚˜ ì¬ìƒì„ ê±´ë„ˆë›´ ë’¤ì—ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ í„´ì„ ìœ„í•´ skipTTS ì´ˆê¸°í™”
        skipTTS = false;
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        chatHistory.push({ role: 'assistant', content: clean });
        assistantMessageCount++;

                
                // ë¶„ì„ ì•Œë¦¼ ë¡œì§ (ìˆ˜ì •ëœ ì¡°ê±´)
                  const currentSessionElapsedTime = (Date.now() - conversationStartTime) / (1000 * 60);
                const finalUserCharCountForAnalysis = previousTotalUserCharCountOverall + userCharCountInSession;
                console.log(`[ë¶„ì„ ì¡°ê±´ ì²´í¬] ì‹œê°„: ${currentSessionElapsedTime.toFixed(1)}ë¶„ (ê¸°ì¤€:10), ì‚¬ìš©ì í„´: ${userTurnCountInSession} (ê¸°ì¤€:20), ì´ ê¸€ììˆ˜: ${finalUserCharCountForAnalysis} (ê¸°ì¤€:1500)`);
                if (currentSessionElapsedTime >= 10 && userTurnCountInSession >= 20 && finalUserCharCountForAnalysis >= 1500 && !analysisNotificationShown) { 
                    console.log(`[ë¶„ì„ ì¡°ê±´ ì¶©ì¡±!] ìƒì„¸ ë¶„ì„ ì‹¤í–‰ ë° localStorage ì €ì¥`);
                    let detailedAnalysisDataForStorage = { ...(lastAiAnalysisData || {}) }; 
                    if (LOZEE_ANALYSIS && typeof LOZEE_ANALYSIS.inferAgeAndLanguage === 'function') { /* ... */ }
                    // ë‹¤ë¥¸ ë¶„ì„ ëª¨ë“ˆ í˜¸ì¶œ
                    if(Object.keys(detailedAnalysisDataForStorage).length > 0) {
                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            startTime: conversationStartTime, 
                            analysisTime: Date.now(),
                            accumulatedDurationMinutes: Math.round(currentSessionElapsedTime), 
                            accumulatedUserCharCount: finalUserCharCountForAnalysis, 
                            results: detailedAnalysisDataForStorage
                        }));

                       showAnalysisNotification(); // â­ ì´ë¦„ ë³€ê²½ëœ í•¨ìˆ˜ í˜¸ì¶œ
                        analysisNotificationShown = true;
                    } else { console.log("ìƒì„±ëœ ë¶„ì„ ë°ì´í„°ê°€ ì—†ì–´ ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨."); }
                } else if (!analysisNotificationShown) { console.log("[ë¶„ì„ ì¡°ê±´ ë¯¸ì¶©ì¡±]"); }

                if (verbosityPromptCount === 0 && assistantMessageCount >= 5) { askForVerbosityPreference(); } 
                else if (verbosityPromptCount === 1 && (Date.now() - lastVerbosityPromptTime > PREFERENCE_PROMPT_INTERVAL)) { askForVerbosityPreference(); }

                 // --- â­ ìˆ˜ë™ ì €ì¥ ë¡œì§ (ì´ì „ ë‹µë³€ ë‚´ìš© ì°¸ê³ í•˜ì—¬ ì¶”ê°€) â­ ---
                if (cleanText.includes("ë°©ë²•ì„ ì•Œë ¤ì¤„ê¹Œ") && typeof displayOptionsInChat === 'function') { // AIê°€ ì œì•ˆ ì‹œ
                    awaitManualSave = true; // ì´ í”Œë˜ê·¸ëŠ” ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ì—ì„œ "ë°©ë²•ì„ ì•Œë ¤ì¤˜"ë¥¼ ì„ íƒí–ˆëŠ”ì§€ íŒë‹¨í•˜ëŠ”ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŒ
                    manualSaveConfirmed = false;
                    const optionsForManual = [ { displayText: "ì‘, ë°©ë²•ì„ ì•Œë ¤ì¤˜! (ì €ì¥í•˜ê¸°)", isManualSave: true }, { displayText: "ê´œì°®ì•„, ì €ì¥ ì•ˆ í• ë˜." } ];
                    displayOptionsInChat(optionsForManual, async (selectedOption) => {
                        appendMessage(selectedOption, 'user');
                        if (selectedOption === "ì‘, ë°©ë²•ì„ ì•Œë ¤ì¤˜! (ì €ì¥í•˜ê¸°)") {
                            manualSaveConfirmed = true; // ì‚¬ìš©ìê°€ ì €ì¥ì„ í™•ì •
                            // AIì—ê²Œ ì‹¤ì œë¡œ ë°©ë²• ì„¤ëª…ì„ ìš”ì²­í•˜ê±°ë‚˜, ë‹¤ìŒ AI ì‘ë‹µì„ ì €ì¥í•˜ë„ë¡ í”Œë˜ê·¸ ì„¤ì •
                            // ì—¬ê¸°ì„œëŠ” ë‹¤ìŒ AIì˜ ì‘ë‹µ(ë°©ë²• ì„¤ëª…)ì„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ê·¸ ë‚´ìš©ì„ ì €ì¥í•´ì•¼ í•¨
                            appendMessage("ì¢‹ì•„! ë¡œì§€ê°€ ë°©ë²•ì„ ì„¤ëª…í•´ì£¼ë©´ ê·¸ ë‚´ìš©ì„ ë”°ë¡œ ì €ì¥í•´ë‘˜ê²Œ.", "assistant_feedback");
                        } else {
                            awaitManualSave = false;
                            manualSaveConfirmed = false;
                            appendMessage("ì•Œê² ì–´, ê·¸ëŸ¼ ì´ì•¼ê¸° ê³„ì†í• ê¹Œ?", 'assistant');
                        }
                    });
                } else if (awaitManualSave && manualSaveConfirmed) { // ì‚¬ìš©ìê°€ "ë°©ë²•ì„ ì•Œë ¤ì¤˜"ë¥¼ ì„ íƒí•œ í›„ AIê°€ ì„¤ëª…ì„ í•œ ê²½ìš°
                    try {
                        if (cleanText && typeof saveManualJournalEntry === 'function') { // AIì˜ ì„¤ëª… ë‚´ìš©(cleanText)ì´ ìˆì„ ë•Œ
                            const savedManualId = await saveManualJournalEntry(currentUserEmail, selectedMain || "ë¡œì§€ ì„¤ëª…", cleanText);
                            if (savedManualId) {
                                appendMessage("âœ… ë¡œì§€ì˜ ì„¤ëª…ì„ ì´ì•¼ê¸°ë¡œ ì˜ ì €ì¥í–ˆì–´!", 'assistant_feedback');
                            }
                        }
                    } catch (err) { console.error("ìˆ˜ë™ ì €ì¥ ì˜¤ë¥˜:", err); appendMessage("âš ï¸ ì €ì¥ ì‹¤íŒ¨.", 'assistant_feedback');}
                    finally { awaitManualSave = false; manualSaveConfirmed = false; } // í”Œë˜ê·¸ ë¦¬ì…‹
                }
                
                              
                
                
                // gpt ìˆ˜ì • ë²„ì ¼ 05-31 ì˜¤í›„ 8ì‹œ 30ë¶„ ìˆ˜ì • 
              } catch (error) {
         if (thinkingBubble) thinkingBubble.remove();
         console.error("sendMessage ë‚´ ì˜¤ë¥˜:", error);
         appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?", "assistant_feedback");
     } finally {
         isProcessing = false;
         if (sendBtn) sendBtn.classList.remove('loading');
     }
 }

        // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
if(sendBtn) sendBtn.addEventListener('click', () => { resetSessionTimeout(); sendMessage(chatInput.value, 'text'); }); 
        else console.error("sendBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if(chatInput) chatInput.addEventListener('keydown', e => { 
            resetSessionTimeout(); 
            if (isPlayingTTS) { if (typeof stopCurrentTTS === 'function') stopCurrentTTS(); skipTTS = true; }
            if (e.key === 'Enter' && !e.isComposing) { e.preventDefault(); sendMessage(chatInput.value, 'text'); }
        });
        else console.error("chatInput ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    </script>
    <script src="./js/gnb.js" defer></script> 
    </body>
</html>