<!DOCTYPE html>
<html lang="ko">
<head>
  <script>
    // ì´ˆê¸° ì„¤ì • í™•ì¸ ë° ë¦¬ë‹¤ì´ë ‰ì…˜ ë¡œì§
    const isConfigured = localStorage.getItem('lozee_username') &&
                         localStorage.getItem('lozee_voice') &&
                         localStorage.getItem('lozee_userage');

    const topicForRedirect = localStorage.getItem('lozee_current_topic');

    if (isConfigured) {
      const targetUrl = topicForRedirect ? `talk.html?topic=${encodeURIComponent(topicForRedirect)}` : 'talk.html';
      window.location.href = targetUrl;
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>
  <style>
    :root {
      --primary-color: #6078ea; 
      --secondary-color: #f0f2f5; 
      --background-color: #FFFFFF; /* ì „ì²´ í˜ì´ì§€ ë°°ê²½ìƒ‰ (í°ìƒ‰) */
      
      --text-color-on-dark-bg: #FFFFFF; 
      --text-color-on-light-bg: #333333; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
      
      --input-background: #FFFFFF; 
      --input-border-color: #D1D5DB; 
      
      --bot-bubble-bg: #E9EBF8; /* AI ë§í’ì„  ë°°ê²½ìƒ‰ (ë¶€ë“œëŸ¬ìš´ ì—°ë³´ë¼/í•˜ëŠ˜ìƒ‰ ê³„ì—´) */
      --bot-bubble-text: #374151; /* AI ë§í’ì„  í…ìŠ¤íŠ¸ ìƒ‰ìƒ (ì–´ë‘ìš´ íšŒìƒ‰) */
      
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #FFFFFF;
      
      --gnb-height: 56px;
      --chat-input-actual-height: 50px;
      --chat-input-padding-vertical: 10px;
      --chat-input-safe-area: env(safe-area-inset-bottom, 20px);
      --chat-input-total-height: calc(var(--chat-input-actual-height) + (2 * var(--chat-input-padding-vertical)) + var(--chat-input-safe-area));
      
      --gnb-title-color: var(--primary-color); 
      --gnb-menu-icon-color: var(--primary-color); 

      --volume-meter-default-bg: var(--primary-color);
      --meter-top-margin: 8px;
      --gnb-dropdown-border-color: #E5E7EB; 
    }
    body {
      margin:0;
      padding-top:var(--gnb-height);
      font-family:'KoPub World Dotum',sans-serif;
      background-color:var(--background-color); 
      color:var(--text-color-on-light-bg); 
      display:flex;
      flex-direction:column;
      height:100vh;
      box-sizing:border-box;
      overflow:hidden;
    }
    #gnb {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:var(--gnb-height);
      background-color:var(--background-color); 
      padding:0 16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.07); 
      z-index:1000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-sizing:border-box;
      border-bottom: 1px solid var(--input-border-color); 
    }
    #gnb-title {
      font-size:1.2em;
      font-weight:bold;
      color:var(--gnb-title-color); 
    }
    #menu-toggle {
      background:none;
      border:none;
      color:var(--gnb-menu-icon-color); 
      font-size:24px;
      cursor:pointer;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #dropdown-menu {
      position:fixed;
      top:var(--gnb-height);
      right:0;
      background-color:var(--background-color); 
      border-radius:0 0 0 8px;
      box-shadow:-2px 2px 5px rgba(0,0,0,0.08);
      width:200px;
      z-index:999;
      overflow:hidden;
      max-height:0;
      transition:max-height 0.3s ease-out;
      border-left: 1px solid var(--input-border-color);
      border-bottom: 1px solid var(--input-border-color);
    }
    #dropdown-menu.show{max-height:500px;}
    #dropdown-menu a {
      display:block;
      color:var(--text-color-on-light-bg); 
      text-decoration:none;
      padding:12px 16px;
      font-size:0.95em;
      border-bottom:1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child{border-bottom:none;}
    #dropdown-menu a:hover{background-color:var(--secondary-color);} 
    #meter-container {
      position:fixed;
      top:calc(var(--gnb-height) + var(--meter-top-margin));
      left:50%;
      transform:translateX(-50%);
      width:60%;
      max-width:300px;
      height:6px;
      background-color:#E5E7EB; 
      border-radius:3px;
      overflow:hidden;
      z-index:998;
    }
    #volume-level {
      width:0%;
      height:100%;
      background:var(--volume-meter-default-bg);
      border-radius:3px;
      transition:width 0.05s linear;
    }
    #chat-container {
      flex-grow:1;
      padding:16px;
      padding-top:calc(var(--meter-top-margin) + 6px + 10px);
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px; 
      margin-bottom: var(--chat-input-total-height); 
    }
    #analysis-container {
      padding:10px;
      background:#f3f4f6; 
      color:#4b5563; 
      font-size:0.85em;
      max-height:150px;
      overflow-y:auto;
      border-top:1px solid #e5e7eb; 
      display:none;
    }
    .bubble {
      padding:10px 15px; 
      border-radius:16px; 
      max-width:80%; 
      line-height:1.6;
      word-break:keep-all;
      box-shadow:0 1px 2px rgba(0,0,0,0.06); 
    }
    .bubble.user {
      background-color:var(--user-bubble-bg);
      color:var(--user-bubble-text);
      align-self:flex-end;
      border-bottom-right-radius:4px;
    }
    .bubble.bot {
      background-color:var(--bot-bubble-bg); 
      color:var(--bot-bubble-text); 
      align-self:flex-start;
      border-bottom-left-radius:4px;
    }
    .bubble.user.interim{opacity:.7;}
    .bubble.system-error, .bubble.ai_feedback { 
      background-color:#FFFBEB; 
      color:#92400E; 
      align-self:center;
      max-width:85%;
      text-align:center;
      font-size:0.9em;
      border:1px solid #FDE68A; 
      margin: 5px 0;
      border-radius: 8px; 
    }
    #chat-input-container {
      position:fixed;
      bottom:0;
      left:0;
      width:100%; 
      background-color:var(--background-color); 
      border-top: 1px solid var(--input-border-color); 
      box-shadow:0 -1px 3px rgba(0,0,0,0.05);
      box-sizing:border-box; 
      padding-top: var(--chat-input-padding-vertical); 
      padding-bottom: calc(var(--chat-input-padding-vertical) + var(--chat-input-safe-area));
    }
    .input-area { 
      display: flex; 
      align-items: center; 
      width: 100%; 
      padding: 0 12px; 
      box-sizing: border-box; 
      gap: 8px; 
      height: var(--chat-input-actual-height); 
    }
    #chat-input {
      flex:1;
      padding:10px 16px;
      border-radius:22px;
      border:1px solid var(--input-border-color); 
      font-size:1em;
      background-color:var(--input-background);
      color:var(--text-color-on-light-bg); 
      height:100%;
      box-sizing:border-box;
    }
    #chat-input::placeholder{color:#9CA3AF;}
    #mic-button, #send-button {
      width:44px;
      height:44px;
      border:none;
      border-radius:50%;
      background-color:var(--primary-color);
      color:var(--user-bubble-text); 
      font-size:1.3em;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background-color 0.2s ease, box-shadow 0.2s ease; 
      flex-shrink: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    #mic-button:hover, #send-button:hover{
        background-color:#4f65d1; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    #mic-button.recording{background-color:#EF4444; box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);}
    #send-button.loading{background:#D1D5DB;cursor:default; box-shadow: none;} 
    
    #chat-container::-webkit-scrollbar{width:6px;} 
    #chat-container::-webkit-scrollbar-track{background:transparent;} 
    #chat-container::-webkit-scrollbar-thumb{background:#D1D5DB;border-radius:3px;} 
    #chat-container::-webkit-scrollbar-thumb:hover{background:#9CA3AF;}
  </style>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (ì¤€ë¹„ì¤‘)</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ìµœê·¼ ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ì£¼ì œë³„ ëŒ€í™” ëª©ë¡</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ì†Œê°œ</a>
    </div>
  </nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-container">
    </div>
  <div id="analysis-container">
    </div>

  <div id="chat-input-container">
    <div class="input-area">
        <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off"/>
        <button id="send-button" title="ë©”ì‹œì§€ ì „ì†¡">â®</button>
    </div>
  </div>

  <!-- 1) Firebase SDK (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>               :contentReference[oaicite:0]{index=0}
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>         :contentReference[oaicite:1]{index=1}

  <!-- 2) ì»¤ìŠ¤í…€ ê¸°ëŠ¥ ëª¨ë“ˆ -->
  <script src="./js/gpt-dialog.js" defer></script>                                                      :contentReference[oaicite:2]{index=2}
  <script src="./js/tts.js" defer></script>                                                             :contentReference[oaicite:3]{index=3}
  <script src="./js/basic-features.js" defer></script>                                                  :contentReference[oaicite:4]{index=4}
  <script src="./js/literacyPatternCheckRenderer.js" defer></script>   

  <script defer>
    
    // Firebase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ ì™„ë£Œ)
    const firebaseConfig = {
      apiKey: "AIzaSyBnuL-CEvcU4NiIyG4yOe6mQjMnh9aArIY",
      authDomain: "lozee-af4d3.firebaseapp.com",
      projectId: "lozee-af4d3",
      storageBucket: "lozee-af4d3.appspot.com",
      messagingSenderId: "838397276113",
      appId: "1:838397276113:web:fc8cb3bdf59ecd52fabaf0",
      measurementId: "G-C23DLE9GZ4"
    };

    let app;
    let db;

    document.addEventListener('DOMContentLoaded', () => {
        try {
        // v8 ì´ˆê¸°í™”
        app = firebase.initializeApp(firebaseConfig);
        db  = firebase.firestore();
        console.log("Firebase initialized successfully (v8).");
      } catch (e) {
        console.error("Firebase initialization error:", e);
        document.getElementById('chat-container').innerHTML =
          `<div class="bubble system-error" style="align-self:center;">
             ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${e.message}
           </div>`;
      }
      checkAndInit();
    });
    </script>
    </head>

    <script>

    function checkAndInit(retries = 20, delay = 300) { // ë”œë ˆì´ ì•½ê°„ ì¦ê°€
        console.log(`checkAndInit ì‹œë„: ${20 - retries + 1}ë²ˆì§¸`);
        const conditions = {
            firebaseApp: typeof firebase !== 'undefined' && typeof firebase.app === 'function' && firebase.app(),
            firebaseDb: typeof db !== 'undefined' && db !== null,
            lozeeDialog: window.LOZEE_DIALOG && typeof window.LOZEE_DIALOG.getGptResponse === 'function',
            lozeeTts: window.LOZEE_TTS && typeof window.LOZEE_TTS.playTTSFromText === 'function',
            lozeeAnalysis: window.LOZEE_ANALYSIS && typeof window.LOZEE_ANALYSIS.trackTime === 'function',
            initializeAppFunc: typeof initializeApp === 'function'
        };

        console.log("Firebase App ë¡œë“œë¨:", conditions.firebaseApp ? 'ì˜ˆ' : 'ì•„ë‹ˆìš”');
        console.log("Firebase DB ì´ˆê¸°í™”ë¨:", conditions.firebaseDb ? 'ì˜ˆ' : 'ì•„ë‹ˆìš”');
        console.log("LOZEE_DIALOG.getGptResponse ë¡œë“œë¨:", conditions.lozeeDialog ? 'ì˜ˆ' : 'ì•„ë‹ˆìš”');
        console.log("LOZEE_TTS.playTTSFromText ë¡œë“œë¨:", conditions.lozeeTts ? 'ì˜ˆ' : 'ì•„ë‹ˆìš”');
        console.log("LOZEE_ANALYSIS.trackTime ë¡œë“œë¨:", conditions.lozeeAnalysis ? 'ì˜ˆ' : 'ì•„ë‹ˆìš”');
        console.log("initializeApp í•¨ìˆ˜ ì •ì˜ë¨:", conditions.initializeAppFunc ? 'ì˜ˆ' : 'ì•„ë‹ˆìš”');

        if (conditions.firebaseApp && conditions.firebaseDb && conditions.lozeeDialog && conditions.lozeeTts && conditions.lozeeAnalysis && conditions.initializeAppFunc) {
            initializeApp();
        } else if (retries > 0) {
            console.log(`í•„ìˆ˜ ê°ì²´/í•¨ìˆ˜ ë¡œë“œ ëŒ€ê¸° ì¤‘... (${retries}íšŒ ë‚¨ìŒ)`);
            setTimeout(() => checkAndInit(retries - 1, delay), delay);
        } else {
            console.error("CRITICAL: í•„ìˆ˜ JavaScript ê°ì²´/í•¨ìˆ˜ ë¡œë“œ ì‹¤íŒ¨. ì•±ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê° ì™¸ë¶€ JS íŒŒì¼ì˜ ë¡œë“œ ìƒíƒœì™€ ë‚´ë¶€ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            let missing = [];
            if (!conditions.firebaseApp || !conditions.firebaseDb) missing.push("Firebase SDK");
            if (!conditions.lozeeDialog) missing.push("gpt-dialog.js ê´€ë ¨ ê¸°ëŠ¥");
            if (!conditions.lozeeTts) missing.push("tts.js ê´€ë ¨ ê¸°ëŠ¥");
            if (!conditions.lozeeAnalysis) missing.push("basic-features.js ê´€ë ¨ ê¸°ëŠ¥");
            if (!conditions.initializeAppFunc) missing.push("initializeApp í•¨ìˆ˜");
            
            const chatContainer = document.getElementById('chat-container');
            const errorMessage = `ì•± ì´ˆê¸°í™” ì‹¤íŒ¨: ë‹¤ìŒ í•„ìˆ˜ ìš”ì†Œ ë¡œë“œ ë¬¸ì œ ë°œìƒ - ${missing.join(', ')}. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            if (chatContainer) {
                 chatContainer.innerHTML = `<div class="bubble system-error" style="align-self:center; max-width: 80%; text-align:center;">${errorMessage}</div>`;
            } else {
                document.body.innerHTML = `<div style="color:red;text-align:center;padding:50px;">ì±„íŒ… UI ë° ì•± ì´ˆê¸°í™” ì‹¤íŒ¨! ${errorMessage}</div>`;
            }
        }
    }
    
    async function initializeApp() {
      console.log("initializeApp í˜¸ì¶œë¨. í•„ìš”í•œ ê°ì²´ë“¤ ë¡œë“œ í™•ì¸ë¨.");
      const chatContainer = document.getElementById('chat-container');
      const analysisContainer = document.getElementById('analysis-container');

      let hasGreeted = false;
      let isRecording = false;
      let mediaRecorder;
      let mediaStream;
      let audioChunks = [];
      let chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');

      const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
      const voiceId = localStorage.getItem('lozee_selectedVoice') || (window.LOZEE_TTS ? window.LOZEE_TTS.DEFAULT_VOICE : 'default-fallback-voice');
      const lastSummary = localStorage.getItem('lozee_lastSummary') || '';
      const topicFromUrl = new URLSearchParams(location.search).get('topic');

      let userNameWithVocative = userName;
      if (window.LOZEE_DIALOG && typeof window.LOZEE_DIALOG.getKoreanVocativeParticle === 'function') {
          const vocativeParticle = window.LOZEE_DIALOG.getKoreanVocativeParticle(userName);
          userNameWithVocative = `${userName}${vocativeParticle}`;
      } else {
          console.warn("getKoreanVocativeParticle í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (talk.html)");
          userNameWithVocative = `${userName}ì•¼`;
      }
      
      window.LOZEE_STATE = window.LOZEE_STATE || {};

      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');
      const menuToggle    = document.getElementById('menu-toggle');
      const dropdownMenu  = document.getElementById('dropdown-menu');

      if (!chatContainer || !chatInput || !sendButton || !micButton || !meterLevel || !menuToggle || !dropdownMenu) {
          console.error("CRITICAL: í•„ìˆ˜ UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTML êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
          if(chatContainer) chatContainer.innerHTML = '<div class="bubble system-error" style="align-self:center;">UI ë¡œë“œ ì˜¤ë¥˜ ë°œìƒ.</div>';
          return;
      }

      async function saveUserProfile() {
        const localUserId = localStorage.getItem('lozee_username'); // ë³€ìˆ˜ ì´ë¦„ ì¶©ëŒ ë°©ì§€
        const diagnosis = localStorage.getItem('lozee_usernote') || ''; 
        const localVoiceId = localStorage.getItem('lozee_voice'); // ë³€ìˆ˜ ì´ë¦„ ì¶©ëŒ ë°©ì§€
        if (!localUserId || !db) {
            console.warn("saveUserProfile: userId ë˜ëŠ” db ê°ì²´ê°€ ì—†ì–´ í”„ë¡œí•„ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        try {
          await db.collection('users').doc(localUserId).set({ 
            name: localUserId, diagnosis, voice: localVoiceId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          console.log("ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥ë¨:", localUserId);
        } catch (error) { console.error("ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error); }
      }
      saveUserProfile();

      async function saveSessionLog(userUtterance, aiResponse, analysisData = null) {
        const localUserId = localStorage.getItem('lozee_username'); // ë³€ìˆ˜ ì´ë¦„ ì¶©ëŒ ë°©ì§€
        if (!localUserId || !db) {
            console.warn("saveSessionLog: userId ë˜ëŠ” db ê°ì²´ê°€ ì—†ì–´ ì„¸ì…˜ ë¡œê·¸ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        try {
          await db.collection('sessions').add({ 
            userId: localUserId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            userText: userUtterance,
            aiReply: aiResponse,
            analysis: analysisData || {} // analysisDataê°€ nullì¼ ê²½ìš° ë¹ˆ ê°ì²´ë¡œ ì €ì¥
          });
          console.log("ì„¸ì…˜ ë¡œê·¸ ì €ì¥ë¨.");
        } catch (error) { console.error("ì„¸ì…˜ ë¡œê·¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error); }
      }

      async function saveJournalEntry(topic, summaryText) {
        const localUserId = localStorage.getItem('lozee_username'); // ë³€ìˆ˜ ì´ë¦„ ì¶©ëŒ ë°©ì§€
        if (!localUserId || !topic || !summaryText || !db) {
            console.warn("saveJournalEntry: userId, topic, summaryText ë˜ëŠ” db ê°ì²´ê°€ ì—†ì–´ ì¼ê¸°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        try {
          await db.collection('journals').add({ 
            userId: localUserId, topic,
            title: summaryText.substring(0, 25) + (summaryText.length > 25 ? "..." : ""),
            summary: summaryText,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            entryType: "ai_reply_snippet"
          });
          console.log("AI ë‹µë³€ ìŠ¤ë‹ˆí« ì¼ê¸° ì €ì¥ë¨.");
        } catch (error) { console.error("AI ë‹µë³€ ìŠ¤ë‹ˆí« ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error); }
      }
      
      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        if (role === 'system-error' || role === 'ai_feedback') {
            el.classList.add(role === 'system-error' ? 'system-error' : 'ai_feedback');
        }
        chatContainer.appendChild(el);
        requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
      }

      let isTTSRunning = false;
      const playTTSFromText_original = window.LOZEE_TTS?.playTTSFromText;
      const lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || (window.LOZEE_TTS ? window.LOZEE_TTS.DEFAULT_VOICE : 'default-fallback-voice');

      async function playTTSWithControl(text, voiceParam) {
        stopCurrentTTS();
        if (!text || !String(text).trim()) {
          console.log("TTS: ì¬ìƒí•  í…ìŠ¤íŠ¸ ì—†ìŒ.");
          isTTSRunning = false; return;
        }
        const effectiveVoice = voiceParam || lsSelectedVoice;
        console.log("ìƒˆë¡œìš´ TTS ì¬ìƒ ì‹œë„:", text, "Voice:", effectiveVoice);
        isTTSRunning = true; setLoading(true);
        try {
          if (typeof playTTSFromText_original === 'function') {
            await playTTSFromText_original(text, effectiveVoice); 
            console.log("TTS ì¬ìƒ ì™„ë£Œ (Promise resolved):", text);
          } else {
            console.warn(`TTS Fallback: ${text}. tts.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” playTTSFromText í•¨ìˆ˜ ë¯¸ì •ì˜.`);
            appendBubble("ì•Œë¦¼: ìŒì„± ì¶œë ¥(TTS) ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "system-error");
          }
        } catch (error) {
          console.error("TTS ì¬ìƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          appendBubble("ìŒì„± ì¶œë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "system-error");
        } finally {
          isTTSRunning = false; setLoading(false);
        }
      }
      
      const getGptResponseFromDialog = window.LOZEE_DIALOG?.getGptResponse;
      const getFirstQuestionFromDialog = window.LOZEE_DIALOG?.getFirstQuestion;
      const trackTimeFromAnalysis = window.LOZEE_ANALYSIS?.trackTime;
      const renderLiteracyAnalysisFromAnalysis = window.LOZEE_ANALYSIS?.renderLiteracyAnalysis;

      menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
      document.addEventListener('click', (event) => {
        const gnb = document.getElementById('gnb');
        if (gnb && !gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
          dropdownMenu.classList.remove('show');
        }
      });

      let audioContext, analyser, microphoneSource, dataArray, volumeMeterAnimationId, analyserStream;
      const LOW_COLOR = { r: 0, g: 180, b: 0 }, MID_COLOR = { r: 255, g: 193, b: 7 }, HIGH_COLOR = { r: 211, g: 47, b: 47 };
      function interpolateColor(c1,c2,f){const r=Math.round(c1.r+f*(c2.r-c1.r)),g=Math.round(c1.g+f*(c2.g-c1.g)),b=Math.round(c1.b+f*(c2.b-c1.b));return `rgb(${r},${g},${b})`}
      function setupAudioAnalysis(stream){try{if(audioContext?.state!=='closed')audioContext?.close().catch(e=>console.warn("AudioContext close ì¤‘ ì˜¤ë¥˜:", e));audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=256;analyser.smoothingTimeConstant=0.3;microphoneSource=audioContext.createMediaStreamSource(stream);microphoneSource.connect(analyser);dataArray=new Uint8Array(analyser.frequencyBinCount);analyserStream=stream;drawVolumeMeter()}catch(e){console.error("ì˜¤ë””ì˜¤ ë¶„ì„ ì„¤ì • ì˜¤ë¥˜:",e);if(meterLevel)meterLevel.style.width='0%';}}
      function drawVolumeMeter(){volumeMeterAnimationId=requestAnimationFrame(drawVolumeMeter);if(!analyser||!dataArray||!meterLevel)return;analyser.getByteFrequencyData(dataArray);let s=0;for(let i=0;i<dataArray.length;i++)s+=dataArray[i];let avgVol=dataArray.length>0?s/dataArray.length:0;let normVol=(avgVol/140)*100;normVol=Math.min(100,Math.max(0,normVol));meterLevel.style.width=normVol+'%';let activeCol;if(normVol<=50)activeCol=interpolateColor(LOW_COLOR,MID_COLOR,normVol/50);else activeCol=interpolateColor(MID_COLOR,HIGH_COLOR,(normVol-50)/50);const baseGradCol=getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim()||'#FFFFFF';meterLevel.style.background=`linear-gradient(to right, ${baseGradCol}, ${activeCol})`}
      function stopAudioAnalysis(){
          if(volumeMeterAnimationId)cancelAnimationFrame(volumeMeterAnimationId);
          volumeMeterAnimationId=null;
          if(microphoneSource)microphoneSource.disconnect();
          microphoneSource=null;
          if(analyserStream?.getTracks)analyserStream.getTracks().forEach(t=>t.stop());
          analyserStream=null;
          if(audioContext && audioContext.state !== 'closed') { 
            audioContext.close().catch(e=>console.warn("AudioContext close ì¤‘ ì˜¤ë¥˜:",e));
          }
          audioContext=null;
          if(meterLevel){meterLevel.style.width='0%';meterLevel.style.background=getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg').trim()}analyser=null;dataArray=null
      }

      let recognition, isRecognizing = false;
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

      function stopCurrentTTS() {
        if (isTTSRunning) {
            console.log("ëª…ì‹œì  TTS ì¤‘ì§€ ì‹œë„ (stopCurrentTTS)");
            if (speechSynthesis && typeof speechSynthesis.cancel === 'function') {
                speechSynthesis.cancel();
                console.log("speechSynthesis.cancel() í˜¸ì¶œë¨.");
            }
            isTTSRunning = false;
            setLoading(false); 
        }
      }

      if (SpeechRec) {
        recognition = new SpeechRec();
        recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'ko-KR';
        micButton.disabled = false;

        recognition.onstart = () => {
          isRecognizing = true;
          stopCurrentTTS(); 
          micButton.textContent = 'ğŸ’¬'; micButton.classList.add('recording');
          console.log("ğŸ¤ STT ì‹œì‘ - TTS ì¤‘ì§€ë¨");
        };
        recognition.onend = () => {
          isRecognizing = false;
          micButton.textContent = 'ğŸ¤'; micButton.classList.remove('recording');
          setLoading(false); 
          stopAudioAnalysis(); 
          console.log("ğŸ¤ STT ì¢…ë£Œ");
        };
        recognition.onresult = (event) => {
          let finalTranscript = '';
          let interimTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcriptPart = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcriptPart;
            } else {
                interimTranscript += transcriptPart;
            }
          }
          
          let interimBubble = document.querySelector('.bubble.user.interim');
          if (interimTranscript) {
            if (!interimBubble) {
                interimBubble = document.createElement('div');
                interimBubble.className = 'bubble user interim';
                chatContainer.appendChild(interimBubble);
            }
            interimBubble.textContent = interimTranscript;
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          
          if (finalTranscript) {
            if (interimBubble) interimBubble.remove(); 
            if (isTTSRunning) { 
                console.log("STT ìµœì¢… ê²°ê³¼ ì²˜ë¦¬ ì „, TTSê°€ ì•„ì§ ì‹¤í–‰ ì¤‘ì´ì–´ì„œ ì¤‘ì§€í•©ë‹ˆë‹¤.");
                stopCurrentTTS();
            }
            handleUserText(finalTranscript); 
          }
        };
        recognition.onerror = (event) => { 
          console.error("âŒ STT ì˜¤ë¥˜:", event.error);
          let errorMsg = "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          if (event.error === 'not-allowed'||event.error === 'service-not-allowed') {
            errorMsg = "ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
          } else if (event.error === 'no-speech') {
            errorMsg = "ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?";
          } else if (event.error === 'network') {
            errorMsg = "ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ìŒì„± ì¸ì‹ì„ í•  ìˆ˜ ì—†ì–´ìš”. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
          }
          appendBubble(errorMsg, "system-error");
          isRecognizing = false;
          micButton.textContent = 'ğŸ¤'; micButton.classList.remove('recording');
          setLoading(false); stopAudioAnalysis();
        };
      } else { 
        console.warn("âš ï¸ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        micButton.title = "ìŒì„± ì¸ì‹ ë¯¸ì§€ì›"; micButton.disabled = true;
        appendBubble("ì•Œë¦¼: ì‚¬ìš© ì¤‘ì¸ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "system-error");
      }

      micButton.onclick = async () => {
        if (!SpeechRec) return;
        if (isTTSRunning) {
          console.log("TTS ì¬ìƒ ì¤‘ì´ë¯€ë¡œ STTë¥¼ ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. TTSë¥¼ ë¨¼ì € ì¤‘ì§€í•©ë‹ˆë‹¤.");
          stopCurrentTTS();
          return; 
        }
        if (isRecognizing) {
          recognition.stop(); 
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupAudioAnalysis(stream); 
            recognition.start(); 
          } catch (err) {
            console.error("âŒ ë§ˆì´í¬ ê¶Œí•œ/ì‹œì‘ ì˜¤ë¥˜:", err); 
            appendBubble("ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "system-error"); 
            stopAudioAnalysis(); 
            setLoading(false);
          }
        }
      };
      
      const userAge = localStorage.getItem('lozee_userage');
      // const userId = localStorage.getItem('lozee_userid') || `user_${Date.now()}`; // Firebase í•¨ìˆ˜ ë‚´ì—ì„œ userIdë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½
      const userDisease = JSON.parse(localStorage.getItem('lozee_userdisease') || '[]');
      
      const params = new URLSearchParams(location.search);
      const incomingTopicId   = params.get('topicId'); 
      const incomingTopicText = params.get('topicText');
      
      let currentSelectedTopic = { 
        id: incomingTopicId, 
        displayText: incomingTopicText || JSON.parse(localStorage.getItem('selectedTopic'))?.displayText || '',
        type: JSON.parse(localStorage.getItem('selectedTopic'))?.type || 'else'
      };

      if (typeof trackTimeFromAnalysis === 'function') trackTimeFromAnalysis();

      if (chatHistory.length === 0 && !hasGreeted) {
        if (typeof getFirstQuestionFromDialog === 'function') { 
            const initialTopicToUse = (currentSelectedTopic.id || currentSelectedTopic.displayText) ? currentSelectedTopic : {displayText: "ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼", type: "else"};
            if (!currentSelectedTopic.displayText && initialTopicToUse.displayText === "ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼") {
                 localStorage.setItem('selectedTopic', JSON.stringify(initialTopicToUse));
            }
            
            const initialPrompt = getFirstQuestionFromDialog(userAge, initialTopicToUse); 
            if (initialPrompt && !initialPrompt.startsWith("ì˜¤ë¥˜:")) {
                appendBubble(initialPrompt, 'ai'); 
                chatHistory.push({ role: 'assistant', content: initialPrompt, timestamp: new Date().toISOString() }); 
                localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
                if(typeof playTTSFromText_original === 'function') await playTTSWithControl(initialPrompt, lsSelectedVoice);
            } else {
                 appendBubble("ì•ˆë…•í•˜ì„¸ìš”! ëŒ€í™”ë¥¼ ì‹œì‘í•˜ëŠ” ë° ë¬¸ì œê°€ ìˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "system-error");
            }
        } else {
            appendBubble("ì•ˆë…•í•˜ì„¸ìš”! ëŒ€í™” ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìˆì–´ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "system-error");
        }
        hasGreeted = true;
      } else if (chatHistory.length > 0) { 
          chatHistory.forEach(msg => appendBubble(msg.content, msg.role === 'assistant' ? 'ai' : msg.role));
          console.log("ì´ì „ ëŒ€í™” ê¸°ë¡ ë³µì› ì™„ë£Œ.");
          hasGreeted = true; 
      }

      function setLoading(flag) {
        sendButton.disabled = flag;
        if (SpeechRec) {
            micButton.disabled = flag || isTTSRunning; 
        } else {
            micButton.disabled = true;
        }
        sendButton.classList.toggle('loading', flag);
      }
      
      async function handleUserText(text) {
        if (!text || !text.trim()) return;
        stopCurrentTTS(); 
        document.querySelector('.bubble.user.interim')?.remove();
        appendBubble(text, 'user');
        
        const historyForGpt = chatHistory.slice(); 
        chatHistory.push({ role: 'user', content: text, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        
        setLoading(true);
        let res;
        try {
          const contextForGpt = {
            // userId, // userIdëŠ” getGptResponse ë‚´ë¶€ì—ì„œ localStorage.getItem('lozee_userid') ë“±ìœ¼ë¡œ ê°€ì ¸ì˜¤ê±°ë‚˜,
                     // ë˜ëŠ” ì—¬ê¸°ì„œ ëª…ì‹œì ìœ¼ë¡œ localStorage.getItem('lozee_username')ì„ ì‚¬ìš©
            userAge, 
            userName, // initializeApp ìŠ¤ì½”í”„ì˜ userName ì‚¬ìš©
            userDisease,
            chatHistory: historyForGpt.slice(-10), 
            selectedTopic: currentSelectedTopic,
            currentStage: localStorage.getItem('currentStage') || 'Stage 1'
          };

          if (typeof getGptResponseFromDialog !== 'function') {
            console.error("CRITICAL: getGptResponse í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            appendBubble("ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "system-error");
            setLoading(false);
            return;
          }
          res = await getGptResponseFromDialog(text, contextForGpt); 

          if (!res.ok) {
            console.error(`API Error: ${res.status} ${res.statusText}.`);
            let errorData;
            try {
                errorData = await res.json(); 
                console.error("API Error Body (JSON Parsed):", errorData);
            } catch (e) {
                const rawErrorText = await res.text().catch(() => "ì˜¤ë¥˜ ì‘ë‹µ ë³¸ë¬¸ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                console.error("Raw API Error Text:", rawErrorText);
                errorData = { text: rawErrorText.substring(0,150) || `API ìš”ì²­ ì‹¤íŒ¨ (${res.status})`};
            }
            appendBubble(errorData.text || `API ìš”ì²­ ì‹¤íŒ¨: ${res.status}`, 'system-error');
            chatHistory.push({ role: 'system', content: `API ì˜¤ë¥˜: ${res.status}`, error: errorData, timestamp: new Date().toISOString() });
            setLoading(false); return;
          }

          const data = await res.json();
          console.log("GPT API ì‘ë‹µ:", data);
          const botMessage = data?.text || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”.";
          appendBubble(botMessage, 'ai'); 
          
          const botResponseEntry = { role: 'assistant', content: botMessage, timestamp: new Date().toISOString() }; 
          if (data.analysis && Object.keys(data.analysis).length > 0) {
            console.log("ğŸ’¡ ìˆ˜ì‹ ëœ ë¶„ì„ ë°ì´í„°:", data.analysis);
            botResponseEntry.analysis = data.analysis;
            if (typeof renderLiteracyAnalysisFromAnalysis === 'function' && analysisContainer && data.analysis.literacy_markers) { 
               renderLiteracyAnalysisFromAnalysis(data.analysis.literacy_markers, 'analysis-container');
               if(analysisContainer) analysisContainer.style.display = 'block';
            } else if (analysisContainer) {
                analysisContainer.innerHTML = ''; analysisContainer.style.display = 'none';
            }
            await saveSessionLog(text, botMessage, data.analysis);
          } else {
             if (analysisContainer) { analysisContainer.innerHTML = ''; analysisContainer.style.display = 'none'; }
             console.log("ë¶„ì„ ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ìˆ˜ì‹ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
             await saveSessionLog(text, botMessage, {}); 
          }
          chatHistory.push(botResponseEntry);
          localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
          
          let isSummarizationConfirmed = false;
          if (window.LOZEE_STATE && window.LOZEE_STATE.awaitingSummaryConfirmation) {
            if (text.includes("1") || text.toLowerCase().includes("ì‘") || text.includes("ì •ë¦¬") || text.includes("ìš”ì•½") || text.toLowerCase().includes("ê·¸ë˜") || text.toLowerCase().includes("ì˜ˆ")) {
                isSummarizationConfirmed = true;
            }
            window.LOZEE_STATE.awaitingSummaryConfirmation = false;
          }

          if (isSummarizationConfirmed) { 
            appendBubble("ì•Œê² ì–´, ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¥¼ ì •ë¦¬í•´ë³¼ê²Œ! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜ ğŸ˜Š", 'ai_feedback');
            await playTTSWithControl("ì•Œê² ì–´, ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¥¼ ì •ë¦¬í•´ë³¼ê²Œ! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜", lsSelectedVoice);

            const summaryContext = {
                ...contextForGpt,
                chatHistory: historyForGpt.slice(-10) 
            };
            const summaryResponse = await getGptResponseFromDialog("SYSTEM_COMMAND_SUMMARIZE_HISTORY", summaryContext);
            
            if (!summaryResponse.ok) throw new Error(`ìš”ì•½ API ì˜¤ë¥˜: ${summaryResponse.status}`);
            const summaryData = await summaryResponse.json();

            const summaryText = summaryData.text;
            const summaryAnalysis = summaryData.analysis; 

            appendBubble(summaryText, 'ai');
            await playTTSWithControl(summaryText, lsSelectedVoice);
            await saveSessionLog(`ëŒ€í™” ìš”ì•½ ìš”ì²­ (ì‚¬ìš©ì ì‘ë‹µ: ${text})`, summaryText, summaryAnalysis); 
            
            // if (typeof saveConversationSummaryAsJournal === 'function') { 
            //    // saveConversationSummaryAsJournal í•¨ìˆ˜ëŠ” í˜„ì¬ talk.htmlì— ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.
            //    // journal.htmlì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë³„ë„ ëª¨ë“ˆí™” ë˜ëŠ” ì—¬ê¸°ì— êµ¬í˜„ í•„ìš”.
            //    // await saveConversationSummaryAsJournal(summaryText, summaryAnalysis, contextForGpt);
            //    console.log("saveConversationSummaryAsJournal í˜¸ì¶œ (í˜„ì¬ talk.htmlì— ë¯¸êµ¬í˜„)");
            // }

            const saveConfirmMsg = `${userNameWithVocative}, ë°©ê¸ˆ ì •ë¦¬í•œ ë‚´ìš©ì€ ì¼ê¸°ì—ë„ ì˜ ë‚¨ê²¨ë’€ì–´! (ì €ì¥ ê¸°ëŠ¥ì€ journal.htmlì— ìˆì–´ìš”) âœ¨`;
            appendBubble(saveConfirmMsg, 'ai');

            await playTTSWithControl(saveConfirmMsg, lsSelectedVoice);
            chatHistory.push({ role: 'assistant', content: summaryText, analysis: summaryAnalysis, timestamp: new Date().toISOString() });
            chatHistory.push({ role: 'assistant', content: saveConfirmMsg, timestamp: new Date().toISOString() });
            localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));

          } else { 
            if(typeof playTTSFromText_original === 'function') {
               await playTTSWithControl(botMessage, lsSelectedVoice);
            }
            if (botMessage.includes("ì •ë¦¬í•´ë³¼ê¹Œ?") && (botMessage.includes("1.") || botMessage.includes("ì²« ë²ˆì§¸")) && (botMessage.includes("2.") || botMessage.includes("ë‘ ë²ˆì§¸"))) {
                window.LOZEE_STATE.awaitingSummaryConfirmation = true;
            }
          }

        } catch (err) {
          console.error("âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì „ì²´ ì˜¤ë¥˜:", err);
          if(res) console.error("ì˜¤ë¥˜ ì‹œì  API ì‘ë‹µ ê°ì²´ (res):", {status: res.status, ok: res.ok});
          const errorDisplayMsg = "ì£„ì†¡í•´ìš”, ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
          appendBubble(errorDisplayMsg, 'system-error');
          chatHistory.push({ role: 'system', content: 'í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜', error: err.message, timestamp: new Date().toISOString() });
        }
        setLoading(false); 
        if(chatInput) {
            chatInput.value = ''; 
        }
      }

      sendButton.onclick = () => { if(chatInput) handleUserText(chatInput.value); };
      chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserText(chatInput.value); } };
      
      if (!hasGreeted && chatHistory.length === 0) { 
          await initGreeting();
          hasGreeted = true;
      } else if (chatHistory.length > 0) { 
          chatHistory.forEach(msg => appendBubble(msg.content, msg.role === 'assistant' ? 'ai' : msg.role));
          console.log("ì´ì „ ëŒ€í™” ê¸°ë¡ ë³µì› ì™„ë£Œ.");
          hasGreeted = true; 
      }

    } // initializeApp í•¨ìˆ˜ì˜ ë
  </script>
</body>
</html>
