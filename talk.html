<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* GNB ìŠ¤íƒ€ì¼ (ìƒë‹¨ ê³ ì •) */
    #gnb { position: fixed; top: 0; left: 0; width: 100%; background: #354157; padding: 8px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; display: flex; gap: 12px; }
    #gnb a { color: #fff; text-decoration: none; font-size: 0.95em; }
    body { margin: 0; padding-top: 40px; font-family: 'KoPub World Dotum', sans-serif; background: #2a3340; color: #fff; }
    #chat-container { padding: 16px; height: calc(100vh - 140px); overflow-y: auto; }
    .bubble { margin: 8px 0; padding: 12px 16px; border-radius: 20px; max-width: 70%; }
    .bubble.user { background: #6e8efb; align-self: flex-end; color: #fff; }
    .bubble.bot  { background: #f0f0f0; align-self: flex-start; color: #333; }
    #chat-input-container { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; gap: 8px; padding: 8px; background: #354157; }
    #chat-input { flex: 1; padding: 12px; border-radius: 20px; border: none; }
    #send-button, #mic-button { width: 48px; height: 48px; border: none; border-radius: 50%; background: #6e8efb; color: #fff; font-size: 1.2em; cursor: pointer; }
    #mic-button.disabled { opacity: 0.5; cursor: default; }
    #meter-container { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); width: 60%; height: 4px; background: #4a5568; border-radius: 2px; overflow: hidden; }
    #volume-meter { width: 100%; height: 100%; }
    #volume-level { width: 0%; height: 100%; background: #6e8efb; }
  </style>
</head>
<body>
  <nav id="gnb">
    <a href="index.html">í™ˆ</a>
    <a href="#" id="gnb-topic-change">ì£¼ì œ ë³€ê²½</a>
    <a href="analysis.html">ë¶„ì„ ê²°ê³¼</a>
    <a href="settings.html">ì„¤ì •</a>
  </nav>

  <div id="meter-container"><div id="volume-meter"><div id="volume-level"></div></div></div>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€" class="disabled">ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥ ë˜ëŠ” ğŸ¤" autocomplete="off" />
    <button id="send-button">â®</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse, getFirstQuestion }    from './js/gpt-dialog.js';
    import { trackTime, trackEmotionTone, trackSituation } from './js/basic-features.js';

    document.addEventListener('DOMContentLoaded', () => {
      // ìš”ì†Œ ì°¸ì¡°
      const chatContainer = document.getElementById('chat-container');
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meter = document.getElementById('volume-level');

      const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge       = localStorage.getItem('lozee_userage');
      const userName      = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');

      // GNB ì£¼ì œ ë³€ê²½
      document.getElementById('gnb-topic-change').onclick = e => {
        e.preventDefault();
        window.location.href = 'index.html';
      };

      // ë©”ì‹œì§€ ì¶”ê°€
      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showAiLoading(flag) {
        sendButton.disabled = flag;
        chatInput.disabled  = flag;
        if (flag) micButton.classList.add('disabled');
      }

      // ì´ˆê¸° ëŒ€í™” ë° BASIC ê¸°ëŠ¥
      async function initConversation() {
        console.log('â–¶ï¸ selectedTopic:', selectedTopic);
        const prompt = getFirstQuestion(userAge, selectedTopic);
        appendBubble(prompt, 'bot');
        await playTTSFromText(prompt, selectedVoice);
        trackTime(); trackEmotionTone(); trackSituation();
      }

      // ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
      async function handleUserText(text) {
        if (!text.trim()) return;
        appendBubble(text, 'user'); showAiLoading(true);
        const botBubble = document.createElement('div'); botBubble.className = 'bubble bot';
        chatContainer.appendChild(botBubble);

        try {
          const res = await getGptResponse(text, { userAge, userName, selectedTopic });
          const reader = res.body.getReader(); const dec = new TextDecoder(); let done = false;
          while (!done) {
            const { value, done: d } = await reader.read(); done = d;
            botBubble.textContent += dec.decode(value, { stream: true });
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          await playTTSFromText(botBubble.textContent, selectedVoice);
        } catch (err) {
          console.error(err);
          appendBubble('ì£„ì†¡í•©ë‹ˆë‹¤, ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
        } finally { showAiLoading(false); }
      }

      // ì´ë²¤íŠ¸
      sendButton.onclick = () => {
        const txt = chatInput.value.trim();
        if (!txt) return;
        chatInput.value = '';
        handleUserText(txt);
      };
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); }
      });

      // STT + VAD ì„¤ì •
      if (navigator.mediaDevices && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            const API = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new API(); rec.lang = 'ko-KR'; rec.interimResults = false;
            rec.onstart  = () => micButton.textContent='ğŸ”´';
            rec.onend    = () => micButton.textContent='ğŸ¤';
            rec.onresult = e => handleUserText(e.results[0][0].transcript);
            micButton.classList.remove('disabled');
            micButton.onclick = () => rec.recognizing ? rec.stop() : rec.start();
          })
          .catch(_=> appendBubble('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'bot'));
      }

      // ì‹œì‘
      initConversation();
    });
  </script>
</body>
</html>
