<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOZEE와 대화하기</title>
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header id="main-header">LOZEE와 대화하기</header>
    <div id="meter-container"><div id="volume-meter"><div id="volume-level"></div></div></div>
    <div id="chat-container">
        <!-- 스피너는 기본 숨김 -->
        <div class="loading-spinner" id="aiLoadingSpinner" style="display:none;"></div> 
    </div>
    <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="메시지를 입력하거나 마이크 버튼을 누르세요...">
        <button id="send-button">전송</button>
    </div>

    <script type="module">
        import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
        import { getGptResponse, getFirstQuestion } from './js/gpt-dialog.js';

        const chatContainer     = document.getElementById('chat-container');
        const meterLevel        = document.getElementById('volume-level');
        const aiLoadingSpinner  = document.getElementById('aiLoadingSpinner');
        const chatInput         = document.getElementById('chat-input');
        const sendButton        = document.getElementById('send-button');

        const selectedVoice     = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
        const userAge           = localStorage.getItem('lozee_userage');
        const userName          = localStorage.getItem('lozee_username') || '친구';
        const userDiseaseRaw    = localStorage.getItem('lozee_userdisease') || '[]';
        const selectedTopicRaw  = localStorage.getItem('selectedTopic') || '{}';
        const isCbtUser         = localStorage.getItem('isCbtUser') === 'true';

        let chatHistory = [];
        let userDisease;
        try { userDisease = JSON.parse(userDiseaseRaw); if(!Array.isArray(userDisease)) userDisease = [userDiseaseRaw]; }
        catch { userDisease = [userDiseaseRaw]; }
        let selectedTopic;
        try { selectedTopic = JSON.parse(selectedTopicRaw); }
        catch { selectedTopic = { displayText:'알 수 없는 주제', tags:['오류'], icon:'❓' }; }

        function appendMessage(text, role) {
            const el = document.createElement('div');
            el.className = `${role}-bubble bubble`;
            el.textContent = text;
            chatContainer.insertBefore(el, aiLoadingSpinner);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            chatHistory.push({role,content:text});
        }

        function showAiLoading(show) {
            aiLoadingSpinner.style.display = show ? 'block' : 'none';
            sendButton.disabled = show;
            chatInput.disabled  = show;
        }

        async function initConversation() {
            showAiLoading(false); // 초기 로딩 스피너 숨김
            const firstQ = getFirstQuestion(userAge);
            appendMessage(firstQ, 'ai');
            await playTTSFromText(firstQ, selectedVoice);
        }

        async function handleUserText(text) {
            if(!text.trim()) return;
            showAiLoading(true);
            try {
                const context = { userAge, userName, userDisease, selectedTopic, isCbtUser, chatHistory: chatHistory.slice(-10) };
                const aiRes = await getGptResponse(text, context);
                const reply = typeof aiRes==='string'? aiRes : aiRes.rephrasing || aiRes.text || '죄송해요, 답변이 없습니다.';
                appendMessage(reply, 'ai');
                await playTTSFromText(reply, selectedVoice);
            } catch(err) {
                console.error(err);
                appendMessage('죄송해요, 오류가 발생했어요.', 'ai');
                await playTTSFromText('죄송해요, 오류가 발생했어요.', selectedVoice);
            } finally { showAiLoading(false); }
        }

        // 텍스트 전송
        sendButton.onclick = () => {
            const txt = chatInput.value.trim();
            if(!txt) return;
            appendMessage(txt, 'user');
            chatInput.value = '';
            handleUserText(txt);
        };
        chatInput.addEventListener('keydown', e=>{
            if(e.key==='Enter' && !sendButton.disabled) sendButton.click();
        });

        // STT 설정 (Web Speech API)
        if(window.SpeechRecognition || window.webkitSpeechRecognition) {
            const Recognition = window.SpeechRecognition||window.webkitSpeechRecognition;
            const recog = new Recognition(); recog.lang='ko-KR'; recog.continuous=false; recog.interimResults=false;
            recog.onresult = e => { const txt=e.results[0][0].transcript; appendMessage(txt,'user'); handleUserText(txt); };
            recog.onerror  = e=> console.warn('STT error',e.error);
            // 마이크 버튼 기능 추가 가능
        }

        document.addEventListener('DOMContentLoaded', initConversation);
    </script>
</body>
</html>
