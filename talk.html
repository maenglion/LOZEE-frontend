<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    :root {
  --primary-color: #6e8efb;
  --secondary-color: #354157;
  --background-color: #2a3340;
  --text-color: #fff;
  --input-background: #f0f0f0;
  --bot-bubble-bg: #f0f0f0;
  --bot-bubble-text: #333;
  --user-bubble-bg: #6e8efb; /* ì‚¬ìš©ì ë§í’ì„ ì€ ì›ë˜ ì´ ìƒ‰ì´ì—ˆìŠµë‹ˆë‹¤ */
  --user-bubble-text: #fff;   /* ì‚¬ìš©ì ë§í’ì„  ê¸€ì”¨ë„ í°ìƒ‰ */
  --gnb-height: 56px;
  --chat-input-height: 70px;
  --gemini-purple: #7B68EE; /* GNB ì œëª© ë° ë©”ë‰´ í† ê¸€ ì›ë˜ ìƒ‰ìƒ */
  --volume-meter-default-bg: var(--primary-color);
  --meter-top-margin: 8px;
  --gnb-dropdown-border-color: #4a5568;
}

body {
  margin: 0;
  padding-top: var(--gnb-height);
  font-family: 'KoPub World Dotum', sans-serif;
  /* ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ ì ìš© */
  background: linear-gradient(135deg, var(--background-color-gradient-start), var(--background-color-gradient-end));
  color: var(--text-color); /* ì£¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ, í°ìƒ‰ ìœ ì§€ ë˜ëŠ” ì–´ë‘ìš´ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
  display: flex;
  flex-direction: column;
  height: 100vh;
  box-sizing: border-box;
  overflow: hidden;
}

/* GNB ë° ì±„íŒ… ì…ë ¥ì°½ ë°°ê²½ì€ ê·¸ë¼ë°ì´ì…˜ê³¼ ì–´ìš¸ë¦¬ë„ë¡ ë°˜íˆ¬ëª… í°ìƒ‰ ë˜ëŠ” ë‹¨ìƒ‰ìœ¼ë¡œ ì¡°ì • ê°€ëŠ¥ */
#gnb {
  /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
  background-color: rgba(255, 255, 255, 0.15); /* ì˜ˆì‹œ: ì•½ê°„ íˆ¬ëª…í•œ í°ìƒ‰ ë°°ê²½ */
  backdrop-filter: blur(10px); /* (ì„ íƒì‚¬í•­) ë¸”ëŸ¬ íš¨ê³¼ë¡œ ê³ ê¸‰ìŠ¤ëŸ¬ì›€ ì¶”ê°€ */
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* ê·¸ë¦¼ì ì•½ê°„ ì—°í•˜ê²Œ */
}
#gnb-title {
  color: #ffffff; /* GNB ë°°ê²½ì´ ë°ì•„ì§€ë©´ ì œëª© ìƒ‰ìƒ ë³€ê²½ ê°€ëŠ¥ */
}
#menu-toggle {
    color: #ffffff; /* GNB ë°°ê²½ì´ ë°ì•„ì§€ë©´ ë©”ë‰´ í† ê¸€ ìƒ‰ìƒ ë³€ê²½ ê°€ëŠ¥ */
}

#chat-input-container {
  /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
  background-color: rgba(255, 255, 255, 0.2); /* ì˜ˆì‹œ: ì•½ê°„ íˆ¬ëª…í•œ í°ìƒ‰ ë°°ê²½ */
  backdrop-filter: blur(5px);
}

#chat-input {
  /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
  background-color: var(--input-background); /* ì´ë¯¸ í°ìƒ‰ ê³„ì—´ */
  color: #333; /* ì…ë ¥ ê¸€ì”¨ëŠ” ì–´ë‘¡ê²Œ */
  border: 1px solid #d0d0d0; /* í…Œë‘ë¦¬ ì•½ê°„ ì—°í•˜ê²Œ */
}

/* ë“œë¡­ë‹¤ìš´ ë©”ë‰´, ìŒëŸ‰ ë°” ë“±ë„ í•„ìš”ì‹œ ìƒ‰ìƒ ì¡°ì • */
#dropdown-menu {
    background-color: rgba(40, 50, 65, 0.9); /* ì•½ê°„ ì–´ë‘ìš´ ë°˜íˆ¬ëª… ë°°ê²½ ìœ ì§€ */
    backdrop-filter: blur(5px);
}
#dropdown-menu a {
    border-bottom: 1px solid var(--gnb-dropdown-border-color);
}
#dropdown-menu a:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

/* ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë©”ì‹œì§€ ë²„ë¸” ë°°ê²½ìƒ‰ ë³€ê²½ */
.bubble.system-error {
    background-color: #ffe0e0; /* ì—°í•œ í•‘í¬/ë¹¨ê°• */
    color: #c0392b; /* ì–´ë‘ìš´ ë¹¨ê°• ê¸€ì”¨ */
    border: 1px solid #e74c3c;
}

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* GNB (í–„ë²„ê±° ë©”ë‰´) */
    #gnb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--background-color);
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gemini-purple);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gemini-purple);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--background-color);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.25);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 500px;
    }

    #dropdown-menu a {
      display: block;
      color: var(--text-color);
      text-decoration: none;
      padding: 12px 16px;
      font-size: 0.95em;
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child { border-bottom: none; }
    #dropdown-menu a:hover {
      background-color: var(--secondary-color);
    }

    /* ìŒëŸ‰ ë°” */
    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: 6px;
      background-color: var(--secondary-color);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-meter { width:100%; height:100%; }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-default-bg);
      border-radius: 3px;
      transition: width 0.05s linear;
    }

    /* ì±„íŒ… ì˜ì—­ */
    #chat-container {
      flex-grow: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + 6px + 16px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: var(--chat-input-height);
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.5;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background-color: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.bot {
      background-color: var(--bot-bubble-bg);
      color: var(--bot-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.user.interim { opacity:.7; }
    .bubble.system-error { /* ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        background-color: #ffdddd;
        color: #d32f2f;
        align-self: center;
        max-width: 80%;
        text-align: center;
        font-size: 0.9em;
        border: 1px solid #d32f2f;
    }


    /* ì…ë ¥ ì˜ì—­ */
    #chat-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-height);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background-color: var(--secondary-color);
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 22px;
      border: 1px solid var(--gnb-dropdown-border-color);
      font-size: 1em;
      background-color: var(--input-background);
      color: #333;
      height: 44px;
      box-sizing: border-box;
    }
    #chat-input::placeholder { color: #777; }

    #mic-button,
    #send-button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: var(--text-color);
      font-size: 1.3em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover,
    #send-button:hover { background-color: #5a7edf; }
    #mic-button.disabled,
    #send-button.disabled {
      opacity:.5;
      cursor:default;
      background-color: #999;
    }
    #send-button.loading { background:#999; cursor:default; }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-container::-webkit-scrollbar-thumb { background: var(--gnb-dropdown-border-color); border-radius: 4px; }
    #chat-container::-webkit-scrollbar-thumb:hover { background: #5a7edf; }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (ì¤€ë¹„ì¤‘)</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ìµœê·¼ ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ì£¼ì œë³„ ëŒ€í™” ëª©ë¡</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ì†Œê°œ</a>
    </div>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>

  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off"/>
    <button id="send-button" title="ë©”ì‹œì§€ ì „ì†¡">â®</button>
  </div>

  <script src="./js/gpt-dialog.js"></script>
  <script src="./js/tts.js"></script>

<script>
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ë­í‚¹ ê¸°ëŠ¥ ë° ê¸°íƒ€ í•„ìš”í•œ ë³€ìˆ˜ë“¤)
    let isInRankingMode = false;
    let rankingType = null; // 'likes' ë˜ëŠ” 'dislikes'
    let itemsToRank = [];
    let comparisonPairs = [];
    let currentPairIndex = 0;
    let comparisonScores = {}; // { "ì•„ì´í…œëª…": ì ìˆ˜ }
    const MAX_ITEMS_TO_RANK = 5; // ìˆœìœ„ ë§¤ê¸¸ ìµœëŒ€ ì•„ì´í…œ ìˆ˜

    let chatContainer; // ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½
    let chatInput;
    let sendButton;
    let micButton;
    let meterLevel;
    let menuToggle;
    let dropdownMenu;
    let gnb;

    let playTTSFunction;
    let currentDefaultVoice;
    let lsSelectedVoice; // lsSelectedVoiceë„ ì—¬ê¸°ì„œ ì„ ì–¸

    // ì‚¬ìš©ì ì •ë³´ (initializeAppì—ì„œ ë¡œë“œ)
    let userAge;
    let userName;
    let userId;
    let userDisease; // JSON íŒŒì‹±ëœ ë°°ì—´ í˜•íƒœë¡œ ì €ì¥ ì˜ˆì •
    let selectedTopic;
    let chatHistory = [];


    // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ë° ì´ˆê¸°í™” ---
    function initializeDOMElements() {
        chatContainer = document.getElementById('chat-container');
        chatInput     = document.getElementById('chat-input');
        sendButton    = document.getElementById('send-button');
        micButton     = document.getElementById('mic-button');
        meterLevel    = document.getElementById('volume-level');
        menuToggle    = document.getElementById('menu-toggle');
        dropdownMenu  = document.getElementById('dropdown-menu');
        gnb           = document.getElementById('gnb');
    }

    // --- ë§í’ì„  ë° UI ê´€ë ¨ í•¨ìˆ˜ ---
    function appendBubble(textOrContent, role, choices = null) {
        if (!chatContainer) {
            console.error("CRITICAL: chatContainer element not found in the DOM. appendBubble cannot function.");
            return;
        }
        const bubbleEl = document.createElement('div');
        bubbleEl.className = `bubble ${role}`;

        if (typeof textOrContent === 'string') {
            const p = document.createElement('p');
            p.textContent = textOrContent;
            bubbleEl.appendChild(p);
        } else if (textOrContent instanceof HTMLElement) {
            bubbleEl.appendChild(textOrContent);
        }

        if (role === 'system-error') {
            bubbleEl.classList.add('system-error');
        }

        if (choices && Array.isArray(choices)) {
            const choicesContainer = document.createElement('div');
            choicesContainer.className = 'choices-container'; // CSS ìŠ¤íƒ€ì¼ í•„ìš” (ì•„ë˜ ì˜ˆì‹œ CSS ì°¸ê³ )
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button'; // CSS ìŠ¤íƒ€ì¼ í•„ìš”
                button.textContent = choice.text;
                button.onclick = () => {
                    choicesContainer.querySelectorAll('.choice-button').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = "0.7"; // ì‹œê°ì  í”¼ë“œë°±
                    });
                    choice.action(choice.value); // ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
                };
                choicesContainer.appendChild(button);
            });
            bubbleEl.appendChild(choicesContainer);
        }
        chatContainer.appendChild(bubbleEl);
        requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
    }

    function showInterim(text) {
        if (!chatContainer) return;
        let el = document.querySelector('.bubble.user.interim');
        if (!el) { el = document.createElement('div'); el.className = 'bubble user interim'; chatContainer.appendChild(el); }
        el.textContent = text; requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
    }

    function setLoading(flag) {
        if (sendButton) sendButton.disabled = flag;
        if (micButton) { // SpeechRecognition ì§€ì› ì—¬ë¶€ì™€ ë³„ê°œë¡œ micButton ì¡´ì¬ ì—¬ë¶€ í™•ì¸
             if (SpeechRecognition) micButton.disabled = flag && !isRecognizing;
             else micButton.disabled = true; // SpeechRecognition ë¯¸ì§€ì›ì´ë©´ í•­ìƒ ë¹„í™œì„±í™”
        }
        if (sendButton) sendButton.classList.toggle('loading', flag);
    }

    // --- TTS ë° STT ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜ ---
    let audioContext;
    let analyser;
    let microphoneSource;
    let dataArray;
    let volumeMeterAnimationId;
    let analyserStream;
    let recognition;
    let isRecognizing = false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    // (setupAudioAnalysis, drawVolumeMeter, stopAudioAnalysis í•¨ìˆ˜ëŠ” ê¸°ì¡´ ì½”ë“œ ìœ ì§€ - ìƒëµ)
    // ... ê¸°ì¡´ setupAudioAnalysis, drawVolumeMeter, stopAudioAnalysis í•¨ìˆ˜ë“¤ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ...
    // (ì œê³µí•´ì£¼ì‹  ì½”ë“œì—ëŠ” ì´ í•¨ìˆ˜ë“¤ì´ ì´ë¯¸ ì˜ ì •ì˜ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤)
      function interpolateColor(color1, color2, factor) { /* ... ê¸°ì¡´ ì½”ë“œ ... */ }
      function setupAudioAnalysis(stream) { /* ... ê¸°ì¡´ ì½”ë“œ ... */ }
      function drawVolumeMeter() { /* ... ê¸°ì¡´ ì½”ë“œ ... */ }
      function stopAudioAnalysis() { /* ... ê¸°ì¡´ ì½”ë“œ ... */ }


    // --- ì„ í˜¸ë„ ìˆœìœ„ ë§¤ê¸°ê¸° ê´€ë ¨ í•¨ìˆ˜ ---
    function startRankingProcess(type) {
        isInRankingMode = true;
        rankingType = type;
        itemsToRank = [];
        comparisonPairs = [];
        currentPairIndex = 0;
        comparisonScores = {};

        const promptText = `ë„¤ê°€ íŠ¹ë³„íˆ ${type === 'likes' ? 'ì¢‹ì•„í•˜ëŠ”' : 'ì‹«ì–´í•˜ëŠ”(ë˜ëŠ” í™”ë‚˜ëŠ”)'} ê²ƒë“¤ì„ ${MAX_ITEMS_TO_RANK}ê°œ ì´ë‚´ë¡œ ì•Œë ¤ì¤„ë˜? ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì„œ ë§í•´ì¤˜. (ì˜ˆ: ê²Œì„, ê°•ì•„ì§€, ê·¸ë¦¼ ê·¸ë¦¬ê¸°)`;
        appendBubble(promptText, 'bot');
        if (playTTSFunction) playTTSFunction(promptText, lsSelectedVoice);
    }

    function handleRankingItemInput(userInputText) {
        itemsToRank = userInputText.split(',')
            .map(item => item.trim())
            .filter(item => item)
            .slice(0, MAX_ITEMS_TO_RANK);

        if (itemsToRank.length < 2) {
            const errorText = `ìµœì†Œ ë‘ ê°œ ì´ìƒì€ ë§í•´ì¤˜ì•¼ ìˆœìœ„ë¥¼ ì •í•  ìˆ˜ ìˆì–´. ë‹¤ì‹œ í•œë²ˆ ${MAX_ITEMS_TO_RANK}ê°œ ì´ë‚´ë¡œ ì•Œë ¤ì¤„ë˜?`;
            appendBubble(errorText, 'bot');
            if (playTTSFunction) playTTSFunction(errorText, lsSelectedVoice);
            return;
        }

        itemsToRank.forEach(item => comparisonScores[item] = 0);
        for (let i = 0; i < itemsToRank.length; i++) {
            for (let j = i + 1; j < itemsToRank.length; j++) {
                comparisonPairs.push([itemsToRank[i], itemsToRank[j]]);
            }
        }

        if (comparisonPairs.length === 0 && itemsToRank.length > 0) { // í•­ëª©ì´ í•˜ë‚˜ë¿ì¼ ê²½ìš°
            const singleItemText = `${itemsToRank[0]}ì„(ë¥¼) ê°€ì¥ ${rankingType === 'likes' ? 'ì¢‹ì•„í•˜ëŠ”êµ¬ë‚˜' : 'ì‹«ì–´í•˜ëŠ”êµ¬ë‚˜'}! ì´ ì´ì•¼ê¸°ì— ëŒ€í•´ ë” í•´ë³¼ê¹Œ?`;
            appendBubble(singleItemText, 'bot', [
                { text: "ì‘, ì¢‹ì•„!", value: itemsToRank[0], action: (chosenItem) => discussRankedItem(chosenItem, 1) },
                { text: "ë‹¤ë¥¸ ì´ì•¼ê¸° í• ë˜", value: 'new_topic', action: () => {
                    isInRankingMode = false;
                    appendBubble("ì•Œê² ì–´. ê·¸ëŸ¼ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ì–´?", "bot");
                    if(playTTSFunction) playTTSFunction("ì•Œê² ì–´. ê·¸ëŸ¼ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ì–´?", lsSelectedVoice);
                }}
            ]);
            if(playTTSFunction) playTTSFunction(singleItemText, lsSelectedVoice);
            isInRankingMode = false;
            return;
        }
        currentPairIndex = 0;
        askNextComparison();
    }

    function askNextComparison() {
        if (currentPairIndex >= comparisonPairs.length) {
            finishRanking();
            return;
        }
        const pair = comparisonPairs[currentPairIndex];
        const questionText = `${pair[0]}(ì´)ë‘ ${pair[1]} ì¤‘ì—ì„œëŠ” ì–´ë–¤ ê²Œ ë” ${rankingType === 'likes' ? 'ì¢‹ì•„' : 'ì‹«ì–´(ë˜ëŠ” í™”ë‚˜)'}?`;
        
        appendBubble(questionText, 'bot', [
            { text: pair[0], value: pair[0], action: (chosenItem) => handleComparisonChoice(chosenItem, pair[1]) },
            { text: pair[1], value: pair[1], action: (chosenItem) => handleComparisonChoice(chosenItem, pair[0]) }
        ]);
        if (playTTSFunction) playTTSFunction(questionText, lsSelectedVoice);
    }

    function handleComparisonChoice(chosenItem, otherItemInPair) {
        appendBubble(`${chosenItem}! (ì„ íƒ)`, 'user'); // ì‚¬ìš©ìê°€ ì„ íƒí•œ ê²ƒì²˜ëŸ¼ í‘œì‹œ
        comparisonScores[chosenItem]++;
        currentPairIndex++;
        askNextComparison();
    }

    function finishRanking() {
        const sortedItems = itemsToRank.sort((a, b) => comparisonScores[b] - comparisonScores[a]);
        let rankText = `ì•Œë ¤ì¤˜ì„œ ê³ ë§ˆì›Œ! ë„¤ê°€ ${rankingType === 'likes' ? 'ì¢‹ì•„í•˜ëŠ”' : 'ì‹«ì–´í•˜ëŠ”(ë˜ëŠ” í™”ë‚˜ëŠ”)'} ê²ƒë“¤ ìˆœì„œëŠ” ì´ë ‡ê²Œ ë‚˜ì™”ì–´:\n`;
        const choicesForDiscussion = [];
        sortedItems.forEach((item, index) => {
            rankText += `${index + 1}. ${item} (ì ìˆ˜: ${comparisonScores[item]})\n`;
            if (index < 3) {
                choicesForDiscussion.push({
                    text: `${item} ì´ì•¼ê¸°í•˜ê¸°`, value: item, 
                    action: (chosenItem) => discussRankedItem(chosenItem, index + 1)
                });
            }
        });
        choicesForDiscussion.push({ text: "ë‹¤ë¥¸ ì´ì•¼ê¸° í• ë˜", value: 'new_topic', action: () => {
            isInRankingMode = false; 
            appendBubble("ì•Œê² ì–´. ê·¸ëŸ¼ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ì–´?", "bot");
            if(playTTSFunction) playTTSFunction("ì•Œê² ì–´. ê·¸ëŸ¼ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ì–´?", lsSelectedVoice);
        }});

        appendBubble(rankText.trim(), 'bot');
        if (playTTSFunction) playTTSFunction(rankText.trim(), lsSelectedVoice);
        
        setTimeout(() => {
            const discussPrompt = "ì´ ì¤‘ì—ì„œ ì˜¤ëŠ˜ì€ ì–´ë–¤ ì´ì•¼ê¸°ì— ëŒ€í•´ ë” ìì„¸íˆ ë‚˜ëˆ ë³¼ê¹Œ?";
            appendBubble(discussPrompt, 'bot', choicesForDiscussion);
            if(playTTSFunction) playTTSFunction(discussPrompt, lsSelectedVoice);
        }, 1000);

        isInRankingMode = false;
        localStorage.setItem('lozee_user_rankings', JSON.stringify({ type: rankingType, items: sortedItems.map(item => ({name: item, score: comparisonScores[item]})) }));
    }

    function discussRankedItem(item, rank) {
        appendBubble(`${item}ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê³  ì‹¶êµ¬ë‚˜!`, 'user');
        const topicData = { type: 'ranked_preference', preference_type: rankingType, item: item, rank: rank };
        localStorage.setItem('lozee_last_active_topic', JSON.stringify(topicData));
        
        const getFirstQuestion = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.getFirstQuestion) || ((age, topic) => "ì˜¤ë¥˜: ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const firstQuestionForRankedItem = getFirstQuestion(userAge, topicData); 
        
        appendBubble(firstQuestionForRankedItem, 'bot');
        if (playTTSFunction) playTTSFunction(firstQuestionForRankedItem, lsSelectedVoice);
        chatHistory.push({ role: 'bot', content: firstQuestionForRankedItem, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory)); // ì²« ì§ˆë¬¸ë„ ê¸°ë¡
    }

    // --- ëŒ€í™” ì²˜ë¦¬ ë¡œì§ ---
    async function handleUserText(text) {
        const trimmedText = text.trim();
        if (!trimmedText) return;

        if (isInRankingMode && rankingType && itemsToRank.length === 0 && comparisonPairs.length === 0) {
            appendBubble(trimmedText, 'user'); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì•„ì´í…œ ëª©ë¡ í‘œì‹œ
            handleRankingItemInput(trimmedText);
            chatInput.value = '';
            setLoading(false); 
            return;
        }
        // ë­í‚¹ ëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜, ì•„ì´í…œ ì…ë ¥ ë‹¨ê³„ê°€ ì§€ë‚œ ê²½ìš° ì¼ë°˜ ëŒ€í™” ì²˜ë¦¬
        document.querySelector('.bubble.user.interim')?.remove();
        appendBubble(trimmedText, 'user');
        chatHistory.push({ role: 'user', content: trimmedText, timestamp: new Date().toISOString() });
        setLoading(true);

        // "ì£¼ì œ ì—†ì–´" ë“± íŠ¹ì • í‚¤ì›Œë“œë¡œ ë­í‚¹ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì œì•ˆ
        if (trimmedText.includes("ì£¼ì œ ì—†ì–´") || trimmedText.includes("ë­í• ì§€ ëª¨ë¥´ê² ì–´") || trimmedText.includes("ì´ì•¼ê¸°í•  ê±° ì—†ì–´")) {
            const choices = [
                { text: "ì¢‹ì•„í•˜ëŠ” ê±° ìˆœìœ„ ë§¤ê²¨ë³¼ê¹Œ?", value: 'likes', action: () => startRankingProcess('likes') },
                { text: "ì‹«ì–´í•˜ëŠ” ê±° ìˆœìœ„ ë§¤ê²¨ë³¼ê¹Œ?", value: 'dislikes', action: () => startRankingProcess('dislikes') },
                { text: "ë‹¤ë¥¸ ì´ì•¼ê¸° í• ë˜", value: 'new_topic', action: () => {
                    appendBubble("ì•Œê² ì–´. ê·¸ëŸ¼ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ë‹ˆ?", "bot");
                    if(playTTSFunction) playTTSFunction("ì•Œê² ì–´. ê·¸ëŸ¼ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ë‹ˆ?", lsSelectedVoice);
                }}
            ];
            appendBubble("ì´ì•¼ê¸°í•  ì£¼ì œë¥¼ ì •í•˜ê¸° ì–´ë µêµ¬ë‚˜. ì–´ë–¤ ê±¸ í•´ë³¼ê¹Œ?", 'bot', choices);
            if(playTTSFunction) playTTSFunction("ì´ì•¼ê¸°í•  ì£¼ì œë¥¼ ì •í•˜ê¸° ì–´ë µêµ¬ë‚˜. ì–´ë–¤ ê±¸ í•´ë³¼ê¹Œ?", lsSelectedVoice);
            setLoading(false); chatInput.value = ''; chatInput.focus();
            return; 
        }

        try {
            const contextForGpt = { userId, userAge, userName, userDisease, chatHistory: chatHistory.slice(-10) };
            const getGptResponse = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.getGptResponse) || (async () => ({ json: async () => ({ text: "ì˜¤ë¥˜: ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}) }));
            
            const res = await getGptResponse(trimmedText, contextForGpt);
            console.log("GPT API ì‘ë‹µ:", data);

            const botMessage = res?.content || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”.";

if (res.analysis) {
  // ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬
}
            const botResponseEntry = { role: 'bot', content: botMessage, timestamp: new Date().toISOString() };
            if (data.analysis) {
                console.log("ğŸ’¡ ë¶„ì„ ë°ì´í„°:", data.analysis);
                botResponseEntry.analysis = data.analysis;
                // ì—¬ê¸°ì— ë¶„ì„ ê²°ê³¼(ì˜ˆ: ê°ì • ê°•ë„)ì— ë”°ë¥¸ ì¶”ê°€ ë¡œì§ì´ë‚˜ ìˆ«ì ì§ˆë¬¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
            }
            chatHistory.push(botResponseEntry);
            localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
            if (playTTSFunction) await playTTSFunction(botMessage, lsSelectedVoice);

            // ìˆ«ìë¡œ ê°ì • ê°•ë„ ë¬»ëŠ” ë¡œì§ (ì˜ˆì‹œ ì¡°ê±´)
            const userIntent = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.detectIntent) ? window.LOZEE_DIALOG.detectIntent(trimmedText) : 'fact';
            if (userIntent === 'emotion' && botMessage.includes("ì–´ë–¤ ê¸°ë¶„ì¸ì§€ ìì„¸íˆ ë§í•´ì¤„ë˜")) { // ì¡°ê±´ì€ ë” êµ¬ì²´í™” í•„ìš”
                const numericScaleQuestion = `${userName}ì•„/ì•¼, ì§€ê¸ˆ ê·¸ ê¸°ë¶„ì´ 1ë¶€í„° 10ê¹Œì§€ ì¤‘ì— ëª‡ ì  ì •ë„ì¼ê¹Œ? ìˆ«ìê°€ í´ìˆ˜ë¡ ë” ê°•í•œ ê±°ì•¼.`;
                appendBubble(numericScaleQuestion, 'bot');
                if (playTTSFunction) await playTTSFunction(numericScaleQuestion, lsSelectedVoice);
            }

        } catch (err) {
            console.error("âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
            const errorMessage = "ì£„ì†¡í•´ìš”, ë‚´ë¶€ ì˜¤ë¥˜ë¡œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”.";
            appendBubble(errorMessage, 'system-error');
            chatHistory.push({ role: 'system', content: errorMessage, error: err.message, timestamp: new Date().toISOString() });
            localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
            if (playTTSFunction) await playTTSFunction(errorMessage, lsSelectedVoice);
        }
        setLoading(false);
        chatInput.value = '';
        chatInput.focus();
    }

    // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    async function initConversation() {
        setLoading(true);
        const getFirstQuestion = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.getFirstQuestion) || ((age, topic) => "ì˜¤ë¥˜: ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const prompt = getFirstQuestion(userAge, selectedTopic);
        
        appendBubble(prompt, 'bot');
        chatHistory.push({ role: 'bot', content: prompt, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        if (playTTSFunction) {
            try { await playTTSFunction(prompt, lsSelectedVoice); }
            catch (ttsError) { console.error("TTS ì˜¤ë¥˜ (ì´ˆê¸° ëŒ€í™”):", ttsError); }
        }
        setLoading(false);
    }

    async function initializeApp() {
        initializeDOMElements(); // DOM ìš”ì†Œ ì´ˆê¸°í™”

        if (!chatContainer) {
            console.error("CRITICAL: chatContainer element not found. Chat cannot function.");
            document.body.innerHTML = '<div style="color: red; font-size: 20px; text-align: center; padding: 50px; background-color: #fff; border: 2px solid red;">ì±„íŒ… UIë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTML êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (chat-container ëˆ„ë½)</div>';
            return;
        }

        // TTS ê´€ë ¨ ì´ˆê¸°í™”
        if (window.LOZEE_TTS && window.LOZEE_TTS.playTTSFromText && window.LOZEE_TTS.DEFAULT_VOICE) {
            playTTSFunction = window.LOZEE_TTS.playTTSFromText;
            currentDefaultVoice = window.LOZEE_TTS.DEFAULT_VOICE;
            console.log("tts.js (ì „ì—­) ë¡œë“œ ì„±ê³µ. ê¸°ë³¸ ìŒì„±:", currentDefaultVoice);
        } else {
            console.error("tts.jsê°€ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜, LOZEE_TTS ê°ì²´ì— í•„ìš”í•œ í•¨ìˆ˜/ë³€ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            playTTSFunction = async (text, voice) => { console.warn(`TTS Fallback (ìŒì„±: ${voice}): ${text}. tts.js ë¡œë“œ ì‹¤íŒ¨.`); };
            currentDefaultVoice = 'default-fallback-voice'; // ì‹¤ì œ ìŒì„± IDê°€ ì•„ë‹˜
            appendBubble("ì•Œë¦¼: ìŒì„± ì¶œë ¥(TTS) ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¡œë§Œ ëŒ€í™”ê°€ ì§„í–‰ë©ë‹ˆë‹¤.", "system-error");
        }
        lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || currentDefaultVoice;


        // GPT Dialog ê´€ë ¨ ì´ˆê¸°í™”
        if (!window.LOZEE_DIALOG || !window.LOZEE_DIALOG.getGptResponse || !window.LOZEE_DIALOG.getFirstQuestion) {
            console.error("gpt-dialog.jsê°€ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜, LOZEE_DIALOG ê°ì²´ì— í•¨ìˆ˜ë“¤ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            appendBubble("ì˜¤ë¥˜: ëŒ€í™” ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.", "system-error");
            // return; // ì—¬ê¸°ì„œ ì¤‘ë‹¨í•˜ë©´ ë‹¤ë¥¸ ê¸°ëŠ¥ë„ ì´ˆê¸°í™” ì•ˆ ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¼ë‹¨ ì§„í–‰
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        userAge = localStorage.getItem('lozee_userage');
        userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
        userId = localStorage.getItem('lozee_userid') || `user_${Date.now()}`; // ê°„ë‹¨í•œ ê³ ìœ  ID ìƒì„±
        try {
            userDisease = JSON.parse(localStorage.getItem('lozee_userdisease') || '[]');
            if (!Array.isArray(userDisease)) userDisease = [userDisease];
        } catch (e) { userDisease = []; }
        
        selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');
        chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');
        
        chatHistory.forEach(msg => { // ê¸°ì¡´ ëŒ€í™” ë¡œë“œ ì‹œ ì„ íƒì§€ ë²„íŠ¼ì€ ë‹¤ì‹œ ë§Œë“¤ì§€ ì•ŠìŒ
            if (typeof msg.content === 'string') { // ë‹¨ìˆœ í…ìŠ¤íŠ¸ë§Œ ë‹¤ì‹œ ë¡œë“œ
                 appendBubble(msg.content, msg.role);
            } else if (msg.content && msg.content.text) { // í˜¹ì‹œ ê°ì²´ í˜•íƒœë¡œ ì €ì¥ë˜ì—ˆë‹¤ë©´
                 appendBubble(msg.content.text, msg.role);
            }
        });


        // ë©”ë‰´ í† ê¸€
        if (menuToggle && dropdownMenu && gnb) {
            menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
            document.addEventListener('click', (event) => {
                if (!gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
                dropdownMenu.classList.remove('show');
                }
            });
        } else {
            console.warn("ë©”ë‰´ ê´€ë ¨ DOM ìš”ì†Œ ì¤‘ ì¼ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }


        // ìŒì„± ì¸ì‹ ì„¤ì • (SpeechRecognition API)
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; // STTê°€ ìë™ìœ¼ë¡œ ë©ˆì¶”ì§€ ì•Šë„ë¡ (í•„ìš”ì— ë”°ë¼ falseë¡œ í•˜ê³  onendì—ì„œ ì¬ì‹œì‘)
            recognition.interimResults = true;
            recognition.lang = 'ko-KR';
            if(micButton) micButton.classList.remove('disabled');

            recognition.onstart = () => {
                isRecognizing = true; if(micButton) { micButton.textContent = 'ğŸ’¬'; micButton.style.backgroundColor = '#e74c3c';} console.log("ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘");
                 // ì‚¬ìš©ìê°€ ë§ ì‹œì‘ ì‹œ TTS ì¤‘ë‹¨ (ë§Œì•½ LOZEE_TTSì— stop í•¨ìˆ˜ê°€ ìˆë‹¤ë©´)
                if (window.LOZEE_TTS && typeof window.LOZEE_TTS.stopPlayback === 'function') {
                    window.LOZEE_TTS.stopPlayback();
                }
            };
            recognition.onend = () => {
                isRecognizing = false; if(micButton) { micButton.textContent = 'ğŸ¤'; micButton.style.backgroundColor = 'var(--primary-color)';} console.log("ğŸ¤ ìŒì„± ì¸ì‹ ì¢…ë£Œ"); 
                setLoading(false); 
                stopAudioAnalysis();
                // í•„ìš”ì‹œ ì—¬ê¸°ì„œ ìë™ìœ¼ë¡œ ë‹¤ì‹œ recognition.start()ë¥¼ í˜¸ì¶œí•˜ì—¬ ê³„ì† ë“£ë„ë¡ í•  ìˆ˜ ìˆìœ¼ë‚˜, ì‚¬ìš©ìê°€ ì›í• ë•Œë§Œ í•˜ë„ë¡ í˜„ì¬ëŠ” ìœ ì§€
            };
            recognition.onresult = (event) => {
                let interimTranscript = '', finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    event.results[i].isFinal ? finalTranscript += event.results[i][0].transcript : interimTranscript += event.results[i][0].transcript;
                }
                if (interimTranscript && isRecognizing) showInterim(interimTranscript); // ì¸ì‹ ì¤‘ì—ë§Œ ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
                if (finalTranscript) { 
                    document.querySelector('.bubble.user.interim')?.remove(); 
                    if(chatInput) chatInput.value = finalTranscript; // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥ì°½ì—ë„ í‘œì‹œ
                    handleUserText(finalTranscript); // ìµœì¢… ê²°ê³¼ë¡œ ëŒ€í™” ì²˜ë¦¬
                }
            };
            recognition.onerror = (event) => {
                console.error("âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event.error);
                appendBubble(event.error === 'not-allowed' || event.error === 'service-not-allowed' ? "ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•´ìš”." : "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "system-error");
                isRecognizing = false; if(micButton) { micButton.textContent = 'ğŸ¤'; micButton.style.backgroundColor = 'var(--primary-color)';}
                setLoading(false); stopAudioAnalysis();
            };
        } else {
            console.warn("âš ï¸ ìŒì„± ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €");
            if(micButton) { micButton.title = "ìŒì„± ì¸ì‹ ë¯¸ì§€ì›"; micButton.disabled = true; }
            appendBubble("ì•Œë¦¼: ì‚¬ìš© ì¤‘ì¸ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "system-error");
        }

        if(micButton) {
            micButton.addEventListener('click', async () => {
                if (!SpeechRecognition) return;
                if (isRecognizing) {
                    recognition.stop();
                } else {
                    try {
                        // TTSê°€ ì¬ìƒ ì¤‘ì´ë¼ë©´ ë¨¼ì € ì¤‘ì§€ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
                        if (window.LOZEE_TTS && typeof window.LOZEE_TTS.stopPlayback === 'function') {
                           await window.LOZEE_TTS.stopPlayback(); // ë¹„ë™ê¸°ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ await
                        }
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        setupAudioAnalysis(stream); recognition.start(); setLoading(true); // STT ì‹œì‘ ì‹œ ë¡œë”©ì€ ì„ íƒì 
                    } catch (err) {
                        console.error("âŒ ë§ˆì´í¬ ê¶Œí•œ/ì‹œì‘ ì˜¤ë¥˜:", err); appendBubble("ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "system-error"); stopAudioAnalysis();
                    }
                }
            });
        }

        // ëŒ€í™” ì‹œì‘ ë¡œì§ (localStorageì— ì €ì¥ëœ ìƒíƒœì— ë”°ë¼ ë¶„ê¸°)
        const savedRankingState = JSON.parse(localStorage.getItem('lozee_ranking_progress')); // ì´ ë¶€ë¶„ì€ ì•„ì§ ë¯¸êµ¬í˜„
        const savedLastTopic = JSON.parse(localStorage.getItem('lozee_last_active_topic'));

        if (savedRankingState /* && savedRankingState.isInRankingMode */) { // ë­í‚¹ ì´ì–´í•˜ê¸° ë¡œì§ (ë¯¸êµ¬í˜„ ìƒíƒœ)
            // TODO: ë­í‚¹ ì´ì–´í•˜ê¸° UI ë° ë¡œì§ í˜¸ì¶œ
            appendBubble("ì§€ë‚œë²ˆì— í•˜ë˜ ì„ í˜¸ë„ ìˆœìœ„ ë§¤ê¸°ê¸°ë¥¼ ì´ì–´ì„œ í• ê¹Œ?", "bot", [
                { text: "ì‘, ì´ì–´ì„œ í• ë˜", value: "resume_ranking", action: () => { /* TODO: ë­í‚¹ ìƒíƒœ ë³µì› ë° askNextComparison í˜¸ì¶œ */ } },
                { text: "ì•„ë‹ˆ, ìƒˆë¡œ ì‹œì‘í• ë˜", value: "new_topic_instead", action: () => {
                    localStorage.removeItem('lozee_ranking_progress');
                    localStorage.removeItem('lozee_last_active_topic');
                    initConversationWithOptionalTopicPrompt(); // ìƒˆë¡œìš´ ì£¼ì œ ì„ íƒ ë˜ëŠ” ì²« ì¸ì‚¬
                }}
            ]);
        } else if (savedLastTopic && savedLastTopic.item) {
             appendBubble(`ì§€ë‚œë²ˆì— '${savedLastTopic.item}'ì— ëŒ€í•´ ì´ì•¼ê¸°í–ˆì—ˆëŠ”ë°, ê³„ì† ì´ì•¼ê¸°í•´ ë³¼ê¹Œ? ì•„ë‹ˆë©´ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ë‹ˆ?`, "bot", [
                { text: "ì‘, ì´ì–´ì„œ í• ë˜", value: "resume_topic", action: () => {
                    selectedTopic = savedLastTopic; // ì„ íƒëœ ì£¼ì œë¡œ ì„¤ì •
                    // GPTì—ê²Œ ì´ì–´ì„œ ëŒ€í™”í•˜ë„ë¡ ìœ ë„ (chatHistoryëŠ” ì´ë¯¸ ë¡œë“œë¨)
                    const resumeMessage = `'${selectedTopic.item}' ì´ì•¼ê¸° ê³„ì†í•˜ì!`;
                    appendBubble(resumeMessage, 'bot');
                    if(playTTSFunction) playTTSFunction(resumeMessage, lsSelectedVoice);
                    // chatHistory.push({role:'system', content: 'ì‚¬ìš©ìê°€ ì´ì „ ëŒ€í™” ì´ì–´í•˜ê¸°ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.'});
                    // ì‚¬ìš©ìê°€ ë­”ê°€ ì…ë ¥í•´ì•¼ ë‹¤ìŒ GPT í˜¸ì¶œì´ ì¼ì–´ë‚˜ë¯€ë¡œ, ë¡œì§€ê°€ ë¨¼ì € ë§ì„ ê±¸ë„ë¡ ìœ ë„í•˜ê±°ë‚˜
                    // í˜¹ì€ ì‚¬ìš©ìê°€ ë°”ë¡œ ë‹¤ìŒ ë§ì„ í•  ìˆ˜ ìˆë„ë¡ ì•ˆë‚´
                }},
                { text: "ìƒˆë¡œìš´ ì´ì•¼ê¸° í• ë˜", value: "new_topic_instead", action: () => {
                    localStorage.removeItem('lozee_last_active_topic');
                    chatHistory = []; // ìƒˆ ì´ì•¼ê¸°ì´ë¯€ë¡œ ì´ì „ ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™” (ì„ íƒ ì‚¬í•­)
                    localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
                    document.querySelectorAll('.bubble').forEach(b => b.remove()); // í™”ë©´ì˜ ë²„ë¸”ë„ ì œê±°
                    initConversationWithOptionalTopicPrompt();
                }}
             ]);
        } else if (Object.keys(selectedTopic).length > 0 && chatHistory.length === 0) {
            await initConversation(); // ì„ íƒëœ ì£¼ì œë¡œ ì²« ëŒ€í™” ì‹œì‘
        } else if (chatHistory.length === 0) { // ì €ì¥ëœ ì£¼ì œë„ ì—†ê³ , ëŒ€í™” ê¸°ë¡ë„ ì—†ì„ ë•Œ
            initConversationWithOptionalTopicPrompt();
        }
        // ì´ë¯¸ ëŒ€í™” ê¸°ë¡ì´ ìˆë‹¤ë©´(ìƒˆë¡œê³ ì¹¨ ë“±), ë³„ë„ì˜ ì´ˆê¸° ë©”ì‹œì§€ ì—†ì´ ì‚¬ìš©ì ì…ë ¥ì„ ê¸°ë‹¤ë¦¼

        function initConversationWithOptionalTopicPrompt() {
            if (Object.keys(selectedTopic).length > 0) {
                 initConversation();
            } else {
                 appendBubble("ì•ˆë…•! ì˜¤ëŠ˜ì€ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•´ë³¼ê¹Œ? ì•„ë‹ˆë©´ ë‚´ê°€ ë¨¼ì € ì£¼ì œë¥¼ ì œì•ˆí•´ ì¤„ê¹Œ?", "bot", [
                    {text: "ë‚´ê°€ ë§í• ê²Œ", value: "user_defines", action: () => {
                        appendBubble("ì¢‹ì•„! ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ì€ì§€ ì…ë ¥í•´ì¤˜.", "bot");
                        if(playTTSFunction) playTTSFunction("ì¢‹ì•„! ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ê³  ì‹¶ì€ì§€ ì…ë ¥í•´ì¤˜.", lsSelectedVoice);
                    }},
                    {text: "ë¡œì§€ê°€ ê³¨ë¼ì¤˜", value: "lozee_picks", action: () => {
                        // ë¡œì§€ê°€ ì£¼ì œë¥¼ ê³¨ë¼ì£¼ëŠ” ë¡œì§ (gpt-dialog.jsì˜ getFirstQuestionê³¼ ìœ ì‚¬í•˜ê²Œ)
                        const randomTopicPrompt = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.getFirstQuestion) ? window.LOZEE_DIALOG.getFirstQuestion(userAge, {displayText: "RANDOM_TOPIC_PLEASE"}) : "ì˜¤ëŠ˜ì€ ë‚ ì”¨ ì´ì•¼ê¸° ì–´ë•Œ?";
                        selectedTopic = {displayText: randomTopicPrompt}; // ì„ì‹œë¡œ ì„¤ì •
                        initConversation();
                    }}
                 ]);
                if(playTTSFunction) playTTSFunction("ì•ˆë…•! ì˜¤ëŠ˜ì€ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•´ë³¼ê¹Œ? ì•„ë‹ˆë©´ ë‚´ê°€ ë¨¼ì € ì£¼ì œë¥¼ ì œì•ˆí•´ ì¤„ê¹Œ?", lsSelectedVoice);
            }
        }


        // ì „ì†¡ ë²„íŠ¼ ë° Enter í‚¤ ì´ë²¤íŠ¸
        if (sendButton && chatInput) {
            sendButton.addEventListener('click', () => { const text = chatInput.value; handleUserText(text); });
            chatInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); const text = chatInput.value; handleUserText(text); 
                } 
            });
        } else {
            console.error("Send button ë˜ëŠ” Chat input DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // ì´ˆê¸° ë¡œë”© ì‹œ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ TTS.js ë“±ì´ ë¡œë“œë  ì‹œê°„ì„ í™•ë³´ (ì„ íƒì )
        // setTimeout(initializeApp, 50); // DOMContentLoaded ë‚´ë¶€ë¡œ ì˜®ê¹€
    } // initializeApp ë

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeApp, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ëŠ˜ë ¤ì„œ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ë³´ì¥ ì‹œë„
    });

  </script>
</body>
</html>

