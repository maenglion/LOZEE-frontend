<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; background: #fff; color: #333; font-family: 'KoPubWorld Dotum', sans-serif; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; font-size: 16px; white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user { background-color: #fff9c4; color: #333; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .ai { background-color: #0095FF; color: #fff; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 5px; }
    #loading-indicator { text-align: center; padding: 10px; display: none; color: #555; font-style: italic; }
    #talk-btn-container { text-align: center; padding: 15px; border-top: 1px solid #eee; background: #fafafa; }
    #talk-btn { width: 80px; height: 80px; border-radius: 50%; background: #b6b6b6; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); color: #fff; font-size: 36px; cursor: pointer; transition: transform .2s, background-color .3s; }
    #talk-btn.recording { background: #e06c75; transform: scale(1.1); }
    #talk-btn.active { background: #0095FF; transform: scale(1.1); }
  </style>
</head>
<body>
  <div id="chat-window"></div>
  <div id="loading-indicator">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    // ë…¹ìŒ ì •ì±…
    function getRecordingPolicyByAge(age) {
      age = parseInt(age, 10) || 16;
      if (age <= 10) return { segmentDuration: 30000, maxDuration: 180000 };
      if (age <= 15) return { segmentDuration: 30000, maxDuration: 300000 };
      return { segmentDuration: 40000, maxDuration: 600000 };
    }

    // ì¹¨ë¬µ ì‹œ ì‹œë‚˜ë¦¬ì˜¤ (10ì´ˆ)
    const silenceScenarios = [
      'ë¬´ìŠ¨ ì´ì•¼ê¸°ë¥¼ ë” í•´ë³¼ê¹Œ?',
      'ê¶ê¸ˆí•œ ê²Œ ìˆìœ¼ë©´ ì–¸ì œë“  ë§í•´ì¤˜.',
      'ì¡°ê¸ˆ ì¡°ìš©í•˜ë„¤, ë¬´ìŠ¨ ìƒê° ì¤‘ì´ì•¼?'
    ];

    const chatWindow = document.getElementById('chat-window');
    const talkBtn     = document.getElementById('talk-btn');
    const loading     = document.getElementById('loading-indicator');

    let sessionStart = Date.now();
    let isRecording = false;
    let mediaRecorder, mediaStream, audioChunks = [];
    let firstDone = false;
    let segmentTimer, maxTimer, silenceTimer;
    let segmentMs = 30000, maxMs = 180000;

    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return div;
    }

    function toggleLoading(state) {
      loading.style.display = state ? 'block' : 'none';
      talkBtn.disabled = state;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // ì •ì±… ì ìš©
      const age = localStorage.getItem('lozee_user_age');
      const policy = getRecordingPolicyByAge(age);
      segmentMs = policy.segmentDuration;
      maxMs = policy.maxDuration;

      // ì´ˆê¸° ì¸ì‚¬
      const name = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const greeting = await getInitialGreeting(name);
      appendMessage(greeting, 'ai');

      // Indexì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€
      const intro = localStorage.getItem('lozee_user_typed_intro');
      if (intro) {
        handleUserTurn(intro);
        localStorage.removeItem('lozee_user_typed_intro');
        firstDone = true;
      }

      // ë§í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      talkBtn.addEventListener('click', async () => {
        clearTimeout(silenceTimer);
        if (!firstDone) {
          firstDone = true;
          toggleLoading(true);
          await playTTSFromText(greeting);
          toggleLoading(false);
          startSilenceTimer();
          return;
        }
        isRecording ? stopRecording() : startRecording();
      });
    });

    async function startRecording() {
      clearTimeout(silenceTimer);
      isRecording = true;
      audioChunks = [];
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = processAudio;
      mediaRecorder.start();
      talkBtn.classList.add('recording');
      segmentTimer = setTimeout(stopRecording, segmentMs);
      maxTimer = setTimeout(stopRecording, maxMs);
    }

    function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      clearTimeout(segmentTimer);
      clearTimeout(maxTimer);
      mediaRecorder.stop();
      mediaStream.getTracks().forEach(t => t.stop());
      talkBtn.classList.remove('recording');
    }

    async function processAudio() {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const userBubble = appendMessage('â€¦', 'user');
      toggleLoading(true);
      try {
        const transcript = await getSTTFromAudio(blob);
        userBubble.textContent = transcript;
        await handleUserTurn(transcript);
      } catch {
        appendMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai');
      } finally {
        toggleLoading(false);
        startSilenceTimer();
      }
    }

    // ì‚¬ìš©ì ë°œí™” ì²˜ë¦¬ + GPT í˜¸ì¶œ
    async function handleUserTurn(text) {
      appendMessage(text, 'user');
      const age = parseInt(localStorage.getItem('lozee_user_age'), 10) || 16;
      const elapsed = Date.now() - sessionStart;
      // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
      const sys = [];
      if (elapsed < 10 * 60 * 1000) sys.push('ì´ˆê¸° 10ë¶„ê°„ ëŒ€í™”ë¥¼ ì´ëŒì–´ ë‚´ëŠ” ë° ì§‘ì¤‘í•˜ì„¸ìš”.');
      if (age < 10 && elapsed < 10 * 60 * 1000) sys.push('15ê¸€ì ì´ìƒ ì‘ë‹µì„ ìì œí•˜ì„¸ìš”.');
      sys.push(age <= 55 ? 'ë°˜ë§ë¡œ ë‹µí•˜ì„¸ìš”.' : 'ì¡´ëŒ“ë§ë¡œ ë‹µí•˜ì„¸ìš”.');
      const systemPrompt = sys.join(' ');

      // GPT í˜¸ì¶œ
      const res = await getGptResponse(text, systemPrompt);
      const aiText = (typeof res === 'string' ? res : (res.error || res.rephrasing || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'));
      appendMessage(aiText, 'ai');
      await playTTSFromText(aiText);
    }

    function startSilenceTimer() {
      silenceTimer = setTimeout(() => {
        const prompt = silenceScenarios[Math.floor(Math.random() * silenceScenarios.length)];
        appendMessage(prompt, 'ai');
        playTTSFromText(prompt);
      }, 10000);
    }
  </script>
</body>
</html>
