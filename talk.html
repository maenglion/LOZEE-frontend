<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEE와 대화하기</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* GNB */
    #gnb {
      position: fixed; top:0; left:0; width:100%;
      background:#354157; padding:8px 16px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      z-index:1000; display:flex; gap:12px;
    }
    #gnb a {
      color:#fff; text-decoration:none; font-size:.95em;
    }

    /* 베이스 */
    body {
      margin:0; padding-top:40px;
      font-family:'KoPub World Dotum',sans-serif;
      background:#2a3340; color:#fff;
    }

    /* 채팅 영역 */
    #chat-container {
      padding:16px;
      height:calc(100vh - 140px);
      overflow-y:auto;
      display:flex; flex-direction:column; gap:8px;
    }
    .bubble {
      padding:12px 16px; border-radius:20px;
      max-width:70%; line-height:1.4; word-break:keep-all;
    }
    .bubble.user         { background:#6e8efb; align-self:flex-end; color:#fff; }
    .bubble.bot          { background:#f0f0f0; align-self:flex-start; color:#333; }
    .bubble.user.interim { opacity:.6; }

    /* 입력 영역 */
    #chat-input-container {
      position:fixed; bottom:0; left:0;
      width:100%; display:flex; gap:8px;
      padding:8px; background:#354157;
    }
    #chat-input {
      flex:1; padding:12px;
      border-radius:20px; border:none;
      font-size:1em;
    }
    #send-button, #mic-button {
      width:48px; height:48px;
      border:none; border-radius:50%;
      background:#6e8efb; color:#fff;
      font-size:1.2em; cursor:pointer;
    }
    #mic-button.disabled { opacity:.5; cursor:default; }
    #send-button.loading { background:#999; cursor:default; }

    /* 음량 바 */
    #meter-container {
      position:fixed; top:40px;
      left:50%; transform:translateX(-50%);
      width:60%; height:4px;
      background:#4a5568; border-radius:2px; overflow:hidden;
    }
    #volume-meter { width:100%; height:100%; }
    #volume-level { width:0%; height:100%; background:#6e8efb; transition:width .1s; }
  </style>
</head>
<body>
  <nav id="gnb">
    <a href="index.html">홈</a>
    <a href="#" id="gnb-topic-change">주제 변경</a>
    <a href="analysis.html">분석 결과</a>
    <a href="settings.html">설정</a>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>

  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" class="disabled" title="음성 인식 시작/중지">🎤</button>
    <input type="text" id="chat-input" placeholder="메시지 입력 또는 🎤" autocomplete="off"/>
    <button id="send-button">⮞</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse, getFirstQuestion }     from './js/gpt-dialog.js';

    document.addEventListener('DOMContentLoaded', async () => {
      // ── DOM 참조 ─────────────────────────────────
      const chatContainer = document.getElementById('chat-container');
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');
      // ────────────────────────────────────────────────

      // 사용자 정보
      const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge       = localStorage.getItem('lozee_userage');
      const userName      = localStorage.getItem('lozee_username') || '친구';
      const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');

      // GNB 주제 변경
      document.getElementById('gnb-topic-change').onclick = e => {
        e.preventDefault();
        window.location.href = 'index.html';
      };

      // 말풍선 추가
      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // 중간 결과 표시
      function showInterim(text) {
        let el = document.querySelector('.bubble.user.interim');
        if (!el) {
          el = document.createElement('div');
          el.className = 'bubble user interim';
          chatContainer.appendChild(el);
        }
        el.textContent = text;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // 로딩 상태 토글
      function setLoading(flag) {
        sendButton.disabled = flag;
        micButton.disabled  = flag;
        sendButton.classList.toggle('loading', flag);
      }

      // 초기 프롬프트
      async function initConversation() {
        const prompt = getFirstQuestion(userAge, selectedTopic);
        appendBubble(prompt, 'bot');
        await playTTSFromText(prompt, selectedVoice);
      }

      // 사용자 입력 처리
      async function handleUserText(text) {
        if (!text.trim()) return;
        appendBubble(text, 'user');
        setLoading(true);
        document.querySelector('.bubble.user.interim')?.remove();

        try {
          const res = await getGptResponse(text, { userAge, userName, selectedTopic });

          if (!res.ok) {
          appendBubble("서버 응답 실패: " + res.status, 'bot');
          return;
        }
 
      const data = await res.json();
      const botMessage = data?.rephrasing || "응답을 받을 수 없었어요.";
      appendBubble(botMessage, 'bot');
      await playTTSFromText(botMessage, selectedVoice);

      const res = await getGptResponse(text, { userAge, userName, selectedTopic });
      console.log("응답 상태:", res.status);
      console.log("헤더:", res.headers);

      const text = await res.text();
      console.log("응답 텍스트:", text);
      console.log("GPT 응답 수신 결과:", data);
