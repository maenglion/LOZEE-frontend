<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="meter-container"><div id="volume-meter"><div id="volume-level"></div></div></div>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œìž‘/ì¤‘ì§€">ðŸŽ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”..." />
    <button id="send-button">ì „ì†¡</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse } from './js/gpt-dialog.js';

    const chatContainer = document.getElementById('chat-container');
    const meterLevel = document.getElementById('volume-level');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const micButton = document.getElementById('mic-button');

    // ì‚¬ìš©ìž ì„¤ì •
    const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
    const userAge = localStorage.getItem('lozee_userage');
    const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');

    let recognitionActive = false;
    let stt;

    function appendBubble(text, role) {
      const el = document.createElement('div');
      el.className = `bubble ${role}`;
      el.textContent = text;
      chatContainer.appendChild(el);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showAiLoading(show) {
      sendButton.disabled = show;
      chatInput.disabled = show;
      micButton.disabled = show;
    }

    // ì´ˆê¸° ì¸ì‚¬: ì„ íƒëœ ì£¼ì œ ë°˜ì˜
    async function initConversation() {
      const greeting = `${userName}ë‹˜, ì˜¤ëŠ˜ì€ "${selectedTopic.displayText || 'ëŒ€í™”'}" ì£¼ì œë¡œ ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?`;
      appendBubble(greeting, 'bot');
      await playTTSFromText(greeting, selectedVoice);
    }

    // ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ GPT í˜¸ì¶œ
    async function handleUserText(text) {
      if (!text.trim()) return;
      appendBubble(text, 'user');
      showAiLoading(true);

      // ë²„ë¸” ìƒì„± í›„ ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ í•œ ë²„ë¸”ì— ì´ì–´ì“°ê¸°
      const botBubble = document.createElement('div');
      botBubble.className = 'bubble bot';
      chatContainer.appendChild(botBubble);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      // fetch streaming
      const response = await fetch('/api/gpt-stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, context: { userAge, userName, selectedTopic } })
      });
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let done = false;
      while (!done) {
        const { value, done: doneReading } = await reader.read();
        done = doneReading;
        const chunk = decoder.decode(value);
        botBubble.textContent += chunk;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      // ì™„ì„±ëœ í…ìŠ¤íŠ¸ì— TTS ìž¬ìƒ
      await playTTSFromText(botBubble.textContent, selectedVoice);
      showAiLoading(false);
    }

    // í…ìŠ¤íŠ¸ ì „ì†¡ ì´ë²¤íŠ¸
    sendButton.onclick = () => {
      const txt = chatInput.value;
      chatInput.value = '';
      handleUserText(txt);
    };
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !sendButton.disabled) sendButton.click();
    });

    // STT ì„¤ì •
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const API = window.SpeechRecognition || window.webkitSpeechRecognition;
      stt = new API();
      stt.lang = 'ko-KR'; stt.interimResults = false; stt.maxAlternatives = 1;
      stt.onstart = () => { recognitionActive = true; micButton.textContent = 'ðŸ”´'; };
      stt.onend = () => { recognitionActive = false; micButton.textContent = 'ðŸŽ¤'; };
      stt.onresult = e => { const speech = e.results[0][0].transcript; handleUserText(speech); };

      micButton.onclick = () => {
        if (recognitionActive) stt.stop();
        else stt.start();
      };
    }

    document.addEventListener('DOMContentLoaded', initConversation);
  </script>
</body>
</html>
