<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="meter-container"><div id="volume-meter"><div id="volume-level"></div></div></div>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€" disabled>ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”..." />
    <button id="send-button">ì „ì†¡</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse, getFirstQuestion } from './js/gpt-dialog.js';
    import { trackTime, trackEmotionTone, trackSituation } from './js/basic-features.js';

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing chat');
      const chatContainer = document.getElementById('chat-container');
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');

      const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge       = localStorage.getItem('lozee_userage');
      const userName      = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const storedTopic   = localStorage.getItem('selectedTopic') || '{}';
      const selectedTopic = JSON.parse(storedTopic) || { displayText: 'ëŒ€í™”' };

      let recognitionActive = false;
      let stt;

      function appendBubble(text, role) {
        console.log('appendBubble', role, text);
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showAiLoading(show) {
        sendButton.disabled = show;
        chatInput.disabled  = show;
        micButton.disabled  = show || micButton.disabled;
      }

      // ì´ˆê¸° ëŒ€í™” ì‹œì‘
      async function initConversation() {
        console.log('initConversation');
        const prompt = getFirstQuestion(userAge, selectedTopic);
        appendBubble(prompt, 'bot');
        await playTTSFromText(prompt, selectedVoice);
        // BASIC ê¸°ëŠ¥ ì´ˆê¸°í™”
        trackTime();
        trackEmotionTone();
        trackSituation();
      }

      // ì‚¬ìš©ì ì…ë ¥ ë° ìŠ¤íŠ¸ë¦¬ë° GPT í˜¸ì¶œ
      async function handleUserText(text) {
        console.log('handleUserText:', text);
        if (!text.trim()) return;
        appendBubble(text, 'user');
        showAiLoading(true);

        const botBubble = document.createElement('div');
        botBubble.className = 'bubble bot';
        chatContainer.appendChild(botBubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
          const res = await fetch('/api/gpt-stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userInput: text, context: { userAge, userName, selectedTopic } })
          });
          const reader = res.body.getReader();
          const dec = new TextDecoder();
          let done = false;
          while (!done) {
            const { value, done: d } = await reader.read();
            done = d;
            botBubble.textContent += dec.decode(value, { stream: true });
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          await playTTSFromText(botBubble.textContent, selectedVoice);
        } catch (err) {
          console.error('GPT streaming error', err);
          appendBubble('ì£„ì†¡í•´ìš”, ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
          await playTTSFromText('ì£„ì†¡í•´ìš”, ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', selectedVoice);
        } finally {
          showAiLoading(false);
        }
      }

      // ì „ì†¡ ë²„íŠ¼ ë° ì—”í„°í‚¤ ì´ë²¤íŠ¸
      sendButton.addEventListener('click', () => {
        const txt = chatInput.value.trim();
        if (txt) { chatInput.value = ''; handleUserText(txt); }
      });
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !sendButton.disabled) {
          e.preventDefault();
          const txt = chatInput.value.trim();
          if (txt) { chatInput.value = ''; handleUserText(txt); }
        }
      });

      // STT ì„¤ì • ë° ê¶Œí•œ ìš”ì²­
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            console.log('Microphone access granted');
            const API = window.SpeechRecognition || window.webkitSpeechRecognition;
            stt = new API();
            stt.lang = 'ko-KR';
            stt.interimResults = false;

            stt.onstart = () => { recognitionActive = true; micButton.textContent = 'ğŸ”´'; };
            stt.onend   = () => { recognitionActive = false; micButton.textContent = 'ğŸ¤'; };
            stt.onresult = e => { const speech = e.results[0][0].transcript; handleUserText(speech); };

            micButton.disabled = false;
            micButton.addEventListener('click', () => {
              if (recognitionActive) stt.stop();
              else stt.start();
            });
          })
          .catch(err => {
            console.error('Microphone permission denied', err);
            appendBubble('ë§ˆì´í¬ ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'bot');
          });
      } else {
        console.error('Web Speech API not supported');
        appendBubble('ìŒì„± ì¸ì‹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”.', 'bot');
      }

      // ì´ˆê¸° ëŒ€í™” ì‹œì‘
      initConversation();
    });
  </script>
</body>
</html>
