<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEEÏôÄ ÎåÄÌôîÌïòÍ∏∞</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css">
    <style>
      :root {
          --primary-color: #6e8efb;
          --secondary-color: #5a7edf;
          --background-color: #ffffff;
          --text-color: #333333;
          --user-bubble-bg: var(--primary-color);
          --user-bubble-text: #ffffff;
          --assistant-bubble-bg: #F5E7A1; 
          --assistant-bubble-text: #333333;
          --input-area-bg: #f8f9fa;
          --chat-input-bg: #ffffff;
          --chat-input-text-color: #333333;
          --chat-input-border-color: #ced4da;
          --chat-input-placeholder-color: #777777;
          --button-bg: var(--primary-color);
          --button-text-color: #ffffff;
          --button-hover-bg: var(--secondary-color);
          --volume-meter-container-bg: #e9ecef;
          --volume-meter-level-bg: var(--primary-color);
          --meter-height: 6px;
          --meter-top-margin: 8px;
          --analysis-notification-bg: #fff3cd;
          --analysis-notification-text: #856404;
          --gnb-height: 56px; 
          --chat-input-area-height: 70px;
      }
      body {
          margin: 0;
          padding-top: var(--gnb-height);
          font-family: 'KoPub World Dotum', sans-serif;
          background: var(--background-color);
          color: var(--text-color);
          display: flex;
          flex-direction: column;
          height: 100vh;
          box-sizing: border-box;
          overflow: hidden;
      }
      #meter-container {
          position: fixed;
          top: calc(var(--gnb-height) + var(--meter-top-margin));
          left: 50%;
          transform: translateX(-50%);
          width: 60%;
          max-width: 300px;
          height: var(--meter-height);
          background: var(--volume-meter-container-bg);
          border-radius: 3px;
          overflow: hidden;
          z-index: 998;
      }
      #volume-level {
          width: 0%;
          height: 100%;
          background: var(--volume-meter-level-bg);
          border-radius: 3px;
          transition: width 0.05s linear, background-color 0.05s linear;
      }
      #chat-window {
          flex: 1;
          padding: 16px;
          padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
          padding-bottom: calc(var(--chat-input-area-height) + 10px);
          overflow-y: auto;
          display: flex;
          flex-direction: column;
          gap: 12px;
          box-sizing: border-box;
      }
      #chat-window::-webkit-scrollbar {
          width: 8px;
      }
      #chat-window::-webkit-scrollbar-track {
          background: var(--background-color);
      }
      #chat-window::-webkit-scrollbar-thumb {
          background: #cccccc;
          border-radius: 4px;
      }
      #chat-window::-webkit-scrollbar-thumb:hover {
          background: #aaaaaa;
      }
      .bubble {
          max-width: 75%;
          padding: 10px 15px;
          border-radius: 18px;
          line-height: 1.6;
          word-break: keep-all;
          box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .bubble.user {
          background: var(--user-bubble-bg);
          color: var(--user-bubble-text);
          align-self: flex-end;
          border-bottom-right-radius: 4px;
      }
      .bubble.assistant {
          background: var(--assistant-bubble-bg);
          color: var(--assistant-bubble-text);
          align-self: flex-start;
          border-bottom-left-radius: 4px;
      }
      .bubble.assistant_feedback {
          background: #e9ecef;
          color: #495057;
          align-self: center;
          font-size: 0.9em;
          border-radius: 8px;
      }
      .bubble.thinking {
          background: var(--assistant-bubble-bg);
          color: var(--assistant-bubble-text);
          align-self: flex-start;
          border-bottom-left-radius: 4px;
          font-style: italic;
          opacity: 0.8;
      }
      .journal-save-notification {
          align-self: center;
          background: #e8f5e9;
          color: #2e7d32;
          padding: 10px 16px;
          border-radius: 12px;
          cursor: default;
          font-size: 0.9em;
          margin: 5px 0;
          border: 1px solid #c8e6c9;
      }
      .analysis-notification {
          align-self: center;
          background: var(--analysis-notification-bg);
          color: var(--analysis-notification-text);
          padding: 10px 16px;
          border-radius: 12px;
          cursor: pointer;
          font-size: 0.9em;
          margin: 5px 0;
      }
      #topic-area {
          display: none !important; /* Ï£ºÏ†ú ÏÑ†ÌÉù ÏòÅÏó≠ÏùÄ ÌòÑÏû¨ HTMLÏóê ÏóÜÏúºÎØÄÎ°ú Ïà®ÍπÄ Ï≤òÎ¶¨ */
      }
      #input-area {
          padding: 0 20px;
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          height: var(--chat-input-area-height);
          display: none;
          align-items: center;
          gap: 8px;
          background: var(--input-area-bg);
          border-top: 1px solid #e0e0e0;
          box-sizing: border-box;
      }
      #input-area button,
      #input-area input {
          font-size: 1em;
          height: 44px;
          box-sizing: border-box;
      }
      #chat-input {
          flex: 1;
          min-width: 50px;
          padding: 10px 16px;
          border: 1px solid var(--chat-input-border-color);
          border-radius: 22px;
          outline: none;
          background-color: var(--chat-input-bg);
          color: var(--chat-input-text-color);
      }
      #chat-input::placeholder {
          color: var(--chat-input-placeholder-color);
      }
      #mic-button,
      #send-btn {
          width: 44px;
          min-width: 44px;
          height: 44px;
          border: none;
          border-radius: 50%;
          background: var(--button-bg);
          color: var(--button-text-color);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.3em;
          transition: background-color 0.2s ease;
          flex-shrink: 0;
      }
      #mic-button:hover,
      #send-btn:hover {
          background: var(--button-hover-bg);
      }
      #mic-button.recording {
          background: #e74c3c;
      }
      #send-btn.loading {
          background: #cccccc;
          cursor: default;
      }
      @media (max-width: 600px) {
          #input-area {
              padding: 0 15px;
              gap: 5px;
          }
          .bubble {
              padding: 9px 13px;
              max-width: 85%;
          }
          #chat-input {
              padding: 9px 14px;
          }
          #mic-button,
          #send-btn {
              width: 40px;
              height: 40px;
              font-size: 1.2em;
          }
          #input-area {
              height: 65px;
          }
          #chat-window {
              padding-bottom: calc(65px + 10px);
          }
      }
      @media (max-width: 360px) {
          #input-area {
              padding: 0 10px;
              gap: 5px;
          }
          #mic-button,
          #send-btn {
              width: 38px;
              height: 38px;
              font-size: 1.1em;
          }
          #chat-input {
              height: 38px;
          }
      }
      .chat-options-container {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin: 10px 0;
          align-items: flex-start;
          max-width: 80%;
          align-self: flex-start;
      }
      .chat-option-btn {
          background-color: #f1f1f1;
          color: #333333;
          border: 1px solid #dcdcdc;
          border-radius: 12px;
          padding: 10px 15px;
          width: 100%;
          text-align: left;
          cursor: pointer;
          font-size: 0.95em;
          transition: background-color 0.2s, transform 0.1s;
          box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .chat-option-btn:hover {
          background-color: #e9e9e9;
          transform: translateY(-1px);
      }
      .chat-option-btn.selected {
          background-color: #E4D2FD;
          color: #333;
          border-color: #c3b2e0;
          font-weight: bold;
      }
      .chat-option-btn.continue-topic-btn {
          background-color: #FFDAB9;
          border-color: #FFA07A;
      }
      .chat-option-btn:disabled {
          background-color: #f8f8f8;
          color: #aaaaaa;
          cursor: not-allowed;
          opacity: 0.7;
      }
      .chat-option-btn.manual-save-btn {
          background-color: #4CAF50;
          color: #ffffff;
          border-color: #388E3C;
      }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">‚ò∞</button>
        <div id="dropdown-menu">
            <a href="mypage.html">üé® ÎÇ¥ Ï†ïÎ≥¥ Î≥¥Í∏∞</a> 
            <a href="index.html">‚ú® ÏÉàÎ°úÏö¥ Ïù¥ÏïºÍ∏∞ ÏãúÏûë!</a> 
            <a href="analysis.html">üìä Ïö∞Î¶¨ Ïù¥ÏïºÍ∏∞ Î∂ÑÏÑù</a> 
            <a href="journal-list.html">üìñ Ïù¥ÏïºÍ∏∞ Î™®ÏùåÏßë</a> 
            <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">‚ùì Î°úÏßÄ ÏÇ¨Ïö© ÏÑ§Î™ÖÏÑú</a> 
        </div>
    </nav>

    <div id="meter-container"><div id="volume-level"></div></div>
    <div id="chat-window"></div>
    <div id="input-area">
        <button id="mic-button">üé§</button>
        <input id="chat-input" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off" />
        <button id="send-btn">‚û§</button>
    </div>

    <script src="./js/gnb.js" defer></script>

    <script type="module">
        import './js/firebase-config.js';
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
        import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
        import LOZEE_ANALYSIS from './js/lozee-analysis.js';
        import {
          saveJournalEntry,
          saveManualJournalEntry,
          updateTopicStats,
          updateUserOverallStats,
          logSessionStart,
          logSessionEnd
        } from './js/firebase-utils.js'; 
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        // --- ÏÉÅÌÉú Î≥ÄÏàò ---
        let skipTTS = false,
            hasGreeted = false,
            isProcessing = false;
        let chatHistory = [],
            selectedMain = null,
            isPlayingTTS = false;
        let conversationStartTime = null;
        let analysisNotificationShown = false;
        let journalReadyNotificationShown = false;
        let sessionTimeoutId = null;
        const SESSION_TIMEOUT_DURATION = 5 * 60 * 1000;
        let lastAiAnalysisData = null;
        let userTurnCountInSession = 0;
        let userCharCountInSession = 0;
        let previousTotalUserCharCountOverall = 0;
        let assistantMessageCount = 0,
            gptVerbosityPreference = 'default';
        let lastVerbosityPromptTime = 0,
            verbosityPromptCount = 0;
        const PREFERENCE_PROMPT_INTERVAL = 10 * 60 * 1000;
        let currentFirestoreSessionId = null;
        let awaitManualSave = false;
        let manualSaveConfirmed = false;
        let micButtonCurrentlyProcessing = false;

        // --- UI ÏöîÏÜå ---
        const chatWindow = document.getElementById('chat-window');
        const inputArea = document.getElementById('input-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const micButton = document.getElementById('mic-button');
        const meterLevel = document.getElementById('volume-level');
        // const topicArea = document.getElementById('topic-area'); // HTMLÏóê Ïã§Ï†ú Ïù¥ IDÎ•º Í∞ÄÏßÑ ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨

        // --- ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ---
        const userName = localStorage.getItem('lozee_username') || 'ÏπúÍµ¨';
        const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
        const currentUserEmail = localStorage.getItem('cbtUserEmail');
        let userType = localStorage.getItem('lozee_userType') || '';
        const voc = getKoreanVocativeParticle(userName);

        async function fetchPreviousUserCharCount() {
            if (!currentUserEmail) return 0;
            try {
                const userRef = doc(db, 'users', currentUserEmail);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().totalUserCharCount) {
                    return parseInt(userSnap.data().totalUserCharCount, 10) || 0;
                }
            } catch (error) {
                console.error("Firestore Ïù¥Ï†Ñ ÎàÑÏ†Å Í∏ÄÏûê Ïàò Î°úÎìú Ïò§Î•ò:", error);
            }
            return 0;
        }

        // --- Ï¥àÍ∏∞Ìôî Î°úÏßÅ ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('talk.html: DOMContentLoaded Ïù¥Î≤§Ìä∏ Î∞úÏÉù');
            if (currentUserEmail === 'unbearable_@naver.com') { // ÌÖåÏä§Ìä∏ Í≥ÑÏ†ï userType Í∞ïÏ†ú ÏÑ§Ï†ï
                userType = 'caregiver';
                localStorage.setItem('lozee_userType', 'caregiver');
            }
            if (!currentUserEmail) {
                alert("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥(Ïù¥Î©îÏùº)Í∞Ä ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
                window.location.href = 'index.html';
                return;
            }
            if (!userType) {
                alert("ÏÇ¨Ïö©Ïûê Ïú†Ìòï Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. ÏãúÏûë ÌéòÏù¥ÏßÄÏóêÏÑú Ïú†ÌòïÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                window.location.href = 'index.html';
                return;
            }

            conversationStartTime = Date.now();
            previousTotalUserCharCountOverall = await fetchPreviousUserCharCount();
            console.log("talk.html: Ïù¥Ï†Ñ ÎàÑÏ†Å ÏÇ¨Ïö©Ïûê Î∞úÌôî Í∏ÄÏûê Ïàò:", previousTotalUserCharCountOverall);
            resetSessionTimeout();

            let startedWithInitTopic = false;
            const initTopicDataString = localStorage.getItem('lozee_talk_init_topic');
            if (initTopicDataString) {
                try {
                    const initTopic = JSON.parse(initTopicDataString);
                    localStorage.removeItem('lozee_talk_init_topic');
                    if (initTopic.details) {
                        selectedMain = initTopic.details;
                        const initialMessageFromLozee = initTopic.prompt || `ÏßÄÎÇúÎ≤à '${selectedMain}' Ïù¥ÏïºÍ∏∞Ïóê Ïù¥Ïñ¥ÏÑú Îçî ÎÇòÎà†Î≥ºÍπå?`;
                        appendMessage(initialMessageFromLozee, 'assistant');
                        console.log(`talk.html: "${selectedMain}" Ï£ºÏ†ú Ïù¥Ïñ¥ÌïòÍ∏∞ ÏãúÏûë.`);
                        startChat(initialMessageFromLozee, 'topic_selection_init');
                        hasGreeted = true;
                        startedWithInitTopic = true;
                    } else {
                        console.warn("initTopic.detailsÍ∞Ä ÏóÜÏñ¥ Ïù¥Ïñ¥ÌïòÍ∏∞Î•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
                    }
                } catch (e) {
                    console.error("Ïù¥Ïñ¥ÌïòÍ∏∞ Ï£ºÏ†ú(lozee_talk_init_topic) ÌååÏã± Ïò§Î•ò:", e);
                    localStorage.removeItem('lozee_talk_init_topic');
                }
            }

            if (!startedWithInitTopic) {
                const greeting = getInitialGreeting(userName + voc, hasGreeted);
                appendMessage(greeting, 'assistant');
                hasGreeted = true;
                showMainTopics();
            }
        });

        function appendMessage(text, role) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + role;
            bubble.textContent = text;
            if (chatWindow) {
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            } else {
                console.error("appendMessage: chatWindow ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            }
        }

        function showJournalReadyNotification() {
            if (journalReadyNotificationShown) return;
            const notification = document.createElement('div');
            notification.className = 'journal-save-notification';
            notification.textContent = 'üìù Ïù¥ÏïºÍ∏∞Í∞Ä Ï∂©Î∂ÑÌûà ÏåìÏòÄÎÑ§Ïöî! Ïù¥ ÎåÄÌôîÎäî Ï¢ÖÎ£å Ïãú ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.';
            if (chatWindow) chatWindow.appendChild(notification);
            journalReadyNotificationShown = true;
        }

        function showAnalysisNotification() {
            if (analysisNotificationShown) return;
            const notification = document.createElement('div');
            notification.className = 'analysis-notification';
            notification.textContent = 'üìä Î∂ÑÏÑù ÏôÑÎ£å! (ÌÅ¥Î¶≠Ìï¥ÏÑú ÌôïÏù∏)';
            notification.onclick = () => {
                location.href = 'analysis.html';
            };
            if (chatWindow) chatWindow.appendChild(notification);
            analysisNotificationShown = true;
        }

        async function playTTSWithControl(txt) {
            if (isRec && recog && typeof recog.stop === 'function') {
                console.log("TTS Ïû¨ÏÉù Ï†Ñ STT Î™ÖÏãúÏ†Å Ï§ëÏßÄ");
                recog.stop();
            }
            if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
            else console.warn("stopCurrentTTS Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            if (skipTTS) {
                skipTTS = false;
                return Promise.resolve();
            }
            isPlayingTTS = true;
            try {
                if (typeof playTTSFromText === 'function') {
                    await playTTSFromText(txt, localStorage.getItem('lozee_voice'));
                } else {
                    console.warn("playTTSFromText Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                }
            } catch (error) {
                console.error("playTTSWithControl ÎÇ¥ TTS Ïû¨ÏÉù Ïò§Î•ò:", error);
            } finally {
                isPlayingTTS = false;
            }
        }

        let audioContext, analyser, source, dataArray, animId, streamRef;
        const LOW_COLOR = { r:0, g:200, b:0 };
        const MID_COLOR = { r:255, g:200, b:0 };
        const HIGH_COLOR = { r:255, g:69, b:0 };

        function interp(c1, c2, f) {
            return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;
        }

        function setupAudioAnalysis(stream) {
            if (audioContext && audioContext.state !== 'closed') {
                audioContext
                    .close()
                    .catch(e => console.warn("Ïù¥Ï†Ñ AudioContext Îã´Í∏∞ Ïò§Î•ò:", e));
            }
            audioContext = new AudioContext();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            streamRef = stream;
            draw();
        }

        function draw() {
            animId = requestAnimationFrame(draw);
            if (!analyser || !dataArray) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = dataArray.reduce((a, v) => a + v, 0);
            let avg = dataArray.length > 0 ? sum / dataArray.length : 0;
            let norm = Math.min(100, Math.max(0, (avg / 140) * 100));
            if (meterLevel) {
                meterLevel.style.width = norm + '%';
                meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${
                    norm <= 50
                        ? interp(LOW_COLOR, MID_COLOR, norm / 50)
                        : interp(MID_COLOR, HIGH_COLOR, (norm - 50) / 50)
                })`;
            }
            if (norm > 10 && isRec && isPlayingTTS && !skipTTS) {
                console.log("ÏÇ¨Ïö©Ïûê ÏùåÏÑ± Í∞êÏßÄ, TTS Ï§ëÎã® ÏãúÎèÑ");
                if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
                skipTTS = true;
            }
        }

        function stopAudio() {
            if (animId) cancelAnimationFrame(animId);
            if (source) source.disconnect();
            if (streamRef) streamRef.getTracks().forEach(track => track.stop());
            if (audioContext && audioContext.state !== 'closed') {
                audioContext
                    .close()
                    .catch(e => console.warn("AudioContext Îã´Í∏∞ Ïò§Î•ò:", e));
            }
            audioContext = null;
            if (meterLevel) {
                meterLevel.style.width = '0%';
                meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue(
                    '--volume-meter-container-bg'
                );
            }
        }

        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recog, isRec = false;
        if (SpeechRecognitionAPI) {
            recog = new SpeechRecognitionAPI();
            recog.continuous = true;
            recog.interimResults = true;
            recog.lang = 'ko-KR';
            recog.onstart = () => {
                isRec = true;
                if (micButton) micButton.classList.add('recording');
                micButtonCurrentlyProcessing = false;
            };
            recog.onend = () => {
                isRec = false;
                if (micButton) micButton.classList.remove('recording');
                stopAudio();
                micButtonCurrentlyProcessing = false;
            };
            recog.onresult = event => {
                resetSessionTimeout();
                let final_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    }
                }
                if (final_transcript) {
                    console.log("STT ÏµúÏ¢Ö Í≤∞Í≥º:", final_transcript);
                    if (chatInput) chatInput.value = '';
                    sendMessage(final_transcript.trim(), 'stt');
                }
            };
            recog.onerror = event => {
                console.error('Speech recognition error:', event.error);
                appendMessage('ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò: ' + event.error, 'assistant_feedback');
                if (isRec && recog) {
                    try {
                        recog.stop();
                    } catch (e) {
                        console.warn("recog.stop() Ïò§Î•ò:", e);
                    }
                }
                isRec = false;
                if (micButton) micButton.classList.remove('recording');
                stopAudio();
                micButtonCurrentlyProcessing = false;
            };
        } else {
            if (micButton) micButton.disabled = true;
            appendMessage(
                'Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.',
                'assistant_feedback'
            );
        }

        if (micButton) {
            micButton.onclick = async () => {
                if (isProcessing || micButtonCurrentlyProcessing) {
                    appendMessage(
                        "Ïû†ÏãúÎßåÏöî, Î°úÏßÄÍ∞Ä ÏùëÎãµÏùÑ Ï§ÄÎπÑ Ï§ëÏù¥Í±∞ÎÇò ÏùåÏÑ± Ïù∏ÏãùÏù¥ ÏãúÏûë/Ï¢ÖÎ£å Ï§ëÏù¥ÏóêÏöî. üòä",
                        "assistant_feedback"
                    );
                    return;
                }
                micButtonCurrentlyProcessing = true;
                if (isRec) {
                    if (recog && typeof recog.stop === 'function') recog.stop();
                } else {
                    if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
                    skipTTS = true;
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            audio: true
                        });
                        setupAudioAnalysis(stream);
                        if (recog && typeof recog.start === 'function') recog.start();
                    } catch (e) {
                        console.error('ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Ïò§Î•ò:', e);
                        appendMessage('ÎßàÏù¥ÌÅ¨ ÏÇ¨Ïö© Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'assistant_feedback');
                        micButtonCurrentlyProcessing = false;
                    }
                }
            };
        }

        function getTopicsForCurrentUser() {
            const ageForTopicLookup = userAge;
            console.log(
                `getTopicsForCurrentUser - userType: ${userType}, ageForTopicLookup (Î≥∏Ïù∏ÎÇòÏù¥): ${ageForTopicLookup}`
            );
            if (!counselingTopicsByAge) {
                console.error(
                    "counseling_topics.jsÎ•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò, counselingTopicsByAge Í∞ùÏ≤¥Í∞Ä export ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!"
                );
                return {};
            }
            let topicsForUserGroup;
            if (userType === 'directUser' && counselingTopicsByAge.directUser) {
                if (ageForTopicLookup < 11)
                    topicsForUserGroup =
                        counselingTopicsByAge.directUser['10ÏÑ∏ÎØ∏Îßå'] ||
                        counselingTopicsByAge.directUser['7-10'] ||
                        {};
                else if (ageForTopicLookup >= 11 && ageForTopicLookup <= 15)
                    topicsForUserGroup =
                        counselingTopicsByAge.directUser['11-15ÏÑ∏'] || {};
                else if (ageForTopicLookup >= 16 && ageForTopicLookup <= 29)
                    topicsForUserGroup =
                        counselingTopicsByAge.directUser['16-29ÏÑ∏'] || {};
                else
                    topicsForUserGroup =
                        counselingTopicsByAge.directUser['30-55ÏÑ∏'] ||
                        counselingTopicsByAge.directUser['16-29ÏÑ∏'] ||
                        {}; // 30-55ÏÑ∏ ÎòêÎäî Í∏∞Î≥∏Í∞í
            } else if (
                userType === 'caregiver' &&
                counselingTopicsByAge.caregiver
            ) {
                topicsForUserGroup = counselingTopicsByAge.caregiver || {};
            } else {
                console.warn(
                    `Ïïå Ïàò ÏóÜÍ±∞ÎÇò ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÏÇ¨Ïö©Ïûê Ïú†Ìòï(${userType})ÏûÖÎãàÎã§. Í∏∞Î≥∏ Ï£ºÏ†úÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.`
                );
                topicsForUserGroup = counselingTopicsByAge.directUser
                    ? counselingTopicsByAge.directUser['11-15ÏÑ∏'] || {}
                    : {};
            }
            console.log(
                "getTopicsForCurrentUser - Î∞òÌôòÎê† topicsForUserGroup:",
                JSON.stringify(topicsForUserGroup, null, 2)
            );
            if (!topicsForUserGroup || Object.keys(topicsForUserGroup).length === 0) {
                console.warn(
                    `getTopicsForCurrentUser: ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú ÏÇ¨Ïö©Ïûê/ÎÇòÏù¥Ïóê ÎßûÎäî Ï£ºÏ†ú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. counseling_topics.js ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`
                );
                return {};
            }
            return topicsForUserGroup;
        }

        function displayOptionsInChat(optionsArray, onSelectCallback) {
            if (!chatWindow) {
                console.error(
                    "displayOptionsInChat: chatWindow ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
                );
                return;
            }
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'chat-options-container';
            const buttons = [];
            if (!optionsArray || !Array.isArray(optionsArray)) {
                console.error(
                    "displayOptionsInChat: optionsArrayÍ∞Ä Ïú†Ìö®Ìïú Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§."
                );
                return;
            }
            optionsArray.forEach(optionObject => {
                let buttonText;
                let valueToCallback;
                if (typeof optionObject === 'string') {
                    buttonText = optionObject;
                    valueToCallback = optionObject;
                } else if (
                    optionObject &&
                    typeof optionObject.displayText !== 'undefined'
                ) {
                    buttonText = optionObject.icon
                        ? `${optionObject.icon} ${optionObject.displayText}`
                        : optionObject.displayText;
                    valueToCallback = optionObject.displayText;
                } else {
                    console.warn(
                        "displayOptionsInChat: ÏûòÎ™ªÎêú ÌòïÏãùÏùò ÏòµÏÖò:",
                        optionObject
                    );
                    return;
                }
                const button = document.createElement('button');
                button.className = 'chat-option-btn';
                button.textContent = buttonText;
                if (optionObject && optionObject.isContinuation) {
                    button.classList.add('continue-topic-btn');
                }
                if (optionObject && optionObject.isManualSave) {
                    button.classList.add('manual-save-btn');
                }
                button.onclick = () => {
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        if (btn === button) {
                            btn.classList.add('selected');
                        }
                    });
                    onSelectCallback(valueToCallback, optionObject);
                };
                optionsContainer.appendChild(button);
                buttons.push(button);
            });
            chatWindow.appendChild(optionsContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showMainTopics() {
            console.log("showMainTopics Ìï®Ïàò Ïã§ÌñâÎê®");
            appendMessage('Ïñ¥Îñ§ Ïù¥ÏïºÍ∏∞Î•º ÎÇòÎà†Î≥ºÍπå?', 'assistant');
            const currentUserTopics = getTopicsForCurrentUser();
            let topicsWithOptions = [];
            const continueTopicDataFromPlans = localStorage.getItem(
                'lozee_continue_topic'
            );
            if (continueTopicDataFromPlans) {
                try {
                    const topicToContinue = JSON.parse(continueTopicDataFromPlans);
                    topicsWithOptions.push({
                        icon: '‚Ü™Ô∏è',
                        displayText: `[ÏïΩÏÜç] ${
                            topicToContinue.details || 'Ïù¥Ï†Ñ ÏÉùÍ∞Å Ïù¥Ïñ¥Í∞ÄÍ∏∞'
                        }`,
                        isContinuation: true,
                        continueDetails: topicToContinue,
                        type: 'mypage_plan'
                    });
                } catch (e) {
                    console.error("Î°úÏßÄÏôÄÏùò ÏïΩÏÜç ÌååÏã± Ïò§Î•ò:", e);
                    localStorage.removeItem('lozee_continue_topic');
                }
            }
            if (
                currentUserTopics &&
                typeof currentUserTopics === 'object' &&
                Object.keys(currentUserTopics).length > 0
            ) {
                const categoryNames = Object.keys(currentUserTopics);
                console.log(
                    "showMainTopics - ÏÉùÏÑ±Ìï† Ï£ºÏ†ú Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö:",
                    categoryNames
                );
                const categoryOptions = categoryNames.map(categoryName => {
                    let icon = 'üí¨';
                    if (
                        currentUserTopics[categoryName] &&
                        Array.isArray(currentUserTopics[categoryName]) &&
                        currentUserTopics[categoryName].length > 0 &&
                        currentUserTopics[categoryName][0].icon
                    ) {
                        icon = currentUserTopics[categoryName][0].icon;
                    }
                    return {
                        icon: icon,
                        displayText: categoryName,
                        isContinuation: false
                    };
                });
                topicsWithOptions.push(...categoryOptions);
            } else {
                console.warn(
                    `showMainTopics: counseling_topics.jsÏóêÏÑú Ï£ºÏ†úÎ•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.`
                );
            }
            topicsWithOptions.push({
                icon: 'üó£Ô∏è',
                displayText: 'ÏûêÏú†Ï£ºÏ†ú',
                isContinuation: false
            });
            console.log(
                "showMainTopics - ÏµúÏ¢Ö Ï£ºÏ†ú ÏÑ†ÌÉù ÏòµÏÖò:",
                JSON.stringify(topicsWithOptions, null, 2)
            );
            displayOptionsInChat(
                topicsWithOptions,
                (selectedText, fullOptionObject) => {
                    selectedMain = selectedText;
                    if (fullOptionObject && fullOptionObject.isContinuation) {
                        localStorage.removeItem('lozee_continue_topic');
                        selectedMain =
                            fullOptionObject.continueDetails.details ||
                            selectedText;
                        appendMessage(
                            selectedMain + ' Ïù¥ÏïºÍ∏∞Î•º Ïù¥Ïñ¥Í∞àÍ≤å!',
                            'assistant'
                        );
                        const continueMessage =
                            fullOptionObject.continueDetails.prompt ||
                            `Ï†ÄÎ≤àÏóê Ïù¥ÏïºÍ∏∞ÌñàÎçò '${selectedMain}'Ïóê ÎåÄÌï¥ Í≥ÑÏÜç Ïù¥ÏïºÍ∏∞Ìï¥Î≥¥Ïûê.`;
                        startChat(continueMessage, 'topic_selection_init');
                    } else if (selectedMain === 'ÏûêÏú†Ï£ºÏ†ú') {
                        appendMessage(selectedMain + ' Ïù¥ÏïºÍ∏∞Î•º ÏÑ†ÌÉùÌñàÍµ¨ÎÇò!', 'assistant');
                        const message = 'ÎÑ§Í∞Ä Ï†ïÌïòÎ©¥ Îèº. Ïñ¥Îñ§ Ïù¥ÏïºÍ∏∞Í∞Ä ÌïòÍ≥† Ïã∂Ïñ¥?';
                        appendMessage(message, 'assistant');
                        if (inputArea) inputArea.style.display = 'flex';
                        if (chatInput) chatInput.focus();
                    } else {
                        appendMessage(selectedMain + ' Ïù¥ÏïºÍ∏∞Î•º ÏÑ†ÌÉùÌñàÍµ¨ÎÇò!', 'assistant');
                        setTimeout(showSubTopics, 300);
                    }
                }
            );
        }

        function showSubTopics() {
            if (!selectedMain || selectedMain === 'ÏûêÏú†Ï£ºÏ†ú') {
                if (selectedMain === 'ÏûêÏú†Ï£ºÏ†ú')
                    startChat('', 'topic_selection_init');
                return;
            }
            const currentUserTopicCategories = getTopicsForCurrentUser();
            let subtopicOptions = [];
            if (
                currentUserTopicCategories &&
                currentUserTopicCategories[selectedMain] &&
                Array.isArray(currentUserTopicCategories[selectedMain])
            ) {
                subtopicOptions =
                    currentUserTopicCategories[selectedMain];
            } else {
                subtopicOptions = [
                    {
                        icon: 'üí¨',
                        displayText: 'Ïù¥ Ï£ºÏ†úÏóê ÎåÄÌï¥ ÏûêÏú†Î°≠Í≤å Ïù¥ÏïºÍ∏∞Ìï¥ Ï§ÑÎûò?'
                    }
                ];
            }
            if (!subtopicOptions || subtopicOptions.length === 0) {
                startChat(`'${selectedMain}'Ïóê ÎåÄÌï¥ ÏûêÏú†Î°≠Í≤å Ïù¥ÏïºÍ∏∞Ìï¥Ï§ò.`, 'topic_selection_init');
                return;
            }
            appendMessage('Ï°∞Í∏à Îçî Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Ïù¥ÏïºÍ∏∞Ìï¥ Ï§ÑÎûò?', 'assistant');
            displayOptionsInChat(
                subtopicOptions,
                (selectedSubtopicText, fullOptionObject) => {
                    startChat(selectedSubtopicText, 'topic_selection_init');
                }
            );
        }

        function startChat(initText, inputMethod = 'topic_selection_init') {
            console.log(
                "startChat Ìï®Ïàò ÏãúÏûëÎê®, Ï¥àÍ∏∞ Î©îÏãúÏßÄ:",
                initText,
                "ÏûÖÎ†•Î∞©Ïãù:",
                inputMethod,
                "ÌòÑÏû¨ selectedMain:",
                selectedMain
            );
            if (inputArea) inputArea.style.display = 'flex';
            if (
                currentUserEmail &&
                selectedMain &&
                !currentFirestoreSessionId &&
                typeof logSessionStart === 'function'
            ) {
                logSessionStart(currentUserEmail, selectedMain).then(id => {
                    if (id) currentFirestoreSessionId = id;
                });
            }
            if (initText && String(initText).trim() !== '') {
                sendMessage(initText, inputMethod);
            } else {
                if (chatInput) chatInput.focus();
            }
        }

        function askForVerbosityPreference() {
            /* ‚Ä¶ (Ïù¥Ï†ÑÍ≥º ÎèôÏùº) ‚Ä¶ */
        }

        function resetSessionTimeout() {
            /* ‚Ä¶ (Ïù¥Ï†ÑÍ≥º ÎèôÏùº, Firestore users ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ Ìè¨Ìï®) ‚Ä¶ */
        }

        async function sendMessage(text, inputMethod = 'text') {
            if (
                !selectedMain &&
                inputMethod !== 'topic_selection_init' &&
                text.trim() !== ''
            ) {
                appendMessage(
                    "Ïù¥ÏïºÍ∏∞Î•º ÏãúÏûëÌïòÍ∏∞ Ï†ÑÏóê Î®ºÏ†Ä Ïñ¥Îñ§ Ï£ºÏ†úÎ°ú Ïù¥ÏïºÍ∏∞Ìï†ÏßÄ ÏÑ†ÌÉùÌï¥ Ï§ÑÎûò? üòä",
                    "assistant_feedback"
                );
                showMainTopics();
                isProcessing = false;
                if (sendBtn) sendBtn.classList.remove('loading');
                return;
            }
            if (!text || String(text).trim() === '' || isProcessing) return;
            resetSessionTimeout();
            isProcessing = true;
            micButtonCurrentlyProcessing = true;
            if (sendBtn) sendBtn.classList.add('loading');
            if (!conversationStartTime) conversationStartTime = Date.now();

            if (inputMethod !== 'topic_selection_init') {
                appendMessage(text, 'user');
                userTurnCountInSession++;
            }
            chatHistory.push({ role: 'user', content: text });
            if (inputMethod !== 'topic_selection_init') {
                userCharCountInSession += text.length;
            }

            if (chatInput) chatInput.value = '';
            const thinkingBubble = document.createElement('div');
            thinkingBubble.className = 'bubble assistant thinking';
            thinkingBubble.textContent = 'ÏÉùÍ∞ÅÏ§ëÏù¥Ïïº...';
            if (chatWindow) {
                chatWindow.appendChild(thinkingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            try {
                const elapsedTimeInMinutesForGPT =
                    (Date.now() - conversationStartTime) / (1000 * 60);
                const userDiagnoses = JSON.parse(
                    localStorage.getItem('lozee_diagnoses') || '[]'
                );
                const res = await getGptResponse(text, {
                    chatHistory,
                    verbosity: gptVerbosityPreference,
                    elapsedTime: elapsedTimeInMinutesForGPT,
                    userTraits: userDiagnoses
                });

                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 78Î≤à Ï§Ñ Ïò§Î•ò ÏàòÏ†ï(Î∂àÌïÑÏöîÌïú '}' Ï†úÍ±∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (!res.ok) {
                    // GPT API Ïò§Î•ò Ï≤òÎ¶¨ (Ïòà: 500 ÏùëÎãµ Îì±)
                    if (thinkingBubble) thinkingBubble.remove();
                    appendMessage(
                        'Ïù¥Îü∞, Î°úÏßÄÍ∞Ä ÏßÄÍ∏à Ï¢Ä ÏïÑÌîàÍ∞Ä Î¥ê. Ïû†Ïãú ÌõÑÏóê Îã§Ïãú ÏãúÎèÑÌï¥ Ï§ÑÎûò? üò•',
                        'assistant'
                    );
                    isProcessing = false;
                    micButtonCurrentlyProcessing = false;
                    if (sendBtn) sendBtn.classList.remove('loading');
                    return;
                }
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                const d = await res.json(); // ÏÑúÎ≤ÑÎäî { text: "...", analysis: { ... } } ÌòïÌÉúÎ°ú ÏùëÎãµ

                if (thinkingBubble) thinkingBubble.remove();

                // ÏÑúÎ≤ÑÍ∞Ä Ïù¥ÎØ∏ ÌÖçÏä§Ìä∏ÏôÄ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÎ¶¨Ìï¥ÏÑú Ï†ÑÎã¨ÌïúÎã§Í≥† Í∞ÄÏ†ï
                const cleanText = d.text || "ÎØ∏ÏïàÌïòÏßÄÎßå, ÏßÄÍ∏àÏùÄ ÎãµÎ≥ÄÏùÑ ÎìúÎ¶¨Í∏∞ Ïñ¥Î†µÎÑ§.";
                const analysisDataFromGpt = d.analysis || {};

                lastAiAnalysisData = analysisDataFromGpt;
                appendMessage(cleanText, 'assistant');

                if (!skipTTS) {
                    await playTTSWithControl(cleanText);
                }
                skipTTS = false;

                chatHistory.push({ role: 'assistant', content: cleanText });
                assistantMessageCount++;

                // ‚Ä¶ Ïù¥ÌõÑ Ï†ÄÎÑê Ï†ÄÏû• Î∞è Î∂ÑÏÑù ÏïåÎ¶º Î°úÏßÅ (Îã§Ïùå Ï§ÑÎ∂ÄÌÑ∞ 165Î≤à Ï§Ñ Ïò§Î•ò Í∞úÏÑ†) ‚Ä¶
                if (!skipTTS) {
                    await playTTSWithControl(cleanText);
                }
                skipTTS = false;

                chatHistory.push({ role: 'assistant', content: cleanText });
                assistantMessageCount++;

                if (
                    userCharCountInSession >= 800 &&
                    !journalReadyNotificationShown &&
                    selectedMain
                ) {
                    showJournalReadyNotification();
                }

                const currentSessionElapsedTime =
                    (Date.now() - conversationStartTime) / (1000 * 60);
                const finalUserCharCountForAnalysis =
                    previousTotalUserCharCountOverall +
                    userCharCountInSession;
                console.log(
                    `[Î∂ÑÏÑù Ï°∞Í±¥ Ï≤¥ÌÅ¨] ÏãúÍ∞Ñ: ${currentSessionElapsedTime.toFixed(
                        1
                    )}Î∂Ñ (Í∏∞Ï§Ä:10), ÏÇ¨Ïö©Ïûê ÌÑ¥: ${userTurnCountInSession} (Í∏∞Ï§Ä:20), Ï¥ù Í∏ÄÏûêÏàò: ${finalUserCharCountForAnalysis} (Í∏∞Ï§Ä:1500)`
                );

                if (
                    currentSessionElapsedTime >= 10 &&
                    userTurnCountInSession >= 20 &&
                    finalUserCharCountForAnalysis >= 1500 &&
                    !analysisNotificationShown
                ) {
                    console.log(`[Î∂ÑÏÑù Ï°∞Í±¥ Ï∂©Ï°±!] ÏÉÅÏÑ∏ Î∂ÑÏÑù Ïã§Ìñâ Î∞è localStorage Ï†ÄÏû•`);
                    let detailedAnalysisDataForStorage = {
                        ...(lastAiAnalysisData || {})
                    };

                    if (
                        LOZEE_ANALYSIS &&
                        typeof LOZEE_ANALYSIS.inferAgeAndLanguage === 'function'
                    ) {
                        try {
                            const conversationTextForAgeAnalysis = chatHistory
                                .map(item => `${item.role}: ${item.content}`)
                                .join('\n');
                            const ageAnalysisResult =
                                await LOZEE_ANALYSIS.inferAgeAndLanguage(
                                    conversationTextForAgeAnalysis
                                );

                            if (
                                ageAnalysisResult &&
                                !ageAnalysisResult.error
                            ) {
                                detailedAnalysisDataForStorage.ageLanguageAnalysis = {
                                    predictedAge:
                                        ageAnalysisResult.predicted_age_group ||
                                        "Î∂ÑÏÑù Ï§ë...",
                                    feedback:
                                        ageAnalysisResult.feedback_message ||
                                        "Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú ÌîºÎìúÎ∞±ÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§."
                                };
                                console.log(
                                    "Ïñ∏Ïñ¥ Ïó∞Î†π Î∂ÑÏÑù Í≤∞Í≥º Ï∂îÍ∞ÄÎê®:",
                                    detailedAnalysisDataForStorage.ageLanguageAnalysis
                                );
                            } else {
                                console.warn(
                                    "Ïñ∏Ïñ¥ Ïó∞Î†π Î∂ÑÏÑù Ïã§Ìå® ÎòêÎäî Ïò§Î•ò:",
                                    ageAnalysisResult?.error
                                );
                            }
                        } catch (langAnalysisError) {
                            console.error(
                                "inferAgeAndLanguage Ìï®Ïàò Ïã§Ìñâ Ï§ë Ïò§Î•ò:",
                                langAnalysisError
                            );
                        }
                    }

                    const dataToStoreInLocalStorage = {
                        results: detailedAnalysisDataForStorage,
                        accumulatedDurationMinutes: currentSessionElapsedTime
                    };

                    const gptProvidedAnalysisExists =
                        Object.keys(lastAiAnalysisData || {}).length > 0;

                    if (
                        gptProvidedAnalysisExists ||
                        detailedAnalysisDataForStorage.ageLanguageAnalysis
                    ) {
                        localStorage.setItem(
                            'lozee_conversation_analysis',
                            JSON.stringify(dataToStoreInLocalStorage)
                        );
                        console.log(
                            "localStorageÏóê 'lozee_conversation_analysis' Ï†ÄÏû• ÏôÑÎ£å:",
                            dataToStoreInLocalStorage
                        );
                        showAnalysisNotification();
                        analysisNotificationShown = true;
                    } else {
                        console.log(
                            "ÏÉùÏÑ±Îêú Ïú†ÏùòÎØ∏Ìïú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ ÏïåÎ¶º ÌëúÏãú Î∞è localStorage Ï†ÄÏû• Ïïà Ìï®."
                        );
                    }
                } else if (!analysisNotificationShown) {
                    console.log("[Î∂ÑÏÑù Ï°∞Í±¥ ÎØ∏Ï∂©Ï°± ÎòêÎäî Ïù¥ÎØ∏ ÏïåÎ¶º ÌëúÏãúÎê®]");
                }

                if (
                    cleanText.includes("Î∞©Î≤ïÏùÑ ÏïåÎ†§Ï§ÑÍπå") &&
                    typeof displayOptionsInChat === 'function'
                ) {
                    /* ‚Ä¶ */
                } else if (awaitManualSave && manualSaveConfirmed) {
                    /* ‚Ä¶ */
                }
            } catch (error) {
                /* ‚Ä¶ (Ïò§Î•ò Ï≤òÎ¶¨) ‚Ä¶ */
            } finally {
                isProcessing = false;
                micButtonCurrentlyProcessing = false;
                if (sendBtn) sendBtn.classList.remove('loading');
            }
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 165Î≤à Ï§Ñ Ïò§Î•ò ÏàòÏ†ï ÎÅù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 334Î≤à Ï§Ñ Ïò§Î•ò ÏàòÏ†ï (Ìï®Ïàò/Î∏îÎ°ù Îã´Ìûò Ï†ïÎ¶¨) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // --- Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ---
        if (sendBtn) {
            sendBtn.addEventListener('click', () => {
                resetSessionTimeout();
                sendMessage(chatInput.value, 'text');
            });
        }
        if (chatInput) {
            chatInput.addEventListener('keydown', e => {
                resetSessionTimeout();
                if (isPlayingTTS) {
                    if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
                    skipTTS = true;
                }
                if (e.key === 'Enter' && !e.isComposing) {
                    e.preventDefault();
                    sendMessage(chatInput.value, 'text');
                }
            });
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 334Î≤à Ï§Ñ Ïò§Î•ò ÏàòÏ†ï ÎÅù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    </script>
</body>
</html>
