<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE 상담</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display:flex; flex-direction:column; height:100vh; margin:0; font-family:'KoPubWorld Dotum',sans-serif; }
    #main-header { background:#0095FF; color:#fff; padding:1rem; text-align:center; font-size:1.25rem; }
    #mic-indicator { text-align:center; padding:0.5rem; font-size:0.9rem; background:#eef; }
    #chat-window { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .bubble { max-width:80%; padding:0.75rem 1rem; border-radius:1rem; line-height:1.4; white-space:pre-wrap; }
    .user { background:#fff9c4; color:#333; align-self:flex-end; border-bottom-right-radius:0.25rem; }
    .ai   { background:#0095FF;  color:#fff; align-self:flex-start; border-bottom-left-radius:0.25rem; }
    #silence-banner { text-align:center; padding:0.5rem; background:#f0f0f0; color:#666; font-size:0.9rem; display:none; }
    #loading-indicator { display:none; text-align:center; padding:0.5rem; color:#555; font-style:italic; }
  </style>
</head>
<body>
  <header id="main-header">LOZEE 상담</header>
  <div id="mic-indicator">🔵 대기 중</div>
  <div id="chat-window"></div>
  <div id="silence-banner">말씀하시면 바로 들어드려요</div>
  <div id="loading-indicator">처리 중...</div>

<script type="module">
import { playTTSFromText } from './js/tts.js';
import { getGptResponse } from './js/gpt-dialog.js';

// 상태 머신
const State = { READY:'READY', RECORD:'RECORD', SILENCE:'SILENCE', PROCESS:'PROCESS' };
let currentState = State.READY;
let silenceTimer;
let recognition;
let userBubble;

// DOM 요소
const chatWindow   = document.getElementById('chat-window');
const micIndicator = document.getElementById('mic-indicator');
const silenceBanner= document.getElementById('silence-banner');
const loading      = document.getElementById('loading-indicator');

// 저장된 설정
const ttsVoice = localStorage.getItem('lozee_tts_voice') || 'ko-KR-Chirp3-HD-Vindemiatrix';

// 메시지 출력
function appendMessage(text, role) {
  const div = document.createElement('div');
  div.className = `bubble ${role}`;
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return div;
}
function setMicStatus(text)   { micIndicator.textContent = text; }
function showBanner(on)      { silenceBanner.style.display = on ? 'block' : 'none'; }
function showLoading(on)     { loading.style.display = on ? 'block' : 'none'; }
function transition(to) {
  clearTimeout(silenceTimer);
  currentState = to;
  showBanner(to === State.SILENCE);
  console.log('State →', to);
}

// 톤 프롬프트 생성
function buildSystemPrompt(extra='') {
  const emotions = JSON.parse(localStorage.getItem('lozee_selected_emotions') || '[]');
  const emoText = emotions.length ? `유저 감정: ${emotions.map(e=>e.sub).join(', ')}.` : '';
  const age = parseInt(localStorage.getItem('lozee_user_age'),10) || 0;
  const tone = age >= 56 ? '존댓말로만 답하세요.' : '반말로만 답하세요.';
  return [emoText, extra, tone].filter(Boolean).join(' ');
}

// 사용자 발화 처리
async function handleUserTurn(text, extraPrompt='') {
  appendMessage(text,'user');
  showLoading(true);
  const systemPrompt = buildSystemPrompt(extraPrompt);
  const res = await getGptResponse(text, systemPrompt);
  const aiText = typeof res === 'string' ? res : (res.error || res.rephrasing || '응답이 없습니다.');
  appendMessage(aiText,'ai');
  await playTTSFromText(aiText,ttsVoice);
  showLoading(false);
}

// STT 초기화 및 권한 요청
async function initSTT() {
  // HTTPS 또는 localhost 확인 필요
  try {
    await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (err) {
    appendMessage('마이크 권한이 필요합니다. 설정에서 허용해주세요.', 'ai');
    console.warn('마이크 권한 오류:', err);
    return;
  }
  // Web Speech API 설정
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'ko-KR';
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = (e) => {
    let interim='', final='';
    for (let i=e.resultIndex; i<e.results.length; i++) {
      const t = e.results[i][0].transcript;
      e.results[i].isFinal ? final+=t : interim+=t;
    }
    if (interim) userBubble.textContent = interim;
    if (final)   userBubble.textContent = final;
  };
  recognition.onspeechstart = () => onVoiceStart();
  recognition.onspeechend   = () => onVoiceEnd();
  recognition.onerror       = (e) => console.warn('SpeechRecognition 오류:',e);

  // 즉시 대기 상태에서 STT 시작
  transition(State.READY);
  recognition.start();
  setMicStatus('🔴 듣고 있어요');
}

function onVoiceStart() {
  if (currentState === State.READY || currentState === State.SILENCE) {
    transition(State.RECORD);
    setMicStatus('🔴 듣고 있어요');
    userBubble = appendMessage('','user');
  }
}

function onVoiceEnd() {
  if (currentState === State.RECORD) {
    transition(State.SILENCE);
    setMicStatus('🔵 대기 중');
    recognition.stop();
    // 20초 무음 후 처리
    silenceTimer = setTimeout(async () => {
      await handleUserTurn(userBubble.textContent);
      transition(State.READY);
      recognition.start();
      setMicStatus('🔴 듣고 있어요');
    }, 20000);
  }
}

// 인트로 처리
async function initIntro() {
  const intro = localStorage.getItem('lozee_user_typed_intro');
  if (intro) {
    await handleUserTurn(intro);
    localStorage.removeItem('lozee_user_typed_intro');
  }
}

// 페이지 초기화
window.addEventListener('DOMContentLoaded', async()=>{
  await initSTT();
  await initIntro();
});
</script>
</body>
</html>