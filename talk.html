<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë³µì› ë° ì¬ì •ë¹„ */
    :root {
      --primary-color: #6e8efb;
      --secondary-color: #354157;
      --background-color: #2a3340;
      --text-color: #fff;
      --input-background: #f0f0f0;
      --bot-bubble-bg: var(--input-background);
      --bot-bubble-text: #333;
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #fff;
      --gnb-height: 56px;
      --chat-input-height: 70px;
      --gemini-purple: #7B68EE;
      --volume-meter-default-bg: var(--primary-color);
      --meter-top-margin: 8px;
      --gnb-dropdown-border-color: #4a5568;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* GNB (í–„ë²„ê±° ë©”ë‰´ ë°©ì‹ ë³µì›) */
    #gnb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--background-color);
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gemini-purple);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gemini-purple);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--background-color);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.25);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 500px;
    }

    #dropdown-menu a {
      display: block;
      color: var(--text-color);
      text-decoration: none;
      padding: 12px 16px;
      font-size: 0.95em;
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child { border-bottom: none; }
    #dropdown-menu a:hover {
      background-color: var(--secondary-color);
    }

    /* ìŒëŸ‰ ë°” */
    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: 6px;
      background-color: var(--secondary-color);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-default-bg);
      border-radius: 3px;
      transition: width 0.05s linear;
    }

    /* ì±„íŒ… ì˜ì—­ */
    #chat-container {
      flex-grow: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + 6px + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: var(--chat-input-height);
    }
    
    #analysis-container { /* ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        padding: 10px;
        background: #1e2a38; /* ì–´ë‘ìš´ ë°°ê²½ */
        color: #ccc; /* ë°ì€ í…ìŠ¤íŠ¸ */
        font-size: 0.85em;
        max-height: 150px; /* í•„ìš”ì‹œ ì¡°ì • */
        overflow-y: auto;
        border-top: 1px solid var(--secondary-color);
        margin-bottom: var(--chat-input-height); /* ì…ë ¥ì°½ì— ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ */
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€, ë¶„ì„ ê²°ê³¼ ìˆì„ ë•Œ JSë¡œ ë³´ì´ê²Œ ì²˜ë¦¬ */
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.5;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background-color: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.bot {
      background-color: var(--bot-bubble-bg);
      color: var(--bot-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.user.interim { opacity:.7; }
    .bubble.system-error {
        background-color: #ffe0e0;
        color: #c0392b;
        align-self: center;
        max-width: 80%;
        text-align: center;
        font-size: 0.9em;
        border: 1px solid #c0392b;
    }

    /* ì…ë ¥ ì˜ì—­ ìŠ¤íƒ€ì¼ ë³µì› */
    #chat-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-height);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background-color: var(--secondary-color);
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 22px;
      border: 1px solid #4a5568;
      font-size: 1em;
      background-color: var(--input-background);
      color: #333;
      height: 44px;
      box-sizing: border-box;
    }
    #chat-input::placeholder { color: #777; }

    #mic-button,
    #send-button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: var(--text-color);
      font-size: 1.3em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      margin-left: 8px;
    }
    #mic-button:hover,
    #send-button:hover {
      background-color: #5a7edf;
    }
    #mic-button.recording {
        background-color: #e74c3c; /* ë¹¨ê°„ìƒ‰ ë°°ê²½ */
    }
    #send-button.loading {
        background:#999;
        cursor:default;
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-container::-webkit-scrollbar-thumb { background: var(--gnb-dropdown-border-color); border-radius: 4px; }
    #chat-container::-webkit-scrollbar-thumb:hover { background: #5a7edf; }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (ì¤€ë¹„ì¤‘)</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ìµœê·¼ ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ì£¼ì œë³„ ëŒ€í™” ëª©ë¡</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ì†Œê°œ</a>
    </div>
  </nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-container"></div>
  <div id="analysis-container"></div> <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off"/>
    <button id="send-button" title="ë©”ì‹œì§€ ì „ì†¡">â®</button>
  </div>

  <script src="./js/gpt-dialog.js"></script>
  <script src="./js/tts.js"></script>
  <script src="./js/basic-features.js"></script>
  <script src="./js/literacyPatternCheckRenderer.js"></script>

  <script> // ì¼ë°˜ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ìœ¼ë¡œ ë³€ê²½
    async function initializeApp() {
      const chatContainer = document.getElementById('chat-container');
      const analysisContainer = document.getElementById('analysis-container');

      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        if (role === 'system-error') el.classList.add('system-error');
        if (chatContainer) {
            chatContainer.appendChild(el);
            requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
        } else {
            console.error("Chat container not found. Message:", text);
            if (role === 'system-error') alert("ì˜¤ë¥˜: " + text);
        }
      }

      if (!chatContainer) {
          console.error("CRITICAL: chatContainer not found.");
          document.body.innerHTML = '<div style="color:red;text-align:center;padding:50px;">ì±„íŒ… UI ë¡œë“œ ì‹¤íŒ¨! (chat-container ëˆ„ë½)</div>';
          return;
      }

      // --- ì „ì—­ ê°ì²´ì—ì„œ í•¨ìˆ˜ ê°€ì ¸ì˜¤ê¸° ë° í´ë°± ì„¤ì • ---
      const playTTSFromText = window.LOZEE_TTS?.playTTSFromText || (async (text, voice) => {
        console.warn(`TTS Fallback (ìŒì„±: ${voice}): ${text}. tts.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜.`);
        appendBubble("ì•Œë¦¼: ìŒì„± ì¶œë ¥(TTS) ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (tts.js í™•ì¸ í•„ìš”)", "system-error");
      });
      const DEFAULT_VOICE = window.LOZEE_TTS?.DEFAULT_VOICE || 'default-fallback-voice';

      const getGptResponse = window.LOZEE_DIALOG?.getGptResponse || (async (text) => {
        console.error("getGptResponse ì‚¬ìš© ë¶ˆê°€ (gpt-dialog.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜).");
        appendBubble("ì˜¤ë¥˜: ëŒ€í™” ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (gpt-dialog.js í™•ì¸ í•„ìš”)", "system-error");
        return Promise.resolve({ ok: false, status: 503, json: async () => ({ text: "ì˜¤ë¥˜: ì‘ë‹µ ì²˜ë¦¬ ë¶ˆê°€."}) });
      });
      const getFirstQuestion = window.LOZEE_DIALOG?.getFirstQuestion || ((userAge, topic) => {
        console.error("getFirstQuestion ì‚¬ìš© ë¶ˆê°€ (gpt-dialog.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜).");
        appendBubble("ì˜¤ë¥˜: ëŒ€í™” ì‹œì‘ ì§ˆë¬¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (gpt-dialog.js í™•ì¸ í•„ìš”)", "system-error");
        return "ì˜¤ë¥˜: ëŒ€í™” ì‹œì‘ ë¶ˆê°€.";
      });

      const trackTime = window.LOZEE_BASIC_FEATURES?.trackTime || (() => console.warn("trackTime ì‚¬ìš© ë¶ˆê°€ (basic-features.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜)."));
      const trackEmotionTone = window.LOZEE_BASIC_FEATURES?.trackEmotionTone || (() => console.warn("trackEmotionTone ì‚¬ìš© ë¶ˆê°€ (basic-features.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜)."));
      const trackSituation = window.LOZEE_BASIC_FEATURES?.trackSituation || (() => console.warn("trackSituation ì‚¬ìš© ë¶ˆê°€ (basic-features.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜)."));
      const renderLiteracyAnalysis = window.LOZEE_LITERACY?.renderLiteracyAnalysis || ((result, el) => {
          console.warn("renderLiteracyAnalysis ì‚¬ìš© ë¶ˆê°€ (literacyPatternCheckRenderer.js ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” í•¨ìˆ˜ ë¯¸ì •ì˜).");
          if(el) el.innerHTML = "<p>ë¬¸í•´ë ¥ ë¶„ì„ ê²°ê³¼ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
      });

      // --- DOM ìš”ì†Œ ì°¸ì¡° ---
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');
      const menuToggle    = document.getElementById('menu-toggle');
      const dropdownMenu  = document.getElementById('dropdown-menu');

      // --- GNB ë©”ë‰´ í† ê¸€ ---
      if (menuToggle && dropdownMenu) {
        menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
        document.addEventListener('click', (event) => {
          const gnb = document.getElementById('gnb');
          if (gnb && !gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
            dropdownMenu.classList.remove('show');
          }
        });
      }

      // --- ì˜¤ë””ì˜¤ ë¶„ì„ ë° ì‹œê°í™” (ì´ì „ ì½”ë“œ ìœ ì§€) ---
      let audioContext, analyser, microphoneSource, dataArray, volumeMeterAnimationId, analyserStream;
      const LOW_COLOR = { r: 0, g: 200, b: 0 }, MID_COLOR = { r: 255, g: 200, b: 0 }, HIGH_COLOR = { r: 255, g: 69, b: 0 };
      function interpolateColor(c1,c2,f){const r=Math.round(c1.r+f*(c2.r-c1.r)),g=Math.round(c1.g+f*(c2.g-c1.g)),b=Math.round(c1.b+f*(c2.b-c1.b));return `rgb(${r},${g},${b})`}
      function setupAudioAnalysis(stream){if(audioContext?.state!=='closed')audioContext?.close();audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=256;analyser.smoothingTimeConstant=0.3;microphoneSource=audioContext.createMediaStreamSource(stream);microphoneSource.connect(analyser);dataArray=new Uint8Array(analyser.frequencyBinCount);analyserStream=stream;drawVolumeMeter()}
      function drawVolumeMeter(){volumeMeterAnimationId=requestAnimationFrame(drawVolumeMeter);if(!analyser||!dataArray||!meterLevel)return;analyser.getByteFrequencyData(dataArray);let s=0;for(let i=0;i<dataArray.length;i++)s+=dataArray[i];let avgVol=dataArray.length>0?s/dataArray.length:0;let normVol=(avgVol/140)*100;normVol=Math.min(100,Math.max(0,normVol));meterLevel.style.width=normVol+'%';let activeCol;if(normVol<=50)activeCol=interpolateColor(LOW_COLOR,MID_COLOR,normVol/50);else activeCol=interpolateColor(MID_COLOR,HIGH_COLOR,(normVol-50)/50);const baseGradCol=getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim()||'#2a3340';meterLevel.style.background=`linear-gradient(to right, ${baseGradCol}, ${activeCol})`}
      function stopAudioAnalysis(){if(volumeMeterAnimationId)cancelAnimationFrame(volumeMeterAnimationId);volumeMeterAnimationId=null;if(microphoneSource)microphoneSource.disconnect();microphoneSource=null;if(analyserStream?.getTracks)analyserStream.getTracks().forEach(t=>t.stop());analyserStream=null;if(audioContext?.state!=='closed')audioContext.close().catch(e=>console.error("AudioContext close error:",e));audioContext=null;if(meterLevel){meterLevel.style.width='0%';meterLevel.style.background=getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg').trim()}analyser=null;dataArray=null}


      // --- STT (ìŒì„± ì¸ì‹) ì„¤ì • ---
      let recognition, isRecognizing = false;
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (SpeechRec) {
        recognition = new SpeechRec();
        recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'ko-KR';
        if(micButton) micButton.disabled = false; // STT ì§€ì› ì‹œ ë²„íŠ¼ í™œì„±í™”

        recognition.onstart = () => {
          isRecognizing = true;
          if(micButton) { micButton.textContent = 'ğŸ’¬'; micButton.classList.add('recording'); }
          console.log("ğŸ¤ STT ì‹œì‘");
        };
        recognition.onend = () => {
          isRecognizing = false;
          if(micButton) { micButton.textContent = 'ğŸ¤'; micButton.classList.remove('recording'); }
          setLoading(false); stopAudioAnalysis(); console.log("ğŸ¤ STT ì¢…ë£Œ");
        };
        recognition.onresult = (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
          }
          if (finalTranscript) { handleUserText(finalTranscript); }
        };
        recognition.onerror = (event) => {
          console.error("âŒ STT ì˜¤ë¥˜:", event.error);
          appendBubble(event.error === 'not-allowed'||event.error === 'service-not-allowed' ? "ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤." : "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "system-error");
          isRecognizing = false;
          if(micButton) { micButton.textContent = 'ğŸ¤'; micButton.classList.remove('recording'); }
          setLoading(false); stopAudioAnalysis();
        };
      } else {
        console.warn("âš ï¸ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        if(micButton) { micButton.title = "ìŒì„± ì¸ì‹ ë¯¸ì§€ì›"; micButton.disabled = true; }
        appendBubble("ì•Œë¦¼: ì‚¬ìš© ì¤‘ì¸ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "system-error");
      }

      if(micButton) {
        micButton.onclick = async () => {
          if (!SpeechRec) return;
          if (isRecognizing) {
            recognition.stop();
          } else {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              setupAudioAnalysis(stream); recognition.start(); setLoading(true);
            } catch (err) {
              console.error("âŒ ë§ˆì´í¬ ê¶Œí•œ/ì‹œì‘ ì˜¤ë¥˜:", err); appendBubble("ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "system-error"); stopAudioAnalysis(); setLoading(false);
            }
          }
        };
      }

      // --- ì‚¬ìš©ì ì •ë³´ ë° ëŒ€í™” ì´ˆê¸°í™” ---
      const lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge = localStorage.getItem('lozee_userage');
      const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const userId = localStorage.getItem('lozee_userid') || `user_${Date.now()}`;
      const userDisease = JSON.parse(localStorage.getItem('lozee_userdisease') || '[]');
      let chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');
      
      const params = new URLSearchParams(location.search);
      const incomingTopicId   = params.get('topic');
      const incomingTopicText = params.get('topicText');
      const currentSelectedTopic = { id: incomingTopicId, displayText: incomingTopicText || JSON.parse(localStorage.getItem('selectedTopic'))?.displayText || '' };

      chatHistory.forEach(msg => appendBubble(msg.content, msg.role));

      // basic-features.jsì˜ í•¨ìˆ˜ë“¤ í˜¸ì¶œ (ì „ì—­ìœ¼ë¡œ ë¡œë“œë˜ì—ˆë‹¤ê³  ê°€ì •)
      if(typeof trackTime === 'function') trackTime();
      if(typeof trackEmotionTone === 'function') trackEmotionTone();
      if(typeof trackSituation === 'function') trackSituation();


      if (currentSelectedTopic.id && chatHistory.length === 0) {
        await initConversation(currentSelectedTopic);
      } else if (chatHistory.length === 0) {
        if (typeof getFirstQuestion === 'function') {
             const initialPrompt = getFirstQuestion(userAge, {displayText: "ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼"});
             appendBubble(initialPrompt, 'bot');
             chatHistory.push({ role: 'bot', content: initialPrompt, timestamp: new Date().toISOString() });
             localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
             if(typeof playTTSFromText === 'function') await playTTSFromText(initialPrompt, lsSelectedVoice);
        } else {
            appendBubble("ì•ˆë…•í•˜ì„¸ìš”! ëŒ€í™” ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìˆì–´ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "system-error");
        }
      }

      function setLoading(flag) {
        if(sendButton) sendButton.disabled = flag;
        if (SpeechRec && micButton) micButton.disabled = flag && !isRecognizing; else if(micButton) micButton.disabled = true;
        if(sendButton) sendButton.classList.toggle('loading', flag);
      }

      async function initConversation(topicForInit) {
        setLoading(true);
        const prompt = getFirstQuestion(userAge, topicForInit); // getFirstQuestionFunction ëŒ€ì‹  getFirstQuestion ì‚¬ìš©
        appendBubble(prompt, 'bot');
        chatHistory.push({ role: 'bot', content: prompt, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        try { if(typeof playTTSFromText === 'function') await playTTSFromText(prompt, lsSelectedVoice); }
        catch (ttsError) { console.error("TTS ì˜¤ë¥˜ (ì´ˆê¸° ëŒ€í™”):", ttsError); }
        setLoading(false);
      }

      async function handleUserText(text) {
        if (!text.trim()) return;
        document.querySelector('.bubble.user.interim')?.remove();
        appendBubble(text, 'user');
        chatHistory.push({ role: 'user', content: text, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        setLoading(true);
        let res;
        try {
          res = await getGptResponse(text, { // getGptResponseFunction ëŒ€ì‹  getGptResponse ì‚¬ìš©
            userId, userAge, userName, userDisease,
            chatHistory: chatHistory.slice(-10),
          });

          if (!res.ok) {
            console.error(`API Error: ${res.status} ${res.statusText}.`);
            let errorData = { text: `ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status}). ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`};
            try { errorData = await res.json(); console.error("API Error Body:", errorData); }
            catch (e) { const rawErrorText = await res.text().catch(() => ""); console.error("Raw API Error Text:", rawErrorText); if(rawErrorText) errorData.text = rawErrorText.substring(0,150); }
            appendBubble(errorData.text || `API ìš”ì²­ ì‹¤íŒ¨: ${res.status}`, 'bot');
            chatHistory.push({ role: 'system', content: `API ì˜¤ë¥˜: ${res.status}`, error: errorData, timestamp: new Date().toISOString() });
            setLoading(false); return;
          }

          const data = await res.json();
          console.log("GPT API ì‘ë‹µ:", data);
          const botMessage = data?.rephrasing || data?.text || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”.";
          appendBubble(botMessage, 'bot');
          const botResponseEntry = { role: 'bot', content: botMessage, timestamp: new Date().toISOString() };
          if (data.analysis) {
            console.log("ğŸ’¡ ë¶„ì„ ë°ì´í„°:", data.analysis);
            botResponseEntry.analysis = data.analysis;
            if (typeof renderLiteracyAnalysis === 'function' && analysisContainer) {
               renderLiteracyAnalysis(data.analysis, analysisContainer);
               analysisContainer.style.display = 'block';
            }
          }
          chatHistory.push(botResponseEntry);
          localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
          if(typeof playTTSFromText === 'function') await playTTSFromText(botMessage, lsSelectedVoice);
        } catch (err) {
          console.error("âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
          if(res) console.error("ì˜¤ë¥˜ ì‹œì  API ì‘ë‹µ ê°ì²´ (res):", {status: res.status, ok: res.ok});
          appendBubble("ì£„ì†¡í•´ìš”, ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.", 'bot');
          chatHistory.push({ role: 'system', content: 'í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜', error: err.message, timestamp: new Date().toISOString() });
        }
        setLoading(false); if(chatInput) chatInput.value = ''; if(chatInput) chatInput.focus();
      }

      if(sendButton) sendButton.onclick = () => handleUserText(chatInput.value);
      if(chatInput) chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserText(chatInput.value); } };
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeApp, 100);
    });
  </script>
</body>
</html>
```
</immersive_code>

