<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEE와 대화하기</title>
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #f9f9f9; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
    header { background-color: #222; color: white; padding: 1rem; text-align: center; font-size: 1.3rem; }
    #chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; }
    .user { align-self: flex-end; background-color: #ffffff; border: 1px solid #e0e0e0; border-bottom-right-radius: 0; }
    .ai { align-self: flex-start; background-color: #eaeaea; border-bottom-left-radius: 0; }
    .ai_feedback { align-self: center; background-color: #e0f7fa; color: #00796b; font-size: 13px; max-width: 80%; text-align: center; border-radius: 10px; margin: 5px 0; }
    .analysis-notification { align-self: center; background-color: #fff9c4; color: #795548; font-size: 14px; padding: 10px 16px; border-radius: 12px; cursor: pointer; }
    #input-area { display: flex; padding: 10px; background: #fff; }
    #chat-input { flex: 1; padding: 12px 16px; border-radius: 20px; border: 1px solid #ccc; font-size: 15px; }
    #send-btn { margin-left: 8px; padding: 12px 16px; border: none; background: #4caf50; color: #fff; border-radius: 20px; cursor: pointer; }
    #talk-btn { display: none; }
  </style>
</head>
<body>
  <header>LOZEE와 대화하기</header>
  <div id="chat-window"></div>
  <div id="input-area">
    <input id="chat-input" type="text" placeholder="메시지를 입력하세요..." autocomplete="off" />
    <button id="send-btn">전송</button>
  </div>

  <script type="module">
    import './firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { db, saveSessionLog } from './js/firebase-utils.js';

    let skipTTS = false;
    let hasGreeted = false;
    let isProcessing = false;
    let chatHistory = [];

    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');

    function appendMessage(text, role) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + role;
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showAnalysisNotification() {
      const bubble = document.createElement('div');
      bubble.className = 'analysis-notification';
      bubble.textContent = '🟡 분석이 생성되었습니다. 클릭하여 결과 보기';
      bubble.addEventListener('click', () => window.location.href = 'analysis.html');
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage(text) {
      if (!text || isProcessing) return;
      isProcessing = true;
      appendMessage(text, 'user');
      chatHistory.push({ role: 'user', content: text });
      chatInput.value = '';

      // GPT 호출
      const res = await getGptResponse(text, { chatHistory });
      const data = await res.json();
      // 필터링: text에서 JSON 부분 제거
      const idx = data.text.indexOf('{');
      const cleanText = idx >= 0 ? data.text.slice(0, idx).trim() : data.text;
      const aiAnalysis = data.analysis || {};

      appendMessage(cleanText, 'ai');
      await playTTSWithControl(cleanText, localStorage.getItem('lozee_voice'));
      chatHistory.push({ role: 'assistant', content: cleanText });

      // 저장
      await saveSessionLog(text, cleanText, aiAnalysis);

      // 분석 유추 & 알림
      const fullText = chatHistory.map(m => `${m.role}:${m.content}`).join('\n');
      const inference = await LOZEE_ANALYSIS.inferAgeAndLanguage(fullText);
      await saveSessionLog('analysis', '', inference);
      showAnalysisNotification();

      isProcessing = false;
    }

    sendBtn.addEventListener('click', () => sendMessage(chatInput.value));
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage(chatInput.value);
      skipTTS = true; stopCurrentTTS();
    });
    chatInput.addEventListener('focus', () => { skipTTS = true; stopCurrentTTS(); });

    function playTTSWithControl(text, voiceId) {
      stopCurrentTTS();
      if (skipTTS) { skipTTS = false; return; }
      return playTTSFromText(text, voiceId);
    }

    async function init() {
      const userName = localStorage.getItem('lozee_username') || '친구';
      const voc = getKoreanVocativeParticle(userName);
      const greet = getInitialGreeting(userName + voc, hasGreeted);
      appendMessage(greet, 'ai');
      await playTTSWithControl(greet, localStorage.getItem('lozee_voice'));
      hasGreeted = true;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
