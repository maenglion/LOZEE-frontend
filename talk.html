<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ê¸°ë³¸ í˜ì´ì§€ ë° í°íŠ¸ ìŠ¤íƒ€ì¼ */
    body { 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; 
      background-color: #ffffff; 
      color: #333; 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      margin: 0;
    }

    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    #main-header {
      background-color: #0095FF; /* ë¡œì§€ ë©”ì¸ ì»¬ëŸ¬ */
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      flex-shrink: 0; 
    }

    /* ì±„íŒ… ì»¨í…Œì´ë„ˆ ë° ì°½ ìŠ¤íƒ€ì¼ */
    #chat-container { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      overflow-y: hidden; 
      width: 100%; 
      max-width: 700px; 
      margin: 0 auto; 
      box-sizing: border-box; 
    }
    #chat-window { 
      flex: 1; 
      overflow-y: auto; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
    }

    /* ë§í’ì„  ê³µí†µ ìŠ¤íƒ€ì¼ */
    .bubble { 
      max-width: 80%; 
      padding: 12px 18px; 
      border-radius: 20px; 
      line-height: 1.6; 
      font-size: 16px; 
      white-space: pre-wrap; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .user { 
      background-color: #fff9c4; 
      color: #333; 
      align-self: flex-end; 
      margin-left: auto; 
      border-bottom-right-radius: 5px; 
    }
    .ai { 
      background-color: #0095FF; 
      color: white; 
      align-self: flex-start; 
      margin-right: auto; 
      border-bottom-left-radius: 5px; 
    }
    .bubble.ai.error { 
      background-color: #ff7373; 
      color: white; 
    }

    /* ë¡œë”© ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ */
    #loading-indicator-talk { 
      text-align: center; 
      padding: 10px; 
      display: none; 
      color: #555; 
      font-style: italic; 
    }

    /* í•˜ë‹¨ ë§ˆì´í¬ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #talk-btn-container { 
      padding: 15px 0; 
      background-color: #ffffff; 
      flex-shrink: 0; 
      text-align: center; 
      border-top: 1px solid #eee; 
    }
    #talk-btn { 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      background-color: #b6b6b6; /* Default grey */
      border: none; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
      color: white; 
      font-size: 36px; 
      cursor: pointer; 
      display: inline-flex; 
      justify-content: center; 
      align-items: center; 
      transition: transform 0.2s ease, background-color 0.3s; 
    }
    #talk-btn.active { /* Blue state - for continuable or initial active pulse */
      background-color: #0095FF; 
      transform: scale(1.1); 
    }
    #talk-btn.recording-in-progress { /* Red state - for 0-25s recording */
        background-color: #e06c75; /* Softer red */
        transform: scale(1.1); 
    }
    #talk-btn:disabled { 
      background-color: #ccc; 
      cursor: not-allowed; 
      transform: scale(1.0); 
    }

    /* ì£¼ì œ ì„ íƒ ë°•ìŠ¤ ê´€ë ¨ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
    #topic-selection { display: none; background: #f0f0f0; padding: 20px; border-top: 1px solid #ddd; text-align: center; flex-shrink: 0; }
    #topic-selection h3 { font-size: 18px; color: #333; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
    .topic-option { font-family: 'KoPubWorld Dotum', sans-serif; padding: 10px 15px; margin: 8px auto; background: white; border: 1px solid #0095FF; color: #0095FF; border-radius: 10px; cursor: pointer; max-width: 320px; font-size: 15px; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
    .topic-option:hover { background-color: #0095FF; color: white; }

    /* ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
    #waiting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);  display: none;  justify-content: center; align-items: center; z-index: 1000;  color: white; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer;  }
  </style>
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>

  <div id="chat-container">
    <div id="chat-window">
      </div>
    <div id="topic-selection">
      <h3>ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ê³  ì‹¶ì€ ì£¼ì œë¥¼ ê³¨ë¼ë³¼ë˜?</h3>
      <div id="topic-options">
        </div>
    </div>
  </div>

  <div id="loading-indicator-talk">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>

  <div id="waiting-overlay">
    <p><span id="waitingUserName"></span>ë‹˜, ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...<br><small>(í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”)</small></p>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    console.log("talk.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (v3.17 - ì§§ì€ ë°œí™” ì²˜ë¦¬ ê°œì„ )");

    const talkBtn = document.getElementById('talk-btn');
    const chatWindow = document.getElementById('chat-window');
    const topicSelectionBox = document.getElementById('topic-selection');
    const topicOptionsContainer = document.getElementById('topic-options');
    const loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
    const waitingOverlay = document.getElementById('waiting-overlay');
    const waitingUserNameSpan = document.getElementById('waitingUserName');

    const currentUserName = localStorage.getItem('lozee_username') || "ì¹œêµ¬";
    const currentUserId = localStorage.getItem('lozee_username'); 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';

    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try {
            selectedEmotions = JSON.parse(selectedEmotionsString);
        } catch (e) {
            console.error("ì„ íƒëœ ê°ì • localStorage íŒŒì‹± ì˜¤ë¥˜:", e);
            selectedEmotions = []; 
        }
    }

    const simplified = (() => {
      const age = parseInt(currentUserAge || "0", 10);
      const disease = (currentUserDisease || "").toLowerCase();
      const needsSimple = age < 15 || ["ì•„ìŠ¤í¼ê±°", "asd", "adhd", "ì‚¬íšŒì ì˜ì‚¬ì†Œí†µì¥ì• "].some(d => disease.includes(d));
      const isVeryYoung = age < 10;
      console.log(`[Simplified Language Check] Age: ${age}, Disease: "${disease}", NeedsSimple: ${needsSimple}, IsVeryYoung: ${isVeryYoung}`);
      return { useSimpleLanguage: needsSimple, useUltraSimpleLanguage: isVeryYoung };
    })();
    
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer;
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTimeValue; 

    const ADMIN_SECRET_PHRASE = "ê³ ì–‘ì´ë§¹êµ¬ë¦„ë§¹ëˆ„ë¦¬";
    const ADMIN_EMAIL = "maengnanyoung@gmail.com";

    let totalCharacterCount = 0;
    let conversationStartTime = null;
    const ANALYSIS_CHAR_THRESHOLD = 800; 
    const ANALYSIS_TIME_THRESHOLD_SECONDS = 180; 
    let analysisRedirectInProgress = false;

    const MAX_RECORDING_DURATION_MS = 30000; 
    const CONTINUE_THRESHOLD_MS = 25000;     
    const MAX_CONSECUTIVE_SEGMENTS = 5;      
    let currentSegmentCount = 0;             
    let autoStopTimer = null;                
    let continuePromptTimer = null;          
    let isEligibleToContinue = false;        
    let userClickedToContinue = false;       
    const API_DISCONNECT_DELAY_MS = 1000;

    function appendMessage(text, role = 'ai', isError = false) { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ }
    function disableTalkButton(disable = true, reason = "") { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ }
    async function loadRecentTopics() { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ 
        if (!currentUserId) { console.warn("[loadRecentTopics] ì‚¬ìš©ì ID ì—†ìŒ, ì£¼ì œ ë¡œë“œ ê±´ë„ˆëœ€."); return []; }
        const topicsApiUrl = `https://ggg-production.up.railway.app/api/topics?userId=${encodeURIComponent(currentUserId)}`;
        console.log(`[loadRecentTopics] API í˜¸ì¶œ ì‹œë„: ${topicsApiUrl}`);
        try {
            const response = await fetch(topicsApiUrl);
            console.log(`[loadRecentTopics] API ì‘ë‹µ ìƒíƒœ: ${response.status}`);
            if (!response.ok) { 
            const errorText = await response.text();
            console.error(`[loadRecentTopics] ìµœê·¼ ì£¼ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status} - ${response.statusText}. ì‘ë‹µ ë³¸ë¬¸: ${errorText.substring(0, 200)}...`); 
            return []; 
            }
            const data = await response.json(); 
            console.log("[loadRecentTopics] ìµœê·¼ ì£¼ì œ ë°ì´í„°:", data);
            return data.topics || [];
        } catch (error) { 
            console.error('[loadRecentTopics] ìµœê·¼ ì£¼ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” JSON íŒŒì‹± ì˜¤ë¥˜:', error); 
            return []; 
        }
    }
    function showTopicBox(topics) { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ }
    function startSilenceTimer() { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ }
    function resetSilenceTimer() { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ }
    function checkAndRedirectToAnalysis() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ }

    async function handleUserInteraction(userText, context = {}) { 
      if (!userText || userText.trim() === "" || analysisRedirectInProgress) return;
      if (!conversationStartTime) conversationStartTime = Date.now();
      disableTalkButton(true, "AI ì‘ë‹µ ëŒ€ê¸° ì¤‘"); 
      topicSelectionBox.style.display = 'none'; 
      loadingIndicatorTalk.style.display = 'block';
      const gptContext = { userAge: currentUserAge, userDisease: currentUserDisease, useSimpleLanguage: simplified.useSimpleLanguage, useUltraSimpleLanguage: simplified.useUltraSimpleLanguage, ...context };
      console.log("[handleUserInteraction] GPT Context:", gptContext);
      try {
        const gptResponse = await getGptResponse(userText, currentUserId, gptContext);
        let aiReply = gptResponse?.rephrasing || gptResponse?.error || "ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ì´í•´í•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆì–´ìš”.";
        let isError = !gptResponse?.rephrasing;
        if (gptResponse?.summary) localStorage.setItem('lozee_lastSummary', (lastSummary = gptResponse.summary));
        
        // AI ì‘ë‹µ ì²˜ë¦¬ í›„ UI ì—…ë°ì´íŠ¸
        setTimeout(async () => {
            loadingIndicatorTalk.style.display = 'none'; 
            const aiBubbleDiv = appendMessage(aiReply, 'ai', isError); 
            if (aiBubbleDiv) { chatWindow.appendChild(aiBubbleDiv); chatWindow.scrollTop = chatWindow.scrollHeight; }
            
            if (!analysisRedirectInProgress) { 
                try { await playTTSFromText(aiReply, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨:", e); } 
            }
            
            // AI ì‘ë‹µ ë° TTS ì™„ë£Œ í›„ ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹
            if (!analysisRedirectInProgress) { 
                disableTalkButton(false, "AI ì‘ë‹µ ì™„ë£Œ"); 
                currentSegmentCount = 0; // ë…¹ìŒ ì²´ì¸ ì¹´ìš´íŠ¸ ì—¬ê¸°ì„œ ë¦¬ì…‹
                resetSilenceTimer(); 
                checkAndRedirectToAnalysis(); 
            }
        }, 1000); // GPT ì‘ë‹µ ë° TTSë¥¼ ìœ„í•œ ìµœì†Œ ì‹œê°„ í™•ë³´
      } catch (error) { 
        loadingIndicatorTalk.style.display = 'none';
        const fallbackMsg = "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.";
        const errorBubble = appendMessage(fallbackMsg, 'ai', true);
        if(errorBubble) chatWindow.appendChild(errorBubble);
        if (!analysisRedirectInProgress) {
            try { await playTTSFromText(fallbackMsg, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨ (ì˜¤ë¥˜ ì²˜ë¦¬ ì¤‘):", e); }
            disableTalkButton(false, "AI ì‘ë‹µ ì˜¤ë¥˜"); 
            currentSegmentCount = 0; // ì˜¤ë¥˜ ì‹œì—ë„ ë…¹ìŒ ì²´ì¸ ë¦¬ì…‹
            resetSilenceTimer(); 
        }
      } 
    }

    async function startRecording() { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ }

    function stopRecording() { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ }

    // mediaRecorder.onstop í•¸ë“¤ëŸ¬ ìˆ˜ì •
    // mediaRecorder.onstopì€ startRecording ë‚´ë¶€ì—ì„œ ì •ì˜ë©ë‹ˆë‹¤.
    // ì•„ë˜ëŠ” startRecording í•¨ìˆ˜ ë‚´ì˜ onstop í•¸ë“¤ëŸ¬ ìˆ˜ì • ë¶€ë¶„ì…ë‹ˆë‹¤.
    // async function startRecording() { ...
    //    mediaRecorder.onstop = async () => {
    //        ... (try...catch ì•ë¶€ë¶„ STT ì²˜ë¦¬ ë¡œì§ì€ ê¸°ì¡´ê³¼ ìœ ì‚¬) ...
    //        try {
    //            const userText = audioBlob ? await getSTTFromAudio(audioBlob, durationInSeconds) : "";
    //            if (userText && userText.trim() !== "") { 
    //                appendMessage(userText, 'user'); 
    //                const isFirst = onboardingComplete && !localStorage.getItem('lozee_first_voice_interaction_done');
    //                // ì¤‘ìš”: handleUserInteraction í˜¸ì¶œ. ì´ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹ì´ ì¼ì–´ë‚¨.
    //                await handleUserInteraction(userText, isFirst ? { initialUserMessage: userText, initialUserEmotions: selectedEmotions, isFirstChatAfterOnboarding: true } : {});
    //                if (isFirst) { localStorage.setItem('lozee_first_voice_interaction_done', 'true'); localStorage.removeItem('lozee_selected_emotions'); }
    //            } else if (!userClickedToContinue && audioBlob) { 
    //                // STT ê²°ê³¼ê°€ ì—†ì§€ë§Œ, ì‚¬ìš©ìê°€ ì—°ì† ë…¹ìŒì„ ì˜ë„í•˜ì§€ ì•Šì€ ê²½ìš° (ì¦‰, ì§§ì€ ë…¹ìŒ í›„ ì¤‘ë‹¨)
    //                const noSttMsgDiv = appendMessage("ì£„ì†¡í•´ìš”, ì˜ ì•Œì•„ë“£ì§€ ëª»í–ˆì–´ìš”.", 'ai', true);
    //                if (noSttMsgDiv) chatWindow.appendChild(noSttMsgDiv);
    //                if (!analysisRedirectInProgress) {
    //                    try { await playTTSFromText(noSttMsgDiv.textContent, currentVoiceId); } catch(e) {console.error("TTS error for no STT", e);}
    //                    // STT ê²°ê³¼ê°€ ì—†ìœ¼ë¯€ë¡œ AI ì‘ë‹µì„ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ì´ ë°”ë¡œ ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹
    //                    disableTalkButton(false, "STT ê²°ê³¼ ì—†ìŒ");
    //                    currentSegmentCount = 0; // ë…¹ìŒ ì²´ì¸ ë¦¬ì…‹
    //                    resetSilenceTimer();
    //                }
    //            } else if (userClickedToContinue && !audioBlob) {
    //                // ì‚¬ìš©ìê°€ ì—°ì† ë…¹ìŒì„ í´ë¦­í–ˆì§€ë§Œ, ì´ì „ ì„¸ê·¸ë¨¼íŠ¸ì— ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
    //                // ë°”ë¡œ ë‹¤ìŒ ë…¹ìŒìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šê³ , ì¼ë‹¨ í˜„ì¬ ìƒíƒœë¥¼ ì‚¬ìš©ìì—ê²Œ ì•Œë¦´ ìˆ˜ ìˆìŒ (ì„ íƒ ì‚¬í•­)
    //                // ë˜ëŠ” ê·¸ëƒ¥ ë‹¤ìŒ ë…¹ìŒìœ¼ë¡œ ì§„í–‰ (í˜„ì¬ ë¡œì§ì€ finallyì—ì„œ shouldContinueChainìœ¼ë¡œ ì²˜ë¦¬)
    //                console.log("[onstop] ì—°ì† ë…¹ìŒ í´ë¦­í–ˆìœ¼ë‚˜ ì´ì „ ì˜¤ë””ì˜¤ ì—†ìŒ. ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ë¡œ ì§„í–‰ ì˜ˆì •.");
    //            }
    //        } catch (sttError) { 
    //            // STT ìì²´ì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ
    //            const sttErrorMsgDiv = appendMessage("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", 'ai', true);
    //            if (sttErrorMsgDiv) chatWindow.appendChild(sttErrorMsgDiv);
    //            if (!analysisRedirectInProgress) {
    //                try {await playTTSFromText(sttErrorMsgDiv.textContent, currentVoiceId); } catch(e) {console.error("TTS error for STT error", e);}
    //                disableTalkButton(false, "STT ì˜¤ë¥˜");
    //                currentSegmentCount = 0; // ë…¹ìŒ ì²´ì¸ ë¦¬ì…‹
    //                resetSilenceTimer();
    //            }
    //        } finally {
    //            const shouldContinueChain = userClickedToContinue && currentSegmentCount < MAX_CONSECUTIVE_SEGMENTS;
    //            userClickedToContinue = false; 
    //
    //            if (shouldContinueChain) {
    //                // ì—°ì† ë…¹ìŒ ë¡œì§
    //                console.log(`ì—°ì† ë…¹ìŒ ì§„í–‰ ì¤€ë¹„: ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ (${currentSegmentCount + 1}) ì‹œì‘ ì „ ${API_DISCONNECT_DELAY_MS}ms ëŒ€ê¸°`);
    //                if (mediaStream) {
    //                    mediaStream.getTracks().forEach(track => track.stop());
    //                    mediaStream = null;
    //                }
    //                mediaRecorder = null; 
    //                disableTalkButton(true, "ë‹¤ìŒ ë…¹ìŒ ì¤€ë¹„ ì¤‘..."); 
    //                setTimeout(() => { 
    //                    console.log(`${API_DISCONNECT_DELAY_MS}ms ëŒ€ê¸° ì™„ë£Œ. ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì‹œì‘ ì‹œë„.`);
    //                    if (!analysisRedirectInProgress) startRecording(); 
    //                    else { 
    //                        talkBtn.innerHTML = 'ğŸ¤'; talkBtn.classList.remove('active', 'recording-in-progress');
    //                        currentSegmentCount = 0; disableTalkButton(false, "ë¶„ì„ í˜ì´ì§€ ì´ë™ìœ¼ë¡œ ì¤‘ë‹¨");
    //                    } 
    //                }, API_DISCONNECT_DELAY_MS);
    //            } else { 
    //                // ì¼ë°˜ ë…¹ìŒ ì¢…ë£Œ (ì—°ì† ì•„ë‹˜)
    //                // STT ê²°ê³¼ê°€ ìˆê³  handleUserInteractionì´ í˜¸ì¶œëœ ê²½ìš°, í•´ë‹¹ í•¨ìˆ˜ ë‚´ì—ì„œ ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹ì´ ì²˜ë¦¬ë¨.
    //                // STT ê²°ê³¼ê°€ ì—†ê±°ë‚˜ STT ì˜¤ë¥˜ì¸ ê²½ìš°, ìœ„ try-catch ë¸”ë¡ì—ì„œ ì´ë¯¸ ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹ì´ ì²˜ë¦¬ë¨.
    //                // ë”°ë¼ì„œ ì´ ë¶€ë¶„ì—ì„œëŠ” íŠ¹ë³„í•œ UI ì¡°ì‘ì„ í•˜ì§€ ì•ŠìŒ.
    //                console.log("ë…¹ìŒ ì²´ì¸ ì¢…ë£Œ (onstop finally). AI ì‘ë‹µ ë˜ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.");
    //                // currentSegmentCountëŠ” handleUserInteraction ë˜ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬ë¶€ì—ì„œ ë¦¬ì…‹ë¨.
    //            }
    //        }
    //    }; // onstop í•¸ë“¤ëŸ¬ ë
    // } // startRecording í•¨ìˆ˜ ë


    // startRecording í•¨ìˆ˜ ë‚´ onstop í•¸ë“¤ëŸ¬ ìˆ˜ì • (v3.17)
    // ì´ ì½”ë“œëŠ” startRecording í•¨ìˆ˜ ë‚´ë¶€ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    // ì „ì²´ startRecording í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ ì œê³µí•˜ëŠ” ëŒ€ì‹ , onstop ë¶€ë¶„ë§Œ ê°•ì¡°í•©ë‹ˆë‹¤.
    // ì‹¤ì œ ì½”ë“œì—ì„œëŠ” startRecording í•¨ìˆ˜ ë‚´ì˜ mediaRecorder.onstop = async () => { ... } ë¶€ë¶„ì„ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.

    // (startRecording í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì€ ê¸°ì¡´ê³¼ ë™ì¼)
    // ...
    // mediaRecorder.onstop = async () => {
    //     console.log("[onstop] ë…¹ìŒ ì¤‘ì§€ë¨, ì²˜ë¦¬ ì‹œì‘...");
    //     isRecording = false; 

    //     const recordingEndTime = performance.now();
    //     const durationInMs = recordingEndTime - (recordingStartTimeValue || recordingEndTime); 
    //     const durationInSeconds = Math.round(durationInMs / 1000);
    //     console.log(`[onstop] ë…¹ìŒëœ ì˜¤ë””ì˜¤ ê¸¸ì´ (ì¶”ì •): ${durationInSeconds}ì´ˆ, ì„¸ê·¸ë¨¼íŠ¸: ${currentSegmentCount}`);

    //     if (audioChunks.length === 0 && !userClickedToContinue) { 
    //         if (!analysisRedirectInProgress) {
    //             disableTalkButton(false, "ë…¹ìŒ ë°ì´í„° ì—†ìŒ"); 
    //             currentSegmentCount = 0; // ì²´ì¸ ë¦¬ì…‹
    //             talkBtn.innerHTML = 'ğŸ¤';
    //             talkBtn.classList.remove('active', 'recording-in-progress');
    //         }
    //         resetSilenceTimer(); 
    //         return; 
    //     }
        
    //     const audioBlob = (audioChunks.length > 0) ? new Blob(audioChunks, { type: mediaRecorder.mimeType }) : null;
    //     audioChunks = [];
        
    //     let sttProcessedSuccessfully = false; // STT ë° í›„ì† ì²˜ë¦¬ ì„±ê³µ ì—¬ë¶€ í”Œë˜ê·¸

    //     if (audioBlob) { // ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ìˆì„ ê²½ìš°ì—ë§Œ STT ì‹œë„
    //         if (!analysisRedirectInProgress) disableTalkButton(true, "STT ì²˜ë¦¬ ì¤‘");
    //         try {
    //             const userText = await getSTTFromAudio(audioBlob, durationInSeconds);
    //             if (userText && userText.trim() !== "") { 
    //                 appendMessage(userText, 'user'); 
    //                 const isFirst = onboardingComplete && !localStorage.getItem('lozee_first_voice_interaction_done');
    //                 await handleUserInteraction(userText, isFirst ? { initialUserMessage: userText, initialUserEmotions: selectedEmotions, isFirstChatAfterOnboarding: true } : {});
    //                 if (isFirst) { localStorage.setItem('lozee_first_voice_interaction_done', 'true'); localStorage.removeItem('lozee_selected_emotions'); }
    //                 sttProcessedSuccessfully = true; // GPT ì‘ë‹µê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼ í•˜ë¯€ë¡œ handleUserInteraction ë‚´ë¶€ì—ì„œ ìµœì¢… ì²˜ë¦¬
    //             } else if (!userClickedToContinue) { 
    //                 // STT ê²°ê³¼ê°€ ì—†ì§€ë§Œ, ì‚¬ìš©ìê°€ ì—°ì† ë…¹ìŒì„ ì˜ë„í•˜ì§€ ì•Šì€ ê²½ìš°
    //                 const noSttMsgDiv = appendMessage("ì£„ì†¡í•´ìš”, ì˜ ì•Œì•„ë“£ì§€ ëª»í–ˆì–´ìš”.", 'ai', true);
    //                 if (noSttMsgDiv) chatWindow.appendChild(noSttMsgDiv);
    //                 if (!analysisRedirectInProgress) {
    //                     try { await playTTSFromText(noSttMsgDiv.textContent, currentVoiceId); } catch(e) {console.error("TTS error for no STT", e);}
    //                     disableTalkButton(false, "STT ê²°ê³¼ ì—†ìŒ");
    //                     currentSegmentCount = 0; 
    //                     resetSilenceTimer();
    //                 }
    //             }
    //         } catch (sttError) { 
    //             const sttErrorMsgDiv = appendMessage("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", 'ai', true);
    //             if (sttErrorMsgDiv) chatWindow.appendChild(sttErrorMsgDiv);
    //             if (!analysisRedirectInProgress) {
    //                 try {await playTTSFromText(sttErrorMsgDiv.textContent, currentVoiceId); } catch(e) {console.error("TTS error for STT error", e);}
    //                 disableTalkButton(false, "STT ì˜¤ë¥˜");
    //                 currentSegmentCount = 0; 
    //                 resetSilenceTimer();
    //             }
    //         }
    //     } else if (!userClickedToContinue) {
    //         // ì˜¤ë””ì˜¤ ë¸”ëì´ ì—†ê³ , ì—°ì† ë…¹ìŒë„ ì•„ë‹Œ ê²½ìš° (ì˜ˆ: ë…¹ìŒ ì‹œì‘ ì§í›„ ë°”ë¡œ ì¤‘ë‹¨)
    //         console.log("[onstop] ì˜¤ë””ì˜¤ ë°ì´í„° ì—†ì´ ë…¹ìŒ ì¤‘ë‹¨ë¨ (ì—°ì† ì•„ë‹˜).");
    //         if (!analysisRedirectInProgress) {
    //             disableTalkButton(false, "ë…¹ìŒ ë°ì´í„° ì—†ìŒ");
    //             currentSegmentCount = 0;
    //             talkBtn.innerHTML = 'ğŸ¤';
    //             talkBtn.classList.remove('active', 'recording-in-progress');
    //             resetSilenceTimer();
    //         }
    //     }

    //     // finally ë¸”ë¡ì€ STT ì²˜ë¦¬ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì—°ì† ë…¹ìŒ ì—¬ë¶€ë§Œ íŒë‹¨
    //     const shouldContinueChain = userClickedToContinue && currentSegmentCount < MAX_CONSECUTIVE_SEGMENTS;
    //     userClickedToContinue = false; 

    //     if (shouldContinueChain) {
    //         console.log(`ì—°ì† ë…¹ìŒ ì§„í–‰ ì¤€ë¹„: ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ (${currentSegmentCount + 1}) ì‹œì‘ ì „ ${API_DISCONNECT_DELAY_MS}ms ëŒ€ê¸°`);
    //         if (mediaStream) {
    //             mediaStream.getTracks().forEach(track => track.stop());
    //             mediaStream = null;
    //         }
    //         mediaRecorder = null; 
    //         disableTalkButton(true, "ë‹¤ìŒ ë…¹ìŒ ì¤€ë¹„ ì¤‘..."); 
    //         setTimeout(() => { 
    //             console.log(`${API_DISCONNECT_DELAY_MS}ms ëŒ€ê¸° ì™„ë£Œ. ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì‹œì‘ ì‹œë„.`);
    //             if (!analysisRedirectInProgress) startRecording(); 
    //             else { 
    //                 talkBtn.innerHTML = 'ğŸ¤'; talkBtn.classList.remove('active', 'recording-in-progress');
    //                 currentSegmentCount = 0; disableTalkButton(false, "ë¶„ì„ í˜ì´ì§€ ì´ë™ìœ¼ë¡œ ì¤‘ë‹¨");
    //             } 
    //         }, API_DISCONNECT_DELAY_MS);
    //     } else if (!sttProcessedSuccessfully && audioBlob) { 
    //         // ì—°ì† ë…¹ìŒì´ ì•„ë‹ˆê³ , STTëŠ” ì‹œë„í–ˆìœ¼ë‚˜ handleUserInteractionìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šì€ ê²½ìš° (ì˜ˆ: STT ê²°ê³¼ ì—†ìŒ ë˜ëŠ” STT ì˜¤ë¥˜)
    //         // ì´ ê²½ìš° ì´ë¯¸ ìœ„ì—ì„œ ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹ì´ ì²˜ë¦¬ë˜ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”.
    //         console.log("[onstop] ì—°ì† ë…¹ìŒ ì•„ë‹˜. STT ì²˜ë¦¬ ì‹¤íŒ¨ ë˜ëŠ” ê²°ê³¼ ì—†ìŒ. UIëŠ” ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨.");
    //     } else if (!audioBlob && !shouldContinueChain) {
    //          // ì˜¤ë””ì˜¤ ë¸”ëë„ ì—†ê³ , ì—°ì† ë…¹ìŒë„ ì•„ë‹Œ ê²½ìš° (ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
    //          console.log("[onstop] ì—°ì† ë…¹ìŒ ì•„ë‹˜. ì˜¤ë””ì˜¤ ë°ì´í„° ì—†ìŒ. UIëŠ” ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨.");
    //     } else {
    //          // STT ì„±ê³µ í›„ handleUserInteractionìœ¼ë¡œ ë„˜ì–´ê°„ ê²½ìš°
    //          console.log("[onstop] ì—°ì† ë…¹ìŒ ì•„ë‹˜. handleUserInteractionì—ì„œ UI ì—…ë°ì´íŠ¸ ì˜ˆì •.");
    //     }
    // }; // onstop í•¸ë“¤ëŸ¬ ë
    // (startRecording í•¨ìˆ˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ ë° ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼)

    talkBtn.addEventListener('click', async () => { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ });
    waitingOverlay.addEventListener('click', () => { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ }); 
    async function initializeChat() { /* (ê¸°ì¡´ê³¼ ë™ì¼ - v3.16 ë‚´ìš© ë°˜ì˜) */ }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeChat);
    } else {
        initializeChat();
    }
  </script>
</body>
</html>
