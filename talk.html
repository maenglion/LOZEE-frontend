<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    :root {
      --primary-color: #6e8efb;
      --secondary-color: #354157; /* ê¸°ì¡´ GNB ë°°ê²½ìƒ‰, ì´ì œ ë‹¤ë¥¸ ìš©ë„ë¡œ ì‚¬ìš© ê°€ëŠ¥ */
      --background-color: #2a3340; /* í˜ì´ì§€ ì „ì²´ ë°°ê²½ ë° ìƒˆë¡œìš´ GNB ë°°ê²½ */
      --text-color: #fff;
      --input-background: #f0f0f0;
      --bot-bubble-bg: #f0f0f0;
      --bot-bubble-text: #333;
      --user-bubble-bg: #6e8efb;
      --user-bubble-text: #fff;
      --gnb-height: 56px;
      --chat-input-height: 70px;
      --gemini-purple: #7B68EE; /* GNB íƒ€ì´í‹€/ë©”ë‰´ ì•„ì´ì½˜ ìƒ‰ìƒ */
      --volume-meter-default-bg: var(--primary-color); /* ìŒëŸ‰ ë°” ê¸°ë³¸ ë°°ê²½ìƒ‰ */
      --meter-top-margin: 8px; /* GNBì™€ ìŒëŸ‰ ë°” ì‚¬ì´ ì—¬ë°± */
      --gnb-dropdown-border-color: #4a5568; /* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ êµ¬ë¶„ì„  ìƒ‰ìƒ */
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }

    /* GNB (í–„ë²„ê±° ë©”ë‰´) */
    #gnb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--background-color); /* GNB ë°°ê²½ìƒ‰ ë³€ê²½ */
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* ê·¸ë¦¼ì ì•½ê°„ ë” ê°•ì¡° */
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gemini-purple); /* ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€ (ê°€ì‹œì„± ì¢‹ìŒ) */
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gemini-purple); /* ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€ (ê°€ì‹œì„± ì¢‹ìŒ) */
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--background-color); /* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë°°ê²½ìƒ‰ ë³€ê²½ */
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.25); /* ê·¸ë¦¼ì ì•½ê°„ ë” ê°•ì¡° */
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 500px;
    }

    #dropdown-menu a {
      display: block;
      color: var(--text-color); /* ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€ (ê°€ì‹œì„± ì¢‹ìŒ) */
      text-decoration: none;
      padding: 12px 16px;
      font-size: 0.95em;
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child { border-bottom: none; }
    #dropdown-menu a:hover {
      background-color: var(--secondary-color); /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ì€ ê¸°ì¡´ GNB ìƒ‰ìƒ í™œìš© */
    }

    /* ìŒëŸ‰ ë°” */
    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: 6px;
      background-color: var(--secondary-color); /* íŠ¸ë™ ë°°ê²½ì€ ê¸°ì¡´ GNB ìƒ‰ìƒ í™œìš© */
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-meter { width:100%; height:100%; }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-default-bg);
      border-radius: 3px;
      transition: width 0.05s linear;
    }

    /* ì±„íŒ… ì˜ì—­ */
    #chat-container {
      flex-grow: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + 6px + 16px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: var(--chat-input-height);
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.5;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background-color: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.bot {
      background-color: var(--bot-bubble-bg);
      color: var(--bot-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.user.interim { opacity:.7; }

    /* ì…ë ¥ ì˜ì—­ */
    #chat-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-height);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background-color: var(--secondary-color); /* í•˜ë‹¨ ì…ë ¥ì°½ ë°°ê²½ì€ ê¸°ì¡´ GNB ìƒ‰ìƒ í™œìš© */
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 22px;
      border: 1px solid var(--gnb-dropdown-border-color);
      font-size: 1em;
      background-color: var(--input-background);
      color: #333;
      height: 44px;
      box-sizing: border-box;
    }
    #chat-input::placeholder { color: #777; }

    #mic-button,
    #send-button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: var(--text-color);
      font-size: 1.3em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover,
    #send-button:hover { background-color: #5a7edf; }
    #mic-button.disabled,
    #send-button.disabled {
      opacity:.5;
      cursor:default;
      background-color: #999;
    }
    #send-button.loading { background:#999; cursor:default; }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-container::-webkit-scrollbar-thumb { background: var(--gnb-dropdown-border-color); border-radius: 4px; }
    #chat-container::-webkit-scrollbar-thumb:hover { background: #5a7edf; }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (ì¤€ë¹„ì¤‘)</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ìµœê·¼ ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ì£¼ì œë³„ ëŒ€í™” ëª©ë¡</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ì†Œê°œ</a>
    </div>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>

  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off"/>
    <button id="send-button" title="ë©”ì‹œì§€ ì „ì†¡">â®</button>
  </div>

<script type="module">
  // --- ì™¸ë¶€ JS íŒŒì¼ ì„í¬íŠ¸ (ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì • í•„ìš”) ---
  // import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
  // import { getGptResponse, getFirstQuestion } from './js/gpt-dialog.js';

  // --- ì„ì‹œ í•¨ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©) ---
  const DEFAULT_VOICE = 'default';
  async function playTTSFromText(text, voice) { console.log(`TTS (ìŒì„±: ${voice}): ${text}`); await new Promise(r => setTimeout(r, 500)); }
  async function getGptResponse(text, context) { console.log("GPT ìš”ì²­:", text, context); await new Promise(r => setTimeout(r, 1000)); return { status: 200, json: async () => ({ text: `ë´‡ ì‘ë‹µ: "${text}"ì— ëŒ€í•œ ë‹µë³€ì…ë‹ˆë‹¤.` }) }; }
  function getFirstQuestion(userAge, selectedTopic) { console.log("ì²« ì§ˆë¬¸ ìƒì„±:", userAge, selectedTopic); return `ì•ˆë…•í•˜ì„¸ìš”! ${selectedTopic.name || 'ì„ íƒëœ ì£¼ì œ'}ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?`; }
  // --- ì„ì‹œ í•¨ìˆ˜ ë ---

  document.addEventListener('DOMContentLoaded', async () => {
    const chatContainer = document.getElementById('chat-container');
    const chatInput     = document.getElementById('chat-input');
    const sendButton    = document.getElementById('send-button');
    const micButton     = document.getElementById('mic-button');
    const meterLevel    = document.getElementById('volume-level');
    const menuToggle    = document.getElementById('menu-toggle');
    const dropdownMenu  = document.getElementById('dropdown-menu');
    const gnb           = document.getElementById('gnb');

    // --- Web Audio API ê´€ë ¨ ë³€ìˆ˜ ---
    let audioContext;
    let analyser;
    let microphoneSource;
    let dataArray;
    let volumeMeterAnimationId;
    let analyserStream; // Web Audioìš© ìŠ¤íŠ¸ë¦¼ ì €ì¥

    const LOW_COLOR = { r: 0, g: 200, b: 0 };
    const MID_COLOR = { r: 255, g: 200, b: 0 };
    const HIGH_COLOR = { r: 255, g: 69, b: 0 };

    function interpolateColor(color1, color2, factor) {
      const r = Math.round(color1.r + factor * (color2.r - color1.r));
      const g = Math.round(color1.g + factor * (color2.g - color1.g));
      const b = Math.round(color1.b + factor * (color2.b - color1.b));
      return `rgb(${r},${g},${b})`;
    }

    function setupAudioAnalysis(stream) {
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close();
      }
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      analyser.smoothingTimeConstant = 0.3;

      microphoneSource = audioContext.createMediaStreamSource(stream);
      microphoneSource.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      analyserStream = stream;
      drawVolumeMeter();
    }

    function drawVolumeMeter() {
      volumeMeterAnimationId = requestAnimationFrame(drawVolumeMeter);
      if (!analyser || !dataArray || !meterLevel) return;

      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
      }
      let averageVolume = dataArray.length > 0 ? sum / dataArray.length : 0;
      let normalizedVolume = (averageVolume / 140) * 100;
      normalizedVolume = Math.min(100, Math.max(0, normalizedVolume));

      meterLevel.style.width = normalizedVolume + '%';

      let activeColor;
      if (normalizedVolume <= 50) {
        const factor = normalizedVolume / 50;
        activeColor = interpolateColor(LOW_COLOR, MID_COLOR, factor);
      } else {
        const factor = (normalizedVolume - 50) / 50;
        activeColor = interpolateColor(MID_COLOR, HIGH_COLOR, factor);
      }
      // ìŒëŸ‰ ë°” ê·¸ë¼ë°ì´ì…˜ ì‹œì‘ ìƒ‰ì„ GNB ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ í•˜ì—¬ ë” ì–´ìš¸ë¦¬ë„ë¡ ë³€ê²½
      const baseGradientColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim() || '#2a3340';
      meterLevel.style.background = `linear-gradient(to right, ${baseGradientColor}, ${activeColor})`;
    }

    function stopAudioAnalysis() {
      if (volumeMeterAnimationId) {
        cancelAnimationFrame(volumeMeterAnimationId);
        volumeMeterAnimationId = null;
      }
      if (microphoneSource) {
        microphoneSource.disconnect();
        microphoneSource = null;
      }
      if (analyserStream && analyserStream.getTracks) {
        analyserStream.getTracks().forEach(track => track.stop());
        analyserStream = null;
      }
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close().catch(e => console.error("AudioContext ë‹«ê¸° ì˜¤ë¥˜:", e));
        audioContext = null;
      }
      if (meterLevel) {
        meterLevel.style.width = '0%';
        meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg').trim();
      }
      analyser = null;
      dataArray = null;
    }

    // â”€â”€ GNB ë“œë¡­ë‹¤ìš´ ë©”ë‰´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    menuToggle.addEventListener('click', () => {
      dropdownMenu.classList.toggle('show');
    });
    document.addEventListener('click', (event) => {
      if (gnb && !gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
        dropdownMenu.classList.remove('show');
      }
    });

    // â”€â”€ ìŒì„± ì¸ì‹ (SpeechRecognition) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let recognition;
    let isRecognizing = false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'ko-KR';
      micButton.classList.remove('disabled');

      recognition.onstart = () => {
        isRecognizing = true;
        micButton.textContent = 'ğŸ’¬';
        micButton.style.backgroundColor = '#e74c3c';
        console.log("ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘");
      };

      recognition.onend = () => {
        isRecognizing = false;
        micButton.textContent = 'ğŸ¤';
        micButton.style.backgroundColor = 'var(--primary-color)';
        console.log("ğŸ¤ ìŒì„± ì¸ì‹ ì¢…ë£Œ");
        setLoading(false);
        stopAudioAnalysis();
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        if (interimTranscript) showInterim(interimTranscript);
        if (finalTranscript) {
          document.querySelector('.bubble.user.interim')?.remove();
          handleUserText(finalTranscript);
        }
      };

      recognition.onerror = (event) => {
        console.error("âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event.error);
        appendBubble(event.error === 'not-allowed' || event.error === 'service-not-allowed' ?
          "ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”." :
          "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "bot");
        isRecognizing = false;
        micButton.textContent = 'ğŸ¤';
        micButton.style.backgroundColor = 'var(--primary-color)';
        setLoading(false);
        stopAudioAnalysis();
      };
    } else {
      console.warn("âš ï¸ ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      micButton.title = "ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
      micButton.disabled = true;
    }

    micButton.addEventListener('click', async () => {
      if (!SpeechRecognition) return;

      if (isRecognizing) {
        recognition.stop();
      } else {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          setupAudioAnalysis(stream);
          recognition.start();
          setLoading(true);
        } catch (err) {
          console.error("âŒ ë§ˆì´í¬ ê¶Œí•œ ë˜ëŠ” ì‹œì‘ ì˜¤ë¥˜:", err);
          appendBubble("ë§ˆì´í¬ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "bot");
          stopAudioAnalysis();
        }
      }
    });

    // â”€â”€ ì‚¬ìš©ì ì •ë³´ ë° ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
    const userAge       = localStorage.getItem('lozee_userage');
    const userName      = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const userId        = localStorage.getItem('lozee_userid') || 'anonymous';
    const userDisease   = localStorage.getItem('lozee_disease') || 'ASD';
    const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');

    if (Object.keys(selectedTopic).length > 0) {
        await initConversation();
    } else {
        appendBubble("ì•ˆë…•í•˜ì„¸ìš”! ë¨¼ì € í™ˆì—ì„œ ëŒ€í™” ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "bot");
    }

    function appendBubble(text, role) {
      const el = document.createElement('div');
      el.className = `bubble ${role}`;
      el.textContent = text;
      chatContainer.appendChild(el);
      requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
    }

    function showInterim(text) {
      let el = document.querySelector('.bubble.user.interim');
      if (!el) {
        el = document.createElement('div');
        el.className = 'bubble user interim';
        chatContainer.appendChild(el);
      }
      el.textContent = text;
      requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
    }

    function setLoading(flag) {
      sendButton.disabled = flag;
      if (SpeechRecognition) {
          micButton.disabled = flag && !isRecognizing;
      } else {
          micButton.disabled = true;
      }
      sendButton.classList.toggle('loading', flag);
    }

    async function initConversation() {
      setLoading(true);
      const prompt = getFirstQuestion(userAge, selectedTopic);
      appendBubble(prompt, 'bot');
      try { await playTTSFromText(prompt, selectedVoice); }
      catch (ttsError) { console.error("TTS ì˜¤ë¥˜ (ì´ˆê¸° ëŒ€í™”):", ttsError); }
      setLoading(false);
    }

    async function handleUserText(text) {
      if (!text.trim()) return;
      document.querySelector('.bubble.user.interim')?.remove();
      appendBubble(text, 'user');
      setLoading(true);
      try {
        const res = await getGptResponse(text, { userId, userAge, userName, userDisease, messages: [{ role: "user", content: text }] });
        const data = await res.json();
        const botMessage = data?.rephrasing || data?.text || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”.";
        appendBubble(botMessage, 'bot');
        await playTTSFromText(botMessage, selectedVoice);
      } catch (err) {
        console.error("âŒ GPT/TTS ì²˜ë¦¬ ì˜¤ë¥˜:", err);
        appendBubble("ì£„ì†¡í•´ìš”, ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", 'bot');
      }
      setLoading(false);
      chatInput.value = '';
      chatInput.focus();
    }

    sendButton.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (text && !sendButton.disabled) handleUserText(text);
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (text && !sendButton.disabled) handleUserText(text);
      }
    });
  });
</script>
</body>
</html>
