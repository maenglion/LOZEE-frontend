<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; font-family: 'KoPubWorld Dotum', sans-serif; background: #fff; color: #333; display: flex; flex-direction: column; height: 100vh; }
    .hidden { display: none !important; }
    /* Intro Screens */
    #intro-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
    .intro-screen { width: 100%; max-width: 500px; text-align: center; }
    .intro-screen h2 { margin-bottom: 1rem; font-size: 1.5rem; }
    .intro-screen p { margin-bottom: 1.5rem; line-height: 1.4; }
    .intro-screen input, .intro-screen textarea { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
    .btn { padding: 0.75rem 1.5rem; background: #0095FF; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
    /* Chat UI */
    #main-header { background-color: #0095FF; color: white; padding: 1rem; text-align: center; font-size: 20px; flex-shrink: 0; }
    #chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; white-space: pre-wrap; }
    .user { background: #fff9c4; align-self: flex-end; border-bottom-right-radius: 5px; }
    .ai { background: #0095FF; color: #fff; align-self: flex-start; border-bottom-left-radius: 5px; }
    #talk-btn-container { padding: 15px; text-align: center; border-top: 1px solid #eee; }
    #talk-btn { width: 80px; height: 80px; border-radius: 50%; background-color: #b6b6b6; border: none; color: white; font-size: 36px; cursor: pointer; transition: transform 0.2s, background-color 0.3s; }
    #talk-btn.recording { background: #e06c75; transform: scale(1.1); }
  </style>
</head>
<body>
  <!-- Intro Flow -->
  <div id="intro-container">
    <div class="intro-screen" data-step="0">
      <h2>ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­</h2>
      <p>LOZEEê°€ ìŒì„±ì„ ë“£ê¸° ìœ„í•´ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš”.</p>
      <button class="btn" id="request-permission-btn">ê¶Œí•œ í—ˆìš©í•˜ê¸°</button>
    </div>
    <div class="intro-screen hidden" data-step="1">
      <h2>LOZEEì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•´ìš”</h2>
      <p>LOZEEê°€ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ì–´ì¤„ê²Œìš”.</p>
      <button class="btn intro-next">ë‹¤ìŒ</button>
    </div>
    <div class="intro-screen hidden" data-step="2">
      <h2>ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”</h2>
      <input type="text" id="user-name-input" placeholder="ì´ë¦„ ì…ë ¥" />
      <button class="btn intro-next">ë‹¤ìŒ</button>
    </div>
    <div class="intro-screen hidden" data-step="3">
      <h2>ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</h2>
      <input type="number" id="user-age-input" placeholder="ë‚˜ì´ ì…ë ¥" />
      <button class="btn intro-next">ë‹¤ìŒ</button>
    </div>
    <div class="intro-screen hidden" data-step="4">
      <h2>ì•Œë ¤ë‘˜ ì •ë³´ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</h2>
      <textarea id="user-info-input" rows="4" placeholder="ì§„ë‹¨ ì •ë³´, ì–¸ì–´ íŠ¹ì„± ë“±"></textarea>
      <button class="btn intro-next">ë‹¤ìŒ</button>
    </div>
    <div class="intro-screen hidden" data-step="5">
      <h2>ì´ì œ ì‹œì‘í• ê²Œìš”</h2>
      <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
      <button class="btn" id="start-conversation-btn">ëŒ€í™” ì‹œì‘</button>
    </div>
  </div>

  <!-- Chat Interface -->
  <header id="main-header" class="hidden">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="chat-container" class="hidden">
    <div id="chat-window"></div>
  </div>
  <div id="talk-btn-container" class="hidden">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { startSTT, stopSTT } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    // Intro logic
    const steps = document.querySelectorAll('.intro-screen');
    let currentStep = 0;
    const nextButtons = document.querySelectorAll('.intro-next');
    const requestPermBtn = document.getElementById('request-permission-btn');
    const startConvBtn = document.getElementById('start-conversation-btn');

    function showStep(index) {
      steps.forEach((el, i) => el.classList.toggle('hidden', i !== index));
    }

    requestPermBtn.addEventListener('click', async () => {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        showStep(1);
      } catch {
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }
    });
    nextButtons.forEach((btn, idx) => btn.addEventListener('click', () => showStep(idx + 2)));
    startConvBtn.addEventListener('click', () => {
      // ì €ì¥
      const name = document.getElementById('user-name-input').value || 'ì¹œêµ¬';
      localStorage.setItem('lozee_username', name);
      document.getElementById('intro-container').classList.add('hidden');
      document.getElementById('main-header').classList.remove('hidden');
      document.getElementById('chat-container').classList.remove('hidden');
      document.getElementById('talk-btn-container').classList.remove('hidden');
      initConversation();
    });

    // Chat logic
    const chatWindow = document.getElementById('chat-window');
    const talkBtn = document.getElementById('talk-btn');
    let firstInteraction = false;
    let initialGreeting = '';

    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function initConversation() {
      const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      initialGreeting = await getInitialGreeting(userName);
      appendMessage(initialGreeting, 'ai');
    }

    talkBtn.addEventListener('click', async () => {
      if (!firstInteraction) {
        firstInteraction = true;
        talkBtn.disabled = true;
        await playTTSFromText(initialGreeting);
        talkBtn.disabled = false;
        return;
      }
      if (!talkBtn.classList.contains('recording')) {
        talkBtn.classList.add('recording');
        await startSTT();
      } else {
        talkBtn.disabled = true;
        const transcript = await stopSTT();
        talkBtn.classList.remove('recording');
        appendMessage(transcript, 'user');
        const aiText = await getGptResponse(transcript);
        appendMessage(aiText, 'ai');
        await playTTSFromText(aiText);
        talkBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
