<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEÏôÄ ÎåÄÌôîÌïòÍ∏∞</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
<style>
  :root {
      --primary-color: #6e8efb;
      --secondary-color: #5a7edf;
      --background-color: #ffffff;
      --text-color: #333333;
      
      --gnb-bg: #6878E9; /* GNB Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω */
      --gnb-text-color: #ffffff;
      --gnb-title-color: #ffffff; /* GNB ÌÉÄÏù¥ÌãÄ Ìù∞ÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω */
      --gnb-menu-toggle-color: #ffffff; /* ÌñÑÎ≤ÑÍ±∞ Î©îÎâ¥ ÏïÑÏù¥ÏΩò Ìù∞ÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω */
      --gnb-dropdown-bg: var(--gnb-bg);
      --gnb-dropdown-text-color: var(--gnb-text-color);
      --gnb-dropdown-border-color: #4a5568;
      --gnb-dropdown-hover-bg: var(--secondary-color);

      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --assistant-bubble-bg: #F5E7A1; /* Î°úÏßÄ ÎßêÌíçÏÑ† Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω */
      --assistant-bubble-text: #333333;

      --input-area-bg: #f8f9fa;
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef;
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px;
      --meter-top-margin: 8px;

      --analysis-notification-bg: #fff3cd;
      --analysis-notification-text: #856404;

      --gnb-height: 56px;
      --chat-input-area-height: 70px;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    #gnb {
      padding: 0 30px; 
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--gnb-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gnb-title-color);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gnb-menu-toggle-color);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--gnb-dropdown-bg);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.2);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 300px;
    }

    #dropdown-menu a {
      display: block;
      padding: 12px 16px;
      text-decoration: none;
      color: var(--gnb-dropdown-text-color);
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
      font-size: 0.95em;
    }
    #dropdown-menu a:last-child {
      border-bottom: none;
    }
    #dropdown-menu a:hover {
      background-color: var(--gnb-dropdown-hover-bg);
    }

    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px;
      transition: width 0.05s linear, background-color 0.05s linear;
    }
    
    #chat-window {
      flex: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
      padding-bottom: calc(var(--chat-input-area-height) + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.assistant_feedback { 
      background: #e9ecef; 
      color: #495057;
      align-self: center; 
      font-size: 0.9em;
      border-radius: 8px;
    }
    .bubble.thinking { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-style: italic;
      opacity: 0.8;
    }


    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    #topic-area {
      display: none !important; 
    }

    #input-area {
      padding: 0 30px; 
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; 
      align-items: center;
      gap: 8px;
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px;
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px;
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn {
      width: 44px;
      min-width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording {
      background: #e74c3c;
    }
    #send-btn.loading {
        background:#cccccc;
        cursor:default;
    }
    
    @media (max-width: 600px) {
      #gnb { padding: 0 20px; } 
      #input-area { padding: 0 20px; } 
      #gnb-title { font-size: 1.1em; }
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
    }

    .chat-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
      align-items: flex-start;
      max-width: 80%;
      align-self: flex-start;
    }

    .chat-option-btn {
      background-color: #f1f1f1;
      color: #333333;
      border: 1px solid #dcdcdc;;
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .chat-option-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-1px);
    }
    .chat-option-btn.selected {
      background-color: #E4D2FD;
      color: #333;
      border-color: #c3b2e0; 
      font-weight: bold;
    }
    .chat-option-btn:disabled {
      background-color: #f8f8f8;
      color: #aaaaaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">‚ò∞</button>
    <div id="dropdown-menu">
      <a href="mypage.html">My Page</a>
      <a href="index.html">Ï£ºÏ†ú Î≥ÄÍ≤Ω</a>
      <a href="analysis.html">ÎåÄÌôî Î∂ÑÏÑù</a>
      <a href="journal-list.html">ÎåÄÌôî Î™©Î°ù</a>
    </div>
  </nav>
  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-window"></div>
  <div id="input-area">
    <button id="mic-button">üé§</button>
    <input id="chat-input" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off" />
    <button id="send-btn">‚û§</button>
  </div>

  <script type="module">
    import './js/firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { saveSessionLog } from './js/firebase-utils.js';
    import { counselingTopicsByAge } from './js/counseling_topics.js';

    // ÏÉÅÌÉú Î≥ÄÏàò
    let skipTTS = false;
    let hasGreeted = false;
    let isProcessing = false;
    let chatHistory = [];
    let selectedMain = null;
    let meta = { lastInputTimestamp: Date.now(), fillerCount: 0, clickedOption: false, presentedIndices:[] };
    let isPlayingTTS = false; 
    let conversationStartTime = null;
    let analysisNotificationShown = false;

    // UI ÏöîÏÜå
    const chatWindow = document.getElementById('chat-window');
    const topicArea = document.getElementById('topic-area'); 
    const inputArea = document.getElementById('input-area');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const micButton = document.getElementById('mic-button');
    const menuToggle = document.getElementById('menu-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const meterLevel = document.getElementById('volume-level');

    // GNB Î©îÎâ¥ ÌÜ†Í∏Ä
    menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
    document.addEventListener('click', e => {
      if (!document.getElementById('gnb').contains(e.target)) {
        dropdownMenu.classList.remove('show');
      }
    });

    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥
    const userName = localStorage.getItem('lozee_username') || 'ÏπúÍµ¨';
    const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
    const voc = getKoreanVocativeParticle(userName);

    // Ï¥àÍ∏∞Ìôî Î°úÏßÅ
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('‚úÖ js/firebase-config.js Î™®Îìà Î°úÎìúÎê®');
      console.log('DOMContentLoaded Ïù¥Î≤§Ìä∏ Î∞úÏÉù');
      
      conversationStartTime = Date.now(); 

      const greeting = getInitialGreeting(userName + voc, hasGreeted);
      appendMessage(greeting, 'assistant');
      
      // Ï≤´ TTSÎäî ÏÇ¨Ïö©Ïûê Ïù∏ÌÑ∞ÎûôÏÖò Ïú†ÎèÑ ÌõÑ Ïû¨ÏÉùÌïòÎäî Í≤ÉÏù¥ Ï¢ãÏúºÎØÄÎ°ú, ÏùºÎã® Ï£ºÏÑù Ï≤òÎ¶¨
      // try {
      //   await playTTSWithControl(greeting);
      // } catch (error) {
      //   console.warn("Ï≤´ TTS ÏûêÎèô Ïû¨ÏÉù ÏãúÎèÑ Ï§ë Ïò§Î•ò(Î¨¥Ïãú Í∞ÄÎä•):", error);
      // }
      console.log("Ï≤´ Ïù∏ÏÇ¨ TTSÎäî ÏÇ¨Ïö©Ïûê Ïù∏ÌÑ∞ÎûôÏÖò ÌõÑ Ïû¨ÏÉùÎêòÎèÑÎ°ù Î°úÏßÅ Î≥ÄÍ≤ΩÏùÑ Í≥†Î†§ÌïòÏÑ∏Ïöî. (ÌòÑÏû¨ ÏûêÎèô Ïû¨ÏÉù Ïïà Ìï®)");
      
      hasGreeted = true;
      showMainTopics();
    });

    // Î©îÏãúÏßÄ Í¥ÄÎ†® Ìï®Ïàò
    function appendMessage(text, role) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + role; 
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showAnalysis() {
      if (analysisNotificationShown) return; // Ïù¥ÎØ∏ ÏïåÎ¶ºÏù¥ ÌëúÏãúÎêòÏóàÏúºÎ©¥ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
      const notification = document.createElement('div');
      notification.className = 'analysis-notification';
      notification.textContent = 'üü°Î∂ÑÏÑù ÏôÑÎ£å';
      notification.onclick = () => {
        // Î∂ÑÏÑù Í≤∞Í≥ºÎ•º localStorage Îì±Ïóê Ï†ÄÏû•ÌïòÏó¨ analysis.htmlÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù Ï†ÑÎã¨
        // Ïòà: localStorage.setItem('currentAnalysisDataForPage', JSON.stringify(chatHistory));
        location.href = 'analysis.html';
      }
      chatWindow.appendChild(notification);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      analysisNotificationShown = true; 
    }

    // TTS Ï†úÏñ¥ Ïû¨ÏÉù Ìï®Ïàò
    async function playTTSWithControl(txt) {
      stopCurrentTTS();
      if (skipTTS) {
        skipTTS = false;
        return Promise.resolve(); 
      }
      isPlayingTTS = true;
      try {
        await playTTSFromText(txt, localStorage.getItem('lozee_voice'));
      } catch (error) {
        console.error("playTTSWithControl ÎÇ¥ TTS Ïû¨ÏÉù Ïò§Î•ò:", error);
      } finally {
        isPlayingTTS = false;
      }
    }

    // Ïò§ÎîîÏò§ Î∂ÑÏÑù Í¥ÄÎ†®
    let audioContext, analyser, source, dataArray, animId, streamRef;
    const LOW = { r:0, g:200, b:0 }; const MID = { r:255, g:200, b:0 }; const HIGH = { r:255, g:69, b:0 };
    function interp(c1, c2, f) { return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;}
    function setupAudioAnalysis(stream) { if (audioContext && audioContext.state !== 'closed') audioContext.close(); audioContext = new AudioContext(); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; source = audioContext.createMediaStreamSource(stream); source.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); streamRef = stream; draw(); }
    function draw() { animId = requestAnimationFrame(draw); if (!analyser || !dataArray) return; analyser.getByteFrequencyData(dataArray); let sum = dataArray.reduce((a, v) => a + v, 0); let avg = sum / dataArray.length; let norm = Math.min(100, Math.max(0, (avg / 140) * 100)); meterLevel.style.width = norm + '%'; let col = norm <= 50 ? interp(LOW, MID, norm / 50) : interp(MID, HIGH, (norm - 50) / 50); meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${col})`; if (norm > 10 && isRec && isPlayingTTS && !skipTTS) { console.log("ÏÇ¨Ïö©Ïûê ÏùåÏÑ± Í∞êÏßÄ, TTS Ï§ëÎã® ÏãúÎèÑ"); stopCurrentTTS(); skipTTS = true; } }
    function stopAudio() { if (animId) cancelAnimationFrame(animId); if (source) source.disconnect(); if (streamRef) streamRef.getTracks().forEach(track => track.stop()); if (audioContext && audioContext.state !== 'closed') { audioContext.close(); } audioContext = null; meterLevel.style.width = '0%'; meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-container-bg'); }

    // STT (Web Speech API)
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog, isRec = false;
    if (SpeechRecognitionAPI) {
      recog = new SpeechRecognitionAPI(); 
      recog.continuous = false; 
      recog.interimResults = false; 
      recog.lang = 'ko-KR';
      recog.onstart = () => { isRec = true; micButton.classList.add('recording'); };
      recog.onend = () => { isRec = false; micButton.classList.remove('recording'); stopAudio(); };
      recog.onresult = event => { let transcript = ''; for (let i = event.resultIndex; i < event.results.length; i++) { if (event.results[i].isFinal) { transcript += event.results[i][0].transcript; } } if (transcript) { console.log("STT Í≤∞Í≥º:", transcript); sendMessage(transcript, 'stt'); } };
      recog.onerror = event => { console.error('Speech recognition error:', event.error); appendMessage('ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò: ' + event.error, 'assistant_feedback'); isRec = false; micButton.classList.remove('recording'); stopAudio(); };
      micButton.onclick = async () => { if (isRec) { recog.stop(); } else { stopCurrentTTS(); skipTTS = true; try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); setupAudioAnalysis(stream); recog.start(); } catch (e) { console.error('ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Ïò§Î•ò:', e); appendMessage('ÎßàÏù¥ÌÅ¨ ÏÇ¨Ïö© Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'assistant_feedback'); } } };
    } else { micButton.disabled = true; appendMessage('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'assistant_feedback'); }

    // ÌÜ†ÌîΩ ÌîåÎ°úÏö∞ - ÏÑ†ÌÉùÏ∞Ω
    function displayOptionsInChat(optionsArray, onSelectCallback, context = null) { console.log("displayOptionsInChat Ìï®Ïàò ÏãúÏûëÎê®, ÏòµÏÖò Î∞∞Ïó¥:", optionsArray); const optionsContainer = document.createElement('div'); optionsContainer.className = 'chat-options-container'; const buttons = []; optionsArray.forEach(optionObject => { let buttonText; let displayTextForCallback; if (typeof optionObject === 'string') { buttonText = optionObject; displayTextForCallback = optionObject; console.log("ÏòµÏÖò Î≤ÑÌäº ÏÉùÏÑ± Ï§ë (Î¨∏ÏûêÏó¥):", optionObject); } else if (optionObject && typeof optionObject.displayText !== 'undefined') { buttonText = optionObject.icon ? `${optionObject.icon} ${optionObject.displayText}` : optionObject.displayText; displayTextForCallback = optionObject.displayText; console.log("ÏòµÏÖò Î≤ÑÌäº ÏÉùÏÑ± Ï§ë (Í∞ùÏ≤¥):", optionObject.displayText); } else { console.warn("displayOptionsInChat: ÏûòÎ™ªÎêú ÌòïÏãùÏùò ÏòµÏÖòÏûÖÎãàÎã§.", optionObject); return; } const button = document.createElement('button'); button.className = 'chat-option-btn'; button.textContent = buttonText; button.onclick = () => { buttons.forEach(btn => { btn.disabled = true; if (btn === button) { btn.classList.add('selected'); } }); onSelectCallback(displayTextForCallback, context); }; optionsContainer.appendChild(button); buttons.push(button); }); chatWindow.appendChild(optionsContainer); console.log("ÏòµÏÖò Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä chatWindowÏóê Ï∂îÍ∞ÄÎê®"); chatWindow.scrollTop = chatWindow.scrollHeight; }

    // ÌÜ†ÌîΩ ÌîåÎ°úÏö∞ - Ï£ºÏ†ú
    function showMainTopics() { console.log("showMainTopics Ìï®Ïàò ÏãúÏûëÎê®"); appendMessage('Ïñ¥Îñ§ Ïù¥ÏïºÍ∏∞Î•º ÎÇòÎà†Î≥ºÍπå?', 'assistant'); const currentAgeGroup = getAgeGroup(); const ageGroupData = counselingTopicsByAge[currentAgeGroup]; let topicsWithOptions = []; if (ageGroupData) { topicsWithOptions = Object.keys(ageGroupData).map(categoryName => { let icon = 'üí¨'; if (ageGroupData[categoryName] && ageGroupData[categoryName].length > 0 && ageGroupData[categoryName][0].icon) { icon = ageGroupData[categoryName][0].icon; } return { icon: icon, displayText: categoryName }; }); } else { console.warn(`counselingTopicsByAgeÏóê '${currentAgeGroup}'Ïóê ÎåÄÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`); } topicsWithOptions.push({ icon: 'üó£Ô∏è', displayText: 'ÏûêÏú†Ï£ºÏ†ú' }); console.log("displayOptionsInChatÏóê Ï†ÑÎã¨Îê† Î∞∞Ïó¥:", topicsWithOptions); displayOptionsInChat(topicsWithOptions, (selectedTopicText) => { selectedMain = selectedTopicText; appendMessage(selectedMain + ' Ïù¥ÏïºÍ∏∞Î•º ÏÑ†ÌÉùÌñàÍµ¨ÎÇò!', 'assistant'); setTimeout(showSubTopics, 300); }); if (topicArea) topicArea.style.display = 'none !important'; }
   
    function showSubTopics() { if (!selectedMain) { console.warn("showSubTopics Ìò∏Ï∂úÎêòÏóàÏúºÎÇò, selectedMainÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."); return;  } console.log("showSubTopics Ìï®Ïàò ÏãúÏûëÎê®, ÏÑ†ÌÉùÎêú Î©îÏù∏ Ï£ºÏ†ú:", selectedMain); appendMessage('Ï°∞Í∏à Îçî Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Ïù¥ÏïºÍ∏∞Ìï¥ Ï§ÑÎûò?', 'assistant'); let subtopicOptions; if (selectedMain === 'ÏûêÏú†Ï£ºÏ†ú') { subtopicOptions = [{ icon: 'üó£Ô∏è', displayText: 'Ïùë, ÏûêÏú†Î°≠Í≤å Ïù¥ÏïºÍ∏∞ ÏãúÏûëÌï¥Ï§ò!' }]; } else { const ageGroupData = counselingTopicsByAge[getAgeGroup()]; const mainTopicData = ageGroupData ? ageGroupData[selectedMain] : undefined; if (mainTopicData && Array.isArray(mainTopicData)) { subtopicOptions = mainTopicData;  } else { console.warn(`'${selectedMain}'Ïóê ÎåÄÌïú ÌïòÏúÑ Ï£ºÏ†úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò ÌòïÏãùÏù¥ ÏûòÎ™ªÎêòÏóàÏäµÎãàÎã§.`); subtopicOptions = [{ icon: 'üí¨', displayText: 'ÎåÄÌôîÎ•º ÏãúÏûëÌï† Ï§ÄÎπÑÍ∞Ä ÎêêÏñ¥.' }]; } if (!subtopicOptions || !subtopicOptions.length) {  subtopicOptions = [{ icon: '‚ñ∂Ô∏è', displayText: 'Î∞îÎ°ú ÎåÄÌôî ÏãúÏûëÌï†Íπå?' }]; } } console.log("displayOptionsInChatÏóê Ï†ÑÎã¨Îê† ÌïòÏúÑ Ï£ºÏ†ú Î∞∞Ïó¥ (ÏàòÏ†ï ÌõÑ):", subtopicOptions); displayOptionsInChat(subtopicOptions, (selectedSubtopicText) => { startChat(selectedSubtopicText); }); if (topicArea) topicArea.style.display = 'none !important'; }

    function startChat(initText) { console.log("startChat Ìï®Ïàò ÏãúÏûëÎê®, Ï¥àÍ∏∞ Î©îÏãúÏßÄ:", initText); if (topicArea) topicArea.style.display = 'none !important'; inputArea.style.display = 'flex'; sendMessage(initText, 'topic_selection_init'); /* Ï£ºÏ†ú ÏÑ†ÌÉù ÏôÑÎ£å ÌõÑ ÏãúÏûëÎêòÎäî Î©îÏãúÏßÄÏù¥ÎØÄÎ°ú inputMethod Î≥ÄÍ≤Ω */ }   

    function getAgeGroup() { if (userAge <= 10) return '7-10'; if (userAge <= 15) return '11-15'; return '30+'; }  

    // Stuck Detection
    function detectStuck(txt, his, meta) { const now = Date.now(); if (meta.lastInputTimestamp && (now - meta.lastInputTimestamp) > 300000) return true; if (meta.fillerCount >= 3) return true; const recentUserMessages = his.filter(m => m.role === 'user').slice(-5); if (recentUserMessages.length === 5 && recentUserMessages.every(m => m.content.trim().length < 5)) return true; if (meta.clickedOption) return false; return false; }
    
    // Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò
    async function sendMessage(text, inputMethod = 'text') { 
      if (!text || String(text).trim() === '' || isProcessing) return;
      isProcessing = true;
      sendBtn.classList.add('loading');

      if (inputMethod !== 'topic_selection_init') { 
        appendMessage(text, 'user');
      }
      chatHistory.push({ role: 'user', content: text }); 
      chatInput.value = '';

      const thinkingBubble = document.createElement('div');
      thinkingBubble.className = 'bubble assistant thinking'; 
      thinkingBubble.textContent = 'ÏÉùÍ∞ÅÏ§ëÏù¥Ïïº...'; 
      chatWindow.appendChild(thinkingBubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const res = await getGptResponse(text, { chatHistory }); 
        thinkingBubble.remove(); 

        if (!res.ok) {
            const errorData = await res.text();
            console.error(`GPT API ÏùëÎãµ Ïò§Î•ò ${res.status}: ${errorData}`);
            appendMessage("ÎØ∏Ïïà, ÏßÄÍ∏àÏùÄ ÎãµÎ≥ÄÌïòÍ∏∞ Ï°∞Í∏à Ïñ¥Î†§Ïõå. (ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò)", "assistant_feedback");
            return; 
        }
        const d = await res.json();
        const cut = d.text.indexOf('{'); 
        const clean = cut >= 0 ? d.text.slice(0, cut).trim() : d.text.trim();
        
        appendMessage(clean, 'assistant'); 

        if (inputMethod === 'stt') { 
            await playTTSWithControl(clean);
        } else if (inputMethod === 'text' && !skipTTS) { 
            // ÌÖçÏä§Ìä∏ ÏûÖÎ†• Ïãú TTSÎ•º ÏõêÌïòÏãúÎ©¥ ÏïÑÎûò Ï£ºÏÑù Ìï¥Ï†ú
            // await playTTSWithControl(clean); 
            console.log("ÌÖçÏä§Ìä∏ ÏûÖÎ†•Ïóê ÎåÄÌïú ÏùëÎãµ. TTSÎäî ÌòÑÏû¨ Ïû¨ÏÉù Ïïà Ìï®.");
        }
        if (skipTTS) skipTTS = false; 
        
        chatHistory.push({ role: 'assistant', content: clean });
        await saveSessionLog(text, clean, d.analysis || {}); 

        const elapsedTimeInMinutes = (Date.now() - conversationStartTime) / (1000 * 60);
        // ÌÖåÏä§Ìä∏Î•º ÏúÑÌï¥ 15Î∂Ñ(elapsedTimeInMinutes >= 10)ÏúºÎ°ú Î≥ÄÍ≤Ω
        if (elapsedTimeInMinutes >= 15 && !analysisNotificationShown) { 
            console.log(`${elapsedTimeInMinutes.toFixed(5)}Î∂Ñ Í≤ΩÍ≥º, ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏãúÎèÑ`);
            // Î∂ÑÏÑù Í≤∞Í≥º Ï†ÄÏû• Î∞è ÏïåÎ¶º Î°úÏßÅ (analysis.htmlÏóêÏÑú ÏÇ¨Ïö©)
            let detailedAnalysisData = {};
            if (LOZEE_ANALYSIS && LOZEE_ANALYSIS.inferAgeAndLanguage) {
                try {
                    const langAgeResult = await LOZEE_ANALYSIS.inferAgeAndLanguage(chatHistory.map(m=>`${m.role}: ${m.content}`).join('\n'));
                    detailedAnalysisData.ageLanguageAnalysis = langAgeResult;
                } catch (e) { console.error("inferAgeAndLanguage Ïò§Î•ò:", e); }
            }
            // Ïó¨Í∏∞Ïóê Îã§Î•∏ Î∂ÑÏÑù Í≤∞Í≥ºÎì§ Ï∂îÍ∞Ä Í∞ÄÎä•
            // Ïòà: detailedAnalysisData.emotionTone = await LOZEE_ANALYSIS.getOverallEmotionTone(chatHistory);

            if(Object.keys(detailedAnalysisData).length > 0) {
                localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                    startTime: conversationStartTime,
                    analysisTime: Date.now(),
                    results: detailedAnalysisData
                }));
                showAnalysis(); //"Î∂ÑÏÑù ÏôÑÎ£å" ÏïåÎ¶º ÌëúÏãú Î∞è analysisNotificationShown = true; Î°ú ÏÑ§Ï†ïÎê®
            }
        }

      } catch (error) {
        if(thinkingBubble) thinkingBubble.remove(); 
        console.error("sendMessage ÎÇ¥ Ïò§Î•ò:", error);
        appendMessage("ÎØ∏Ïïà, ÏßÄÍ∏àÏùÄ ÎãµÎ≥ÄÌïòÍ∏∞ Ï°∞Í∏à Ïñ¥Î†§Ïõå. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï§ÑÎûò?", "assistant_feedback");
      } finally {
        isProcessing = false;
        sendBtn.classList.remove('loading');
      }
    }   

    // Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
    sendBtn.addEventListener('click', () => sendMessage(chatInput.value, 'text')); 
    chatInput.addEventListener('keydown', e => {
      meta.lastInputTimestamp = Date.now();
      meta.clickedOption = false;
      // const fillers = ['Ïùå','‚Ä¶','Ïñ¥','Í∏ÄÏéÑ','Î™®Î•¥Í≤†Ïñ¥Ïöî','Ïûò Î™®Î•¥Í≤†Ïñ¥']; 
      // meta.fillerCount = fillers.some(f => chatInput.value.includes(f)) ? meta.fillerCount + 1 : 0; // ÌïÑÏöîÏãú ÌôúÏÑ±Ìôî
      
      if (isPlayingTTS) { 
        stopCurrentTTS();
        skipTTS = true;
      }
      
      if (e.key === 'Enter' && !e.isComposing) { 
        e.preventDefault(); 
        sendMessage(chatInput.value, 'text'); 
      }
    });
  </script>
</body>
</html>