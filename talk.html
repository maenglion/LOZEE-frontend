<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE ìƒë‹´</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display:flex; flex-direction:column; height:100vh; margin:0; font-family:'KoPubWorld Dotum',sans-serif; }
    #main-header { background:#0095FF; color:#fff; padding:1rem; text-align:center; font-size:1.25rem; }
    #status-bar { display:flex; align-items:center; justify-content:center; gap:1rem; background:#eef; padding:0.5rem; }
    #mic-indicator { font-size:0.9rem; }
    #vu-meter { width:100px; height:20px; background:#ccc; border-radius:4px; }
    #chat-window { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .bubble { max-width:80%; padding:0.75rem 1rem; border-radius:1rem; line-height:1.4; white-space:pre-wrap; }
    .user { background:#fff9c4; color:#333; align-self:flex-end; border-bottom-right-radius:0.25rem; }
    .ai   { background:#0095FF;  color:#fff; align-self:flex-start; border-bottom-left-radius:0.25rem; }
    #silence-banner { text-align:center; padding:0.5rem; background:#f0f0f0; color:#666; font-size:0.9rem; display:none; }
    #loading-indicator { display:none; text-align:center; padding:0.5rem; color:#555; font-style:italic; }
  </style>
</head>
<body>
  <header id="main-header">LOZEE ìƒë‹´</header>
  <div id="status-bar">
    <div id="mic-indicator">ğŸ”µ ëŒ€ê¸° ì¤‘</div>
    <canvas id="vu-meter"></canvas>
  </div>
  <div id="chat-window"></div>
  <div id="silence-banner">ë§ì”€í•˜ì‹œë©´ ë°”ë¡œ ë“¤ì–´ë“œë ¤ìš”</div>
  <div id="loading-indicator">ì²˜ë¦¬ ì¤‘...</div>

  <script type="module">
  import { playTTSFromText } from './js/tts.js';
  import { getGptResponse } from './js/gpt-dialog.js';

  // ìƒíƒœ ë¨¸ì‹ 
  const State = { READY:'READY', RECORD:'RECORD', SILENCE:'SILENCE', PROCESS:'PROCESS' };
  let currentState = State.READY, silenceTimer, chunkTimer;
  let recognition, userBubble;

  // DOM
  const chatWindow   = document.getElementById('chat-window');
  const micIndicator = document.getElementById('mic-indicator');
  const vuCanvas     = document.getElementById('vu-meter');
  const silenceBanner= document.getElementById('silence-banner');
  const loading      = document.getElementById('loading-indicator');

  // TTS ì„¤ì •
  const ttsVoice = localStorage.getItem('lozee_tts_voice') || 'ko-KR-Chirp3-HD-Vindemiatrix';

  function appendMessage(text, role) {
    const div = document.createElement('div'); div.className=`bubble ${role}`; div.textContent=text;
    chatWindow.appendChild(div); chatWindow.scrollTop=chatWindow.scrollHeight; return div;
  }
  function setMic(text){ micIndicator.textContent=text; }
  function showBanner(on){ silenceBanner.style.display=on?'block':'none'; }
  function showLoading(on){ loading.style.display=on?'block':'none'; }
  function transition(to){
    clearTimeout(silenceTimer); clearTimeout(chunkTimer);
    currentState=to; showBanner(to===State.SILENCE);
    console.log('Stateâ†’',to);
  }

  // system prompt builder
  function buildSystem(text){
    const ems=JSON.parse(localStorage.getItem('lozee_selected_emotions')||'[]');
    const emo=ems.length?`ìœ ì € ê°ì •: ${ems.map(e=>e.sub).join(', ')}.`:'';
    const age=parseInt(localStorage.getItem('lozee_user_age'),10)||0;
    const tone=age>=56?'ì¡´ëŒ“ë§ë¡œë§Œ ë‹µí•˜ì„¸ìš”.':'ë°˜ë§ë¡œë§Œ ë‹µí•˜ì„¸ìš”.';
    return [emo,text,tone].filter(Boolean).join(' ');
  }

  async function handleUserTurn(text, extra=''){
    appendMessage(text,'user'); showLoading(true);
    const prompt=buildSystem(extra);
    const res=await getGptResponse(text,prompt);
    const aiText=typeof res==='string'?res:(res.error||res.rephrasing||'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
    appendMessage(aiText,'ai');
    await playTTSFromText(aiText,ttsVoice);
    showLoading(false);
  }

  // STT init
  async function initSTT(){
    try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      setupVUMeter(stream);
    }catch(e){ appendMessage('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.','ai'); return; }
    recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
    recognition.lang='ko-KR'; recognition.continuous=true; recognition.interimResults=true;
    recognition.onresult=e=>{
      let interim='',final='';
      for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;
        e.results[i].isFinal?final+=t:interim+=t;
      }
      if(interim) userBubble.textContent=interim;
      if(final)   userBubble.textContent=final;
    };
    recognition.onspeechstart=onVoiceStart;
    recognition.onspeechend=onVoiceEnd;
    recognition.onerror=e=>console.warn('STT ì˜¤ë¥˜',e);
    // ì¦‰ì‹œ ë“£ê¸° ì‹œì‘
    transition(State.READY);
    recognition.start(); setMic('ğŸ”´ ë“£ê³  ìˆì–´ìš”');
  }

  function onVoiceStart(){
    if(currentState===State.READY||currentState===State.SILENCE){
      transition(State.RECORD);
      setMic('ğŸ”´ ë“£ê³  ìˆì–´ìš”');
      userBubble=appendMessage('','user');
      // 30ì´ˆ chunk timer
      chunkTimer=setTimeout(()=>{if(currentState===State.RECORD) onVoiceEnd();},30000);
    }
  }

  function onVoiceEnd(){
    if(currentState===State.RECORD){
      transition(State.SILENCE);
      setMic('ğŸ”µ ëŒ€ê¸° ì¤‘');
      recognition.stop();
      silenceTimer=setTimeout(async()=>{
        await handleUserTurn(userBubble.textContent);
        transition(State.READY);
        recognition.start(); setMic('ğŸ”´ ë“£ê³  ìˆì–´ìš”');
      },5000);
    }
  }

  // VU meter
  function setupVUMeter(stream){
    const ctx=new AudioContext();
    const src=ctx.createMediaStreamSource(stream);
    const analyser=ctx.createAnalyser(); analyser.fftSize=64;
    src.connect(analyser);
    const data=new Uint8Array(analyser.frequencyBinCount);
    const canvas=vuCanvas; const cw=canvas.width, ch=canvas.height;
    const dib=canvas.getContext('2d');
    function draw(){
      analyser.getByteFrequencyData(data);
      dib.clearRect(0,0,cw,ch);
      const barWidth=cw/data.length;
      data.forEach((v,i)=>{
        const h=(v/ch)*ch;
        dib.fillStyle='#4caf50';
        dib.fillRect(i*barWidth,ch-h,barWidth-1,h);
      });
      requestAnimationFrame(draw);
    }
    draw();
  }

  // intro
  async function initIntro(){
    const intro=localStorage.getItem('lozee_user_typed_intro');
    if(intro){await handleUserTurn(intro);localStorage.removeItem('lozee_user_typed_intro');}
  }

  window.addEventListener('DOMContentLoaded',async()=>{await initSTT();await initIntro();});
  </script>
</body>
</html>
