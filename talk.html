<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title> 
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; 
      background-color: #ffffff; 
      color: #333; 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      margin: 0;
      overflow: hidden; 
    }
    #main-header {
      background-color: #0095FF; color: white; padding: 0.8rem 1rem;
      text-align: center; font-size: 1.1em; 
      font-weight: bold; flex-shrink: 0; 
    }
    #chat-container { 
      flex: 1; display: flex; flex-direction: column; 
      overflow-y: hidden; 
      width: 100%; max-width: 700px; 
      margin: 0 auto; box-sizing: border-box; 
      position: relative; 
    }
    #chat-window { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      padding-bottom: 70px; 
      display: flex; 
      flex-direction: column; gap: 10px; 
    }
    .bubble { 
      max-width: 85%; padding: 10px 15px; border-radius: 18px; 
      line-height: 1.5; font-size: 1em; 
      white-space: pre-wrap; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.08); 
    }
    .user { 
      background-color: #FFFDE7; 
      color: #424242; align-self: flex-end; 
      margin-left: auto; border-bottom-right-radius: 5px; 
    }
    .ai { 
      background-color: #E3F2FD; 
      color: #1E88E5; align-self: flex-start; 
      margin-right: auto; border-bottom-left-radius: 5px; 
    }
    .bubble.ai.error { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }
    #loading-indicator-talk { 
      text-align: center; padding: 8px; display: none; 
      color: #757575; font-style: italic; font-size: 0.9em;
    }
    
    #input-controls-container { 
      padding: 10px; 
      background-color: #f5f5f5; 
      flex-shrink: 0; 
      border-top: 1px solid #e0e0e0; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 10px; 
      width: 100%;
      box-sizing: border-box;
      position: fixed; 
      bottom: 0;
      left: 0;
      z-index: 100;
    }

    #talk-btn, #toggle-input-btn { 
      width: 48px; height: 48px; 
      border-radius: 50%; 
      border: none; 
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
      color: white; 
      cursor: pointer; display: inline-flex; 
      justify-content: center; align-items: center; 
      transition: transform 0.1s ease, background-color 0.2s; 
      flex-shrink: 0; 
      font-weight: bold; 
      font-size: 20px; 
    }
    #talk-btn { 
      background-color: #0095FF; 
      font-size: 22px; 
    }
    #talk-btn.active { background-color: #ff4500; transform: scale(1.1); }
    #talk-btn:disabled { background-color: #bdbdbd; cursor: not-allowed; transform: scale(1.0); }

    #toggle-input-btn { 
      background-color: #FFEB3B; 
      color: #333; 
    }
    #toggle-input-btn:hover { opacity: 0.85; }
    #toggle-input-btn svg { 
        width: 24px; 
        height: 24px;
        fill: white; 
    }
     body.keyboard-mode #toggle-input-btn { 
        background-color: #0095FF; 
        color: white; 
    }

    #text-input-area {
      display: none; 
      flex-grow: 1; 
      display: flex; 
      align-items: flex-end; 
      gap: 8px; 
    }
    #user-text-input { 
      flex-grow: 1; 
      min-height: 22px; 
      max-height: 100px; 
      border-radius: 20px; 
      padding: 10px 15px; 
      border: 1px solid #bdbdbd; 
      font-size: 1em; 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      resize: none; 
      line-height: 1.4;
      overflow-y: auto; 
      background-color: white;
    }
    #send-text-btn { 
      background-color: #0095FF; 
      color: white; border: none; cursor: pointer;
      border-radius: 50%; 
      width: 40px; 
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0; 
      flex-shrink: 0; 
      transition: background-color 0.2s;
    }
    #send-text-btn svg { 
        width: 20px;
        height: 20px;
        fill: white;
    }
    #send-text-btn:hover { background-color: #0077cc; }
    #send-text-btn:disabled { background-color: #bdbdbd; }

    @media (max-width: 768px) {
      #chat-window {
        padding-bottom: 60px; 
      }
      body.keyboard-mode #chat-window {
         /* JSì—ì„œ adjustChatWindowPadding í•¨ìˆ˜ë¡œ ë™ì  ì¡°ì ˆ */
      }
      body.keyboard-mode #input-controls-container {
        /* ì´ë¯¸ fixedì´ë¯€ë¡œ ì¶”ê°€ ìŠ¤íƒ€ì¼ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ */
      }
      body.keyboard-mode #talk-btn { 
        display: none; 
      }
      body.keyboard-mode #text-input-area { 
        display: flex; 
      }
    }

    #topic-selection { /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ê³¼ ë™ì¼) */ }
    #waiting-overlay { /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ê³¼ ë™ì¼) */ }
  </style>
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>

  <div id="chat-container">
    <div id="chat-window"></div>
    <div id="topic-selection" style="display: none;">
      <h3>ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ê³  ì‹¶ì€ ì£¼ì œë¥¼ ê³¨ë¼ë³¼ë˜?</h3>
      <div id="topic-options"></div>
    </div>
  </div>

  <div id="loading-indicator-talk">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  
  <div id="input-controls-container">
    <button id="toggle-input-btn" aria-label="ì…ë ¥ ë°©ì‹ ì „í™˜">
      <span id="toggle-icon-text-T">T</span> 
      <svg viewBox="0 0 24 24" id="mic-icon-for-toggle-btn" style="display:none;"> 
        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path>
      </svg>
    </button>
    <div id="text-input-area"> 
      <textarea id="user-text-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
      <button id="send-text-btn" aria-label="ì „ì†¡">
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
        </svg>
      </button>
    </div>
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button> 
  </div>

  <div id="waiting-overlay" style="display: none;">
    <p><span id="waitingUserName"></span>ë‹˜, ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...<br><small>(í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”)</small></p>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';
    import { getIsPoliteByAge, speakInterjection } from './js/interjection-helper.js';

    console.log("talk.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (v3.21 - ì¶”ì„ìƒˆ ë° ì´ˆê¸°í™” ë¡œì§ ì˜¤ë¥˜ ìˆ˜ì •)");

    const talkBtn = document.getElementById('talk-btn');
    const chatWindow = document.getElementById('chat-window');
    const toggleInputBtn = document.getElementById('toggle-input-btn');
    const textInputArea = document.getElementById('text-input-area');
    const userTextInput = document.getElementById('user-text-input');
    const sendTextBtn = document.getElementById('send-text-btn');
    const inputControlsContainer = document.getElementById('input-controls-container');
    const toggleIconTextT = document.getElementById('toggle-icon-text-T'); 
    const micIconForToggleBtn = document.getElementById('mic-icon-for-toggle-btn'); 
    const loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
    const topicBox = document.getElementById('topic-selection'); 
    const waitingOverlay = document.getElementById('waiting-overlay'); 
    const waitingUserName = document.getElementById('waitingUserName'); 

    let currentInputMode = 'microphone'; 
    const currentUserName = localStorage.getItem('lozee_username') || "ì¹œêµ¬";
    const currentUserId = localStorage.getItem('lozee_username'); 
    document.title = `${currentUserName}ë‹˜ê³¼ì˜ LOZEE ëŒ€í™”`;
    const ADMIN_SECRET_PHRASE = "ë§¹ê³ ì–‘ì´"; 
    const ADMIN_EMAIL = "maengnanyoung@gmail.com";
    const MAX_RECORDING_DURATION = 45000; 
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer; 
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTime; 
    let maxDurationTimeoutId; 
    let userConsecutiveTurns = 0;
    const MAX_CONSECUTIVE_TURNS = 5;
    let lastUserUtterance = ""; 
    let consecutiveTurnTimeoutId; 
    const CONSECUTIVE_TURN_SILENCE_TIMEOUT = 7000; 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';
    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try { selectedEmotions = JSON.parse(selectedEmotionsString); } 
        catch (e) { console.error("ì„ íƒëœ ê°ì • localStorage íŒŒì‹± ì˜¤ë¥˜:", e); selectedEmotions = []; }
    }

    function adjustChatWindowPadding() { /* ì´ì „ê³¼ ë™ì¼ */ }
    function appendMessage(text, role = 'ai', isError = false) { /* ì´ì „ê³¼ ë™ì¼ */ }
    function disableAllInputs(disable = true, reason = "") { /* ì´ì „ê³¼ ë™ì¼ */ }
    function resetSilenceTimer() { /* ì´ì „ê³¼ ë™ì¼ */ }
    function startSilenceTimer() { /* ì´ì „ê³¼ ë™ì¼ */ }
    function startConsecutiveTurnSilenceTimer() { /* ì´ì „ê³¼ ë™ì¼ */ }
    function resetConsecutiveTurnSilenceTimer() { /* ì´ì „ê³¼ ë™ì¼ */ }
    
    async function handleUserInteraction(userText, context = {}) { 
      if (!userText || userText.trim() === "") { 
        console.warn("[handleUserInteraction] userTextê°€ ë¹„ì–´ìˆì–´ ì²˜ë¦¬ ì¤‘ë‹¨.");
        disableAllInputs(false, "ì‚¬ìš©ì ì…ë ¥ ì—†ìŒ"); // ì…ë ¥ UI í™œì„±í™” ë³´ì¥
        return; 
      }
      disableAllInputs(true, "AI ì‘ë‹µ ëŒ€ê¸° ì¤‘"); 
      loadingIndicatorTalk.style.display = 'block';
      clearTimeout(silenceTimer); 
      clearTimeout(consecutiveTurnTimeoutId);
      console.log("[handleUserInteraction] ì‹œì‘. UserText:", userText.substring(0,50), "Context:", context);

      try {
        // ì¶”ì„ìƒˆëŠ” ì‚¬ìš©ìì˜ ì—°ì† ë°œí™”ê°€ ëë‚˜ê³  AIê°€ ì‘ë‹µì„ ì‹œì‘í•  ë•Œë§Œ ì¬ìƒ
        if (userConsecutiveTurns === 0) { 
          console.log("[Interjection] ì¶”ì„ìƒˆ ì¬ìƒ ì‹œë„ (ì—°ì† ë°œí™” ì•„ë‹˜)...");
          try {
              const isPolite = getIsPoliteByAge();
              speakInterjection(isPolite); 
              console.log("[Interjection] ì¶”ì„ìƒˆ ì¬ìƒ ìš”ì²­ë¨.");
          } catch (e) {
              console.error("ì¶”ì„ìƒˆ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ (handleUserInteraction ë‚´ë¶€):", e);
          }
        }

        console.log("[handleUserInteraction] GPT ìš”ì²­ ì‹œì‘...");
        const gptContext = { userAge: currentUserAge, userDisease: currentUserDisease, ...context };
        const gptResponse = await getGptResponse(userText, currentUserId, gptContext); 
        console.log("GPT ì‘ë‹µ ê²°ê³¼ (handleUserInteraction):", gptResponse); 
        
        let aiReply = "ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ì´í•´í•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆì–´ìš”.";
        let isError = true;

        if (gptResponse) {
            if (gptResponse.rephrasing) { aiReply = gptResponse.rephrasing; isError = false;
                if (gptResponse.summary) { localStorage.setItem('lozee_lastSummary', gptResponse.summary); lastSummary = gptResponse.summary; }
            } else if (gptResponse.error) { aiReply = gptResponse.error; }
        }
        
        // AI ë©”ì‹œì§€ í‘œì‹œ ë° TTSëŠ” ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰
        // setTimeoutì„ Promiseë¡œ ê°ì‹¸ì„œ TTS ì™„ë£Œ í›„ disableAllInputs(false)ê°€ í˜¸ì¶œë˜ë„ë¡ í•  ìˆ˜ ìˆìœ¼ë‚˜,
        // í˜„ì¬ëŠ” TTS ì¬ìƒì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì´ë£¨ì–´ì§€ë¯€ë¡œ, UIëŠ” ì¦‰ì‹œ í™œì„±í™”ë˜ë„ë¡ í•¨.
        loadingIndicatorTalk.style.display = 'none'; 
        console.log("[handleUserInteraction] AI ì‘ë‹µ UIì— í‘œì‹œ ë° TTS ì‹œì‘. AI Reply:", aiReply.substring(0,50));
        appendMessage(aiReply, 'ai', isError); 
        
        if (!isError && aiReply) {
            try {
                await playTTSFromText(aiReply, currentVoiceId); 
                console.log("[handleUserInteraction] TTS ì¬ìƒ ì™„ë£Œ (ë˜ëŠ” ì‹œì‘ë¨).");
            } catch (e) { 
                console.error("TTS ì‹¤íŒ¨ (handleUserInteraction):", e.message ? e.message : e); 
            }
        }
        // disableAllInputs(false, "AI ì‘ë‹µ ì™„ë£Œ"); // finally ë¸”ë¡ìœ¼ë¡œ ì´ë™

      } catch (error) { 
        console.error("[handleUserInteraction] AI ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì£¼ ì˜ˆì™¸:", error);
        loadingIndicatorTalk.style.display = 'none';
        const fallbackMsg = "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.";
        appendMessage(fallbackMsg, 'ai', true);
        try { await playTTSFromText(fallbackMsg, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨ (ì˜¤ë¥˜ ì²˜ë¦¬ ì¤‘):", e.message ? e.message : e); }
        // disableAllInputs(false, "AI ì‘ë‹µ ì˜¤ë¥˜"); // finally ë¸”ë¡ìœ¼ë¡œ ì´ë™
      } finally {
        // ì–´ë–¤ ê²½ìš°ë“  ë¡œë”© ì¸ë””ì¼€ì´í„°ëŠ” ìˆ¨ê¸°ê³ , ì…ë ¥ UIëŠ” í™œì„±í™”í•©ë‹ˆë‹¤.
        loadingIndicatorTalk.style.display = 'none';
        disableAllInputs(false, "handleUserInteraction ì™„ë£Œ");
        resetSilenceTimer(); 
        console.log("[handleUserInteraction] finally ë¸”ë¡ ì‹¤í–‰ë¨. ì…ë ¥ UI í™œì„±í™”.");
      }
    }

    function stopRecordingIfMaxDuration() { /* ì´ì „ê³¼ ë™ì¼ */ }
    async function startRecording() { /* ì´ì „ê³¼ ë™ì¼ (ê´€ë¦¬ì ëª…ë ¹ í™•ì¸ ë¡œì§ í¬í•¨) */ }
    function stopRecording() { /* ì´ì „ê³¼ ë™ì¼ */ }
    const toggleInputBtn = document.getElementById('toggle-input-btn'); 
    const textInputArea = document.getElementById('text-input-area');
    const userTextInput = document.getElementById('user-text-input');
    const sendTextBtn = document.getElementById('send-text-btn');
    const keyboardIconForToggle = document.getElementById('keyboard-icon-for-toggle'); 
    // const micIconForToggleBtn = document.getElementById('mic-icon-for-toggle-btn'); // HTMLì—ì„œ ID ìˆ˜ì • í•„ìš”


    toggleInputBtn.addEventListener('click', () => { /* ì´ì „ê³¼ ë™ì¼ */ });
    sendTextBtn.addEventListener('click', async () => { /* ì´ì „ê³¼ ë™ì¼ (ê´€ë¦¬ì ëª…ë ¹ í™•ì¸ ë¡œì§ í¬í•¨) */ });
    userTextInput.addEventListener('keypress', (event) => { /* ì´ì „ê³¼ ë™ì¼ */ });
    userTextInput.addEventListener('input', () => { /* ì´ì „ê³¼ ë™ì¼ */ });
    talkBtn.addEventListener('click', async () => { /* ì´ì „ê³¼ ë™ì¼ */ });
    
    window.addEventListener('resize', adjustChatWindowPadding); 

    async function initializeChat() { 
        console.log("[initializeChat] ì‹œì‘ë¨. ì˜¨ë³´ë”© ì™„ë£Œ:", onboardingComplete, "ì‚¬ìš©ì ì²«ë§ˆë””:", userTypedIntro ? userTypedIntro.substring(0,30) : "ì—†ìŒ");
        disableAllInputs(true, "ì´ˆê¸°í™” ì¤‘");
        userConsecutiveTurns = 0; 
        lastUserUtterance = "";   
        
        talkBtn.style.display = 'inline-flex'; 
        textInputArea.style.display = 'none';
        const toggleIconTextT = document.getElementById('toggle-icon-text-T'); 
        const micIconForToggle = document.getElementById('mic-icon-for-toggle-btn'); // ID ìˆ˜ì •
        if (toggleIconTextT) toggleIconTextT.style.display = 'inline-block'; 
        if (micIconForToggle) micIconForToggle.style.display = 'none';  

        currentInputMode = 'microphone';
        document.body.classList.remove('keyboard-mode'); 
        adjustChatWindowPadding(); 

        if (!currentUserId || !currentVoiceId) { 
            const errorMsg = "ì‚¬ìš©ì ì •ë³´(ID/ì´ë©”ì¼ ë˜ëŠ” ëª©ì†Œë¦¬)ê°€ ì—†ì–´ ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • ë˜ëŠ” ì‹œì‘ í˜ì´ì§€ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.";
            console.error("[initializeChat] ì‚¬ìš©ì ì •ë³´ ë¶€ì¡±:", errorMsg);
            appendMessage(errorMsg, 'ai', true); 
            loadingIndicatorTalk.style.display = 'none'; 
            disableAllInputs(true, "ì‚¬ìš©ì ì •ë³´ ì—†ìŒ"); 
            return; 
        }
        try {
            if (onboardingComplete && userTypedIntro && userTypedIntro.trim() !== "") { 
                console.log("[initializeChat] ì˜¨ë³´ë”© ë°ì´í„°ë¡œ ì²« ëŒ€í™” ì‹œì‘:", userTypedIntro.substring(0,30));
                appendMessage(userTypedIntro, 'user'); 
                
                const contextForFirstInteraction = { 
                    initialUserMessage: userTypedIntro, 
                    initialUserEmotions: selectedEmotions, 
                    isFirstChatAfterOnboarding: true 
                };
                // AI ì‘ë‹µ ìš”ì²­ ë° ì´í›„ ë¡œì§ì€ handleUserInteraction ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
                await handleUserInteraction(userTypedIntro, contextForFirstInteraction); 
                
                // handleUserInteractionì´ ì™„ë£Œëœ í›„ (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘) ì•„ë˜ ë¡œì§ ì‹¤í–‰
                localStorage.removeItem('lozee_onboarding_complete'); 
                localStorage.removeItem('lozee_user_typed_intro'); 
                localStorage.removeItem('lozee_selected_emotions'); 
                firstInteractionDone = true; 
                console.log("[initializeChat] ì˜¨ë³´ë”© ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ (localStorage ì •ë¦¬).");
            } else if (onboardingComplete && (!userTypedIntro || userTypedIntro.trim() === "")) { 
                console.log("[initializeChat] ì˜¨ë³´ë”©ì€ ì™„ë£Œí–ˆìœ¼ë‚˜, ì‚¬ìš©ìì˜ ì²«ë§ˆë””ê°€ ì—†ìŠµë‹ˆë‹¤. AIê°€ ë¨¼ì € ë§ì„ ê²ë‹ˆë‹¤.");
                initialGreetingText = `ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”, ${currentUserName}ë‹˜! ì´ì œ ëŒ€í™”ë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆì–´ìš”. ì•„ë˜ ì…ë ¥ ë°©ì‹ì„ ì„ íƒí•´ ì§€ê¸ˆ ì–´ë–¤ì§€ ë§ì”€í•´ì£¼ì„¸ìš”.`;
                appendMessage(initialGreetingText, 'ai'); 
                loadingIndicatorTalk.style.display = 'block';
                try { 
                    await playTTSFromText(initialGreetingText, currentVoiceId); 
                } 
                catch(ttsError){ console.error("ì˜¨ë³´ë”© í›„ ì²« ì¸ì‚¬ TTS ì˜¤ë¥˜:", ttsError); } 
                finally { 
                    loadingIndicatorTalk.style.display = 'none'; 
                    disableAllInputs(false, "ì˜¨ë³´ë”© í›„ ì²« ì…ë ¥ ëŒ€ê¸°"); 
                }
                firstInteractionDone = true; 
            } else { 
                console.log("[initializeChat] ì¼ë°˜ ì‹œì‘ ë˜ëŠ” URL íŒŒë¼ë¯¸í„° í™•ì¸.");
                const urlParams = new URLSearchParams(window.location.search);
                const topicFromUrl = urlParams.get('topic');
                if (topicFromUrl) { 
                  appendMessage(`"${topicFromUrl}"ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê³  ì‹¶ì–´ìš”.`, 'user');
                  await handleUserInteraction(`"${topicFromUrl}" ê´€ë ¨í•´ì„œ ì´ì•¼ê¸° ì‹œì‘í•´ì¤˜.`);
                  firstInteractionDone = true; 
                } else { 
                  initialGreetingText = await getInitialGreeting(currentUserName, hasVisited, lastSummary, currentUserAge, currentUserDisease);
                  appendMessage(initialGreetingText, 'ai');
                  loadingIndicatorTalk.style.display = 'block'; // TTS ì¬ìƒ ì „ ë¡œë”© í‘œì‹œ
                  try {
                      await playTTSFromText(initialGreetingText, currentVoiceId);
                  } catch (e) {
                      console.error("ì´ˆê¸° ì¸ì‚¬ TTS ì˜¤ë¥˜:", e);
                  } finally {
                      loadingIndicatorTalk.style.display = 'none';
                      disableAllInputs(false, "ì´ˆê¸°í™” ì™„ë£Œ, ì²« í´ë¦­/ì…ë ¥ ëŒ€ê¸°"); 
                  }
                }
            }
            if (!hasVisited) { localStorage.setItem('lozee_hasVisited', 'true'); hasVisited = true; }
        } catch (error) { 
            console.error("[initializeChat] ì´ˆê¸°í™” ì¤‘ ì˜ˆì™¸:", error);
            appendMessage("ì±„íŒ… ì‹œì‘ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.", 'ai', true);
            loadingIndicatorTalk.style.display = 'none'; // ì˜¤ë¥˜ ì‹œ ë¡œë”© ìˆ¨ê¹€
            disableAllInputs(true, "ì´ˆê¸°í™” ì˜¤ë¥˜");
        } finally {
            console.log("ì±„íŒ… ì´ˆê¸°í™” ì™„ë£Œ (finally ë¸”ë¡).");
            // disableAllInputs(false)ëŠ” ê° ë¶„ê¸°ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•¨.
            // ë§Œì•½ ì–´ë–¤ ë¶„ê¸°ì—ì„œë„ disableAllInputs(false)ê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ìˆë‹¤ë©´, ì—¬ê¸°ì„œ í˜¸ì¶œ.
            // ì˜ˆë¥¼ ë“¤ì–´, if (!currentUserId || !currentVoiceId) ë¸”ë¡ì€ return í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì²˜ë¦¬ ì•ˆ ë¨.
            // í•˜ì§€ë§Œ ë‹¤ë¥¸ ì„±ê³µ/ì‹¤íŒ¨ ê²½ë¡œëŠ” ê°ì ì²˜ë¦¬í•˜ê³  ìˆìŒ.
            resetSilenceTimer(); 
        }
    }
    initializeChat();
  </script>
</body>
</html>
