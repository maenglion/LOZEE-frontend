<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEE와 대화하기</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <header id="main-header">LOZEE와 대화하기</header>
  <div id="meter-container"><div id="volume-meter"><div id="volume-level"></div></div></div>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="음성 인식 시작/중지" disabled>🎤</button>
    <input type="text" id="chat-input" placeholder="메시지를 입력하거나 마이크 버튼을 누르세요..." />
    <button id="send-button">전송</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse, getFirstQuestion } from './js/gpt-dialog.js';
    import { trackTime, trackEmotionTone, trackSituation } from './js/basic-features.js';

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing chat');
      const chatContainer = document.getElementById('chat-container');
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');

      const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge       = localStorage.getItem('lozee_userage');
      const userName      = localStorage.getItem('lozee_username') || '친구';
      const storedTopic   = localStorage.getItem('selectedTopic') || '{}';
      const selectedTopic = JSON.parse(storedTopic) || { displayText: '대화' };

      let recognitionActive = false;
      let stt;

      function appendBubble(text, role) {
        console.log('appendBubble', role, text);
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showAiLoading(show) {
        sendButton.disabled = show;
        chatInput.disabled  = show;
        micButton.disabled  = show || micButton.disabled;
      }

      // 초기 대화 시작
      async function initConversation() {
        console.log('initConversation');
        const prompt = getFirstQuestion(userAge, selectedTopic);
        appendBubble(prompt, 'bot');
        await playTTSFromText(prompt, selectedVoice);
        // BASIC 기능 초기화
        trackTime();
        trackEmotionTone();
        trackSituation();
      }

      // 사용자 입력 및 스트리밍 GPT 호출
      async function handleUserText(text) {
        console.log('handleUserText:', text);
        if (!text.trim()) return;
        appendBubble(text, 'user');
        showAiLoading(true);

        const botBubble = document.createElement('div');
        botBubble.className = 'bubble bot';
        chatContainer.appendChild(botBubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
          const res = await fetch('/api/gpt-stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userInput: text, context: { userAge, userName, selectedTopic } })
          });
          const reader = res.body.getReader();
          const dec = new TextDecoder();
          let done = false;
          while (!done) {
            const { value, done: d } = await reader.read();
            done = d;
            botBubble.textContent += dec.decode(value, { stream: true });
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          await playTTSFromText(botBubble.textContent, selectedVoice);
        } catch (err) {
          console.error('GPT streaming error', err);
          appendBubble('죄송해요, 오류가 발생했어요.', 'bot');
          await playTTSFromText('죄송해요, 오류가 발생했어요.', selectedVoice);
        } finally {
          showAiLoading(false);
        }
      }

      // 전송 버튼 및 엔터키 이벤트
      sendButton.addEventListener('click', () => {
        const txt = chatInput.value.trim();
        if (txt) { chatInput.value = ''; handleUserText(txt); }
      });
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !sendButton.disabled) {
          e.preventDefault();
          const txt = chatInput.value.trim();
          if (txt) { chatInput.value = ''; handleUserText(txt); }
        }
      });

      // STT 설정 및 권한 요청
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            console.log('Microphone access granted');
            const API = window.SpeechRecognition || window.webkitSpeechRecognition;
            stt = new API();
            stt.lang = 'ko-KR';
            stt.interimResults = false;

            stt.onstart = () => { recognitionActive = true; micButton.textContent = '🔴'; };
            stt.onend   = () => { recognitionActive = false; micButton.textContent = '🎤'; };
            stt.onresult = e => { const speech = e.results[0][0].transcript; handleUserText(speech); };

            micButton.disabled = false;
            micButton.addEventListener('click', () => {
              if (recognitionActive) stt.stop();
              else stt.start();
            });
          })
          .catch(err => {
            console.error('Microphone permission denied', err);
            appendBubble('마이크 권한을 사용할 수 없어요. 설정을 확인해주세요.', 'bot');
          });
      } else {
        console.error('Web Speech API not supported');
        appendBubble('음성 인식 기능을 사용할 수 없어요.', 'bot');
      }

      // 초기 대화 시작
      initConversation();
    });
  </script>
</body>
</html>
