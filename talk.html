<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEE와 대화하기</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* GNB */
    #gnb { position: fixed; top:0; left:0; width:100%; background:#354157; padding:8px 16px; box-shadow:0 2px 4px rgba(0,0,0,0.1); z-index:1000; display:flex; gap:12px; }
    #gnb a { color:#fff; text-decoration:none; font-size:.95em; }
    body { margin:0; padding-top:40px; font-family:'KoPub World Dotum',sans-serif; background:#2a3340; color:#fff; }
    /* 채팅 영역 챗 버블 스타일 */
    #chat-container { padding:16px; height:calc(100vh - 140px); overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
    .bubble { padding:12px 16px; border-radius:20px; max-width:70%; line-height:1.4; word-break:keep-all; }
    .bubble.user          { background:#6e8efb; align-self:flex-end; color:#fff; }
    .bubble.bot           { background:#f0f0f0; align-self:flex-start; color:#333; }
    .bubble.user.interim  { opacity:.6; }  /* 중간 결과 전용 스타일 */
    /* 입력 영역 */
    #chat-input-container { position:fixed; bottom:0; left:0; width:100%; display:flex; gap:8px; padding:8px; background:#354157; }
    #chat-input  { flex:1; padding:12px; border-radius:20px; border:none; }
    #send-button, #mic-button { width:48px; height:48px; border:none; border-radius:50%; background:#6e8efb; color:#fff; font-size:1.2em; cursor:pointer; }
    #mic-button.disabled { opacity:.5; cursor:default; }
    /* 음량 바 */
    #meter-container { position:fixed; top:40px; left:50%; transform:translateX(-50%); width:60%; height:4px; background:#4a5568; border-radius:2px; overflow:hidden; }
    #volume-meter  { width:100%; height:100%; }
    #volume-level  { width:0%; height:100%; background:#6e8efb; transition:width .1s; }
    /* 로딩 스피너 (send 버튼 대체) */
    #send-button.loading { background:#999; cursor:default; }
  </style>
</head>
<body>
  <nav id="gnb">
    <a href="index.html">홈</a>
    <a href="#" id="gnb-topic-change">주제 변경</a>
    <a href="analysis.html">분석 결과</a>
    <a href="settings.html">설정</a>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" class="disabled" title="음성 인식 시작/중지">🎤</button>
    <input type="text" id="chat-input" placeholder="메시지 입력 또는 🎤" autocomplete="off"/>
    <button id="send-button">⮞</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse, getFirstQuestion } from './js/gpt-dialog.js';

    document.addEventListener('DOMContentLoaded', async () => {
      // DOM 요소
      const chatContainer = document.getElementById('chat-container');
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');

      // 사용자 정보
      const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge       = localStorage.getItem('lozee_userage');
      const userName      = localStorage.getItem('lozee_username') || '친구';
      const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');

      // GNB 주제 변경
      document.getElementById('gnb-topic-change').onclick = e => {
        e.preventDefault();
        window.location.href = 'index.html';
      };

      // 말풍선 추가
      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // 중간 결과 표시
      function showInterim(text) {
        let el = document.querySelector('.bubble.user.interim');
        if (!el) {
          el = document.createElement('div');
          el.className = 'bubble user interim';
          chatContainer.appendChild(el);
        }
        el.textContent = text;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // 로딩 상태
      function setLoading(flag) {
        sendButton.disabled = flag;
        micButton.disabled  = flag;
        sendButton.classList.toggle('loading', flag);
      }

      // ── 초기 대화 시작 ─────────────────────────
      async function initConversation() {
        // 인덱스에서 넘어온 주제(selectedTopic)와 나이(userAge)를 반영한 첫 질문 생성
       const prompt = getFirstQuestion(userAge, selectedTopic);
       appendBubble(prompt, 'bot');
       await playTTSFromText(prompt, selectedVoice);
      }

       // 페이지 로드 직후 초기 대화 시작 호출
       document.addEventListener('DOMContentLoaded', () => {
       initConversation();

      // 사용자 텍스트 처리
      async function handleUserText(text) {
        if (!text.trim()) return;
        appendBubble(text, 'user');
        setLoading(true);
        // 중간 버블 삭제
        document.querySelector('.bubble.user.interim')?.remove();

        try {
          const res = await getGptResponse(text, { userAge, userName, selectedTopic });
          // 스트리밍 응답 처리
          const reader = res.body.getReader();
          const dec    = new TextDecoder();
          let done = false;
          const botBubble = document.createElement('div');
          botBubble.className = 'bubble bot';
          chatContainer.appendChild(botBubble);

          while (!done) {
            const { value, done: d } = await reader.read();
            done = d;
            botBubble.textContent += dec.decode(value, { stream: true });
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          await playTTSFromText(botBubble.textContent, selectedVoice);
        } catch (err) {
          console.error(err);
          appendBubble('죄송합니다, 오류가 발생했어요.', 'bot');
        } finally {
          setLoading(false);
        }
      }

      // STT + 음량 바 세팅
      if (navigator.mediaDevices && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          // Audio 레벨링
          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src      = audioCtx.createMediaStreamSource(stream);
          const analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          src.connect(analyser);

          const data = new Uint8Array(analyser.frequencyBinCount);
          function drawMeter() {
            analyser.getByteTimeDomainData(data);
            let sum = 0;
            for (let v of data) {
              const x = (v/128) - 1;
              sum += x*x;
            }
            const rms = Math.sqrt(sum/data.length);
            meterLevel.style.width = `${Math.min(rms * 200, 100)}%`;
            requestAnimationFrame(drawMeter);
          }
          drawMeter();

          // SpeechRecognition
          const API = window.SpeechRecognition || window.webkitSpeechRecognition;
          const rec = new API();
          rec.lang           = 'ko-KR';
          rec.interimResults = true;
          rec.continuous     = false;

          rec.onstart = () => { micButton.textContent = '🔴'; };
          rec.onend   = () => { micButton.textContent = '🎤'; };

          rec.onresult = event => {
            let interim = '', finalT = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const { transcript, isFinal } = event.results[i][0];
              if (isFinal) finalT += transcript;
              else interim += transcript;
            }
            if (interim) showInterim(interim);
            else document.querySelector('.bubble.user.interim')?.remove();

            if (finalT) {
              document.querySelector('.bubble.user.interim')?.remove();
              handleUserText(finalT);
            }
          };

          rec.onerror = e => {
            console.error('STT 오류', e.error);
          };

          // 마이크 버튼 활성화
          micButton.classList.remove('disabled');
          micButton.onclick = () => {
            if (sendButton.disabled) return;
            if (micButton.textContent === '🔴') rec.stop();
            else rec.start();
          };

        } catch {
          appendBubble('마이크 권한이 필요합니다.', 'bot');
        }
      } else {
        appendBubble('음성 인식 기능을 지원하지 않는 브라우저예요.', 'bot');
      }

      // Send 버튼 이벤트
      sendButton.onclick = () => {
        if (sendButton.disabled) return;
        const txt = chatInput.value.trim();
        if (!txt) return;
        chatInput.value = '';
        handleUserText(txt);
      };
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); }
      });

     // ── 9. 시작 ─────────────────────────────
     document.addEventListener('DOMContentLoaded', async () => {
     await initConversation();  // 페이지 로드 직후 첫 질문
     });
     </script>
</body>
</html>
