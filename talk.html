<!DOCTYPE html>
<html lang="ko">
<head>
  <script>
    // 초기 설정 확인 및 리다이렉션 로직
    const isConfigured = localStorage.getItem('lozee_username') &&
                         localStorage.getItem('lozee_voice') &&
                         localStorage.getItem('lozee_userage');

    const topicForRedirect = localStorage.getItem('lozee_current_topic');

    if (isConfigured) {
      const targetUrl = topicForRedirect ? `talk.html?topic=${encodeURIComponent(topicForRedirect)}` : 'talk.html';
      window.location.href = targetUrl;
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>LOZEE와 대화하기</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>
  <style>
    :root {
      --primary-color: #6078ea; 
      --secondary-color: #f0f2f5; 
      --background-color: #FFFFFF; /* 전체 페이지 배경색 (흰색) */
      
      --text-color-on-dark-bg: #FFFFFF; 
      --text-color-on-light-bg: #333333; /* 기본 텍스트 색상 */
      
      --input-background: #FFFFFF; 
      --input-border-color: #D1D5DB; 
      
      --bot-bubble-bg: #E9EBF8; /* AI 말풍선 배경색 (부드러운 연보라/하늘색 계열) */
      --bot-bubble-text: #374151; /* AI 말풍선 텍스트 색상 (어두운 회색) */
      
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #FFFFFF;
      
      --gnb-height: 56px;
      --chat-input-actual-height: 50px;
      --chat-input-padding-vertical: 10px;
      --chat-input-safe-area: env(safe-area-inset-bottom, 20px);
      --chat-input-total-height: calc(var(--chat-input-actual-height) + (2 * var(--chat-input-padding-vertical)) + var(--chat-input-safe-area));
      
      --gnb-title-color: var(--primary-color); 
      --gnb-menu-icon-color: var(--primary-color); 

      --volume-meter-default-bg: var(--primary-color);
      --meter-top-margin: 8px;
      --gnb-dropdown-border-color: #E5E7EB; 
    }
    body {
      margin:0;
      padding-top:var(--gnb-height);
      font-family:'KoPub World Dotum',sans-serif;
      background-color:var(--background-color); 
      color:var(--text-color-on-light-bg); 
      display:flex;
      flex-direction:column;
      height:100vh;
      box-sizing:border-box;
      overflow:hidden;
    }
    #gnb {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:var(--gnb-height);
      background-color:var(--background-color); 
      padding:0 16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.07); 
      z-index:1000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-sizing:border-box;
      border-bottom: 1px solid var(--input-border-color); 
    }
    #gnb-title {
      font-size:1.2em;
      font-weight:bold;
      color:var(--gnb-title-color); 
    }
    #menu-toggle {
      background:none;
      border:none;
      color:var(--gnb-menu-icon-color); 
      font-size:24px;
      cursor:pointer;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #dropdown-menu {
      position:fixed;
      top:var(--gnb-height);
      right:0;
      background-color:var(--background-color); 
      border-radius:0 0 0 8px;
      box-shadow:-2px 2px 5px rgba(0,0,0,0.08);
      width:200px;
      z-index:999;
      overflow:hidden;
      max-height:0;
      transition:max-height 0.3s ease-out;
      border-left: 1px solid var(--input-border-color);
      border-bottom: 1px solid var(--input-border-color);
    }
    #dropdown-menu.show{max-height:500px;}
    #dropdown-menu a {
      display:block;
      color:var(--text-color-on-light-bg); 
      text-decoration:none;
      padding:12px 16px;
      font-size:0.95em;
      border-bottom:1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child{border-bottom:none;}
    #dropdown-menu a:hover{background-color:var(--secondary-color);} 
    #meter-container {
      position:fixed;
      top:calc(var(--gnb-height) + var(--meter-top-margin));
      left:50%;
      transform:translateX(-50%);
      width:60%;
      max-width:300px;
      height:6px;
      background-color:#E5E7EB; 
      border-radius:3px;
      overflow:hidden;
      z-index:998;
    }
    #volume-level {
      width:0%;
      height:100%;
      background:var(--volume-meter-default-bg);
      border-radius:3px;
      transition:width 0.05s linear;
    }
    #chat-container {
      flex-grow:1;
      padding:16px;
      padding-top:calc(var(--meter-top-margin) + 6px + 10px);
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px; 
      margin-bottom: var(--chat-input-total-height); 
    }
    #analysis-container {
      padding:10px;
      background:#f3f4f6; 
      color:#4b5563; 
      font-size:0.85em;
      max-height:150px;
      overflow-y:auto;
      border-top:1px solid #e5e7eb; 
      display:none;
    }
    .bubble {
      padding:10px 15px; 
      border-radius:16px; 
      max-width:80%; 
      line-height:1.6;
      word-break:keep-all;
      box-shadow:0 1px 2px rgba(0,0,0,0.06); 
    }
    .bubble.user {
      background-color:var(--user-bubble-bg);
      color:var(--user-bubble-text);
      align-self:flex-end;
      border-bottom-right-radius:4px;
    }
    .bubble.bot {
      background-color:var(--bot-bubble-bg); 
      color:var(--bot-bubble-text); 
      align-self:flex-start;
      border-bottom-left-radius:4px;
    }
    .bubble.user.interim{opacity:.7;}
    .bubble.system-error, .bubble.ai_feedback { 
      background-color:#FFFBEB; 
      color:#92400E; 
      align-self:center;
      max-width:85%;
      text-align:center;
      font-size:0.9em;
      border:1px solid #FDE68A; 
      margin: 5px 0;
      border-radius: 8px; 
    }
    #chat-input-container {
      position:fixed;
      bottom:0;
      left:0;
      width:100%; 
      background-color:var(--background-color); 
      border-top: 1px solid var(--input-border-color); 
      box-shadow:0 -1px 3px rgba(0,0,0,0.05);
      box-sizing:border-box; 
      padding-top: var(--chat-input-padding-vertical); 
      padding-bottom: calc(var(--chat-input-padding-vertical) + var(--chat-input-safe-area));
    }
    .input-area { 
      display: flex; 
      align-items: center; 
      width: 100%; 
      padding: 0 12px; 
      box-sizing: border-box; 
      gap: 8px; 
      height: var(--chat-input-actual-height); 
    }
    #chat-input {
      flex:1;
      padding:10px 16px;
      border-radius:22px;
      border:1px solid var(--input-border-color); 
      font-size:1em;
      background-color:var(--input-background);
      color:var(--text-color-on-light-bg); 
      height:100%;
      box-sizing:border-box;
    }
    #chat-input::placeholder{color:#9CA3AF;}
    #mic-button, #send-button {
      width:44px;
      height:44px;
      border:none;
      border-radius:50%;
      background-color:var(--primary-color);
      color:var(--user-bubble-text); 
      font-size:1.3em;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background-color 0.2s ease, box-shadow 0.2s ease; 
      flex-shrink: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    #mic-button:hover, #send-button:hover{
        background-color:#4f65d1; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    #mic-button.recording{background-color:#EF4444; box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);}
    #send-button.loading{background:#D1D5DB;cursor:default; box-shadow: none;} 
    
    #chat-container::-webkit-scrollbar{width:6px;} 
    #chat-container::-webkit-scrollbar-track{background:transparent;} 
    #chat-container::-webkit-scrollbar-thumb{background:#D1D5DB;border-radius:3px;} 
    #chat-container::-webkit-scrollbar-thumb:hover{background:#9CA3AF;}
  </style>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="메뉴 열기/닫기">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (준비중)</a>
      <a href="index.html">주제 변경</a>
      <a href="analysis.html">최근 대화 분석</a>
      <a href="journal-list.html">주제별 대화 목록</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE 소개</a>
    </div>
  </nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-container">
    </div>
  <div id="analysis-container">
    </div>

  <div id="chat-input-container">
    <div class="input-area">
        <button id="mic-button" title="음성 인식 시작/중지">🎤</button>
        <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." autocomplete="off"/>
        <button id="send-button" title="메시지 전송">⮞</button>
    </div>
  </div>

  <!-- 1) Firebase SDK (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>               :contentReference[oaicite:0]{index=0}
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>         :contentReference[oaicite:1]{index=1}

  <!-- 2) 커스텀 기능 모듈 -->
  <script src="./js/gpt-dialog.js" defer></script>                                                      :contentReference[oaicite:2]{index=2}
  <script src="./js/tts.js" defer></script>                                                             :contentReference[oaicite:3]{index=3}
  <script src="./js/basic-features.js" defer></script>                                                  :contentReference[oaicite:4]{index=4}
  <script src="./js/literacyPatternCheckRenderer.js" defer></script>   

  <script defer>
    
    // Firebase 설정 (실제 값으로 교체 완료)
    const firebaseConfig = {
      apiKey: "AIzaSyBnuL-CEvcU4NiIyG4yOe6mQjMnh9aArIY",
      authDomain: "lozee-af4d3.firebaseapp.com",
      projectId: "lozee-af4d3",
      storageBucket: "lozee-af4d3.appspot.com",
      messagingSenderId: "838397276113",
      appId: "1:838397276113:web:fc8cb3bdf59ecd52fabaf0",
      measurementId: "G-C23DLE9GZ4"
    };

    let app;
    let db;

    document.addEventListener('DOMContentLoaded', () => {
        try {
        // v8 초기화
        app = firebase.initializeApp(firebaseConfig);
        db  = firebase.firestore();
        console.log("Firebase initialized successfully (v8).");
      } catch (e) {
        console.error("Firebase initialization error:", e);
        document.getElementById('chat-container').innerHTML =
          `<div class="bubble system-error" style="align-self:center;">
             데이터베이스 연결에 실패했습니다. 오류: ${e.message}
           </div>`;
      }
      checkAndInit();
    });
    </script>
    </head>

    <script>

    function checkAndInit(retries = 20, delay = 300) { // 딜레이 약간 증가
        console.log(`checkAndInit 시도: ${20 - retries + 1}번째`);
        const conditions = {
            firebaseApp: typeof firebase !== 'undefined' && typeof firebase.app === 'function' && firebase.app(),
            firebaseDb: typeof db !== 'undefined' && db !== null,
            lozeeDialog: window.LOZEE_DIALOG && typeof window.LOZEE_DIALOG.getGptResponse === 'function',
            lozeeTts: window.LOZEE_TTS && typeof window.LOZEE_TTS.playTTSFromText === 'function',
            lozeeAnalysis: window.LOZEE_ANALYSIS && typeof window.LOZEE_ANALYSIS.trackTime === 'function',
            initializeAppFunc: typeof initializeApp === 'function'
        };

        console.log("Firebase App 로드됨:", conditions.firebaseApp ? '예' : '아니요');
        console.log("Firebase DB 초기화됨:", conditions.firebaseDb ? '예' : '아니요');
        console.log("LOZEE_DIALOG.getGptResponse 로드됨:", conditions.lozeeDialog ? '예' : '아니요');
        console.log("LOZEE_TTS.playTTSFromText 로드됨:", conditions.lozeeTts ? '예' : '아니요');
        console.log("LOZEE_ANALYSIS.trackTime 로드됨:", conditions.lozeeAnalysis ? '예' : '아니요');
        console.log("initializeApp 함수 정의됨:", conditions.initializeAppFunc ? '예' : '아니요');

        if (conditions.firebaseApp && conditions.firebaseDb && conditions.lozeeDialog && conditions.lozeeTts && conditions.lozeeAnalysis && conditions.initializeAppFunc) {
            initializeApp();
        } else if (retries > 0) {
            console.log(`필수 객체/함수 로드 대기 중... (${retries}회 남음)`);
            setTimeout(() => checkAndInit(retries - 1, delay), delay);
        } else {
            console.error("CRITICAL: 필수 JavaScript 객체/함수 로드 실패. 앱을 초기화할 수 없습니다. 각 외부 JS 파일의 로드 상태와 내부 오류를 확인해주세요.");
            let missing = [];
            if (!conditions.firebaseApp || !conditions.firebaseDb) missing.push("Firebase SDK");
            if (!conditions.lozeeDialog) missing.push("gpt-dialog.js 관련 기능");
            if (!conditions.lozeeTts) missing.push("tts.js 관련 기능");
            if (!conditions.lozeeAnalysis) missing.push("basic-features.js 관련 기능");
            if (!conditions.initializeAppFunc) missing.push("initializeApp 함수");
            
            const chatContainer = document.getElementById('chat-container');
            const errorMessage = `앱 초기화 실패: 다음 필수 요소 로드 문제 발생 - ${missing.join(', ')}. 페이지를 새로고침하거나 개발자 콘솔을 확인해주세요.`;
            if (chatContainer) {
                 chatContainer.innerHTML = `<div class="bubble system-error" style="align-self:center; max-width: 80%; text-align:center;">${errorMessage}</div>`;
            } else {
                document.body.innerHTML = `<div style="color:red;text-align:center;padding:50px;">채팅 UI 및 앱 초기화 실패! ${errorMessage}</div>`;
            }
        }
    }
    
    async function initializeApp() {
      console.log("initializeApp 호출됨. 필요한 객체들 로드 확인됨.");
      const chatContainer = document.getElementById('chat-container');
      const analysisContainer = document.getElementById('analysis-container');

      let hasGreeted = false;
      let isRecording = false;
      let mediaRecorder;
      let mediaStream;
      let audioChunks = [];
      let chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');

      const userName = localStorage.getItem('lozee_username') || '친구';
      const hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
      const voiceId = localStorage.getItem('lozee_selectedVoice') || (window.LOZEE_TTS ? window.LOZEE_TTS.DEFAULT_VOICE : 'default-fallback-voice');
      const lastSummary = localStorage.getItem('lozee_lastSummary') || '';
      const topicFromUrl = new URLSearchParams(location.search).get('topic');

      let userNameWithVocative = userName;
      if (window.LOZEE_DIALOG && typeof window.LOZEE_DIALOG.getKoreanVocativeParticle === 'function') {
          const vocativeParticle = window.LOZEE_DIALOG.getKoreanVocativeParticle(userName);
          userNameWithVocative = `${userName}${vocativeParticle}`;
      } else {
          console.warn("getKoreanVocativeParticle 함수를 찾을 수 없습니다. (talk.html)");
          userNameWithVocative = `${userName}야`;
      }
      
      window.LOZEE_STATE = window.LOZEE_STATE || {};

      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');
      const menuToggle    = document.getElementById('menu-toggle');
      const dropdownMenu  = document.getElementById('dropdown-menu');

      if (!chatContainer || !chatInput || !sendButton || !micButton || !meterLevel || !menuToggle || !dropdownMenu) {
          console.error("CRITICAL: 필수 UI 요소를 찾을 수 없습니다. HTML 구조를 확인하세요.");
          if(chatContainer) chatContainer.innerHTML = '<div class="bubble system-error" style="align-self:center;">UI 로드 오류 발생.</div>';
          return;
      }

      async function saveUserProfile() {
        const localUserId = localStorage.getItem('lozee_username'); // 변수 이름 충돌 방지
        const diagnosis = localStorage.getItem('lozee_usernote') || ''; 
        const localVoiceId = localStorage.getItem('lozee_voice'); // 변수 이름 충돌 방지
        if (!localUserId || !db) {
            console.warn("saveUserProfile: userId 또는 db 객체가 없어 프로필을 저장할 수 없습니다.");
            return;
        }
        try {
          await db.collection('users').doc(localUserId).set({ 
            name: localUserId, diagnosis, voice: localVoiceId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          console.log("사용자 프로필 저장됨:", localUserId);
        } catch (error) { console.error("사용자 프로필 저장 중 오류:", error); }
      }
      saveUserProfile();

      async function saveSessionLog(userUtterance, aiResponse, analysisData = null) {
        const localUserId = localStorage.getItem('lozee_username'); // 변수 이름 충돌 방지
        if (!localUserId || !db) {
            console.warn("saveSessionLog: userId 또는 db 객체가 없어 세션 로그를 저장할 수 없습니다.");
            return;
        }
        try {
          await db.collection('sessions').add({ 
            userId: localUserId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            userText: userUtterance,
            aiReply: aiResponse,
            analysis: analysisData || {} // analysisData가 null일 경우 빈 객체로 저장
          });
          console.log("세션 로그 저장됨.");
        } catch (error) { console.error("세션 로그 저장 중 오류:", error); }
      }

      async function saveJournalEntry(topic, summaryText) {
        const localUserId = localStorage.getItem('lozee_username'); // 변수 이름 충돌 방지
        if (!localUserId || !topic || !summaryText || !db) {
            console.warn("saveJournalEntry: userId, topic, summaryText 또는 db 객체가 없어 일기를 저장할 수 없습니다.");
            return;
        }
        try {
          await db.collection('journals').add({ 
            userId: localUserId, topic,
            title: summaryText.substring(0, 25) + (summaryText.length > 25 ? "..." : ""),
            summary: summaryText,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            entryType: "ai_reply_snippet"
          });
          console.log("AI 답변 스니펫 일기 저장됨.");
        } catch (error) { console.error("AI 답변 스니펫 일기 저장 중 오류:", error); }
      }
      
      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        if (role === 'system-error' || role === 'ai_feedback') {
            el.classList.add(role === 'system-error' ? 'system-error' : 'ai_feedback');
        }
        chatContainer.appendChild(el);
        requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
      }

      let isTTSRunning = false;
      const playTTSFromText_original = window.LOZEE_TTS?.playTTSFromText;
      const lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || (window.LOZEE_TTS ? window.LOZEE_TTS.DEFAULT_VOICE : 'default-fallback-voice');

      async function playTTSWithControl(text, voiceParam) {
        stopCurrentTTS();
        if (!text || !String(text).trim()) {
          console.log("TTS: 재생할 텍스트 없음.");
          isTTSRunning = false; return;
        }
        const effectiveVoice = voiceParam || lsSelectedVoice;
        console.log("새로운 TTS 재생 시도:", text, "Voice:", effectiveVoice);
        isTTSRunning = true; setLoading(true);
        try {
          if (typeof playTTSFromText_original === 'function') {
            await playTTSFromText_original(text, effectiveVoice); 
            console.log("TTS 재생 완료 (Promise resolved):", text);
          } else {
            console.warn(`TTS Fallback: ${text}. tts.js 로드 실패 또는 playTTSFromText 함수 미정의.`);
            appendBubble("알림: 음성 출력(TTS) 기능을 사용할 수 없습니다.", "system-error");
          }
        } catch (error) {
          console.error("TTS 재생 중 오류 발생:", error);
          appendBubble("음성 출력 중 오류가 발생했습니다.", "system-error");
        } finally {
          isTTSRunning = false; setLoading(false);
        }
      }
      
      const getGptResponseFromDialog = window.LOZEE_DIALOG?.getGptResponse;
      const getFirstQuestionFromDialog = window.LOZEE_DIALOG?.getFirstQuestion;
      const trackTimeFromAnalysis = window.LOZEE_ANALYSIS?.trackTime;
      const renderLiteracyAnalysisFromAnalysis = window.LOZEE_ANALYSIS?.renderLiteracyAnalysis;

      menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
      document.addEventListener('click', (event) => {
        const gnb = document.getElementById('gnb');
        if (gnb && !gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
          dropdownMenu.classList.remove('show');
        }
      });

      let audioContext, analyser, microphoneSource, dataArray, volumeMeterAnimationId, analyserStream;
      const LOW_COLOR = { r: 0, g: 180, b: 0 }, MID_COLOR = { r: 255, g: 193, b: 7 }, HIGH_COLOR = { r: 211, g: 47, b: 47 };
      function interpolateColor(c1,c2,f){const r=Math.round(c1.r+f*(c2.r-c1.r)),g=Math.round(c1.g+f*(c2.g-c1.g)),b=Math.round(c1.b+f*(c2.b-c1.b));return `rgb(${r},${g},${b})`}
      function setupAudioAnalysis(stream){try{if(audioContext?.state!=='closed')audioContext?.close().catch(e=>console.warn("AudioContext close 중 오류:", e));audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=256;analyser.smoothingTimeConstant=0.3;microphoneSource=audioContext.createMediaStreamSource(stream);microphoneSource.connect(analyser);dataArray=new Uint8Array(analyser.frequencyBinCount);analyserStream=stream;drawVolumeMeter()}catch(e){console.error("오디오 분석 설정 오류:",e);if(meterLevel)meterLevel.style.width='0%';}}
      function drawVolumeMeter(){volumeMeterAnimationId=requestAnimationFrame(drawVolumeMeter);if(!analyser||!dataArray||!meterLevel)return;analyser.getByteFrequencyData(dataArray);let s=0;for(let i=0;i<dataArray.length;i++)s+=dataArray[i];let avgVol=dataArray.length>0?s/dataArray.length:0;let normVol=(avgVol/140)*100;normVol=Math.min(100,Math.max(0,normVol));meterLevel.style.width=normVol+'%';let activeCol;if(normVol<=50)activeCol=interpolateColor(LOW_COLOR,MID_COLOR,normVol/50);else activeCol=interpolateColor(MID_COLOR,HIGH_COLOR,(normVol-50)/50);const baseGradCol=getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim()||'#FFFFFF';meterLevel.style.background=`linear-gradient(to right, ${baseGradCol}, ${activeCol})`}
      function stopAudioAnalysis(){
          if(volumeMeterAnimationId)cancelAnimationFrame(volumeMeterAnimationId);
          volumeMeterAnimationId=null;
          if(microphoneSource)microphoneSource.disconnect();
          microphoneSource=null;
          if(analyserStream?.getTracks)analyserStream.getTracks().forEach(t=>t.stop());
          analyserStream=null;
          if(audioContext && audioContext.state !== 'closed') { 
            audioContext.close().catch(e=>console.warn("AudioContext close 중 오류:",e));
          }
          audioContext=null;
          if(meterLevel){meterLevel.style.width='0%';meterLevel.style.background=getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg').trim()}analyser=null;dataArray=null
      }

      let recognition, isRecognizing = false;
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

      function stopCurrentTTS() {
        if (isTTSRunning) {
            console.log("명시적 TTS 중지 시도 (stopCurrentTTS)");
            if (speechSynthesis && typeof speechSynthesis.cancel === 'function') {
                speechSynthesis.cancel();
                console.log("speechSynthesis.cancel() 호출됨.");
            }
            isTTSRunning = false;
            setLoading(false); 
        }
      }

      if (SpeechRec) {
        recognition = new SpeechRec();
        recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'ko-KR';
        micButton.disabled = false;

        recognition.onstart = () => {
          isRecognizing = true;
          stopCurrentTTS(); 
          micButton.textContent = '💬'; micButton.classList.add('recording');
          console.log("🎤 STT 시작 - TTS 중지됨");
        };
        recognition.onend = () => {
          isRecognizing = false;
          micButton.textContent = '🎤'; micButton.classList.remove('recording');
          setLoading(false); 
          stopAudioAnalysis(); 
          console.log("🎤 STT 종료");
        };
        recognition.onresult = (event) => {
          let finalTranscript = '';
          let interimTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcriptPart = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcriptPart;
            } else {
                interimTranscript += transcriptPart;
            }
          }
          
          let interimBubble = document.querySelector('.bubble.user.interim');
          if (interimTranscript) {
            if (!interimBubble) {
                interimBubble = document.createElement('div');
                interimBubble.className = 'bubble user interim';
                chatContainer.appendChild(interimBubble);
            }
            interimBubble.textContent = interimTranscript;
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          
          if (finalTranscript) {
            if (interimBubble) interimBubble.remove(); 
            if (isTTSRunning) { 
                console.log("STT 최종 결과 처리 전, TTS가 아직 실행 중이어서 중지합니다.");
                stopCurrentTTS();
            }
            handleUserText(finalTranscript); 
          }
        };
        recognition.onerror = (event) => { 
          console.error("❌ STT 오류:", event.error);
          let errorMsg = "음성 인식 중 오류가 발생했습니다.";
          if (event.error === 'not-allowed'||event.error === 'service-not-allowed') {
            errorMsg = "마이크 권한이 필요합니다. 브라우저 설정을 확인해주세요.";
          } else if (event.error === 'no-speech') {
            errorMsg = "음성이 감지되지 않았어요. 다시 말씀해주시겠어요?";
          } else if (event.error === 'network') {
            errorMsg = "네트워크 문제로 음성 인식을 할 수 없어요. 인터넷 연결을 확인해주세요.";
          }
          appendBubble(errorMsg, "system-error");
          isRecognizing = false;
          micButton.textContent = '🎤'; micButton.classList.remove('recording');
          setLoading(false); stopAudioAnalysis();
        };
      } else { 
        console.warn("⚠️ 음성 인식을 지원하지 않는 브라우저입니다.");
        micButton.title = "음성 인식 미지원"; micButton.disabled = true;
        appendBubble("알림: 사용 중인 브라우저에서는 음성 인식을 지원하지 않습니다.", "system-error");
      }

      micButton.onclick = async () => {
        if (!SpeechRec) return;
        if (isTTSRunning) {
          console.log("TTS 재생 중이므로 STT를 시작하지 않습니다. TTS를 먼저 중지합니다.");
          stopCurrentTTS();
          return; 
        }
        if (isRecognizing) {
          recognition.stop(); 
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupAudioAnalysis(stream); 
            recognition.start(); 
          } catch (err) {
            console.error("❌ 마이크 권한/시작 오류:", err); 
            appendBubble("마이크를 사용할 수 없습니다. 권한을 확인해주세요.", "system-error"); 
            stopAudioAnalysis(); 
            setLoading(false);
          }
        }
      };
      
      const userAge = localStorage.getItem('lozee_userage');
      // const userId = localStorage.getItem('lozee_userid') || `user_${Date.now()}`; // Firebase 함수 내에서 userId를 가져오도록 변경
      const userDisease = JSON.parse(localStorage.getItem('lozee_userdisease') || '[]');
      
      const params = new URLSearchParams(location.search);
      const incomingTopicId   = params.get('topicId'); 
      const incomingTopicText = params.get('topicText');
      
      let currentSelectedTopic = { 
        id: incomingTopicId, 
        displayText: incomingTopicText || JSON.parse(localStorage.getItem('selectedTopic'))?.displayText || '',
        type: JSON.parse(localStorage.getItem('selectedTopic'))?.type || 'else'
      };

      if (typeof trackTimeFromAnalysis === 'function') trackTimeFromAnalysis();

      if (chatHistory.length === 0 && !hasGreeted) {
        if (typeof getFirstQuestionFromDialog === 'function') { 
            const initialTopicToUse = (currentSelectedTopic.id || currentSelectedTopic.displayText) ? currentSelectedTopic : {displayText: "오늘 있었던 일", type: "else"};
            if (!currentSelectedTopic.displayText && initialTopicToUse.displayText === "오늘 있었던 일") {
                 localStorage.setItem('selectedTopic', JSON.stringify(initialTopicToUse));
            }
            
            const initialPrompt = getFirstQuestionFromDialog(userAge, initialTopicToUse); 
            if (initialPrompt && !initialPrompt.startsWith("오류:")) {
                appendBubble(initialPrompt, 'ai'); 
                chatHistory.push({ role: 'assistant', content: initialPrompt, timestamp: new Date().toISOString() }); 
                localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
                if(typeof playTTSFromText_original === 'function') await playTTSWithControl(initialPrompt, lsSelectedVoice);
            } else {
                 appendBubble("안녕하세요! 대화를 시작하는 데 문제가 있어요. 잠시 후 다시 시도해주세요.", "system-error");
            }
        } else {
            appendBubble("안녕하세요! 대화 기능을 불러오는 데 문제가 있어 대화를 시작할 수 없습니다.", "system-error");
        }
        hasGreeted = true;
      } else if (chatHistory.length > 0) { 
          chatHistory.forEach(msg => appendBubble(msg.content, msg.role === 'assistant' ? 'ai' : msg.role));
          console.log("이전 대화 기록 복원 완료.");
          hasGreeted = true; 
      }

      function setLoading(flag) {
        sendButton.disabled = flag;
        if (SpeechRec) {
            micButton.disabled = flag || isTTSRunning; 
        } else {
            micButton.disabled = true;
        }
        sendButton.classList.toggle('loading', flag);
      }
      
      async function handleUserText(text) {
        if (!text || !text.trim()) return;
        stopCurrentTTS(); 
        document.querySelector('.bubble.user.interim')?.remove();
        appendBubble(text, 'user');
        
        const historyForGpt = chatHistory.slice(); 
        chatHistory.push({ role: 'user', content: text, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        
        setLoading(true);
        let res;
        try {
          const contextForGpt = {
            // userId, // userId는 getGptResponse 내부에서 localStorage.getItem('lozee_userid') 등으로 가져오거나,
                     // 또는 여기서 명시적으로 localStorage.getItem('lozee_username')을 사용
            userAge, 
            userName, // initializeApp 스코프의 userName 사용
            userDisease,
            chatHistory: historyForGpt.slice(-10), 
            selectedTopic: currentSelectedTopic,
            currentStage: localStorage.getItem('currentStage') || 'Stage 1'
          };

          if (typeof getGptResponseFromDialog !== 'function') {
            console.error("CRITICAL: getGptResponse 함수를 찾을 수 없습니다.");
            appendBubble("죄송합니다, 응답을 처리할 수 없습니다.", "system-error");
            setLoading(false);
            return;
          }
          res = await getGptResponseFromDialog(text, contextForGpt); 

          if (!res.ok) {
            console.error(`API Error: ${res.status} ${res.statusText}.`);
            let errorData;
            try {
                errorData = await res.json(); 
                console.error("API Error Body (JSON Parsed):", errorData);
            } catch (e) {
                const rawErrorText = await res.text().catch(() => "오류 응답 본문을 읽을 수 없습니다.");
                console.error("Raw API Error Text:", rawErrorText);
                errorData = { text: rawErrorText.substring(0,150) || `API 요청 실패 (${res.status})`};
            }
            appendBubble(errorData.text || `API 요청 실패: ${res.status}`, 'system-error');
            chatHistory.push({ role: 'system', content: `API 오류: ${res.status}`, error: errorData, timestamp: new Date().toISOString() });
            setLoading(false); return;
          }

          const data = await res.json();
          console.log("GPT API 응답:", data);
          const botMessage = data?.text || "응답을 받지 못했어요.";
          appendBubble(botMessage, 'ai'); 
          
          const botResponseEntry = { role: 'assistant', content: botMessage, timestamp: new Date().toISOString() }; 
          if (data.analysis && Object.keys(data.analysis).length > 0) {
            console.log("💡 수신된 분석 데이터:", data.analysis);
            botResponseEntry.analysis = data.analysis;
            if (typeof renderLiteracyAnalysisFromAnalysis === 'function' && analysisContainer && data.analysis.literacy_markers) { 
               renderLiteracyAnalysisFromAnalysis(data.analysis.literacy_markers, 'analysis-container');
               if(analysisContainer) analysisContainer.style.display = 'block';
            } else if (analysisContainer) {
                analysisContainer.innerHTML = ''; analysisContainer.style.display = 'none';
            }
            await saveSessionLog(text, botMessage, data.analysis);
          } else {
             if (analysisContainer) { analysisContainer.innerHTML = ''; analysisContainer.style.display = 'none'; }
             console.log("분석 데이터가 비어있거나 수신되지 않았습니다.");
             await saveSessionLog(text, botMessage, {}); 
          }
          chatHistory.push(botResponseEntry);
          localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
          
          let isSummarizationConfirmed = false;
          if (window.LOZEE_STATE && window.LOZEE_STATE.awaitingSummaryConfirmation) {
            if (text.includes("1") || text.toLowerCase().includes("응") || text.includes("정리") || text.includes("요약") || text.toLowerCase().includes("그래") || text.toLowerCase().includes("예")) {
                isSummarizationConfirmed = true;
            }
            window.LOZEE_STATE.awaitingSummaryConfirmation = false;
          }

          if (isSummarizationConfirmed) { 
            appendBubble("알겠어, 우리가 나눈 이야기를 정리해볼게! 잠시만 기다려줘 😊", 'ai_feedback');
            await playTTSWithControl("알겠어, 우리가 나눈 이야기를 정리해볼게! 잠시만 기다려줘", lsSelectedVoice);

            const summaryContext = {
                ...contextForGpt,
                chatHistory: historyForGpt.slice(-10) 
            };
            const summaryResponse = await getGptResponseFromDialog("SYSTEM_COMMAND_SUMMARIZE_HISTORY", summaryContext);
            
            if (!summaryResponse.ok) throw new Error(`요약 API 오류: ${summaryResponse.status}`);
            const summaryData = await summaryResponse.json();

            const summaryText = summaryData.text;
            const summaryAnalysis = summaryData.analysis; 

            appendBubble(summaryText, 'ai');
            await playTTSWithControl(summaryText, lsSelectedVoice);
            await saveSessionLog(`대화 요약 요청 (사용자 응답: ${text})`, summaryText, summaryAnalysis); 
            
            // if (typeof saveConversationSummaryAsJournal === 'function') { 
            //    // saveConversationSummaryAsJournal 함수는 현재 talk.html에 정의되어 있지 않습니다.
            //    // journal.html의 기능을 사용하려면 별도 모듈화 또는 여기에 구현 필요.
            //    // await saveConversationSummaryAsJournal(summaryText, summaryAnalysis, contextForGpt);
            //    console.log("saveConversationSummaryAsJournal 호출 (현재 talk.html에 미구현)");
            // }

            const saveConfirmMsg = `${userNameWithVocative}, 방금 정리한 내용은 일기에도 잘 남겨뒀어! (저장 기능은 journal.html에 있어요) ✨`;
            appendBubble(saveConfirmMsg, 'ai');

            await playTTSWithControl(saveConfirmMsg, lsSelectedVoice);
            chatHistory.push({ role: 'assistant', content: summaryText, analysis: summaryAnalysis, timestamp: new Date().toISOString() });
            chatHistory.push({ role: 'assistant', content: saveConfirmMsg, timestamp: new Date().toISOString() });
            localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));

          } else { 
            if(typeof playTTSFromText_original === 'function') {
               await playTTSWithControl(botMessage, lsSelectedVoice);
            }
            if (botMessage.includes("정리해볼까?") && (botMessage.includes("1.") || botMessage.includes("첫 번째")) && (botMessage.includes("2.") || botMessage.includes("두 번째"))) {
                window.LOZEE_STATE.awaitingSummaryConfirmation = true;
            }
          }

        } catch (err) {
          console.error("❌ 메시지 처리 중 전체 오류:", err);
          if(res) console.error("오류 시점 API 응답 객체 (res):", {status: res.status, ok: res.ok});
          const errorDisplayMsg = "죄송해요, 메시지 처리 중 예상치 못한 오류가 발생했어요. 잠시 후 다시 시도해주세요.";
          appendBubble(errorDisplayMsg, 'system-error');
          chatHistory.push({ role: 'system', content: '클라이언트 처리 오류', error: err.message, timestamp: new Date().toISOString() });
        }
        setLoading(false); 
        if(chatInput) {
            chatInput.value = ''; 
        }
      }

      sendButton.onclick = () => { if(chatInput) handleUserText(chatInput.value); };
      chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserText(chatInput.value); } };
      
      if (!hasGreeted && chatHistory.length === 0) { 
          await initGreeting();
          hasGreeted = true;
      } else if (chatHistory.length > 0) { 
          chatHistory.forEach(msg => appendBubble(msg.content, msg.role === 'assistant' ? 'ai' : msg.role));
          console.log("이전 대화 기록 복원 완료.");
          hasGreeted = true; 
      }

    } // initializeApp 함수의 끝
  </script>
</body>
</html>
