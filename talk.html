<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEE 상담</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { display:flex; flex-direction:column; height:100vh; margin:0; font-family:'KoPubWorld Dotum',sans-serif; }
    #main-header { background:#0095FF; color:#fff; padding:1rem; text-align:center; font-size:1.25rem; }
    #status-bar { display:flex; align-items:center; justify-content:center; gap:1rem; background:#eef; padding:0.5rem; }
    #mic-indicator { font-size:0.9rem; }
    #vu-meter { width:100px; height:20px; background:#ccc; border-radius:4px; }
    #chat-window { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .bubble { max-width:80%; padding:0.75rem 1rem; border-radius:1rem; line-height:1.4; white-space:pre-wrap; }
    .user { background:#fff9c4; color:#333; align-self:flex-end; border-bottom-right-radius:0.25rem; }
    .ai   { background:#0095FF;  color:#fff; align-self:flex-start; border-bottom-left-radius:0.25rem; }
    #silence-banner { text-align:center; padding:0.5rem; background:#f0f0f0; color:#666; font-size:0.9rem; display:none; }
    #loading-indicator { display:none; text-align:center; padding:0.5rem; color:#555; font-style:italic; }
  </style>
</head>
<body>
  <header id="main-header">LOZEE 상담</header>
  <div id="status-bar">
    <div id="mic-indicator">🔵 대기 중</div>
    <canvas id="vu-meter"></canvas>
  </div>
  <div id="chat-window"></div>
  <div id="silence-banner">말씀하시면 바로 들어드려요</div>
  <div id="loading-indicator">처리 중...</div>

  <script type="module">
  import { playTTSFromText } from './js/tts.js';
  import { getGptResponse } from './js/gpt-dialog.js';

  const State = { READY:'READY', RECORD:'RECORD', SILENCE:'SILENCE' };
  let currentState = State.READY;
  let silenceTimer;
  let recognition, userBubble, currentTTS;

  const chatWindow   = document.getElementById('chat-window');
  const micIndicator = document.getElementById('mic-indicator');
  const vuCanvas     = document.getElementById('vu-meter');
  const silenceBanner= document.getElementById('silence-banner');
  const loading      = document.getElementById('loading-indicator');
  const ttsVoice     = localStorage.getItem('lozee_tts_voice') || 'ko-KR-Chirp3-HD-Vindemiatrix';

  function appendMessage(text, role) {
    const div = document.createElement('div');
    div.className = `bubble ${role}`;
    div.textContent = text;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return div;
  }

  function setMic(text) { micIndicator.textContent = text; }
  function showBanner(on) { silenceBanner.style.display = on ? 'block' : 'none'; }
  function showLoading(on) { loading.style.display = on ? 'block' : 'none'; }

  function transition(to) {
    clearTimeout(silenceTimer);
    currentState = to;
    showBanner(to === State.SILENCE);
    console.log('State →', to);
  }

  async function handleUserTurn(text) {
    // 중단된 STT와 TTS 처리
    if (recognition) {
      recognition.abort();
      setMic('🔵 대기 중');
    }
    appendMessage(text, 'user');
    showLoading(true);
    if (currentTTS) { currentTTS.pause(); currentTTS = null; }

    const res = await getGptResponse(text);
    showLoading(false);
    if (typeof res === 'string') {
      appendMessage(res, 'ai');
      currentTTS = await playTTSFromText(res, ttsVoice);
      currentTTS.onended = () => {
        if (recognition) {
          recognition.start();
          setMic('🔴 듣고 있어요');
        }
      };
    } else if (res.error) {
      appendMessage(res.error, 'ai');
      if (recognition) {
        recognition.start();
        setMic('🔴 듣고 있어요');
      }
    }
    transition(State.READY);
  }

  async function initSTT() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      setupVUMeter(stream);
    } catch (e) {
      appendMessage('마이크 권한이 필요합니다.', 'ai');
      return;
    }

    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ko-KR';
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onresult = e => {
      let interim = '', final = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        e.results[i].isFinal ? final += t : interim += t;
      }
      if (interim) userBubble.textContent = interim;
      if (final) userBubble.textContent = final;
    };

    recognition.onspeechstart = onVoiceStart;
    recognition.onspeechend = onVoiceEnd;
    recognition.onerror = e => console.warn('STT 오류', e);

    transition(State.READY);
    recognition.start();
    setMic('🔴 듣고 있어요');
  }

  function onVoiceStart() {
    if (currentState === State.READY || currentState === State.SILENCE) {
      transition(State.RECORD);
      setMic('🔴 듣고 있어요');
      userBubble = appendMessage('', 'user');
      clearTimeout(silenceTimer);
    }
  }

  function onVoiceEnd() {
    if (currentState === State.RECORD) {
      transition(State.SILENCE);
      setMic('🔵 대기 중');
      recognition.stop();
      silenceTimer = setTimeout(() => {
        handleUserTurn(userBubble.textContent);
      }, 5000);
    }
  }

  function setupVUMeter(stream) {
    const ctx = new AudioContext();
    const src = ctx.createMediaStreamSource(stream);
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 64;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    const dib = vuCanvas.getContext('2d');
    const cw = vuCanvas.width, ch = vuCanvas.height;
    (function draw() {
      analyser.getByteFrequencyData(data);
      dib.clearRect(0, 0, cw, ch);
      const barWidth = cw / data.length;
      data.forEach((v, i) => {
        const h = (v / ch) * ch;
        dib.fillStyle = '#4caf50';
        dib.fillRect(i * barWidth, ch - h, barWidth - 1, h);
      });
      requestAnimationFrame(draw);
    })();
  }

  async function initIntro() {
    const intro = localStorage.getItem('lozee_user_typed_intro') || '';
    if (intro) {
      await handleUserTurn(intro);
      localStorage.removeItem('lozee_user_typed_intro');
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await initSTT();
    await initIntro();
  });
  </script>
</body>
</html>
