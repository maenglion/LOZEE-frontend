<!DOCTYPE html>
<html lang="ko">
<head>
  <script>
    // ì´ˆê¸° ì„¤ì • í™•ì¸ ë° ë¦¬ë‹¤ì´ë ‰ì…˜ ë¡œì§
    const isConfigured = localStorage.getItem('lozee_username') &&
                         localStorage.getItem('lozee_voice') &&
                         localStorage.getItem('lozee_userage');

    const topicForRedirect = localStorage.getItem('lozee_current_topic');

    if (isConfigured) {
      const targetUrl = topicForRedirect ? `talk.html?topic=${encodeURIComponent(topicForRedirect)}` : 'talk.html';
      window.location.href = targetUrl;
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>
  <style>
    :root {
      --primary-color: #6078ea; 
      --secondary-color: #f0f2f5; 
      --background-color: #FFFFFF; 
      
      --text-color-on-dark-bg: #FFFFFF; 
      --text-color-on-light-bg: #333333; 
      
      --input-background: #FFFFFF; 
      --input-border-color: #D1D5DB; 
      
      --bot-bubble-bg: #E9EBF8; 
      --bot-bubble-text: #374151; 
      
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #FFFFFF;
      
      --gnb-height: 56px;
      --chat-input-actual-height: 50px;
      --chat-input-padding-vertical: 10px;
      --chat-input-safe-area: env(safe-area-inset-bottom, 20px);
      --chat-input-total-height: calc(var(--chat-input-actual-height) + (2 * var(--chat-input-padding-vertical)) + var(--chat-input-safe-area));
      
      --gnb-title-color: var(--primary-color); 
      --gnb-menu-icon-color: var(--primary-color); 

      --volume-meter-default-bg: var(--primary-color);
      --meter-top-margin: 8px;
      --gnb-dropdown-border-color: #E5E7EB; 
    }
    body {
      margin:0;
      padding-top:var(--gnb-height);
      font-family:'KoPub World Dotum',sans-serif;
      background-color:var(--background-color); 
      color:var(--text-color-on-light-bg); 
      display:flex;
      flex-direction:column;
      height:100vh;
      box-sizing:border-box;
      overflow:hidden;
    }
    #gnb {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:var(--gnb-height);
      background-color:var(--background-color); 
      padding:0 16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.07); 
      z-index:1000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-sizing:border-box;
      border-bottom: 1px solid var(--input-border-color); 
    }
    #gnb-title {
      font-size:1.2em;
      font-weight:bold;
      color:var(--gnb-title-color); 
    }
    #menu-toggle {
      background:none;
      border:none;
      color:var(--gnb-menu-icon-color); 
      font-size:24px;
      cursor:pointer;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #dropdown-menu {
      position:fixed;
      top:var(--gnb-height);
      right:0;
      background-color:var(--background-color); 
      border-radius:0 0 0 8px;
      box-shadow:-2px 2px 5px rgba(0,0,0,0.08);
      width:200px;
      z-index:999;
      overflow:hidden;
      max-height:0;
      transition:max-height 0.3s ease-out;
      border-left: 1px solid var(--input-border-color);
      border-bottom: 1px solid var(--input-border-color);
    }
    #dropdown-menu.show{max-height:500px;}
    #dropdown-menu a {
      display:block;
      color:var(--text-color-on-light-bg); 
      text-decoration:none;
      padding:12px 16px;
      font-size:0.95em;
      border-bottom:1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child{border-bottom:none;}
    #dropdown-menu a:hover{background-color:var(--secondary-color);} 
    #meter-container {
      position:fixed;
      top:calc(var(--gnb-height) + var(--meter-top-margin));
      left:50%;
      transform:translateX(-50%);
      width:60%;
      max-width:300px;
      height:6px;
      background-color:#E5E7EB; 
      border-radius:3px;
      overflow:hidden;
      z-index:998;
    }
    #volume-level {
      width:0%;
      height:100%;
      background:var(--volume-meter-default-bg);
      border-radius:3px;
      transition:width 0.05s linear;
    }
    #chat-container {
      flex-grow:1;
      padding:16px;
      padding-top:calc(var(--meter-top-margin) + 6px + 10px);
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px; 
      margin-bottom: var(--chat-input-total-height); 
    }
    #analysis-container {
      padding:10px;
      background:#f3f4f6; 
      color:#4b5563; 
      font-size:0.85em;
      max-height:150px;
      overflow-y:auto;
      border-top:1px solid #e5e7eb; 
      display:none;
    }
    .bubble {
      padding:10px 15px; 
      border-radius:16px; 
      max-width:80%; 
      line-height:1.6;
      word-break:keep-all;
      box-shadow:0 1px 2px rgba(0,0,0,0.06); 
    }
    .bubble.user {
      background-color:var(--user-bubble-bg);
      color:var(--user-bubble-text);
      align-self:flex-end;
      border-bottom-right-radius:4px;
    }
    .bubble.bot {
      background-color:var(--bot-bubble-bg); 
      color:var(--bot-bubble-text); 
      align-self:flex-start;
      border-bottom-left-radius:4px;
    }
    .bubble.user.interim{opacity:.7;}
    .bubble.system-error, .bubble.ai_feedback { 
      background-color:#FFFBEB; 
      color:#92400E; 
      align-self:center;
      max-width:85%;
      text-align:center;
      font-size:0.9em;
      border:1px solid #FDE68A; 
      margin: 5px 0;
      border-radius: 8px; 
    }
    #chat-input-container {
      position:fixed;
      bottom:0;
      left:0;
      width:100%; 
      background-color:var(--background-color); 
      border-top: 1px solid var(--input-border-color); 
      box-shadow:0 -1px 3px rgba(0,0,0,0.05);
      box-sizing:border-box; 
      padding-top: var(--chat-input-padding-vertical); 
      padding-bottom: calc(var(--chat-input-padding-vertical) + var(--chat-input-safe-area));
    }
    .input-area { 
      display: flex; 
      align-items: center; 
      width: 100%; 
      padding: 0 12px; 
      box-sizing: border-box; 
      gap: 8px; 
      height: var(--chat-input-actual-height); 
    }
    #chat-input {
      flex:1;
      padding:10px 16px;
      border-radius:22px;
      border:1px solid var(--input-border-color); 
      font-size:1em;
      background-color:var(--input-background);
      color:var(--text-color-on-light-bg); 
      height:100%;
      box-sizing:border-box;
    }
    #chat-input::placeholder{color:#9CA3AF;}
    #mic-button, #send-button {
      width:44px;
      height:44px;
      border:none;
      border-radius:50%;
      background-color:var(--primary-color);
      color:var(--user-bubble-text); 
      font-size:1.3em;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background-color 0.2s ease, box-shadow 0.2s ease; 
      flex-shrink: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    #mic-button:hover, #send-button:hover{
        background-color:#4f65d1; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    #mic-button.recording{background-color:#EF4444; box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);}
    #send-button.loading{background:#D1D5DB;cursor:default; box-shadow: none;} 
    
    #chat-container::-webkit-scrollbar{width:6px;} 
    #chat-container::-webkit-scrollbar-track{background:transparent;} 
    #chat-container::-webkit-scrollbar-thumb{background:#D1D5DB;border-radius:3px;} 
    #chat-container::-webkit-scrollbar-thumb:hover{background:#9CA3AF;}
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (ì¤€ë¹„ì¤‘)</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ìµœê·¼ ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ì£¼ì œë³„ ëŒ€í™” ëª©ë¡</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ì†Œê°œ</a>
    </div>
  </nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-container">
    </div>
  <div id="analysis-container">
    </div>

  <div id="chat-input-container">
    <div class="input-area">
        <button id="mic-button" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off"/>
        <button id="send-button" title="ë©”ì‹œì§€ ì „ì†¡">â®</button>
    </div>
  </div>

  <script src="./js/gpt-dialog.js" defer></script>
  <script src="./js/tts.js" defer></script>
  <script src="./js/basic-features.js" defer></script>
  <script src="./js/literacyPatternCheckRenderer.js" defer></script>

  <script>
    // Firebase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ í•„ìš”)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    let app;
    let db;

    document.addEventListener('DOMContentLoaded', () => {
        try {
            // Firebase SDKê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ì´ˆê¸°í™”
            if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function') {
                app = firebase.initializeApp(firebaseConfig);
                if (typeof firebase.firestore === 'function') {
                    db = firebase.firestore();
                    console.log("Firebase initialized successfully.");
                } else {
                    console.error("Firebase Firestore SDK not found.");
                    throw new Error("Firebase Firestore SDK not found.");
                }
            } else {
                console.error("Firebase App SDK not found.");
                throw new Error("Firebase App SDK not found.");
            }
        } catch (e) {
            console.error("Firebase initialization error:", e);
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                 chatContainer.innerHTML = '<div class="bubble system-error" style="align-self:center; max-width: 80%; text-align:center;">ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        checkAndInit();
    });

    function checkAndInit(retries = 20, delay = 250) { 
        console.log("checkAndInit ì‹œë„:", retries);
        console.log("window.LOZEE_DIALOG:", window.LOZEE_DIALOG, ", typeof getGptResponse:", typeof window.LOZEE_DIALOG?.getGptResponse);
        console.log("window.LOZEE_TTS:", window.LOZEE_TTS, ", typeof playTTSFromText:", typeof window.LOZEE_TTS?.playTTSFromText);
        console.log("window.LOZEE_ANALYSIS:", window.LOZEE_ANALYSIS, ", typeof trackTime:", typeof window.LOZEE_ANALYSIS?.trackTime);
        console.log("typeof initializeApp:", typeof initializeApp);


        if (window.LOZEE_DIALOG && typeof window.LOZEE_DIALOG.getGptResponse === 'function' &&
            window.LOZEE_TTS && typeof window.LOZEE_TTS.playTTSFromText === 'function' &&
            window.LOZEE_ANALYSIS && typeof window.LOZEE_ANALYSIS.trackTime === 'function' &&
            typeof initializeApp === 'function') {
            initializeApp();
        } else if (retries > 0) {
            console.log(`í•„ìˆ˜ ê°ì²´/í•¨ìˆ˜ ë¡œë“œ ëŒ€ê¸° ì¤‘... (${retries}íšŒ ë‚¨ìŒ)`);
            setTimeout(() => checkAndInit(retries - 1, delay), delay);
        } else {
            console.error("CRITICAL: í•„ìˆ˜ JavaScript ê°ì²´/í•¨ìˆ˜ ë¡œë“œ ì‹¤íŒ¨. ì•±ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                 chatContainer.innerHTML = '<div class="bubble system-error" style="align-self:center; max-width: 80%; text-align:center;">ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            } else {
                document.body.innerHTML = '<div style="color:red;text-align:center;padding:50px;">ì±„íŒ… UI ë° ì•± ì´ˆê¸°í™” ì‹¤íŒ¨!</div>';
            }
        }
    }
    
    async function initializeApp() {
      console.log("initializeApp í˜¸ì¶œë¨. í•„ìš”í•œ ê°ì²´ë“¤ ë¡œë“œ í™•ì¸ë¨.");
      const chatContainer = document.getElementById('chat-container');
      const analysisContainer = document.getElementById('analysis-container');

      let hasGreeted = false;
      let isRecording = false;
      let mediaRecorder;
      let mediaStream;
      let audioChunks = [];
      let chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');

      const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
      const voiceId = localStorage.getItem('lozee_selectedVoice') || (window.LOZEE_TTS ? window.LOZEE_TTS.DEFAULT_VOICE : 'default-fallback-voice');
      const lastSummary = localStorage.getItem('lozee_lastSummary') || '';
      const topicFromUrl = new URLSearchParams(location.search).get('topic');

      let userNameWithVocative = userName;
      if (window.LOZEE_DIALOG && typeof window.LOZEE_DIALOG.getKoreanVocativeParticle === 'function') {
          const vocativeParticle = window.LOZEE_DIALOG.getKoreanVocativeParticle(userName);
          userNameWithVocative = `${userName}${vocativeParticle}`;
      } else {
          console.warn("getKoreanVocativeParticle í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (talk.html)");
          userNameWithVocative = `${userName}ì•¼`;
      }
      
      window.LOZEE_ST