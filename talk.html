<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEE 상담</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="chat-container">
    <!-- 대화 UI: LOZEE 메시지, 사용자 메시지 영역 등 -->
    <div id="messages"></div>
  </div>

  <script type="module">
    import { startSTT, stopSTT } from './stt.js';
    import { startTTS } from './tts.js';
    import { getGptResponse } from './gpt-dialog.js';

    const messagesEl = document.getElementById('messages');

    // 사용자 발화 처리
    async function handleUserTurn(transcript) {
      appendMessage('user', transcript);
      stopSTT();

      // GPT 응답 요청
      appendMessage('bot', '...');
      const gptText = await getGptResponse(transcript);

      // TTS 재생
      await startTTS(gptText);

      // 재생 끝나면 다시 STT 시작
      startSTT(handleUserTurn);
      updateLastBotMessage(gptText);
    }

    // 메시지 화면에 추가
    function appendMessage(sender, text) {
      const msg = document.createElement('div');
      msg.className = sender === 'bot' ? 'bot-message' : 'user-message';
      msg.textContent = text;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // 기존 마지막 "..." 텍스트를 실제 답변으로 교체
    function updateLastBotMessage(text) {
      const botMsgs = messagesEl.querySelectorAll('.bot-message');
      botMsgs[botMsgs.length - 1].textContent = text;
    }

    // 초기 대화 루틴
    async function initConversation() {
      const firstUtterance = sessionStorage.getItem('lozee_first_utterance');
      if (firstUtterance) {
        appendMessage('bot', firstUtterance);
        await startTTS(firstUtterance);
      }

      // 사용자가 첫마디를 입력했다면, 이후 바로 STT
      startSTT(handleUserTurn);
    }

    document.addEventListener('DOMContentLoaded', initConversation);
  </script>
</body>
</html>
