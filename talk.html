<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ê¸°ë³¸ í˜ì´ì§€ ë° í°íŠ¸ ìŠ¤íƒ€ì¼ */
    body { 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; 
      background-color: #ffffff; 
      color: #333; 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      margin: 0;
    }

    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    #main-header {
      background-color: #0095FF; /* ë¡œì§€ ë©”ì¸ ì»¬ëŸ¬ */
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      flex-shrink: 0; 
    }

    /* ì±„íŒ… ì»¨í…Œì´ë„ˆ ë° ì°½ ìŠ¤íƒ€ì¼ */
    #chat-container { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      overflow-y: hidden; 
      width: 100%; 
      max-width: 700px; 
      margin: 0 auto; 
      box-sizing: border-box; 
    }
    #chat-window { 
      flex: 1; 
      overflow-y: auto; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
    }

    /* ë§í’ì„  ê³µí†µ ìŠ¤íƒ€ì¼ */
    .bubble { 
      max-width: 80%; 
      padding: 12px 18px; 
      border-radius: 20px; 
      line-height: 1.6; 
      font-size: 16px; 
      white-space: pre-wrap; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .user { 
      background-color: #fff9c4; 
      color: #333; 
      align-self: flex-end; 
      margin-left: auto; 
      border-bottom-right-radius: 5px; 
    }
    .ai { 
      background-color: #0095FF; 
      color: white; 
      align-self: flex-start; 
      margin-right: auto; 
      border-bottom-left-radius: 5px; 
    }
    .bubble.ai.error { 
      background-color: #ff7373; 
      color: white; 
    }

    /* ë¡œë”© ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ */
    #loading-indicator-talk { 
      text-align: center; 
      padding: 10px; 
      display: none; 
      color: #555; 
      font-style: italic; 
    }

    /* í•˜ë‹¨ ë§ˆì´í¬ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #talk-btn-container { 
      padding: 15px 0; 
      background-color: #ffffff; 
      flex-shrink: 0; 
      text-align: center; 
      border-top: 1px solid #eee; 
    }
    #talk-btn { 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      background-color: #b6b6b6; /* Default grey */
      border: none; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
      color: white; 
      font-size: 36px; 
      cursor: pointer; 
      display: inline-flex; 
      justify-content: center; 
      align-items: center; 
      transition: transform 0.2s ease, background-color 0.3s; 
    }
    #talk-btn.active { /* Blue state - for continuable or initial active pulse (no longer used for chaining) */
      background-color: #0095FF; 
      transform: scale(1.1); 
    }
    #talk-btn.recording-in-progress { /* Red state */
        background-color: #e06c75; 
        transform: scale(1.1); 
    }
    #talk-btn:disabled { 
      background-color: #ccc; 
      cursor: not-allowed; 
      transform: scale(1.0); 
    }
    #topic-selection { display: none; background: #f0f0f0; padding: 20px; border-top: 1px solid #ddd; text-align: center; flex-shrink: 0; }
    #topic-selection h3 { font-size: 18px; color: #333; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
    .topic-option { font-family: 'KoPubWorld Dotum', sans-serif; padding: 10px 15px; margin: 8px auto; background: white; border: 1px solid #0095FF; color: #0095FF; border-radius: 10px; cursor: pointer; max-width: 320px; font-size: 15px; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
    .topic-option:hover { background-color: #0095FF; color: white; }
    #waiting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);  display: none;  justify-content: center; align-items: center; z-index: 1000;  color: white; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer;  }
  </style>
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="chat-container">
    <div id="chat-window"></div>
    <div id="topic-selection">
      <h3>ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ê³  ì‹¶ì€ ì£¼ì œë¥¼ ê³¨ë¼ë³¼ë˜?</h3>
      <div id="topic-options"></div>
    </div>
  </div>
  <div id="loading-indicator-talk">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>
  <div id="waiting-overlay">
    <p><span id="waitingUserName"></span>ë‹˜, ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...<br><small>(í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”)</small></p>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    console.log("talk.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (v3.19 - ì—°ë ¹ë³„ ìë™ ë…¹ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì ìš©)");

    const talkBtn = document.getElementById('talk-btn');
    const chatWindow = document.getElementById('chat-window');
    const topicSelectionBox = document.getElementById('topic-selection');
    const topicOptionsContainer = document.getElementById('topic-options');
    const loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
    const waitingOverlay = document.getElementById('waiting-overlay');
    const waitingUserNameSpan = document.getElementById('waitingUserName');

    const currentUserName = localStorage.getItem('lozee_username') || "ì¹œêµ¬";
    const currentUserId = localStorage.getItem('lozee_username'); 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';

    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try { selectedEmotions = JSON.parse(selectedEmotionsString); } 
        catch (e) { console.error("ì„ íƒëœ ê°ì • localStorage íŒŒì‹± ì˜¤ë¥˜:", e); selectedEmotions = []; }
    }

    const simplified = (() => {
      const age = parseInt(currentUserAge || "0", 10);
      const disease = (currentUserDisease || "").toLowerCase();
      const needsSimple = age < 15 || ["ì•„ìŠ¤í¼ê±°", "asd", "adhd", "ì‚¬íšŒì ì˜ì‚¬ì†Œí†µì¥ì• "].some(d => disease.includes(d));
      const isVeryYoung = age < 10;
      console.log(`[Simplified Language Check] Age: ${age}, Disease: "${disease}", NeedsSimple: ${needsSimple}, IsVeryYoung: ${isVeryYoung}`);
      return { useSimpleLanguage: needsSimple, useUltraSimpleLanguage: isVeryYoung };
    })();
    
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer;
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTimeValue; 

    const ADMIN_SECRET_PHRASE = "ê³ ì–‘ì´ë§¹êµ¬ë¦„ë§¹ëˆ„ë¦¬";
    const ADMIN_EMAIL = "maengnanyoung@gmail.com";

    let totalCharacterCount = 0;
    let conversationStartTime = null;
    const ANALYSIS_CHAR_THRESHOLD = 800; 
    const ANALYSIS_TIME_THRESHOLD_SECONDS = 180; 
    let analysisRedirectInProgress = false;
    
    // ì—°ë ¹ë³„ ë…¹ìŒ ì •ì±… ê´€ë ¨ ë³€ìˆ˜
    let currentSegmentDuration = 40000; // ê¸°ë³¸ê°’, ì •ì±…ì— ë”°ë¼ ì—…ë°ì´íŠ¸ë¨
    let maxTotalRecordingTime = 600000;  // ê¸°ë³¸ê°’, ì •ì±…ì— ë”°ë¼ ì—…ë°ì´íŠ¸ë¨
    let autoSegmentStartTime = null;     // ìë™ ì„¸ê·¸ë¨¼íŠ¸ ë…¹ìŒ ì„¸ì…˜ ì‹œì‘ ì‹œê°„
    let currentSegmentInAutoChain = 0;   // í˜„ì¬ ìë™ ì„¸ê·¸ë¨¼íŠ¸ ì²´ì¸ ë‚´ì˜ ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜
    
    let autoStopTimer = null; // ë‹¨ì¼ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ì¤‘ì§€ íƒ€ì´ë¨¸
    const API_DISCONNECT_DELAY_MS = 100; // ë‹¤ìŒ ìë™ ì„¸ê·¸ë¨¼íŠ¸ ì‹œì‘ ì „ ì§§ì€ ì§€ì—°

    // ì—°ë ¹ë³„ ë…¹ìŒ ì„¤ì • ì •ì˜ í•¨ìˆ˜
    function getRecordingPolicyByAge(age) {
        console.log(`[getRecordingPolicyByAge] Age: ${age}`);
        if (age <= 10) {
            return { segmentDuration: 30000, maxDuration: 180000 }; // 30ì´ˆ ë‹¨ìœ„, ì´ 3ë¶„
        } else if (age <= 15) {
            return { segmentDuration: 30000, maxDuration: 300000 }; // 30ì´ˆ ë‹¨ìœ„, ì´ 5ë¶„
        } else {
            return { segmentDuration: 40000, maxDuration: 600000 }; // 40ì´ˆ ë‹¨ìœ„, ì´ 10ë¶„
        }
    }

    function appendMessage(text, role = 'ai', isError = false) { /* (v3.18ê³¼ ë™ì¼) */ }
    function disableTalkButton(disable = true, reason = "") { /* (v3.18ê³¼ ë™ì¼) */ }
    async function loadRecentTopics() { /* (v3.18ê³¼ ë™ì¼) */ }
    function showTopicBox(topics) { /* (v3.18ê³¼ ë™ì¼) */ }
    function startSilenceTimer() { /* (v3.18ê³¼ ë™ì¼) */ }
    function resetSilenceTimer() { /* (v3.18ê³¼ ë™ì¼) */ }
    function checkAndRedirectToAnalysis() { /* (v3.18ê³¼ ë™ì¼) */ }

    async function handleUserInteraction(userText, context = {}) { 
      if (!userText || userText.trim() === "" || analysisRedirectInProgress) return;
      if (!conversationStartTime) conversationStartTime = Date.now();
      
      disableTalkButton(true, "AI ì‘ë‹µ ëŒ€ê¸° ì¤‘"); 
      topicSelectionBox.style.display = 'none'; 
      loadingIndicatorTalk.style.display = 'block';

      const gptContext = { userAge: currentUserAge, userDisease: currentUserDisease, useSimpleLanguage: simplified.useSimpleLanguage, useUltraSimpleLanguage: simplified.useUltraSimpleLanguage, ...context };
      console.log("[handleUserInteraction] GPT Context:", gptContext);
      try {
        const gptResponse = await getGptResponse(userText, currentUserId, gptContext);
        let aiReply = gptResponse?.rephrasing || gptResponse?.error || "ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ì´í•´í•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆì–´ìš”.";
        let isError = !gptResponse?.rephrasing;
        if (gptResponse?.summary) localStorage.setItem('lozee_lastSummary', (lastSummary = gptResponse.summary));
        
        loadingIndicatorTalk.style.display = 'none'; 
        const aiBubbleDiv = appendMessage(aiReply, 'ai', isError); 
        if (aiBubbleDiv) { chatWindow.appendChild(aiBubbleDiv); chatWindow.scrollTop = chatWindow.scrollHeight; }
        
        if (!analysisRedirectInProgress) { 
            try { await playTTSFromText(aiReply, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨:", e); } 
        }
      } catch (error) { 
        loadingIndicatorTalk.style.display = 'none';
        const fallbackMsg = "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.";
        const errorBubble = appendMessage(fallbackMsg, 'ai', true);
        if(errorBubble) chatWindow.appendChild(errorBubble);
        if (!analysisRedirectInProgress) {
            try { await playTTSFromText(fallbackMsg, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨ (ì˜¤ë¥˜ ì²˜ë¦¬ ì¤‘):", e); }
        }
      } finally {
        if (!analysisRedirectInProgress) { 
            disableTalkButton(false, "AI ì‘ë‹µ/ì˜¤ë¥˜ ì²˜ë¦¬ ì™„ë£Œ"); 
            // currentSegmentInAutoChainì€ ìë™ ì„¸ì…˜ì´ ì•„ë‹ ê²½ìš° ì—¬ê¸°ì„œ ë¦¬ì…‹, ìë™ ì„¸ì…˜ì˜ ê²½ìš° onstopì—ì„œ ê´€ë¦¬
            if (!autoSegmentStartTime) { // ìë™ ì„¸ì…˜ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ë¦¬ì…‹
                 currentSegmentInAutoChain = 0;
            }
            resetSilenceTimer(); 
            checkAndRedirectToAnalysis(); 
        }
      }
    }

    async function startRecording() {
      if (isRecording || analysisRedirectInProgress) { return; }
      
      // autoSegmentStartTimeì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ (ìë™ ì„¸ì…˜ ì¤‘), currentSegmentInAutoChain ì¦ê°€
      // ì•„ë‹ˆë¼ë©´ (ìˆ˜ë™ ì‹œì‘), 1ë¡œ ì„¤ì •
      if (autoSegmentStartTime) {
          currentSegmentInAutoChain++;
      } else { // ì‚¬ìš©ìê°€ ì²˜ìŒ ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš° (ìë™ ì„¸ì…˜ì˜ ì‹œì‘)
          const userAgeNum = parseInt(currentUserAge || "16", 10); // ê¸°ë³¸ê°’ ì„±ì¸ìœ¼ë¡œ
          const policy = getRecordingPolicyByAge(userAgeNum);
          currentSegmentDuration = policy.segmentDuration;
          maxTotalRecordingTime = policy.maxDuration;
          autoSegmentStartTime = Date.now(); // ìƒˆ ìë™ ì„¸ì…˜ ì‹œì‘ ì‹œê°„ ê¸°ë¡
          currentSegmentInAutoChain = 1; // ì´ ì„¸ì…˜ì˜ ì²« ë²ˆì§¸ ì„¸ê·¸ë¨¼íŠ¸
          console.log(`[startRecording] ìƒˆ ìë™ ë…¹ìŒ ì„¸ì…˜ ì‹œì‘. ì •ì±…: ${currentSegmentDuration}ms per segment, ${maxTotalRecordingTime}ms total.`);
      }
      
      console.log(`[startRecording] ìë™ ì„¸ê·¸ë¨¼íŠ¸ ${currentSegmentInAutoChain} ì‹œì‘. (ì„¸ê·¸ë¨¼íŠ¸ ê¸¸ì´: ${currentSegmentDuration}ms)`);
      
      topicSelectionBox.style.display = 'none'; waitingOverlay.style.display = 'none'; 
      try {
        if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; }
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
        isRecording = true;
        talkBtn.classList.remove('active'); talkBtn.classList.add('recording-in-progress'); talkBtn.innerHTML = 'â¹ï¸'; 
        disableTalkButton(false, "ë…¹ìŒ ì¤‘"); 
        audioChunks = []; const options = { mimeType: 'audio/webm;codecs=opus' };
        mediaRecorder = new MediaRecorder(mediaStream, options); recordingStartTimeValue = performance.now(); 
        
        mediaRecorder.ondataavailable = event => { if (event.data.size > 0) { audioChunks.push(event.data); } };
        
        mediaRecorder.onstop = async () => {
            console.log("[onstop] ë…¹ìŒ ì¤‘ì§€ë¨, ì²˜ë¦¬ ì‹œì‘...");
            isRecording = false; 

            const recordingEndTime = performance.now();
            const durationInMs = recordingEndTime - (recordingStartTimeValue || recordingEndTime); 
            const durationInSeconds = Math.round(durationInMs / 1000);
            console.log(`[onstop] ë…¹ìŒëœ ì˜¤ë””ì˜¤ ê¸¸ì´ (ì¶”ì •): ${durationInSeconds}ì´ˆ, ìë™ ì„¸ê·¸ë¨¼íŠ¸ ë²ˆí˜¸: ${currentSegmentInAutoChain}`);

            if (audioChunks.length === 0) { 
                console.log("[onstop] ì˜¤ë””ì˜¤ ë°ì´í„° ì—†ìŒ.");
                if (autoSegmentStartTime) { // ìë™ ì„¸ì…˜ ì¤‘ì¸ë° ì˜¤ë””ì˜¤ê°€ ì—†ë‹¤ë©´? ì¼ë‹¨ ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì‹œë„ ë˜ëŠ” ì„¸ì…˜ ì¢…ë£Œ ê²°ì •
                    const elapsedSinceSessionStart = Date.now() - autoSegmentStartTime;
                    if (elapsedSinceSessionStart < maxTotalRecordingTime) {
                        console.log("[Auto Segment] ì˜¤ë””ì˜¤ ì—†ìœ¼ë‚˜, ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ì‹œì‘ ì‹œë„.");
                        setTimeout(() => { if (autoSegmentStartTime && !analysisRedirectInProgress) startRecording(); }, API_DISCONNECT_DELAY_MS);
                        return; // handleUserInteraction ë“±ì€ ê±´ë„ˆëœ€
                    } else {
                        console.log("[Auto Segment] ì˜¤ë””ì˜¤ ì—†ê³ , ìµœëŒ€ ì‹œê°„ ë„ë‹¬. ìë™ ì„¸ì…˜ ì¢…ë£Œ.");
                        autoSegmentStartTime = null; currentSegmentInAutoChain = 0;
                        if(!analysisRedirectInProgress) disableTalkButton(false, "ìë™ ë…¹ìŒ ì¢…ë£Œ (ë°ì´í„° ì—†ìŒ)");
                        resetSilenceTimer();
                        return;
                    }
                } else { // ìˆ˜ë™ ë…¹ìŒì´ì—ˆëŠ”ë° ì˜¤ë””ì˜¤ê°€ ì—†ëŠ” ê²½ìš°
                    if (!analysisRedirectInProgress) {
                        disableTalkButton(false, "ë…¹ìŒ ë°ì´í„° ì—†ìŒ"); 
                        currentSegmentInAutoChain = 0; 
                        talkBtn.innerHTML = 'ğŸ¤';
                        talkBtn.classList.remove('active', 'recording-in-progress');
                    }
                    resetSilenceTimer(); 
                    return; 
                }
            }
            
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            audioChunks = [];
            
            let sttProcessedAndHandled = false;

            if (!analysisRedirectInProgress) disableTalkButton(true, "STT/GPT ì²˜ë¦¬ ì¤‘");
            try {
                const userText = await getSTTFromAudio(audioBlob, durationInSeconds);
                if (userText && userText.trim() !== "") { 
                    appendMessage(userText, 'user'); 
                    const isFirst = onboardingComplete && !localStorage.getItem('lozee_first_voice_interaction_done');
                    await handleUserInteraction(userText, isFirst ? { initialUserMessage: userText, initialUserEmotions: selectedEmotions, isFirstChatAfterOnboarding: true } : {});
                    if (isFirst) { localStorage.setItem('lozee_first_voice_interaction_done', 'true'); localStorage.removeItem('lozee_selected_emotions'); }
                    sttProcessedAndHandled = true; 
                } else { 
                    const noSttMsgDiv = appendMessage("ì£„ì†¡í•´ìš”, ì˜ ì•Œì•„ë“£ì§€ ëª»í–ˆì–´ìš”.", 'ai', true);
                    if (noSttMsgDiv) chatWindow.appendChild(noSttMsgDiv);
                    if (!analysisRedirectInProgress) {
                        try { await playTTSFromText(noSttMsgDiv.textContent, currentVoiceId); } catch(e) {console.error("TTS error for no STT", e);}
                        // STT ê²°ê³¼ ì—†ì–´ë„ handleUserInteractionì˜ finallyê°€ ë²„íŠ¼/íƒ€ì´ë¨¸ ì²˜ë¦¬í•˜ë„ë¡ í•¨.
                        // ë‹¤ë§Œ, ì´ ê²½ìš°ëŠ” GPT í˜¸ì¶œì´ ì—†ìœ¼ë¯€ë¡œ ì§ì ‘ ì²˜ë¦¬.
                        disableTalkButton(false, "STT ê²°ê³¼ ì—†ìŒ"); 
                        if (!autoSegmentStartTime) currentSegmentInAutoChain = 0; // ìë™ ì„¸ì…˜ ì•„ë‹ˆë©´ ë¦¬ì…‹
                        resetSilenceTimer();
                    }
                }
            } catch (sttError) { 
                const sttErrorMsgDiv = appendMessage("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", 'ai', true);
                if (sttErrorMsgDiv) chatWindow.appendChild(sttErrorMsgDiv);
                if (!analysisRedirectInProgress) {
                    try {await playTTSFromText(sttErrorMsgDiv.textContent, currentVoiceId); } catch(e) {console.error("TTS error for STT error", e);}
                    disableTalkButton(false, "STT ì˜¤ë¥˜"); 
                    if (!autoSegmentStartTime) currentSegmentInAutoChain = 0; // ìë™ ì„¸ì…˜ ì•„ë‹ˆë©´ ë¦¬ì…‹
                    resetSilenceTimer();
                }
            }

            // ìë™ ì„¸ê·¸ë¨¼íŠ¸ ì´ì–´ë¶™ì´ê¸° ë¡œì§
            if (autoSegmentStartTime) { // ìë™ ë…¹ìŒ ì„¸ì…˜ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ
                const elapsedSinceSessionStart = Date.now() - autoSegmentStartTime;
                console.log(`[Auto Segment] ì „ì²´ ìë™ ë…¹ìŒ ê²½ê³¼ ì‹œê°„: ${Math.round(elapsedSinceSessionStart/1000)}s / ${maxTotalRecordingTime/1000}s`);

                if (elapsedSinceSessionStart < maxTotalRecordingTime) {
                    console.log("[Auto Segment] ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ì‹œì‘ ì¡°ê±´ ì¶©ì¡±.");
                    // GPT ì‘ë‹µì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë‹¤ìŒ ë…¹ìŒ ì‹œì‘ (handleUserInteractionì€ ë¹„ë™ê¸°)
                    // ë²„íŠ¼ì€ handleUserInteractionì˜ finallyì—ì„œ ë‹¤ì‹œ í™œì„±í™”ë  ê²ƒì´ê³ , ë‹¤ìŒ startRecordingì—ì„œ ë‹¤ì‹œ ë¹„í™œì„±í™”ë¨.
                    setTimeout(() => { 
                        if (autoSegmentStartTime && !analysisRedirectInProgress) { // ìˆ˜ë™ ì¤‘ì§€ ë“±ìœ¼ë¡œ ì„¸ì…˜ì´ ì·¨ì†Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
                           console.log("[Auto Segment] setTimeout ì‹¤í–‰, ë‹¤ìŒ startRecording í˜¸ì¶œ");
                           startRecording(); 
                        } else {
                           console.log("[Auto Segment] setTimeout ì‹¤í–‰, ê·¸ëŸ¬ë‚˜ autoSegmentStartTimeì´ nullì´ê±°ë‚˜ ë¶„ì„ ì´ë™ ì¤‘. ë‹¤ìŒ ë…¹ìŒ ì•ˆí•¨.");
                           if (!analysisRedirectInProgress && !isRecording) { // ë²„íŠ¼ì´ ë¹„í™œì„±í™” ìƒíƒœë¡œ ë‚¨ì§€ ì•Šë„ë¡
                               disableTalkButton(false, "ìë™ ì„¸ì…˜ ì¤‘ë‹¨ë¨");
                               resetSilenceTimer();
                           }
                        }
                    }, API_DISCONNECT_DELAY_MS);
                } else {
                    console.log("[Auto Segment] ìµœëŒ€ ìë™ ë…¹ìŒ ì‹œê°„ ë„ë‹¬. ìë™ ì„¸ì…˜ ì¢…ë£Œ.");
                    autoSegmentStartTime = null; 
                    // currentSegmentInAutoChainì€ handleUserInteractionì˜ finallyì—ì„œ ë¦¬ì…‹ë¨ (sttProcessedAndHandledê°€ trueì¼ë•Œ)
                    // ë˜ëŠ” ì—¬ê¸°ì„œë„ ë¦¬ì…‹í•´ì¤˜ë„ ë¨.
                    if (!sttProcessedAndHandled && !analysisRedirectInProgress) { // ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸ ì²˜ë¦¬ê°€ ì‹¤íŒ¨í•œ ê²½ìš°
                        disableTalkButton(false, "ìµœëŒ€ ìë™ ë…¹ìŒ ì‹œê°„ ë„ë‹¬");
                        currentSegmentInAutoChain = 0;
                        resetSilenceTimer();
                    }
                }
            } else {
                console.log("[onstop] ìˆ˜ë™ ì¤‘ì§€ëœ ë…¹ìŒ ì„¸ì…˜ì´ê±°ë‚˜, ìë™ ì„¸ì…˜ì´ ì•„ë‹˜.");
                // ìˆ˜ë™ ì¤‘ì§€ ì‹œ currentSegmentInAutoChainì€ talkBtn í•¸ë“¤ëŸ¬ ë˜ëŠ” stopRecordingì—ì„œ ì´ë¯¸ ë¦¬ì…‹ë¨.
                // ë²„íŠ¼ í™œì„±í™” ë° íƒ€ì´ë¨¸ ë¦¬ì…‹ì€ handleUserInteractionì˜ finally ë˜ëŠ” STT ì‹¤íŒ¨/ê²°ê³¼ì—†ìŒ ê²½ë¡œì—ì„œ ì²˜ë¦¬ë¨.
            }
        }; // onstop í•¸ë“¤ëŸ¬ ë
        
        mediaRecorder.start(); 
        console.log(`[TIMER_LOG] autoStopTimer (ë‹¨ì¼ ì„¸ê·¸ë¨¼íŠ¸ìš©) ì„¤ì •: ${currentSegmentDuration}ms í›„`);
        clearTimeout(autoStopTimer); 
        autoStopTimer = setTimeout(() => { 
            console.log(`[TIMER_LOG] autoStopTimer ì‹¤í–‰ë¨ (ìë™ ì„¸ê·¸ë¨¼íŠ¸ ${currentSegmentInAutoChain}). isRecording: ${isRecording}, state: ${mediaRecorder?.state}`);
            if (isRecording && mediaRecorder && mediaRecorder.state === "recording") { 
                console.log("[TIMER_LOG] autoStopTimerê°€ stopRecording(false) í˜¸ì¶œ");
                stopRecording(false); // ìë™ ì¤‘ì§€ì´ë¯€ë¡œ isManualStop = false
            }
        }, currentSegmentDuration);
        
        // resetSilenceTimer(); // ë…¹ìŒ ì‹œì‘ ì‹œì—ëŠ” ì¹¨ë¬µì´ ì•„ë‹ˆë¯€ë¡œ í˜¸ì¶œ ë¶ˆí•„ìš”. ì‚¬ìš©ìê°€ ë§í•˜ê³  ìˆìœ¼ë¯€ë¡œ.
      } catch (error) { 
            const errorMsgDiv = appendMessage("ë§ˆì´í¬ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", 'ai', true);
            if (errorMsgDiv) chatWindow.appendChild(errorMsgDiv);
            isRecording = false; talkBtn.innerHTML = 'ğŸ¤';
            talkBtn.classList.remove('active', 'recording-in-progress');
            if (!analysisRedirectInProgress) disableTalkButton(false, "ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜");
            autoSegmentStartTime = null; currentSegmentInAutoChain = 0; // ì˜¤ë¥˜ ì‹œ ìë™ ì„¸ì…˜ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
        }
    }

    function stopRecording(isManualStop = false) { 
        console.log(`[stopRecording] í˜¸ì¶œë¨. ìˆ˜ë™ ì¤‘ì§€: ${isManualStop}`);
        clearTimeout(autoStopTimer); autoStopTimer = null; 
        
        if (isManualStop) {
            console.log("[stopRecording] ìˆ˜ë™ ì¤‘ì§€ë¡œ autoSegmentStartTime ë° currentSegmentInAutoChain ì´ˆê¸°í™”.");
            autoSegmentStartTime = null; 
            currentSegmentInAutoChain = 0;
        }
        
        if (mediaRecorder && mediaRecorder.state === "recording") { 
            console.log("[stopRecording] mediaRecorder.stop() í˜¸ì¶œ");
            mediaRecorder.stop(); 
        } else { 
            console.log("[stopRecording] mediaRecorderê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì¤‘ì§€ë¨. isRecordingì„ falseë¡œ ì„¤ì •.");
            isRecording = false; 
            // ë§Œì•½ ë…¹ìŒê¸°ê°€ ì´ë¯¸ ë©ˆì¶˜ ìƒíƒœì—ì„œ ìˆ˜ë™ ì¤‘ì§€ë¥¼ ì‹œë„í•˜ë©´, ë²„íŠ¼ ìƒíƒœê°€ ê¼¬ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸.
            if (isManualStop && !analysisRedirectInProgress) {
                 disableTalkButton(false, "ìˆ˜ë™ ì¤‘ì§€ ì™„ë£Œ");
                 talkBtn.innerHTML = 'ğŸ¤';
                 talkBtn.classList.remove('recording-in-progress', 'active');
                 resetSilenceTimer();
            }
        }
    }

    talkBtn.addEventListener('click', async () => { 
      if (analysisRedirectInProgress) { return; }
      waitingOverlay.style.display = 'none'; 
      if (!firstInteractionDone && !onboardingComplete && initialGreetingText) { 
        firstInteractionDone = true; disableTalkButton(true, "ì´ˆê¸° ì¸ì‚¬ë§ TTS ì¤‘"); loadingIndicatorTalk.style.display = 'block';
        try { await playTTSFromText(initialGreetingText, currentVoiceId); } 
        catch (error) {
          const errorBubble = appendMessage( error.name === 'NotAllowedError' ? "(ëª©ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë ¤ë©´ í™”ë©´ì„ ë‹¤ì‹œ í•œë²ˆ í´ë¦­í•˜ê±°ë‚˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.)" : "(ì´ˆê¸° ì•ˆë‚´ ìŒì„± ì¬ìƒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)", "ai", true);
          if(errorBubble) chatWindow.appendChild(errorBubble); 
        } finally { loadingIndicatorTalk.style.display = 'none'; disableTalkButton(false, "ì´ˆê¸° ì¸ì‚¬ë§ TTS ì™„ë£Œ/ì‹¤íŒ¨"); resetSilenceTimer(); }
        return; 
      }

      if (!isRecording) {
        // ì‚¬ìš©ìê°€ ë…¹ìŒ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¦„ -> ìƒˆ ìë™ ì„¸ì…˜ ì‹œì‘ ë˜ëŠ” ê¸°ì¡´ ì„¸ì…˜ ì´ì–´ê°€ê¸° ì•„ë‹˜.
        autoSegmentStartTime = null; // ì´ì „ ìë™ ì„¸ì…˜ í™•ì‹¤íˆ ì¢…ë£Œ
        currentSegmentInAutoChain = 0; // ì¹´ìš´íŠ¸ ë¦¬ì…‹
        startRecording(); // ì—¬ê¸°ì„œ ìƒˆë¡œìš´ autoSegmentStartTimeì´ ì„¤ì •ë¨
      } else { 
        // ì‚¬ìš©ìê°€ ë…¹ìŒ ì¤‘ì§€ ë²„íŠ¼ì„ ëˆ„ë¦„
        stopRecording(true); // ìˆ˜ë™ ì¤‘ì§€ì„ì„ ëª…ì‹œ
      }
    });
    
    waitingOverlay.addEventListener('click', () => { /* (v3.16ê³¼ ë™ì¼) */ }); 
    async function initializeChat() { /* (v3.16ê³¼ ë™ì¼) */ }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeChat);
    } else {
        initializeChat();
    }
  </script>
</body>
</html>
