<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEEì™€ ëŒ€í™”</title>
  <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ê¸°ë³¸ í˜ì´ì§€ ë° í°íŠ¸ ìŠ¤íƒ€ì¼ */
    body { 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh; 
      background-color: #ffffff; 
      color: #333; 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      margin: 0;
    }

    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    #main-header {
      background-color: #0095FF; /* ë¡œì§€ ë©”ì¸ ì»¬ëŸ¬ */
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      flex-shrink: 0; 
    }

    /* ì±„íŒ… ì»¨í…Œì´ë„ˆ ë° ì°½ ìŠ¤íƒ€ì¼ */
    #chat-container { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      overflow-y: hidden; 
      width: 100%; 
      max-width: 700px; 
      margin: 0 auto; 
      box-sizing: border-box; 
    }
    #chat-window { 
      flex: 1; 
      overflow-y: auto; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
    }

    /* ë§í’ì„  ê³µí†µ ìŠ¤íƒ€ì¼ */
    .bubble { 
      max-width: 80%; 
      padding: 12px 18px; 
      border-radius: 20px; 
      line-height: 1.6; 
      font-size: 16px; 
      white-space: pre-wrap; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .user { 
      background-color: #fff9c4; 
      color: #333; 
      align-self: flex-end; 
      margin-left: auto; 
      border-bottom-right-radius: 5px; 
    }
    .ai { 
      background-color: #0095FF; 
      color: white; 
      align-self: flex-start; 
      margin-right: auto; 
      border-bottom-left-radius: 5px; 
    }
    .bubble.ai.error { 
      background-color: #ff7373; 
      color: white; 
    }

    /* ë¡œë”© ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ */
    #loading-indicator-talk { 
      text-align: center; 
      padding: 10px; 
      display: none; 
      color: #555; 
      font-style: italic; 
    }

    /* í•˜ë‹¨ ë§ˆì´í¬ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #talk-btn-container { 
      padding: 15px 0; 
      background-color: #ffffff; 
      flex-shrink: 0; 
      text-align: center; 
      border-top: 1px solid #eee; 
    }
    #talk-btn { 
      font-family: 'KoPubWorld Dotum', sans-serif; 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      background-color: #b6b6b6; /* Default grey */
      border: none; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
      color: white; 
      font-size: 36px; 
      cursor: pointer; 
      display: inline-flex; 
      justify-content: center; 
      align-items: center; 
      transition: transform 0.2s ease, background-color 0.3s; 
    }
    #talk-btn.active { /* Blue state - for continuable or initial active pulse */
      background-color: #0095FF; 
      transform: scale(1.1); 
    }
    #talk-btn.recording-in-progress { /* Red state - for 0-25s recording */
        background-color: #e06c75; /* Softer red */
        transform: scale(1.1); 
    }
    #talk-btn:disabled { 
      background-color: #ccc; 
      cursor: not-allowed; 
      transform: scale(1.0); 
    }

    /* ì£¼ì œ ì„ íƒ ë°•ìŠ¤ ê´€ë ¨ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
    #topic-selection { display: none; background: #f0f0f0; padding: 20px; border-top: 1px solid #ddd; text-align: center; flex-shrink: 0; }
    #topic-selection h3 { font-size: 18px; color: #333; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
    .topic-option { font-family: 'KoPubWorld Dotum', sans-serif; padding: 10px 15px; margin: 8px auto; background: white; border: 1px solid #0095FF; color: #0095FF; border-radius: 10px; cursor: pointer; max-width: 320px; font-size: 15px; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
    .topic-option:hover { background-color: #0095FF; color: white; }

    /* ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
    #waiting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);  display: none;  justify-content: center; align-items: center; z-index: 1000;  color: white; font-size: 24px; font-weight: bold; text-align: center; cursor: pointer;  }
  </style>
</head>
<body>
  <header id="main-header">LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>

  <div id="chat-container">
    <div id="chat-window">
      </div>
    <div id="topic-selection">
      <h3>ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ê³  ì‹¶ì€ ì£¼ì œë¥¼ ê³¨ë¼ë³¼ë˜?</h3>
      <div id="topic-options">
        </div>
    </div>
  </div>

  <div id="loading-indicator-talk">AI ì‘ë‹µ ì¤€ë¹„ ì¤‘...</div>
  
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ë§í•˜ê¸°">ğŸ¤</button>
  </div>

  <div id="waiting-overlay">
    <p><span id="waitingUserName"></span>ë‹˜, ì ì‹œ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...<br><small>(í™”ë©´ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”)</small></p>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    console.log("talk.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (v3.12 - ì—°ì† ë…¹ìŒ ì‹œ ëª…ì‹œì  API ë¶„ë¦¬)");

    const talkBtn = document.getElementById('talk-btn');
    const chatWindow = document.getElementById('chat-window');
    const topicBox = document.getElementById('topic-selection');
    const topicOptionsContainer = document.getElementById('topic-options');
    const loadingIndicatorTalk = document.getElementById('loading-indicator-talk');
    const waitingOverlay = document.getElementById('waiting-overlay');
    const waitingUserName = document.getElementById('waitingUserName');

    const currentUserName = localStorage.getItem('lozee_username') || "ì¹œêµ¬";
    const currentUserId = localStorage.getItem('lozee_username'); 
    const currentVoiceId = localStorage.getItem('lozee_voice');
    const currentUserAge = localStorage.getItem('lozee_userage');
    const currentUserDisease = localStorage.getItem('lozee_userdiagnosis');
    let hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    let lastSummary = localStorage.getItem('lozee_lastSummary') || '';

    const onboardingComplete = localStorage.getItem('lozee_onboarding_complete') === 'true';
    const userTypedIntro = localStorage.getItem('lozee_user_typed_intro'); 
    const selectedEmotionsString = localStorage.getItem('lozee_selected_emotions');
    let selectedEmotions = [];
    if (selectedEmotionsString) {
        try {
            selectedEmotions = JSON.parse(selectedEmotionsString);
        } catch (e) {
            console.error("ì„ íƒëœ ê°ì • localStorage íŒŒì‹± ì˜¤ë¥˜:", e);
            selectedEmotions = [];
        }
    }

    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let mediaStream = null;
    let silenceTimer;
    const SILENCE_TIMEOUT = 20000; 
    let firstInteractionDone = false; 
    let initialGreetingText = "";    
    let recordingStartTimeValue; 

    const ADMIN_SECRET_PHRASE = "ê³ ì–‘ì´ë§¹êµ¬ë¦„ë§¹ëˆ„ë¦¬";
    const ADMIN_EMAIL = "maengnanyoung@gmail.com";

    let totalCharacterCount = 0;
    let conversationStartTime = null;
    const ANALYSIS_CHAR_THRESHOLD = 800; 
    const ANALYSIS_TIME_THRESHOLD_SECONDS = 180; 
    let analysisRedirectInProgress = false;

    const MAX_RECORDING_DURATION_MS = 30000; 
    const CONTINUE_THRESHOLD_MS = 25000;     
    const MAX_CONSECUTIVE_SEGMENTS = 5;      
    let currentSegmentCount = 0;             
    let autoStopTimer = null;                
    let continuePromptTimer = null;          
    let isEligibleToContinue = false;        
    let userClickedToContinue = false;       
    const API_DISCONNECT_DELAY_MS = 1000; // ì—°ì† ë…¹ìŒ ì‹œ API ë¶„ë¦¬ë¥¼ ìœ„í•œ ì§€ì—° ì‹œê°„

    function appendMessage(text, role = 'ai', isError = false) {
      // (ê¸°ì¡´ê³¼ ë™ì¼)
      if (!text || String(text).trim() === "") { return null; }
      const messageText = String(text);
      totalCharacterCount += messageText.length; 
      const msgDiv = document.createElement('div'); 
      msgDiv.className = `bubble ${role}`;
      if (isError && role === 'ai') msgDiv.classList.add('error');
      msgDiv.innerHTML = messageText.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
      if (role === 'user') { 
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
          resetSilenceTimer();
      }
      return msgDiv; 
    }

    function disableTalkButton(disable = true, reason = "") {
      talkBtn.disabled = disable;
      console.log(`[disableTalkButton] ${disable ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}${reason ? ` (${reason})` : ''}`);
    }

    async function loadRecentTopics() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ 
      if (!currentUserId) { return []; }
      try {
        const backendUrl = 'https://ggg-production.up.railway.app'; 
        const response = await fetch(`${backendUrl}/api/topics?userId=${encodeURIComponent(currentUserId)}`);
        if (!response.ok) { return []; }
        const data = await response.json(); 
        return data.topics || [];
      } catch (error) { return []; }
    }

    function showTopicBox(topics) { /* (ê¸°ì¡´ê³¼ ë™ì¼, ë‚´ìš© ê°„ê²°í™”) */ 
        topicOptionsContainer.innerHTML = ''; 
        let hasOptions = false;
        if (topics && topics.length > 0) { /* populate options */ hasOptions = true; } 
        else { /* populate default options */ hasOptions = true; }
        topicBox.style.display = hasOptions ? 'block' : 'none'; 
        if(hasOptions) setTimeout(() => chatWindow.scrollTop = chatWindow.scrollHeight, 0); 
    }

    function startSilenceTimer() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ 
        clearTimeout(silenceTimer); 
        silenceTimer = setTimeout(async () => {
            if (isRecording || analysisRedirectInProgress) { return; }
            const topics = await loadRecentTopics(); 
            showTopicBox(topics);
        }, SILENCE_TIMEOUT);
    }

    function resetSilenceTimer() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ 
        clearTimeout(silenceTimer);
        if (topicBox.style.display === 'none' && talkBtn.disabled === false && !analysisRedirectInProgress) {
            startSilenceTimer();
        }
    }
    
    function checkAndRedirectToAnalysis() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ 
        if (analysisRedirectInProgress || !conversationStartTime) return;
        const durationInSeconds = (Date.now() - conversationStartTime) / 1000;
        if (totalCharacterCount >= ANALYSIS_CHAR_THRESHOLD && durationInSeconds >= ANALYSIS_TIME_THRESHOLD_SECONDS) {
            analysisRedirectInProgress = true; 
            disableTalkButton(true, "ë¶„ì„ í˜ì´ì§€ ì´ë™ ì¤€ë¹„ ì¤‘");
            const redirectMsgDiv = appendMessage("(ëŒ€í™” ë‚´ìš©ì´ ì¶©ë¶„í•˜ì—¬ ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...)", "ai", true);
            if (redirectMsgDiv) chatWindow.appendChild(redirectMsgDiv);
            setTimeout(() => { window.location.href = 'analysis.html'; }, 2000);
        }
    }

    async function handleUserInteraction(userText, context = {}) { /* (ê¸°ì¡´ê³¼ ë™ì¼, ë‚´ìš© ê°„ê²°í™”) */ 
      if (!userText || userText.trim() === "" || analysisRedirectInProgress) return;
      if (!conversationStartTime) conversationStartTime = Date.now();
      disableTalkButton(true, "AI ì‘ë‹µ ëŒ€ê¸° ì¤‘"); 
      topicBox.style.display = 'none';
      loadingIndicatorTalk.style.display = 'block';
      try {
        const gptResponse = await getGptResponse(userText, currentUserId, {userAge:currentUserAge, userDisease:currentUserDisease, ...context});
        let aiReply = gptResponse?.rephrasing || gptResponse?.error || "ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ì´í•´í•˜ëŠ” ë° ì–´ë ¤ì›€ì´ ìˆì—ˆì–´ìš”.";
        let isError = !gptResponse?.rephrasing;
        if (gptResponse?.summary) localStorage.setItem('lozee_lastSummary', (lastSummary = gptResponse.summary));

        setTimeout(async () => {
            loadingIndicatorTalk.style.display = 'none'; 
            const aiBubbleDiv = appendMessage(aiReply, 'ai', isError); 
            if (aiBubbleDiv) { chatWindow.appendChild(aiBubbleDiv); chatWindow.scrollTop = chatWindow.scrollHeight; }
            if (!analysisRedirectInProgress) try { await playTTSFromText(aiReply, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨:", e); }
            if (!analysisRedirectInProgress) { disableTalkButton(false, "AI ì‘ë‹µ ì™„ë£Œ"); resetSilenceTimer(); checkAndRedirectToAnalysis(); }
        }, 1000);
      } catch (error) { 
        loadingIndicatorTalk.style.display = 'none';
        const fallbackMsg = "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.";
        const errorBubble = appendMessage(fallbackMsg, 'ai', true);
        if(errorBubble) chatWindow.appendChild(errorBubble);
        if (!analysisRedirectInProgress) {
            try { await playTTSFromText(fallbackMsg, currentVoiceId); } catch (e) { console.error("TTS ì‹¤íŒ¨ (ì˜¤ë¥˜ ì²˜ë¦¬ ì¤‘):", e); }
            disableTalkButton(false, "AI ì‘ë‹µ ì˜¤ë¥˜"); resetSilenceTimer(); 
        }
      } 
    }

    async function startRecording() {
      if (isRecording || analysisRedirectInProgress) { return; }

      if (currentSegmentCount >= MAX_CONSECUTIVE_SEGMENTS) {
          appendMessage(`ìµœëŒ€ ${MAX_CONSECUTIVE_SEGMENTS}ë²ˆê¹Œì§€ ì—°ì†ìœ¼ë¡œ ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, "ai", true);
          // (TTS for max segments, button reset - ê¸°ì¡´ê³¼ ë™ì¼)
          talkBtn.innerHTML = 'ğŸ¤';
          talkBtn.classList.remove('active', 'recording-in-progress');
          disableTalkButton(false, "ìµœëŒ€ ì—°ì† ë…¹ìŒ ë„ë‹¬");
          currentSegmentCount = 0; 
          isRecording = false; 
          return;
      }

      currentSegmentCount++;
      console.log(`[startRecording] Segment ${currentSegmentCount}/${MAX_CONSECUTIVE_SEGMENTS} ì‹œì‘ (ìµœëŒ€ ${MAX_RECORDING_DURATION_MS/1000}ì´ˆ)`);
      
      topicBox.style.display = 'none';
      waitingOverlay.style.display = 'none'; 
      try {
        // ì´ì „ ìŠ¤íŠ¸ë¦¼ì´ ìˆë‹¤ë©´ í™•ì‹¤íˆ ì¤‘ì§€
        if (mediaStream) { 
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
            console.log("[startRecording] ì´ì „ mediaStream ëª…ì‹œì  ì¤‘ì§€.");
        }
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true }); // ìƒˆ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
        
        isRecording = true; 
        isEligibleToContinue = false; 
        userClickedToContinue = false; 

        talkBtn.classList.remove('active'); 
        talkBtn.classList.add('recording-in-progress'); 
        talkBtn.innerHTML = 'â¹ï¸'; 
        disableTalkButton(false, "ë…¹ìŒ ì¤‘"); 
        
        audioChunks = []; 
        const options = { mimeType: 'audio/webm;codecs=opus' };
        mediaRecorder = new MediaRecorder(mediaStream, options); // ìƒˆ ë ˆì½”ë” ì¸ìŠ¤í„´ìŠ¤
        recordingStartTimeValue = performance.now(); 
        
        mediaRecorder.ondataavailable = event => { 
            if (event.data.size > 0) { audioChunks.push(event.data); }
        };

        mediaRecorder.onstop = async () => {
            console.log("[onstop] ë…¹ìŒ ì¤‘ì§€ë¨, ì²˜ë¦¬ ì‹œì‘...");
            isRecording = false; // ì¤‘ìš”: ìƒíƒœë¥¼ ë¨¼ì € ë³€ê²½

            const recordingEndTime = performance.now();
            const durationInMs = recordingEndTime - (recordingStartTimeValue || recordingEndTime); 
            const durationInSeconds = Math.round(durationInMs / 1000);
            console.log(`[onstop] ë…¹ìŒëœ ì˜¤ë””ì˜¤ ê¸¸ì´ (ì¶”ì •): ${durationInSeconds}ì´ˆ, ì„¸ê·¸ë¨¼íŠ¸: ${currentSegmentCount}`);

            // (audioChunks.length === 0 && !userClickedToContinue ë¶€ë¶„ ê¸°ì¡´ê³¼ ë™ì¼)
            if (audioChunks.length === 0 && !userClickedToContinue) { 
                if (!analysisRedirectInProgress) disableTalkButton(false, "ë…¹ìŒ ë°ì´í„° ì—†ìŒ"); 
                if (!userClickedToContinue || currentSegmentCount >= MAX_CONSECUTIVE_SEGMENTS) {
                    currentSegmentCount = 0;
                    talkBtn.innerHTML = 'ğŸ¤';
                    talkBtn.classList.remove('active', 'recording-in-progress');
                }
                resetSilenceTimer(); 
                return; 
            }
            
            const audioBlob = (audioChunks.length > 0) ? new Blob(audioChunks, { type: mediaRecorder.mimeType }) : null;
            audioChunks = [];
            
            if (!analysisRedirectInProgress) disableTalkButton(true, "STT ì²˜ë¦¬ ì¤‘");

            try {
                const userText = audioBlob ? await getSTTFromAudio(audioBlob, durationInSeconds) : "";
                // (Admin command, userText ì²˜ë¦¬ ê¸°ì¡´ê³¼ ë™ì¼)
                if (userText && userText.trim() !== "") {
                    appendMessage(userText, 'user'); 
                    const isFirst = onboardingComplete && !localStorage.getItem('lozee_first_voice_interaction_done');
                    await handleUserInteraction(userText, isFirst ? { initialUserMessage: userText, initialUserEmotions: selectedEmotions, isFirstChatAfterOnboarding: true } : {});
                    if (isFirst) { localStorage.setItem('lozee_first_voice_interaction_done', 'true'); localStorage.removeItem('lozee_selected_emotions'); }
                } else if (!userClickedToContinue && audioBlob) { 
                    appendMessage("ì£„ì†¡í•´ìš”, ì˜ ì•Œì•„ë“£ì§€ ëª»í–ˆì–´ìš”.", 'ai', true);
                }
            } catch (sttError) {
                console.error("[onstop] STT ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:", sttError);
                appendMessage("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. (STT API ì˜¤ë¥˜ ê°€ëŠ¥ì„±)", 'ai', true);
            } finally {
                const shouldContinueChain = userClickedToContinue && currentSegmentCount < MAX_CONSECUTIVE_SEGMENTS;
                userClickedToContinue = false; 

                if (shouldContinueChain) {
                    console.log(`ì—°ì† ë…¹ìŒ ì§„í–‰ ì¤€ë¹„: ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ (${currentSegmentCount + 1}) ì‹œì‘ ì „ ${API_DISCONNECT_DELAY_MS}ms ëŒ€ê¸°`);
                    
                    // ì´ì „ ìŠ¤íŠ¸ë¦¼ê³¼ ë ˆì½”ë” ëª…ì‹œì  í•´ì œ (stopRecordingì—ì„œë„ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œ í•œë²ˆ ë” í™•ì¸)
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                        mediaStream = null;
                    }
                    mediaRecorder = null; // ì´ì „ MediaRecorder ì°¸ì¡° í•´ì œ

                    disableTalkButton(true, "ë‹¤ìŒ ë…¹ìŒ ì¤€ë¹„ ì¤‘..."); // ì§€ì—° ì‹œê°„ ë™ì•ˆ ë²„íŠ¼ ë¹„í™œì„±í™”

                    setTimeout(() => {
                        console.log(`${API_DISCONNECT_DELAY_MS}ms ëŒ€ê¸° ì™„ë£Œ. ë‹¤ìŒ ì„¸ê·¸ë¨¼íŠ¸ ì‹œì‘`);
                        if (!analysisRedirectInProgress) {
                             // startRecording ì „ì— ë²„íŠ¼ í™œì„±í™” ë¶ˆí•„ìš”, startRecording ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
                             startRecording(); 
                        } else {
                            console.log("ë¶„ì„ í˜ì´ì§€ ì´ë™ ì¤‘ì´ë¯€ë¡œ ë‹¤ìŒ ë…¹ìŒ ì‹œì‘ ì•ˆ í•¨.");
                            talkBtn.innerHTML = 'ğŸ¤';
                            talkBtn.classList.remove('active', 'recording-in-progress');
                            currentSegmentCount = 0;
                            disableTalkButton(false, "ë¶„ì„ í˜ì´ì§€ ì´ë™ìœ¼ë¡œ ì¤‘ë‹¨");
                        }
                    }, API_DISCONNECT_DELAY_MS);
                } else {
                    console.log("ë…¹ìŒ ì²´ì¸ ì¢…ë£Œ (STT ì²˜ë¦¬ í›„).");
                    talkBtn.innerHTML = 'ğŸ¤';
                    talkBtn.classList.remove('active', 'recording-in-progress');
                    if (!analysisRedirectInProgress) disableTalkButton(false, "STT ì™„ë£Œ/ì˜¤ë¥˜/ì—°ì† ì¢…ë£Œ");
                    currentSegmentCount = 0; 
                    resetSilenceTimer();
                }
            }
        };

        mediaRecorder.start(); 
        // (Timers for autoStop and continuePrompt - ê¸°ì¡´ê³¼ ë™ì¼)
        clearTimeout(autoStopTimer);
        autoStopTimer = setTimeout(() => {
            if (isRecording && mediaRecorder.state === "recording") {
                userClickedToContinue = false; stopRecording(); 
            }
        }, MAX_RECORDING_DURATION_MS);

        clearTimeout(continuePromptTimer);
        continuePromptTimer = setTimeout(() => {
            if (isRecording) {
                isEligibleToContinue = true;
                talkBtn.classList.remove('recording-in-progress'); 
                talkBtn.classList.add('active'); 
            }
        }, CONTINUE_THRESHOLD_MS);
        
        resetSilenceTimer();

      } catch (error) { /* (ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ì™€ ë™ì¼) */ 
        console.error("[startRecording] ë…¹ìŒ ì‹œì‘ ì¤‘ ì˜ˆì™¸:", error);
        appendMessage("ë§ˆì´í¬ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", 'ai', true);
        isRecording = false; 
        talkBtn.innerHTML = 'ğŸ¤';
        talkBtn.classList.remove('active', 'recording-in-progress');
        if (!analysisRedirectInProgress) disableTalkButton(false, "ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜");
        currentSegmentCount = 0; 
      }
    }

    function stopRecording() {
        console.log(`[stopRecording] í˜¸ì¶œë¨. userClickedToContinue: ${userClickedToContinue}, currentSegment: ${currentSegmentCount}, mediaState: ${mediaRecorder?.state}`);
        
        clearTimeout(autoStopTimer); autoStopTimer = null;
        clearTimeout(continuePromptTimer); continuePromptTimer = null;
        
        isEligibleToContinue = false; 

        if (mediaRecorder && mediaRecorder.state === "recording") { 
            mediaRecorder.stop(); // onstop ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ íŠ¸ë¦¬ê±°
        } else { // ì´ë¯¸ ì¤‘ì§€ë˜ì—ˆê±°ë‚˜, ë ˆì½”ë”ê°€ ì—†ëŠ” ê²½ìš°
            isRecording = false; // ìƒíƒœ í™•ì‹¤íˆ ì—…ë°ì´íŠ¸
            // ë²„íŠ¼ ìƒíƒœ ë° currentSegmentCountëŠ” onstop ë˜ëŠ” ë‹¤ìŒ startRecordingì—ì„œ ì²˜ë¦¬ë˜ë„ë¡ í•¨
            // ë¶ˆí•„ìš”í•œ UI ì—…ë°ì´íŠ¸ ìµœì†Œí™”
        }
        // mediaStream í•´ì œëŠ” startRecording ë˜ëŠ” onstopì˜ ì—°ì† ë…¹ìŒ ë¡œì§ì—ì„œ ì²˜ë¦¬
    }

    talkBtn.addEventListener('click', async () => { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ 
      if (analysisRedirectInProgress) { return; }
      waitingOverlay.style.display = 'none'; 
      if (!firstInteractionDone && !onboardingComplete && initialGreetingText) { /* ì´ˆê¸° ì¸ì‚¬ TTS */ return; }

      if (!isRecording) {
        currentSegmentCount = 0; 
        userClickedToContinue = false;
        isEligibleToContinue = false;
        startRecording();
      } else { 
        userClickedToContinue = isEligibleToContinue && currentSegmentCount < MAX_CONSECUTIVE_SEGMENTS;
        if(userClickedToContinue) console.log("[talkBtn Click] ì—°ì† ë…¹ìŒ ìš”ì²­ (íŒŒë€ ë²„íŠ¼ í´ë¦­ë¨)");
        else console.log("[talkBtn Click] ì¼ë°˜ ë…¹ìŒ ì¤‘ì§€ ìš”ì²­");
        stopRecording(); 
      }
    });
    
    waitingOverlay.addEventListener('click', () => { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ });

    async function initializeChat() { /* (ê¸°ì¡´ê³¼ ë™ì¼, ë‚´ìš© ê°„ê²°í™”) */ 
      talkBtn.innerHTML = 'ğŸ¤';
      talkBtn.classList.remove('active', 'recording-in-progress');
      disableTalkButton(true, "ì´ˆê¸°í™” ì¤‘");
      if (!currentUserId || !currentVoiceId) { /* ì‚¬ìš©ì ì •ë³´ ì—†ìŒ ì²˜ë¦¬ */ return; }
      try {
        if (onboardingComplete && userTypedIntro) { /* ì˜¨ë³´ë”© ì™„ë£Œ ë° ì²«ë§ˆë”” ì…ë ¥ë¨ */ } 
        else if (onboardingComplete && !userTypedIntro) { /* ì˜¨ë³´ë”© ì™„ë£Œ, ì²« ìŒì„± ì…ë ¥ ëŒ€ê¸° */ } 
        else { /* ì¼ë°˜ ì‹œì‘ ë˜ëŠ” URL í† í”½ */ }
        if (!hasVisited) localStorage.setItem('lozee_hasVisited', 'true'); 
      } catch (error) { /* ì´ˆê¸°í™” ì˜¤ë¥˜ ì²˜ë¦¬ */ } 
      finally {
        console.log("ì±„íŒ… ì´ˆê¸°í™” ì™„ë£Œ.");
        if (!analysisRedirectInProgress) resetSilenceTimer(); 
      }
    }
    initializeChat();
  </script>
</body>
</html>
