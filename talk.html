<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
<style>
  :root {
      --primary-color: #6e8efb;
      --secondary-color: #5a7edf;
      --background-color: #ffffff;
      --text-color: #333333;
      
      --gnb-bg: #6878E9; /* GNB ë°°ê²½ìƒ‰ ë³€ê²½ */
      --gnb-text-color: #ffffff;
      --gnb-title-color: #ffffff; /* GNB íƒ€ì´í‹€ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
      --gnb-menu-toggle-color: #ffffff; /* í–„ë²„ê±° ë©”ë‰´ ì•„ì´ì½˜ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
      --gnb-dropdown-bg: var(--gnb-bg);
      --gnb-dropdown-text-color: var(--gnb-text-color);
      --gnb-dropdown-border-color: #4a5568;
      --gnb-dropdown-hover-bg: var(--secondary-color);

      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --assistant-bubble-bg: #F5E7A1; /* ë¡œì§€ ë§í’ì„  ë°°ê²½ìƒ‰ ë³€ê²½ */
      --assistant-bubble-text: #333333;

      --input-area-bg: #f8f9fa;
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef;
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px;
      --meter-top-margin: 8px;

      --analysis-notification-bg: #fff3cd;
      --analysis-notification-text: #856404;

      --gnb-height: 56px;
      --chat-input-area-height: 70px;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    #gnb {
      padding: 0 30px; 
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--gnb-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gnb-title-color);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gnb-menu-toggle-color);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--gnb-dropdown-bg);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.2);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 300px;
    }

    #dropdown-menu a {
      display: block;
      padding: 12px 16px;
      text-decoration: none;
      color: var(--gnb-dropdown-text-color);
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
      font-size: 0.95em;
    }
    #dropdown-menu a:last-child {
      border-bottom: none;
    }
    #dropdown-menu a:hover {
      background-color: var(--gnb-dropdown-hover-bg);
    }

    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px;
      transition: width 0.05s linear, background-color 0.05s linear;
    }
    
    #chat-window {
      flex: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
      padding-bottom: calc(var(--chat-input-area-height) + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant { /* 'ai'ì—ì„œ 'assistant'ë¡œ í´ë˜ìŠ¤ëª… ë³€ê²½ ëŒ€ì‘ */
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.assistant_feedback { /* í”¼ë“œë°± ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (assistantì™€ ë™ì¼í•˜ê²Œ í•˜ê±°ë‚˜ ë‹¤ë¥´ê²Œ ì§€ì •) */
      background: #e9ecef; /* ì˜ˆì‹œ: ì•½ê°„ ë‹¤ë¥¸ íšŒìƒ‰í†¤ */
      color: #495057;
      align-self: center; /* ì¤‘ì•™ ë˜ëŠ” ì™¼ìª½ ì •ë ¬ ì„ íƒ */
      font-size: 0.9em;
      border-radius: 8px;
    }
    .bubble.thinking { /* ìƒê°ì¤‘ì´ì•¼... ë§í’ì„  ìŠ¤íƒ€ì¼ */
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-style: italic;
      opacity: 0.8;
    }


    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    #topic-area {
      display: none !important; 
    }

    #input-area {
      padding: 0 30px; 
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; 
      align-items: center;
      gap: 8px;
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px;
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px;
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn {
      width: 44px;
      min-width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording {
      background: #e74c3c;
    }
    #send-btn.loading {
        background:#cccccc;
        cursor:default;
    }
    
    @media (max-width: 600px) {
      #gnb { padding: 0 20px; } 
      #input-area { padding: 0 20px; } 
      #gnb-title { font-size: 1.1em; }
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
    }

    .chat-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
      align-items: flex-start;
      max-width: 80%;
      align-self: flex-start;
    }

    .chat-option-btn {
      background-color: #f1f1f1;
      color: #333333;
      border: 1px solid #dcdcdc;;
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .chat-option-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-1px);
    }
    .chat-option-btn.selected {
      background-color: #E4D2FD;
      color: #333;
      border-color: #c3b2e0; 
      font-weight: bold;
    }
    .chat-option-btn:disabled {
      background-color: #f8f8f8;
      color: #aaaaaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">â˜°</button>
    <div id="dropdown-menu">
      <a href="mypage.html">My Page</a>
      <a href="index.html">ì£¼ì œ ë³€ê²½</a>
      <a href="analysis.html">ëŒ€í™” ë¶„ì„</a>
      <a href="journal-list.html">ëŒ€í™” ëª©ë¡</a>
    </div>
  </nav>
  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-window"></div>
  <div id="input-area">
    <button id="mic-button">ğŸ¤</button>
    <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
    <button id="send-btn">â¤</button>
  </div>

  <script type="module">
    import './js/firebase-config.js';
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
    import LOZEE_ANALYSIS from './js/lozee-analysis.js';
    import { saveSessionLog } from './js/firebase-utils.js';
    import { counselingTopicsByAge } from './js/counseling_topics.js';

    // ìƒíƒœ
    let skipTTS = false;
    let hasGreeted = false;
    let isProcessing = false;
    let chatHistory = [];
    let selectedMain = null;
    let meta = { lastInputTimestamp: Date.now(), fillerCount: 0, clickedOption: false, presentedIndices:[] };
    let isPlayingTTS = false; 

    // UI ìš”ì†Œ
    const chatWindow = document.getElementById('chat-window');
    const topicArea = document.getElementById('topic-area'); 
    const inputArea = document.getElementById('input-area');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const micButton = document.getElementById('mic-button');
    const menuToggle = document.getElementById('menu-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const meterLevel = document.getElementById('volume-level');

    // GNB ë©”ë‰´ í† ê¸€
    menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
    document.addEventListener('click', e => {
      if (!document.getElementById('gnb').contains(e.target)) {
        dropdownMenu.classList.remove('show');
      }
    });

    // ì‚¬ìš©ì ì •ë³´
    const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10);
    const voc = getKoreanVocativeParticle(userName);

    // ì´ˆê¸°í™” ë¡œì§
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âœ… js/firebase-config.js ëª¨ë“ˆ ë¡œë“œë¨');
      console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');

      const greeting = getInitialGreeting(userName + voc, hasGreeted);
      appendMessage(greeting, 'assistant'); // CSS í´ë˜ìŠ¤ëª… ì¼ì¹˜ ìœ„í•´ 'assistant' ì‚¬ìš©
      
      try {
        // ì²« TTSëŠ” ì‚¬ìš©ì ì¸í„°ë™ì…˜ ìœ ë„ ë˜ëŠ” ë²„íŠ¼ í´ë¦­ í›„ ì¬ìƒ ê¶Œì¥
        // ì—¬ê¸°ì„œëŠ” ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë¡œì§ ì§„í–‰ë˜ë„ë¡ í•¨
        // await playTTSWithControl(greeting); // ì£¼ì„ ì²˜ë¦¬ - ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„ ì¬ìƒí•˜ë„ë¡ ë³€ê²½ ê³ ë ¤
        console.log("ì²« TTSëŠ” ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„ ì¬ìƒë˜ë„ë¡ ë¡œì§ ë³€ê²½ì„ ê³ ë ¤í•˜ì„¸ìš”.");
      } catch (error) {
        console.warn("ì²« TTS ìë™ ì¬ìƒ ì‹œë„ ì¤‘ ì˜¤ë¥˜(ë¬´ì‹œ ê°€ëŠ¥):", error);
      }
      
      hasGreeted = true;
      showMainTopics();
    });

    // ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜
    function appendMessage(text, role) {
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + role; // CSS í´ë˜ìŠ¤ëª… (.bubble.user, .bubble.assistant ë“±)
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showAnalysis() {
      const notification = document.createElement('div');
      notification.className = 'analysis-notification';
      notification.textContent = 'ğŸŸ¡ë¶„ì„ ì™„ë£Œ';
      notification.onclick = () => location.href = 'analysis.html';
      chatWindow.appendChild(notification);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // TTS ì œì–´ ì¬ìƒ í•¨ìˆ˜
    async function playTTSWithControl(txt) {
      stopCurrentTTS();
      if (skipTTS) {
        skipTTS = false;
        return Promise.resolve(); 
      }
      isPlayingTTS = true;
      try {
        await playTTSFromText(txt, localStorage.getItem('lozee_voice'));
      } catch (error) {
        console.error("playTTSWithControl ë‚´ TTS ì¬ìƒ ì˜¤ë¥˜:", error);
      } finally {
        isPlayingTTS = false;
      }
    }

    // ì˜¤ë””ì˜¤ ë¶„ì„ ê´€ë ¨
    let audioContext, analyser, source, dataArray, animId, streamRef;
    const LOW = { r:0, g:200, b:0 };
    const MID = { r:255, g:200, b:0 };
    const HIGH = { r:255, g:69, b:0 };

    function interp(c1, c2, f) { /* ... ê¸°ì¡´ ì½”ë“œ ... */ return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;}

    function setupAudioAnalysis(stream) { /* ... ê¸°ì¡´ ì½”ë“œ ... */ if (audioContext) audioContext.close(); audioContext = new AudioContext(); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; source = audioContext.createMediaStreamSource(stream); source.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); streamRef = stream; draw(); }

    function draw() { /* ... ê¸°ì¡´ ì½”ë“œ ... */ animId = requestAnimationFrame(draw); if (!analyser || !dataArray) return; analyser.getByteFrequencyData(dataArray); let sum = dataArray.reduce((a, v) => a + v, 0); let avg = sum / dataArray.length; let norm = Math.min(100, Math.max(0, (avg / 140) * 100)); meterLevel.style.width = norm + '%'; let col = norm <= 50 ? interp(LOW, MID, norm / 50) : interp(MID, HIGH, (norm - 50) / 50); meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${col})`; if (norm > 10 && isRec && isPlayingTTS && !skipTTS) { console.log("ì‚¬ìš©ì ìŒì„± ê°ì§€, TTS ì¤‘ë‹¨ ì‹œë„"); stopCurrentTTS(); skipTTS = true; } }

    function stopAudio() { /* ... ê¸°ì¡´ ì½”ë“œ ... */ if (animId) cancelAnimationFrame(animId); if (source) source.disconnect(); if (streamRef) streamRef.getTracks().forEach(track => track.stop()); if (audioContext && audioContext.state !== 'closed') { audioContext.close(); } audioContext = null; meterLevel.style.width = '0%'; meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-container-bg'); }

    // STT (Web Speech API)
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recog, isRec = false;

    if (SpeechRecognitionAPI) {
      recog = new SpeechRecognitionAPI(); /* ... ê¸°ì¡´ STT ì„¤ì • ... */
      recog.continuous = true; 
      recog.interimResults = false; 
      recog.lang = 'ko-KR';

      recog.onstart = () => { isRec = true; micButton.classList.add('recording'); };
      recog.onend = () => { isRec = false; micButton.classList.remove('recording'); stopAudio(); };
      recog.onresult = event => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) { transcript += event.results[i][0].transcript; }
        }
        if (transcript) {
          console.log("STT ê²°ê³¼:", transcript);
          sendMessage(transcript, 'stt'); // ì…ë ¥ ë°©ì‹ 'stt' ì „ë‹¬
        }
      };
      recog.onerror = event => { console.error('Speech recognition error:', event.error); appendMessage('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error, 'assistant_feedback'); isRec = false; micButton.classList.remove('recording'); stopAudio(); };

      micButton.onclick = async () => {
        if (isRec) {
          recog.stop();
        } else {
          stopCurrentTTS(); 
          skipTTS = true;   
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupAudioAnalysis(stream); 
            recog.start();
          } catch (e) {
            console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', e);
            appendMessage('ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'assistant_feedback');
          }
        }
      };
    } else { /* ... ìŒì„±ì¸ì‹ ë¯¸ì§€ì› ì²˜ë¦¬ ... */ micButton.disabled = true; appendMessage('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'assistant_feedback'); }

    // í† í”½ í”Œë¡œìš° - ì„ íƒì°½
    function displayOptionsInChat(optionsArray, onSelectCallback, context = null) { /* ... ì´ì „ ë‹µë³€ì˜ ìˆ˜ì •ëœ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ... */ console.log("displayOptionsInChat í•¨ìˆ˜ ì‹œì‘ë¨, ì˜µì…˜ ë°°ì—´:", optionsArray); const optionsContainer = document.createElement('div'); optionsContainer.className = 'chat-options-container'; const buttons = []; optionsArray.forEach(optionObject => { let buttonText; let displayTextForCallback; if (typeof optionObject === 'string') { buttonText = optionObject; displayTextForCallback = optionObject; console.log("ì˜µì…˜ ë²„íŠ¼ ìƒì„± ì¤‘ (ë¬¸ìì—´):", optionObject); } else if (optionObject && typeof optionObject.displayText !== 'undefined') { buttonText = optionObject.icon ? `${optionObject.icon} ${optionObject.displayText}` : optionObject.displayText; displayTextForCallback = optionObject.displayText; console.log("ì˜µì…˜ ë²„íŠ¼ ìƒì„± ì¤‘ (ê°ì²´):", optionObject.displayText); } else { console.warn("displayOptionsInChat: ì˜ëª»ëœ í˜•ì‹ì˜ ì˜µì…˜ì…ë‹ˆë‹¤.", optionObject); return; } const button = document.createElement('button'); button.className = 'chat-option-btn'; button.textContent = buttonText; button.onclick = () => { buttons.forEach(btn => { btn.disabled = true; if (btn === button) { btn.classList.add('selected'); } }); onSelectCallback(displayTextForCallback, context); }; optionsContainer.appendChild(button); buttons.push(button); }); chatWindow.appendChild(optionsContainer); console.log("ì˜µì…˜ ì»¨í…Œì´ë„ˆê°€ chatWindowì— ì¶”ê°€ë¨"); chatWindow.scrollTop = chatWindow.scrollHeight; }

    // í† í”½ í”Œë¡œìš° - ì£¼ì œ
    function showMainTopics() { /* ... ì´ì „ ë‹µë³€ì˜ ìˆ˜ì •ëœ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ... */ console.log("showMainTopics í•¨ìˆ˜ ì‹œì‘ë¨"); appendMessage('ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³¼ê¹Œ?', 'assistant'); const currentAgeGroup = getAgeGroup(); const ageGroupData = counselingTopicsByAge[currentAgeGroup]; let topicsWithOptions = []; if (ageGroupData) { topicsWithOptions = Object.keys(ageGroupData).map(categoryName => { let icon = 'ğŸ’¬'; if (ageGroupData[categoryName] && ageGroupData[categoryName].length > 0 && ageGroupData[categoryName][0].icon) { icon = ageGroupData[categoryName][0].icon; } return { icon: icon, displayText: categoryName }; }); } else { console.warn(`counselingTopicsByAgeì— '${currentAgeGroup}'ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`); } topicsWithOptions.push({ icon: 'ğŸ—£ï¸', displayText: 'ììœ ì£¼ì œ' }); console.log("displayOptionsInChatì— ì „ë‹¬ë  ë°°ì—´:", topicsWithOptions); displayOptionsInChat(topicsWithOptions, (selectedTopicText) => { selectedMain = selectedTopicText; appendMessage(selectedMain + ' ì´ì•¼ê¸°ë¥¼ ì„ íƒí–ˆêµ¬ë‚˜!', 'assistant'); setTimeout(showSubTopics, 300); }); if (topicArea) topicArea.style.display = 'none !important'; }
   
    function showSubTopics() { /* ... ì´ì „ ë‹µë³€ì˜ ìˆ˜ì •ëœ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ... */ if (!selectedMain) { console.warn("showSubTopics í˜¸ì¶œë˜ì—ˆìœ¼ë‚˜, selectedMainì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return;  } console.log("showSubTopics í•¨ìˆ˜ ì‹œì‘ë¨, ì„ íƒëœ ë©”ì¸ ì£¼ì œ:", selectedMain); appendMessage('ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì´ì•¼ê¸°í•´ ì¤„ë˜?', 'assistant'); let subtopicOptions; if (selectedMain === 'ììœ ì£¼ì œ') { subtopicOptions = [{ icon: 'ğŸ—£ï¸', displayText: 'ì‘, ììœ ë¡­ê²Œ ì´ì•¼ê¸° ì‹œì‘í•´ì¤˜!' }]; } else { const ageGroupData = counselingTopicsByAge[getAgeGroup()]; const mainTopicData = ageGroupData ? ageGroupData[selectedMain] : undefined; if (mainTopicData && Array.isArray(mainTopicData)) { subtopicOptions = mainTopicData;  } else { console.warn(`'${selectedMain}'ì— ëŒ€í•œ í•˜ìœ„ ì£¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.`); subtopicOptions = [{ icon: 'ğŸ’¬', displayText: 'ëŒ€í™”ë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ëì–´.' }]; } if (!subtopicOptions.length) {  subtopicOptions = [{ icon: 'â–¶ï¸', displayText: 'ë°”ë¡œ ëŒ€í™” ì‹œì‘í• ê¹Œ?' }]; } } console.log("displayOptionsInChatì— ì „ë‹¬ë  í•˜ìœ„ ì£¼ì œ ë°°ì—´ (ìˆ˜ì • í›„):", subtopicOptions); displayOptionsInChat(subtopicOptions, (selectedSubtopicText) => { startChat(selectedSubtopicText); }); if (topicArea) topicArea.style.display = 'none !important'; }

    function startChat(initText) { /* ... ì´ì „ ë‹µë³€ì˜ ìˆ˜ì •ëœ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ... */ console.log("startChat í•¨ìˆ˜ ì‹œì‘ë¨, ì´ˆê¸° ë©”ì‹œì§€:", initText); if (topicArea) topicArea.style.display = 'none !important'; inputArea.style.display = 'flex'; sendMessage(initText, 'text'); } // ì´ˆê¸° ì±„íŒ… ì‹œì‘ì€ 'text' ë°©ì‹ìœ¼ë¡œ ê°„ì£¼  

    function getAgeGroup() { /* ... ì´ì „ ë‹µë³€ì˜ ìˆ˜ì •ëœ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ... */ if (userAge <= 10) return '7-10'; if (userAge <= 15) return '11-15'; return '30+'; }  

    // Stuck Detection
    function detectStuck(txt, his, meta) { /* ... ê¸°ì¡´ ì½”ë“œ ... */ const now = Date.now(); if (meta.lastInputTimestamp && (now - meta.lastInputTimestamp) > 300000) return true; if (meta.fillerCount >= 3) return true; const recentUserMessages = his.filter(m => m.role === 'user').slice(-5); if (recentUserMessages.length === 5 && recentUserMessages.every(m => m.content.trim().length < 5)) return true; if (meta.clickedOption) return false; return false; }
    
    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
    async function sendMessage(text, inputMethod = 'text') { // inputMethod íŒŒë¼ë¯¸í„° ì¶”ê°€
      if (!text || String(text).trim() === '' || isProcessing) return;
      isProcessing = true;
      sendBtn.classList.add('loading');

      appendMessage(text, 'user');
      chatHistory.push({ role: 'user', content: text });
      chatInput.value = '';

      // "ìƒê°ì¤‘ì´ì•¼..." ì„ì‹œ ë§í’ì„  ì¶”ê°€
      const thinkingBubble = document.createElement('div');
      thinkingBubble.className = 'bubble assistant thinking'; // 'thinking' í´ë˜ìŠ¤ ì¶”ê°€
      thinkingBubble.textContent = 'ìƒê°ì¤‘ì´ì•¼...'; // ë˜ëŠ” ë¡œë”© ìŠ¤í”¼ë„ˆ ì•„ì´ì½˜ ì‚¬ìš© ê°€ëŠ¥
      chatWindow.appendChild(thinkingBubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const res = await getGptResponse(text, { chatHistory }); 
        
        thinkingBubble.remove(); // ì‹¤ì œ ì‘ë‹µ ë°›ìœ¼ë©´ ì„ì‹œ ë§í’ì„  ì œê±°

        if (!res.ok) {
            const errorData = await res.text();
            console.error(`GPT API ì‘ë‹µ ì˜¤ë¥˜ ${res.status}: ${errorData}`);
            appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. (ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜)", "assistant_feedback");
            return; 
        }
        const d = await res.json();
        const cut = d.text.indexOf('{'); 
        const clean = cut >= 0 ? d.text.slice(0, cut).trim() : d.text.trim();
        
        appendMessage(clean, 'assistant'); // ì‹¤ì œ AI ì‘ë‹µ ë§í’ì„  ì¶”ê°€

        // ì…ë ¥ ë°©ì‹ì— ë”°ë¼ TTS ì¬ìƒ ì—¬ë¶€ ê²°ì •
        if (inputMethod === 'stt' || (inputMethod === 'text' && !skipTTS) ) { // í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œì—ë„ skipTTSê°€ falseë©´ ì¬ìƒ
            await playTTSWithControl(clean);
        }
        if (skipTTS) skipTTS = false; // skipTTS ì‚¬ìš© í›„ ë¦¬ì…‹
        
        chatHistory.push({ role: 'assistant', content: clean });
        await saveSessionLog(text, clean, d.analysis || {}); 

        if (d.analysis) {
          // LOZEE_ANALYSIS.trackEmotionTone(d.analysis); 
          // LOZEE_ANALYSIS.trackSituation(d.analysis); 
          const userMessagesCount = chatHistory.filter(m => m.role === 'user').length;
          if (userMessagesCount >= 3) { // ì˜ˆì‹œ: ì‚¬ìš©ì ë©”ì‹œì§€ 3ê°œ ì´ìƒì¼ ë•Œ ë¶„ì„
            if (LOZEE_ANALYSIS && LOZEE_ANALYSIS.inferAgeAndLanguage) { 
               await LOZEE_ANALYSIS.inferAgeAndLanguage(chatHistory.map(m=>m.role+':'+m.content).join('\n'));
            }
            showAnalysis(); 
          }
        }
      } catch (error) {
        if(thinkingBubble) thinkingBubble.remove(); // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì„ì‹œ ë§í’ì„  ì œê±°
        console.error("sendMessage ë‚´ ì˜¤ë¥˜:", error);
        appendMessage("ë¯¸ì•ˆ, ì§€ê¸ˆì€ ë‹µë³€í•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ì›Œ. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?", "assistant_feedback");
      } finally {
        isProcessing = false;
        sendBtn.classList.remove('loading');
      }
    }   

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    sendBtn.addEventListener('click', () => sendMessage(chatInput.value, 'text')); // 'text' ì…ë ¥ ë°©ì‹ ì „ë‹¬
    chatInput.addEventListener('keydown', e => {
      meta.lastInputTimestamp = Date.now();
      // ... (fillers ë¡œì§) ...
      meta.clickedOption = false;
      
      // ì‚¬ìš©ìê°€ íƒ€ì´í•‘ ì‹œì‘í•˜ë©´ í˜„ì¬ TTS ì¤‘ì§€í•˜ê³  ë‹¤ìŒ AI ì‘ë‹µ TTSë„ ê±´ë„ˆë›¸ ì¤€ë¹„
      if (isPlayingTTS) { // TTSê°€ ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ ì¤‘ì§€/ìŠ¤í‚µ ì²˜ë¦¬
        stopCurrentTTS();
        skipTTS = true;
      }
      
      if (e.key === 'Enter' && !e.isComposing) { 
        e.preventDefault(); 
        sendMessage(chatInput.value, 'text'); // 'text' ì…ë ¥ ë°©ì‹ ì „ë‹¬
      }
    });
  </script>
</body>
</html>