<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEE와 대화하기</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* 기본 스타일 */
    :root {
      --primary-color: #6e8efb;
      --secondary-color: #354157;
      --background-color: #2a3340;
      --text-color: #fff;
      --input-background: #f0f0f0;
      --bot-bubble-bg: #f0f0f0;
      --bot-bubble-text: #333;
      --user-bubble-bg: #6e8efb;
      --user-bubble-text: #fff;
      --gnb-height: 56px;
      --chat-input-height: 70px;
      --gemini-purple: #7B68EE;
      --volume-meter-default-bg: var(--primary-color);
      --meter-top-margin: 8px;
      --gnb-dropdown-border-color: #4a5568;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height);
      font-family: 'KoPub World Dotum', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* GNB (햄버거 메뉴) */
    #gnb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--gnb-height);
      background-color: var(--background-color);
      padding: 0 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    #gnb-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--gemini-purple);
    }

    #menu-toggle {
      background: none;
      border: none;
      color: var(--gemini-purple);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dropdown-menu {
      position: fixed;
      top: var(--gnb-height);
      right: 0;
      background-color: var(--background-color);
      border-radius: 0 0 0 8px;
      box-shadow: -3px 3px 6px rgba(0,0,0,0.25);
      width: 200px;
      z-index: 999;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    #dropdown-menu.show {
      max-height: 500px;
    }

    #dropdown-menu a {
      display: block;
      color: var(--text-color);
      text-decoration: none;
      padding: 12px 16px;
      font-size: 0.95em;
      border-bottom: 1px solid var(--gnb-dropdown-border-color);
    }
    #dropdown-menu a:last-child { border-bottom: none; }
    #dropdown-menu a:hover {
      background-color: var(--secondary-color);
    }

    /* 음량 바 */
    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: 6px;
      background-color: var(--secondary-color);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-meter { width:100%; height:100%; }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-default-bg);
      border-radius: 3px;
      transition: width 0.05s linear;
    }

    /* 채팅 영역 */
    #chat-container {
      flex-grow: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + 6px + 16px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: var(--chat-input-height);
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.5;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background-color: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.bot {
      background-color: var(--bot-bubble-bg);
      color: var(--bot-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.user.interim { opacity:.7; }
    .bubble.system-error { /* 오류 메시지 스타일 */
        background-color: #ffdddd;
        color: #d32f2f;
        align-self: center;
        max-width: 80%;
        text-align: center;
        font-size: 0.9em;
        border: 1px solid #d32f2f;
    }


    /* 입력 영역 */
    #chat-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-height);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background-color: var(--secondary-color);
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 22px;
      border: 1px solid var(--gnb-dropdown-border-color);
      font-size: 1em;
      background-color: var(--input-background);
      color: #333;
      height: 44px;
      box-sizing: border-box;
    }
    #chat-input::placeholder { color: #777; }

    #mic-button,
    #send-button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: var(--text-color);
      font-size: 1.3em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    #mic-button:hover,
    #send-button:hover { background-color: #5a7edf; }
    #mic-button.disabled,
    #send-button.disabled {
      opacity:.5;
      cursor:default;
      background-color: #999;
    }
    #send-button.loading { background:#999; cursor:default; }

    /* 스크롤바 스타일 */
    #chat-container::-webkit-scrollbar { width: 8px; }
    #chat-container::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-container::-webkit-scrollbar-thumb { background: var(--gnb-dropdown-border-color); border-radius: 4px; }
    #chat-container::-webkit-scrollbar-thumb:hover { background: #5a7edf; }
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="메뉴 열기/닫기">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (준비중)</a>
      <a href="index.html">주제 변경</a>
      <a href="analysis.html">최근 대화 분석</a>
      <a href="journal-list.html">주제별 대화 목록</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE 소개</a>
    </div>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>

  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" title="음성 인식 시작/중지">🎤</button>
    <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." autocomplete="off"/>
    <button id="send-button" title="메시지 전송">⮞</button>
  </div>

  <script src="./js/gpt-dialog.js"></script>
  <script src="./js/tts.js"></script>

  <script> // type="module" 제거하고 일반 스크립트로 변경
    async function initializeApp() {
      const chatContainer = document.getElementById('chat-container');

      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        if (role === 'system-error') {
            el.classList.add('system-error');
        }
        if (chatContainer) {
            chatContainer.appendChild(el);
            requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
        } else {
            console.error("Chat container not found for appendBubble. Message:", text);
            // Fallback: alert if chatContainer is not available for critical messages
            if (role === 'system-error') {
                alert("오류: " + text);
            }
        }
      }

      if (!chatContainer) {
          console.error("CRITICAL: chatContainer element not found in the DOM. Chat cannot function.");
          document.body.innerHTML = '<div style="color: red; font-size: 20px; text-align: center; padding: 50px; background-color: #fff; border: 2px solid red;">채팅 UI를 초기화할 수 없습니다. HTML 구조를 확인해주세요. (chat-container 누락)</div>';
          return;
      }

      let playTTSFunction;
      let currentDefaultVoice;

      if (window.LOZEE_TTS && window.LOZEE_TTS.playTTSFromText && window.LOZEE_TTS.DEFAULT_VOICE) {
        playTTSFunction = window.LOZEE_TTS.playTTSFromText;
        currentDefaultVoice = window.LOZEE_TTS.DEFAULT_VOICE;
        console.log("tts.js (전역) 로드 성공.");
      } else {
        console.error("tts.js가 올바르게 로드되지 않았거나, LOZEE_TTS 객체에 함수들이 정의되지 않았습니다.");
        playTTSFunction = async (text, voice) => {
          console.warn(`TTS Fallback (음성: ${voice}): ${text}. tts.js 로드 실패.`);
        };
        currentDefaultVoice = 'default-fallback-tts';
        appendBubble("알림: 음성 출력(TTS) 기능을 불러오는 데 문제가 발생했습니다. 텍스트로만 대화가 진행됩니다.", "system-error");
      }

      if (!window.LOZEE_DIALOG || !window.LOZEE_DIALOG.getGptResponse || !window.LOZEE_DIALOG.getFirstQuestion) {
        console.error("gpt-dialog.js가 올바르게 로드되지 않았거나, LOZEE_DIALOG 객체에 함수들이 정의되지 않았습니다.");
        appendBubble("오류: 대화 기능을 초기화할 수 없습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.", "system-error");
        // 대화 기능 핵심 로드 실패 시, 추가 기능 초기화 중단 가능성 고려
        // return; // 여기서 중단하면 음성인식 등 다른 기능도 초기화 안 됨. 일단은 진행.
      }
      // getGptResponse와 getFirstQuestion은 LOZEE_DIALOG가 로드되지 않았더라도
      // 오류 메시지를 표시한 후, 아래에서 사용 시 undefined 에러를 방지하기 위해
      // 안전한 기본값(폴백 함수)을 할당할 수 있습니다.
      const getGptResponse = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.getGptResponse) || (async (text) => {
          console.error("getGptResponse is not available.");
          appendBubble("오류: 메시지 전송 기능을 사용할 수 없습니다.", "system-error");
          return { json: async () => ({ text: "오류: 응답을 받을 수 없습니다."}) };
      });
      const getFirstQuestion = (window.LOZEE_DIALOG && window.LOZEE_DIALOG.getFirstQuestion) || ((userAge, topic) => {
          console.error("getFirstQuestion is not available.");
          appendBubble("오류: 초기 대화 질문을 생성할 수 없습니다.", "system-error");
          return "오류: 대화를 시작할 수 없습니다.";
      });


      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');
      const menuToggle    = document.getElementById('menu-toggle');
      const dropdownMenu  = document.getElementById('dropdown-menu');
      const gnb           = document.getElementById('gnb');

      let audioContext;
      let analyser;
      let microphoneSource;
      let dataArray;
      let volumeMeterAnimationId;
      let analyserStream;

      const LOW_COLOR = { r: 0, g: 200, b: 0 };
      const MID_COLOR = { r: 255, g: 200, b: 0 };
      const HIGH_COLOR = { r: 255, g: 69, b: 0 };

      function interpolateColor(color1, color2, factor) {
        const r = Math.round(color1.r + factor * (color2.r - color1.r));
        const g = Math.round(color1.g + factor * (color2.g - color1.g));
        const b = Math.round(color1.b + factor * (color2.b - color1.b));
        return `rgb(${r},${g},${b})`;
      }

      function setupAudioAnalysis(stream) {
        if (audioContext && audioContext.state !== 'closed') {
          audioContext.close();
        }
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.3;
        microphoneSource = audioContext.createMediaStreamSource(stream);
        microphoneSource.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyserStream = stream;
        drawVolumeMeter();
      }

      function drawVolumeMeter() {
        volumeMeterAnimationId = requestAnimationFrame(drawVolumeMeter);
        if (!analyser || !dataArray || !meterLevel) return;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
        let averageVolume = dataArray.length > 0 ? sum / dataArray.length : 0;
        let normalizedVolume = (averageVolume / 140) * 100;
        normalizedVolume = Math.min(100, Math.max(0, normalizedVolume));
        meterLevel.style.width = normalizedVolume + '%';
        let activeColor;
        if (normalizedVolume <= 50) {
          activeColor = interpolateColor(LOW_COLOR, MID_COLOR, normalizedVolume / 50);
        } else {
          activeColor = interpolateColor(MID_COLOR, HIGH_COLOR, (normalizedVolume - 50) / 50);
        }
        const baseGradientColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim() || '#2a3340';
        meterLevel.style.background = `linear-gradient(to right, ${baseGradientColor}, ${activeColor})`;
      }

      function stopAudioAnalysis() {
        if (volumeMeterAnimationId) cancelAnimationFrame(volumeMeterAnimationId);
        volumeMeterAnimationId = null;
        if (microphoneSource) microphoneSource.disconnect();
        microphoneSource = null;
        if (analyserStream?.getTracks) analyserStream.getTracks().forEach(track => track.stop());
        analyserStream = null;
        if (audioContext?.state !== 'closed') audioContext.close().catch(e => console.error("AudioContext close error:", e));
        audioContext = null;
        if (meterLevel) {
          meterLevel.style.width = '0%';
          meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg').trim();
        }
        analyser = null; dataArray = null;
      }

      menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
      document.addEventListener('click', (event) => {
        if (gnb && !gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
          dropdownMenu.classList.remove('show');
        }
      });

      let recognition;
      let isRecognizing = false;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'ko-KR';
        micButton.classList.remove('disabled');
        recognition.onstart = () => {
          isRecognizing = true; micButton.textContent = '💬'; micButton.style.backgroundColor = '#e74c3c'; console.log("🎤 음성 인식 시작");
        };
        recognition.onend = () => {
          isRecognizing = false; micButton.textContent = '🎤'; micButton.style.backgroundColor = 'var(--primary-color)'; console.log("🎤 음성 인식 종료"); setLoading(false); stopAudioAnalysis();
        };
        recognition.onresult = (event) => {
          let interimTranscript = '', finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            event.results[i].isFinal ? finalTranscript += event.results[i][0].transcript : interimTranscript += event.results[i][0].transcript;
          }
          if (interimTranscript) showInterim(interimTranscript);
          if (finalTranscript) { document.querySelector('.bubble.user.interim')?.remove(); handleUserText(finalTranscript); }
        };
        recognition.onerror = (event) => {
          console.error("❌ 음성 인식 오류:", event.error);
          appendBubble(event.error === 'not-allowed' || event.error === 'service-not-allowed' ? "마이크 사용 권한이 필요해요." : "음성 인식 중 오류.", "bot");
          isRecognizing = false; micButton.textContent = '🎤'; micButton.style.backgroundColor = 'var(--primary-color)'; setLoading(false); stopAudioAnalysis();
        };
      } else {
        console.warn("⚠️ 음성 인식 미지원 브라우저"); micButton.title = "음성 인식 미지원"; micButton.disabled = true;
        appendBubble("알림: 사용 중인 브라우저에서는 음성 인식을 지원하지 않습니다.", "system-error");
      }

      micButton.addEventListener('click', async () => {
        if (!SpeechRecognition) return;
        if (isRecognizing) {
          recognition.stop();
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupAudioAnalysis(stream); recognition.start(); setLoading(true);
          } catch (err) {
            console.error("❌ 마이크 권한/시작 오류:", err); appendBubble("마이크 사용 불가. 권한 확인 필요.", "bot"); stopAudioAnalysis();
          }
        }
      });

      const lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || currentDefaultVoice;
      const userAge = localStorage.getItem('lozee_userage');
      const userName = localStorage.getItem('lozee_username') || '친구';
      const userId = localStorage.getItem('lozee_userid') || 'anonymous';
      const userDisease = localStorage.getItem('lozee_disease') || 'ASD';
      const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');
      let chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');
      chatHistory.forEach(msg => appendBubble(msg.content, msg.role));

      if (Object.keys(selectedTopic).length > 0 && chatHistory.length === 0) {
        await initConversation();
      } else if (chatHistory.length === 0) {
        appendBubble("안녕하세요! 먼저 홈에서 대화 주제를 선택해주세요.", "bot");
      }

      function showInterim(text) {
        let el = document.querySelector('.bubble.user.interim');
        if (!el) { el = document.createElement('div'); el.className = 'bubble user interim'; chatContainer.appendChild(el); }
        el.textContent = text; requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
      }
      function setLoading(flag) {
        sendButton.disabled = flag;
        if (SpeechRecognition) micButton.disabled = flag && !isRecognizing; else micButton.disabled = true;
        sendButton.classList.toggle('loading', flag);
      }
      async function initConversation() {
        setLoading(true);
        const prompt = getFirstQuestion(userAge, selectedTopic);
        appendBubble(prompt, 'bot');
        chatHistory.push({ role: 'bot', content: prompt, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        try { await playTTSFunction(prompt, lsSelectedVoice); }
        catch (ttsError) { console.error("TTS 오류 (초기 대화):", ttsError); }
        setLoading(false);
      }
      async function handleUserText(text) {
        if (!text.trim()) return;
        document.querySelector('.bubble.user.interim')?.remove();
        appendBubble(text, 'user');
        chatHistory.push({ role: 'user', content: text, timestamp: new Date().toISOString() });
        setLoading(true);
        try {
          const res = await getGptResponse(text, {
            userId, userAge, userName, userDisease,
            chatHistory: chatHistory.slice(-10), messages: [{ role: "user", content: text }]
          });
          const data = await res.json(); console.log("GPT API 응답:", data);
          const botMessage = data?.rephrasing || data?.text || "응답을 받지 못했어요.";
          appendBubble(botMessage, 'bot');
          const botResponseEntry = { role: 'bot', content: botMessage, timestamp: new Date().toISOString() };
          if (data.analysis) { console.log("💡 분석 데이터:", data.analysis); botResponseEntry.analysis = data.analysis; }
          chatHistory.push(botResponseEntry);
          localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
          await playTTSFunction(botMessage, lsSelectedVoice);
        } catch (err) {
          console.error("❌ 처리 중 오류:", err); appendBubble("죄송해요, 오류 발생.", 'bot');
          chatHistory.push({ role: 'system', content: '봇 응답 실패', error: err.message, timestamp: new Date().toISOString() });
          localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        }
        setLoading(false); chatInput.value = ''; chatInput.focus();
      }
      sendButton.addEventListener('click', () => { const text = chatInput.value.trim(); if (text && !sendButton.disabled) handleUserText(text); });
      chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); const text = chatInput.value.trim(); if (text && !sendButton.disabled) handleUserText(text); } });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeApp, 50); // 약간의 지연 후 initializeApp 호출
    });

  </script>
</body>
</html>
