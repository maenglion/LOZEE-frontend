<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* GNB */
    #gnb { position: fixed; top:0; left:0; width:100%; background:#354157; padding:8px 16px; box-shadow:0 2px 4px rgba(0,0,0,0.1); z-index:1000; display:flex; gap:12px; }
    #gnb a { color:#fff; text-decoration:none; font-size:.95em; }
    body { margin:0; padding-top:40px; font-family:'KoPub World Dotum',sans-serif; background:#2a3340; color:#fff; }
    /* ì±„íŒ… ì˜ì—­ ì±— ë²„ë¸” ìŠ¤íƒ€ì¼ */
    #chat-container { padding:16px; height:calc(100vh - 140px); overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
    .bubble { padding:12px 16px; border-radius:20px; max-width:70%; line-height:1.4; word-break:keep-all; }
    .bubble.user          { background:#6e8efb; align-self:flex-end; color:#fff; }
    .bubble.bot           { background:#f0f0f0; align-self:flex-start; color:#333; }
    .bubble.user.interim  { opacity:.6; }  /* ì¤‘ê°„ ê²°ê³¼ ì „ìš© ìŠ¤íƒ€ì¼ */
    /* ì…ë ¥ ì˜ì—­ */
    #chat-input-container { position:fixed; bottom:0; left:0; width:100%; display:flex; gap:8px; padding:8px; background:#354157; }
    #chat-input  { flex:1; padding:12px; border-radius:20px; border:none; }
    #send-button, #mic-button { width:48px; height:48px; border:none; border-radius:50%; background:#6e8efb; color:#fff; font-size:1.2em; cursor:pointer; }
    #mic-button.disabled { opacity:.5; cursor:default; }
    /* ìŒëŸ‰ ë°” */
    #meter-container { position:fixed; top:40px; left:50%; transform:translateX(-50%); width:60%; height:4px; background:#4a5568; border-radius:2px; overflow:hidden; }
    #volume-meter  { width:100%; height:100%; }
    #volume-level  { width:0%; height:100%; background:#6e8efb; transition:width .1s; }
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ (send ë²„íŠ¼ ëŒ€ì²´) */
    #send-button.loading { background:#999; cursor:default; }
  </style>
</head>
<body>
  <nav id="gnb">
    <a href="index.html">í™ˆ</a>
    <a href="#" id="gnb-topic-change">ì£¼ì œ ë³€ê²½</a>
    <a href="analysis.html">ë¶„ì„ ê²°ê³¼</a>
    <a href="settings.html">ì„¤ì •</a>
  </nav>

  <div id="meter-container">
    <div id="volume-meter">
      <div id="volume-level"></div>
    </div>
  </div>
  <div id="chat-container"></div>

  <div id="chat-input-container">
    <button id="mic-button" class="disabled" title="ìŒì„± ì¸ì‹ ì‹œì‘/ì¤‘ì§€">ğŸ¤</button>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥ ë˜ëŠ” ğŸ¤" autocomplete="off"/>
    <button id="send-button">â®</button>
  </div>

  <script type="module">
    import { playTTSFromText, DEFAULT_VOICE } from './js/tts.js';
    import { getGptResponse, getFirstQuestion } from './js/gpt-dialog.js';

    document.addEventListener('DOMContentLoaded', async () => {
      // DOM ìš”ì†Œ
      const chatContainer = document.getElementById('chat-container');
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');

      // ì‚¬ìš©ì ì •ë³´
      const selectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge       = localStorage.getItem('lozee_userage');
      const userName      = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
      const selectedTopic = JSON.parse(localStorage.getItem('selectedTopic') || '{}');

      // GNB ì£¼ì œ ë³€ê²½
      document.getElementById('gnb-topic-change').onclick = e => {
        e.preventDefault();
        window.location.href = 'index.html';
      };

      // ë§í’ì„  ì¶”ê°€
      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
      function showInterim(text) {
        let el = document.querySelector('.bubble.user.interim');
        if (!el) {
          el = document.createElement('div');
          el.className = 'bubble user interim';
          chatContainer.appendChild(el);
        }
        el.textContent = text;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // ë¡œë”© ìƒíƒœ
      function setLoading(flag) {
        sendButton.disabled = flag;
        micButton.disabled  = flag;
        sendButton.classList.toggle('loading', flag);
      }

      // â”€â”€ ì´ˆê¸° ëŒ€í™” ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function initConversation() {
        // ì¸ë±ìŠ¤ì—ì„œ ë„˜ì–´ì˜¨ ì£¼ì œ(selectedTopic)ì™€ ë‚˜ì´(userAge)ë¥¼ ë°˜ì˜í•œ ì²« ì§ˆë¬¸ ìƒì„±
       const prompt = getFirstQuestion(userAge, selectedTopic);
       appendBubble(prompt, 'bot');
       await playTTSFromText(prompt, selectedVoice);
      }

       // í˜ì´ì§€ ë¡œë“œ ì§í›„ ì´ˆê¸° ëŒ€í™” ì‹œì‘ í˜¸ì¶œ
       document.addEventListener('DOMContentLoaded', () => {
       initConversation();

      // ì‚¬ìš©ì í…ìŠ¤íŠ¸ ì²˜ë¦¬
      async function handleUserText(text) {
        if (!text.trim()) return;
        appendBubble(text, 'user');
        setLoading(true);
        // ì¤‘ê°„ ë²„ë¸” ì‚­ì œ
        document.querySelector('.bubble.user.interim')?.remove();

        try {
          const res = await getGptResponse(text, { userAge, userName, selectedTopic });
          // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
          const reader = res.body.getReader();
          const dec    = new TextDecoder();
          let done = false;
          const botBubble = document.createElement('div');
          botBubble.className = 'bubble bot';
          chatContainer.appendChild(botBubble);

          while (!done) {
            const { value, done: d } = await reader.read();
            done = d;
            botBubble.textContent += dec.decode(value, { stream: true });
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          await playTTSFromText(botBubble.textContent, selectedVoice);
        } catch (err) {
          console.error(err);
          appendBubble('ì£„ì†¡í•©ë‹ˆë‹¤, ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
        } finally {
          setLoading(false);
        }
      }

      // STT + ìŒëŸ‰ ë°” ì„¸íŒ…
      if (navigator.mediaDevices && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          // Audio ë ˆë²¨ë§
          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src      = audioCtx.createMediaStreamSource(stream);
          const analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          src.connect(analyser);

          const data = new Uint8Array(analyser.frequencyBinCount);
          function drawMeter() {
            analyser.getByteTimeDomainData(data);
            let sum = 0;
            for (let v of data) {
              const x = (v/128) - 1;
              sum += x*x;
            }
            const rms = Math.sqrt(sum/data.length);
            meterLevel.style.width = `${Math.min(rms * 200, 100)}%`;
            requestAnimationFrame(drawMeter);
          }
          drawMeter();

          // SpeechRecognition
          const API = window.SpeechRecognition || window.webkitSpeechRecognition;
          const rec = new API();
          rec.lang           = 'ko-KR';
          rec.interimResults = true;
          rec.continuous     = false;

          rec.onstart = () => { micButton.textContent = 'ğŸ”´'; };
          rec.onend   = () => { micButton.textContent = 'ğŸ¤'; };

          rec.onresult = event => {
            let interim = '', finalT = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const { transcript, isFinal } = event.results[i][0];
              if (isFinal) finalT += transcript;
              else interim += transcript;
            }
            if (interim) showInterim(interim);
            else document.querySelector('.bubble.user.interim')?.remove();

            if (finalT) {
              document.querySelector('.bubble.user.interim')?.remove();
              handleUserText(finalT);
            }
          };

          rec.onerror = e => {
            console.error('STT ì˜¤ë¥˜', e.error);
          };

          // ë§ˆì´í¬ ë²„íŠ¼ í™œì„±í™”
          micButton.classList.remove('disabled');
          micButton.onclick = () => {
            if (sendButton.disabled) return;
            if (micButton.textContent === 'ğŸ”´') rec.stop();
            else rec.start();
          };

        } catch {
          appendBubble('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'bot');
        }
      } else {
        appendBubble('ìŒì„± ì¸ì‹ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì˜ˆìš”.', 'bot');
      }

      // Send ë²„íŠ¼ ì´ë²¤íŠ¸
      sendButton.onclick = () => {
        if (sendButton.disabled) return;
        const txt = chatInput.value.trim();
        if (!txt) return;
        chatInput.value = '';
        handleUserText(txt);
      };
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); }
      });

     // â”€â”€ 9. ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     document.addEventListener('DOMContentLoaded', async () => {
     await initConversation();  // í˜ì´ì§€ ë¡œë“œ ì§í›„ ì²« ì§ˆë¬¸
     });
     </script>
</body>
</html>
