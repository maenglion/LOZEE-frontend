<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEEÏôÄ ÎåÄÌôîÌïòÍ∏∞</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> 
<style>
  :root {
      --primary-color: #6e8efb;
      --secondary-color: #5a7edf;
      --background-color: #ffffff;
      --text-color: #333333;
      
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #ffffff;
      --assistant-bubble-bg: #F5E7A1; /* Î°úÏßÄ ÎßêÌíçÏÑ† Î∞∞Í≤ΩÏÉâ */
      --assistant-bubble-text: #333333;

      --input-area-bg: #f8f9fa;
      --chat-input-bg: #ffffff;
      --chat-input-text-color: #333333;
      --chat-input-border-color: #ced4da;
      --chat-input-placeholder-color: #777777;

      --button-bg: var(--primary-color);
      --button-text-color: #ffffff;
      --button-hover-bg: var(--secondary-color);

      --volume-meter-container-bg: #e9ecef;
      --volume-meter-level-bg: var(--primary-color);
      --meter-height: 6px;
      --meter-top-margin: 8px;

      --analysis-notification-bg: #fff3cd;
      --analysis-notification-text: #856404;

      --gnb-height: 56px; 
      --chat-input-area-height: 70px;
    }

    body {
      margin: 0;
      padding-top: var(--gnb-height); 
      font-family: 'KoPub World Dotum', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    #meter-container {
      position: fixed;
      top: calc(var(--gnb-height) + var(--meter-top-margin));
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 300px;
      height: var(--meter-height);
      background: var(--volume-meter-container-bg);
      border-radius: 3px;
      overflow: hidden;
      z-index: 998;
    }
    #volume-level {
      width: 0%;
      height: 100%;
      background: var(--volume-meter-level-bg);
      border-radius: 3px;
      transition: width 0.05s linear, background-color 0.05s linear;
    }
    
    #chat-window {
      flex: 1;
      padding: 16px;
      padding-top: calc(var(--meter-top-margin) + var(--meter-height) + 10px);
      padding-bottom: calc(var(--chat-input-area-height) + 10px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    
    #chat-window::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-track { background: var(--background-color); }
    #chat-window::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    #chat-window::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.6;
      word-break: keep-all;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bubble.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.assistant_feedback { 
      background: #e9ecef; 
      color: #495057;
      align-self: center; 
      font-size: 0.9em;
      border-radius: 8px;
    }
    .bubble.thinking { 
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-style: italic;
      opacity: 0.8;
    }

    .analysis-notification {
      align-self: center;
      background: var(--analysis-notification-bg);
      color: var(--analysis-notification-text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
    }

    #topic-area { 
      display: none !important; 
    }

    #input-area {
      padding: 0 30px; 
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--chat-input-area-height);
      display: none; 
      align-items: center;
      gap: 8px;
      background: var(--input-area-bg);
      border-top: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    #input-area button, #input-area input {
      font-size: 1em;
      height: 44px;
      box-sizing: border-box;
    }

    #chat-input {
      flex: 1;
      min-width: 50px; 
      padding: 10px 16px;
      border: 1px solid var(--chat-input-border-color);
      border-radius: 22px;
      outline: none;
      background-color: var(--chat-input-bg);
      color: var(--chat-input-text-color);
    }
    #chat-input::placeholder {
      color: var(--chat-input-placeholder-color);
    }

    #mic-button, #send-btn {
      width: 44px;
      min-width: 44px; 
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--button-bg);
      color: var(--button-text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      transition: background-color 0.2s ease;
      flex-shrink: 0; 
    }
    #mic-button:hover, #send-btn:hover {
      background: var(--button-hover-bg);
    }
    #mic-button.recording {
      background: #e74c3c;
    }
    #send-btn.loading {
        background:#cccccc;
        cursor:default;
    }
    
    @media (max-width: 600px) {
      #input-area { padding: 0 20px; gap: 5px; } 
      .bubble { padding: 9px 13px; max-width: 85%; }
      #chat-input { padding: 9px 14px; }
      #mic-button, #send-btn { width: 40px; height: 40px; font-size: 1.2em;}
      #input-area { height: 65px; }
      #chat-window { padding-bottom: calc(65px + 10px); }
    }
     @media (max-width: 360px) { 
        #input-area { padding: 0 10px; gap: 5px; }
        #mic-button, #send-btn { width: 38px; height: 38px; font-size: 1.1em; }
        #chat-input { height: 38px; }
    }

    .chat-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
      align-items: flex-start;
      max-width: 80%;
      align-self: flex-start;
    }
    .chat-option-btn {
      background-color: #f1f1f1;
      color: #333333;
      border: 1px solid #dcdcdc;;
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.95em;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .chat-option-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-1px);
    }
    .chat-option-btn.selected {
      background-color: #E4D2FD; 
      color: #333;
      border-color: #c3b2e0; 
      font-weight: bold;
    }
    .chat-option-btn.continue-topic-btn { 
        background-color: #FFDAB9; 
        border-color: #FFA07A;
    }
    .chat-option-btn:disabled {
      background-color: #f8f8f8;
      color: #aaaaaa;
      cursor: not-allowed;
      opacity: 0.7;
    }
</style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">‚ò∞</button>
        <div id="dropdown-menu">
          <a href="mypage.html">üé® ÎÇ¥ Ï†ïÎ≥¥ Î≥¥Í∏∞</a> 
          <a href="index.html">‚ú® ÏÉàÎ°úÏö¥ Ïù¥ÏïºÍ∏∞ ÏãúÏûë!</a> 
          <a href="analysis.html">üìä Ïö∞Î¶¨ Ïù¥ÏïºÍ∏∞ Î∂ÑÏÑù</a> 
          <a href="journal-list.html">üìñ Ïù¥ÏïºÍ∏∞ Î™®ÏùåÏßë</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">‚ùì Î°úÏßÄ ÏÇ¨Ïö© ÏÑ§Î™ÖÏÑú</a> 
        </div>
    </nav>

    <div id="meter-container"><div id="volume-level"></div></div>
    <div id="chat-window"></div>
    <div id="input-area">
        <button id="mic-button">üé§</button>
        <input id="chat-input" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off" />
        <button id="send-btn">‚û§</button>
    </div>

    <script type="module">
        import './js/firebase-config.js';
        import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
        import { playTTSFromText, stopCurrentTTS } from './js/tts.js';
        import LOZEE_ANALYSIS from './js/lozee-analysis.js';
        import { saveSessionLog, updateTopicStats } from './js/firebase-utils.js'; 
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        // --- ÏÉÅÌÉú Î≥ÄÏàò ---
        let skipTTS = false;
        let hasGreeted = false;
        let isProcessing = false;
        let chatHistory = [];
        let selectedMain = null; 
        let meta = { lastInputTimestamp: Date.now(), fillerCount: 0, clickedOption: false, presentedIndices:[] };
        let isPlayingTTS = false; 
        let conversationStartTime = null;
        let analysisNotificationShown = false;
        
        let assistantMessageCount = 0; 
        let gptVerbosityPreference = 'default'; 
        let lastVerbosityPromptTime = 0; 
        let verbosityPromptCount = 0; 
        const PREFERENCE_PROMPT_INTERVAL = 10 * 60 * 1000; // 10Î∂Ñ

        // --- UI ÏöîÏÜå ---
        const chatWindow = document.getElementById('chat-window');
        const topicArea = document.getElementById('topic-area'); // HTMLÏóêÏÑú ÏÇ≠Ï†úÌñàÍ±∞ÎÇò display:none!important; Ï≤òÎ¶¨
        const inputArea = document.getElementById('input-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const micButton = document.getElementById('mic-button');
        const menuToggle = document.getElementById('menu-toggle');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const meterLevel = document.getElementById('volume-level');

        // --- GNB Î©îÎâ¥ ÌÜ†Í∏Ä ---
        if (menuToggle && dropdownMenu) {
            const gnbElement = document.getElementById('gnb');
            menuToggle.addEventListener('click', (event) => {
                event.stopPropagation(); 
                dropdownMenu.classList.toggle('show');
            });
            document.addEventListener('click', (event) => {
                if (gnbElement && !gnbElement.contains(event.target) && event.target !== menuToggle) {
                    dropdownMenu.classList.remove('show');
                }
            });
        }

        // --- ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ---
        const userName = localStorage.getItem('lozee_username') || 'ÏπúÍµ¨';
        const userAge = parseInt(localStorage.getItem('lozee_userage') || '0', 10); 
        const voc = getKoreanVocativeParticle(userName);

        // --- Ï¥àÍ∏∞Ìôî Î°úÏßÅ ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('‚úÖ js/firebase-config.js Î™®Îìà Î°úÎìúÎê®');
            console.log('DOMContentLoaded Ïù¥Î≤§Ìä∏ Î∞úÏÉù');
            conversationStartTime = Date.now(); 
            const greeting = getInitialGreeting(userName + voc, hasGreeted);
            appendMessage(greeting, 'assistant');
            console.log("Ï≤´ Ïù∏ÏÇ¨ TTSÎäî ÏÇ¨Ïö©Ïûê Ïù∏ÌÑ∞ÎûôÏÖò(Ïòà: ÏãúÏûë Î≤ÑÌäº) ÌõÑ Ïû¨ÏÉùÌïòÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§. (ÌòÑÏû¨ ÏûêÎèô Ïû¨ÏÉù Ïïà Ìï®)");
            hasGreeted = true;
            showMainTopics();
        });

        // --- Î©îÏãúÏßÄ Í¥ÄÎ†® Ìï®Ïàò ---
        function appendMessage(text, role) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + role; 
            bubble.textContent = text;
            if(chatWindow) chatWindow.appendChild(bubble); // chatWindow null Ï≤¥ÌÅ¨
            if(chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showAnalysis() {
            if (analysisNotificationShown) return;
            const notification = document.createElement('div');
            notification.className = 'analysis-notification';
            notification.textContent = 'üü°Î∂ÑÏÑù Í≤∞Í≥º Î≥¥Í∏∞'; 
            notification.onclick = () => {
                location.href = 'analysis.html';
            }
            if(chatWindow) chatWindow.appendChild(notification);
            if(chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
            analysisNotificationShown = true; 
        }

        // --- TTS Ï†úÏñ¥ Ïû¨ÏÉù Ìï®Ïàò ---
        async function playTTSWithControl(txt) {
            if (isRec && recog) { 
                 console.log("TTS Ïû¨ÏÉù Ï†Ñ STT Î™ÖÏãúÏ†Å Ï§ëÏßÄ (playTTSWithControl)");
                 if (typeof recog.stop === 'function') recog.stop(); 
            }
            if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
            
            if (skipTTS) {
                skipTTS = false;
                return Promise.resolve(); 
            }
            isPlayingTTS = true;
            try {
                if (typeof playTTSFromText === 'function') {
                    await playTTSFromText(txt, localStorage.getItem('lozee_voice'));
                } else {
                    console.warn("playTTSFromText Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                }
            } catch (error) {
                console.error("playTTSWithControl ÎÇ¥ TTS Ïû¨ÏÉù Ïò§Î•ò:", error);
            } finally {
                isPlayingTTS = false;
            }
        }

        // --- Ïò§ÎîîÏò§ Î∂ÑÏÑù Í¥ÄÎ†® ---
        let audioContext, analyser, source, dataArray, animId, streamRef;
        const LOW = { r:0, g:200, b:0 }; const MID = { r:255, g:200, b:0 }; const HIGH = { r:255, g:69, b:0 };
        function interp(c1, c2, f) { return `rgb(${Math.round(c1.r + f * (c2.r - c1.r))},${Math.round(c1.g + f * (c2.g - c1.g))},${Math.round(c1.b + f * (c2.b - c1.b))})`;}
        function setupAudioAnalysis(stream) { if (audioContext && audioContext.state !== 'closed') {audioContext.close().catch(e => console.warn("Ïù¥Ï†Ñ AudioContext Îã´Í∏∞ Ïò§Î•ò(Î¨¥Ïãú Í∞ÄÎä•):", e));} audioContext = new AudioContext(); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; source = audioContext.createMediaStreamSource(stream); source.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); streamRef = stream; draw(); }
        function draw() { animId = requestAnimationFrame(draw); if (!analyser || !dataArray) return; analyser.getByteFrequencyData(dataArray); let sum = dataArray.reduce((a, v) => a + v, 0); let avg = sum / dataArray.length; let norm = Math.min(100, Math.max(0, (avg / 140) * 100)); if(meterLevel) meterLevel.style.width = norm + '%'; if(meterLevel) meterLevel.style.background = `linear-gradient(to right, var(--background-color), ${norm <= 50 ? interp(LOW, MID, norm / 50) : interp(MID, HIGH, (norm - 50) / 50)})`; if (norm > 10 && isRec && isPlayingTTS && !skipTTS) { console.log("ÏÇ¨Ïö©Ïûê ÏùåÏÑ± Í∞êÏßÄ, TTS Ï§ëÎã® ÏãúÎèÑ"); if (typeof stopCurrentTTS === 'function') stopCurrentTTS(); skipTTS = true; } }
        function stopAudio() { if (animId) cancelAnimationFrame(animId); if (source) source.disconnect(); if (streamRef) streamRef.getTracks().forEach(track => track.stop()); if (audioContext && audioContext.state !== 'closed') { audioContext.close().catch(e => console.warn("AudioContext Îã´Í∏∞ Ïò§Î•ò(Î¨¥Ïãú Í∞ÄÎä•):", e)); } audioContext = null; if(meterLevel) { meterLevel.style.width = '0%'; meterLevel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-container-bg'); } }

        // --- STT (Web Speech API) ---
        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recog, isRec = false;
        if (SpeechRecognitionAPI) {
            recog = new SpeechRecognitionAPI(); 
            recog.continuous = true; // ÏÇ¨Ïö©ÏûêÍ∞Ä Í∏∏Í≤å ÎßêÌï† Ïàò ÏûàÎèÑÎ°ù trueÎ°ú Î≥ÄÍ≤Ω
            recog.interimResults = true; // Ï§ëÍ∞Ñ Í≤∞Í≥º Î∞õÍ∏∞
            recog.lang = 'ko-KR';
            recog.onstart = () => { isRec = true; if(micButton) micButton.classList.add('recording'); };
            recog.onend = () => { isRec = false; if(micButton) micButton.classList.remove('recording'); stopAudio(); };
            recog.onresult = event => { 
                let interim_transcript = '';
                let final_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                // (ÏÑ†ÌÉù ÏÇ¨Ìï≠) Ï§ëÍ∞Ñ Í≤∞Í≥ºÎ•º chatInputÏóê ÏûÑÏãúÎ°ú ÌëúÏãú:
                // if (chatInput) chatInput.value = final_transcript + interim_transcript;
                
                if (final_transcript) { 
                    console.log("STT ÏµúÏ¢Ö Í≤∞Í≥º:", final_transcript); 
                    // if (chatInput) chatInput.value = ''; // ÏµúÏ¢Ö Í≤∞Í≥º Ï†ÑÏÜ° ÌõÑ ÏûÖÎ†•Ï∞Ω ÎπÑÏö∏ÏßÄ Ïó¨Î∂Ä
                    sendMessage(final_transcript.trim(), 'stt'); 
                } 
            };
            recog.onerror = event => { console.error('Speech recognition error:', event.error); appendMessage('ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò: ' + event.error, 'assistant_feedback'); if(isRec && recog){ try{recog.stop();}catch(e){console.warn("recog.stop() Ïò§Î•ò(Î¨¥Ïãú Í∞ÄÎä•):",e)}} isRec = false; if(micButton) micButton.classList.remove('recording'); stopAudio(); };
            
            if(micButton) micButton.onclick = async () => { 
                if (isRec) { 
                    if(recog) recog.stop(); 
                } else { 
                    if (typeof stopCurrentTTS === 'function') stopCurrentTTS(); 
                    skipTTS = true;   
                    try { 
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
                        setupAudioAnalysis(stream); 
                        if(recog) recog.start(); 
                    } catch (e) { 
                        console.error('ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Ïò§Î•ò:', e); 
                        appendMessage('ÎßàÏù¥ÌÅ¨ ÏÇ¨Ïö© Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'assistant_feedback'); 
                    } 
                } 
            };
        } else { if(micButton) micButton.disabled = true; appendMessage('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'assistant_feedback'); }

        // --- ÌÜ†ÌîΩ ÌîåÎ°úÏö∞ - ÏÑ†ÌÉùÏ∞Ω ---
        function getTopicsForCurrentUser() {
            const userType = localStorage.getItem('lozee_userType'); 
            // userAgeÎäî talk.html ÏÉÅÎã®ÏóêÏÑú Ïù¥ÎØ∏ ÌååÏã±Îê®
            const ageForTopicGetter = userType === 'caregiver' 
                ? (parseInt(localStorage.getItem('lozee_child_age') || userAge.toString(), 10)) // ÏûêÎÖÄ ÎÇòÏù¥ ÏóÜÏúºÎ©¥ Î≥¥Ìò∏Ïûê ÎÇòÏù¥Î°ú ÎåÄÏ≤¥ (ÏûÑÏãú)
                : userAge; 

            if (userType === 'directUser') {
                if (ageForTopicGetter < 11) return counselingTopicsByAge.directUser['10ÏÑ∏ÎØ∏Îßå'];
                if (ageForTopicGetter >= 11 && ageForTopicGetter <= 15) return counselingTopicsByAge.directUser['11-15ÏÑ∏'];
                if (ageForTopicGetter >= 16 && ageForTopicGetter <= 29) return counselingTopicsByAge.directUser['16-29ÏÑ∏'];
                return counselingTopicsByAge.directUser['16-29ÏÑ∏']; // Í∏∞Î≥∏Í∞í
            } else if (userType === 'caregiver') {
                return counselingTopicsByAge.caregiver;
            } else {
                console.warn("Ïïå Ïàò ÏóÜÎäî ÏÇ¨Ïö©Ïûê Ïú†Ìòï:", userType, "Í∏∞Î≥∏ Ï£ºÏ†ú(directUser 11-15ÏÑ∏)Î•º ÌëúÏãúÌï©ÎãàÎã§.");
                return counselingTopicsByAge.directUser['11-15ÏÑ∏']; 
            }
        }
                
        function displayOptionsInChat(optionsArray, onSelectCallback) { 
            console.log("displayOptionsInChat Ìï®Ïàò ÏãúÏûëÎê®, ÏòµÏÖò Î∞∞Ïó¥:", optionsArray); 
            const optionsContainer = document.createElement('div'); optionsContainer.className = 'chat-options-container'; 
            const buttons = []; 
            if (!optionsArray || !Array.isArray(optionsArray)) {
                console.error("displayOptionsInChat: optionsArrayÍ∞Ä Ïú†Ìö®Ìïú Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§.", optionsArray);
                return;
            }
            optionsArray.forEach(optionObject => { 
                let buttonText; let valueToCallback; 
                if (typeof optionObject === 'string') { buttonText = optionObject; valueToCallback = optionObject;} 
                else if (optionObject && typeof optionObject.displayText !== 'undefined') { buttonText = optionObject.icon ? `${optionObject.icon} ${optionObject.displayText}` : optionObject.displayText; valueToCallback = optionObject.displayText; } 
                else { console.warn("displayOptionsInChat: ÏûòÎ™ªÎêú ÌòïÏãùÏùò ÏòµÏÖò:", optionObject); return; } 
                const button = document.createElement('button'); button.className = 'chat-option-btn'; button.textContent = buttonText; 
                if (optionObject && optionObject.isContinuation) { button.classList.add('continue-topic-btn'); }
                button.onclick = () => { buttons.forEach(btn => { btn.disabled = true; if (btn === button) { btn.classList.add('selected'); } }); onSelectCallback(valueToCallback, optionObject); }; 
                optionsContainer.appendChild(button); buttons.push(button); 
            }); 
            if(chatWindow) chatWindow.appendChild(optionsContainer); 
            if(chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; 
        }

        // --- ÌÜ†ÌîΩ ÌîåÎ°úÏö∞ - Ï£ºÏ†ú ---
        function showMainTopics() { 
            console.log("showMainTopics Ìï®Ïàò ÏãúÏûëÎê®"); 
            appendMessage('Ïñ¥Îñ§ Ïù¥ÏïºÍ∏∞Î•º ÎÇòÎà†Î≥ºÍπå?', 'assistant'); 
            const currentUserTopics = getTopicsForCurrentUser(); 
            let topicsWithOptions = []; 
            const continueTopicData = localStorage.getItem('lozee_continue_topic');
            if (continueTopicData) { try { const topicToContinue = JSON.parse(continueTopicData); topicsWithOptions.push({ icon: '‚Ü™Ô∏è', displayText: `Ï†ÄÎ≤à ÎåÄÌôî Ïù¥Ïñ¥ÌïòÍ∏∞ (${topicToContinue.details || 'ÏÉùÍ∞Å Ìå®ÌÑ¥'})`, isContinuation: true, continueDetails: topicToContinue }); } catch (e) { console.error("Ïù¥Ïñ¥ÌïòÍ∏∞ Ï£ºÏ†ú ÌååÏã± Ïò§Î•ò:", e); localStorage.removeItem('lozee_continue_topic');} }
            if (currentUserTopics && typeof currentUserTopics === 'object' && Object.keys(currentUserTopics).length > 0) { const categoryNames = Object.keys(currentUserTopics); const categoryOptions = categoryNames.map(categoryName => { let icon = 'üí¨'; if (currentUserTopics[categoryName] && Array.isArray(currentUserTopics[categoryName]) && currentUserTopics[categoryName].length > 0 && currentUserTopics[categoryName][0].icon) { icon = currentUserTopics[categoryName][0].icon; } return { icon: icon, displayText: categoryName, isContinuation: false }; }); topicsWithOptions.push(...categoryOptions); } 
            else { console.warn(`ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏóê ÎßûÎäî Ï£ºÏ†ú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.`, currentUserTopics); } 
            topicsWithOptions.push({ icon: 'üó£Ô∏è', displayText: 'ÏûêÏú†Ï£ºÏ†ú', isContinuation: false }); 
            console.log("displayOptionsInChatÏóê Ï†ÑÎã¨Îê† Î∞∞Ïó¥:", topicsWithOptions); 
            displayOptionsInChat(topicsWithOptions, (selectedText, fullOptionObject) => { 
                selectedMain = selectedText; appendMessage(selectedMain + ' Ïù¥ÏïºÍ∏∞Î•º ÏÑ†ÌÉùÌñàÍµ¨ÎÇò!', 'assistant'); 
                if (fullOptionObject && fullOptionObject.isContinuation) { localStorage.removeItem('lozee_continue_topic'); const continueMessage = fullOptionObject.continueDetails && fullOptionObject.continueDetails.details ? `Ï†ÄÎ≤àÏóê Ïù¥ÏïºÍ∏∞ÌñàÎçò '${fullOptionObject.continueDetails.details}'Ïóê ÎåÄÌï¥ Í≥ÑÏÜç Ïù¥ÏïºÍ∏∞Ìï¥Î≥¥Ïûê.` : "Ï†ÄÎ≤àÏóê ÎÇòÎàÑÎçò Ïù¥ÏïºÍ∏∞, Í≥ÑÏÜçÌï¥Î≥ºÍπå?"; startChat(continueMessage, 'topic_selection_init'); } 
                else if (selectedMain === 'ÏûêÏú†Ï£ºÏ†ú') { const message = 'ÎÑ§Í∞Ä Ï†ïÌïòÎ©¥ Îèº. Ïñ¥Îñ§ Ïù¥ÏïºÍ∏∞Í∞Ä ÌïòÍ≥† Ïã∂Ïñ¥?'; appendMessage(message, 'assistant'); if(inputArea) inputArea.style.display = 'flex'; if(chatInput) chatInput.focus();  } 
                else { setTimeout(showSubTopics, 300); } 
            }); 
            if (topicArea) { topicArea.style.display = 'none !important'; }
        }
           
        function showSubTopics() { 
            if (!selectedMain) { console.warn("showSubTopics: selectedMainÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå"); return; } 
            const currentUserTopicCategories = getTopicsForCurrentUser(); let subtopicOptions = [];
            if (selectedMain === 'ÏûêÏú†Ï£ºÏ†ú') { startChat('', 'topic_selection_init'); return; } 
            else if (currentUserTopicCategories && currentUserTopicCategories[selectedMain] && Array.isArray(currentUserTopicCategories[selectedMain])) { subtopicOptions = currentUserTopicCategories[selectedMain]; } 
            else { console.warn(`'${selectedMain}' Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÎåÄÌïú ÌïòÏúÑ Ï£ºÏ†úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò ÌòïÏãùÏù¥ ÏûòÎ™ªÎêòÏóàÏäµÎãàÎã§.`); subtopicOptions = [{ icon: 'üí¨', displayText: 'Ïù¥ Ï£ºÏ†úÏóê ÎåÄÌï¥ ÏûêÏú†Î°≠Í≤å Ïù¥ÏïºÍ∏∞Ìï¥ Ï§ÑÎûò?' }]; } 
            if (!subtopicOptions || subtopicOptions.length === 0) { console.log(`'${selectedMain}' Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÌïòÏúÑ Ï£ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.`); startChat(`'${selectedMain}'Ïóê ÎåÄÌï¥ ÏûêÏú†Î°≠Í≤å Ïù¥ÏïºÍ∏∞Ìï¥Ï§ò.`, 'topic_selection_init'); return; } 
            appendMessage('Ï°∞Í∏à Îçî Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Ïù¥ÏïºÍ∏∞Ìï¥ Ï§ÑÎûò?', 'assistant');
            displayOptionsInChat(subtopicOptions, (selectedSubtopicText) => { startChat(selectedSubtopicText, 'topic_selection_init'); }); 
        }

        function startChat(initText, inputMethod = 'topic_selection_init') { 
            console.log("startChat Ìï®Ïàò ÏãúÏûëÎê®, Ï¥àÍ∏∞ Î©îÏãúÏßÄ:", initText, "ÏûÖÎ†•Î∞©Ïãù:", inputMethod); 
            if (topicArea) topicArea.style.display = 'none !important'; 
            if (inputArea) inputArea.style.display = 'flex'; 
            if (initText && String(initText).trim() !== '') { sendMessage(initText, inputMethod); } 
            else { if (chatInput) chatInput.focus(); }
        }   
        
        // --- Îßê Í∏∏Ïù¥ ÏÑ†Ìò∏ÎèÑ ÏßàÎ¨∏ Ìï®Ïàò ---
        function askForVerbosityPreference() {
            if (verbosityPromptCount >= 2) return; 
            const options = [ { displayText: "ÎßêÏùÑ Ï¢Ä Ï§ÑÏó¨Ï§ò" }, { displayText: "ÏßÄÍ∏àÏù¥ Ï†ÅÎãπÌï¥" }, { displayText: "ÎÇòÏóêÍ≤å Îçî ÎßéÏùÄ Ï°∞Ïñ∏ÏùÑ Ï§ò" } ];
            appendMessage("ÏßÄÍ∏à ÎÇ¥Í∞Ä ÌïòÎäî ÎßêÏù¥ ÎÑàÏóêÍ≤å Ï†ÅÎãπÌïúÏßÄ ÏïåÎ†§Ï§ÑÎûò?", 'assistant');
            displayOptionsInChat(options, (selectedOption) => {
                appendMessage(selectedOption, 'user'); 
                if (selectedOption === "ÎßêÏùÑ Ï¢Ä Ï§ÑÏó¨Ï§ò") gptVerbosityPreference = 'short';
                else if (selectedOption === "ÎÇòÏóêÍ≤å Îçî ÎßéÏùÄ Ï°∞Ïñ∏ÏùÑ Ï§ò") gptVerbosityPreference = 'verbose';
                else gptVerbosityPreference = 'default';
                verbosityPromptCount++; lastVerbosityPromptTime = Date.now(); 
                const followupMessage = "ÏïåÎ†§Ï§òÏÑú Í≥†ÎßàÏõå! Ïù¥ ÏÑ§Ï†ïÏùÄ ÏïΩ 10Î∂ÑÍ∞Ñ Ïú†ÏßÄÎê† Í±∞Ïïº. Í≥ÑÏÜçÌï¥ÏÑú ÌïòÍ≥† Ïã∂ÏùÄ Ïù¥ÏïºÍ∏∞Î•º Ìï¥Ï§ò.";
                appendMessage(followupMessage, 'assistant');
            });
        }

        // --- Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò ---
        async function sendMessage(text, inputMethod = 'text') { 
            if (!text || String(text).trim() === '' || isProcessing) return;
            isProcessing = true;
            if(sendBtn) sendBtn.classList.add('loading');

            if (!conversationStartTime) conversationStartTime = Date.now();

            if (inputMethod !== 'topic_selection_init') { 
                appendMessage(text, 'user');
            }
            chatHistory.push({ role: 'user', content: text }); 
            // userTotalCharCount += text.length; // ÌòÑÏû¨ ÏÑ∏ÏÖòÏùò ÏÇ¨Ïö©Ïûê Î∞úÌôî Í∏ÄÏûê Ïàò ÎàÑÏ†Å



            const currentUserEmail = localStorage.getItem('cbtUserEmail');
            if (chatInput) chatInput.value = '';

            const thinkingBubble = document.createElement('div');
            thinkingBubble.className = 'bubble assistant thinking'; 
            thinkingBubble.textContent = 'ÏÉùÍ∞ÅÏ§ëÏù¥Ïïº...'; 
            if (chatWindow) chatWindow.appendChild(thinkingBubble);
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                const elapsedTimeInMinutesForGPT = (Date.now() - conversationStartTime) / (1000 * 60);
                const userDiagnoses = JSON.parse(localStorage.getItem('lozee_diagnoses') || '[]');

                const res = await getGptResponse(text, { 
                    chatHistory, 
                    verbosity: gptVerbosityPreference, 
                    elapsedTime: elapsedTimeInMinutesForGPT,
                    userTraits: userDiagnoses
                }); 
                
                if (thinkingBubble) thinkingBubble.remove(); 

                if (!res.ok) {
                    const errorData = await res.text();
                    console.error(`GPT API ÏùëÎãµ Ïò§Î•ò ${res.status}: ${errorData}`);
                    appendMessage("ÎØ∏Ïïà, ÏßÄÍ∏àÏùÄ ÎãµÎ≥ÄÌïòÍ∏∞ Ï°∞Í∏à Ïñ¥Î†§Ïõå. (ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò)", "assistant_feedback");
                    return; 
                }
                const d = await res.json();
                const cut = d.text.indexOf('{'); 
                const clean = cut >= 0 ? d.text.slice(0, cut).trim() : d.text.trim();
                    
                appendMessage(clean, 'assistant'); 

                if (inputMethod === 'stt') { 
                    await playTTSWithControl(clean);
                } else if (inputMethod === 'text' && !skipTTS) { 
                    console.log("ÌÖçÏä§Ìä∏ ÏûÖÎ†•Ïóê ÎåÄÌïú ÏùëÎãµ. TTSÎäî ÌòÑÏû¨ Ïû¨ÏÉù Ïïà Ìï®.");
                } else if (inputMethod === 'topic_selection_init' && !skipTTS) {
                    console.log("Ï£ºÏ†ú ÏÑ†ÌÉù ÌõÑ Ï≤´ ÏùëÎãµ. TTSÎäî ÌòÑÏû¨ Ïû¨ÏÉù Ïïà Ìï®.");
                }
                if (skipTTS) skipTTS = false; 
                
                chatHistory.push({ role: 'assistant', content: clean });
                assistantMessageCount++; 

                if (currentUserEmail && selectedMain) {
                    await saveSessionLog(text, clean, d.analysis || {}, selectedMain, currentUserEmail); 
                    await updateTopicStats(currentUserEmail, selectedMain); 
                }

                const elapsedTimeInMinutesForAnalysis = (Date.now() - conversationStartTime) / (1000 * 60);
                if (elapsedTimeInMinutesForAnalysis >= 15 && !analysisNotificationShown) { 
                    console.log(`${elapsedTimeInMinutesForAnalysis.toFixed(1)}Î∂Ñ Í≤ΩÍ≥º, ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏãúÎèÑ`);
                    let detailedAnalysisDataForStorage = {};
                    let currentTotalConversationMinutes = elapsedTimeInMinutesForAnalysis; 

                    if (LOZEE_ANALYSIS && LOZEE_ANALYSIS.inferAgeAndLanguage) { 
                        try { 
                            const langAgeResult = await LOZEE_ANALYSIS.inferAgeAndLanguage(chatHistory.map(m=>`${m.role}: ${m.content}`).join('\n')); 
                            detailedAnalysisDataForStorage.ageLanguageAnalysis = langAgeResult; 
                        } catch (e) { console.error("inferAgeAndLanguage Ïò§Î•ò:", e); } 
                    }
                    if (d.analysis) { 
                        detailedAnalysisDataForStorage.gptRealtimeAnalysis = d.analysis; 
                        if(d.analysis.keywords) detailedAnalysisDataForStorage.keywords = d.analysis.keywords; 
                        if(d.analysis.overallSentiment) detailedAnalysisDataForStorage.overallSentiment = d.analysis.overallSentiment; 
                        if(d.analysis.cognitiveDistortions) detailedAnalysisDataForStorage.cognitiveDistortions = d.analysis.cognitiveDistortions; 
                    }

                    if(Object.keys(detailedAnalysisDataForStorage).length > 0) {
                        // FirestoreÏóêÏÑú ÏÇ¨Ïö©ÏûêÏùò Ïù¥Ï†ÑÍπåÏßÄÏùò Ï¥ù ÎàÑÏ†Å Í∏ÄÏûê ÏàòÎ•º Í∞ÄÏ†∏ÏôÄ ÎçîÌïòÍ±∞ÎÇò,
                        // ÌòÑÏû¨ ÏÑ∏ÏÖòÏùò Í∏ÄÏûê ÏàòÎßå Ï†ÄÏû•Ìï†ÏßÄ Ï†ïÏ±Ö Í≤∞Ï†ï ÌïÑÏöî.
                        // Ïó¨Í∏∞ÏÑúÎäî ÌòÑÏû¨ ÏÑ∏ÏÖòÏùò ÏÇ¨Ïö©Ïûê Î∞úÌôî Í∏ÄÏûê ÏàòÎ•º Ï†ÄÏû•ÌïúÎã§Í≥† Í∞ÄÏ†ï.
                        // (ÎòêÎäî talk.html Î°úÎìú Ïãú localStorageÎÇò FirestoreÏóêÏÑú Ïù¥Ï†Ñ ÎàÑÏ†ÅÏπò Í∞ÄÏ†∏ÏôÄ ÎçîÌïòÍ∏∞)
        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
        startTime: conversationStartTime, 
        analysisTime: Date.now(),
        accumulatedDurationMinutes: currentTotalConversationMinutes,
        accumulatedUserCharCount: userTotalCharCount, // üëà ÏÇ¨Ïö©Ïûê Ï¥ù Î∞úÌôî Í∏ÄÏûê Ïàò Ï∂îÍ∞Ä
        results: detailedAnalysisDataForStorage
                        }));
                        showAnalysis();
                    }
                }

                if (verbosityPromptCount === 0 && assistantMessageCount >= 5) {
                  askForVerbosityPreference();
                } else if (verbosityPromptCount === 1 && (Date.now() - lastVerbosityPromptTime > PREFERENCE_PROMPT_INTERVAL)) {
                  askForVerbosityPreference();
                }
            } catch (error) { 
              if(thinkingBubble) thinkingBubble.remove(); 
              console.error("sendMessage ÎÇ¥ Ïò§Î•ò:", error);
              appendMessage("ÎØ∏Ïïà, ÏßÄÍ∏àÏùÄ ÎãµÎ≥ÄÌïòÍ∏∞ Ï°∞Í∏à Ïñ¥Î†§Ïõå. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï§ÑÎûò?", "assistant_feedback");
            } finally { 
              isProcessing = false;
              if(sendBtn) sendBtn.classList.remove('loading');
            }
        } 

        // --- Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ---
        if(sendBtn) sendBtn.addEventListener('click', () => sendMessage(chatInput.value, 'text')); 
        if(chatInput) chatInput.addEventListener('keydown', e => { 
            meta.lastInputTimestamp = Date.now();
            meta.clickedOption = false;
            // const fillers = ['Ïùå','‚Ä¶','Ïñ¥','Í∏ÄÏéÑ','Î™®Î•¥Í≤†Ïñ¥Ïöî','Ïûò Î™®Î•¥Í≤†Ïñ¥']; 
            // meta.fillerCount = fillers.some(f => chatInput.value.includes(f)) ? meta.fillerCount + 1 : 0;
            
            if (isPlayingTTS) { 
                if (typeof stopCurrentTTS === 'function') stopCurrentTTS();
                skipTTS = true;
            }
            if (e.key === 'Enter' && !e.isComposing) { 
                e.preventDefault(); 
                sendMessage(chatInput.value, 'text'); 
            }
        });
    </script>
    <script src="./js/gnb.js" defer></script> 
</body>
</html>