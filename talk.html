<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEE 상담</title>
  <!-- 스타일 시트 경로 수정 -->
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./emotion-colors.css" />
</head>
<body>
  <div id="chat-container">
    <div id="status">
      <span id="status-dot"></span>
      <span id="status-text">대기 중</span>
    </div>
    <div id="messages"></div>
  </div>

  <script type="module">
    // stt.js의 내보내기 방식을 모두 import
    import * as STT from './js/stt.js';
    import { startTTS }       from './js/tts.js';
    import { getGptResponse } from './js/gpt-dialog.js';

    // onboarding 미완료 시 index로
    if (!sessionStorage.getItem('lozee_first_utterance')) {
      window.location.replace('index.html');
    }

    const messagesEl = document.getElementById('messages');

    function appendMessage(sender, text) {
      const msg = document.createElement('div');
      msg.className = sender === 'bot' ? 'bot-message' : 'user-message';
      msg.textContent = text;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function handleUserTurn(transcript) {
      appendMessage('user', transcript);
      STT.stopSTT();

      appendMessage('bot', '…');
      const gptText = await getGptResponse(transcript);

      await startTTS(gptText);
      STT.startSTT(handleUserTurn);

      const botMsgs = messagesEl.querySelectorAll('.bot-message');
      botMsgs[botMsgs.length - 1].textContent = gptText;
    }

    async function initConversation() {
      const first = sessionStorage.getItem('lozee_first_utterance');
      appendMessage('bot', first);
      await startTTS(first);
      STT.startSTT(handleUserTurn);
    }

    document.addEventListener('DOMContentLoaded', initConversation);
  </script>
</body>
</html>
