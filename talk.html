<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE 대화</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; background: #fff; color: #333; font-family: 'KoPubWorld Dotum', sans-serif; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; font-size: 16px; white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user { background-color: #fff9c4; color: #333; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .ai { background-color: #0095FF; color: #fff; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 5px; }
    #loading-indicator { text-align: center; padding: 10px; display: none; color: #555; font-style: italic; }
    #talk-btn-container { text-align: center; padding: 15px; border-top: 1px solid #eee; background: #fafafa; }
    #talk-btn { width: 80px; height: 80px; border-radius: 50%; background: #b6b6b6; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); color: #fff; font-size: 36px; cursor: pointer; transition: transform .2s, background-color .3s; }
    #talk-btn.recording { background: #e06c75; transform: scale(1.1); }
    #talk-btn.active { background: #0095FF; transform: scale(1.1); }
  </style>
</head>
<body>
  <div id="chat-window"></div>
  <div id="loading-indicator">AI 응답 준비 중...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="말하기">🎤</button>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    // 녹음 정책
    function getRecordingPolicyByAge(age) {
      age = parseInt(age, 10) || 16;
      if (age <= 10) return { segmentDuration: 30000, maxDuration: 180000 };
      if (age <= 15) return { segmentDuration: 30000, maxDuration: 300000 };
      return { segmentDuration: 40000, maxDuration: 600000 };
    }

    // 침묵 시 시나리오 (10초)
    const silenceScenarios = [
      '무슨 이야기를 더 해볼까?',
      '궁금한 게 있으면 언제든 말해줘.',
      '조금 조용하네, 무슨 생각 중이야?'
    ];

    const chatWindow = document.getElementById('chat-window');
    const talkBtn     = document.getElementById('talk-btn');
    const loading     = document.getElementById('loading-indicator');

    let sessionStart = Date.now();
    let isRecording = false;
    let mediaRecorder, mediaStream, audioChunks = [];
    let firstDone = false;
    let segmentTimer, maxTimer, silenceTimer;
    let segmentMs = 30000, maxMs = 180000;

    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return div;
    }

    function toggleLoading(state) {
      loading.style.display = state ? 'block' : 'none';
      talkBtn.disabled = state;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // 정책 적용
      const age = localStorage.getItem('lozee_user_age');
      const policy = getRecordingPolicyByAge(age);
      segmentMs = policy.segmentDuration;
      maxMs = policy.maxDuration;

      // 초기 인사
      const name = localStorage.getItem('lozee_username') || '친구';
      const greeting = await getInitialGreeting(name);
      appendMessage(greeting, 'ai');

      // Index에서 보낸 메시지
      const intro = localStorage.getItem('lozee_user_typed_intro');
      if (intro) {
        handleUserTurn(intro);
        localStorage.removeItem('lozee_user_typed_intro');
        firstDone = true;
      }

      // 말하기 버튼 이벤트
      talkBtn.addEventListener('click', async () => {
        clearTimeout(silenceTimer);
        if (!firstDone) {
          firstDone = true;
          toggleLoading(true);
          await playTTSFromText(greeting);
          toggleLoading(false);
          startSilenceTimer();
          return;
        }
        isRecording ? stopRecording() : startRecording();
      });
    });

    async function startRecording() {
      clearTimeout(silenceTimer);
      isRecording = true;
      audioChunks = [];
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = processAudio;
      mediaRecorder.start();
      talkBtn.classList.add('recording');
      segmentTimer = setTimeout(stopRecording, segmentMs);
      maxTimer = setTimeout(stopRecording, maxMs);
    }

    function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      clearTimeout(segmentTimer);
      clearTimeout(maxTimer);
      mediaRecorder.stop();
      mediaStream.getTracks().forEach(t => t.stop());
      talkBtn.classList.remove('recording');
    }

    async function processAudio() {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const userBubble = appendMessage('…', 'user');
      toggleLoading(true);
      try {
        const transcript = await getSTTFromAudio(blob);
        userBubble.textContent = transcript;
        await handleUserTurn(transcript);
      } catch {
        appendMessage('오류가 발생했습니다.', 'ai');
      } finally {
        toggleLoading(false);
        startSilenceTimer();
      }
    }

    // 사용자 발화 처리 + GPT 호출
    async function handleUserTurn(text) {
      appendMessage(text, 'user');
      const age = parseInt(localStorage.getItem('lozee_user_age'), 10) || 16;
      const elapsed = Date.now() - sessionStart;
      // 시스템 프롬프트 구성
      const sys = [];
      if (elapsed < 10 * 60 * 1000) sys.push('초기 10분간 대화를 이끌어 내는 데 집중하세요.');
      if (age < 10 && elapsed < 10 * 60 * 1000) sys.push('15글자 이상 응답을 자제하세요.');
      sys.push(age <= 55 ? '반말로 답하세요.' : '존댓말로 답하세요.');
      const systemPrompt = sys.join(' ');

      // GPT 호출
      const res = await getGptResponse(text, systemPrompt);
      const aiText = (typeof res === 'string' ? res : (res.error || res.rephrasing || '응답이 없습니다.'));
      appendMessage(aiText, 'ai');
      await playTTSFromText(aiText);
    }

    function startSilenceTimer() {
      silenceTimer = setTimeout(() => {
        const prompt = silenceScenarios[Math.floor(Math.random() * silenceScenarios.length)];
        appendMessage(prompt, 'ai');
        playTTSFromText(prompt);
      }, 10000);
    }
  </script>
</body>
</html>
