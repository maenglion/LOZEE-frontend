<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEÏôÄ ÎåÄÌôîÌïòÍ∏∞</title>
  <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary-color: #6e8efb;
      --secondary-color: #354157;
      --background-color: #2a3340;
      --text-color: #fff;
      --input-background: #f0f0f0;
      --bot-bubble-bg: var(--input-background);
      --bot-bubble-text: #333;
      --user-bubble-bg: var(--primary-color);
      --user-bubble-text: #fff;
      --gnb-height: 56px;
      --chat-input-height: 70px;
      --chat-input-padding-bottom: 36px;
      --gemini-purple: #7B68EE;
      --volume-meter-default-bg: var(--primary-color);
      --meter-top-margin: 8px;
      --gnb-dropdown-border-color: #4a5568;
    }
    body{margin:0;padding-top:var(--gnb-height);font-family:'KoPub World Dotum',sans-serif;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;height:100vh;box-sizing:border-box;overflow:hidden;}
    #gnb{position:fixed;top:0;left:0;width:100%;height:var(--gnb-height);background-color:var(--background-color);padding:0 16px;box-shadow:0 2px 5px rgba(0,0,0,0.3);z-index:1000;display:flex;justify-content:space-between;align-items:center;box-sizing:border-box;}
    #gnb-title{font-size:1.2em;font-weight:bold;color:var(--gemini-purple);}
    #menu-toggle{background:none;border:none;color:var(--gemini-purple);font-size:24px;cursor:pointer;padding:8px;display:flex;align-items:center;justify-content:center;}
    #dropdown-menu{position:fixed;top:var(--gnb-height);right:0;background-color:var(--background-color);border-radius:0 0 0 8px;box-shadow:-3px 3px 6px rgba(0,0,0,0.25);width:200px;z-index:999;overflow:hidden;max-height:0;transition:max-height 0.3s ease-out;}
    #dropdown-menu.show{max-height:500px;}
    #dropdown-menu a{display:block;color:var(--text-color);text-decoration:none;padding:12px 16px;font-size:0.95em;border-bottom:1px solid var(--gnb-dropdown-border-color);}
    #dropdown-menu a:last-child{border-bottom:none;}
    #dropdown-menu a:hover{background-color:var(--secondary-color);}
    #meter-container{position:fixed;top:calc(var(--gnb-height) + var(--meter-top-margin));left:50%;transform:translateX(-50%);width:60%;max-width:300px;height:6px;background-color:var(--secondary-color);border-radius:3px;overflow:hidden;z-index:998;}
    #volume-level{width:0%;height:100%;background:var(--volume-meter-default-bg);border-radius:3px;transition:width 0.05s linear;}
    #chat-container{flex-grow:1;padding:16px;padding-top:calc(var(--meter-top-margin) + 6px + 10px);overflow-y:auto;display:flex;flex-direction:column;gap:10px; margin-bottom: calc(var(--chat-input-height) + var(--chat-input-padding-bottom));}
    #analysis-container{padding:10px;background:#1e2a38;color:#ccc;font-size:0.85em;max-height:150px;overflow-y:auto;border-top:1px solid var(--secondary-color); display:none;}
    .bubble{padding:12px 16px;border-radius:18px;max-width:75%;line-height:1.5;word-break:keep-all;box-shadow:0 1px 2px rgba(0,0,0,0.1);}
    .bubble.user{background-color:var(--user-bubble-bg);color:var(--user-bubble-text);align-self:flex-end;border-bottom-right-radius:4px;}
    .bubble.bot{background-color:var(--bot-bubble-bg);color:var(--bot-bubble-text);align-self:flex-start;border-bottom-left-radius:4px;}
    .bubble.user.interim{opacity:.7;}
    .bubble.system-error{background-color:#ffe0e0;color:#c0392b;align-self:center;max-width:80%;text-align:center;font-size:0.9em;border:1px solid #c0392b; margin: 5px 0;}
    #chat-input-container{position:fixed;bottom:0;left:0;width:100%;height:calc(var(--chat-input-height) + var(--chat-input-padding-bottom)); display:flex;flex-direction:column; background-color:var(--secondary-color);box-shadow:0 -2px 4px rgba(0,0,0,0.1);box-sizing:border-box; padding-top: 8px;}
    .input-area { display: flex; align-items: center; width: 100%; padding: 0 12px; gap: 8px; height: var(--chat-input-height); }
    #chat-input{flex:1;padding:12px 16px;border-radius:22px;border:1px solid #4a5568;font-size:1em;background-color:var(--input-background);color:#333;height:44px;box-sizing:border-box;}
    #chat-input::placeholder{color:#777;}
    #mic-button, #send-button{width:44px;height:44px;border:none;border-radius:50%;background-color:var(--primary-color);color:var(--text-color);font-size:1.3em;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color 0.2s ease; flex-shrink: 0;}
    #mic-button { margin-left: 0; margin-right: 8px;} /* ÎßàÏù¥ÌÅ¨ Î≤ÑÌäº ÏôºÏ™Ω ÎßàÏßÑ Ï†úÍ±∞, Ïò§Î•∏Ï™Ω Í∞ÑÍ≤© Ï∂îÍ∞Ä */
    #send-button { margin-left: 0; } /* Ï†ÑÏÜ° Î≤ÑÌäº ÏôºÏ™Ω ÎßàÏßÑ Ï†úÍ±∞ */
    #mic-button:hover, #send-button:hover{background-color:#5a7edf;}
    #mic-button.recording{background-color:#e74c3c;}
    #send-button.loading{background:#999;cursor:default;}
    #chat-container::-webkit-scrollbar{width:8px;}
    #chat-container::-webkit-scrollbar-track{background:var(--background-color);}
    #chat-container::-webkit-scrollbar-thumb{background:var(--gnb-dropdown-border-color);border-radius:4px;}
    #chat-container::-webkit-scrollbar-thumb:hover{background:#5a7edf;}
  </style>
</head>
<body>
  <nav id="gnb">
    <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle" aria-label="Î©îÎâ¥ Ïó¥Í∏∞/Îã´Í∏∞">&#9776;</button>
    <div id="dropdown-menu">
      <a href="#">MY PAGE (Ï§ÄÎπÑÏ§ë)</a>
      <a href="index.html">Ï£ºÏ†ú Î≥ÄÍ≤Ω</a>
      <a href="analysis.html">ÏµúÍ∑º ÎåÄÌôî Î∂ÑÏÑù</a>
      <a href="journal-list.html">Ï£ºÏ†úÎ≥Ñ ÎåÄÌôî Î™©Î°ù</a>
      <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank" rel="noopener noreferrer">LOZEE ÏÜåÍ∞ú</a>
    </div>
  </nav>

  <div id="meter-container"><div id="volume-level"></div></div>
  <div id="chat-container"></div>
  <div id="analysis-container"></div>

  <div id="chat-input-container">
    <div class="input-area">
        <button id="mic-button" title="ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë/Ï§ëÏßÄ">üé§</button>
        <input type="text" id="chat-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off"/>
        <button id="send-button" title="Î©îÏãúÏßÄ Ï†ÑÏÜ°">‚Æû</button>
    </div>
  </div>

  <script src="./js/gpt-dialog.js"></script>
  <script src="./js/tts.js"></script>
  <script src="./js/basic-features.js"></script>
  <script src="./js/literacyPatternCheckRenderer.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeApp, 100);
    });

    async function initializeApp() {
      const chatContainer = document.getElementById('chat-container');
      const analysisContainer = document.getElementById('analysis-container');

      function appendBubble(text, role) {
        const el = document.createElement('div');
        el.className = `bubble ${role}`;
        el.textContent = text;
        if (role === 'system-error') el.classList.add('system-error');
        if (chatContainer) {
            chatContainer.appendChild(el);
            requestAnimationFrame(() => chatContainer.scrollTop = chatContainer.scrollHeight);
        } else {
            console.error("Chat container not found. Message:", text);
            if (role === 'system-error') alert("Ïò§Î•ò: " + text);
        }
      }

      if (!chatContainer) {
          console.error("CRITICAL: chatContainer not found.");
          document.body.innerHTML = '<div style="color:red;text-align:center;padding:50px;">Ï±ÑÌåÖ UI Î°úÎìú Ïã§Ìå®!</div>';
          return;
      }

      // --- TTS Î∞è STT Ï†úÏñ¥ Î≥ÄÏàò ---
      let currentTTSUtterance = null; // Web Speech API ÏÇ¨Ïö© Ïãú Utterance Í∞ùÏ≤¥ Ï†ÄÏû•
      let isTTSRunning = false;   // TTS Ïû¨ÏÉù ÏÉÅÌÉú ÌîåÎûòÍ∑∏
      let currentTTSAudioElement = null; // tts.jsÍ∞Ä Audio Í∞ùÏ≤¥Î•º Î∞òÌôòÌïòÎäî Í≤ΩÏö∞Î•º ÏúÑÌïú Î≥ÄÏàò

      // --- Ï†ÑÏó≠ Í∞ùÏ≤¥ÏóêÏÑú Ìï®Ïàò Í∞ÄÏ†∏Ïò§Í∏∞ Î∞è Ìè¥Î∞± ---
      const playTTSFromText_original = window.LOZEE_TTS?.playTTSFromText;
      const DEFAULT_VOICE = window.LOZEE_TTS?.DEFAULT_VOICE || 'default-fallback-voice';

      async function playTTSWithControl(text, voice) {
        stopCurrentTTS(); // ÏÉà TTS Ïû¨ÏÉù Ï†Ñ Í∏∞Ï°¥ TTS Ï§ëÏßÄ

        if (!text || !String(text).trim()) {
          console.log("TTS: Ïû¨ÏÉùÌï† ÌÖçÏä§Ìä∏ ÏóÜÏùå.");
          isTTSRunning = false; // Ïû¨ÏÉùÌï† ÎÇ¥Ïö© ÏóÜÏúºÎ©¥ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
          return;
        }

        console.log("ÏÉàÎ°úÏö¥ TTS Ïû¨ÏÉù ÏãúÎèÑ:", text);
        isTTSRunning = true;
        setLoading(true); // TTS ÏãúÏûë Ïãú Î°úÎî© ÏÉÅÌÉú (ÎßàÏù¥ÌÅ¨ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Îì±)

        try {
          if (typeof playTTSFromText_original === 'function') {
            // LOZEE_TTS.playTTSFromTextÍ∞Ä PromiseÎ•º Î∞òÌôòÌïòÍ≥†,
            // ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú Web Speech API ÎòêÎäî Audio Í∞ùÏ≤¥Î•º ÏÇ¨Ïö©ÌïúÎã§Í≥† Í∞ÄÏ†ï
            await playTTSFromText_original(text, voice);
            console.log("TTS Ïû¨ÏÉù ÏôÑÎ£å (Promise resolved):", text);
          } else {
            console.warn(`TTS Fallback (ÏùåÏÑ±: ${voice}): ${text}. tts.js Î°úÎìú Ïã§Ìå®.`);
            appendBubble("ÏïåÎ¶º: ÏùåÏÑ± Ï∂úÎ†•(TTS) Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. (tts.js ÌôïÏù∏ ÌïÑÏöî)", "system-error");
          }
        } catch (error) {
          console.error("TTS Ïû¨ÏÉù Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
          appendBubble("ÏùåÏÑ± Ï∂úÎ†• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", "system-error");
        } finally {
          isTTSRunning = false;
          currentTTSUtterance = null; // Web Speech API ÏÇ¨Ïö© Ïãú Ï¥àÍ∏∞Ìôî
          currentTTSAudioElement = null; // Audio Í∞ùÏ≤¥ ÏÇ¨Ïö© Ïãú Ï¥àÍ∏∞Ìôî
          setLoading(false); // TTS Ï¢ÖÎ£å ÌõÑ Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
        }
      }


      const getGptResponse = window.LOZEE_DIALOG?.getGptResponse || (async (text) => {
        console.error("getGptResponse ÏÇ¨Ïö© Î∂àÍ∞Ä (gpt-dialog.js Î°úÎìú Ïã§Ìå®).");
        appendBubble("Ïò§Î•ò: ÎåÄÌôî ÏùëÎãµÏùÑ Î∞õÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (gpt-dialog.js ÌôïÏù∏ ÌïÑÏöî)", "system-error");
        return Promise.resolve({ ok: false, status: 503, statusText: "Service Unavailable", json: async () => ({ text: "Ïò§Î•ò: ÏùëÎãµ Ï≤òÎ¶¨ Î∂àÍ∞Ä."}) });
      });
      const getFirstQuestion = window.LOZEE_DIALOG?.getFirstQuestion || ((userAge, topic) => {
        console.error("getFirstQuestion ÏÇ¨Ïö© Î∂àÍ∞Ä (gpt-dialog.js Î°úÎìú Ïã§Ìå®).");
        appendBubble("Ïò§Î•ò: ÎåÄÌôî ÏãúÏûë ÏßàÎ¨∏ÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§. (gpt-dialog.js ÌôïÏù∏ ÌïÑÏöî)", "system-error");
        return "Ïò§Î•ò: ÎåÄÌôî ÏãúÏûë Î∂àÍ∞Ä.";
      });

      const trackTime = window.LOZEE_ANALYSIS?.trackTime || (() => console.warn("trackTime ÏÇ¨Ïö© Î∂àÍ∞Ä."));
      const trackEmotionTone = window.LOZEE_ANALYSIS?.trackEmotionTone || (() => console.warn("trackEmotionTone ÏÇ¨Ïö© Î∂àÍ∞Ä."));
      const trackSituation = window.LOZEE_ANALYSIS?.trackSituation || (() => console.warn("trackSituation ÏÇ¨Ïö© Î∂àÍ∞Ä."));
      const renderLiteracyAnalysis = window.LOZEE_ANALYSIS?.renderLiteracyAnalysis || ((result, elId) => {
          console.warn("renderLiteracyAnalysis ÏÇ¨Ïö© Î∂àÍ∞Ä.");
          const el = document.getElementById(elId);
          if(el) { el.innerHTML = ""; el.style.display = 'none'; }
      });

      // --- DOM ÏöîÏÜå Ï∞∏Ï°∞ ---
      const chatInput     = document.getElementById('chat-input');
      const sendButton    = document.getElementById('send-button');
      const micButton     = document.getElementById('mic-button');
      const meterLevel    = document.getElementById('volume-level');
      const menuToggle    = document.getElementById('menu-toggle');
      const dropdownMenu  = document.getElementById('dropdown-menu');

      // --- GNB Î©îÎâ¥ ÌÜ†Í∏Ä ---
      if (menuToggle && dropdownMenu) {
        menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
        document.addEventListener('click', (event) => {
          const gnb = document.getElementById('gnb');
          if (gnb && !gnb.contains(event.target) && dropdownMenu.classList.contains('show')) {
            dropdownMenu.classList.remove('show');
          }
        });
      }

      // --- Ïò§ÎîîÏò§ Î∂ÑÏÑù Î∞è ÏãúÍ∞ÅÌôî ---
      let audioContext, analyser, microphoneSource, dataArray, volumeMeterAnimationId, analyserStream;
      const LOW_COLOR = { r: 0, g: 200, b: 0 }, MID_COLOR = { r: 255, g: 200, b: 0 }, HIGH_COLOR = { r: 255, g: 69, b: 0 };
      function interpolateColor(c1,c2,f){const r=Math.round(c1.r+f*(c2.r-c1.r)),g=Math.round(c1.g+f*(c2.g-c1.g)),b=Math.round(c1.b+f*(c2.b-c1.b));return `rgb(${r},${g},${b})`}
      function setupAudioAnalysis(stream){if(audioContext?.state!=='closed')audioContext?.close();audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=256;analyser.smoothingTimeConstant=0.3;microphoneSource=audioContext.createMediaStreamSource(stream);microphoneSource.connect(analyser);dataArray=new Uint8Array(analyser.frequencyBinCount);analyserStream=stream;drawVolumeMeter()}
      function drawVolumeMeter(){volumeMeterAnimationId=requestAnimationFrame(drawVolumeMeter);if(!analyser||!dataArray||!meterLevel)return;analyser.getByteFrequencyData(dataArray);let s=0;for(let i=0;i<dataArray.length;i++)s+=dataArray[i];let avgVol=dataArray.length>0?s/dataArray.length:0;let normVol=(avgVol/140)*100;normVol=Math.min(100,Math.max(0,normVol));meterLevel.style.width=normVol+'%';let activeCol;if(normVol<=50)activeCol=interpolateColor(LOW_COLOR,MID_COLOR,normVol/50);else activeCol=interpolateColor(MID_COLOR,HIGH_COLOR,(normVol-50)/50);const baseGradCol=getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim()||'#2a3340';meterLevel.style.background=`linear-gradient(to right, ${baseGradCol}, ${activeCol})`}
      function stopAudioAnalysis(){if(volumeMeterAnimationId)cancelAnimationFrame(volumeMeterAnimationId);volumeMeterAnimationId=null;if(microphoneSource)microphoneSource.disconnect();microphoneSource=null;if(analyserStream?.getTracks)analyserStream.getTracks().forEach(t=>t.stop());analyserStream=null;if(audioContext?.state!=='closed')audioContext.close().catch(e=>console.error("AudioContext close error:",e));audioContext=null;if(meterLevel){meterLevel.style.width='0%';meterLevel.style.background=getComputedStyle(document.documentElement).getPropertyValue('--volume-meter-default-bg').trim()}analyser=null;dataArray=null}

      // --- STT (ÏùåÏÑ± Ïù∏Ïãù) ÏÑ§Ï†ï ---
      let recognition, isRecognizing = false;
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

      function stopCurrentTTS() {
        if (isTTSRunning) {
            console.log("Î™ÖÏãúÏ†Å TTS Ï§ëÏßÄ (stopCurrentTTS Ìò∏Ï∂úÎê®)");
            // Î∞©Î≤ï 1: tts.jsÍ∞Ä Web Speech APIÎ•º ÏßÅÏ†ë ÏÇ¨Ïö©ÌïúÎã§Í≥† Í∞ÄÏ†ï
            if (speechSynthesis && typeof speechSynthesis.cancel === 'function') {
                speechSynthesis.cancel();
                console.log("speechSynthesis.cancel() Ìò∏Ï∂úÎê®.");
            }
            // Î∞©Î≤ï 2: tts.jsÍ∞Ä Audio Í∞ùÏ≤¥Î•º ÏÉùÏÑ±ÌïòÍ≥†, talk.htmlÏóêÏÑú Í∑∏ Í∞ùÏ≤¥Î•º Í¥ÄÎ¶¨ÌïòÎäî Í≤ΩÏö∞ (ÌòÑÏû¨Îäî currentTTSAudioElement ÏÇ¨Ïö© ÏïàÌï®)
            if (currentTTSAudioElement && typeof currentTTSAudioElement.pause === 'function') {
                currentTTSAudioElement.pause();
                currentTTSAudioElement.src = ''; // Î¶¨ÏÜåÏä§ Ìï¥Ï†ú
                console.log("currentTTSAudioElement.pause() Ìò∏Ï∂úÎê®.");
            }
            // Î∞©Î≤ï 3: tts.js ÎÇ¥Ïóê ÏûêÏ≤¥Ï†ÅÏù∏ Ï§ëÏßÄ Ìï®ÏàòÍ∞Ä ÏûàÍ≥†, LOZEE_TTS Í∞ùÏ≤¥Î•º ÌÜµÌï¥ ÎÖ∏Ï∂úÎêú Í≤ΩÏö∞
            // if (window.LOZEE_TTS && typeof window.LOZEE_TTS.stopPlayback === 'function') {
            //   window.LOZEE_TTS.stopPlayback();
            // }
            isTTSRunning = false;
            currentTTSAudioElement = null; // Í¥ÄÎ†® Í∞ùÏ≤¥ Ï∞∏Ï°∞ Ï¥àÍ∏∞Ìôî
            currentTTSUtterance = null;    // Í¥ÄÎ†® Í∞ùÏ≤¥ Ï∞∏Ï°∞ Ï¥àÍ∏∞Ìôî
            setLoading(false); // TTS Ï§ëÏßÄ Ïãú Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
        }
      }

      if (SpeechRec) {
        recognition = new SpeechRec();
        recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'ko-KR';
        if(micButton) micButton.disabled = false;

        recognition.onstart = () => {
          isRecognizing = true;
          stopCurrentTTS(); // ÏÇ¨Ïö©ÏûêÍ∞Ä Îßê ÏãúÏûë Ïãú, ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ TTS Ï§ëÏßÄ
          if(micButton) { micButton.textContent = 'üí¨'; micButton.classList.add('recording'); }
          console.log("üé§ STT ÏãúÏûë - TTS Ï§ëÏßÄ ÏãúÎèÑÎê®");
        };
        recognition.onend = () => {
          isRecognizing = false;
          if(micButton) { micButton.textContent = 'üé§'; micButton.classList.remove('recording'); }
          setLoading(false); stopAudioAnalysis(); console.log("üé§ STT Ï¢ÖÎ£å");
        };
        recognition.onresult = (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
          }
          if (finalTranscript) { handleUserText(finalTranscript); }
        };
        recognition.onerror = (event) => {
          console.error("‚ùå STT Ïò§Î•ò:", event.error);
          appendBubble(event.error === 'not-allowed'||event.error === 'service-not-allowed' ? "ÎßàÏù¥ÌÅ¨ ÏÇ¨Ïö© Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§." : "ÏùåÏÑ± Ïù∏Ïãù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", "system-error");
          isRecognizing = false;
          if(micButton) { micButton.textContent = 'üé§'; micButton.classList.remove('recording'); }
          setLoading(false); stopAudioAnalysis();
        };
      } else {
        console.warn("‚ö†Ô∏è ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
        if(micButton) { micButton.title = "ÏùåÏÑ± Ïù∏Ïãù ÎØ∏ÏßÄÏõê"; micButton.disabled = true; }
        appendBubble("ÏïåÎ¶º: ÏÇ¨Ïö© Ï§ëÏù∏ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.", "system-error");
      }

      if(micButton) {
        micButton.onclick = async () => {
          if (!SpeechRec) return;
          if (isTTSRunning) { // TTSÍ∞Ä Ïû¨ÏÉù Ï§ëÏù¥Î©¥
            console.log("TTS Ïû¨ÏÉù Ï§ëÏûÖÎãàÎã§. STTÎ•º ÏãúÏûëÌïòÍ∏∞ Ï†ÑÏóê TTSÎ•º Ï§ëÏßÄÌï©ÎãàÎã§.");
            stopCurrentTTS(); // TTSÎ•º Î®ºÏ†Ä Ï§ëÏßÄ
            // TTS Ï§ëÏßÄ ÌõÑ Î∞îÎ°ú STTÎ•º ÏãúÏûëÌï† ÏàòÎèÑ ÏûàÏúºÎÇò, ÏÇ¨Ïö©Ïûê Í≤ΩÌóòÏÉÅ Îã§Ïãú ÌÅ¥Î¶≠ Ïú†ÎèÑ
            // ÎòêÎäî ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ ÏûêÎèô ÏãúÏûë Îì± Í≥†Î†§ Í∞ÄÎä•
            // Ïó¨Í∏∞ÏÑúÎäî TTSÎßå Ï§ëÏßÄÌïòÍ≥† ÏÇ¨Ïö©ÏûêÏùò Îã§Ïùå ÌñâÎèô(ÎßàÏù¥ÌÅ¨ Î≤ÑÌäº Ïû¨ÌÅ¥Î¶≠)ÏùÑ Í∏∞Îã§Î¶ΩÎãàÎã§.
            return;
          }
          if (isRecognizing) {
            recognition.stop();
          } else {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              setupAudioAnalysis(stream); recognition.start(); setLoading(true);
            } catch (err) {
              console.error("‚ùå ÎßàÏù¥ÌÅ¨ Í∂åÌïú/ÏãúÏûë Ïò§Î•ò:", err); appendBubble("ÎßàÏù¥ÌÅ¨Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.", "system-error"); stopAudioAnalysis(); setLoading(false);
            }
          }
        };
      }

      // --- ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∞è ÎåÄÌôî Ï¥àÍ∏∞Ìôî ---
      localStorage.removeItem('lozee_conversation_history');

      const lsSelectedVoice = localStorage.getItem('lozee_selectedVoice') || DEFAULT_VOICE;
      const userAge = localStorage.getItem('lozee_userage');
      const userName = localStorage.getItem('lozee_username') || 'ÏπúÍµ¨';
      const userId = localStorage.getItem('lozee_userid') || `user_${Date.now()}`;
      const userDisease = JSON.parse(localStorage.getItem('lozee_userdisease') || '[]');
      let chatHistory = JSON.parse(localStorage.getItem('lozee_conversation_history') || '[]');
      
      const params = new URLSearchParams(location.search);
      const incomingTopicId   = params.get('topic');
      const incomingTopicText = params.get('topicText');
      const currentSelectedTopic = { 
        id: incomingTopicId, 
        displayText: incomingTopicText || JSON.parse(localStorage.getItem('selectedTopic'))?.displayText || '',
        type: JSON.parse(localStorage.getItem('selectedTopic'))?.type || 'else'
      };

      // chatHistory.forEach(msg => appendBubble(msg.content, msg.role)); // Ï¥àÍ∏∞ÌôîÎ°ú Ïù∏Ìï¥ Ïã§Ìñâ Ïïà Îê®

      if(typeof trackTime === 'function') trackTime();

      if (currentSelectedTopic.id && chatHistory.length === 0) {
        await initConversation(currentSelectedTopic);
      } else if (chatHistory.length === 0) {
        if (typeof getFirstQuestion === 'function') {
             const initialTopic = {displayText: "Ïò§Îäò ÏûàÏóàÎçò Ïùº", type: "else"};
             localStorage.setItem('selectedTopic', JSON.stringify(initialTopic));
             const initialPrompt = getFirstQuestion(userAge, initialTopic);
             if (initialPrompt && !initialPrompt.startsWith("Ïò§Î•ò:")) {
                appendBubble(initialPrompt, 'bot');
                chatHistory.push({ role: 'bot', content: initialPrompt, timestamp: new Date().toISOString() });
                localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
                if(typeof playTTSFromText === 'function') await playTTSWithControl(initialPrompt, lsSelectedVoice);
             }
        } else {
            appendBubble("ÏïàÎÖïÌïòÏÑ∏Ïöî! ÎåÄÌôî Í∏∞Îä•ÏùÑ Ï¥àÍ∏∞ÌôîÌïòÎäî Îç∞ Î¨∏Ï†úÍ∞Ä ÏûàÏñ¥ ÎåÄÌôîÎ•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.", "system-error");
        }
      }

      function setLoading(flag) {
        if(sendButton) sendButton.disabled = flag;
        if (SpeechRec && micButton) {
            // Î°úÎî© Ï§ëÏù¥Í±∞ÎÇò, TTSÍ∞Ä Ïû¨ÏÉù Ï§ëÏù¥Í±∞ÎÇò, Ïù¥ÎØ∏ STTÍ∞Ä Ïù∏Ïãù Ï§ëÏùº Îïå ÎßàÏù¥ÌÅ¨ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            micButton.disabled = flag || isTTSRunning || isRecognizing;
        } else if(micButton) {
            micButton.disabled = true;
        }
        if(sendButton) sendButton.classList.toggle('loading', flag);
      }

      async function initConversation(topicForInit) {
        setLoading(true);
        const prompt = getFirstQuestion(userAge, topicForInit);
        if (prompt && !prompt.startsWith("Ïò§Î•ò:")) {
            appendBubble(prompt, 'bot');
            chatHistory.push({ role: 'bot', content: prompt, timestamp: new Date().toISOString() });
            localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
            try { 
              if(typeof playTTSFromText === 'function') {
                await playTTSWithControl(prompt, lsSelectedVoice); 
              }
            }
            catch (ttsError) { console.error("TTS Ïò§Î•ò (Ï¥àÍ∏∞ ÎåÄÌôî):", ttsError); }
        }
        setLoading(false);
      }

      async function handleUserText(text) {
        if (!text.trim()) return;
        stopCurrentTTS(); // ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Ï≤òÎ¶¨ Ï†Ñ, Í∏∞Ï°¥ TTS Ï§ëÏßÄ
        document.querySelector('.bubble.user.interim')?.remove();
        appendBubble(text, 'user');
        chatHistory.push({ role: 'user', content: text, timestamp: new Date().toISOString() });
        localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
        setLoading(true);
        let res;
        try {
          res = await getGptResponse(text, {
            userId, userAge, userName, userDisease,
            chatHistory: chatHistory.slice(-10),
            selectedTopic: currentSelectedTopic
          });

          if (!res.ok) { // API ÏùëÎãµ Ïã§Ìå® Ï≤òÎ¶¨ (400 Ïò§Î•ò Îì±)
            console.error(`API Error: ${res.status} ${res.statusText}.`);
            let errorData = { text: `ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò (${res.status}). Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`};
            try { 
                const resText = await res.text(); // Î®ºÏ†Ä ÌÖçÏä§Ìä∏Î°ú Î∞õÍ≥†
                console.error("Raw API Error Text:", resText); 
                errorData = JSON.parse(resText); // Í∑∏ Îã§ÏùåÏóê JSON ÌååÏã± ÏãúÎèÑ
                console.error("API Error Body (JSON Parsed):", errorData);
            } catch (e) { 
                // JSON ÌååÏã± Ïã§Ìå® Ïãú errorData.textÎäî Ïù¥ÎØ∏ ÏÑ§Ï†ïÎêú Í∞íÏùÑ ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò, resTextÎ•º ÏùºÎ∂Ä ÏÇ¨Ïö©
                if(typeof res.text === 'function') { // res.text()Í∞Ä Ìï®ÏàòÏù∏ÏßÄ ÌôïÏù∏ ÌõÑ Ìò∏Ï∂ú (ÏïàÏ†ÑÏû•Ïπò)
                    const rawErrorText = await res.text().catch(() => "Ïò§Î•ò ÏùëÎãµ Î≥∏Î¨∏ ÏùΩÍ∏∞ Ïã§Ìå®.");
                    errorData.text = rawErrorText.substring(0,150) || `ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò (${res.status})`;
                }
            }
            appendBubble(errorData.text || `API ÏöîÏ≤≠ Ïã§Ìå®: ${res.status}`, 'bot');
            chatHistory.push({ role: 'system', content: `API Ïò§Î•ò: ${res.status}`, error: errorData, timestamp: new Date().toISOString() });
            setLoading(false); return;
          }

          const data = await res.json();
          console.log("GPT API ÏùëÎãµ:", data);
          const botMessage = data?.rephrasing || data?.text || "ÏùëÎãµÏùÑ Î∞õÏßÄ Î™ªÌñàÏñ¥Ïöî.";
          appendBubble(botMessage, 'bot');
          const botResponseEntry = { role: 'bot', content: botMessage, timestamp: new Date().toISOString() };
          if (data.analysis) {
            console.log("üí° Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞:", data.analysis);
            botResponseEntry.analysis = data.analysis;
            if (typeof renderLiteracyAnalysis === 'function' && analysisContainer && data.analysis.literacy) {
               renderLiteracyAnalysis(data.analysis.literacy, 'analysis-container');
            } else if (analysisContainer) {
                analysisContainer.innerHTML = '';
                analysisContainer.style.display = 'none';
            }
          } else {
             if (analysisContainer) {
                analysisContainer.innerHTML = '';
                analysisContainer.style.display = 'none';
            }
          }
          chatHistory.push(botResponseEntry);
          localStorage.setItem('lozee_conversation_history', JSON.stringify(chatHistory));
          if(typeof playTTSFromText === 'function') {
             await playTTSWithControl(botMessage, lsSelectedVoice);
          }
        } catch (err) {
          console.error("‚ùå Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:", err);
          if(res) console.error("Ïò§Î•ò ÏãúÏ†ê API ÏùëÎãµ Í∞ùÏ≤¥ (res):", {status: res.status, ok: res.ok});
          appendBubble("Ï£ÑÏÜ°Ìï¥Ïöî, Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù.", 'bot');
          chatHistory.push({ role: 'system', content: 'ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï≤òÎ¶¨ Ïò§Î•ò', error: err.message, timestamp: new Date().toISOString() });
        }
        setLoading(false); if(chatInput) chatInput.value = ''; if(chatInput) chatInput.focus();
      }

      if(sendButton) sendButton.onclick = () => { if(chatInput) handleUserText(chatInput.value); };
      if(chatInput) chatInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserText(chatInput.value); } };
    }
  </script>
</body>
</html>
