<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOZEE ÎåÄÌôî</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; background: #fff; color: #333; font-family: 'KoPubWorld Dotum', sans-serif; }
    #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; font-size: 16px; white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user { background-color: #fff9c4; color: #333; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .ai { background-color: #0095FF; color: #fff; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 5px; }
    #loading-indicator { text-align: center; padding: 10px; display: none; color: #555; font-style: italic; }
    #talk-btn-container { text-align: center; padding: 15px; border-top: 1px solid #eee; background: #fafafa; }
    #talk-btn { width: 80px; height: 80px; border-radius: 50%; background: #b6b6b6; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); color: #fff; font-size: 36px; cursor: pointer; transition: transform .2s, background-color .3s; }
    #talk-btn.recording { background: #e06c75; transform: scale(1.1); }
    #talk-btn.active { background: #0095FF; transform: scale(1.1); }
  </style>
</head>
<body>
  <div id="chat-window"></div>
  <div id="loading-indicator">AI ÏùëÎãµ Ï§ÄÎπÑ Ï§ë...</div>
  <div id="talk-btn-container">
    <button id="talk-btn" aria-label="ÎßêÌïòÍ∏∞">üé§</button>
  </div>

  <script type="module">
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    import { getGptResponse, getInitialGreeting } from './js/gpt-dialog.js';

    const chatWindow = document.getElementById('chat-window');
    const talkBtn     = document.getElementById('talk-btn');
    const loading     = document.getElementById('loading-indicator');

    let isRecording = false;
    let mediaRecorder, mediaStream, audioChunks = [];
    let firstDone = false;
    const MAX_MS = 30000;

    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function toggleLoading(state) {
      loading.style.display = state ? 'block' : 'none';
      talkBtn.disabled = state;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // 1) Greeting
      const userName = localStorage.getItem('lozee_username') || 'ÏπúÍµ¨';
      const hello = await getInitialGreeting(userName);
      appendMessage(hello, 'ai');

      // 2) IndexÏóêÏÑú ÏûÖÎ†•Îêú Ï≤´ Î©îÏãúÏßÄ
      const intro = localStorage.getItem('lozee_user_typed_intro');
      if (intro) {
        appendMessage(intro, 'user');
        toggleLoading(true);
        try {
          const ai = await getGptResponse(intro);
          appendMessage(ai, 'ai');
          await playTTSFromText(ai);
        } catch {
          appendMessage('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'ai');
        } finally {
          toggleLoading(false);
        }
        localStorage.removeItem('lozee_user_typed_intro');
        firstDone = true;
      }

      // 3) ÎßàÏù¥ÌÅ¨ Î≤ÑÌäº ÌÅ¥Î¶≠
      talkBtn.addEventListener('click', async () => {
        if (!firstDone) {
          firstDone = true;
          toggleLoading(true);
          await playTTSFromText(hello);
          toggleLoading(false);
          return;
        }
        isRecording ? stopRecording() : startRecording();
      });
    });

    async function startRecording() {
      isRecording = true; audioChunks = [];
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = processAudio;
      mediaRecorder.start();
      talkBtn.classList.add('recording');
      setTimeout(() => isRecording && stopRecording(), MAX_MS);
    }

    function stopRecording() {
      isRecording = false;
      mediaRecorder.stop();
      mediaStream.getTracks().forEach(t => t.stop());
      talkBtn.classList.remove('recording');
    }

    async function processAudio() {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      appendMessage('‚Ä¶', 'user');
      toggleLoading(true);
      try {
        const text = await getSTTFromAudio(blob);
        chatWindow.lastChild.textContent = text;
        const ai = await getGptResponse(text);
        appendMessage(ai, 'ai');
        await playTTSFromText(ai);
      } catch {
        appendMessage('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'ai');
      } finally {
        toggleLoading(false);
      }
    }
  </script>
</body>
</html>
