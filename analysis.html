<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE와 함께하는 마음 탐험!</title>
    <link
        href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" href="gnb.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* analysis.html 페이지 고유 스타일 */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #ffffff; /* body 배경을 흰색으로 통일 */
            --text-color: #333333;
            --card-bg-analysis: #ffffff; /* 카드 배경도 흰색으로 */
            --explanation-bg-analysis: #eef2f7; /* 설명 영역 배경은 연한 파랑 */
            --primary-color-analysis: var(--primary-color); /* h1 제목 등에 사용될 색상 */
            --gnb-height: 56px;
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color); /* :root 변수 사용 */
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width:900px;
            margin:25px auto;
            padding:0 25px;
            box-sizing: border-box;
        }
        h1 { /* 페이지 메인 타이틀 */
            color: var(--primary-color-analysis);
            text-align: center;
            font-size: 2em;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .share-button-container {
            text-align: center;
            margin-bottom: 30px;
        }
        #reportShareButton {
            background-color: var(--primary-color); /* :root 변수 사용 */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #reportShareButton:hover {
            background-color: var(--secondary-color); /* :root 변수 사용 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .assistant-analysis-notice {
            font-size: 0.75em;
            color: #78909c;
            margin-top: -12px;
            margin-bottom: 15px;
            text-align: right;
        }
        .module-explanation {
            font-size:0.9em;
            color:#555;
            margin-bottom:15px;
            padding: 10px;
            background-color: var(--explanation-bg-analysis);
            border-radius: 6px;
            line-height: 1.6;
        }

        h2 { /* 각 섹션 제목 */
            margin-top:0;
            margin-bottom: 8px;
            font-size:1.5em;
            color:#34495e; /* 남색 계열 */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
        }
        .section {
            background:var(--card-bg-analysis);
            padding:25px;
            margin-top:25px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.08);
        }
        .section p {
            color: #555555;
            line-height: 1.7;
            font-size: 1em;
        }
        .section p span { /* 현재 코드에는 없지만, 강조용으로 추가 가능 */
            color: var(--secondary-color);
            font-weight: bold;
        }
        .feedback {
            margin-top:15px;
            padding:12px 18px;
            border-left-width:5px;
            border-left-style:solid;
            border-radius:8px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .feedback.negative { background:#ffebee; border-left-color: #c62828; color:#c62828; }
        .feedback.positive { background:#e8f5e9; border-left-color: #2e7d32; color:#2e7d32; }
        .feedback.neutral { background:#eceff1; border-left-color: #546e7a; color:#37474f; }

        #emotionChartContainer {
            position: relative;
            max-width: 450px;
            min-height: 100px;
            height: auto;
            margin: 20px auto 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #emotionChart, #situationChart { /* #situationChart는 현재 사용 안함 */
            width:100% !important;
            height:auto !important;
            aspect-ratio: 1 / 1; /* 정사각형 비율 유지 */
            background-color: #fdfdfd;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            box-sizing: border-box;
            display: none; /* JS로 표시 */
        }
        #tagCloud { min-height:100px; border:1px dashed #cccccc; padding:15px; margin-top: 20px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
        .badge { display:inline-block; margin:4px; padding:8px 12px; background:#e8eaf6; color: #3f51b5; border-radius:16px; font-size:0.9em; transition: background-color 0.2s, color 0.2s; font-weight: 500; }
        .badge:hover { background-color: #c5cae9; color: #303f9f; }
        #patternDashboard { margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; color: #444; min-height: 50px; }
        #patternDashboard p { color: #444; margin-bottom: 8px; } /* 기존 스타일과 중복될 수 있으나 명시 */
        #situationAlerts { margin-top: 15px; min-height: 50px; }
        #situationAlerts .cognitive-distortion-item { background:#fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9em; }
        .footer-assistant-notice { text-align: center; margin-top: 40px; margin-bottom: 20px; font-size: 0.8em; color: #78909c; }
        .methodology-list { list-style-type: none; padding-left: 0; font-size: 0.9em; color: #555; }
        .methodology-list li { margin-bottom: 12px; padding-left: 25px; position: relative; }
        .methodology-list li::before { content: "💡"; color: var(--primary-color); /* :root 변수 사용 */ position: absolute; left: 0; font-size: 1.1em; }
        .methodology-list li strong { color: #34495e; }
        .action-button { display: inline-block; margin-top: 15px; background-color: var(--primary-color); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .action-button:hover { background-color: var(--secondary-color); }

        @media (max-width: 768px) { h1 { font-size: 1.7em; } h2 { font-size: 1.3em; } .section { padding: 20px; } #emotionChartContainer { max-width: 100%; } #emotionChart, #situationChart { aspect-ratio: 4 / 3; } .methodology-list { font-size: 0.85em; } }
        @media (max-width: 480px) { .container { margin: 15px auto; padding: 0 15px; } h1 { font-size: 1.5em; margin-bottom: 25px; } h2 { font-size: 1.2em; } .section { padding: 15px; margin-top: 20px;} .section p { font-size: 0.95em; } .feedback { padding: 10px 15px; font-size: 0.9em;} #emotionChartContainer { max-width: 100%; } #emotionChart, #situationChart { aspect-ratio: 1 / 1; } .badge { font-size: 0.85em; padding: 6px 10px;} .assistant-analysis-notice { font-size: 0.7em; } .methodology-list { font-size: 0.8em; } }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a>
          <a href="index.html">✨ 새로운 이야기 시작!</a>
          <a href="analysis.html">📊 우리 이야기 분석</a> <a href="journal-list.html">📖 이야기 모음집</a>
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a>
        </div>
    </nav>

    <div class="container">
        <h1>🚀 로지와 함께한 이야기 탐험!</h1>
        <div class="share-button-container">
            <button id="reportShareButton">나의 이야기 보고서 공유하기 🔗</button>
        </div>

        <div class="section" id="languageAgeSection" style="display:none;">
            <h2>🗣️ 내 말솜씨 나이는 몇 살일까?</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                로지와 이야기하면서 네가 사용한 말들을 보고, 네 말솜씨가 몇 살 친구랑 비슷한지 알려줄게! 실제 나이랑 달라도 괜찮아, 함께 더 멋지게 말하는 법을 배우면 되니까! 😉
            </p>
            <p class="module-explanation" style="font-size: 0.85em; background-color: #e3f2fd; color: #1e88e5;">
                <strong>[로지의 약속!]</strong> 언어 분석은 총 3단계로 점점 더 정확해져! <br>
                <strong>1단계(30분~)</strong>: 우리가 처음 만나서 나눈 이야기로 살짝 엿보기! <br>
                <strong>2단계(2시간~)</strong>: 좀 더 많은 이야기를 나누면 로지가 너를 더 잘 알게 돼! <br>
                <strong>3단계(6시간~)</strong>: 와! 이제 정말 너의 멋진 말솜씨를 잘 알 것 같아! (가장 정확한 분석)
            </p>
            <p>내 진짜 나이: <span id="realAge">정보 없음</span>살</p>
            <p>내 말솜씨 나이 (로지의 생각): <span id="predictedLangAge">분석 중...</span> <span id="ageDifferenceVisual" style="font-weight:normal; margin-left: 8px;"></span></p>
            <div id="ageFeedback" class="feedback" style="display:none;"></div>
            <button id="languagePracticeBtn" class="action-button" style="display:none;">로지와 함께 말솜씨 키우기 쑥쑥! 🌱 (준비 중)</button>
        </div>

        <div class="section" id="emotionToneSection">
            <h2>🌈 내 마음 색깔은 뭘까? (감정 변화)</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                우리가 나눈 이야기에서 어떤 느낌들이 많았는지, 또 어떤 단어들을 자주 사용했는지 보여줄게! 네 마음속 날씨를 함께 알아보자! ☀️🌧️
            </p>
            <div id="emotionChartContainer"> <canvas id="emotionChart"></canvas>
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p>
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="patternSection">
            <h2>🔍 자주 나타나는 내 마음 &amp; 단어</h2> <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                이야기하다 보면 나도 모르게 자주 쓰는 말이나 비슷한 느낌을 표현할 때가 있어. 로지가 그런 부분을 찾아봤어!
            </p>
            <div id="patternDashboard"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>🧐 생각 탐험! (나의 생각 습관)</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                여기는 우리가 나눈 이야기를 요약하고, 혹시 네 생각이 한쪽으로만 기울어지지는 않았는지(이걸 '생각 습관'이라고 불러볼까?), 어떤 특별한 점이 있는지 살펴보는 곳이야. 특별한 생각 습관이 보여도 걱정하지 마! 누구나 그럴 수 있고, 우리는 이야기하면서 함께 더 유연하게 생각하는 방법을 찾을 수 있어! 💪
            </p>
            <canvas id="situationChart" style="display:none;"></canvas>
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">이 생각에 대해 다음에 더 이야기 나눠볼까? 🤔</button>
        </div>

        <div class="section" id="analysisMethodologySection">
             <h2>LOZEE의 분석 방법론</h2>
             <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <ul class="methodology-list">
                <li><strong>Russell의 감정 원형 모형</strong>: Valence(쾌-불쾌)와 Arousal(각성-이완) 축을 기반으로 감정의 위치를 다차원적으로 분석합니다.</li>
                <li><strong>Plutchik의 감정 바퀴</strong>: 8가지 기본 감정과 그 강도 및 유사성을 바탕으로 복합적인 감정 상태를 이해합니다.</li>
                <li><strong>Lexicon 기반 감성 분석</strong>: 한국어 감성 사전(예: KOSAC)을 활용하여 텍스트의 긍정, 부정, 중립 극성을 판단합니다.</li>
                <li><strong>딥러닝 분류 모델 (BERT/KoBERT)</strong>: 최신 자연어 처리 모델을 사용하여 문맥을 고려한 고정밀 감정 극성 및 세부 감정(예: 기쁨, 슬픔, 분노 등)을 분류합니다.</li>
                <li><strong>인지왜곡 이론 (Beck의 CBT)</strong>: 인지행동치료 이론에 기반하여 대화에서 나타날 수 있는 대표적인 인지왜곡 패턴(예: 흑백논리, 과잉일반화 등)을 감지합니다.</li>
                <li><strong>대화 주제 구조화</strong>: LOZEE AI의 자체 상담 토픽 데이터를 활용하여 대화의 흐름과 주요 주제를 체계적으로 파악하고 관련 피드백을 제공합니다.</li>
            </ul>
        </div>

        <p class="footer-assistant-notice">본 분석은 로지 AI가 마음을 담아 준비했어요. 개인적인 성찰을 위한 참고 자료로 활용해주세요.</p>
    </div>

    <script type="module">
        let chartLibraryInitialized = false;

        function initializeChartJsGlobal() {
            // ... (이전과 동일) ...
        }

        // 이 페이지에서는 getKoreanVocativeParticle 함수가 직접 필요하지 않으므로 제거 가능
        // function getKoreanVocativeParticle(name) { /* ... */ }


        document.addEventListener('DOMContentLoaded', () => {
            console.log("Analysis Page: DOMContentLoaded 이벤트 시작");
            const chartJsIsReady = initializeChartJsGlobal();

            // --- DOM 요소 가져오기 ---
            const languageAgeSection = document.getElementById('languageAgeSection');
            const realAgeEl = document.getElementById('realAge');
            const predictedLangAgeEl = document.getElementById('predictedLangAge');
            const ageFeedbackEl = document.getElementById('ageFeedback');
            const ageDifferenceVisualEl = document.getElementById('ageDifferenceVisual');
            const languagePracticeBtn = document.getElementById('languagePracticeBtn');

            const emotionChartEl = document.getElementById('emotionChart');
            const emotionChartContainerEl = document.getElementById('emotionChartContainer');
            const empathyMessageEl = document.getElementById('empathyMessage');
            const tagCloudEl = document.getElementById('tagCloud');

            const patternDashboardEl = document.getElementById('patternDashboard');
            const patternSection = document.getElementById('patternSection'); // patternSection DOM 요소 추가

            const situationAlertsEl = document.getElementById('situationAlerts');
            const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
            const situationSection = document.getElementById('situationSection'); // situationSection DOM 요소 추가

            const reportShareButton = document.getElementById('reportShareButton');
            const containerEl = document.querySelector('.container');

            // --- 데이터 로드 ---
            // loggedInUserId는 이 페이지에서 직접 사용하지 않음. 필요한 정보는 localStorage에서 직접 가져옴.
            const userAge = parseInt(localStorage.getItem('lozee_userage'), 10) || 0;
            if(realAgeEl) realAgeEl.textContent = userAge > 0 ? userAge : "정보 없음"; // 실제 나이 표시
            console.log("Analysis Page - User Age:", userAge);

            const analysisDataString = localStorage.getItem('lozee_conversation_analysis');
            let analysisResults = null;
            let accumulatedDurationMinutes = 0;

            if (!analysisDataString) {
                console.warn("Analysis Page: localStorage에 'lozee_conversation_analysis' 데이터가 없습니다.");
                if (containerEl) {
                    // 분석 방법론 섹션을 제외한 모든 분석 관련 섹션 숨기기
                    document.querySelectorAll('.section:not(#analysisMethodologySection)').forEach(sec => {
                        if(sec && sec.id !== 'analysisMethodologySection') sec.style.display = 'none';
                    });
                     if (!containerEl.querySelector('.no-data-message')) { // 중복 방지
                        const noDataMsgDiv = document.createElement('div');
                        noDataMsgDiv.className = 'feedback neutral no-data-message'; // CSS 클래스 활용
                        noDataMsgDiv.style.textAlign = 'center';
                        noDataMsgDiv.style.marginTop = '20px';
                        noDataMsgDiv.innerHTML = '<h2>아직 로지와 나눈 이야기가 충분하지 않나 봐요! 😮</h2><p>먼저 로지와 신나게 이야기하고 분석 결과를 확인해보세요!</p>';
                        const methodologySection = document.getElementById('analysisMethodologySection');
                        let referenceNodeForMessage = methodologySection; // 기본적으로 방법론 섹션 앞에 삽입 시도

                        // 더 나은 위치 찾기: h1 다음, 또는 첫 번째 .section 앞에
                        const pageH1 = containerEl.querySelector('h1');
                        if (pageH1 && pageH1.nextElementSibling) {
                             referenceNodeForMessage = pageH1.nextElementSibling; // 공유 버튼 컨테이너 다음
                             if (referenceNodeForMessage.nextElementSibling) { // 첫번째 섹션이 있다면 그 앞에
                                referenceNodeForMessage = referenceNodeForMessage.nextElementSibling;
                             }
                        }

                        if (referenceNodeForMessage && referenceNodeForMessage.parentElement === containerEl) {
                            containerEl.insertBefore(noDataMsgDiv, referenceNodeForMessage);
                        } else { // 최후의 수단
                             containerEl.appendChild(noDataMsgDiv);
                        }
                    }
                }
                return;
            }

            // 중복된 try-catch 블록 수정
            try {
                const fullAnalysis = JSON.parse(analysisDataString);
                analysisResults = fullAnalysis.results;
                accumulatedDurationMinutes = parseFloat(fullAnalysis.accumulatedDurationMinutes) || 0;
            } catch (e) {
                console.error("저장된 분석 결과 파싱 오류:", e);
                if (containerEl) containerEl.innerHTML = '<h1>앗! 분석 결과를 불러오는 데 문제가 생겼어요 😥</h1><p style="text-align:center;">이전 대화로 돌아가거나, 잠시 후 다시 시도해주세요.</p>';
                return;
            }

            if (!analysisResults) {
                console.warn("Analysis Page: 파싱 후 analysisResults 객체가 null입니다.");
                // languageAgeSection은 이미 위에서 처리되었을 수 있음. 다른 섹션도 데이터 없음 처리 필요 시 추가.
                 if(emotionToneSection) emotionToneSection.innerHTML = '<p style="text-align:center;color:#777;">감정 분석 데이터가 없어요.</p>';
                 if(patternSection) patternSection.innerHTML = '<p style="text-align:center;color:#777;">패턴 분석 데이터가 없어요.</p>';
                 if(situationSection) situationSection.innerHTML = '<p style="text-align:center;color:#777;">생각 탐험 데이터가 없어요.</p>';
                return;
            }

            // --- 각 분석 섹션 렌더링 ---

            // 1. 언어·나이 분석 (12세 이하 사용자에게만 표시)
            if (languageAgeSection) {
                if (userAge > 0 && userAge <= 12 && analysisResults.ageLanguageAnalysis) {
                    languageAgeSection.style.display = 'block';
                    const langAnalysis = analysisResults.ageLanguageAnalysis;

                    // 누적 대화 시간에 따른 분기 처리 (기존 로직 유지)
                    // ... (이전 답변의 if (accumulatedDurationMinutes < 30) { ... } else if ... 등 코드 전체) ...
                    if (accumulatedDurationMinutes < 30) {
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = "...";
                        if (ageDifferenceVisualEl) ageDifferenceVisualEl.textContent = "";
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = "언어 분석을 받으려면 누적 30분 이상 대화해야 합니다 😊"; ageFeedbackEl.className = 'feedback neutral'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn) languagePracticeBtn.style.display = 'none';
                    } else if (accumulatedDurationMinutes < 120) { // 1단계
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = langAnalysis.stage1PredictedAge || "분석 준비 중";
                        if (ageDifferenceVisualEl && langAnalysis.stage1DifferenceSymbol && langAnalysis.stage1DifferenceText) ageDifferenceVisualEl.innerHTML = `${langAnalysis.stage1DifferenceSymbol} <span style="font-size:0.8em; margin-left:4px;">(${langAnalysis.stage1DifferenceText})</span>`;
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = langAnalysis.stage1Feedback || "30분 넘게 이야기해줘서 고마워! 언어 분석을 시작할게."; ageFeedbackEl.className = 'feedback positive'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn) languagePracticeBtn.style.display = 'none'; // 또는 'inline-block'으로 변경
                    } else if (accumulatedDurationMinutes < 300) { // 2단계 (예시에서는 300분=5시간으로 되어 있으나, 이전에는 360분=6시간이었음. 일관성 확인 필요)
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = langAnalysis.stage2PredictedAge || "분석 준비 중";
                        if (ageDifferenceVisualEl && langAnalysis.stage2DifferenceSymbol && langAnalysis.stage2DifferenceText) ageDifferenceVisualEl.innerHTML = `${langAnalysis.stage2DifferenceSymbol} <span style="font-size:0.8em; margin-left:4px;">(${langAnalysis.stage2DifferenceText})</span>`;
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = langAnalysis.stage2Feedback || "2시간 넘게 이야기했네! 더 깊은 분석 결과를 보여줄게."; ageFeedbackEl.className = 'feedback neutral'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn && langAnalysis.stage2PredictedAge) languagePracticeBtn.style.display = 'inline-block'; // 2단계부터 연습 버튼 표시
                    } else { // 3단계
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = langAnalysis.stage3PredictedAge || "분석 준비 중";
                        if (ageDifferenceVisualEl && langAnalysis.stage3DifferenceSymbol && langAnalysis.stage3DifferenceText) ageDifferenceVisualEl.innerHTML = `${langAnalysis.stage3DifferenceSymbol} <span style="font-size:0.8em; margin-left:4px;">(${langAnalysis.stage3DifferenceText})</span>`;
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = langAnalysis.stage3Feedback || "5시간 넘게 이야기해줘서 정말 고마워! 가장 정확한 분석을 보여줄게."; ageFeedbackEl.className = 'feedback positive'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn && langAnalysis.stage3PredictedAge) languagePracticeBtn.style.display = 'inline-block';
                    }

                } else {
                    languageAgeSection.style.display = 'none';
                }
            }


            // 2. 감정 어조 및 태그 클라우드
            const emotionToneSection = document.getElementById('emotionToneSection'); // DOM 요소 참조 확인
            if (emotionToneSection) {
                if (chartJsIsReady && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                    if(emotionChartEl) emotionChartEl.style.display = 'block';
                    if(emotionChartContainerEl && emotionChartContainerEl.querySelector('.no-chart-message')) {
                         emotionChartContainerEl.querySelector('.no-chart-message').remove();
                    }
                    renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                    if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                } else {
                    if(emotionChartEl) emotionChartEl.style.display = 'none';
                    if(emotionChartContainerEl && !emotionChartContainerEl.querySelector('.no-chart-message')) {
                        const noDataMsg = document.createElement('p');
                        noDataMsg.textContent = chartJsIsReady ? "분석이 쌓이면 여기에 마음 색깔 차트가 완성될 거야! 😊" : "차트 기능을 불러오지 못했어요. 😥";
                        noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888'; noDataMsg.classList.add('no-chart-message');
                        emotionChartContainerEl.appendChild(noDataMsg);
                    }
                    if(empathyMessageEl) { empathyMessageEl.textContent = "아직은 네 마음속 감정들을 자세히 알기 어려워. 로지랑 더 많은 이야기를 나눠보자!"; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; }
                }
                if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                     // renderTagCloud는 tags가 [{text:"키워드", weight: 숫자}] 형태를 기대함
                    if(tagCloudEl) renderTagCloud('tagCloud', analysisResults.keywords.map(kw => ({ text: kw, weight: Math.floor(5 + Math.random() * 10) })));
                } else { if(tagCloudEl) tagCloudEl.innerHTML = '<p style="text-align:center; color:#888;">이야기 속에서 자주 나온 단어들을 모으고 있어요!</p>';}
            }

            // 3. 반복 패턴
            if (patternSection) { // patternSection 변수가 위에서 정의되었는지 확인 필요
                if (analysisResults.patterns && analysisResults.patterns.length > 0) {
                    if(patternDashboardEl) renderPatternDashboard('patternDashboard', analysisResults.patterns);
                } else { if(patternDashboardEl) patternDashboardEl.innerHTML = '<p style="text-align:center; color:#888;">반복되는 이야기 패턴을 찾고 있어요!</p>';}
            }

            // 4. 상황 분석 (인지왜곡)
            if (situationSection) { // situationSection 변수가 위에서 정의되었는지 확인 필요
                const situationChartToHide = document.getElementById('situationChart'); // 이 차트는 현재 사용 안함
                if(situationChartToHide) situationChartToHide.style.display = 'none';

                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions);
                    if (continueDistortionTalkBtn) {
                        continueDistortionTalkBtn.style.display = 'inline-block';
                        continueDistortionTalkBtn.onclick = () => {
                            // "로지와의 약속" 생성 및 talk.html로 이어가기 로직 연결
                            createImprovementPlanIfNeeded(analysisResults, userAge); // 현재 userAge는 대화 대상의 나이
                            const plan = (JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]')).find(p => p.type === 'cognitive_distortion' && analysisResults.cognitiveDistortions.includes(p.details));
                            if (plan) {
                                const continueTopicData = {
                                    type: 'continue_improvement_plan',
                                    planType: plan.type,
                                    details: plan.topic || plan.details,
                                    prompt: plan.promptForContinuation || `"${plan.details}" 생각 패턴에 대해 더 이야기 나눠볼까요?`
                                };
                                localStorage.setItem('lozee_talk_init_topic', JSON.stringify(continueTopicData));
                                window.location.href = 'talk.html';
                            } else {
                                alert("이어갈 약속 정보를 생성하는 데 실패했습니다. 다시 시도해주세요.");
                            }
                        };
                    }
                } else {
                    if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';
                    if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                }
            }

            // 공유 버튼 로직
            if(reportShareButton) {
                reportShareButton.onclick = () => {
                    const reportId = (localStorage.getItem('lozee_username') || 'user') + "_" + new Date().getTime(); // 사용자 이름 사용
                    const shareableLink = `${window.location.origin}${window.location.pathname}?report_id=${reportId}`;
                    // 실제 보고서 저장 로직은 Firebase Functions 등을 통해 구현 필요
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(shareableLink)
                            .then(() => {
                                alert('공유 링크가 복사되었습니다!\n' + shareableLink + '\n(실제 공유를 위해서는 보고서 저장 기능이 필요합니다.)');
                            })
                            .catch(err => {
                                console.error('클립보드 복사 실패:', err);
                                alert('링크 복사에 실패했어요. 수동으로 복사해주세요:\n' + shareableLink);
                            });
                    } else {
                        prompt('아래 링크를 복사하여 공유하세요 (실제 공유 기능은 추가 구현 필요):', shareableLink);
                    }
                };
            }
             // 분석 결과 로드 후, "로지와의 약속" 생성 (필요시)
            if (analysisResults) {
                 createImprovementPlanIfNeeded(analysisResults, userAge);
            }

        }); // DOMContentLoaded 끝

        // --- 데이터 렌더링 함수들 ---
        // renderTagCloud, renderPatternDashboard, alertCognitiveDistortions,
        // renderEmotionChart, displayEmpathyMessage 함수는 여기에 위치합니다.
        // (이전 답변에서 제공된 완성된 함수 코드를 사용합니다)
        function renderTagCloud(elementId, tags) { const cloudEl = document.getElementById(elementId); if(!cloudEl) return; if(tags && tags.length > 0) { cloudEl.innerHTML = tags.map(tag => { const size = 0.8 + ((tag.weight || 5) / 15); const opacity = Math.max(0.5, (tag.weight || 5) / 10); return `<span class="badge" style="opacity:${opacity}; font-size:${size}em;">${tag.text}</span>`; }).join(''); } else { cloudEl.innerHTML = '<p style="text-align:center; color:#888;">이야기에서 자주 나온 단어들을 모으고 있어요!</p>'; } }
        function renderPatternDashboard(elementId, patterns) { const dashEl = document.getElementById(elementId); if(!dashEl) return; if(patterns && patterns.length > 0) { dashEl.innerHTML = patterns.map(p => `<p>💡 ${p}</p>`).join(''); } else { dashEl.innerHTML = '<p style="text-align:center; color:#888;">반복되는 이야기 패턴을 찾고 있어요!</p>'; } }
        function alertCognitiveDistortions(elementId, distortions) { const alertEl = document.getElementById(elementId); if(!alertEl) return; if(distortions && distortions.length > 0) { alertEl.innerHTML = distortions.map(d => `<p class="cognitive-distortion-item">${d}</p>`).join(''); } else { alertEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';} }
        function renderEmotionChart(canvasId, emotionData) {
            if (!chartLibraryInitialized || typeof Chart === 'undefined') { /* ... */ return; }
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            const chartContainer = document.getElementById('emotionChartContainer');
            const chartEl = document.getElementById(canvasId);
            if (!ctx) { /* ... */ return; }
            if (!emotionData || Object.keys(emotionData).length === 0) { /* ... */ return; }
            if(chartContainer) { const exMsg = chartContainer.querySelector('.no-chart-message') || chartContainer.querySelector('.no-chart-library-message'); if (exMsg) exMsg.remove(); if(chartEl) chartEl.style.display = 'block';}
            const existingChart = Chart.getChart(ctx); if (existingChart) { existingChart.destroy(); }
            const emotionColors = { '기쁨': 'rgba(255, 205, 86, 0.7)','슬픔': 'rgba(54, 162, 235, 0.7)','분노': 'rgba(255, 99, 132, 0.7)','불안': 'rgba(153, 102, 255, 0.7)','수치': 'rgba(255, 159, 64, 0.7)','중립': 'rgba(201, 203, 207, 0.7)'};
            const labels = Object.keys(emotionData); const dataValues = Object.values(emotionData);
            const backgroundColors = labels.map(label => emotionColors[label] || 'rgba(100,100,100,0.7)');
            new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ label: '나의 마음 비율', data: dataValues, backgroundColor: backgroundColors, borderColor: '#ffffff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: Chart.defaults.color, font: { family: Chart.defaults.font.family, size: 11 }, padding: 15 } }, tooltip: { titleFont: { family: Chart.defaults.font.family }, bodyFont: { family: Chart.defaults.font.family } } } } });
        }
        function displayEmpathyMessage(emotionData) {
            const empathyMessageEl = document.getElementById('empathyMessage');
            if (!empathyMessageEl || !emotionData || Object.keys(emotionData).length === 0) { if (empathyMessageEl) empathyMessageEl.style.display = 'none'; return; }
            const entries = Object.entries(emotionData).filter(([, score]) => score > 0);
            if (entries.length === 0) { empathyMessageEl.textContent = '대화에서 다양한 감정들을 탐색해볼 수 있어요.'; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; return; }
            entries.sort((a, b) => b[1] - a[1]);
            const [dominantEmotion, score] = entries[0]; let msg = ''; let sentimentClass = 'neutral';
            if (score > 0.3) {
                switch (dominantEmotion) {
                    case '기쁨': msg = `대화에서 <strong>즐거움</strong>이 느껴지네요! 좋은 순간들을 많이 나누셨나 봐요. 😊`; sentimentClass = 'positive'; break;
                    case '슬픔': msg = `<strong>슬픔이나 속상함</strong>이 느껴지는 부분이 있었어요. 그 마음에 로지가 귀 기울일게요. 털어놓아 주셔서 고마워요.`; sentimentClass = 'negative'; break;
                    case '분노': msg = `<strong>화나거나 답답한 감정</strong>이 있었던 것 같아요. 그런 감정도 소중한 내 마음의 신호랍니다.`; sentimentClass = 'negative'; break;
                    case '불안': msg = `<strong>걱정이나 불안함</strong>이 느껴졌어요. 어떤 점이 마음을 불편하게 했는지 함께 살펴볼까요?`; sentimentClass = 'negative'; break;
                    case '수치': msg = `혹시 <strong>부끄럽거나 당황스러운 마음</strong>이 드셨나요? 괜찮아요, 여기는 안전한 공간이에요.`; sentimentClass = 'neutral'; break;
                    case '중립': msg = `대화가 전반적으로 <strong>차분하게</strong> 진행된 것 같아요. 생각을 정리하는 데 도움이 되었길 바라요.`; sentimentClass = 'neutral'; break;
                    default: msg = '다양한 감정들을 표현해주셨네요. 자신의 감정을 알아차리는 것은 매우 중요합니다.'; sentimentClass = 'neutral';
                }
            } else { msg = '이야기를 통해 다양한 감정들을 탐색하고 표현하는 연습을 할 수 있어요.'; sentimentClass = 'neutral'; }
            empathyMessageEl.innerHTML = msg; empathyMessageEl.className = `feedback ${sentimentClass}`; empathyMessageEl.style.display = 'block';
        }
        // "로지와의 약속" 생성 함수
        function createImprovementPlanIfNeeded(analysisResults, userAge) {
            let plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]' );
            const currentJournalId = localStorage.getItem('lozee_selected_journal_id') || `session_${new Date().getTime()}`; // 현재 분석 중인 저널 ID 또는 세션 식별자

            // 1. 인지왜곡 관련 약속 생성
            if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                analysisResults.cognitiveDistortions.forEach(distortion => {
                    const planId = `cog_${currentJournalId}_${distortion.replace(/\s+/g, '_').substring(0,20)}`; // ID 길이 제한 고려
                    const existingPlan = plans.find(p => p.id === planId);
                    if (!existingPlan) {
                        plans.push({
                            id: planId,
                            type: 'cognitive_distortion',
                            title: `생각 습관 돌아보기: "${distortion}"`,
                            details: distortion,
                            topic: analysisResults.summaryTitle || "최근 대화 주제",
                            promptForContinuation: `지난번에 "${analysisResults.summaryTitle || '이 대화'}"에서 나타났던 "${distortion}" 생각 패턴에 대해 더 깊이 이야기 나눠볼까요? 어떤 상황에서 그런 생각이 들었고, 그로 인해 어떤 감정을 느끼셨는지 편하게 말씀해주세요.`
                        });
                    }
                });
            }

            // 2. 언어 연령 차이 관련 약속 생성 (12세 이하 사용자에게만 해당)
            if (userAge > 0 && userAge <= 12 && analysisResults.ageLanguageAnalysis) {
                const langAnalysis = analysisResults.ageLanguageAnalysis;
                const realUserAge = userAge; // 이미 숫자로 변환됨
                let predictedUserAgeNum = null;

                // "X세", "X-Y세" 형태의 predictedAge를 숫자(또는 범위의 중간값)로 변환 시도
                if (langAnalysis.predictedAge) {
                    const ageMatch = String(langAnalysis.predictedAge).match(/(\d+)(-(\d+))?/);
                    if (ageMatch && ageMatch[1]) {
                        predictedUserAgeNum = parseInt(ageMatch[1]);
                        if (ageMatch[3]) { // 범위인 경우 (X-Y세)
                            predictedUserAgeNum = (predictedUserAgeNum + parseInt(ageMatch[3])) / 2;
                        }
                    }
                }
                
                if (predictedUserAgeNum !== null) {
                    const ageDifference = Math.abs(predictedUserAgeNum - realUserAge);
                    if (ageDifference >= 0.5) { // 6개월 이상 차이
                        const planId = `lang_${currentJournalId}_age_diff`;
                        const existingPlan = plans.find(p => p.id === planId);
                        if (!existingPlan) {
                            plans.push({
                                id: planId,
                                type: 'language_practice',
                                title: `말솜씨 발전시키기`,
                                details: `언어 표현력 향상 (예상 ${langAnalysis.predictedAge}, 실제 ${realUserAge}세)`,
                                topic: "언어 표현 연습",
                                predictedAge: langAnalysis.predictedAge, // 문자열 형태 유지
                                userAge: realUserAge, // 숫자
                                promptForContinuation: `지난번 분석에서 내 말솜씨가 ${langAnalysis.predictedAge} 정도로 보였는데, 실제 나이(${realUserAge}세)와 조금 차이가 있었지? 함께 연습하면서 생각이나 느낌을 더 잘 표현하는 방법을 찾아보자! 어떤 말부터 연습해볼까?`
                            });
                        }
                    }
                }
            }

            // 중복 제거 (같은 ID의 약속이 여러 번 추가되는 것 방지)
            const uniquePlans = plans.filter((plan, index, self) =>
                index === self.findIndex((p) => (p.id === plan.id))
            );

            if (uniquePlans.length > 0) {
                localStorage.setItem('lozee_improvement_plans', JSON.stringify(uniquePlans));
                console.log("Analysis Page: 개선 계획 저장됨:", uniquePlans);
            } else {
                 console.log("Analysis Page: 생성할 새로운 개선 계획이 없습니다.");
            }
        }
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>