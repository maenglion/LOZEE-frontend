<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE와 함께하는 마음 탐험!</title>
    <link
        href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" href="gnb.css"> 
    <style>
        /* analysis.html 페이지 고유 스타일 (이전과 동일) */
        :root { /* ... */ }
        body, html { /* ... */ }
        body { padding-top: var(--gnb-height); }
        .container { /* ... */ }
        h1 { /* ... */ }
        .share-button-container { /* ... */ }
        #reportShareButton { /* ... */ }
        #reportShareButton:hover { /* ... */ }
        .assistant-analysis-notice { /* ... */ }
        .module-explanation { /* ... */ }
        h2 { /* ... */ }
        .section { /* ... */ }
        .section p { /* ... */ }
        .section p span { /* ... */ }
        .feedback { /* ... */ }
        .feedback.negative { /* ... */ }
        .feedback.positive { /* ... */ }
        .feedback.neutral { /* ... */ }
        #emotionChartContainer { position: relative; max-width: 450px; height: auto; margin: 20px auto 0; }
        #emotionChart, #situationChart { width:100% !important; height:auto !important; aspect-ratio: 1 / 1; background-color: #fdfdfd; border-radius: 8px; border: 1px solid #e0e0e0; padding: 15px; box-sizing: border-box; }
        #tagCloud { /* ... */ }
        .badge { /* ... */ }
        .badge:hover { /* ... */ }
        #patternDashboard { /* ... */ }
        #patternDashboard p { /* ... */ }
        #situationAlerts { /* ... */ }
        #situationAlerts .cognitive-distortion-item { /* ... */ }
        .footer-assistant-notice { /* ... */ }
        .methodology-list { /* ... */ }
        .methodology-list li { /* ... */ }
        .methodology-list li::before { /* ... */ }
        .methodology-list li strong { /* ... */ }
        .action-button { /* ... */ }
        .action-button:hover { /* ... */ }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 480px) { /* ... */ }
    </style>
</head>
<body>
    <nav id="gnb">
        </nav>

    <div class="container">
        <h1>🚀 로지와 함께한 이야기 탐험!</h1>
        <div class="share-button-container">
            <button id="reportShareButton">나의 이야기 보고서 공유하기 🔗</button>
        </div>

        <div class="section" id="languageAgeSection" style="display:none;"> 
            <h2>🗣️ 내 말솜씨 나이는 몇 살일까?</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                로지와 이야기하면서 네가 사용한 말들을 보고, 네 말솜씨가 몇 살 친구랑 비슷한지 알려줄게! 실제 나이랑 달라도 괜찮아, 함께 더 멋지게 말하는 법을 배우면 되니까! 😉
            </p>
            <p class="module-explanation" style="font-size: 0.85em; background-color: #e3f2fd; color: #1e88e5;">
                <strong>[로지의 약속!]</strong> 언어 분석은 총 3단계로 점점 더 정확해져! <br>
                <strong>1단계(30분~)</strong>: 우리가 처음 만나서 나눈 이야기로 살짝 엿보기! <br>
                <strong>2단계(2시간~)</strong>: 좀 더 많은 이야기를 나누면 로지가 너를 더 잘 알게 돼! <br>
                <strong>3단계(6시간~)</strong>: 와! 이제 정말 너의 멋진 말솜씨를 잘 알 것 같아! (가장 정확한 분석)
            </p>
            <p>내 진짜 나이: <span id="realAge"></span>살</p>
            <p>내 말솜씨 나이 (로지의 생각): <span id="predictedLangAge"></span> <span id="ageDifferenceVisual" style="font-weight:normal; margin-left: 8px;"></span></p>
            <div id="ageFeedback" class="feedback" style="display:none;"></div>
            <button id="languagePracticeBtn" class="action-button" style="display:none;">로지와 함께 말솜씨 키우기 쑥쑥! 🌱 (준비 중)</button>
        </div>

        <div class="section" id="analysisMethodologySection">
             <h2>LOZEE의 분석 방법론</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <ul class="methodology-list">
                <li><strong>Russell의 감정 원형 모형</strong>: Valence(쾌-불쾌)와 Arousal(각성-이완) 축을 기반으로 감정의 위치를 다차원적으로 분석합니다.</li>
                <li><strong>Plutchik의 감정 바퀴</strong>: 8가지 기본 감정과 그 강도 및 유사성을 바탕으로 복합적인 감정 상태를 이해합니다.</li>
                <li><strong>Lexicon 기반 감성 분석</strong>: 한국어 감성 사전(예: KOSAC)을 활용하여 텍스트의 긍정, 부정, 중립 극성을 판단합니다.</li>
                <li><strong>딥러닝 분류 모델 (BERT/KoBERT)</strong>: 최신 자연어 처리 모델을 사용하여 문맥을 고려한 고정밀 감정 극성 및 세부 감정(예: 기쁨, 슬픔, 분노 등)을 분류합니다.</li>
                <li><strong>인지왜곡 이론 (Beck의 CBT)</strong>: 인지행동치료 이론에 기반하여 대화에서 나타날 수 있는 대표적인 인지왜곡 패턴(예: 흑백논리, 과잉일반화 등)을 감지합니다.</li>
                <li><strong>대화 주제 구조화</strong>: LOZEE AI의 자체 상담 토픽 데이터를 활용하여 대화의 흐름과 주요 주제를 체계적으로 파악하고 관련 피드백을 제공합니다.</li>
            </ul>
        </div>

        <div class="section" id="emotionToneSection">
            <h2>🌈 내 마음 색깔은 뭘까? (감정 변화)</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                우리가 나눈 이야기에서 어떤 느낌들이 많았는지, 또 어떤 단어들을 자주 사용했는지 보여줄게! 네 마음속 날씨를 함께 알아보자! ☀️🌧️
            </p>
            <div id="emotionChartContainer">
                <canvas id="emotionChart"></canvas> 
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p> 
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="patternSection">
            <h2>🔍 자주 나타나는 내 마음 & 단어</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                이야기하다 보면 나도 모르게 자주 쓰는 말이나 비슷한 느낌을 표현할 때가 있어. 로지가 그런 부분을 찾아봤어!
            </p>
            <div id="patternDashboard"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>🧐 생각 탐험! (나의 생각 습관)</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                여기는 우리가 나눈 이야기를 요약하고, 혹시 네 생각이 한쪽으로만 기울어지지는 않았는지(이걸 '생각 습관'이라고 불러볼까?), 어떤 특별한 점이 있는지 살펴보는 곳이야. 특별한 생각 습관이 보여도 걱정하지 마! 누구나 그럴 수 있고, 우리는 이야기하면서 함께 더 유연하게 생각하는 방법을 찾을 수 있어! 💪
            </p>
            <canvas id="situationChart" style="display:none;"></canvas> 
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">이 생각에 대해 다음에 더 이야기 나눠볼까? 🤔</button>
        </div>

        <p class="footer-assistant-notice">본 분석은 로지 AI가 마음을 담아 준비했어요.</p>
    </div>

    <script type="module">
        // Chart.js ESM 모듈 불러오기 (jsDelivr의 일반 최신 버전 링크 사용)
        import { Chart, registerables } from 'https://cdn.jsdelivr.net/npm/chart.js/dist/chart.esm.js';
        Chart.register(...registerables);
       
        // Chart.js 전역 기본값 설정
        Chart.defaults.color = '#333'; 
        Chart.defaults.borderColor = '#e0e0e0'; 
        Chart.defaults.font.family = "'KoPub World Dotum', sans-serif"; 
        Chart.defaults.font.size = 12; 

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Analysis Page: DOMContentLoaded"); 

            // --- DOM 요소 가져오기 ---
            const languageAgeSection = document.getElementById('languageAgeSection');
            const realAgeEl = document.getElementById('realAge');
            const predictedLangAgeEl = document.getElementById('predictedLangAge');
            const ageFeedbackEl = document.getElementById('ageFeedback');
            const ageDifferenceVisualEl = document.getElementById('ageDifferenceVisual');
            const languagePracticeBtn = document.getElementById('languagePracticeBtn');
            
            const emotionChartEl = document.getElementById('emotionChart');
            const empathyMessageEl = document.getElementById('empathyMessage');
            const tagCloudEl = document.getElementById('tagCloud');
            
            const patternDashboardEl = document.getElementById('patternDashboard');
            
            const situationAlertsEl = document.getElementById('situationAlerts');
            const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
            
            const reportShareButton = document.getElementById('reportShareButton');

            // --- 데이터 로드 ---
            const userAge = parseInt(localStorage.getItem('lozee_userage'), 10) || 0; 
            if(realAgeEl) realAgeEl.textContent = userAge || "정보 없음";

            const analysisDataString = localStorage.getItem('lozee_conversation_analysis');
            console.log("Analysis Page - Analysis Data String from localStorage:", analysisDataString);
            let analysisResults = null;
            let accumulatedDurationMinutes = 0;

            if (analysisDataString) {
                try {
                    const fullAnalysis = JSON.parse(analysisDataString);
                    analysisResults = fullAnalysis.results; // 실제 분석 결과 객체
                    accumulatedDurationMinutes = parseFloat(fullAnalysis.accumulatedDurationMinutes) || 0;
                    console.log("Analysis Page - Parsed analysisResults:", analysisResults);
                    console.log("Analysis Page - Accumulated Duration (min):", accumulatedDurationMinutes);
                } catch (e) {
                    console.error("저장된 분석 결과 파싱 오류:", e);
                    if (document.querySelector('.container')) {
                        document.querySelector('.container').innerHTML = '<h1>앗! 분석 결과를 불러오는 데 문제가 생겼어요 😥</h1><p style="text-align:center;">이전 대화로 돌아가거나, 잠시 후 다시 시도해주세요.</p>';
                    }
                    return; 
                }
            } else {
                console.log("Analysis Page: localStorage에 'lozee_conversation_analysis' 데이터 없음");
                if (document.querySelector('.container')) {
                    document.querySelectorAll('.section').forEach(sec => {
                        // 방법론 섹션은 남기고 나머지는 숨기거나 "데이터 없음" 메시지 표시
                        if (sec.id !== 'analysisMethodologySection') {
                            sec.style.display = 'none'; 
                        }
                    });
                    // 데이터 없음 메시지를 컨테이너 상단에 추가 (방법론 섹션은 유지될 수 있도록)
                    const containerEl = document.querySelector('.container');
                    if (containerEl && !containerEl.querySelector('.no-data-message')) {
                        const noDataMsgDiv = document.createElement('div');
                        noDataMsgDiv.className = 'feedback neutral no-data-message'; // 스타일 적용
                        noDataMsgDiv.style.textAlign = 'center';
                        noDataMsgDiv.style.marginTop = '20px';
                        noDataMsgDiv.innerHTML = '<h2>아직 로지와 나눈 이야기가 충분하지 않나 봐요! 😮</h2><p>먼저 로지와 신나게 이야기하고 분석 결과를 확인해보세요!</p>';
                        // 페이지 제목(h1) 다음에 메시지 삽입
                        const pageTitleH1 = containerEl.querySelector('h1');
                        if (pageTitleH1 && pageTitleH1.nextSibling) {
                            pageTitleH1.parentElement.insertBefore(noDataMsgDiv, pageTitleH1.nextSibling.nextSibling); // 공유버튼 다음에
                        } else if (pageTitleH1) {
                             pageTitleH1.insertAdjacentElement('afterend', noDataMsgDiv);
                        } else {
                            containerEl.prepend(noDataMsgDiv);
                        }
                    }
                }
                return; 
            }
            
            // --- 각 분석 섹션 렌더링 (analysisResults가 null이 아닐 때만 실행) ---
            if (analysisResults) {
                // 1. 언어·나이 분석 섹션 처리
                if (languageAgeSection) {
                    if (userAge > 12 || !analysisResults.ageLanguageAnalysis) { 
                        languageAgeSection.style.display = 'none';
                        // ... (콘솔 로그는 이전과 동일) ...
                    } else {
                        languageAgeSection.style.display = 'block'; 
                        // ... (언어 연령 분석 결과 표시 로직 - 이전 답변의 완성된 코드 사용) ...
                        // (feedbackMsg, visualText 설정 및 버튼 표시 조건 등 포함)
                        let predicted = null;
                        if (analysisResults.ageLanguageAnalysis.estimatedAgeRange) {
                            const ageRangeMatch = String(analysisResults.ageLanguageAnalysis.estimatedAgeRange).match(/\d+/);
                            if (ageRangeMatch) predicted = parseInt(ageRangeMatch[0], 10);
                        }
                        let feedbackMsg = ''; let visualText = ''; ageFeedbackEl.className = 'feedback';
                        if (accumulatedDurationMinutes < 30) { visualText = "(아직 30분이 안 돼서, 살짝 맛보기 분석이야! 🍳)"; predictedLangAgeEl.textContent = "아직 비밀! 😉"; feedbackMsg = "로지와 30분 이상 이야기하면 내가 얼마나 멋지게 말하는지 살짝 알려줄게! 조금만 더 이야기 나눠볼까?"; ageFeedbackEl.classList.add('neutral');
                        } else if (predicted !== null) { /* ... (나머지 피드백 로직) ... */ } else { predictedLangAgeEl.textContent = "정보 부족"; feedbackMsg = (accumulatedDurationMinutes >= 30) ? "지금은 네 말솜씨 나이를 정확히 알기 어렵네. 다음에 다시 확인해 줄래?" : "로지와 30분 이상 이야기하면 말솜씨 나이를 알려줄 수 있어!"; ageFeedbackEl.classList.add('neutral'); languagePracticeBtn.style.display = 'none';}
                        if(ageDifferenceVisualEl) ageDifferenceVisualEl.textContent = visualText; if(ageFeedbackEl) ageFeedbackEl.textContent = feedbackMsg; if(ageFeedbackEl) ageFeedbackEl.style.display = 'block';
                        if (userAge <= 12 && predicted !== null && (userAge - predicted) >= 1) { if(languagePracticeBtn) languagePracticeBtn.style.display = 'inline-block'; /* ... onclick ... */ } else { if(languagePracticeBtn) languagePracticeBtn.style.display = 'none';}
                    }
                }

                // 2. 감정 어조 및 태그 클라우드
                if (analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                    if(emotionChartEl) emotionChartEl.style.display = 'block';
                    renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                    if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                } else {
                    if(emotionChartEl) emotionChartEl.style.display = 'none';
                    if(empathyMessageEl) { /* ... 데이터 없음 메시지 ... */ }
                }
                if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                    const tagsForCloud = analysisResults.keywords.map(kw => ({ text: kw, weight: 5 + Math.floor(Math.random() * 10) }));
                    renderTagCloud('tagCloud', tagsForCloud);
                } else { /* ... 데이터 없음 메시지 ... */ }
                
                // 3. 반복 패턴
                if (analysisResults.patterns && analysisResults.patterns.length > 0) {
                    if(patternDashboardEl) renderPatternDashboard('patternDashboard', analysisResults.patterns);
                } else {
                    if(patternDashboardEl) patternDashboardEl.innerHTML = '<p style="text-align:center; color:#888;">반복되는 이야기 패턴을 찾고 있어요!</p>';
                }

                // 4. 상황 분석 (인지왜곡)
                const situationChartElToHide = document.getElementById('situationChart'); // 변수 재선언 방지
                if(situationChartElToHide) situationChartElToHide.style.display = 'none'; 
                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions);
                    if (continueDistortionTalkBtn) { /* ... 버튼 표시 및 onclick 로직 ... */ }
                } else {
                    if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';
                    if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                }
            } else { // analysisResults 자체가 null인 경우 (위에서 이미 return으로 처리했지만, 방어용)
                 console.log("Analysis Page: analysisResults 객체가 없습니다. 대부분의 분석 섹션을 숨깁니다.");
                 document.querySelectorAll('.section').forEach(sec => {
                    if (sec.id !== 'analysisMethodologySection') sec.style.display = 'none';
                 });
            }

            // 공유 버튼 로직
            if(reportShareButton) { reportShareButton.onclick = () => { /* ... 기존 공유 로직 ... */ }; }
        });

        // --- 데이터 렌더링 함수들 (모두 채워진 상태로) ---
        function renderTagCloud(elementId, tags) { const cloudEl = document.getElementById(elementId); if(!cloudEl) return; if(tags && tags.length > 0) { cloudEl.innerHTML = tags.map(tag => { const size = 0.8 + (tag.weight / 15); const opacity = Math.max(0.5, tag.weight / 10); return `<span class="badge" style="opacity:${opacity}; font-size:${size}em;">${tag.text}</span>`; }).join(''); } else { cloudEl.innerHTML = '<p style="text-align:center; color:#888;">이야기에서 자주 나온 단어들을 모으고 있어요!</p>'; } }
        function renderPatternDashboard(elementId, patterns) { const dashEl = document.getElementById(elementId); if(!dashEl) return; if(patterns && patterns.length > 0) { dashEl.innerHTML = patterns.map(p => `<p>💡 ${p}</p>`).join(''); } else { dashEl.innerHTML = '<p style="text-align:center; color:#888;">반복되는 이야기 패턴을 찾고 있어요!</p>'; } }
        function alertCognitiveDistortions(elementId, distortions) { const alertEl = document.getElementById(elementId); if(!alertEl) return; if(distortions && distortions.length > 0) { alertEl.innerHTML = distortions.map(d => `<p class="cognitive-distortion-item">${d}</p>`).join(''); } else { alertEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';} }
        
        function renderEmotionChart(canvasId, emotionData) { 
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            const chartEl = document.getElementById(canvasId);
            if (!ctx) { console.error("renderEmotionChart: 캔버스 context를 가져올 수 없습니다."); if(chartEl) chartEl.style.display = 'none'; return; }
            
            if (!emotionData || Object.keys(emotionData).length === 0) {
                if(chartEl) {
                    chartEl.style.display = 'none';
                    const parentSection = chartEl.closest('.section');
                    if (parentSection && !parentSection.querySelector('.no-chart-data-message')) { 
                         const noDataMsg = document.createElement('p');
                         noDataMsg.textContent = "감정 변화를 그리기에 아직 이야기가 부족해요. 😟";
                         noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888';
                         noDataMsg.classList.add('no-chart-data-message');
                         chartEl.insertAdjacentElement('afterend', noDataMsg);
                    }
                }
                return;
            }
            // 데이터가 있으면 차트 보이기
            if(chartEl) chartEl.style.display = 'block';

            const existingChart = Chart.getChart(ctx);
            if (existingChart) { existingChart.destroy(); }

            const emotionColors = { '기쁨': 'rgba(255, 205, 86, 0.7)', '슬픔': 'rgba(54, 162, 235, 0.7)', '분노': 'rgba(255, 99, 132, 0.7)', '불안': 'rgba(153, 102, 255, 0.7)', '수치': 'rgba(255, 159, 64, 0.7)', '중립': 'rgba(201, 203, 207, 0.7)'};
            const labels = Object.keys(emotionData);
            const dataValues = Object.values(emotionData);
            const backgroundColors = labels.map(label => emotionColors[label] || 'rgba(100, 100, 100, 0.7)');

            new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ label: '나의 마음 비율', data: dataValues, backgroundColor: backgroundColors, borderColor: '#ffffff', borderWidth: 2 }] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: Chart.defaults.color, font: { family: Chart.defaults.font.family, size: 11 }, padding: 15 } }, 
                        tooltip: { titleFont: { family: Chart.defaults.font.family }, bodyFont: { family: Chart.defaults.font.family } } 
                    } 
                } 
            });
        }

        function displayEmpathyMessage(emotionData) { 
            const empathyMessageEl = document.getElementById('empathyMessage'); 
            if (!empathyMessageEl) return;
            if (!emotionData || Object.keys(emotionData).length === 0) { 
                empathyMessageEl.style.display = 'none'; return; 
            } 
            let highestEmotion = ''; let highestCount = 0; let totalEmotions = 0; 
            for (const emotion in emotionData) { totalEmotions += emotionData[emotion]; if (emotionData[emotion] > highestCount) { highestCount = emotionData[emotion]; highestEmotion = emotion; } } 
            if (totalEmotions === 0) { /* ... */ return; } 
            let message = ""; const userName = localStorage.getItem('lozee_username') || '친구'; 
            const vocativeUserName = userName + (getKoreanVocativeParticle(userName) || '야'); // 호격 조사 추가

            if (highestEmotion === '기쁨' && highestCount / totalEmotions > 0.4) { message = `${vocativeUserName}, 이야기 속에서 '기쁨'의 순간들이 많았구나! 정말 신나고 즐거운 일들이 많았던 것 같아! ✨ 로지도 네 덕분에 행복해졌어!`; 
            } else if (highestEmotion === '불안' && emotionData['기쁨'] > 0) { message = `${vocativeUserName}, 마음속에 '불안'한 느낌도 있었지만, '기쁨'의 순간들도 함께 있었네! 어려운 마음 속에서도 빛나는 점을 찾은 네가 정말 대단해! 앞으로 로지가 더 힘이 되어줄게.`; 
            } else if (highestEmotion === '불안') { message = `${vocativeUserName}, '불안'한 마음이 조금 컸었구나. 그래도 로지에게 솔직하게 이야기해줘서 정말 고마워. 그 마음을 잘 다독일 수 있도록 로지가 곁에 있을게.`; 
            } else if (highestEmotion === '슬픔') { message = `${vocativeUserName}, 마음이 조금 슬펐던 순간들이 있었네. 괜찮아, 슬픈 마음도 소중한 내 마음의 신호등이란다. 로지가 네 마음을 꼭 안아줄게. 꼬옥! 🤗`; 
            } else if (highestEmotion === '분노') { message = `${vocativeUserName}, 혹시 '화'가 나거나 '짜증'나는 일이 있었니? 그런 마음이 들 때는 로지에게 바로 이야기해줘도 괜찮아. 네 마음이 편안해지도록 돕고 싶어.`; 
            } else if (emotionData['기쁨'] > 0 && emotionData['슬픔'] > 0) { message = `${vocativeUserName}, 기쁜 마음도 있었고, 조금은 슬픈 마음도 함께 있었네. 우리 마음은 원래 여러 가지 색깔을 가지고 있단다. 모두 다 소중한 네 마음이야.`; 
            } else { message = `${vocativeUserName}, 로지와 이야기하면서 네 마음속 여러 가지 느낌들을 살펴보았어. 어떤 느낌이 들었는지 더 자세히 이야기해 줄 수 있을까? 😊`; } 
            empathyMessageEl.textContent = message; 
            empathyMessageEl.className = 'feedback neutral'; 
            empathyMessageEl.style.display = 'block';
        }

        // getKoreanVocativeParticle 함수 (talk.html에서 가져오거나, gpt-dialog.js를 import하여 사용)
        // 여기서는 talk.html에 있다고 가정하고, 만약 없다면 gpt-dialog.js에서 import 필요
        // 또는 여기에 직접 정의
        function getKoreanVocativeParticle(name) {
            if (!name) return '야'; // 이름 없으면 '야'
            const lastChar = name.charCodeAt(name.length - 1);
            // 한글 음절(가-힣) 범위: 0xAC00 (가) ~ 0xD7A3 (힣)
            if (lastChar < 0xAC00 || lastChar > 0xD7A3) {
                return '야'; // 한글 이름 아니면 '야'
            }
            return (lastChar - 0xAC00) % 28 === 0 ? '야' : '아'; // 종성 유무에 따라
        }

    </script>
    <script src="./js/gnb.js" defer></script> 
</body>
</html>