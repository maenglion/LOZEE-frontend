<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEEì™€ í•¨ê»˜í•˜ëŠ” ë§ˆìŒ íƒí—˜!</title>
    <link
        href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" href="gnb.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* analysis.html í˜ì´ì§€ ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #ffffff; /* body ë°°ê²½ì„ í°ìƒ‰ìœ¼ë¡œ í†µì¼ */
            --text-color: #333333;
            --card-bg-analysis: #ffffff; /* ì¹´ë“œ ë°°ê²½ë„ í°ìƒ‰ìœ¼ë¡œ */
            --explanation-bg-analysis: #eef2f7; /* ì„¤ëª… ì˜ì—­ ë°°ê²½ì€ ì—°í•œ íŒŒë‘ */
            --primary-color-analysis: var(--primary-color); /* h1 ì œëª© ë“±ì— ì‚¬ìš©ë  ìƒ‰ìƒ */
            --gnb-height: 56px;
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color); /* :root ë³€ìˆ˜ ì‚¬ìš© */
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width:900px;
            margin:25px auto;
            padding:0 25px;
            box-sizing: border-box;
        }
        h1 { /* í˜ì´ì§€ ë©”ì¸ íƒ€ì´í‹€ */
            color: var(--primary-color-analysis);
            text-align: center;
            font-size: 2em;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .share-button-container {
            text-align: center;
            margin-bottom: 30px;
        }
        #reportShareButton {
            background-color: var(--primary-color); /* :root ë³€ìˆ˜ ì‚¬ìš© */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #reportShareButton:hover {
            background-color: var(--secondary-color); /* :root ë³€ìˆ˜ ì‚¬ìš© */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .assistant-analysis-notice {
            font-size: 0.75em;
            color: #78909c;
            margin-top: -12px;
            margin-bottom: 15px;
            text-align: right;
        }
        .module-explanation {
            font-size:0.9em;
            color:#555;
            margin-bottom:15px;
            padding: 10px;
            background-color: var(--explanation-bg-analysis);
            border-radius: 6px;
            line-height: 1.6;
        }

        h2 { /* ê° ì„¹ì…˜ ì œëª© */
            margin-top:0;
            margin-bottom: 8px;
            font-size:1.5em;
            color:#34495e; /* ë‚¨ìƒ‰ ê³„ì—´ */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
        }
        .section {
            background:var(--card-bg-analysis);
            padding:25px;
            margin-top:25px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.08);
        }
        .section p {
            color: #555555;
            line-height: 1.7;
            font-size: 1em;
        }
        .section p span { /* í˜„ì¬ ì½”ë“œì—ëŠ” ì—†ì§€ë§Œ, ê°•ì¡°ìš©ìœ¼ë¡œ ì¶”ê°€ ê°€ëŠ¥ */
            color: var(--secondary-color);
            font-weight: bold;
        }
        .feedback {
            margin-top:15px;
            padding:12px 18px;
            border-left-width:5px;
            border-left-style:solid;
            border-radius:8px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .feedback.negative { background:#ffebee; border-left-color: #c62828; color:#c62828; }
        .feedback.positive { background:#e8f5e9; border-left-color: #2e7d32; color:#2e7d32; }
        .feedback.neutral { background:#eceff1; border-left-color: #546e7a; color:#37474f; }

        #emotionChartContainer {
            position: relative;
            max-width: 450px;
            min-height: 100px;
            height: auto;
            margin: 20px auto 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #emotionChart, #situationChart { /* #situationChartëŠ” í˜„ì¬ ì‚¬ìš© ì•ˆí•¨ */
            width:100% !important;
            height:auto !important;
            aspect-ratio: 1 / 1; /* ì •ì‚¬ê°í˜• ë¹„ìœ¨ ìœ ì§€ */
            background-color: #fdfdfd;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            box-sizing: border-box;
            display: none; /* JSë¡œ í‘œì‹œ */
        }
        #tagCloud { min-height:100px; border:1px dashed #cccccc; padding:15px; margin-top: 20px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
        .badge { display:inline-block; margin:4px; padding:8px 12px; background:#e8eaf6; color: #3f51b5; border-radius:16px; font-size:0.9em; transition: background-color 0.2s, color 0.2s; font-weight: 500; }
        .badge:hover { background-color: #c5cae9; color: #303f9f; }
        #patternDashboard { margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; color: #444; min-height: 50px; }
        #patternDashboard p { color: #444; margin-bottom: 8px; } /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ê³¼ ì¤‘ë³µë  ìˆ˜ ìˆìœ¼ë‚˜ ëª…ì‹œ */
        #situationAlerts { margin-top: 15px; min-height: 50px; }
        #situationAlerts .cognitive-distortion-item { background:#fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9em; }
        .footer-assistant-notice { text-align: center; margin-top: 40px; margin-bottom: 20px; font-size: 0.8em; color: #78909c; }
        .methodology-list { list-style-type: none; padding-left: 0; font-size: 0.9em; color: #555; }
        .methodology-list li { margin-bottom: 12px; padding-left: 25px; position: relative; }
        .methodology-list li::before { content: "ğŸ’¡"; color: var(--primary-color); /* :root ë³€ìˆ˜ ì‚¬ìš© */ position: absolute; left: 0; font-size: 1.1em; }
        .methodology-list li strong { color: #34495e; }
        .action-button { display: inline-block; margin-top: 15px; background-color: var(--primary-color); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .action-button:hover { background-color: var(--secondary-color); }

        @media (max-width: 768px) { h1 { font-size: 1.7em; } h2 { font-size: 1.3em; } .section { padding: 20px; } #emotionChartContainer { max-width: 100%; } #emotionChart, #situationChart { aspect-ratio: 4 / 3; } .methodology-list { font-size: 0.85em; } }
        @media (max-width: 480px) { .container { margin: 15px auto; padding: 0 15px; } h1 { font-size: 1.5em; margin-bottom: 25px; } h2 { font-size: 1.2em; } .section { padding: 15px; margin-top: 20px;} .section p { font-size: 0.95em; } .feedback { padding: 10px 15px; font-size: 0.9em;} #emotionChartContainer { max-width: 100%; } #emotionChart, #situationChart { aspect-ratio: 1 / 1; } .badge { font-size: 0.85em; padding: 6px 10px;} .assistant-analysis-notice { font-size: 0.7em; } .methodology-list { font-size: 0.8em; } }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a>
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a>
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a>
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
        </div>
    </nav>

    <div class="container">
        <h1>ğŸš€ ë¡œì§€ì™€ í•¨ê»˜í•œ ì´ì•¼ê¸° íƒí—˜!</h1>
        <div class="share-button-container">
            <button id="reportShareButton">ë‚˜ì˜ ì´ì•¼ê¸° ë³´ê³ ì„œ ê³µìœ í•˜ê¸° ğŸ”—</button>
        </div>

        <div class="section" id="languageAgeSection" style="display:none;">
            <h2>ğŸ—£ï¸ ë‚´ ë§ì†œì”¨ ë‚˜ì´ëŠ” ëª‡ ì‚´ì¼ê¹Œ?</h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <p class="module-explanation">
                ë¡œì§€ì™€ ì´ì•¼ê¸°í•˜ë©´ì„œ ë„¤ê°€ ì‚¬ìš©í•œ ë§ë“¤ì„ ë³´ê³ , ë„¤ ë§ì†œì”¨ê°€ ëª‡ ì‚´ ì¹œêµ¬ë‘ ë¹„ìŠ·í•œì§€ ì•Œë ¤ì¤„ê²Œ! ì‹¤ì œ ë‚˜ì´ë‘ ë‹¬ë¼ë„ ê´œì°®ì•„, í•¨ê»˜ ë” ë©‹ì§€ê²Œ ë§í•˜ëŠ” ë²•ì„ ë°°ìš°ë©´ ë˜ë‹ˆê¹Œ! ğŸ˜‰
            </p>
            <p class="module-explanation" style="font-size: 0.85em; background-color: #e3f2fd; color: #1e88e5;">
                <strong>[ë¡œì§€ì˜ ì•½ì†!]</strong> ì–¸ì–´ ë¶„ì„ì€ ì´ 3ë‹¨ê³„ë¡œ ì ì  ë” ì •í™•í•´ì ¸! <br>
                <strong>1ë‹¨ê³„(30ë¶„~)</strong>: ìš°ë¦¬ê°€ ì²˜ìŒ ë§Œë‚˜ì„œ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¡œ ì‚´ì§ ì—¿ë³´ê¸°! <br>
                <strong>2ë‹¨ê³„(2ì‹œê°„~)</strong>: ì¢€ ë” ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©´ ë¡œì§€ê°€ ë„ˆë¥¼ ë” ì˜ ì•Œê²Œ ë¼! <br>
                <strong>3ë‹¨ê³„(6ì‹œê°„~)</strong>: ì™€! ì´ì œ ì •ë§ ë„ˆì˜ ë©‹ì§„ ë§ì†œì”¨ë¥¼ ì˜ ì•Œ ê²ƒ ê°™ì•„! (ê°€ì¥ ì •í™•í•œ ë¶„ì„)
            </p>
            <p>ë‚´ ì§„ì§œ ë‚˜ì´: <span id="realAge">ì •ë³´ ì—†ìŒ</span>ì‚´</p>
            <p>ë‚´ ë§ì†œì”¨ ë‚˜ì´ (ë¡œì§€ì˜ ìƒê°): <span id="predictedLangAge">ë¶„ì„ ì¤‘...</span> <span id="ageDifferenceVisual" style="font-weight:normal; margin-left: 8px;"></span></p>
            <div id="ageFeedback" class="feedback" style="display:none;"></div>
            <button id="languagePracticeBtn" class="action-button" style="display:none;">ë¡œì§€ì™€ í•¨ê»˜ ë§ì†œì”¨ í‚¤ìš°ê¸° ì‘¥ì‘¥! ğŸŒ± (ì¤€ë¹„ ì¤‘)</button>
        </div>

        <div class="section" id="emotionToneSection">
            <h2>ğŸŒˆ ë‚´ ë§ˆìŒ ìƒ‰ê¹”ì€ ë­˜ê¹Œ? (ê°ì • ë³€í™”)</h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <p class="module-explanation">
                ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ì—ì„œ ì–´ë–¤ ëŠë‚Œë“¤ì´ ë§ì•˜ëŠ”ì§€, ë˜ ì–´ë–¤ ë‹¨ì–´ë“¤ì„ ìì£¼ ì‚¬ìš©í–ˆëŠ”ì§€ ë³´ì—¬ì¤„ê²Œ! ë„¤ ë§ˆìŒì† ë‚ ì”¨ë¥¼ í•¨ê»˜ ì•Œì•„ë³´ì! â˜€ï¸ğŸŒ§ï¸
            </p>
            <div id="emotionChartContainer"> <canvas id="emotionChart"></canvas>
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p>
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="patternSection">
            <h2>ğŸ” ìì£¼ ë‚˜íƒ€ë‚˜ëŠ” ë‚´ ë§ˆìŒ &amp; ë‹¨ì–´</h2> <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <p class="module-explanation">
                ì´ì•¼ê¸°í•˜ë‹¤ ë³´ë©´ ë‚˜ë„ ëª¨ë¥´ê²Œ ìì£¼ ì“°ëŠ” ë§ì´ë‚˜ ë¹„ìŠ·í•œ ëŠë‚Œì„ í‘œí˜„í•  ë•Œê°€ ìˆì–´. ë¡œì§€ê°€ ê·¸ëŸ° ë¶€ë¶„ì„ ì°¾ì•„ë´¤ì–´!
            </p>
            <div id="patternDashboard"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>ğŸ§ ìƒê° íƒí—˜! (ë‚˜ì˜ ìƒê° ìŠµê´€)</h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <p class="module-explanation">
                ì—¬ê¸°ëŠ” ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¥¼ ìš”ì•½í•˜ê³ , í˜¹ì‹œ ë„¤ ìƒê°ì´ í•œìª½ìœ¼ë¡œë§Œ ê¸°ìš¸ì–´ì§€ì§€ëŠ” ì•Šì•˜ëŠ”ì§€(ì´ê±¸ 'ìƒê° ìŠµê´€'ì´ë¼ê³  ë¶ˆëŸ¬ë³¼ê¹Œ?), ì–´ë–¤ íŠ¹ë³„í•œ ì ì´ ìˆëŠ”ì§€ ì‚´í´ë³´ëŠ” ê³³ì´ì•¼. íŠ¹ë³„í•œ ìƒê° ìŠµê´€ì´ ë³´ì—¬ë„ ê±±ì •í•˜ì§€ ë§ˆ! ëˆ„êµ¬ë‚˜ ê·¸ëŸ´ ìˆ˜ ìˆê³ , ìš°ë¦¬ëŠ” ì´ì•¼ê¸°í•˜ë©´ì„œ í•¨ê»˜ ë” ìœ ì—°í•˜ê²Œ ìƒê°í•˜ëŠ” ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ìˆì–´! ğŸ’ª
            </p>
            <canvas id="situationChart" style="display:none;"></canvas>
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">ì´ ìƒê°ì— ëŒ€í•´ ë‹¤ìŒì— ë” ì´ì•¼ê¸° ë‚˜ëˆ ë³¼ê¹Œ? ğŸ¤”</button>
        </div>

        <div class="section" id="analysisMethodologySection">
             <h2>LOZEEì˜ ë¶„ì„ ë°©ë²•ë¡ </h2>
             <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <ul class="methodology-list">
                <li><strong>Russellì˜ ê°ì • ì›í˜• ëª¨í˜•</strong>: Valence(ì¾Œ-ë¶ˆì¾Œ)ì™€ Arousal(ê°ì„±-ì´ì™„) ì¶•ì„ ê¸°ë°˜ìœ¼ë¡œ ê°ì •ì˜ ìœ„ì¹˜ë¥¼ ë‹¤ì°¨ì›ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                <li><strong>Plutchikì˜ ê°ì • ë°”í€´</strong>: 8ê°€ì§€ ê¸°ë³¸ ê°ì •ê³¼ ê·¸ ê°•ë„ ë° ìœ ì‚¬ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë³µí•©ì ì¸ ê°ì • ìƒíƒœë¥¼ ì´í•´í•©ë‹ˆë‹¤.</li>
                <li><strong>Lexicon ê¸°ë°˜ ê°ì„± ë¶„ì„</strong>: í•œêµ­ì–´ ê°ì„± ì‚¬ì „(ì˜ˆ: KOSAC)ì„ í™œìš©í•˜ì—¬ í…ìŠ¤íŠ¸ì˜ ê¸ì •, ë¶€ì •, ì¤‘ë¦½ ê·¹ì„±ì„ íŒë‹¨í•©ë‹ˆë‹¤.</li>
                <li><strong>ë”¥ëŸ¬ë‹ ë¶„ë¥˜ ëª¨ë¸ (BERT/KoBERT)</strong>: ìµœì‹  ìì—°ì–´ ì²˜ë¦¬ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ë§¥ì„ ê³ ë ¤í•œ ê³ ì •ë°€ ê°ì • ê·¹ì„± ë° ì„¸ë¶€ ê°ì •(ì˜ˆ: ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸ ë“±)ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.</li>
                <li><strong>ì¸ì§€ì™œê³¡ ì´ë¡  (Beckì˜ CBT)</strong>: ì¸ì§€í–‰ë™ì¹˜ë£Œ ì´ë¡ ì— ê¸°ë°˜í•˜ì—¬ ëŒ€í™”ì—ì„œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆëŠ” ëŒ€í‘œì ì¸ ì¸ì§€ì™œê³¡ íŒ¨í„´(ì˜ˆ: í‘ë°±ë…¼ë¦¬, ê³¼ì‰ì¼ë°˜í™” ë“±)ì„ ê°ì§€í•©ë‹ˆë‹¤.</li>
                <li><strong>ëŒ€í™” ì£¼ì œ êµ¬ì¡°í™”</strong>: LOZEE AIì˜ ìì²´ ìƒë‹´ í† í”½ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ëŒ€í™”ì˜ íë¦„ê³¼ ì£¼ìš” ì£¼ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ íŒŒì•…í•˜ê³  ê´€ë ¨ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
            </ul>
        </div>

        <p class="footer-assistant-notice">ë³¸ ë¶„ì„ì€ ë¡œì§€ AIê°€ ë§ˆìŒì„ ë‹´ì•„ ì¤€ë¹„í–ˆì–´ìš”. ê°œì¸ì ì¸ ì„±ì°°ì„ ìœ„í•œ ì°¸ê³  ìë£Œë¡œ í™œìš©í•´ì£¼ì„¸ìš”.</p>
    </div>

    <script type="module">
        let chartLibraryInitialized = false;

        function initializeChartJsGlobal() {
            // ... (ì´ì „ê³¼ ë™ì¼) ...
        }

        // ì´ í˜ì´ì§€ì—ì„œëŠ” getKoreanVocativeParticle í•¨ìˆ˜ê°€ ì§ì ‘ í•„ìš”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±° ê°€ëŠ¥
        // function getKoreanVocativeParticle(name) { /* ... */ }


        document.addEventListener('DOMContentLoaded', () => {
            console.log("Analysis Page: DOMContentLoaded ì´ë²¤íŠ¸ ì‹œì‘");
            const chartJsIsReady = initializeChartJsGlobal();

            // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const languageAgeSection = document.getElementById('languageAgeSection');
            const realAgeEl = document.getElementById('realAge');
            const predictedLangAgeEl = document.getElementById('predictedLangAge');
            const ageFeedbackEl = document.getElementById('ageFeedback');
            const ageDifferenceVisualEl = document.getElementById('ageDifferenceVisual');
            const languagePracticeBtn = document.getElementById('languagePracticeBtn');

            const emotionChartEl = document.getElementById('emotionChart');
            const emotionChartContainerEl = document.getElementById('emotionChartContainer');
            const empathyMessageEl = document.getElementById('empathyMessage');
            const tagCloudEl = document.getElementById('tagCloud');

            const patternDashboardEl = document.getElementById('patternDashboard');
            const patternSection = document.getElementById('patternSection'); // patternSection DOM ìš”ì†Œ ì¶”ê°€

            const situationAlertsEl = document.getElementById('situationAlerts');
            const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
            const situationSection = document.getElementById('situationSection'); // situationSection DOM ìš”ì†Œ ì¶”ê°€

            const reportShareButton = document.getElementById('reportShareButton');
            const containerEl = document.querySelector('.container');

            // --- ë°ì´í„° ë¡œë“œ ---
            // loggedInUserIdëŠ” ì´ í˜ì´ì§€ì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ. í•„ìš”í•œ ì •ë³´ëŠ” localStorageì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´.
            const userAge = parseInt(localStorage.getItem('lozee_userage'), 10) || 0;
            if(realAgeEl) realAgeEl.textContent = userAge > 0 ? userAge : "ì •ë³´ ì—†ìŒ"; // ì‹¤ì œ ë‚˜ì´ í‘œì‹œ
            console.log("Analysis Page - User Age:", userAge);

            const analysisDataString = localStorage.getItem('lozee_conversation_analysis');
            let analysisResults = null;
            let accumulatedDurationMinutes = 0;

            if (!analysisDataString) {
                console.warn("Analysis Page: localStorageì— 'lozee_conversation_analysis' ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                if (containerEl) {
                    // ë¶„ì„ ë°©ë²•ë¡  ì„¹ì…˜ì„ ì œì™¸í•œ ëª¨ë“  ë¶„ì„ ê´€ë ¨ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                    document.querySelectorAll('.section:not(#analysisMethodologySection)').forEach(sec => {
                        if(sec && sec.id !== 'analysisMethodologySection') sec.style.display = 'none';
                    });
                     if (!containerEl.querySelector('.no-data-message')) { // ì¤‘ë³µ ë°©ì§€
                        const noDataMsgDiv = document.createElement('div');
                        noDataMsgDiv.className = 'feedback neutral no-data-message'; // CSS í´ë˜ìŠ¤ í™œìš©
                        noDataMsgDiv.style.textAlign = 'center';
                        noDataMsgDiv.style.marginTop = '20px';
                        noDataMsgDiv.innerHTML = '<h2>ì•„ì§ ë¡œì§€ì™€ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šë‚˜ ë´ìš”! ğŸ˜®</h2><p>ë¨¼ì € ë¡œì§€ì™€ ì‹ ë‚˜ê²Œ ì´ì•¼ê¸°í•˜ê³  ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>';
                        const methodologySection = document.getElementById('analysisMethodologySection');
                        let referenceNodeForMessage = methodologySection; // ê¸°ë³¸ì ìœ¼ë¡œ ë°©ë²•ë¡  ì„¹ì…˜ ì•ì— ì‚½ì… ì‹œë„

                        // ë” ë‚˜ì€ ìœ„ì¹˜ ì°¾ê¸°: h1 ë‹¤ìŒ, ë˜ëŠ” ì²« ë²ˆì§¸ .section ì•ì—
                        const pageH1 = containerEl.querySelector('h1');
                        if (pageH1 && pageH1.nextElementSibling) {
                             referenceNodeForMessage = pageH1.nextElementSibling; // ê³µìœ  ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ë‹¤ìŒ
                             if (referenceNodeForMessage.nextElementSibling) { // ì²«ë²ˆì§¸ ì„¹ì…˜ì´ ìˆë‹¤ë©´ ê·¸ ì•ì—
                                referenceNodeForMessage = referenceNodeForMessage.nextElementSibling;
                             }
                        }

                        if (referenceNodeForMessage && referenceNodeForMessage.parentElement === containerEl) {
                            containerEl.insertBefore(noDataMsgDiv, referenceNodeForMessage);
                        } else { // ìµœí›„ì˜ ìˆ˜ë‹¨
                             containerEl.appendChild(noDataMsgDiv);
                        }
                    }
                }
                return;
            }

            // ì¤‘ë³µëœ try-catch ë¸”ë¡ ìˆ˜ì •
            try {
                const fullAnalysis = JSON.parse(analysisDataString);
                analysisResults = fullAnalysis.results;
                accumulatedDurationMinutes = parseFloat(fullAnalysis.accumulatedDurationMinutes) || 0;
            } catch (e) {
                console.error("ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜:", e);
                if (containerEl) containerEl.innerHTML = '<h1>ì•—! ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš” ğŸ˜¥</h1><p style="text-align:center;">ì´ì „ ëŒ€í™”ë¡œ ëŒì•„ê°€ê±°ë‚˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            if (!analysisResults) {
                console.warn("Analysis Page: íŒŒì‹± í›„ analysisResults ê°ì²´ê°€ nullì…ë‹ˆë‹¤.");
                // languageAgeSectionì€ ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë˜ì—ˆì„ ìˆ˜ ìˆìŒ. ë‹¤ë¥¸ ì„¹ì…˜ë„ ë°ì´í„° ì—†ìŒ ì²˜ë¦¬ í•„ìš” ì‹œ ì¶”ê°€.
                 if(emotionToneSection) emotionToneSection.innerHTML = '<p style="text-align:center;color:#777;">ê°ì • ë¶„ì„ ë°ì´í„°ê°€ ì—†ì–´ìš”.</p>';
                 if(patternSection) patternSection.innerHTML = '<p style="text-align:center;color:#777;">íŒ¨í„´ ë¶„ì„ ë°ì´í„°ê°€ ì—†ì–´ìš”.</p>';
                 if(situationSection) situationSection.innerHTML = '<p style="text-align:center;color:#777;">ìƒê° íƒí—˜ ë°ì´í„°ê°€ ì—†ì–´ìš”.</p>';
                return;
            }

            // --- ê° ë¶„ì„ ì„¹ì…˜ ë Œë”ë§ ---

            // 1. ì–¸ì–´Â·ë‚˜ì´ ë¶„ì„ (12ì„¸ ì´í•˜ ì‚¬ìš©ìì—ê²Œë§Œ í‘œì‹œ)
            if (languageAgeSection) {
                if (userAge > 0 && userAge <= 12 && analysisResults.ageLanguageAnalysis) {
                    languageAgeSection.style.display = 'block';
                    const langAnalysis = analysisResults.ageLanguageAnalysis;

                    // ëˆ„ì  ëŒ€í™” ì‹œê°„ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                    // ... (ì´ì „ ë‹µë³€ì˜ if (accumulatedDurationMinutes < 30) { ... } else if ... ë“± ì½”ë“œ ì „ì²´) ...
                    if (accumulatedDurationMinutes < 30) {
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = "...";
                        if (ageDifferenceVisualEl) ageDifferenceVisualEl.textContent = "";
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = "ì–¸ì–´ ë¶„ì„ì„ ë°›ìœ¼ë ¤ë©´ ëˆ„ì  30ë¶„ ì´ìƒ ëŒ€í™”í•´ì•¼ í•©ë‹ˆë‹¤ ğŸ˜Š"; ageFeedbackEl.className = 'feedback neutral'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn) languagePracticeBtn.style.display = 'none';
                    } else if (accumulatedDurationMinutes < 120) { // 1ë‹¨ê³„
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = langAnalysis.stage1PredictedAge || "ë¶„ì„ ì¤€ë¹„ ì¤‘";
                        if (ageDifferenceVisualEl && langAnalysis.stage1DifferenceSymbol && langAnalysis.stage1DifferenceText) ageDifferenceVisualEl.innerHTML = `${langAnalysis.stage1DifferenceSymbol} <span style="font-size:0.8em; margin-left:4px;">(${langAnalysis.stage1DifferenceText})</span>`;
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = langAnalysis.stage1Feedback || "30ë¶„ ë„˜ê²Œ ì´ì•¼ê¸°í•´ì¤˜ì„œ ê³ ë§ˆì›Œ! ì–¸ì–´ ë¶„ì„ì„ ì‹œì‘í• ê²Œ."; ageFeedbackEl.className = 'feedback positive'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn) languagePracticeBtn.style.display = 'none'; // ë˜ëŠ” 'inline-block'ìœ¼ë¡œ ë³€ê²½
                    } else if (accumulatedDurationMinutes < 300) { // 2ë‹¨ê³„ (ì˜ˆì‹œì—ì„œëŠ” 300ë¶„=5ì‹œê°„ìœ¼ë¡œ ë˜ì–´ ìˆìœ¼ë‚˜, ì´ì „ì—ëŠ” 360ë¶„=6ì‹œê°„ì´ì—ˆìŒ. ì¼ê´€ì„± í™•ì¸ í•„ìš”)
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = langAnalysis.stage2PredictedAge || "ë¶„ì„ ì¤€ë¹„ ì¤‘";
                        if (ageDifferenceVisualEl && langAnalysis.stage2DifferenceSymbol && langAnalysis.stage2DifferenceText) ageDifferenceVisualEl.innerHTML = `${langAnalysis.stage2DifferenceSymbol} <span style="font-size:0.8em; margin-left:4px;">(${langAnalysis.stage2DifferenceText})</span>`;
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = langAnalysis.stage2Feedback || "2ì‹œê°„ ë„˜ê²Œ ì´ì•¼ê¸°í–ˆë„¤! ë” ê¹Šì€ ë¶„ì„ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤„ê²Œ."; ageFeedbackEl.className = 'feedback neutral'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn && langAnalysis.stage2PredictedAge) languagePracticeBtn.style.display = 'inline-block'; // 2ë‹¨ê³„ë¶€í„° ì—°ìŠµ ë²„íŠ¼ í‘œì‹œ
                    } else { // 3ë‹¨ê³„
                        if (predictedLangAgeEl) predictedLangAgeEl.textContent = langAnalysis.stage3PredictedAge || "ë¶„ì„ ì¤€ë¹„ ì¤‘";
                        if (ageDifferenceVisualEl && langAnalysis.stage3DifferenceSymbol && langAnalysis.stage3DifferenceText) ageDifferenceVisualEl.innerHTML = `${langAnalysis.stage3DifferenceSymbol} <span style="font-size:0.8em; margin-left:4px;">(${langAnalysis.stage3DifferenceText})</span>`;
                        if (ageFeedbackEl) { ageFeedbackEl.textContent = langAnalysis.stage3Feedback || "5ì‹œê°„ ë„˜ê²Œ ì´ì•¼ê¸°í•´ì¤˜ì„œ ì •ë§ ê³ ë§ˆì›Œ! ê°€ì¥ ì •í™•í•œ ë¶„ì„ì„ ë³´ì—¬ì¤„ê²Œ."; ageFeedbackEl.className = 'feedback positive'; ageFeedbackEl.style.display = 'block';}
                        if (languagePracticeBtn && langAnalysis.stage3PredictedAge) languagePracticeBtn.style.display = 'inline-block';
                    }

                } else {
                    languageAgeSection.style.display = 'none';
                }
            }


            // 2. ê°ì • ì–´ì¡° ë° íƒœê·¸ í´ë¼ìš°ë“œ
            const emotionToneSection = document.getElementById('emotionToneSection'); // DOM ìš”ì†Œ ì°¸ì¡° í™•ì¸
            if (emotionToneSection) {
                if (chartJsIsReady && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                    if(emotionChartEl) emotionChartEl.style.display = 'block';
                    if(emotionChartContainerEl && emotionChartContainerEl.querySelector('.no-chart-message')) {
                         emotionChartContainerEl.querySelector('.no-chart-message').remove();
                    }
                    renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                    if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                } else {
                    if(emotionChartEl) emotionChartEl.style.display = 'none';
                    if(emotionChartContainerEl && !emotionChartContainerEl.querySelector('.no-chart-message')) {
                        const noDataMsg = document.createElement('p');
                        noDataMsg.textContent = chartJsIsReady ? "ë¶„ì„ì´ ìŒ“ì´ë©´ ì—¬ê¸°ì— ë§ˆìŒ ìƒ‰ê¹” ì°¨íŠ¸ê°€ ì™„ì„±ë  ê±°ì•¼! ğŸ˜Š" : "ì°¨íŠ¸ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ğŸ˜¥";
                        noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888'; noDataMsg.classList.add('no-chart-message');
                        emotionChartContainerEl.appendChild(noDataMsg);
                    }
                    if(empathyMessageEl) { empathyMessageEl.textContent = "ì•„ì§ì€ ë„¤ ë§ˆìŒì† ê°ì •ë“¤ì„ ìì„¸íˆ ì•Œê¸° ì–´ë ¤ì›Œ. ë¡œì§€ë‘ ë” ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì!"; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; }
                }
                if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                     // renderTagCloudëŠ” tagsê°€ [{text:"í‚¤ì›Œë“œ", weight: ìˆ«ì}] í˜•íƒœë¥¼ ê¸°ëŒ€í•¨
                    if(tagCloudEl) renderTagCloud('tagCloud', analysisResults.keywords.map(kw => ({ text: kw, weight: Math.floor(5 + Math.random() * 10) })));
                } else { if(tagCloudEl) tagCloudEl.innerHTML = '<p style="text-align:center; color:#888;">ì´ì•¼ê¸° ì†ì—ì„œ ìì£¼ ë‚˜ì˜¨ ë‹¨ì–´ë“¤ì„ ëª¨ìœ¼ê³  ìˆì–´ìš”!</p>';}
            }

            // 3. ë°˜ë³µ íŒ¨í„´
            if (patternSection) { // patternSection ë³€ìˆ˜ê°€ ìœ„ì—ì„œ ì •ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸ í•„ìš”
                if (analysisResults.patterns && analysisResults.patterns.length > 0) {
                    if(patternDashboardEl) renderPatternDashboard('patternDashboard', analysisResults.patterns);
                } else { if(patternDashboardEl) patternDashboardEl.innerHTML = '<p style="text-align:center; color:#888;">ë°˜ë³µë˜ëŠ” ì´ì•¼ê¸° íŒ¨í„´ì„ ì°¾ê³  ìˆì–´ìš”!</p>';}
            }

            // 4. ìƒí™© ë¶„ì„ (ì¸ì§€ì™œê³¡)
            if (situationSection) { // situationSection ë³€ìˆ˜ê°€ ìœ„ì—ì„œ ì •ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸ í•„ìš”
                const situationChartToHide = document.getElementById('situationChart'); // ì´ ì°¨íŠ¸ëŠ” í˜„ì¬ ì‚¬ìš© ì•ˆí•¨
                if(situationChartToHide) situationChartToHide.style.display = 'none';

                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions);
                    if (continueDistortionTalkBtn) {
                        continueDistortionTalkBtn.style.display = 'inline-block';
                        continueDistortionTalkBtn.onclick = () => {
                            // "ë¡œì§€ì™€ì˜ ì•½ì†" ìƒì„± ë° talk.htmlë¡œ ì´ì–´ê°€ê¸° ë¡œì§ ì—°ê²°
                            createImprovementPlanIfNeeded(analysisResults, userAge); // í˜„ì¬ userAgeëŠ” ëŒ€í™” ëŒ€ìƒì˜ ë‚˜ì´
                            const plan = (JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]')).find(p => p.type === 'cognitive_distortion' && analysisResults.cognitiveDistortions.includes(p.details));
                            if (plan) {
                                const continueTopicData = {
                                    type: 'continue_improvement_plan',
                                    planType: plan.type,
                                    details: plan.topic || plan.details,
                                    prompt: plan.promptForContinuation || `"${plan.details}" ìƒê° íŒ¨í„´ì— ëŒ€í•´ ë” ì´ì•¼ê¸° ë‚˜ëˆ ë³¼ê¹Œìš”?`
                                };
                                localStorage.setItem('lozee_talk_init_topic', JSON.stringify(continueTopicData));
                                window.location.href = 'talk.html';
                            } else {
                                alert("ì´ì–´ê°ˆ ì•½ì† ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                            }
                        };
                    }
                } else {
                    if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">íŠ¹ë³„íˆ í•œìª½ìœ¼ë¡œ ê¸°ìš¸ì–´ì§„ ìƒê° ì—†ì´ ì´ì•¼ê¸°ë¥¼ ì˜ ë‚˜ëˆ„ê³  ìˆêµ¬ë‚˜! ì˜í–ˆì–´! ğŸ‘</p>';
                    if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                }
            }

            // ê³µìœ  ë²„íŠ¼ ë¡œì§
            if(reportShareButton) {
                reportShareButton.onclick = () => {
                    const reportId = (localStorage.getItem('lozee_username') || 'user') + "_" + new Date().getTime(); // ì‚¬ìš©ì ì´ë¦„ ì‚¬ìš©
                    const shareableLink = `${window.location.origin}${window.location.pathname}?report_id=${reportId}`;
                    // ì‹¤ì œ ë³´ê³ ì„œ ì €ì¥ ë¡œì§ì€ Firebase Functions ë“±ì„ í†µí•´ êµ¬í˜„ í•„ìš”
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(shareableLink)
                            .then(() => {
                                alert('ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n' + shareableLink + '\n(ì‹¤ì œ ê³µìœ ë¥¼ ìœ„í•´ì„œëŠ” ë³´ê³ ì„œ ì €ì¥ ê¸°ëŠ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.)');
                            })
                            .catch(err => {
                                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                                alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n' + shareableLink);
                            });
                    } else {
                        prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ê³µìœ í•˜ì„¸ìš” (ì‹¤ì œ ê³µìœ  ê¸°ëŠ¥ì€ ì¶”ê°€ êµ¬í˜„ í•„ìš”):', shareableLink);
                    }
                };
            }
             // ë¶„ì„ ê²°ê³¼ ë¡œë“œ í›„, "ë¡œì§€ì™€ì˜ ì•½ì†" ìƒì„± (í•„ìš”ì‹œ)
            if (analysisResults) {
                 createImprovementPlanIfNeeded(analysisResults, userAge);
            }

        }); // DOMContentLoaded ë

        // --- ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ë“¤ ---
        // renderTagCloud, renderPatternDashboard, alertCognitiveDistortions,
        // renderEmotionChart, displayEmpathyMessage í•¨ìˆ˜ëŠ” ì—¬ê¸°ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.
        // (ì´ì „ ë‹µë³€ì—ì„œ ì œê³µëœ ì™„ì„±ëœ í•¨ìˆ˜ ì½”ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤)
        function renderTagCloud(elementId, tags) { const cloudEl = document.getElementById(elementId); if(!cloudEl) return; if(tags && tags.length > 0) { cloudEl.innerHTML = tags.map(tag => { const size = 0.8 + ((tag.weight || 5) / 15); const opacity = Math.max(0.5, (tag.weight || 5) / 10); return `<span class="badge" style="opacity:${opacity}; font-size:${size}em;">${tag.text}</span>`; }).join(''); } else { cloudEl.innerHTML = '<p style="text-align:center; color:#888;">ì´ì•¼ê¸°ì—ì„œ ìì£¼ ë‚˜ì˜¨ ë‹¨ì–´ë“¤ì„ ëª¨ìœ¼ê³  ìˆì–´ìš”!</p>'; } }
        function renderPatternDashboard(elementId, patterns) { const dashEl = document.getElementById(elementId); if(!dashEl) return; if(patterns && patterns.length > 0) { dashEl.innerHTML = patterns.map(p => `<p>ğŸ’¡ ${p}</p>`).join(''); } else { dashEl.innerHTML = '<p style="text-align:center; color:#888;">ë°˜ë³µë˜ëŠ” ì´ì•¼ê¸° íŒ¨í„´ì„ ì°¾ê³  ìˆì–´ìš”!</p>'; } }
        function alertCognitiveDistortions(elementId, distortions) { const alertEl = document.getElementById(elementId); if(!alertEl) return; if(distortions && distortions.length > 0) { alertEl.innerHTML = distortions.map(d => `<p class="cognitive-distortion-item">${d}</p>`).join(''); } else { alertEl.innerHTML = '<p style="text-align:center; color:#888;">íŠ¹ë³„íˆ í•œìª½ìœ¼ë¡œ ê¸°ìš¸ì–´ì§„ ìƒê° ì—†ì´ ì´ì•¼ê¸°ë¥¼ ì˜ ë‚˜ëˆ„ê³  ìˆêµ¬ë‚˜! ì˜í–ˆì–´! ğŸ‘</p>';} }
        function renderEmotionChart(canvasId, emotionData) {
            if (!chartLibraryInitialized || typeof Chart === 'undefined') { /* ... */ return; }
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            const chartContainer = document.getElementById('emotionChartContainer');
            const chartEl = document.getElementById(canvasId);
            if (!ctx) { /* ... */ return; }
            if (!emotionData || Object.keys(emotionData).length === 0) { /* ... */ return; }
            if(chartContainer) { const exMsg = chartContainer.querySelector('.no-chart-message') || chartContainer.querySelector('.no-chart-library-message'); if (exMsg) exMsg.remove(); if(chartEl) chartEl.style.display = 'block';}
            const existingChart = Chart.getChart(ctx); if (existingChart) { existingChart.destroy(); }
            const emotionColors = { 'ê¸°ì¨': 'rgba(255, 205, 86, 0.7)','ìŠ¬í””': 'rgba(54, 162, 235, 0.7)','ë¶„ë…¸': 'rgba(255, 99, 132, 0.7)','ë¶ˆì•ˆ': 'rgba(153, 102, 255, 0.7)','ìˆ˜ì¹˜': 'rgba(255, 159, 64, 0.7)','ì¤‘ë¦½': 'rgba(201, 203, 207, 0.7)'};
            const labels = Object.keys(emotionData); const dataValues = Object.values(emotionData);
            const backgroundColors = labels.map(label => emotionColors[label] || 'rgba(100,100,100,0.7)');
            new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ label: 'ë‚˜ì˜ ë§ˆìŒ ë¹„ìœ¨', data: dataValues, backgroundColor: backgroundColors, borderColor: '#ffffff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: Chart.defaults.color, font: { family: Chart.defaults.font.family, size: 11 }, padding: 15 } }, tooltip: { titleFont: { family: Chart.defaults.font.family }, bodyFont: { family: Chart.defaults.font.family } } } } });
        }
        function displayEmpathyMessage(emotionData) {
            const empathyMessageEl = document.getElementById('empathyMessage');
            if (!empathyMessageEl || !emotionData || Object.keys(emotionData).length === 0) { if (empathyMessageEl) empathyMessageEl.style.display = 'none'; return; }
            const entries = Object.entries(emotionData).filter(([, score]) => score > 0);
            if (entries.length === 0) { empathyMessageEl.textContent = 'ëŒ€í™”ì—ì„œ ë‹¤ì–‘í•œ ê°ì •ë“¤ì„ íƒìƒ‰í•´ë³¼ ìˆ˜ ìˆì–´ìš”.'; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; return; }
            entries.sort((a, b) => b[1] - a[1]);
            const [dominantEmotion, score] = entries[0]; let msg = ''; let sentimentClass = 'neutral';
            if (score > 0.3) {
                switch (dominantEmotion) {
                    case 'ê¸°ì¨': msg = `ëŒ€í™”ì—ì„œ <strong>ì¦ê±°ì›€</strong>ì´ ëŠê»´ì§€ë„¤ìš”! ì¢‹ì€ ìˆœê°„ë“¤ì„ ë§ì´ ë‚˜ëˆ„ì…¨ë‚˜ ë´ìš”. ğŸ˜Š`; sentimentClass = 'positive'; break;
                    case 'ìŠ¬í””': msg = `<strong>ìŠ¬í””ì´ë‚˜ ì†ìƒí•¨</strong>ì´ ëŠê»´ì§€ëŠ” ë¶€ë¶„ì´ ìˆì—ˆì–´ìš”. ê·¸ ë§ˆìŒì— ë¡œì§€ê°€ ê·€ ê¸°ìš¸ì¼ê²Œìš”. í„¸ì–´ë†“ì•„ ì£¼ì…”ì„œ ê³ ë§ˆì›Œìš”.`; sentimentClass = 'negative'; break;
                    case 'ë¶„ë…¸': msg = `<strong>í™”ë‚˜ê±°ë‚˜ ë‹µë‹µí•œ ê°ì •</strong>ì´ ìˆì—ˆë˜ ê²ƒ ê°™ì•„ìš”. ê·¸ëŸ° ê°ì •ë„ ì†Œì¤‘í•œ ë‚´ ë§ˆìŒì˜ ì‹ í˜¸ëë‹ˆë‹¤.`; sentimentClass = 'negative'; break;
                    case 'ë¶ˆì•ˆ': msg = `<strong>ê±±ì •ì´ë‚˜ ë¶ˆì•ˆí•¨</strong>ì´ ëŠê»´ì¡Œì–´ìš”. ì–´ë–¤ ì ì´ ë§ˆìŒì„ ë¶ˆí¸í•˜ê²Œ í–ˆëŠ”ì§€ í•¨ê»˜ ì‚´í´ë³¼ê¹Œìš”?`; sentimentClass = 'negative'; break;
                    case 'ìˆ˜ì¹˜': msg = `í˜¹ì‹œ <strong>ë¶€ë„ëŸ½ê±°ë‚˜ ë‹¹í™©ìŠ¤ëŸ¬ìš´ ë§ˆìŒ</strong>ì´ ë“œì…¨ë‚˜ìš”? ê´œì°®ì•„ìš”, ì—¬ê¸°ëŠ” ì•ˆì „í•œ ê³µê°„ì´ì—ìš”.`; sentimentClass = 'neutral'; break;
                    case 'ì¤‘ë¦½': msg = `ëŒ€í™”ê°€ ì „ë°˜ì ìœ¼ë¡œ <strong>ì°¨ë¶„í•˜ê²Œ</strong> ì§„í–‰ëœ ê²ƒ ê°™ì•„ìš”. ìƒê°ì„ ì •ë¦¬í•˜ëŠ” ë° ë„ì›€ì´ ë˜ì—ˆê¸¸ ë°”ë¼ìš”.`; sentimentClass = 'neutral'; break;
                    default: msg = 'ë‹¤ì–‘í•œ ê°ì •ë“¤ì„ í‘œí˜„í•´ì£¼ì…¨ë„¤ìš”. ìì‹ ì˜ ê°ì •ì„ ì•Œì•„ì°¨ë¦¬ëŠ” ê²ƒì€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.'; sentimentClass = 'neutral';
                }
            } else { msg = 'ì´ì•¼ê¸°ë¥¼ í†µí•´ ë‹¤ì–‘í•œ ê°ì •ë“¤ì„ íƒìƒ‰í•˜ê³  í‘œí˜„í•˜ëŠ” ì—°ìŠµì„ í•  ìˆ˜ ìˆì–´ìš”.'; sentimentClass = 'neutral'; }
            empathyMessageEl.innerHTML = msg; empathyMessageEl.className = `feedback ${sentimentClass}`; empathyMessageEl.style.display = 'block';
        }
        // "ë¡œì§€ì™€ì˜ ì•½ì†" ìƒì„± í•¨ìˆ˜
        function createImprovementPlanIfNeeded(analysisResults, userAge) {
            let plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]' );
            const currentJournalId = localStorage.getItem('lozee_selected_journal_id') || `session_${new Date().getTime()}`; // í˜„ì¬ ë¶„ì„ ì¤‘ì¸ ì €ë„ ID ë˜ëŠ” ì„¸ì…˜ ì‹ë³„ì

            // 1. ì¸ì§€ì™œê³¡ ê´€ë ¨ ì•½ì† ìƒì„±
            if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                analysisResults.cognitiveDistortions.forEach(distortion => {
                    const planId = `cog_${currentJournalId}_${distortion.replace(/\s+/g, '_').substring(0,20)}`; // ID ê¸¸ì´ ì œí•œ ê³ ë ¤
                    const existingPlan = plans.find(p => p.id === planId);
                    if (!existingPlan) {
                        plans.push({
                            id: planId,
                            type: 'cognitive_distortion',
                            title: `ìƒê° ìŠµê´€ ëŒì•„ë³´ê¸°: "${distortion}"`,
                            details: distortion,
                            topic: analysisResults.summaryTitle || "ìµœê·¼ ëŒ€í™” ì£¼ì œ",
                            promptForContinuation: `ì§€ë‚œë²ˆì— "${analysisResults.summaryTitle || 'ì´ ëŒ€í™”'}"ì—ì„œ ë‚˜íƒ€ë‚¬ë˜ "${distortion}" ìƒê° íŒ¨í„´ì— ëŒ€í•´ ë” ê¹Šì´ ì´ì•¼ê¸° ë‚˜ëˆ ë³¼ê¹Œìš”? ì–´ë–¤ ìƒí™©ì—ì„œ ê·¸ëŸ° ìƒê°ì´ ë“¤ì—ˆê³ , ê·¸ë¡œ ì¸í•´ ì–´ë–¤ ê°ì •ì„ ëŠë¼ì…¨ëŠ”ì§€ í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”.`
                        });
                    }
                });
            }

            // 2. ì–¸ì–´ ì—°ë ¹ ì°¨ì´ ê´€ë ¨ ì•½ì† ìƒì„± (12ì„¸ ì´í•˜ ì‚¬ìš©ìì—ê²Œë§Œ í•´ë‹¹)
            if (userAge > 0 && userAge <= 12 && analysisResults.ageLanguageAnalysis) {
                const langAnalysis = analysisResults.ageLanguageAnalysis;
                const realUserAge = userAge; // ì´ë¯¸ ìˆ«ìë¡œ ë³€í™˜ë¨
                let predictedUserAgeNum = null;

                // "Xì„¸", "X-Yì„¸" í˜•íƒœì˜ predictedAgeë¥¼ ìˆ«ì(ë˜ëŠ” ë²”ìœ„ì˜ ì¤‘ê°„ê°’)ë¡œ ë³€í™˜ ì‹œë„
                if (langAnalysis.predictedAge) {
                    const ageMatch = String(langAnalysis.predictedAge).match(/(\d+)(-(\d+))?/);
                    if (ageMatch && ageMatch[1]) {
                        predictedUserAgeNum = parseInt(ageMatch[1]);
                        if (ageMatch[3]) { // ë²”ìœ„ì¸ ê²½ìš° (X-Yì„¸)
                            predictedUserAgeNum = (predictedUserAgeNum + parseInt(ageMatch[3])) / 2;
                        }
                    }
                }
                
                if (predictedUserAgeNum !== null) {
                    const ageDifference = Math.abs(predictedUserAgeNum - realUserAge);
                    if (ageDifference >= 0.5) { // 6ê°œì›” ì´ìƒ ì°¨ì´
                        const planId = `lang_${currentJournalId}_age_diff`;
                        const existingPlan = plans.find(p => p.id === planId);
                        if (!existingPlan) {
                            plans.push({
                                id: planId,
                                type: 'language_practice',
                                title: `ë§ì†œì”¨ ë°œì „ì‹œí‚¤ê¸°`,
                                details: `ì–¸ì–´ í‘œí˜„ë ¥ í–¥ìƒ (ì˜ˆìƒ ${langAnalysis.predictedAge}, ì‹¤ì œ ${realUserAge}ì„¸)`,
                                topic: "ì–¸ì–´ í‘œí˜„ ì—°ìŠµ",
                                predictedAge: langAnalysis.predictedAge, // ë¬¸ìì—´ í˜•íƒœ ìœ ì§€
                                userAge: realUserAge, // ìˆ«ì
                                promptForContinuation: `ì§€ë‚œë²ˆ ë¶„ì„ì—ì„œ ë‚´ ë§ì†œì”¨ê°€ ${langAnalysis.predictedAge} ì •ë„ë¡œ ë³´ì˜€ëŠ”ë°, ì‹¤ì œ ë‚˜ì´(${realUserAge}ì„¸)ì™€ ì¡°ê¸ˆ ì°¨ì´ê°€ ìˆì—ˆì§€? í•¨ê»˜ ì—°ìŠµí•˜ë©´ì„œ ìƒê°ì´ë‚˜ ëŠë‚Œì„ ë” ì˜ í‘œí˜„í•˜ëŠ” ë°©ë²•ì„ ì°¾ì•„ë³´ì! ì–´ë–¤ ë§ë¶€í„° ì—°ìŠµí•´ë³¼ê¹Œ?`
                            });
                        }
                    }
                }
            }

            // ì¤‘ë³µ ì œê±° (ê°™ì€ IDì˜ ì•½ì†ì´ ì—¬ëŸ¬ ë²ˆ ì¶”ê°€ë˜ëŠ” ê²ƒ ë°©ì§€)
            const uniquePlans = plans.filter((plan, index, self) =>
                index === self.findIndex((p) => (p.id === plan.id))
            );

            if (uniquePlans.length > 0) {
                localStorage.setItem('lozee_improvement_plans', JSON.stringify(uniquePlans));
                console.log("Analysis Page: ê°œì„  ê³„íš ì €ì¥ë¨:", uniquePlans);
            } else {
                 console.log("Analysis Page: ìƒì„±í•  ìƒˆë¡œìš´ ê°œì„  ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>