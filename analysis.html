<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE와 함께하는 마음 탐험!</title>
    <link
        href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" href="gnb.css"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* analysis.html 페이지 고유 스타일 (이전과 동일) */
        :root {
            --primary-color-analysis: #6078ea;
            --card-bg-analysis: #ffffff;
            --text-color-analysis: #333333;
            --explanation-bg-analysis: #eef2f7;
            --gnb-height: 56px; 
        }
        body, html { 
            margin:0; 
            padding:0; 
            font-family:'KoPub World Dotum', sans-serif; 
            background:#f4f6f8; 
            color: var(--text-color-analysis); 
        }
        body { padding-top: var(--gnb-height); }
        .container { max-width:900px; margin:25px auto; padding:0 25px; box-sizing: border-box; }
        h1 { color: var(--primary-color-analysis); text-align: center; font-size: 2em; margin-bottom: 15px; font-weight: 700; }
        .share-button-container { text-align: center; margin-bottom: 30px; }
        #reportShareButton { background-color: #6e8efb; color: white; padding: 10px 20px; border: none; border-radius: 20px; font-size: 0.95em; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #reportShareButton:hover { background-color: #5a7edf; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .assistant-analysis-notice { font-size: 0.75em; color: #78909c; margin-top: -12px; margin-bottom: 15px; text-align: right; }
        .module-explanation { font-size:0.9em; color:#555; margin-bottom:15px; padding: 10px; background-color: var(--explanation-bg-analysis); border-radius: 6px; line-height: 1.6; }
        h2 { margin-top:0; margin-bottom: 8px; font-size:1.5em; color:#34495e; border-bottom: 2px solid #e0e0e0; padding-bottom: 12px; }
        .section { background:var(--card-bg-analysis); padding:25px; margin-top:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
        .section p { color: #555555; line-height: 1.7; font-size: 1em; }
        .section p span { color: #2c3e50; font-weight: bold; }
        .feedback { margin-top:15px; padding:12px 18px; border-left-width:5px; border-left-style:solid; border-radius:8px; font-size: 0.95em; line-height: 1.6; }
        .feedback.negative { background:#ffebee; border-left-color: #c62828; color:#c62828; }
        .feedback.positive { background:#e8f5e9; border-left-color: #2e7d32; color:#2e7d32; }
        .feedback.neutral { background:#eceff1; border-left-color: #546e7a; color:#37474f; }
        #emotionChartContainer { position: relative; max-width: 450px; min-height: 100px; height: auto; margin: 20px auto 0; display: flex; align-items: center; justify-content: center;}
        #emotionChart, #situationChart { width:100% !important; height:auto !important; aspect-ratio: 1 / 1; background-color: #fdfdfd; border-radius: 8px; border: 1px solid #e0e0e0; padding: 15px; box-sizing: border-box; display: none; }
        #tagCloud { min-height:100px; border:1px dashed #cccccc; padding:15px; margin-top: 20px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
        .badge { display:inline-block; margin:4px; padding:8px 12px; background:#e8eaf6; color: #3f51b5; border-radius:16px; font-size:0.9em; transition: background-color 0.2s, color 0.2s; font-weight: 500; }
        .badge:hover { background-color: #c5cae9; color: #303f9f; }
        #patternDashboard { margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; color: #444; min-height: 50px; }
        #patternDashboard p { color: #444; margin-bottom: 8px; }
        #situationAlerts { margin-top: 15px; min-height: 50px; }
        #situationAlerts .cognitive-distortion-item { background:#fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9em; }
        .footer-assistant-notice { text-align: center; margin-top: 40px; margin-bottom: 20px; font-size: 0.8em; color: #78909c; }
        .methodology-list { list-style-type: none; padding-left: 0; font-size: 0.9em; color: #555; }
        .methodology-list li { margin-bottom: 12px; padding-left: 25px; position: relative; }
        .methodology-list li::before { content: "💡"; color: #6078ea; position: absolute; left: 0; font-size: 1.1em; }
        .methodology-list li strong { color: #34495e; }
        .action-button { display: inline-block; margin-top: 15px; background-color: #6e8efb; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .action-button:hover { background-color: #5a7edf; }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 480px) { /* ... */ }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a> 
          <a href="index.html">✨ 새로운 이야기 시작!</a> 
          <a href="analysis.html">📊 우리 이야기 분석</a> 
          <a href="journal-list.html">📖 이야기 모음집</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a> 
        </div>
    </nav>

    <div class="container">
        <h1>🚀 로지와 함께한 이야기 탐험!</h1>
        <div class="share-button-container">
            <button id="reportShareButton">나의 이야기 보고서 공유하기 🔗</button>
        </div>

        <div class="section" id="languageAgeSection" style="display:none;"> 
            <h2>🗣️ 내 말솜씨 나이는 몇 살일까?</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                로지와 이야기하면서 네가 사용한 말들을 보고, 네 말솜씨가 몇 살 친구랑 비슷한지 알려줄게! 실제 나이랑 달라도 괜찮아, 함께 더 멋지게 말하는 법을 배우면 되니까! 😉
            </p>
            <p class="module-explanation" style="font-size: 0.85em; background-color: #e3f2fd; color: #1e88e5;">
                <strong>[로지의 약속!]</strong> 언어 분석은 총 3단계로 점점 더 정확해져! <br>
                <strong>1단계(30분~)</strong>: 우리가 처음 만나서 나눈 이야기로 살짝 엿보기! <br>
                <strong>2단계(2시간~)</strong>: 좀 더 많은 이야기를 나누면 로지가 너를 더 잘 알게 돼! <br>
                <strong>3단계(6시간~)</strong>: 와! 이제 정말 너의 멋진 말솜씨를 잘 알 것 같아! (가장 정확한 분석)
            </p>
            <p>내 진짜 나이: <span id="realAge"></span>살</p>
            <p>내 말솜씨 나이 (로지의 생각): <span id="predictedLangAge"></span> <span id="ageDifferenceVisual" style="font-weight:normal; margin-left: 8px;"></span></p>
            <div id="ageFeedback" class="feedback" style="display:none;"></div>
            <button id="languagePracticeBtn" class="action-button" style="display:none;">로지와 함께 말솜씨 키우기 쑥쑥! 🌱 (준비 중)</button>
        </div>

        <div class="section" id="analysisMethodologySection">
            </div>

        <div class="section" id="emotionToneSection">
            <h2>🌈 내 마음 색깔은 뭘까? (감정 변화)</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                우리가 나눈 이야기에서 어떤 느낌들이 많았는지, 또 어떤 단어들을 자주 사용했는지 보여줄게! 네 마음속 날씨를 함께 알아보자! ☀️🌧️
            </p>
            <div id="emotionChartContainer"> 
                <canvas id="emotionChart"></canvas> 
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p> 
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="patternSection">
            <h2>🔍 자주 나타나는 내 마음 & 단어</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                이야기하다 보면 나도 모르게 자주 쓰는 말이나 비슷한 느낌을 표현할 때가 있어. 로지가 그런 부분을 찾아봤어!
            </p>
            <div id="patternDashboard"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>🧐 생각 탐험! (나의 생각 습관)</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                여기는 우리가 나눈 이야기를 요약하고, 혹시 네 생각이 한쪽으로만 기울어지지는 않았는지(이걸 '생각 습관'이라고 불러볼까?), 어떤 특별한 점이 있는지 살펴보는 곳이야. 특별한 생각 습관이 보여도 걱정하지 마! 누구나 그럴 수 있고, 우리는 이야기하면서 함께 더 유연하게 생각하는 방법을 찾을 수 있어! 💪
            </p>
            <canvas id="situationChart" style="display:none;"></canvas> 
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">이 생각에 대해 다음에 더 이야기 나눠볼까? 🤔</button>
        </div>

        <p class="footer-assistant-notice">본 분석은 로지 AI가 마음을 담아 준비했어요.</p>
    </div>

    <script type="module">
        let chartLibraryInitialized = false;

        function initializeChartJsGlobal() {
            try {
                if (typeof Chart !== 'undefined' && Chart) { 
                    Chart.defaults.color = '#333'; 
                    Chart.defaults.borderColor = '#e0e0e0'; 
                    Chart.defaults.font.family = "'KoPub World Dotum', sans-serif"; 
                    Chart.defaults.font.size = 12; 
                    console.log("Analysis Page: Chart.js(UMD) 라이브러리가 인식되고 기본값이 설정되었습니다.");
                    chartLibraryInitialized = true;
                    return true;
                } else {
                    console.error("Analysis Page: Chart.js(UMD) 라이브러리를 찾을 수 없습니다. <head>에 스크립트가 올바르게 추가되었는지 확인하세요.");
                    const emotionChartContainer = document.getElementById('emotionChartContainer');
                    if (emotionChartContainer) {
                        emotionChartContainer.innerHTML = '<p style="text-align:center; color:red; padding:20px;">차트 기능에 문제가 있어요. 😭<br>페이지를 새로고침 해보세요.</p>';
                    }
                    return false;
                }
            } catch (error) {
                console.error("Analysis Page: Chart.js(UMD) 초기화 중 오류!", error);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => { 
            console.log("Analysis Page: DOMContentLoaded 이벤트 시작");
            const chartJsIsReady = initializeChartJsGlobal(); 

            const languageAgeSection = document.getElementById('languageAgeSection');
            const realAgeEl = document.getElementById('realAge');
            const predictedLangAgeEl = document.getElementById('predictedLangAge');
            const ageFeedbackEl = document.getElementById('ageFeedback');
            const ageDifferenceVisualEl = document.getElementById('ageDifferenceVisual');
            const languagePracticeBtn = document.getElementById('languagePracticeBtn');
            
            const emotionToneSection = document.getElementById('emotionToneSection');
            const emotionChartEl = document.getElementById('emotionChart');
            const emotionChartContainerEl = document.getElementById('emotionChartContainer');
            const empathyMessageEl = document.getElementById('empathyMessage');
            const tagCloudEl = document.getElementById('tagCloud');
            
            const patternSection = document.getElementById('patternSection');
            const patternDashboardEl = document.getElementById('patternDashboard');
            
            const situationSection = document.getElementById('situationSection');
            const situationAlertsEl = document.getElementById('situationAlerts');
            const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
            const situationChartEl = document.getElementById('situationChart');
            
            const reportShareButton = document.getElementById('reportShareButton');
            const containerEl = document.querySelector('.container');

            const userAge = parseInt(localStorage.getItem('lozee_userage'), 10) || 0; 
            if(realAgeEl) realAgeEl.textContent = userAge || "정보 없음";
            console.log("Analysis Page - User Age:", userAge);

            let analysisDataString = localStorage.getItem('lozee_conversation_analysis');
            let analysisResults = null;
            let accumulatedDurationMinutes = 0;
            let accumulatedUserCharCount = 0;

            // --- ⭐ 하드코딩된 예시 분석 데이터 (요청사항 반영) ---
            // 실제 데이터가 없을 경우 이 예시 데이터를 사용합니다.
            const sampleAnalysisForRyan = {
                startTime: Date.now() - (15 * 60 * 1000), // 15분 전 시작했다고 가정
                analysisTime: Date.now(),
                accumulatedDurationMinutes: 15, // 15분 대화했다고 가정
                accumulatedUserCharCount: 2500, // 2500자 대화했다고 가정
                results: {
                    ageLanguageAnalysis: { estimatedAgeRange: "자기 나이와 비슷" }, // 예시: 실제 나이와 비슷
                    emotionToneData: { '답답함': 5, '분노': 3, '자기이해': 4, '단호함': 4, '혼란스러움': 2 }, // 대화 내용 기반 감정
                    keywords: ["가족", "패턴", "회피", "아스퍼거", "ADHD", "기억력", "판단", "소시오패스", "안철수"],
                    patterns: [
                        "반복되는 문제 상황에 대한 명확한 인식과 해결 의지",
                        "자신의 신경다양성 특성(아스퍼거, ADHD)에 대한 깊은 이해와 이를 통한 타인 및 상황 분석",
                        "논리적이고 직설적인 대화 선호 및 비논리/회피 성향에 대한 비판적 시각"
                    ],
                    cognitiveDistortions: ["일반화의 오류 (가능성! 🤫)", "흑백논리적 사고 경향 (가능성! 🤫)"] // 예시 인지왜곡 (짧은 대화이므로 가능성으로)
                }
            };
            // 실제 데이터가 없으면 샘플 데이터 사용 (테스트용)
            if (!analysisDataString) {
                console.warn("Analysis Page: localStorage에 분석 데이터 없음. 예시 데이터를 사용합니다.");
                analysisDataString = JSON.stringify(sampleAnalysisForRyan);
            }
            // --- ⭐ 예시 데이터 끝 ---


            if (analysisDataString) {
                try {
                    const fullAnalysis = JSON.parse(analysisDataString);
                    analysisResults = fullAnalysis.results;
                    accumulatedDurationMinutes = parseFloat(fullAnalysis.accumulatedDurationMinutes) || 0;
                    accumulatedUserCharCount = parseInt(fullAnalysis.accumulatedUserCharCount, 10) || 0;
                } catch (e) {
                    console.error("저장된 분석 결과 파싱 오류:", e);
                    if (containerEl) containerEl.innerHTML = '<h1>앗! 분석 결과를 불러오는 데 문제가 생겼어요 😥</h1><p style="text-align:center;">이전 대화로 돌아가거나, 잠시 후 다시 시도해주세요.</p>';
                    return; 
                }
            } else { // 이 부분은 위에서 샘플 데이터로 대체했으므로, 실제로 도달하지 않을 수 있음
                console.warn("Analysis Page: localStorage에 'lozee_conversation_analysis' 데이터가 없습니다 (재확인).");
                // ... (데이터 없음 메시지 표시 로직은 위에서 처리) ...
                return; 
            }
            
            if (!analysisResults) {
                console.warn("Analysis Page: 파싱 후 analysisResults 객체가 null입니다.");
                // ... (데이터 없음 메시지 처리) ...
                return;
            }

            // --- 1. 언어·나이 분석 섹션 처리 ---
            if (languageAgeSection) {
                if (userAge > 12 || !analysisResults.ageLanguageAnalysis) { 
                    languageAgeSection.style.display = 'none';
                } else {
                    languageAgeSection.style.display = 'block'; 
                    let predictedText = "정보를 모으는 중... 🤔"; // 기본값
                    if (analysisResults.ageLanguageAnalysis.estimatedAgeRange === "자기 나이와 비슷") {
                        predictedText = `${userAge}살 친구와 비슷해요!`;
                    } else if (analysisResults.ageLanguageAnalysis.estimatedAgeRange.match(/\d+/)) {
                        predictedText = `${analysisResults.ageLanguageAnalysis.estimatedAgeRange.match(/\d+/)[0]} 살 친구처럼 말해요!`;
                    }
                    
                    let feedbackMsg = ''; 
                    let visualText = ''; 
                    let accuracyIcon = ''; 

                    if(ageFeedbackEl) ageFeedbackEl.className = 'feedback';

                    if (accumulatedUserCharCount >= 7000) { accuracyIcon = ' <span style="color:green; font-weight:bold;">(분석 정확도 높음! 👍)</span>';
                    } else if (accumulatedUserCharCount >= 2000) { accuracyIcon = ' <span style="color:blue;">(꽤 정확한 분석!)</span>';
                    } else { accuracyIcon = ' <span style="color:#cc7a00;">(아직은 가능성! 🤫)</span>'; }

                    if(predictedLangAgeEl) predictedLangAgeEl.innerHTML = `${predictedText}${accuracyIcon}`;

                    if (accumulatedDurationMinutes < 30) {
                        visualText = "(아직 30분이 안 돼서, 살짝 맛보기 분석이야! 🍳)";
                        feedbackMsg = "로지와 30분 이상 이야기하면 내가 얼마나 멋지게 말하는지 살짝 알려줄게! 조금만 더 이야기 나눠볼까?";
                        if(ageFeedbackEl) ageFeedbackEl.classList.add('neutral');
                    } else { // 30분 이상 대화 시
                        const predictedAgeNum = analysisResults.ageLanguageAnalysis.estimatedAgeRange.match(/\d+/) ? parseInt(analysisResults.ageLanguageAnalysis.estimatedAgeRange.match(/\d+/)[0], 10) : userAge;
                        const diffYearsApprox = userAge - predictedAgeNum;

                        if (accumulatedDurationMinutes < 120) { visualText = `(로지랑 나눈 이야기로 본 첫인상! 🌱)${accuracyIcon}`; /* ... */ } 
                        else if (accumulatedDurationMinutes < 360) { visualText = `(이야기를 더 많이 나눠보니 알 것 같아! 🌳)${accuracyIcon}`; /* ... */ } 
                        else { visualText = `(로지가 본 너의 멋진 말솜씨! 🌟)${accuracyIcon}`; /* ... */ }
                        // 상세 피드백 메시지 (이전 코드와 유사하게 구성)
                        feedbackMsg = `네 말솜씨는 ${predictedText}인 것 같아! ${visualText}`; // 예시
                        if(ageFeedbackEl) ageFeedbackEl.classList.add('neutral'); // 또는 상황에 맞게
                        
                        if (userAge <= 12 && diffYearsApprox >= 1) { 
                            if(languagePracticeBtn) languagePracticeBtn.style.display = 'inline-block';
                        } else {
                            if(languagePracticeBtn) languagePracticeBtn.style.display = 'none';
                        }
                    }
                    if(ageDifferenceVisualEl) ageDifferenceVisualEl.innerHTML = visualText;
                    if(ageFeedbackEl) { ageFeedbackEl.textContent = feedbackMsg; ageFeedbackEl.style.display = 'block';}
                    if(languagePracticeBtn && languagePracticeBtn.style.display === 'inline-block') {
                        languagePracticeBtn.onclick = () => alert("재미있는 언어 연습을 준비하고 있어! 조금만 기다려줘! 😊");
                    }
                }
            }

            // --- 2. 감정 어조 및 태그 클라우드 ---
            if (emotionToneSection) {
                if (chartJsIsReady && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                    if(emotionChartEl) emotionChartEl.style.display = 'block';
                    if(emotionChartContainerEl && emotionChartContainerEl.querySelector('.no-chart-message')) { emotionChartContainerEl.querySelector('.no-chart-message').remove(); }
                    renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                    if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                } else { 
                    if(emotionChartEl) emotionChartEl.style.display = 'none';
                    if(emotionChartContainerEl && !emotionChartContainerEl.querySelector('.no-chart-message')) {
                        const noDataMsg = document.createElement('p');
                        noDataMsg.textContent = chartJsIsReady ? "분석이 쌓이면 여기에 마음 색깔 차트가 완성될 거야! 😊" : "차트 기능을 불러오지 못했어요. 😥";
                        noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888'; noDataMsg.classList.add('no-chart-message');
                        emotionChartContainerEl.innerHTML = ''; // 기존 내용 비우고 메시지만
                        emotionChartContainerEl.appendChild(noDataMsg);
                    }
                    if(empathyMessageEl && ! (analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) ) { empathyMessageEl.textContent = "아직은 네 마음속 감정들을 자세히 알기 어려워. 로지랑 더 많은 이야기를 나눠보자!"; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; }
                }
                if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                    if(tagCloudEl) renderTagCloud('tagCloud', analysisResults.keywords.map(kw => ({ text: kw, weight: 5 + Math.floor(Math.random() * 10) })));
                } else { if(tagCloudEl) tagCloudEl.innerHTML = '<p style="text-align:center; color:#888;">이야기 속에서 자주 나온 단어들을 모으고 있어요!</p>';}
            }
            
            // --- 3. 반복 패턴 ---
            if (patternSection) {
                if (analysisResults.patterns && analysisResults.patterns.length > 0) {
                    if(patternDashboardEl) renderPatternDashboard('patternDashboard', analysisResults.patterns);
                } else { if(patternDashboardEl) patternDashboardEl.innerHTML = '<p style="text-align:center; color:#888;">반복되는 이야기 패턴을 찾고 있어요!</p>';}
            }

            // --- 4. 상황 분석 (인지왜곡) ---
            if (situationSection) {
                const situationChartToHide = document.getElementById('situationChart');
                if(situationChartToHide) situationChartToHide.style.display = 'none'; 
                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions, accumulatedUserCharCount); // charCount 전달
                    if (continueDistortionTalkBtn) { 
                        continueDistortionTalkBtn.style.display = 'inline-block'; 
                        const accuracyTextForButton = accumulatedUserCharCount < 2000 ? "(아직 이야기가 충분하지 않을 수 있어요)" : (accumulatedUserCharCount < 7000 ? "(더 이야기하면 정확해져요)" : "");
                        continueDistortionTalkBtn.innerHTML = `이 생각에 대해 다음에 더 이야기 나눠볼까? 🤔 <span style="font-size:0.8em; display:block; color:#eee;">${accuracyTextForButton}</span>`;
                        continueDistortionTalkBtn.onclick = () => { 
                            localStorage.setItem('lozee_continue_topic', JSON.stringify({ 
                                type: 'cognitive_distortion_follow_up', 
                                details: `발견된 생각 습관 (${analysisResults.cognitiveDistortions[0] || '자세히 보기'})` // 예시
                            })); 
                            alert("좋아요! 다음번에 로지를 만나면 이 생각에 대해 더 깊이 이야기 나눠봐요. 약속! 🤙");
                        }; 
                    }
                } else {
                    if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';
                    if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                }
            }

            // 공유 버튼 로직
            if(reportShareButton) { reportShareButton.onclick = () => { /* ... 기존 공유 로직 ... */ }; }
        });

        // --- 데이터 렌더링 함수들 (본문 내용 포함) ---
        function renderTagCloud(elementId, tags) { const cloudEl = document.getElementById(elementId); if(!cloudEl) return; if(tags && tags.length > 0) { cloudEl.innerHTML = tags.map(tag => { const size = 0.8 + (tag.weight / 15); const opacity = Math.max(0.5, tag.weight / 10); return `<span class="badge" style="opacity:${opacity}; font-size:${size}em;">${tag.text}</span>`; }).join(''); } else { cloudEl.innerHTML = '<p style="text-align:center; color:#888;">아직 주요 단어가 충분히 모이지 않았어요.</p>'; } }
        function renderPatternDashboard(elementId, patterns) { const dashEl = document.getElementById(elementId); if(!dashEl) return; if(patterns && patterns.length > 0) { dashEl.innerHTML = patterns.map(p => `<p>💡 ${p}</p>`).join(''); } else { dashEl.innerHTML = '<p style="text-align:center; color:#888;">반복되는 이야기 패턴을 찾고 있어요!</p>'; } }
        
        function alertCognitiveDistortions(elementId, distortions, charCount = 0) { 
            const alertEl = document.getElementById(elementId); 
            if(!alertEl) return; 
            if(distortions && distortions.length > 0) { 
                let accuracyIconText = '';
                if (charCount < 2000) { accuracyIconText = ' <span style="color:#cc7a00; font-weight:normal; font-size:0.9em;">(아직은 가능성! 🤫 더 이야기하면 정확해져요!)</span>';
                } else if (charCount < 7000) { accuracyIconText = ' <span style="color:blue; font-weight:normal; font-size:0.9em;">(꽤 신중한 분석이에요!)</span>';
                } else { accuracyIconText = ' <span style="color:green; font-weight:bold; font-size:0.9em;">(정확도 높은 분석이에요! 👍)</span>'; }
                alertEl.innerHTML = distortions.map(d => `<p class="cognitive-distortion-item">${d}${accuracyIconText}</p>`).join(''); 
            } else { 
                alertEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';
            } 
        }
        
        function renderEmotionChart(canvasId, emotionData) { /* ... 이전 답변의 완성된 도넛 차트 코드 ... */ }
        function displayEmpathyMessage(emotionData) { /* ... 이전 답변의 완성된 공감 메시지 코드 ... */ }
        function getKoreanVocativeParticle(name) { /* ... 이전 답변의 완성된 호격조사 코드 ... */ }
    </script>
    <script src="./js/gnb.js" defer></script> 
</body>
</html>