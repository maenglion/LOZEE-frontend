<script type="module">
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { db } from './js/firebase-config.js';
        import { doc, setDoc, getDoc, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const auth = getAuth();

        // --- DOM 요소 가져오기 ---
        const steps = {
            userType: document.getElementById('stepUserType'),
            caregiverNd: document.getElementById('stepCaregiverNeurodiversity'),
            diagnosisType: document.getElementById('stepDiagnosisType'),
            nameBirthSelf: document.getElementById('stepNameBirthSelf'),
            nameBirthChild: document.getElementById('stepNameBirthChild'),
            finalStart: document.getElementById('stepFinalStart')
        };

        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        // const cbtCodeInput = document.getElementById('cbtCodeInput'); // CBT 관련 요소는 현재 로직에서 제외
        // const cbtCodeError = document.getElementById('cbtCodeError');
        // const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');

        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const caregiverNdError = document.getElementById('caregiverNdError');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');

        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');

        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');
        // 라벨 DOM 요소 ID 확인 및 일치 (HTML의 for 속성과 JS의 getElementById ID가 일치해야 함)
        // const nameSelfPromptEl = document.getElementById('nameSelfPromptLabel');
        // const birthSelfPromptEl = document.getElementById('birthSelfPromptLabel');
        // const birthSelfInfoTextEl = document.getElementById('birthSelfInfoText');


        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');
        // const nameChildPromptEl = document.getElementById('nameChildPromptLabel');
        // const birthChildPromptEl = document.getElementById('birthChildPromptLabel');
        // const birthChildInfoTextEl = document.getElementById('birthChildInfoText');

        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn'); // HTML에 정의된 최종 시작 버튼 ID

        // --- 상태 변수 ---
        let currentUserId = null; // Firebase Auth UID
        let selectedUserType = ''; // 'directUser' 또는 'caregiver'
        let tempCaregiverSelfName = '', tempCaregiverSelfBirthDate = '', tempCaregiverSelfAge = null;
        let tempChildName = '', tempChildBirthDate = '', tempChildAge = null;
        // let tempChildLozeeUid = null; // 자녀 UID는 이번 단계에서 설정하지 않음 (필요시 mypage에서 연결)
        let tempDirectUserName = '', tempDirectUserBirthDate = '', tempDirectUserAge = null;
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = [];

        // --- 헬퍼 함수 ---
        function showStep(stepElement) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            if (stepElement) {
                stepElement.classList.add('active');
            } else {
                console.error("showStep: 표시할 stepElement가 유효하지 않습니다.");
            }
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) {
            if (!yearEl || !monthEl || !dayEl) {
                console.error("populateBirthSelects: 생년월일 select 요소를 찾을 수 없습니다.");
                return;
            }
            yearEl.innerHTML = '<option value="">년</option>';
            monthEl.innerHTML = '<option value="">월</option>';
            dayEl.innerHTML = '<option value="">일</option>';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - startYearOffset; y >= currentYear - endYearOffset; y--) {
                const opt = new Option(`${y}년`, y);
                yearEl.add(opt);
            }
            for (let m = 1; m <= 12; m++) {
                const opt = new Option(`${m}월`, m);
                monthEl.add(opt);
            }
            for (let d = 1; d <= 31; d++) {
                const opt = new Option(`${d}일`, d);
                dayEl.add(opt);
            }
        }

        function calculateAge(y, m, d) {
            if (!y || !m || !d) return null;
            const birth = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
            if (isNaN(birth.getTime())) return null;
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age >= 0 ? age : null;
        }

        async function saveUserProfileToFirestore(uid, profileData) {
            if (!uid || !profileData) {
                console.error("saveUserProfileToFirestore: UID 또는 프로필 데이터가 없습니다.");
                return;
            }
            const userRef = doc(db, "users", uid);
            const dataToSave = {
                uid: uid, // UID도 문서에 저장
                ...profileData,
                lastLogin: serverTimestamp()
            };

            try {
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    dataToSave.createdAt = serverTimestamp(); // 최초 생성 시에만 createdAt 설정
                    await setDoc(userRef, dataToSave);
                    console.log(`[saveUserProfileToFirestore] Firestore에 새 사용자 문서 생성: ${uid}`, dataToSave);
                } else {
                    await setDoc(userRef, dataToSave, { merge: true }); // 기존 정보에 병합/업데이트
                    console.log(`[saveUserProfileToFirestore] Firestore 사용자 문서 업데이트: ${uid}`, dataToSave);
                }
            } catch (error) {
                console.error(`[saveUserProfileToFirestore] 사용자 문서 저장/업데이트 실패 (${uid}):`, error.message);
                alert("사용자 정보를 저장하는 데 실패했습니다. 인터넷 연결을 확인하고 다시 시도해주세요. Firestore 보안 규칙도 확인해주세요.");
                throw error;
            }
        }

        // --- 이벤트 핸들러 ---
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                // CBT 코드 입력 단계는 현재 로직에서 제외되었으므로 바로 다음 단계로
                if (selectedUserType === 'caregiver') {
                    showStep(steps.caregiverNd);
                } else { // directUser
                    if(diagnosisTitleEl) diagnosisTitleEl.textContent = "현재 어떤 어려움을 느끼고 있나요?";
                    if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 항목을 모두 선택해주세요. (중복 선택 가능)";
                    showStep(steps.diagnosisType);
                }
            };
        });

        caregiverNdOptionBtns.forEach(button => {
            button.onclick = () => {
                const ndType = button.dataset.nd;
                if (ndType === 'unsure_or_none') {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected'); tempSelectedCaregiverNd = [];
                    } else {
                        caregiverNdOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); tempSelectedCaregiverNd = [ndType];
                    }
                } else {
                    document.querySelector('.caregiver-nd-btn[data-nd="unsure_or_none"]')?.classList.remove('selected');
                    tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== 'unsure_or_none');
                    button.classList.toggle('selected');
                    if (tempSelectedCaregiverNd.includes(ndType)) {
                        tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== ndType);
                    } else {
                        tempSelectedCaregiverNd.push(ndType);
                    }
                }
                if(caregiverNdError) caregiverNdError.textContent = '';
                console.log("선택된 보호자/배우자 신경다양성:", tempSelectedCaregiverNd);
            };
        });

        if(submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => {
            // localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(tempSelectedCaregiverNd)); // 최종 저장 시 한번에
            if(diagnosisTitleEl) diagnosisTitleEl.textContent = "아이(또는 가족)의 어떤 점에 대해 이야기 나누고 싶으세요?";
            if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 어려움을 모두 선택해주세요. (중복 선택 가능)";
            showStep(steps.diagnosisType);
        };

        diagnosisOptionBtns.forEach(button => {
            button.onclick = () => {
                const diagnosis = button.dataset.diagnosis;
                const isExclusive = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');
                if (isExclusive) {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected'); tempSelectedDiagnoses = [];
                    } else {
                        diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); tempSelectedDiagnoses = [diagnosis];
                    }
                } else {
                    document.querySelector('.diagnosis-btn[data-diagnosis="NotApplicable"]')?.classList.remove('selected');
                    document.querySelector('.diagnosis-btn[data-diagnosis="Unsure"]')?.classList.remove('selected');
                    tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');
                    button.classList.toggle('selected');
                    if (tempSelectedDiagnoses.includes(diagnosis)) {
                        tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== diagnosis);
                    } else {
                        tempSelectedDiagnoses.push(diagnosis);
                    }
                }
                if(diagnosisError) diagnosisError.textContent = '';
                console.log("선택된 진단/어려움 유형:", tempSelectedDiagnoses);
            };
        });

        if(submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => {
            if (tempSelectedDiagnoses.length === 0) {
                if(diagnosisError) diagnosisError.textContent = "하나 이상 선택해주세요."; return;
            }
            if(diagnosisError) diagnosisError.textContent = '';
            // localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses)); // 최종 저장 시 한번에

            if (selectedUserType === 'caregiver') {
                if(nameBirthSelfTitleEl) nameBirthSelfTitleEl.textContent = "보호자님의 정보를 알려주세요.";
                // document.getElementById('nameSelfPromptLabel').textContent = "로지가 보호자님을 어떻게 부르면 좋을까요?";
                // document.getElementById('nameSelfInput').placeholder = "보호자님 이름 또는 별명";
                // document.getElementById('birthSelfPromptLabel').textContent = "보호자님의 생년월일을 선택해주세요.";
                // document.getElementById('birthSelfInfoText').textContent = "정확한 나이를 계산하여 맞춤형 상호작용을 제공합니다.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 18, 70); // 보호자 나이 범위
            } else { // directUser
                if(nameBirthSelfTitleEl) nameBirthSelfTitleEl.textContent = "만나서 반가워요! 당신에 대해 알려주세요.";
                // document.getElementById('nameSelfPromptLabel').textContent = "로지가 당신을 어떻게 부르면 좋을까요?";
                // document.getElementById('nameSelfInput').placeholder = "이름 또는 별명";
                // document.getElementById('birthSelfPromptLabel').textContent = "생년월일을 선택해주세요.";
                // document.getElementById('birthSelfInfoText').textContent = "정확한 나이를 계산하여 더 적절한 대화 경험을 제공합니다.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90); // 당사자 나이 범위 (최소 3세로 가정)
            }
            showStep(steps.nameBirthSelf);
        };

        if(submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            if (!name) { if(nameSelfError) nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.'; return; }
            if(nameSelfError) nameSelfError.textContent = '';
            if (!y || !m || !d) { if(birthSelfError) birthSelfError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            if(birthSelfError) birthSelfError.textContent = '';

            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                tempCaregiverSelfName = name;
                tempCaregiverSelfBirthDate = birthDate;
                tempCaregiverSelfAge = age;
                // document.getElementById('nameBirthChildTitle').textContent = "아이(또는 가족)의 정보를 알려주세요.";
                // document.getElementById('nameChildPromptLabel').textContent = "로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?";
                // document.getElementById('nameChildInput').placeholder = "아이(또는 가족) 이름 또는 별명";
                // document.getElementById('nameChildInput').value = ''; // 자녀 이름 입력 필드 초기화
                // document.getElementById('birthChildPromptLabel').textContent = "아이(또는 가족)의 생년월일을 선택해주세요.";
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18); // 자녀 나이 범위
                showStep(steps.nameBirthChild);
            } else { // directUser
                tempDirectUserName = name;
                tempDirectUserBirthDate = birthDate;
                tempDirectUserAge = age;
                showStep(steps.finalStart);
            }
        };

        if(submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
            if (!name) { if(nameChildError) nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.'; return; }
            if(nameChildError) nameChildError.textContent = '';
            if (!y || !m || !d) { if(birthChildError) birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.'; return; }
            if(birthChildError) birthChildError.textContent = '';

            tempChildName = name;
            tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            tempChildAge = calculateAge(y, m, d);
            showStep(steps.finalStart); // 자녀 정보 입력 후 다음 단계 (예: 자녀 UID 연결 또는 바로 시작)
        };

        if(startLozeeConversationBtn) startLozeeConversationBtn.onclick = async () => {
            if (!currentUserId) {
                alert("사용자 인증 정보가 없습니다. 페이지를 새로고침하거나 다시 시도해주세요.");
                return;
            }

            // 1. 최종 프로필 데이터 구성
            let profileDataToSave = {
                role: selectedUserType === 'caregiver' ? 'parent' : 'child',
                userType: selectedUserType,
                // 공통 정보 (당사자 또는 보호자 본인 정보)
                name: selectedUserType === 'caregiver' ? tempCaregiverSelfName : tempDirectUserName,
                birthDate: selectedUserType === 'caregiver' ? tempCaregiverSelfBirthDate : tempDirectUserBirthDate,
                age: selectedUserType === 'caregiver' ? tempCaregiverSelfAge : tempDirectUserAge,
            };

            // 2. localStorage에 저장할 대화 맥락용 정보 설정
            localStorage.setItem('lozee_username', profileDataToSave.name); // 현재 대화 상대의 이름
            localStorage.setItem('lozee_role', profileDataToSave.role);
            localStorage.setItem('lozee_userType', profileDataToSave.userType);


            if (selectedUserType === 'caregiver') {
                profileDataToSave.caregiverInfo = { // Firestore에 저장될 보호자 하위 정보
                    caregiverNeurodiversity: tempSelectedCaregiverNd,
                    childName: tempChildName,
                    childBirthDate: tempChildBirthDate,
                    childAge: tempChildAge,
                    childDiagnoses: tempSelectedDiagnoses // 자녀의 특성
                    // childLozeeUid: tempChildLozeeUid, // 만약 자녀 UID 연결 로직이 있다면
                };
                // localStorage에는 대화 맥락용 자녀 정보 및 보호자 특성 저장
                localStorage.setItem('lozee_userAge', tempChildAge !== null ? tempChildAge.toString() : '0'); // 대화 맥락 나이 = 자녀 나이
                localStorage.setItem('lozee_childName', tempChildName);
                localStorage.setItem('lozee_childAge', tempChildAge !== null ? tempChildAge.toString() : '0'); // 명시적 자녀 나이
                localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses)); // 자녀 특성 (talk.js에서 사용)
                localStorage.setItem('lozee_parentIsND', JSON.stringify(tempSelectedCaregiverNd.length > 0 && !tempSelectedCaregiverNd.includes('unsure_or_none')));
                localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(tempSelectedCaregiverNd)); // 보호자 본인 특성
            } else { // directUser
                profileDataToSave.diagnoses = tempSelectedDiagnoses; // 본인 특성
                localStorage.setItem('lozee_userAge', tempDirectUserAge !== null ? tempDirectUserAge.toString() : '0'); // 대화 맥락 나이 = 본인 나이
                localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses));
                // directUser일 경우 child 및 caregiver 관련 localStorage 항목 정리
                localStorage.removeItem('lozee_childName');
                localStorage.removeItem('lozee_childAge');
                localStorage.removeItem('lozee_parentIsND');
                localStorage.removeItem('lozee_childId');
                localStorage.removeItem('lozee_caregiver_neurodiversity');
            }

            try {
                await saveUserProfileToFirestore(currentUserId, profileDataToSave);
                window.location.href = 'talk.html';
            } catch (error) {
                console.error("최종 사용자 정보 저장 실패 (startLozeeConversationBtn):", error);
                // 사용자에게 오류 알림 가능
            }
        };

        // --- 페이지 로드 시 실행 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Index: 기존 Firebase Auth 세션 감지. UID:", user.uid);
                currentUserId = user.uid;
                localStorage.setItem('lozee_userId', currentUserId);

                // (선택적) 기존 사용자인 경우 Firestore에서 정보를 가져와 다음 단계 결정 또는 자동 로그인
                // const userDocRef = doc(db, "users", currentUserId);
                // const userSnap = await getDoc(userDocRef);
                // if (userSnap.exists() && userSnap.data().name && userSnap.data().role) {
                //     console.log("Index: 기존 사용자 정보 감지, talk.html로 바로 이동 고려");
                //     // 필요한 localStorage 값들 설정...
                //     // window.location.href = 'talk.html';
                //     // return;
                // }
                showStep(steps.userType); // 기존 사용자도 일단 유형 선택부터 (또는 프로필 있으면 바로 talk.html)
            } else {
                console.log("Index: Firebase Auth 세션 없음. 익명 로그인 시도.");
                try {
                    const userCredential = await signInAnonymously(auth);
                    const newUser = userCredential.user;
                    console.log('Index: 새로운 익명 사용자 UID 생성 및 저장:', newUser.uid);
                    currentUserId = newUser.uid;
                    localStorage.setItem('lozee_userId', currentUserId);
                    showStep(steps.userType); // UID 생성 후 첫 단계 표시
                } catch (error) {
                    console.error("Index: 익명 로그인 실패:", error);
                    alert("세션 초기화에 실패했습니다. 페이지를 새로고침 해주세요.");
                    // 익명 로그인 실패 시 대체 로직 (예: 임시 guest UID 사용은 권장하지 않음)
                }
            }
        });
  
    </script>
</body>
</html>