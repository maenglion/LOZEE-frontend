<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE ì‹œì‘í•˜ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        .select-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-bottom: 12px; }
        .select-row select { width: calc(33% - 6px); }
        
        #stepUserType h2 { font-size: 2em; margin-bottom: 40px; }
        .user-type-options { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; max-width: 700px; }
        .user-type-btn { flex: 1; padding: 25px 20px; font-size: 1.2em; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.4; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; }
        .btn-subtitle { font-size: 0.8em; font-weight: normal; color: #7b8dda; margin-top: 8px; }
        .user-type-btn:hover { background: #fff; transform: translateY(-1px); }

        .diagnosis-options { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; max-height: 60vh; overflow-y: auto; padding: 0 10px;}
        .diagnosis-btn, .caregiver-nd-btn { display: block; width: 85%; max-width: 480px; margin-bottom: 10px; padding: 12px; font-size: 1em; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .diagnosis-btn:hover, .caregiver-nd-btn:hover { background: #fff; }
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { background-color: #6e8efb; color: white; border-color: #6e8efb; }
        .optional-text { font-size: 0.8em; color: #e0e0e0; font-weight: normal; }
        
        .secondary-btn { background: #78909c; color: white; margin-top: 10px; }
        .secondary-btn:hover { background: #607d8b; }

        .input-group { margin-bottom: 20px; width: 85%; max-width: 350px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 1em; color: #f0f0f0; text-align: left; }
        .input-group input, .input-group .select-row { width: 100%; margin-bottom: 0; }


        /* index.html <style> íƒœê·¸ ë‚´ ìˆ˜ì • */
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { 
            background-color: #FFEB3B; /* ë…¸ë€ìƒ‰ ê³„ì—´ (ì˜ˆì‹œ) */
            color: #333; /* ë…¸ë€ ë°°ê²½ì— ì–´ìš¸ë¦¬ëŠ” ê¸€ììƒ‰ */
            border-color: #FBC02D; /* ë…¸ë€ìƒ‰ ê³„ì—´ í…Œë‘ë¦¬ */
            font-weight: bold;
        }

        @media (max-width: 600px) { 
            h2 { font-size: 1.6em; margin-bottom: 15px;} 
            p, .info-text { font-size: 0.95em; margin-bottom:10px;} 
            button { font-size: 0.9em; padding: 12px 20px; margin-top: 15px;} 
            input, select { padding: 10px; margin-bottom:10px; font-size: 0.95em;}
            .select-row {max-width:100%;}

            #stepUserType h2 { font-size: 1.7em; margin-bottom: 25px; }
            .user-type-options { flex-direction: column; gap: 15px; }
            .user-type-btn { width: 90%; min-height: auto; padding: 18px; font-size: 1.05em; }
            .diagnosis-btn, .caregiver-nd-btn { max-width: 90%; font-size:0.95em; padding:10px; }
            .diagnosis-options {max-height: 50vh;}
            .input-group { width: 90%;}
        }
    </style>
</head>
<body class="step-background-main">
    <div id="stepUserType" class="step active">
        <h2>ë‹¹ì‹ ì€ ì–´ë””ì— í•´ë‹¹í•˜ì‹œë‚˜ìš”?</h2>
        <div class="user-type-options">
            <button class="user-type-btn" data-usertype="directUser">ì œê°€ ì§ì ‘ ì´ì•¼ê¸° ë‚˜ëˆŒ ê±°ì˜ˆìš”<br><span class="btn-subtitle">(ì‹ ê²½ë‹¤ì–‘ì¸ ë‹¹ì‚¬ì)</span></button>
            <button class="user-type-btn" data-usertype="caregiver">ì œê°€ ë³´í˜¸ìì˜ˆìš”<br><span class="btn-subtitle">(ì–‘ìœ¡ì, ë°°ìš°ì ë“±)</span></button>
        </div>
        <div class="error-message" id="userTypeError"></div>
    </div>

    <div id="stepCBT" class="step">
        <h2 id="cbtTitle">ë¡œì§€ì™€ ëŒ€í™” ì‹œì‘í•˜ê¸°</h2>
        <p id="cbtInfo">CBT ì°¸ì—¬ì ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="email" id="cbtCodeInput" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" />
        <div class="error-message" id="cbtCodeError"></div>
        <button id="submitCbtCodeBtn">ë‹¤ìŒ</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step">
        <h2>ë³´í˜¸ìë‹˜ì— ëŒ€í•´ì„œë„ ì•Œë ¤ì£¼ì‹œê² ì–´ìš”? <span class="optional-text">(ì„ íƒ ì‚¬í•­)</span></h2>
        <p>ë³¸ì¸ ë˜ëŠ” ê´€ê³„ì¸(ì˜ˆ: ë°°ìš°ì)ê»˜ì„œ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±ì„ ê°€ì§€ê³  ê³„ì‹œë‹¤ë©´, í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”. <br>ì´ëŠ” ë¡œì§€ê°€ ë” ê¹Šì´ ê³µê°í•˜ê³  ë§ì¶¤í˜• ëŒ€í™”ë¥¼ ì œê³µí•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>
        <div class="diagnosis-options caregiver-nd-options">
            <button class="caregiver-nd-btn" data-nd="self_asd">ì €(ë³´í˜¸ì ë³¸ì¸)ì—ê²Œ ìí ìŠ¤í™íŠ¸ëŸ¼(ASD) ì„±í–¥ì´ ìˆì–´ìš”.</button>
            <button class="caregiver-nd-btn" data-nd="self_adhd">ì €(ë³´í˜¸ì ë³¸ì¸)ì—ê²Œ ADHD ì„±í–¥ì´ ìˆì–´ìš”.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_asd">ë°°ìš°ì(ê´€ê³„ì¸)ì—ê²Œ ìí ìŠ¤í™íŠ¸ëŸ¼(ASD) ì„±í–¥ì´ ìˆì–´ìš”.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_adhd">ë°°ìš°ì(ê´€ê³„ì¸)ì—ê²Œ ADHD ì„±í–¥ì´ ìˆì–´ìš”.</button>
            <button class="caregiver-nd-btn" data-nd="self_else">ì €(ë³´í˜¸ì ë³¸ì¸)ì—ê²Œ ê¸°íƒ€ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±ì´ ìˆì–´ìš”.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_else">ë°°ìš°ì(ê´€ê³„ì¸)ì—ê²Œ ê¸°íƒ€ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±ì´ ìˆì–´ìš”.</button>
            <button class="caregiver-nd-btn" data-nd="unsure_or_none">ì˜ ëª¨ë¥´ê±°ë‚˜ í•´ë‹¹ ì‚¬í•­ ì—†ì–´ìš”.</button>
        </div>
        <div class="error-message" id="caregiverNdError"></div>
        <button id="submitCaregiverNdBtn">ë‹¤ìŒ (ë˜ëŠ” ê±´ë„ˆë›°ê¸°)</button>
    </div>

    <div id="stepDiagnosisType" class="step">
        <h2 id="diagnosisTitle">ë‚˜ì˜ ì‹ ê²½ë‹¤ì–‘ì„± ì •ë³´</h2>
        <p id="diagnosisInfo">í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”. (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</p>
        <div class="diagnosis-options">
            <button class="diagnosis-btn" data-diagnosis="ASD">ìí ìŠ¤í™íŠ¸ëŸ¼ (ASD)</button>
            <button class="diagnosis-btn" data-diagnosis="ADHD">ì£¼ì˜ë ¥ ê²°í• ê³¼ì‰í–‰ë™ ì¥ì•  (ADHD)</button>
            <button class="diagnosis-btn" data-diagnosis="Asperger">ì•„ìŠ¤í¼ê±° ì¦í›„êµ° (ê³ ê¸°ëŠ¥ ìí)</button>
            <button class="diagnosis-btn" data-diagnosis="Tic">í‹± ì¥ì• </button>
            <button class="diagnosis-btn" data-diagnosis="LD">í•™ìŠµ ì¥ì• </button>
            <button class="diagnosis-btn" data-diagnosis="Else">ê¸°íƒ€ ì–´ë ¤ì›€ ë˜ëŠ” ê¶ê¸ˆì¦</button>
            <button class="diagnosis-btn" data-diagnosis="Unsure">ì•„ì§ ì˜ ëª¨ë¥´ê² ì–´ìš” / ì§„ë‹¨ ì—†ìŒ</button>
            <button class="diagnosis-btn" data-diagnosis="NotApplicable">íŠ¹ë³„íˆ í•´ë‹¹ ì—†ìŒ</button> 
        </div>
        <div class="error-message" id="diagnosisError"></div>
        <button id="submitDiagnosisBtn">ë‹¤ìŒ</button>
    </div>

    <div id="stepNameBirthSelf" class="step">
        <h2 id="nameBirthSelfTitle">ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”!</h2>
        <p id="nameSelfPrompt">ë¡œì§€ê°€ ë‹¹ì‹ ì„ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?</p>
        <input type="text" id="nameSelfInput" placeholder="ì´ë¦„ ë˜ëŠ” ë³„ëª…" />
        <div class="error-message" id="nameSelfError"></div>
        <p id="birthSelfPrompt">ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        <div class="info-text" id="birthSelfInfoText">ì •í™•í•œ ë‚˜ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ë” ì ì ˆí•œ ëŒ€í™” ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
        <div class="select-row">
            <select id="birthSelfYear"><option value="">ë…„</option></select>
            <select id="birthSelfMonth"><option value="">ì›”</option></select>
            <select id="birthSelfDay"><option value="">ì¼</option></select>
        </div>
        <div class="error-message" id="birthSelfError"></div>
        <button id="submitNameBirthSelfBtn">ë‹¤ìŒ</button>
    </div>
    
    <div id="stepNameBirthChild" class="step">
        <h2 id="nameBirthChildTitle">ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</h2>
        <p id="nameChildPrompt">ë¡œì§€ê°€ ì•„ì´(ë˜ëŠ” ê°€ì¡±)ë¥¼ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?</p>
        <input type="text" id="nameChildInput" placeholder="ì•„ì´(ë˜ëŠ” ê°€ì¡±) ì´ë¦„ ë˜ëŠ” ë³„ëª…" />
        <div class="error-message" id="nameChildError"></div>
        <p id="birthChildPrompt">ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        <div class="info-text" id="birthChildInfoText">ì •í™•í•œ ë‚˜ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì—ê²Œ ë” ì ì ˆí•œ ëŒ€í™” ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
        <div class="select-row">
            <select id="birthChildYear"><option value="">ë…„</option></select>
            <select id="birthChildMonth"><option value="">ì›”</option></select>
            <select id="birthChildDay"><option value="">ì¼</option></select>
        </div>
        <div class="error-message" id="birthChildError"></div>
        <button id="submitNameBirthChildBtn">ë‹¤ìŒ</button>
    </div>


    <div id="stepChildEmail" class="step">
        <h2>ì•„ì´/ê°€ì¡±ì˜ ë¡œì§€ ê³„ì • ì—°ê²° <span class="optional-text">(ì„ íƒ ì‚¬í•­)</span></h2>
        <p>ë§Œì•½ ì•„ì´(ë˜ëŠ” ê°€ì¡±)ê°€ ë¡œì§€ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, í•´ë‹¹ ê³„ì •ì˜ ë¡œì§€ ê°€ì… ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ì´ë¥¼ í†µí•´ ë¡œì§€ê°€ ê´€ë ¨ëœ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ (ìƒëŒ€ë°©ì´ ì •ë³´ ê³µìœ ì— ë™ì˜í•œ ê²½ìš°ì—ë§Œ) ë³´í˜¸ìë‹˜ê»˜ ë” ë„ì›€ì´ ë˜ëŠ” ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <p class="info-text" style="font-size: 0.85em; color: #ffeb3b;"><strong>[ì¤‘ìš”]</strong> ê°œì¸ ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´, ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë°˜ë“œì‹œ ìƒëŒ€ë°©ì˜ ë™ì˜ê°€ í•„ìš”í•˜ë©°, ë¡œì§€ëŠ” ìƒëŒ€ë°©ì´ ë™ì˜í•œ ë²”ìœ„ ë‚´ì˜ ì •ë³´ë§Œì„ ì°¸ê³ í•©ë‹ˆë‹¤.</p>
        <input type="email" id="childLozeeEmailInput" placeholder="ì•„ì´/ê°€ì¡±ì˜ ë¡œì§€ ê°€ì… ì´ë©”ì¼ (ì„ íƒ)" />
        <div class="error-message" id="childEmailError"></div>
        <button id="submitChildEmailBtn">ì €ì¥ í›„ ì‹œì‘í•˜ê¸°</button>
        <button id="skipChildEmailBtn" class="secondary-btn">ê±´ë„ˆë›°ê³  ì‹œì‘í•˜ê¸°</button>
    </div>

    <script type="module">
        import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';
        import { db } from './js/firebase-config.js'; 
        import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

      // --- DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
      // ëª¨ë“  DOM ê´€ë ¨ ì‘ì—…ê³¼ ì´ˆê¸°í™” ë¡œì§ì„ ì´ ì•ˆìœ¼ë¡œ ì˜®ê¹ë‹ˆë‹¤.
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ: index.html");

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const stepUserType = document.getElementById('stepUserType');
        const stepCBT = document.getElementById('stepCBT');
        const stepCaregiverNeurodiversity = document.getElementById('stepCaregiverNeurodiversity');
        const stepDiagnosisType = document.getElementById('stepDiagnosisType');
        const stepNameBirthSelf = document.getElementById('stepNameBirthSelf'); // ë³´í˜¸ì/ë‹¹ì‚¬ì ë³¸ì¸ ì •ë³´ ì…ë ¥
        const stepNameBirthChild = document.getElementById('stepNameBirthChild'); // ë³´í˜¸ìê°€ ìë…€ ì •ë³´ ì…ë ¥
        const stepChildEmail = document.getElementById('stepChildEmail');

        const cbtTitleEl = document.getElementById('cbtTitle');
        const cbtInfoEl = document.getElementById('cbtInfo');
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const cbtCodeInput = document.getElementById('cbtCodeInput');
        const cbtCodeError = document.getElementById('cbtCodeError');
        const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');
        
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        
        // ë³¸ì¸ ì •ë³´ ì…ë ¥ í•„ë“œ
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfPromptEl = document.getElementById('nameSelfPrompt');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfPromptEl = document.getElementById('birthSelfPrompt');
        const birthSelfInfoTextEl = document.getElementById('birthSelfInfoText');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');

        // ì•„ì´/ê°€ì¡± ì •ë³´ ì…ë ¥ í•„ë“œ (ë³´í˜¸ììš©)
        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildPromptEl = document.getElementById('nameChildPrompt');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildPromptEl = document.getElementById('birthChildPrompt');
        const birthChildInfoTextEl = document.getElementById('birthChildInfoText');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');

        const childLozeeEmailInput = document.getElementById('childLozeeEmailInput');
        const childEmailError = document.getElementById('childEmailError');
        const submitChildEmailBtn = document.getElementById('submitChildEmailBtn');
        const skipChildEmailBtn = document.getElementById('skipChildEmailBtn');

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let selectedUserType = ''; 
        let caregiverSelfName = '', caregiverSelfBirthDate = '', caregiverSelfAge = 0; // ë³´í˜¸ì ë³¸ì¸ ì •ë³´
        let childName = '', childBirthDate = '', childAge = 0; // ì•„ì´/ê°€ì¡± ì •ë³´
        let directUserName = '', directUserBirthDate = '', directUserAge = 0; // ë‹¹ì‚¬ì ì •ë³´
        let selectedCaregiverNd = [];
        let selectedDiagnoses = []; // ë‹¹ì‚¬ì ë˜ëŠ” ì•„ì´/ê°€ì¡±ì˜ ì§„ë‹¨ ì •ë³´

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function showStep(elToShow) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */ }
        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 3, endYearOffset = 90) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */ }
        function calculateAge(y, m, d) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */ }
        function createBaseUserData(email, userTypeToSave) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */ }
        async function checkForExistingCbtUser(email) { /* ... ì´ì „ ë‹µë³€ì˜ ë¡œì§ì„ ì°¸ê³ í•˜ì—¬, ë³´í˜¸ì ë³¸ì¸ ì •ë³´ë„ localStorageì— ì €ì¥/ë¡œë“œ í•˜ë„ë¡ ìˆ˜ì • ... */ }
 
 
        function showStep(elToShow) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            if (elToShow) elToShow.classList.add('active');
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 3, endYearOffset = 90) {
            // ... (ì´ì „ ì½”ë“œì™€ ë™ì¼) ...
        }

        function calculateAge(y, m, d) {
            // ... (ì´ì „ ì½”ë“œì™€ ë™ì¼) ...
        }
        
        function createBaseUserData(email, userTypeToSave) {
             return {
                email: email,
                userType: userTypeToSave,
                // createdAtì€ ìµœì´ˆ ì €ì¥ ì‹œì—ë§Œ ì¶”ê°€ (setDoc ë¡œì§ì—ì„œ ì²˜ë¦¬)
                lastLogin: serverTimestamp()
            };
        }

        async function checkForExistingCbtUser(email) {
            // ... (ì´ì „ ìµœì¢…ë³¸ì˜ checkForExistingCbtUser í•¨ìˆ˜ ë‚´ìš©) ...
        }

        // 5. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        // 5-1. ì‚¬ìš©ì ìœ í˜• ì„ íƒ
          userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                localStorage.setItem('lozee_userType', selectedUserType);
                // ... (cbtTitleEl ë“± UI ì—…ë°ì´íŠ¸) ...
                showStep(stepCBT);
            };
        });

        // 5-2. CBT ì´ë©”ì¼ ì œì¶œ
        submitCbtCodeBtn.onclick = async () => {
            const email = cbtCodeInput.value.trim();
            // ... (ìœ íš¨ì„± ê²€ì‚¬) ...
            localStorage.setItem('cbtUserEmail', email.toLowerCase());
            localStorage.setItem('isCbtUser', 'true');

            const existingUserProcessed = await checkForExistingCbtUser(email);
            if (existingUserProcessed) return; 

            if (selectedUserType === 'caregiver') {
                // ...
                showStep(stepCaregiverNeurodiversity);
            } else { 
                // ...
                showStep(stepDiagnosisType);
            }
        };


        // 5-3. ë³´í˜¸ì ë³¸ì¸/ê´€ê³„ì¸ ì‹ ê²½ë‹¤ì–‘ì„± ì„ íƒ
        caregiverNdOptionBtns.forEach(button => { /* ... ì´ì „ê³¼ ë™ì¼í•œ ì„ íƒ ë¡œì§ (selectedCaregiverNd ì—…ë°ì´íŠ¸) ... */ });
        submitCaregiverNdBtn.onclick = () => {
            localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(selectedCaregiverNd));
            diagnosisTitleEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì–´ë–¤ ì ì— ëŒ€í•´ ì´ì•¼ê¸° ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì„¸ìš”?";
            diagnosisInfoEl.textContent = "í•´ë‹¹í•˜ëŠ” ì–´ë ¤ì›€ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”. (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)";
            showStep(stepDiagnosisType);
        };

        // 5-4. (ìì‹  ë˜ëŠ” ì•„ì´/ê°€ì¡±ì˜) ì‹ ê²½ë‹¤ì–‘ì„± ìœ í˜• ì„ íƒ
       diagnosisOptionBtns.forEach(button => {
        button.onclick = () => {
            const diagnosis = button.dataset.diagnosis;
            const isExclusiveOption = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');

            if (isExclusiveOption) {
            // "í•´ë‹¹ ì—†ìŒ" ë˜ëŠ” "ì˜ ëª¨ë¥´ê² ì–´ìš”"ë¥¼ í´ë¦­í•œ ê²½ìš°
            if (button.classList.contains('selected')) {
                // ì´ë¯¸ ì„ íƒëœ ìƒíƒœë©´ ì„ íƒ í•´ì œ
                button.classList.remove('selected');
                selectedDiagnoses = [];
            } else {
                // ë‹¤ë¥¸ ëª¨ë“  ë²„íŠ¼ ì„ íƒ í•´ì œ í›„ ì´ ë²„íŠ¼ë§Œ ì„ íƒ
                diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedDiagnoses = [diagnosis];
            }
        } else {
            // ì¼ë°˜ ì§„ë‹¨ ìœ í˜•ì„ í´ë¦­í•œ ê²½ìš° (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)
            // ë§Œì•½ "í•´ë‹¹ ì—†ìŒ" ë˜ëŠ” "ì˜ ëª¨ë¥´ê² ì–´ìš”"ê°€ ì´ì „ì— ì„ íƒë˜ì–´ ìˆì—ˆë‹¤ë©´ í•´ì œ
            diagnosisOptionBtns.forEach(btn => {
                if (btn.dataset.diagnosis === 'NotApplicable' || btn.dataset.diagnosis === 'Unsure') {
                    btn.classList.remove('selected');
                }
            });
            // selectedDiagnoses ë°°ì—´ì—ì„œë„ "NotApplicable", "Unsure" ì œê±°
            selectedDiagnoses = selectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');

            // í˜„ì¬ í´ë¦­í•œ ë²„íŠ¼ ì„ íƒ/í•´ì œ í† ê¸€
            button.classList.toggle('selected');
            if (selectedDiagnoses.includes(diagnosis)) {
                selectedDiagnoses = selectedDiagnoses.filter(d => d !== diagnosis);
            } else {
                selectedDiagnoses.push(diagnosis);
            }
        }
        
        // ì„ íƒëœ ì§„ë‹¨ì´ í•˜ë‚˜ë„ ì—†ê³ , "í•´ë‹¹ ì—†ìŒ"ì´ë‚˜ "ì˜ ëª¨ë¥´ê² ì–´ìš”"ë„ ì„ íƒ ì•ˆ ëœ ê²½ìš°
        // ì‚¬ìš©ìê°€ ëª¨ë“  ì„ íƒì„ í•´ì œí–ˆì„ ë•Œ, selectedDiagnosesë¥¼ ë¹ˆ ë°°ì—´ë¡œ ìœ ì§€
        if (!isExclusiveOption && !button.classList.contains('selected') && !selectedDiagnoses.some(val => button.dataset.diagnosis === val)) {
            // ì´ë¯¸ filterë¡œ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ë™ì‘ í•„ìš” ì—†ìŒ
        }
        
        // ë§Œì•½ ì¼ë°˜ ì§„ë‹¨ ìœ í˜•ì„ ì„ íƒí–ˆëŠ”ë°, selectedDiagnosesê°€ ë¹„ê²Œ ë˜ë©´ (ëª¨ë‘ í•´ì œ ì‹œ)
        // "í•´ë‹¹ ì—†ìŒ"ì´ë‚˜ "ì˜ ëª¨ë¥´ê² ì–´ìš”"ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒí•˜ê²Œ í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì§€ê¸ˆì€ ê·¸ëƒ¥ ë¹„ì›Œë‘ .
        
        diagnosisError.textContent = ''; // ì„ íƒ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
        console.log("ì„ íƒëœ ì§„ë‹¨ ìœ í˜•:", selectedDiagnoses);
    };
});

      // submitDiagnosisBtn.onclick í•¸ë“¤ëŸ¬ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ ê°€ëŠ¥í•˜ë‚˜,
      // selectedDiagnoses ë°°ì—´ì— "NotApplicable" ë˜ëŠ” "Unsure"ë§Œ ìˆê±°ë‚˜,
      // í˜¹ì€ ì—¬ëŸ¬ ì¼ë°˜ ì§„ë‹¨ ìœ í˜•ì´ í•¨ê»˜ ìˆëŠ”ì§€ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
    submitDiagnosisBtn.onclick = () => {
        if (selectedDiagnoses.length === 0) { // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆ í•¨
        diagnosisError.textContent = "í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”. íŠ¹ë³„íˆ í•´ë‹¹ì‚¬í•­ì´ ì—†ê±°ë‚˜ ì˜ ëª¨ë¥´ê² ë‹¤ë©´ ê´€ë ¨ ì˜µì…˜ì„ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”.";
        return;
        }
    // ë§Œì•½ "NotApplicable"ì´ë‚˜ "Unsure"ê°€ ë‹¤ë¥¸ ì¼ë°˜ ì§„ë‹¨ê³¼ í•¨ê»˜ ì„ íƒë  ìˆ˜ ì—†ë„ë¡ í•˜ë ¤ë©´,
    // ì—¬ê¸°ì„œ ì¶”ê°€ì ì¸ ìœ íš¨ì„± ê²€ì‚¬ ê°€ëŠ¥ (í˜„ì¬ ë¡œì§ì€ ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬)
    
    diagnosisError.textContent = '';
    localStorage.setItem('lozee_diagnoses', JSON.stringify(selectedDiagnoses));

        // ë‹¤ìŒ ë‹¨ê³„: ì´ë¦„/ìƒë…„ì›”ì¼ ì…ë ¥ (ë³´í˜¸ìë©´ ë³¸ì¸ ì •ë³´ ë¨¼ì €, ë‹¹ì‚¬ìë©´ ë³¸ì¸ ì •ë³´)
         if (selectedUserType === 'caregiver') {
             caregiverNameFromInput = name; // nameì€ nameSelfInput.value.trim()
             caregiverSelfBirthDate = birthDate; // birthDateëŠ” y,m,dë¡œ ì¡°í•©
             caregiverSelfAge = age; // ageëŠ” calculateAge ê²°ê³¼

        // ë‹¤ìŒ ë‹¨ê³„: ìë…€ ì •ë³´ ì…ë ¥ UI ì„¤ì •
             nameBirthChildTitleEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
             nameChildPromptEl.textContent = "ë¡œì§€ê°€ ì•„ì´(ë˜ëŠ” ê°€ì¡±)ë¥¼ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?";
             nameChildInput.placeholder = "ì•„ì´(ë˜ëŠ” ê°€ì¡±) ì´ë¦„ ë˜ëŠ” ë³„ëª…";
             nameChildInput.value = ''; // ì´ì „ ê°’ ì´ˆê¸°í™”
             birthChildPromptEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
             populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // ğŸ‘ˆ ìë…€ ë‚˜ì´ ë²”ìœ„ë¡œ í˜¸ì¶œ
             showStep(stepNameBirthChild);


            } else { // directUser
                nameBirthSelfTitleEl.textContent = "ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”! ë‹¹ì‹ ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”.";
                nameSelfPromptEl.textContent = "ë¡œì§€ê°€ ë‹¹ì‹ ì„ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?";
                nameSelfInput.placeholder = "ì´ë¦„ ë˜ëŠ” ë³„ëª…";
                birthSelfPromptEl.textContent = "ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay); // ë‹¹ì‚¬ì ë‚˜ì´ ë²”ìœ„
                showStep(stepNameBirthSelf);
            }
        };
        
        // 5-5. ë³´í˜¸ì/ë‹¹ì‚¬ì ë³¸ì¸ ì´ë¦„/ìƒë…„ì›”ì¼ ì œì¶œ
        submitNameBirthSelfBtn.onclick = async () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            
            if (!name) { nameSelfError.textContent = 'ì´ë¦„(ë˜ëŠ” ë³„ëª…)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
            nameSelfError.textContent = '';
            if (!y || !m || !d) { birthSelfError.textContent = 'ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'; return; }
            birthSelfError.textContent = '';
            
            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                caregiverNameFromInput = name;
                caregiverSelfBirthDate = birthDate;
                caregiverSelfAge = age;
                // ë‹¤ìŒ ë‹¨ê³„: ìë…€ ì •ë³´ ì…ë ¥
                nameBirthChildTitleEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
                nameChildPromptEl.textContent = "ë¡œì§€ê°€ ì•„ì´(ë˜ëŠ” ê°€ì¡±)ë¥¼ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?";
                nameChildInput.placeholder = "ì•„ì´(ë˜ëŠ” ê°€ì¡±) ì´ë¦„ ë˜ëŠ” ë³„ëª…";
                birthChildPromptEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // ìë…€ ë‚˜ì´ ë²”ìœ„
                showStep(stepNameBirthChild);
            } else { // directUser
                directUserName = name;
                directUserBirthDate = birthDate;
                directUserAge = age;
                // ë‹¹ì‚¬ìëŠ” ìë…€ ì •ë³´ ì…ë ¥/ì—°ê²° ë‹¨ê³„ ì—†ì´ ë°”ë¡œ Firestore ì €ì¥ ë° talk.htmlë¡œ ì´ë™
                await saveUserDataToFirestore();
                window.location.href = 'talk.html';
            }
        };

        // 5-2. (ë³´í˜¸ì ì„ íƒ ì‹œ) ì•„ì´/ê°€ì¡± ì´ë¦„/ìƒë…„ì›”ì¼ ì œì¶œ
        submitNameBirthChildBtn.onclick = async () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;

            if (!name) { nameChildError.textContent = 'ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
            nameChildError.textContent = '';
            if (!y || !m || !d) { birthChildError.textContent = 'ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'; return; }
            birthChildError.textContent = '';

            childName = name;
            childBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            childAge = calculateAge(y, m, d);

            await saveUserDataToFirestore(); // ëª¨ë“  ì •ë³´ ì·¨í•© í›„ ì €ì¥
            showStep(stepChildEmail); // ë‹¤ìŒ: ì•„ì´/ê°€ì¡± ë¡œì§€ ê³„ì • ì—°ê²°
        };

       // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹¤í–‰ ë¡œì§ ---
        // populateBirthSelectsëŠ” ê° ì´ë¦„/ìƒë…„ì›”ì¼ ì…ë ¥ ë‹¨ê³„ ì§„ì… ì‹œ í˜¸ì¶œ
        populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay); // ë‹¹ì‚¬ì/ë³´í˜¸ì ë³¸ì¸ìš©ì€ ë¯¸ë¦¬ ì±„ì›Œë‘˜ ìˆ˜ ìˆìŒ
        // populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // ìë…€ìš©ì€ í•´ë‹¹ ë‹¨ê³„ ì§„ì… ì‹œ

        showStep(stepUserType); // ì²« í™”ë©´ì€ ì‚¬ìš©ì ìœ í˜• ì„ íƒ
        }); // ì—¬ê¸°ê°€ DOMContentLoaded ë¦¬ìŠ¤ë„ˆì˜ ë‹«ëŠ” ì¤‘ê´„í˜¸ì™€ ê´„í˜¸ì…ë‹ˆë‹¤.

        
        // Firestoreì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥ í•¨ìˆ˜
        async function saveUserDataToFirestore() {
            const cbtUserEmail = localStorage.getItem('cbtUserEmail');
            const userTypeToSave = localStorage.getItem('lozee_userType');
            // selectedDiagnosesëŠ” ë‹¹ì‚¬ìë©´ ë³¸ì¸ì˜ ê²ƒ, ë³´í˜¸ìë©´ ì•„ì´/ê°€ì¡±ì˜ ê²ƒ
            const diagnosesToSave = JSON.parse(localStorage.getItem('lozee_diagnoses') || '[]');
            const caregiverNdToSave = JSON.parse(localStorage.getItem('lozee_caregiver_neurodiversity') || '[]');

            if (!cbtUserEmail || !userTypeToSave) {
                console.error("í•„ìˆ˜ ì •ë³´ ëˆ„ë½ìœ¼ë¡œ Firestore ì €ì¥ ë¶ˆê°€");
                return;
            }

            const userDocRef = doc(db, "users", cbtUserEmail);
            let userDataToSave = createBaseUserData(cbtUserEmail, userTypeToSave);

            if (userTypeToSave === 'caregiver') {
                userDataToSave.name = caregiverNameFromInput; 
                userDataToSave.birthDate = caregiverSelfBirthDate;
                userDataToSave.age = caregiverSelfAge;
                userDataToSave.caregiverNeurodiversity = caregiverNdToSave;
                userDataToSave.childName = childName; 
                userDataToSave.childBirthDate = childBirthDate;
                userDataToSave.childAge = childAge; 
                userDataToSave.childDiagnoses = diagnosesToSave; 
            } else { // directUser
                userDataToSave.name = directUserName;
                userDataToSave.birthDate = directUserBirthDate;
                userDataToSave.age = directUserAge;
                userDataToSave.diagnoses = diagnosesToSave;
            }
            
            try {
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists()) { 
                    delete userDataToSave.createdAt; // ê¸°ì¡´ ì‚¬ìš©ìë©´ createdAtì€ ì—…ë°ì´íŠ¸ ì•ˆ í•¨
                }
                await setDoc(userDocRef, userDataToSave , { merge: true });
                console.log("Firestoreì— ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ì €ì¥/ì—…ë°ì´íŠ¸ ì™„ë£Œ.");

                // talk.htmlì—ì„œ ì‚¬ìš©í•  localStorage ì •ë³´ ìµœì¢… ì„¤ì •
                if (userTypeToSave === 'caregiver') {
                    localStorage.setItem('lozee_username', childName); // talk.htmlì—ì„œëŠ” ì£¼ë¡œ ì•„ì´ ê¸°ì¤€ìœ¼ë¡œ ëŒ€í™”
                    localStorage.setItem('lozee_userage', childAge.toString());
                    // ë³´í˜¸ì ë³¸ì¸ ì •ë³´ë„ í•„ìš”ì‹œ mypage ë“±ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë³„ë„ ì €ì¥
                    localStorage.setItem('lozee_caregiver_name', caregiverNameFromInput);
                    localStorage.setItem('lozee_caregiver_age', caregiverSelfAge.toString());
                } else {
                    localStorage.setItem('lozee_username', directUserName);
                }

            } catch (error) {
                console.error("Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            }
        }

        // 6. ì•„ì´/ê°€ì¡± ë¡œì§€ ì´ë©”ì¼ ì œì¶œ (ë³´í˜¸ì ì„ íƒ ì‹œ)
        submitChildEmailBtn.onclick = async () => { /* ... ì´ì „ê³¼ ë™ì¼ (childLozeeEmail Firestoreì— ì €ì¥) ... */ };
        skipChildEmailBtn.onclick = () => { /* ... ì´ì „ê³¼ ë™ì¼ ... */ };

    </script>
</body>
</html>