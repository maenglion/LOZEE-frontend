<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        /* ... (CSS 스타일은 이전과 동일하게 유지) ... */
    </style>
</head>
<body class="step-background-main">
    <script type="module">
        import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';
        import { db } from './js/firebase-config.js'; 
        import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

      // --- DOMContentLoaded 이벤트 리스너 ---
      // 모든 DOM 관련 작업과 초기화 로직을 이 안으로 옮깁니다.
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded 이벤트 발생: index.html");

        // --- DOM 요소 가져오기 ---
        const stepUserType = document.getElementById('stepUserType');
        const stepCBT = document.getElementById('stepCBT');
        const stepCaregiverNeurodiversity = document.getElementById('stepCaregiverNeurodiversity');
        const stepDiagnosisType = document.getElementById('stepDiagnosisType');
        const stepNameBirthSelf = document.getElementById('stepNameBirthSelf');
        const stepNameBirthChild = document.getElementById('stepNameBirthChild');
        const stepChildEmail = document.getElementById('stepChildEmail');

        const cbtTitleEl = document.getElementById('cbtTitle'); // HTML에 ID가 있는지 확인
        const cbtInfoEl = document.getElementById('cbtInfo');   // HTML에 ID가 있는지 확인
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const cbtCodeInput = document.getElementById('cbtCodeInput');
        const cbtCodeError = document.getElementById('cbtCodeError');
        const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');
        
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfPromptEl = document.getElementById('nameSelfPrompt');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfPromptEl = document.getElementById('birthSelfPrompt');
        const birthSelfInfoTextEl = document.getElementById('birthSelfInfoText');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');

        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildPromptEl = document.getElementById('nameChildPrompt');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildPromptEl = document.getElementById('birthChildPrompt');
        const birthChildInfoTextEl = document.getElementById('birthChildInfoText');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');

        const childLozeeEmailInput = document.getElementById('childLozeeEmailInput');
        const childEmailError = document.getElementById('childEmailError');
        const submitChildEmailBtn = document.getElementById('submitChildEmailBtn');
        const skipChildEmailBtn = document.getElementById('skipChildEmailBtn');

        // --- 상태 변수 ---
        let selectedUserType = ''; 
        let caregiverSelfName = '', caregiverSelfBirthDate = '', caregiverSelfAge = 0;
        let childName = '', childBirthDate = '', childAge = 0;
        let directUserName = '', directUserBirthDate = '', directUserAge = 0;
        let selectedCaregiverNd = [];
        let selectedDiagnoses = [];

        // --- 헬퍼 함수 ---
        function showStep(elToShow) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            if (elToShow) elToShow.classList.add('active');
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 3, endYearOffset = 90) {
            if (!yearEl || !monthEl || !dayEl) {
                console.error("populateBirthSelects: 생년월일 select 요소를 찾을 수 없습니다.");
                return;
            }
            yearEl.innerHTML = '<option value="">년</option>'; // 옵션 초기화
            monthEl.innerHTML = '<option value="">월</option>';
            dayEl.innerHTML = '<option value="">일</option>';

            const now = new Date();
            const currentYear = now.getFullYear();
            for (let y = currentYear - startYearOffset; y >= currentYear - endYearOffset; y--) {
                const opt = document.createElement('option'); opt.value = y; opt.textContent = y + '년'; yearEl.appendChild(opt);
            }
            for (let m = 1; m <= 12; m++) { const opt = document.createElement('option'); opt.value = m; opt.textContent = m + '월'; monthEl.appendChild(opt); }
            for (let d = 1; d <= 31; d++) { const opt = document.createElement('option'); opt.value = d; opt.textContent = d + '일'; dayEl.appendChild(opt); }
        }

        function calculateAge(y, m, d) { /* ... 이전과 동일 ... */ }
        function createBaseUserData(email, userTypeToSave) { /* ... 이전과 동일 ... */ }
        async function checkForExistingCbtUser(email) { /* ... 이전과 동일 ... */ }
 
        // --- 이벤트 핸들러 정의 및 등록 ---
        // 1. 사용자 유형 선택
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                localStorage.setItem('lozee_userType', selectedUserType);
                
                if (selectedUserType === 'caregiver') {
                    if(cbtTitleEl) cbtTitleEl.textContent = "보호자님, 반갑습니다!";
                    if(cbtInfoEl) cbtInfoEl.textContent = "원활한 서비스 이용을 위해 보호자님의 이메일 주소를 입력해주세요.";
                    if(cbtCodeInput) cbtCodeInput.placeholder = "보호자님 이메일 주소";
                } else { 
                    if(cbtTitleEl) cbtTitleEl.textContent = "로지와 대화 시작하기";
                    if(cbtInfoEl) cbtInfoEl.textContent = "CBT 참여자 이메일 주소를 입력해주세요.";
                    if(cbtCodeInput) cbtCodeInput.placeholder = "이메일 주소";
                }
                showStep(stepCBT);
            };
        });

        // 2. CBT 이메일 제출
        submitCbtCodeBtn.onclick = async () => {
            const email = cbtCodeInput.value.trim();
            if (!validateCbtEmail(email)) {
                cbtCodeError.textContent = getCbtErrorMessage(); return;
            }
            cbtCodeError.textContent = '';
            localStorage.setItem('cbtUserEmail', email.toLowerCase());
            localStorage.setItem('isCbtUser', 'true');

            const existingUserProcessed = await checkForExistingCbtUser(email);
            if (existingUserProcessed) return; 

            if (selectedUserType === 'caregiver') {
                showStep(stepCaregiverNeurodiversity);
            } else { 
                diagnosisTitleEl.textContent = "현재 어떤 어려움을 느끼고 있나요?";
                diagnosisInfoEl.textContent = "해당하는 항목을 모두 선택해주세요. (중복 선택 가능)";
                showStep(stepDiagnosisType);
            }
        };

        // 3. 보호자 본인/관계인 신경다양성 선택
        caregiverNdOptionBtns.forEach(button => { /* ... 이전 답변의 선택 로직과 동일 ... */ });
        submitCaregiverNdBtn.onclick = () => { /* ... 이전 답변의 로직과 동일, localStorage 저장 및 다음 단계 UI 설정 ... */         localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(selectedCaregiverNd));
            diagnosisTitleEl.textContent = "아이(또는 가족)의 어떤 점에 대해 이야기 나누고 싶으세요?";
            diagnosisInfoEl.textContent = "해당하는 어려움을 모두 선택해주세요. (중복 선택 가능)";
            showStep(stepDiagnosisType);};

        // 4. (자신 또는 아이/가족의) 신경다양성 유형 선택
        diagnosisOptionBtns.forEach(button => { /* ... 이전 답변의 선택 로직과 동일 ... */ });
        submitDiagnosisBtn.onclick = () => {
            if (selectedDiagnoses.length === 0 && !selectedDiagnoses.includes('NotApplicable') && !selectedDiagnoses.includes('Unsure')) {
                diagnosisError.textContent = "하나 이상 선택해주세요."; return;
            }
            diagnosisError.textContent = '';
            localStorage.setItem('lozee_diagnoses', JSON.stringify(selectedDiagnoses));

            if (selectedUserType === 'caregiver') {
                nameBirthSelfTitleEl.textContent = "보호자님의 정보를 알려주세요.";
                nameSelfPromptEl.textContent = "로지가 보호자님을 어떻게 부르면 좋을까요?";
                nameSelfInput.placeholder = "보호자님 이름 또는 별명";
                birthSelfPromptEl.textContent = "보호자님의 생년월일을 선택해주세요.";
                birthSelfInfoTextEl.textContent = "정확한 나이를 계산하여 맞춤형 상호작용을 제공합니다.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 18, 90); // 👈 보호자 나이 범위로 호출
            } else { // directUser
                nameBirthSelfTitleEl.textContent = "만나서 반가워요! 당신에 대해 알려주세요.";
                nameSelfPromptEl.textContent = "로지가 당신을 어떻게 부르면 좋을까요?";
                nameSelfInput.placeholder = "이름 또는 별명";
                birthSelfPromptEl.textContent = "생년월일을 선택해주세요.";
                birthSelfInfoTextEl.textContent = "정확한 나이를 계산하여 더 적절한 대화 경험을 제공합니다.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90); // 👈 당사자 나이 범위로 호출 (기존 3~90)
            }
            showStep(stepNameBirthSelf);
        };
        
        // 5. 보호자/당사자 본인 이름/생년월일 제출
        submitNameBirthSelfBtn.onclick = async () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            
            if (!name) { nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.'; return; }
            nameSelfError.textContent = '';
            if (!y || !m || !d) { birthSelfError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            birthSelfError.textContent = '';
            
            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                caregiverSelfName = name;
                caregiverSelfBirthDate = birthDate;
                caregiverSelfAge = age;
                
                nameBirthChildTitleEl.textContent = "아이(또는 가족)의 정보를 알려주세요.";
                nameChildPromptEl.textContent = "로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?";
                nameChildInput.placeholder = "아이(또는 가족) 이름 또는 별명";
                nameChildInput.value = ''; 
                birthChildPromptEl.textContent = "아이(또는 가족)의 생년월일을 선택해주세요.";
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // 👈 자녀 나이 범위로 호출
                showStep(stepNameBirthChild);
            } else { // directUser
                directUserName = name;
                directUserBirthDate = birthDate;
                directUserAge = age;
                await saveUserDataToFirestore(); // 당사자는 바로 저장 및 이동
                window.location.href = 'talk.html';
            }
        };

        // 5-2. (보호자 선택 시) 아이/가족 이름/생년월일 제출
        submitNameBirthChildBtn.onclick = async () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;

            if (!name) { nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.'; return; }
            nameChildError.textContent = '';
            if (!y || !m || !d) { birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.'; return; }
            birthChildError.textContent = '';

            childName = name;
            childBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            childAge = calculateAge(y, m, d);

            await saveUserDataToFirestore(); 
            showStep(stepChildEmail); 
        };
        
        // Firestore에 사용자 데이터 저장 함수
        async function saveUserDataToFirestore() { /* ... 이전 답변의 내용과 동일 ... */ }

        // 6. 아이/가족 로지 이메일 제출 (보호자 선택 시)
        submitChildEmailBtn.onclick = async () => { /* ... 이전과 동일 ... */ };
        skipChildEmailBtn.onclick = () => { /* ... 이전과 동일 ... */ };

        // --- 페이지 로드 시 초기 실행 로직 ---
        // populateBirthSelects는 각 이름/생년월일 입력 단계 진입 시 호출하므로 여기서 미리 호출할 필요 없음.
        showStep(stepUserType); // 첫 화면은 사용자 유형 선택
    });
    </script>
</body>
</html>