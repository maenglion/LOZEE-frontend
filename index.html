<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE ì‹œì‘í•˜ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        /* ... (CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) ... */
    </style>
</head>
<body class="step-background-main">
    <script type="module">
        import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';
        import { db } from './js/firebase-config.js'; 
        import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

      // --- DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
      // ëª¨ë“  DOM ê´€ë ¨ ì‘ì—…ê³¼ ì´ˆê¸°í™” ë¡œì§ì„ ì´ ì•ˆìœ¼ë¡œ ì˜®ê¹ë‹ˆë‹¤.
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ: index.html");

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const stepUserType = document.getElementById('stepUserType');
        const stepCBT = document.getElementById('stepCBT');
        const stepCaregiverNeurodiversity = document.getElementById('stepCaregiverNeurodiversity');
        const stepDiagnosisType = document.getElementById('stepDiagnosisType');
        const stepNameBirthSelf = document.getElementById('stepNameBirthSelf');
        const stepNameBirthChild = document.getElementById('stepNameBirthChild');
        const stepChildEmail = document.getElementById('stepChildEmail');

        const cbtTitleEl = document.getElementById('cbtTitle'); // HTMLì— IDê°€ ìˆëŠ”ì§€ í™•ì¸
        const cbtInfoEl = document.getElementById('cbtInfo');   // HTMLì— IDê°€ ìˆëŠ”ì§€ í™•ì¸
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const cbtCodeInput = document.getElementById('cbtCodeInput');
        const cbtCodeError = document.getElementById('cbtCodeError');
        const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');
        
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfPromptEl = document.getElementById('nameSelfPrompt');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfPromptEl = document.getElementById('birthSelfPrompt');
        const birthSelfInfoTextEl = document.getElementById('birthSelfInfoText');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');

        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildPromptEl = document.getElementById('nameChildPrompt');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildPromptEl = document.getElementById('birthChildPrompt');
        const birthChildInfoTextEl = document.getElementById('birthChildInfoText');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');

        const childLozeeEmailInput = document.getElementById('childLozeeEmailInput');
        const childEmailError = document.getElementById('childEmailError');
        const submitChildEmailBtn = document.getElementById('submitChildEmailBtn');
        const skipChildEmailBtn = document.getElementById('skipChildEmailBtn');

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let selectedUserType = ''; 
        let caregiverSelfName = '', caregiverSelfBirthDate = '', caregiverSelfAge = 0;
        let childName = '', childBirthDate = '', childAge = 0;
        let directUserName = '', directUserBirthDate = '', directUserAge = 0;
        let selectedCaregiverNd = [];
        let selectedDiagnoses = [];

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function showStep(elToShow) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            if (elToShow) elToShow.classList.add('active');
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 3, endYearOffset = 90) {
            if (!yearEl || !monthEl || !dayEl) {
                console.error("populateBirthSelects: ìƒë…„ì›”ì¼ select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            yearEl.innerHTML = '<option value="">ë…„</option>'; // ì˜µì…˜ ì´ˆê¸°í™”
            monthEl.innerHTML = '<option value="">ì›”</option>';
            dayEl.innerHTML = '<option value="">ì¼</option>';

            const now = new Date();
            const currentYear = now.getFullYear();
            for (let y = currentYear - startYearOffset; y >= currentYear - endYearOffset; y--) {
                const opt = document.createElement('option'); opt.value = y; opt.textContent = y + 'ë…„'; yearEl.appendChild(opt);
            }
            for (let m = 1; m <= 12; m++) { const opt = document.createElement('option'); opt.value = m; opt.textContent = m + 'ì›”'; monthEl.appendChild(opt); }
            for (let d = 1; d <= 31; d++) { const opt = document.createElement('option'); opt.value = d; opt.textContent = d + 'ì¼'; dayEl.appendChild(opt); }
        }

        function calculateAge(y, m, d) { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        function createBaseUserData(email, userTypeToSave) { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        async function checkForExistingCbtUser(email) { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
 
        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì •ì˜ ë° ë“±ë¡ ---
        // 1. ì‚¬ìš©ì ìœ í˜• ì„ íƒ
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                localStorage.setItem('lozee_userType', selectedUserType);
                
                if (selectedUserType === 'caregiver') {
                    if(cbtTitleEl) cbtTitleEl.textContent = "ë³´í˜¸ìë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤!";
                    if(cbtInfoEl) cbtInfoEl.textContent = "ì›í™œí•œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ë³´í˜¸ìë‹˜ì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                    if(cbtCodeInput) cbtCodeInput.placeholder = "ë³´í˜¸ìë‹˜ ì´ë©”ì¼ ì£¼ì†Œ";
                } else { 
                    if(cbtTitleEl) cbtTitleEl.textContent = "ë¡œì§€ì™€ ëŒ€í™” ì‹œì‘í•˜ê¸°";
                    if(cbtInfoEl) cbtInfoEl.textContent = "CBT ì°¸ì—¬ì ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                    if(cbtCodeInput) cbtCodeInput.placeholder = "ì´ë©”ì¼ ì£¼ì†Œ";
                }
                showStep(stepCBT);
            };
        });

        // 2. CBT ì´ë©”ì¼ ì œì¶œ
        submitCbtCodeBtn.onclick = async () => {
            const email = cbtCodeInput.value.trim();
            if (!validateCbtEmail(email)) {
                cbtCodeError.textContent = getCbtErrorMessage(); return;
            }
            cbtCodeError.textContent = '';
            localStorage.setItem('cbtUserEmail', email.toLowerCase());
            localStorage.setItem('isCbtUser', 'true');

            const existingUserProcessed = await checkForExistingCbtUser(email);
            if (existingUserProcessed) return; 

            if (selectedUserType === 'caregiver') {
                showStep(stepCaregiverNeurodiversity);
            } else { 
                diagnosisTitleEl.textContent = "í˜„ì¬ ì–´ë–¤ ì–´ë ¤ì›€ì„ ëŠë¼ê³  ìˆë‚˜ìš”?";
                diagnosisInfoEl.textContent = "í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”. (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)";
                showStep(stepDiagnosisType);
            }
        };

        // 3. ë³´í˜¸ì ë³¸ì¸/ê´€ê³„ì¸ ì‹ ê²½ë‹¤ì–‘ì„± ì„ íƒ
        caregiverNdOptionBtns.forEach(button => { /* ... ì´ì „ ë‹µë³€ì˜ ì„ íƒ ë¡œì§ê³¼ ë™ì¼ ... */ });
        submitCaregiverNdBtn.onclick = () => { /* ... ì´ì „ ë‹µë³€ì˜ ë¡œì§ê³¼ ë™ì¼, localStorage ì €ì¥ ë° ë‹¤ìŒ ë‹¨ê³„ UI ì„¤ì • ... */         localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(selectedCaregiverNd));
            diagnosisTitleEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì–´ë–¤ ì ì— ëŒ€í•´ ì´ì•¼ê¸° ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì„¸ìš”?";
            diagnosisInfoEl.textContent = "í•´ë‹¹í•˜ëŠ” ì–´ë ¤ì›€ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”. (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)";
            showStep(stepDiagnosisType);};

        // 4. (ìì‹  ë˜ëŠ” ì•„ì´/ê°€ì¡±ì˜) ì‹ ê²½ë‹¤ì–‘ì„± ìœ í˜• ì„ íƒ
        diagnosisOptionBtns.forEach(button => { /* ... ì´ì „ ë‹µë³€ì˜ ì„ íƒ ë¡œì§ê³¼ ë™ì¼ ... */ });
        submitDiagnosisBtn.onclick = () => {
            if (selectedDiagnoses.length === 0 && !selectedDiagnoses.includes('NotApplicable') && !selectedDiagnoses.includes('Unsure')) {
                diagnosisError.textContent = "í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”."; return;
            }
            diagnosisError.textContent = '';
            localStorage.setItem('lozee_diagnoses', JSON.stringify(selectedDiagnoses));

            if (selectedUserType === 'caregiver') {
                nameBirthSelfTitleEl.textContent = "ë³´í˜¸ìë‹˜ì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
                nameSelfPromptEl.textContent = "ë¡œì§€ê°€ ë³´í˜¸ìë‹˜ì„ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?";
                nameSelfInput.placeholder = "ë³´í˜¸ìë‹˜ ì´ë¦„ ë˜ëŠ” ë³„ëª…";
                birthSelfPromptEl.textContent = "ë³´í˜¸ìë‹˜ì˜ ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
                birthSelfInfoTextEl.textContent = "ì •í™•í•œ ë‚˜ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ë§ì¶¤í˜• ìƒí˜¸ì‘ìš©ì„ ì œê³µí•©ë‹ˆë‹¤.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 18, 90); // ğŸ‘ˆ ë³´í˜¸ì ë‚˜ì´ ë²”ìœ„ë¡œ í˜¸ì¶œ
            } else { // directUser
                nameBirthSelfTitleEl.textContent = "ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”! ë‹¹ì‹ ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”.";
                nameSelfPromptEl.textContent = "ë¡œì§€ê°€ ë‹¹ì‹ ì„ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?";
                nameSelfInput.placeholder = "ì´ë¦„ ë˜ëŠ” ë³„ëª…";
                birthSelfPromptEl.textContent = "ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
                birthSelfInfoTextEl.textContent = "ì •í™•í•œ ë‚˜ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ë” ì ì ˆí•œ ëŒ€í™” ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90); // ğŸ‘ˆ ë‹¹ì‚¬ì ë‚˜ì´ ë²”ìœ„ë¡œ í˜¸ì¶œ (ê¸°ì¡´ 3~90)
            }
            showStep(stepNameBirthSelf);
        };
        
        // 5. ë³´í˜¸ì/ë‹¹ì‚¬ì ë³¸ì¸ ì´ë¦„/ìƒë…„ì›”ì¼ ì œì¶œ
        submitNameBirthSelfBtn.onclick = async () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            
            if (!name) { nameSelfError.textContent = 'ì´ë¦„(ë˜ëŠ” ë³„ëª…)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
            nameSelfError.textContent = '';
            if (!y || !m || !d) { birthSelfError.textContent = 'ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'; return; }
            birthSelfError.textContent = '';
            
            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                caregiverSelfName = name;
                caregiverSelfBirthDate = birthDate;
                caregiverSelfAge = age;
                
                nameBirthChildTitleEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
                nameChildPromptEl.textContent = "ë¡œì§€ê°€ ì•„ì´(ë˜ëŠ” ê°€ì¡±)ë¥¼ ì–´ë–»ê²Œ ë¶€ë¥´ë©´ ì¢‹ì„ê¹Œìš”?";
                nameChildInput.placeholder = "ì•„ì´(ë˜ëŠ” ê°€ì¡±) ì´ë¦„ ë˜ëŠ” ë³„ëª…";
                nameChildInput.value = ''; 
                birthChildPromptEl.textContent = "ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // ğŸ‘ˆ ìë…€ ë‚˜ì´ ë²”ìœ„ë¡œ í˜¸ì¶œ
                showStep(stepNameBirthChild);
            } else { // directUser
                directUserName = name;
                directUserBirthDate = birthDate;
                directUserAge = age;
                await saveUserDataToFirestore(); // ë‹¹ì‚¬ìëŠ” ë°”ë¡œ ì €ì¥ ë° ì´ë™
                window.location.href = 'talk.html';
            }
        };

        // 5-2. (ë³´í˜¸ì ì„ íƒ ì‹œ) ì•„ì´/ê°€ì¡± ì´ë¦„/ìƒë…„ì›”ì¼ ì œì¶œ
        submitNameBirthChildBtn.onclick = async () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;

            if (!name) { nameChildError.textContent = 'ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
            nameChildError.textContent = '';
            if (!y || !m || !d) { birthChildError.textContent = 'ì•„ì´(ë˜ëŠ” ê°€ì¡±)ì˜ ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'; return; }
            birthChildError.textContent = '';

            childName = name;
            childBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            childAge = calculateAge(y, m, d);

            await saveUserDataToFirestore(); 
            showStep(stepChildEmail); 
        };
        
        // Firestoreì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥ í•¨ìˆ˜
        async function saveUserDataToFirestore() { /* ... ì´ì „ ë‹µë³€ì˜ ë‚´ìš©ê³¼ ë™ì¼ ... */ }

        // 6. ì•„ì´/ê°€ì¡± ë¡œì§€ ì´ë©”ì¼ ì œì¶œ (ë³´í˜¸ì ì„ íƒ ì‹œ)
        submitChildEmailBtn.onclick = async () => { /* ... ì´ì „ê³¼ ë™ì¼ ... */ };
        skipChildEmailBtn.onclick = () => { /* ... ì´ì „ê³¼ ë™ì¼ ... */ };

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹¤í–‰ ë¡œì§ ---
        // populateBirthSelectsëŠ” ê° ì´ë¦„/ìƒë…„ì›”ì¼ ì…ë ¥ ë‹¨ê³„ ì§„ì… ì‹œ í˜¸ì¶œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë¯¸ë¦¬ í˜¸ì¶œí•  í•„ìš” ì—†ìŒ.
        showStep(stepUserType); // ì²« í™”ë©´ì€ ì‚¬ìš©ì ìœ í˜• ì„ íƒ
    });
    </script>
</body>
</html>