<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        .success-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #a5d6a7; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .success-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        button:disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
    </style>
</head>
<body class="step-background-main">
    <div id="stepAuthChoice" class="step active">
        <h2>LOZEE에 오신 것을 환영합니다!</h2>
        <button id="goToLoginBtn">로그인</button>
        <button id="goToSignUpBtn">회원가입</button>
    </div>

    <div id="stepLogin" class="step">
        <h2>로그인</h2>
        <div class="input-group"><label for="loginEmail">이메일</label><input type="email" id="loginEmail" placeholder="이메일 주소"></div>
        <div class="input-group"><label for="loginPassword">비밀번호</label><input type="password" id="loginPassword" placeholder="비밀번호"></div>
        <div class="error-message" id="loginError"></div>
        <button id="loginBtn">로그인</button>
        <button id="forgotPasswordBtn" class="secondary-btn">비밀번호를 잊으셨나요?</button>
        <p class="info-text" style="margin-top: 15px;">계정이 없으신가요? <a href="#" id="linkToSignUpFromLogin" style="color: #fff; text-decoration: underline;">회원가입</a></p>
    </div>

    <div id="stepPasswordReset" class="step">
        <h2>비밀번호 재설정</h2>
        <p>가입하신 이메일 주소를 입력하시면, 비밀번호 재설정 링크를 보내드립니다.</p>
        <div class="input-group"><label for="resetEmail">이메일</label><input type="email" id="resetEmail" placeholder="이메일 주소"></div>
        <div class="error-message" id="resetError"></div><div class="success-message" id="resetSuccess"></div>
        <button id="sendResetEmailBtn">재설정 이메일 발송</button>
        <button id="backToLoginBtn" class="secondary-btn">로그인으로 돌아가기</button>
    </div>

    <div id="stepUserType" class="step">
        <h2>회원가입</h2>
        <p>어떤 역할로 로지를 이용하시겠어요?</p>
        <div class="user-type-options"><button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요</button><button class="user-type-btn" data-usertype="caregiver">제가 보호자예요</button></div>
        <p class="info-text" style="margin-top: 15px;">이미 계정이 있으신가요? <a href="#" id="linkToLoginFromSignUp" style="color: #fff; text-decoration: underline;">로그인</a></p>
    </div>

    <div id="stepSignUpEmailPassword" class="step">
        <h2>회원가입</h2>
        <div class="input-group"><label for="signUpEmail">이메일</label><input type="email" id="signUpEmail" placeholder="이메일 주소"></div>
        <div class="input-group"><label for="signUpPassword">비밀번호 (6자리 이상)</label><input type="password" id="signUpPassword" placeholder="비밀번호"></div>
        <div class="input-group"><label for="signUpPasswordConfirm">비밀번호 확인</label><input type="password" id="signUpPasswordConfirm" placeholder="비밀번호 다시 입력"></div>
        <div class="error-message" id="signUpError"></div>
        <button id="createAccountBtn">가입 및 인증메일 발송</button>
    </div>

    <div id="stepEmailVerification" class="step">
        <h2>이메일 인증 안내</h2>
        <p>가입하신 이메일 주소(<strong id="verificationEmailDisplay"></strong>)로 인증 메일을 보냈습니다.<br>메일을 확인하고 인증 링크를 클릭해주세요.</p>
        <p class="info-text">인증을 완료하셨으면 아래 버튼을 눌러주세요.</p>
        <div class="error-message" id="verificationError"></div>
        <button id="checkVerificationBtn">인증 완료 확인</button>
    </div>
    
    <div id="stepFinalStart" class="step">
        <h2>모든 준비가 끝났어요!</h2>
        <p>이제 로지와 대화를 시작할 수 있습니다.</p>
        <button id="startLozeeBtn">대화 시작하기</button>
    </div>

    <script type="module">
        import { db, auth as firebaseAuth } from './js/firebase-config.js';
        import {
            listenAuthState,
            signUpWithEmail,
            signInWithEmail,
            resetPassword,
            saveUserProfile
        } from './js/auth.js';

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 요소 가져오기 ---
            const steps = {
                authChoice: document.getElementById('stepAuthChoice'),
                login: document.getElementById('stepLogin'),
                passwordReset: document.getElementById('stepPasswordReset'),
                userType: document.getElementById('stepUserType'),
                signUpEmailPassword: document.getElementById('stepSignUpEmailPassword'),
                emailVerification: document.getElementById('stepEmailVerification'),
                finalStart: document.getElementById('stepFinalStart')
            };

            const goToLoginBtn = document.getElementById('goToLoginBtn');
            const goToSignUpBtn = document.getElementById('goToSignUpBtn');
            const linkToSignUpFromLogin = document.getElementById('linkToSignUpFromLogin');
            const linkToLoginFromSignUp = document.getElementById('linkToLoginFromSignUp');
            const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn');
            const loginErrorEl = document.getElementById('loginError');
            const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
            const resetEmailInput = document.getElementById('resetEmail');
            const resetErrorEl = document.getElementById('resetError');
            const resetSuccessEl = document.getElementById('resetSuccess');
            const userTypeButtons = document.querySelectorAll('.user-type-btn');
            const signUpEmailInput = document.getElementById('signUpEmail');
            const signUpPasswordInput = document.getElementById('signUpPassword');
            const signUpPasswordConfirmInput = document.getElementById('signUpPasswordConfirm');
            const createAccountBtn = document.getElementById('createAccountBtn');
            const signUpErrorEl = document.getElementById('signUpError');
            const verificationEmailDisplayEl = document.getElementById('verificationEmailDisplay');
            const verificationErrorEl = document.getElementById('verificationError');
            const checkVerificationBtn = document.getElementById('checkVerificationBtn');
            const startLozeeBtn = document.getElementById('startLozeeBtn');
            
            // --- 상태 변수 ---
            let currentUserId = null;
            let selectedUserType = '';

            // --- 헬퍼 함수 ---
            function showStep(stepId) {
                Object.values(steps).forEach(step => step.classList.remove('active'));
                if (steps[stepId]) {
                    steps[stepId].classList.add('active');
                } else {
                    steps.authChoice.classList.add('active');
                }
            }

            // --- 이벤트 핸들러 ---
            goToLoginBtn.onclick = () => showStep('login');
            goToSignUpBtn.onclick = () => showStep('userType');
            linkToSignUpFromLogin.onclick = (e) => { e.preventDefault(); showStep('userType'); };
            linkToLoginFromSignUp.onclick = (e) => { e.preventDefault(); showStep('login'); };
            forgotPasswordBtn.onclick = () => showStep('passwordReset');
            backToLoginBtn.onclick = () => showStep('login');
            startLozeeBtn.onclick = () => { window.location.href = 'talk.html'; };

            userTypeButtons.forEach(button => {
                button.onclick = () => {
                    selectedUserType = button.dataset.usertype;
                    showStep('signUpEmailPassword');
                };
            });
            
            loginBtn.onclick = async () => {
                loginErrorEl.textContent = '';
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                if (!email || !password) {
                    loginErrorEl.textContent = '이메일과 비밀번호를 입력해주세요.';
                    return;
                }
                loginBtn.disabled = true;
                const { error } = await signInWithEmail(email, password);
                if (error) {
                    loginErrorEl.textContent = '로그인에 실패했습니다. 이메일 또는 비밀번호를 확인해주세요.';
                }
                loginBtn.disabled = false;
            };

            sendResetEmailBtn.onclick = async () => {
                resetErrorEl.textContent = '';
                resetSuccessEl.textContent = '';
                const email = resetEmailInput.value;
                if (!email) {
                    resetErrorEl.textContent = '이메일 주소를 입력해주세요.';
                    return;
                }
                const { success, error } = await resetPassword(email);
                if (success) {
                    resetSuccessEl.textContent = '비밀번호 재설정 이메일을 보냈습니다. 메일함을 확인해주세요.';
                } else {
                    resetErrorEl.textContent = '이메일 발송에 실패했습니다.';
                }
            };
            
            createAccountBtn.onclick = async () => {
                signUpErrorEl.textContent = '';
                const email = signUpEmailInput.value;
                const password = signUpPasswordInput.value;
                const passwordConfirm = signUpPasswordConfirmInput.value;
                if (password !== passwordConfirm) {
                    signUpErrorEl.textContent = '비밀번호가 일치하지 않습니다.';
                    return;
                }
                createAccountBtn.disabled = true;
                const { user, error } = await signUpWithEmail(email, password);
                if (error) {
                    signUpErrorEl.textContent = '계정 생성에 실패했습니다: ' + error.message;
                } else {
                    verificationEmailDisplayEl.textContent = user.email;
                    showStep('emailVerification');
                }
                createAccountBtn.disabled = false;
            };

            checkVerificationBtn.onclick = async () => {
                verificationErrorEl.textContent = '';
                await firebaseAuth.currentUser?.reload();
                if (firebaseAuth.currentUser?.emailVerified) {
                    await saveUserProfile(firebaseAuth.currentUser.uid, { userType: selectedUserType });
                    showStep('finalStart');
                } else {
                    verificationErrorEl.textContent = '아직 이메일 인증이 완료되지 않았습니다.';
                }
            };

            // --- 페이지 로드 시 인증 상태 확인 ---
            listenAuthState(
                (user, userProfile) => {
                    currentUserId = user.uid;
                    if (!user.emailVerified) {
                        verificationEmailDisplayEl.textContent = user.email;
                        showStep('emailVerification');
                    } else if (userProfile) {
                        window.location.href = 'talk.html';
                    } else {
                        showStep('userType'); // 프로필이 없는 경우
                    }
                },
                () => { // 로그아웃 상태
                    showStep('authChoice');
                }
            );
        });
    </script>
</body>
</html>