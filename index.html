<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <style>
        body, html { margin:0; padding:0; font-family:'KoPub World Dotum',sans-serif; color:#fff; height:100%; overflow:hidden; }
        .step { display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;
                 text-align:center; height:100vh; width:100vw; position:absolute; top:0; left:0; }
        .step.active { display:flex; }
        .step-background-main { background:linear-gradient(135deg,#6078ea,#a777e3); }
        h2 { font-size:1.8em; margin-bottom:20px; color:#fff; }
        p { font-size:1.1em; line-height:1.6; margin-bottom:15px; color:#f0f0f0; }
        .info-text, #topicStepDescription { color:#e0e0e0; font-size:.9em; margin-bottom:15px; }
        .intro-message { color:#f5f5f5; line-height:1.9; font-size:1.05em; max-width:450px; text-align:left; margin-bottom:25px; }
        .intro-message strong, .intro-message .app-name-meaning { font-weight:bold; color:#fff; }
        .developer-contact { margin-top:20px; font-size:.9em; color:#ddd; }
        .error-message { font-weight:bold; font-size:.9em; min-height:1.2em; margin-top:5px; margin-bottom:10px;
                         padding:5px 8px; color:#ffcdd2; background:rgba(0,0,0,0.15); border-radius:4px; }
        .error-message:empty { display:none; }
        input, select { padding:12px; margin-bottom:12px; border:1px solid #bdbdbd; border-radius:8px;
                       width:85%; max-width:350px; font-size:1em; background:#fdfdfd; box-sizing:border-box; }
        button { padding:13px 28px; background:#fff; color:#6e8efb; border:none; border-radius:25px;
                  cursor:pointer; font-weight:bold; font-size:1.05em; margin-top:20px;
                  box-shadow:0 4px 8px rgba(0,0,0,0.15); transition:background-color .2s,transform .2s; }
        button:hover { background:#f5f5f5; transform:translateY(-2px); }
        button:disabled { background:#e0e0e0; color:#9e9e9e; cursor:not-allowed; transform:none; box-shadow:none; }
        .options-container { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:20px;
                             width:100%; max-width:480px; }
        .options-container button { background:rgba(255,255,255,0.25); color:#fff; border:1px solid rgba(255,255,255,0.6);
                                     padding:10px 15px; border-radius:20px; font-size:.9em; box-shadow:0 2px 4px rgba(0,0,0,0.1);
                                     transition:background-color .2s,color .2s,transform .1s,box-shadow .2s; flex-shrink:0; }
        .options-container button.selected, .options-container button:hover {
            background:#fff; color:#6078ea; border-color:#fff; transform:translateY(-1px) scale(1.03);
            box-shadow:0 4px 6px rgba(0,0,0,0.1);
        }
        .navigation-buttons { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:15px;
                               width:100%; max-width:480px; }
        .navigation-buttons button { background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.4);
                                     color:#f0f0f0; padding:10px 20px; font-size:.95em; }
        .navigation-buttons button:hover {
            background:rgba(255,255,255,0.25); color:#fff; transform:translateY(-1px); border-color:rgba(255,255,255,0.6);
        }
        .secondary-button { background:transparent !important; border:1px solid #dcd0ff !important; color:#dcd0ff !important; }
        .secondary-button:hover { background:rgba(255,255,255,0.1) !important; color:#fff !important; }
    </style>
</head>
<body class="step-background-main">
    <!-- 스텝 구조 생략 (stepCBT, stepNameAge, stepDiagnosis, stepLozeeIntro, stepTopic) -->

    <script type="module">
        import { counselingTopicsByAge } from './js/counseling_topics.js';
        import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';

        // ── DOM 참조 ─────────────────────────────────
        const steps = [
            document.getElementById('stepCBT'),
            document.getElementById('stepNameAge'),
            document.getElementById('stepDiagnosis'),
            document.getElementById('stepLozeeIntro'),
            document.getElementById('stepTopic')
        ];
        const [
            cbtCodeInput, cbtCodeError, submitCbtCodeBtn,
            nameInput, nameError, ageSelectInput, ageError, submitNameAgeBtn,
            diagnosisSelection, diagnosisError, submitDiagnosisBtn,
            confirmLozeeIntroBtn,
            topicUserAgeInfo, topicCategorySelection,
            subTopicSelectionContainer, subTopicButtons,
            moreTopicsBtn, backToCategoriesBtn,
            noSpecificTopicBtn, lozeePickBtn,
            topicStepTitle, topicStepDescription
        ] = [
            'cbtCodeInput','cbtCodeError','submitCbtCodeBtn',
            'nameInput','nameError','ageSelectInput','ageError','submitNameAgeBtn',
            'diagnosisSelection','diagnosisError','submitDiagnosisBtn',
            'confirmLozeeIntroBtn',
            'topicUserAgeInfo','topicCategorySelection',
            'subTopicSelectionContainer','subTopicButtons',
            'moreTopicsBtn','backToCategoriesBtn',
            'noSpecificTopicBtn','lozeePickBtn',
            'topicStepTitle','topicStepDescription'
        ].map(id => document.getElementById(id));

        function showStep(idx) {
            steps.forEach((s,i)=>s.classList.toggle('active', i===idx));
        }

        const playTTS = async txt=>console.log('[MOCK TTS]', txt);

        function populateAgeOptions(){
            for(let i=5;i<=90;i++){
                const o=document.createElement('option');o.value=i; o.textContent=`${i}세`;
                ageSelectInput.appendChild(o);
            }
        }

        const diagnosisOptions=[
            {id:'adhd',text:'ADHD'},{id:'asd',text:'ASD'},{id:'asperger',text:'ASD(아스퍼거증후군)'},
            {id:'social_comm_disorder',text:'사회적의사소통장애'},{id:'2e',text:'Audhd'},
            {id:'borderline_intel',text:'경계선지능'},{id:'developmental_dis',text:'발달장애'},
            {id:'language_delay',text:'언어지연'},{id:'none',text:'진단받은 것 없어',exclusive:true},
            {id:'prefer_not_to_say',text:'지금은 선택 안할래',exclusive:true}
        ];
        function populateDiagnosisOptions(){
            diagnosisSelection.innerHTML='';
            diagnosisOptions.forEach(d=>{
                const b=document.createElement('button');b.textContent=d.text; b.dataset.id=d.id;
                if(d.exclusive) b.dataset.exclusive='true';
                b.onclick=()=>{
                    b.classList.toggle('selected');
                    if(b.dataset.exclusive)
                        diagnosisSelection.querySelectorAll('button').forEach(x=>x!==b&&x.classList.remove('selected'));
                    else if(b.classList.contains('selected'))
                        diagnosisSelection.querySelectorAll('button[data-exclusive]')
                            .forEach(x=>x.classList.remove('selected'));
                };
                diagnosisSelection.appendChild(b);
            });
        }

        function proceedToNext(errElem,ttsText, nextIdx){
            if(errElem) errElem.textContent='';
            playTTS(ttsText);
            showStep(nextIdx);
        }

        submitCbtCodeBtn.onclick=()=>{
            const email=cbtCodeInput.value.trim();
            if(!validateCbtEmail(email)){
                cbtCodeError.textContent=getCbtErrorMessage();playTTS(getCbtErrorMessage());return;
            }
            localStorage.setItem('cbtUserEmail',email.toLowerCase());
            localStorage.setItem('isCbtUser','true');
            localStorage.setItem('cbtVerified','true');
            proceedToNext(cbtCodeError,'이메일이 확인되었어요. 만나서 반가워요!',1);
        };
        submitNameAgeBtn.onclick=()=>{
            const n=nameInput.value.trim(), a=ageSelectInput.value;
            if(!n){nameError.textContent='이름을 입력해주세요.';playTTS('이름을 입력해주세요.');return;}
            nameError.textContent='';
            if(!a){ageError.textContent='나이를 선택해주세요.';playTTS('나이를 선택해주세요.');return;}
            ageError.textContent='';
            localStorage.setItem('lozee_username',n);
            localStorage.setItem('lozee_userage',a);
            proceedToNext(ageError,'좋아요. 어떤 어려움이 있나요?',2);
        };
        submitDiagnosisBtn.onclick=()=>{
            const sel=Array.from(diagnosisSelection.querySelectorAll('button.selected')).map(b=>b.dataset.id);
            localStorage.setItem('lozee_userdisease',JSON.stringify(sel));
            const age=parseInt(localStorage.getItem('lozee_userage'),10);
            const target=['adhd','asd','asperger','social_comm_disorder','2e'];
            const has=sel.some(id=>target.includes(id));
            if(has){
                renderTopicCategories(age);
                proceedToNext(diagnosisError,'어떤 종류의 이야기를 하고 싶으세요?',4);
            } else {
                proceedToNext(diagnosisError,'로지에 대해 안내할게요.',3);
            }
        };
        confirmLozeeIntroBtn.onclick=()=>proceedToNext(null,'처음으로 돌아갑니다.',0);

        // ── 카테고리 페이지네이션 ─────────────────────────
        const MAX_CATEGORIES_PER_PAGE=6;
        let displayedCategoryIndex=0;
        function getTopicDataForAge(age){
            const key='8-10';
            return counselingTopicsByAge[key]||{};
        }
        function renderTopicCategories(age){
            topicCategorySelection.innerHTML='';
            subTopicSelectionContainer.style.display='none';
            topicCategorySelection.style.display='flex';
            const topicData=getTopicDataForAge(age);
            const cats=Object.keys(topicData);
            if(cats.length===0){ topicCategorySelection.innerHTML='<p>준비된 주제가 없어요.</p>';return; }
            // 1) 페이지네이션
            const toShow=cats.slice(displayedCategoryIndex,displayedCategoryIndex+MAX_CATEGORIES_PER_PAGE);
            toShow.forEach(catKey=>{
                const b=document.createElement('button');
                b.innerHTML=`${topicData[catKey][0]?.icon||'📁'} ${catKey}`;
                b.onclick=()=>{/* 서브토픽 렌더 */};
                topicCategorySelection.appendChild(b);
            });
            // 2) 더 보기 버튼
            const hasMore=displayedCategoryIndex+MAX_CATEGORIES_PER_PAGE<cats.length;
            let mBtn=document.getElementById('moreCategoriesBtn');
            if(!mBtn){
                mBtn=document.createElement('button');mBtn.id='moreCategoriesBtn';
                mBtn.className='secondary-button';mBtn.textContent='다른 카테고리 더 보기';
                mBtn.style.margin='10px auto';
                mBtn.onclick=()=>{ displayedCategoryIndex+=MAX_CATEGORIES_PER_PAGE;renderTopicCategories(age);};
                topicCategorySelection.parentNode.appendChild(mBtn);
            }
            mBtn.style.display=hasMore?'block':'none';
        }

        backToCategoriesBtn.onclick=()=>{
            displayedCategoryIndex=0; renderTopicCategories(localStorage.getItem('lozee_userage'));
            playTTS('다른 카테고리를 골라볼까요?');
        };
        lozeePickBtn.onclick=()=>{ displayedCategoryIndex=0; /* 랜덤픽 로직 */ };
        noSpecificTopicBtn.onclick=()=>{ displayedCategoryIndex=0; /* 직접입력 로직 */ };

        document.addEventListener('DOMContentLoaded',()=>{
            populateAgeOptions();populateDiagnosisOptions(); playTTS('안녕하세요! 이메일 입력해주세요.'); showStep(0);
        });
    </script>
</body>
</html>
