<body class="step-background-main">
    <div id="stepAuthChoice" class="step active">
        <h2>LOZEE에 오신 것을 환영합니다!</h2>
        <button id="goToLoginBtn">로그인</button>
        <button id="goToSignUpBtn">회원가입</button>
    </div>

    <div id="stepLogin" class="step">
        <h2>로그인</h2>
        <div class="input-group">
            <label for="loginEmail">이메일</label>
            <input type="email" id="loginEmail" placeholder="이메일 주소">
        </div>
        <div class="input-group">
            <label for="loginPassword">비밀번호</label>
            <input type="password" id="loginPassword" placeholder="비밀번호">
        </div>
        <div class="error-message" id="loginError"></div>
        <button id="loginBtn">로그인</button>
        <button id="forgotPasswordBtn" class="secondary-btn">비밀번호를 잊으셨나요?</button>
        <p class="info-text" style="margin-top: 15px;">계정이 없으신가요? <a href="#" id="linkToSignUpFromLogin" style="color: #fff; text-decoration: underline;">회원가입</a></p>
    </div>

    <div id="stepPasswordReset" class="step">
        <h2>비밀번호 재설정</h2>
        <p>가입하신 이메일 주소를 입력하시면, 비밀번호 재설정 링크를 보내드립니다.</p>
        <div class="input-group">
            <label for="resetEmail">이메일</label>
            <input type="email" id="resetEmail" placeholder="이메일 주소">
        </div>
        <div class="error-message" id="resetError"></div>
        <div class="success-message" id="resetSuccess" style="color: #a5d6a7;"></div>
        <button id="sendResetEmailBtn">재설정 이메일 발송</button>
        <button id="backToLoginBtn" class="secondary-btn">로그인으로 돌아가기</button>
    </div>

    <div id="stepUserType" class="step">
        <h2>회원가입: 역할 선택</h2>
        <p>어떤 역할로 로지를 이용하시겠어요?</p>
        <div class="user-type-options">
            <button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br><span class="btn-subtitle">(신경다양인 당사자)</span></button>
            <button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br><span class="btn-subtitle">(양육자, 배우자 등)</span></button>
        </div>
        <div class="error-message" id="userTypeError"></div>
         <p class="info-text" style="margin-top: 15px;">이미 계정이 있으신가요? <a href="#" id="linkToLoginFromSignUp" style="color: #fff; text-decoration: underline;">로그인</a></p>
    </div>

    <div id="stepSignUpEmailPassword" class="step"> <h2>회원가입: 계정 정보 입력</h2>
        <div class="input-group">
            <label for="signUpEmail">이메일</label>
            <input type="email" id="signUpEmail" placeholder="이메일 주소">
        </div>
        <div class="input-group">
            <label for="signUpPassword">비밀번호 (6자리 이상)</label>
            <input type="password" id="signUpPassword" placeholder="비밀번호">
        </div>
        <div class="input-group">
            <label for="signUpPasswordConfirm">비밀번호 확인</label>
            <input type="password" id="signUpPasswordConfirm" placeholder="비밀번호 다시 입력">
        </div>
        <div class="error-message" id="signUpError"></div>
        <button id="createAccountBtn">계정 생성 및 인증 메일 발송</button>
    </div>

    <div id="stepEmailVerification" class="step">
        <h2>이메일 인증 안내</h2>
        <p>가입하신 이메일 주소(<strong id="verificationEmailDisplay"></strong>)로 인증 메일을 보냈습니다.<br>메일을 확인하고 인증 링크를 클릭해주세요.</p>
        <p class="info-text">인증을 완료하셨으면 아래 버튼을 눌러주세요.</p>
        <div class="error-message" id="verificationError"></div>
        <button id="checkVerificationBtn">이메일 인증 완료</button>
        <button id="resendVerificationBtn" class="secondary-btn">인증 메일 다시 보내기</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step"> </div>
    <div id="stepDiagnosisType" class="step"> </div>
    <div id="stepNameBirthSelf" class="step"> </div>
    <div id="stepNameBirthChild" class="step"> </div>

    <div id="stepChildLink" class="step">
        <h2>자녀 계정 연결 (선택 사항)</h2>
        <p>자녀가 로지를 사용하고 있다면, 자녀의 로지 가입 이메일을 입력하여 연결 요청을 보낼 수 있습니다.<br>자녀가 수락하면, 자녀의 활동 중 특정 위험 신호에 대한 알림을 받으실 수 있습니다.</p>
        <p class="info-text" style="font-size: 0.85em; color: #ffeb3b;"><strong>[중요]</strong> 개인 정보 보호를 위해, 이 기능은 자녀의 동의가 반드시 필요합니다.</p>
        <div class="input-group">
            <label for="childLinkEmailInput">자녀 로지 가입 이메일</label>
            <input type="email" id="childLinkEmailInput" placeholder="자녀 이메일 주소 (선택 사항)">
        </div>
        <div class="error-message" id="childLinkError"></div>
        <button id="sendChildLinkRequestBtn">연결 요청 보내고 시작</button>
        <button id="skipChildLinkBtn" class="secondary-btn">건너뛰고 시작</button>
    </div>

    <div id="stepFinalStart" class="step">
        <h2>모든 준비가 끝났어요!</h2>
        <p>입력해주신 정보를 바탕으로 로지가 더 의미있는 대화를 나눌 수 있을 거예요.</p>
        <button id="startLozeeConversationBtn">로지와 대화 시작하기</button>
    </div>

    <script type="module">
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { db, auth as firebaseAuth } from './js/firebase-config.js';
        import { doc, setDoc, getDoc, serverTimestamp, updateDoc, collection, addDoc, query, where, writeBatch } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // --- DOM 요소 가져오기 ---
        const steps = {
            authChoice: document.getElementById('stepAuthChoice'),
            login: document.getElementById('stepLogin'),
            passwordReset: document.getElementById('stepPasswordReset'),
            userType: document.getElementById('stepUserType'),
            signUpEmailPassword: document.getElementById('stepSignUpEmailPassword'),
            emailVerification: document.getElementById('stepEmailVerification'),
            caregiverNd: document.getElementById('stepCaregiverNeurodiversity'),
            diagnosisType: document.getElementById('stepDiagnosisType'),
            nameBirthSelf: document.getElementById('stepNameBirthSelf'),
            nameBirthChild: document.getElementById('stepNameBirthChild'),
            childLink: document.getElementById('stepChildLink'), // 자녀 연결 단계
            finalStart: document.getElementById('stepFinalStart')
        };

        // 로그인 관련
        const goToLoginBtn = document.getElementById('goToLoginBtn');
        const goToSignUpBtn = document.getElementById('goToSignUpBtn');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginErrorEl = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const linkToSignUpFromLogin = document.getElementById('linkToSignUpFromLogin');

        // 비밀번호 재설정 관련
        const resetEmailInput = document.getElementById('resetEmail');
        const resetErrorEl = document.getElementById('resetError');
        const resetSuccessEl = document.getElementById('resetSuccess');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');

        // 회원가입 관련
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const userTypeErrorEl = document.getElementById('userTypeError');
        const linkToLoginFromSignUp = document.getElementById('linkToLoginFromSignUp');

        const signUpEmailInput = document.getElementById('signUpEmail');
        const signUpPasswordInput = document.getElementById('signUpPassword');
        const signUpPasswordConfirmInput = document.getElementById('signUpPasswordConfirm');
        const signUpErrorEl = document.getElementById('signUpError');
        const createAccountBtn = document.getElementById('createAccountBtn');

        const verificationEmailDisplayEl = document.getElementById('verificationEmailDisplay');
        const verificationErrorEl = document.getElementById('verificationError');
        const checkVerificationBtn = document.getElementById('checkVerificationBtn');
        const resendVerificationBtn = document.getElementById('resendVerificationBtn');

        // 프로필 정보 입력 관련 (기존 DOM 요소 사용)
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');
        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');

        // 자녀 계정 연결 관련
        const childLinkEmailInput = document.getElementById('childLinkEmailInput');
        const childLinkErrorEl = document.getElementById('childLinkError');
        const sendChildLinkRequestBtn = document.getElementById('sendChildLinkRequestBtn');
        const skipChildLinkBtn = document.getElementById('skipChildLinkBtn');
        
        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn');


        // --- 상태 변수 ---
        let currentAuthUser = null; // Firebase Auth User 객체
        let currentUserId = null;   // Firebase Auth UID
        let selectedUserType = '';  // 'directUser' 또는 'caregiver'
        let tempCaregiverSelfName = '', tempCaregiverSelfBirthDate = null, tempCaregiverSelfAge = null;
        let tempChildName = '', tempChildBirthDate = null, tempChildAge = null;
        let tempDirectUserName = '', tempDirectUserBirthDate = null, tempDirectUserAge = null;
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = [];


        // --- 헬퍼 함수 ---
        function showStep(stepElement) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            if (stepElement) stepElement.classList.add('active');
            else {
                 console.error("showStep: 표시할 stepElement가 없습니다. 기본 단계(authChoice)로 이동합니다.");
                 if(steps.authChoice) steps.authChoice.classList.add('active');
            }
        }
        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) { /* ... 이전과 동일 ... */ }
        function calculateAge(y, m, d) { /* ... 이전과 동일 ... */ }

        async function saveOrUpdateUserProfile(uid, profileData) {
            if (!uid || !profileData) {
                console.error("saveOrUpdateUserProfile: UID 또는 프로필 데이터가 없습니다.");
                alert("사용자 정보를 저장하는 데 실패했습니다. 필수 정보가 누락되었습니다.");
                return false;
            }
            const userRef = doc(db, "users", uid);
            const dataToSave = {
                uid: uid,
                email: firebaseAuth.currentUser ? firebaseAuth.currentUser.email : profileData.email, // 인증된 이메일 사용
                ...profileData,
                lastLogin: serverTimestamp()
            };

            try {
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    dataToSave.createdAt = serverTimestamp();
                    await setDoc(userRef, dataToSave);
                    console.log(`[saveOrUpdateUserProfile] Firestore에 새 사용자 문서 생성: ${uid}`, dataToSave);
                } else {
                    await setDoc(userRef, dataToSave, { merge: true });
                    console.log(`[saveOrUpdateUserProfile] Firestore 사용자 문서 업데이트: ${uid}`, dataToSave);
                }
                return true;
            } catch (error) {
                console.error(`[saveOrUpdateUserProfile] 사용자 문서 저장/업데이트 실패 (${uid}):`, error.message, error);
                alert("사용자 정보를 저장하는 데 실패했습니다. 인터넷 연결 및 Firestore 보안 규칙을 확인해주세요.\n오류: " + error.message);
                return false;
            }
        }

        function setLocalStorageAndRedirect(profileData, userAgeForTalkContext, childData = null) {
            localStorage.setItem('lozee_userId', currentUserId);
            localStorage.setItem('lozee_username', profileData.name);
            localStorage.setItem('lozee_userAge', userAgeForTalkContext !== null ? userAgeForTalkContext.toString() : '0');
            localStorage.setItem('lozee_role', profileData.role);
            localStorage.setItem('lozee_userType', profileData.userType);

            if (profileData.userType === 'caregiver' && childData) {
                localStorage.setItem('lozee_childName', childData.name);
                localStorage.setItem('lozee_childAge', childData.age !== null ? childData.age.toString() : '0');
                localStorage.setItem('lozee_diagnoses', JSON.stringify(childData.diagnoses || [])); // 자녀 특성
                localStorage.setItem('lozee_parentIsND', JSON.stringify(profileData.caregiverInfo.caregiverNeurodiversity.length > 0 && !profileData.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')));
                localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(profileData.caregiverInfo.caregiverNeurodiversity));
                if (childData.uid) localStorage.setItem('lozee_childId', childData.uid); // 연결된 자녀 UID
            } else { // directUser
                localStorage.setItem('lozee_diagnoses', JSON.stringify(profileData.diagnoses || [])); // 본인 특성
                localStorage.removeItem('lozee_childName');
                localStorage.removeItem('lozee_childAge');
                localStorage.removeItem('lozee_parentIsND');
                localStorage.removeItem('lozee_childId');
                localStorage.removeItem('lozee_caregiver_neurodiversity');
            }
            console.log("모든 정보 저장 완료. talk.html로 이동합니다.");
            window.location.href = 'talk.html';
        }


        // --- 이벤트 핸들러 바인딩 ---
        if(goToLoginBtn) goToLoginBtn.onclick = () => showStep(steps.login);
        if(goToSignUpBtn) goToSignUpBtn.onclick = () => showStep(steps.userType); // 회원가입은 역할 선택부터
        if(linkToSignUpFromLogin) linkToSignUpFromLogin.onclick = (e) => { e.preventDefault(); showStep(steps.userType); };
        if(linkToLoginFromSignUp) linkToLoginFromSignUp.onclick = (e) => { e.preventDefault(); showStep(steps.login); };
        if(forgotPasswordBtn) forgotPasswordBtn.onclick = () => showStep(steps.passwordReset);
        if(backToLoginBtn) backToLoginBtn.onclick = () => showStep(steps.login);

        // 로그인 버튼
        if(loginBtn) loginBtn.onclick = async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if(loginErrorEl) loginErrorEl.textContent = '';
            if (!email || !password) { if(loginErrorEl) loginErrorEl.textContent = "이메일과 비밀번호를 모두 입력해주세요."; return; }

            try {
                const userCredential = await signInWithEmailAndPassword(firebaseAuth, email, password);
                currentAuthUser = userCredential.user;
                currentUserId = currentAuthUser.uid;
                localStorage.setItem('lozee_userId', currentUserId);

                if (!currentAuthUser.emailVerified) {
                    if(loginErrorEl) loginErrorEl.textContent = "이메일 인증이 완료되지 않았습니다. 메일함의 인증 링크를 클릭해주세요.";
                    // (선택) 로그아웃 처리 후 이메일 인증 단계로 보낼 수 있음
                    // await signOut(firebaseAuth); currentAuthUser = null; currentUserId = null;
                    // if(verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                    // showStep(steps.emailVerification);
                    return;
                }

                // Firestore에서 사용자 정보 로드하여 localStorage 업데이트
                const userRef = doc(db, "users", currentUserId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    let ageForTalk = userData.age; // 기본은 본인 나이
                    if (userData.userType === 'caregiver' && userData.caregiverInfo) {
                        ageForTalk = userData.caregiverInfo.childAge; // 보호자면 자녀 나이
                    }
                    setLocalStorageAndRedirect(userData, ageForTalk, userData.caregiverInfo);
                } else {
                    // 프로필이 없는 경우 (이론상으로는 회원가입 시 생성되어야 함)
                    console.warn("로그인 성공했으나 Firestore에 사용자 프로필이 없습니다. 프로필 입력 단계로 이동합니다.");
                    selectedUserType = localStorage.getItem('lozee_userType') || 'directUser'; // 기본값
                    if (selectedUserType === 'caregiver') showStep(steps.caregiverNd);
                    else showStep(steps.diagnosisType);
                }
            } catch (error) {
                console.error("로그인 실패:", error.code, error.message);
                if(loginErrorEl) loginErrorEl.textContent = "이메일 또는 비밀번호가 올바르지 않거나, 사용자 계정을 찾을 수 없습니다.";
            }
        };

        // 비밀번호 재설정 버튼
        if(sendResetEmailBtn) sendResetEmailBtn.onclick = async () => {
            const email = resetEmailInput.value.trim();
            if(resetErrorEl) resetErrorEl.textContent = '';
            if(resetSuccessEl) resetSuccessEl.textContent = '';
            if (!email) { if(resetErrorEl) resetErrorEl.textContent = "이메일을 입력해주세요."; return; }

            try {
                await sendPasswordResetEmail(firebaseAuth, email);
                if(resetSuccessEl) resetSuccessEl.textContent = "비밀번호 재설정 이메일을 보냈습니다. 메일함을 확인해주세요.";
            } catch (error) {
                console.error("비밀번호 재설정 이메일 발송 실패:", error.code, error.message);
                if(resetErrorEl) resetErrorEl.textContent = "이메일 발송에 실패했습니다. 다시 시도해주세요.";
            }
        };

        // 회원가입: 역할 선택 (기존 userTypeButtons 핸들러와 유사)
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                showStep(steps.signUpEmailPassword); // 이메일/비번 입력 단계로
            };
        });

        // 회원가입: 계정 생성 버튼
        if(createAccountBtn) createAccountBtn.onclick = async () => {
            const email = signUpEmailInput.value.trim();
            const password = signUpPasswordInput.value;
            const passwordConfirm = signUpPasswordConfirmInput.value;
            if(signUpErrorEl) signUpErrorEl.textContent = '';

            if (!email || !password || !passwordConfirm) { if(signUpErrorEl) signUpErrorEl.textContent = "모든 필드를 입력해주세요."; return; }
            if (password !== passwordConfirm) { if(signUpErrorEl) signUpErrorEl.textContent = "비밀번호가 일치하지 않습니다."; return; }
            if (password.length < 6) { if(signUpErrorEl) signUpErrorEl.textContent = "비밀번호는 6자리 이상이어야 합니다."; return; }

            try {
                const userCredential = await createUserWithEmailAndPassword(firebaseAuth, email, password);
                currentAuthUser = userCredential.user;
                currentUserId = currentAuthUser.uid;
                console.log("계정 생성 성공, UID:", currentUserId);

                await sendEmailVerification(currentAuthUser);
                console.log("인증 메일 발송됨.");
                if(verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                showStep(steps.emailVerification);

            } catch (error) {
                console.error("회원가입 실패:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    if(signUpErrorEl) signUpErrorEl.textContent = "이미 사용 중인 이메일입니다.";
                } else if (error.code === 'auth/weak-password') {
                    if(signUpErrorEl) signUpErrorEl.textContent = "비밀번호는 6자리 이상이어야 합니다.";
                } else {
                    if(signUpErrorEl) signUpErrorEl.textContent = "계정 생성에 실패했습니다: " + error.message;
                }
            }
        };

        // 이메일 인증 확인 버튼
        if(checkVerificationBtn) checkVerificationBtn.onclick = async () => {
            if (!firebaseAuth.currentUser) {
                if(verificationErrorEl) verificationErrorEl.textContent = "사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.";
                showStep(steps.login);
                return;
            }
            await firebaseAuth.currentUser.reload(); // 최신 사용자 상태 가져오기
            if (firebaseAuth.currentUser.emailVerified) {
                console.log("이메일 인증 완료!");
                if(verificationErrorEl) verificationErrorEl.textContent = '';
                // 인증 완료 후 프로필 입력 단계로 이동
                if (selectedUserType === 'caregiver') {
                    showStep(steps.caregiverNd);
                } else { // directUser
                    if(diagnosisTitleEl) diagnosisTitleEl.textContent = "현재 어떤 어려움을 느끼고 있나요?";
                    if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 항목을 모두 선택해주세요. (중복 선택 가능)";
                    showStep(steps.diagnosisType);
                }
            } else {
                if(verificationErrorEl) verificationErrorEl.textContent = "아직 이메일 인증이 완료되지 않았습니다. 메일함의 인증 링크를 클릭해주세요.";
            }
        };

        // 인증 메일 다시 보내기 버튼
        if(resendVerificationBtn) resendVerificationBtn.onclick = async () => {
            if (firebaseAuth.currentUser) {
                try {
                    await sendEmailVerification(firebaseAuth.currentUser);
                    alert("인증 메일을 다시 보냈습니다. 메일함을 확인해주세요.");
                } catch (error) {
                    console.error("인증 메일 재발송 실패:", error);
                    alert("인증 메일 재발송에 실패했습니다: " + error.message);
                }
            } else {
                alert("사용자 정보를 찾을 수 없습니다. 로그인 단계로 이동합니다.");
                showStep(steps.login);
            }
        };

        // --- 프로필 정보 입력 단계 이벤트 핸들러들 (기존과 동일, temp 변수에 저장) ---
        if(submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => { /* tempSelectedCaregiverNd 저장 후 다음 단계 */ showStep(steps.diagnosisType); };
        if(submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => { /* tempSelectedDiagnoses 저장 후 다음 단계 */ showStep(steps.nameBirthSelf); };
        if(submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => { /* tempDirectUserName/tempCaregiverSelfName 등 저장 후 다음 단계 */
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            if (!name || !y || !m || !d) { /* 오류 처리 */ return; }
            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            if (selectedUserType === 'caregiver') {
                tempCaregiverSelfName = name; tempCaregiverSelfBirthDate = birthDate; tempCaregiverSelfAge = age;
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18); showStep(steps.nameBirthChild);
            } else {
                tempDirectUserName = name; tempDirectUserBirthDate = birthDate; tempDirectUserAge = age;
                showStep(steps.finalStart); // 당사자는 자녀 정보 입력 없이 바로 finalStart로
            }
        };
        if(submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => { /* tempChildName 등 저장 후 다음 단계 */
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
            if (!name || !y || !m || !d) { /* 오류 처리 */ return; }
            const age = calculateAge(y,m,d);
            tempChildName = name; tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; tempChildAge = age;
             // 보호자는 자녀 정보 입력 후, 자녀 계정 연결 단계 또는 바로 finalStart로
            showStep(steps.childLink); // 자녀 계정 연결 단계로
        };

        // 자녀 계정 연결 단계 버튼 핸들러
        if(sendChildLinkRequestBtn) sendChildLinkRequestBtn.onclick = async () => {
            const childEmailToLink = childLinkEmailInput.value.trim();
            if(childLinkErrorEl) childLinkErrorEl.textContent = '';
            if (childEmailToLink) {
                // TODO: 자녀에게 연결 요청 보내는 로직 구현 (예: Firestore에 connectionRequests 문서 생성)
                console.log(`자녀 계정(${childEmailToLink}) 연결 요청 로직 필요`);
                alert(`${childEmailToLink}로 연결 요청을 보냈습니다. 자녀가 수락하면 연결됩니다. (기능 구현 필요)`);
                // 이 단계에서는 실제 연결 없이, 정보만 저장하고 넘어갈 수 있음
            }
            // 자녀 계정 연결 시도 후 (또는 입력 안 함) 최종 시작 단계로
            showStep(steps.finalStart);
        };

        if(skipChildLinkBtn) skipChildLinkBtn.onclick = () => {
            // 자녀 계정 연결 건너뛰고 최종 시작 단계로
            if(childLinkEmailInput) childLinkEmailInput.value = ''; // 입력값 초기화
            showStep(steps.finalStart);
        };


        // --- 페이지 로드 시 초기화 ---
        // onAuthStateChanged는 DOMContentLoaded 밖에 배치하여 즉시 실행
        onAuthStateChanged(firebaseAuth, async (user) => {
            if (user) {
                console.log("Index: Firebase Auth 기존 사용자 감지. UID:", user.uid);
                currentUserId = user.uid;
                localStorage.setItem('lozee_userId', currentUserId);

                // (선택적) Firestore에서 사용자 프로필 정보 가져오기
                const userRef = doc(db, "users", currentUserId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().name && userSnap.data().userType) { // 필수 정보가 있다면
                    const userData = userSnap.data();
                    // localStorage에 필요한 정보 채우기
                    localStorage.setItem('lozee_username', userData.name);
                    localStorage.setItem('lozee_role', userData.role || (userData.userType === 'caregiver' ? 'parent' : 'child'));
                    localStorage.setItem('lozee_userType', userData.userType);

                    if (userData.userType === 'caregiver' && userData.caregiverInfo) {
                        localStorage.setItem('lozee_userAge', String(userData.caregiverInfo.childAge || '0')); // 대화 맥락 나이
                        localStorage.setItem('lozee_childName', userData.caregiverInfo.childName || '아이');
                        localStorage.setItem('lozee_diagnoses', JSON.stringify(userData.caregiverInfo.childDiagnoses || []));
                        localStorage.setItem('lozee_parentIsND', JSON.stringify(userData.caregiverInfo.caregiverNeurodiversity?.length > 0 && !userData.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')));
                        localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(userData.caregiverInfo.caregiverNeurodiversity || []));
                        if (userData.caregiverInfo.childLozeeUid) {
                             localStorage.setItem('lozee_childId', userData.caregiverInfo.childLozeeUid);
                        }
                    } else { // directUser
                        localStorage.setItem('lozee_userAge', String(userData.age || '0')); // 대화 맥락 나이
                        localStorage.setItem('lozee_diagnoses', JSON.stringify(userData.diagnoses || []));
                    }

                    console.log("Index: 기존 사용자 정보 로드 완료. talk.html로 이동합니다.");
                    window.location.href = 'talk.html'; // 모든 정보 있으면 바로 대화 시작
                    return;
                }
                // 프로필 정보가 부족하면 첫 단계부터 시작
                showStep(steps.userType);
            } else {
                console.log("Index: Firebase Auth 세션 없음. 익명 로그인 시도.");
                try {
                    const userCredential = await signInAnonymously(firebaseAuth);
                    const newUser = userCredential.user;
                    console.log('Index: 새로운 익명 사용자 UID 생성 및 저장:', newUser.uid);
                    currentUserId = newUser.uid;
                    localStorage.setItem('lozee_userId', currentUserId);
                    showStep(steps.userType); // UID 생성 후 첫 단계 표시
                } catch (error) {
                    console.error("Index: 익명 로그인 실패:", error.code, error.message);
                    let userMessage = "사용자 세션을 시작하는 데 실패했습니다. 인터넷 연결을 확인하고 페이지를 새로고침 해주세요.";
                    if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/admin-restricted-operation' || error.code === 'auth/configuration-not-found') {
                        userMessage += "\n(익명 로그인이 Firebase 프로젝트에서 활성화되지 않았거나, Firebase 설정에 문제가 있을 수 있습니다.)";
                    }
                    document.body.innerHTML = `<div class='container' style="background: none; color: #333;"><h1>서비스 접속 오류</h1><p>${userMessage.replace(/\n/g, '<br>')}</p><button onclick="window.location.reload()">새로고침</button></div>`;
                }
            }
        });

    </script>
</body>
</html>