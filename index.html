<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        button:disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
        .select-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-bottom: 12px; }
        .select-row select { width: calc(33% - 6px); }
        
        #stepUserType h2 { font-size: 2em; margin-bottom: 40px; }
        .user-type-options { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; max-width: 700px; }
        .user-type-btn { flex: 1; padding: 25px 20px; font-size: 1.2em; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.4; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; }
        .btn-subtitle { font-size: 0.8em; font-weight: normal; color: #7b8dda; margin-top: 8px; }
        .user-type-btn:hover { background: #fff; transform: translateY(-1px); }

        .diagnosis-options { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; max-height: 60vh; overflow-y: auto; padding: 0 10px;}
        .diagnosis-btn, .caregiver-nd-btn { display: block; width: 85%; max-width: 480px; margin-bottom: 10px; padding: 12px; font-size: 1em; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .diagnosis-btn:hover, .caregiver-nd-btn:hover { background: #fff; }
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { background-color: #FFEB3B; color: #333; border-color: #FBC02D; font-weight:bold;}
        .optional-text { font-size: 0.8em; color: #e0e0e0; font-weight: normal; }
        
        .secondary-btn { background: #78909c; color: white; margin-top: 10px; }
        .secondary-btn:hover { background: #607d8b; }

        .input-group { margin-bottom: 20px; width: 85%; max-width: 350px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 1em; color: #f0f0f0; text-align: left; }
        .input-group input, .input-group .select-row { width: 100%; margin-bottom: 0; }

        @media (max-width: 600px) { 
            h2 { font-size: 1.6em; margin-bottom: 15px;} 
            p, .info-text { font-size: 0.95em; margin-bottom:10px;} 
            button { font-size: 0.9em; padding: 12px 20px; margin-top: 15px;} 
            input, select { padding: 10px; margin-bottom:10px; font-size: 0.95em;}
            .select-row {max-width:100%;}

            #stepUserType h2 { font-size: 1.7em; margin-bottom: 25px; }
            .user-type-options { flex-direction: column; gap: 15px; }
            .user-type-btn { width: 90%; min-height: auto; padding: 18px; font-size: 1.05em; }
            .diagnosis-btn, .caregiver-nd-btn { max-width: 90%; font-size:0.95em; padding:10px; }
            .diagnosis-options {max-height: 50vh;}
            .input-group { width: 90%;}
        }
    </style>
</head>
<body class="step-background-main">
    <div id="stepUserType" class="step active">
        <h2>당신은 어디에 해당하시나요?</h2>
        <div class="user-type-options">
            <button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br><span class="btn-subtitle">(신경다양인 당사자)</span></button>
            <button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br><span class="btn-subtitle">(양육자, 배우자 등)</span></button>
        </div>
        <div class="error-message" id="userTypeError"></div>
    </div>

    <div id="stepCBT" class="step">
        <h2 id="cbtTitle">로지와 대화 시작하기</h2>
        <p id="cbtInfo">CBT 참여자 이메일 주소를 입력해주세요.</p>
        <input type="email" id="cbtCodeInput" placeholder="이메일 주소" />
        <div class="error-message" id="cbtCodeError"></div>
        <button id="submitCbtCodeBtn">다음</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step">
        <h2>보호자님에 대해서도 알려주시겠어요? <span class="optional-text">(선택 사항)</span></h2>
        <p>본인 또는 관계인(예: 배우자)께서 신경다양성 특성을 가지고 계시다면, 해당하는 항목을 모두 선택해주세요. <br>이는 로지가 더 깊이 공감하고 맞춤형 대화를 제공하는 데 도움이 됩니다.</p>
        <div class="diagnosis-options caregiver-nd-options">
            <button class="caregiver-nd-btn" data-nd="self_asd">저(보호자 본인)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="self_adhd">저(보호자 본인)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_asd">배우자(관계인)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_adhd">배우자(관계인)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="self_else">저(보호자 본인)에게 기타 신경다양성 특성이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_else">배우자(관계인)에게 기타 신경다양성 특성이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="unsure_or_none">잘 모르거나 해당 사항 없어요.</button>
        </div>
        <div class="error-message" id="caregiverNdError"></div>
        <button id="submitCaregiverNdBtn">다음 (또는 건너뛰기)</button>
    </div>

    <div id="stepDiagnosisType" class="step">
        <h2 id="diagnosisTitle">신경다양성 특성 이해하기</h2>
        <p id="diagnosisInfo">해당하는 항목을 모두 선택해주세요. (중복 선택 가능)</p>
        <div class="diagnosis-options">
            <button class="diagnosis-btn" data-diagnosis="ASD">자폐 스펙트럼 (ASD)</button>
            <button class="diagnosis-btn" data-diagnosis="ADHD">주의력 결핍 과잉행동 장애 (ADHD)</button>
            <button class="diagnosis-btn" data-diagnosis="Asperger">아스퍼거 증후군 (고기능 자폐)</button>
            <button class="diagnosis-btn" data-diagnosis="Tic">틱 장애</button>
            <button class="diagnosis-btn" data-diagnosis="LD">학습 장애</button>
            <button class="diagnosis-btn" data-diagnosis="Else">기타 어려움 또는 궁금증</button>
            <button class="diagnosis-btn" data-diagnosis="Unsure">아직 잘 모르겠어요 / 진단 없음</button>
            <button class="diagnosis-btn" data-diagnosis="NotApplicable">특별히 해당 없음</button> 
        </div>
        <div class="error-message" id="diagnosisError"></div>
        <button id="submitDiagnosisBtn">다음</button>
    </div>

    <div id="stepNameBirthSelf" class="step">
        <h2 id="nameBirthSelfTitle">정보 입력</h2>
        <div class="input-group">
            <label for="nameSelfInput" id="nameSelfPromptLabel">로지가 당신을 어떻게 부르면 좋을까요?</label>
            <input type="text" id="nameSelfInput" placeholder="이름 또는 별명" />
            <div class="error-message" id="nameSelfError"></div>
        </div>
        <div class="input-group">
            <label for="birthSelfYear" id="birthSelfPromptLabel">생년월일을 선택해주세요.</label>
            <div class="info-text" id="birthSelfInfoText">정확한 나이를 계산하여 더 적절한 대화 경험을 제공합니다.</div>
            <div class="select-row">
                <select id="birthSelfYear"><option value="">년</option></select>
                <select id="birthSelfMonth"><option value="">월</option></select>
                <select id="birthSelfDay"><option value="">일</option></select>
            </div>
            <div class="error-message" id="birthSelfError"></div>
        </div>
        <button id="submitNameBirthSelfBtn">다음</button>
    </div>
    
    <div id="stepNameBirthChild" class="step">
        <h2 id="nameBirthChildTitle">아이(또는 가족)의 정보를 알려주세요.</h2>
        <div class="input-group">
            <label for="nameChildInput" id="nameChildPromptLabel">로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?</label>
            <input type="text" id="nameChildInput" placeholder="아이(또는 가족) 이름 또는 별명" />
            <div class="error-message" id="nameChildError"></div>
        </div>
        <div class="input-group">
            <label for="birthChildYear" id="birthChildPromptLabel">아이(또는 가족)의 생년월일을 선택해주세요.</label>
            <div class="info-text" id="birthChildInfoText">정확한 나이를 계산하여 아이(또는 가족)에게 더 적절한 대화 경험을 제공합니다.</div>
            <div class="select-row">
                <select id="birthChildYear"><option value="">년</option></select>
                <select id="birthChildMonth"><option value="">월</option></select>
                <select id="birthChildDay"><option value="">일</option></select>
            </div>
            <div class="error-message" id="birthChildError"></div>
        </div>
        <button id="submitNameBirthChildBtn">다음</button>
    </div>

    <div id="stepChildEmail" class="step">
        <h2>아이/가족의 로지 계정 연결 <span class="optional-text">(선택 사항)</span></h2>
        <p>만약 아이(또는 가족)가 로지를 사용하고 있다면, 해당 계정의 로지 가입 이메일을 입력해주세요.<br>이를 통해 로지가 관련된 대화 내용을 참고하여 (상대방이 정보 공유에 동의한 경우에만) 보호자님께 더 도움이 되는 조언을 드릴 수 있습니다.</p>
        <p class="info-text" style="font-size: 0.85em; color: #ffeb3b;"><strong>[중요]</strong> 개인 정보 보호를 위해, 이 기능을 사용하려면 반드시 상대방의 동의가 필요하며, 로지는 상대방이 동의한 범위 내의 정보만을 참고합니다.</p>
        <input type="email" id="childLozeeEmailInput" placeholder="아이/가족의 로지 가입 이메일 (선택)" />
        <div class="error-message" id="childEmailError"></div>
        <button id="submitChildEmailBtn">저장 후 로지와 대화 시작하기</button>
        <button id="skipChildEmailBtn" class="secondary-btn">건너뛰고 대화 시작하기</button>
    </div>


  <script type="module">
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { db } from './js/firebase-config.js'; // db 인스턴스
        import { doc, setDoc, getDoc, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        // cbt.js는 현재 로직에서 직접 사용되지 않으므로 import 제거 또는 주석 처리
        // import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';


        const auth = getAuth();

        // --- DOM 요소 가져오기 ---
        // 각 단계별 div 요소
        const steps = {
            userType: document.getElementById('stepUserType'),
            caregiverNd: document.getElementById('stepCaregiverNeurodiversity'),
            diagnosisType: document.getElementById('stepDiagnosisType'),
            nameBirthSelf: document.getElementById('stepNameBirthSelf'),
            nameBirthChild: document.getElementById('stepNameBirthChild'),
            finalStart: document.getElementById('stepFinalStart') // 이전에 stepChildEmail이었던 것을 대체
        };

        // 각 단계별 버튼 및 입력 필드
        const userTypeButtons = document.querySelectorAll('.user-type-btn');

        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const caregiverNdError = document.getElementById('caregiverNdError');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');

        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');

        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');

        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');

        // 최종 시작 버튼 (HTML의 startLozeeConversationBtn ID와 일치해야 함)
        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn');

        // --- 상태 변수 ---
        let currentUserId = null; // Firebase Auth UID
        let selectedUserType = ''; // 'directUser' 또는 'caregiver'
        // 각 단계에서 입력받는 정보를 저장할 임시 변수들
        let tempCaregiverSelfName = '', tempCaregiverSelfBirthDate = null, tempCaregiverSelfAge = null;
        let tempChildName = '', tempChildBirthDate = null, tempChildAge = null;
        let tempDirectUserName = '', tempDirectUserBirthDate = null, tempDirectUserAge = null;
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = []; // 당사자 또는 자녀의 특성 저장용

        // --- 헬퍼 함수 ---
        function showStep(stepElement) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            if (stepElement) {
                stepElement.classList.add('active');
            } else {
                console.error("showStep: 표시할 stepElement가 유효하지 않거나 없습니다. HTML ID를 확인해주세요.");
                // 예: stepUserType이 가장 먼저 표시되어야 함
                if (steps.userType) steps.userType.classList.add('active');
            }
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) {
            if (!yearEl || !monthEl || !dayEl) {
                console.error("populateBirthSelects: 생년월일 select 요소를 찾을 수 없습니다.");
                return;
            }
            yearEl.innerHTML = '<option value="">년</option>';
            monthEl.innerHTML = '<option value="">월</option>';
            dayEl.innerHTML = '<option value="">일</option>';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - startYearOffset; y >= currentYear - endYearOffset; y--) {
                const opt = new Option(`${y}년`, y); yearEl.add(opt);
            }
            for (let m = 1; m <= 12; m++) {
                const opt = new Option(`${m}월`, m); monthEl.add(opt);
            }
            for (let d = 1; d <= 31; d++) {
                const opt = new Option(`${d}일`, d); dayEl.add(opt);
            }
        }

        function calculateAge(y, m, d) {
            if (!y || !m || !d) return null;
            try {
                const birth = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                if (isNaN(birth.getTime())) return null;
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age >= 0 ? age : null;
            } catch (e) {
                console.error("calculateAge 오류:", e);
                return null;
            }
        }

        async function saveUserProfileToFirestore(uid, profileData) {
            if (!uid || !profileData) {
                console.error("saveUserProfileToFirestore: UID 또는 프로필 데이터가 없습니다.");
                alert("사용자 정보를 저장하는 데 실패했습니다. 필수 정보가 누락되었습니다.");
                return false;
            }
            const userRef = doc(db, "users", uid);
            const dataToSave = {
                uid: uid,
                ...profileData,
                lastLogin: serverTimestamp()
            };

            try {
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    dataToSave.createdAt = serverTimestamp();
                    await setDoc(userRef, dataToSave);
                    console.log(`[saveUserProfileToFirestore] Firestore에 새 사용자 문서 생성: ${uid}`, dataToSave);
                } else {
                    await setDoc(userRef, dataToSave, { merge: true }); // 기존 정보에 병합/업데이트
                    console.log(`[saveUserProfileToFirestore] Firestore 사용자 문서 업데이트: ${uid}`, dataToSave);
                }
                return true;
            } catch (error) {
                console.error(`[saveUserProfileToFirestore] 사용자 문서 저장/업데이트 실패 (${uid}):`, error.message);
                alert("사용자 정보를 저장하는 데 실패했습니다. 인터넷 연결 및 Firestore 보안 규칙을 확인해주세요.\n오류: " + error.message);
                return false;
            }
        }

        // --- 이벤트 핸들러 ---
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                if (selectedUserType === 'caregiver') {
                    if (steps.caregiverNd) showStep(steps.caregiverNd);
                    else console.error("caregiverNd 스텝 요소를 찾을 수 없습니다.");
                } else { // directUser
                    if(diagnosisTitleEl) diagnosisTitleEl.textContent = "현재 어떤 어려움을 느끼고 있나요?";
                    if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 항목을 모두 선택해주세요. (중복 선택 가능)";
                    if (steps.diagnosisType) showStep(steps.diagnosisType);
                    else console.error("diagnosisType 스텝 요소를 찾을 수 없습니다.");
                }
            };
        });

        caregiverNdOptionBtns.forEach(button => {
            button.onclick = () => {
                const ndType = button.dataset.nd;
                if (ndType === 'unsure_or_none') {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected'); tempSelectedCaregiverNd = [];
                    } else {
                        caregiverNdOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); tempSelectedCaregiverNd = [ndType];
                    }
                } else {
                    document.querySelector('.caregiver-nd-btn[data-nd="unsure_or_none"]')?.classList.remove('selected');
                    tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== 'unsure_or_none');
                    button.classList.toggle('selected');
                    if (tempSelectedCaregiverNd.includes(ndType)) {
                        tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== ndType);
                    } else {
                        tempSelectedCaregiverNd.push(ndType);
                    }
                }
                if(caregiverNdError) caregiverNdError.textContent = '';
                console.log("선택된 보호자/배우자 신경다양성:", tempSelectedCaregiverNd);
            };
        });

        if(submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => {
            if(diagnosisTitleEl) diagnosisTitleEl.textContent = "아이(또는 가족)의 어떤 점에 대해 이야기 나누고 싶으세요?";
            if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 어려움을 모두 선택해주세요. (중복 선택 가능)";
            if(steps.diagnosisType) showStep(steps.diagnosisType);
            else console.error("diagnosisType 스텝 요소를 찾을 수 없습니다.");
        };

        diagnosisOptionBtns.forEach(button => {
            button.onclick = () => {
                const diagnosis = button.dataset.diagnosis;
                const isExclusive = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');
                if (isExclusive) {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected'); tempSelectedDiagnoses = [];
                    } else {
                        diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); tempSelectedDiagnoses = [diagnosis];
                    }
                } else {
                    document.querySelector('.diagnosis-btn[data-diagnosis="NotApplicable"]')?.classList.remove('selected');
                    document.querySelector('.diagnosis-btn[data-diagnosis="Unsure"]')?.classList.remove('selected');
                    tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');
                    button.classList.toggle('selected');
                    if (tempSelectedDiagnoses.includes(diagnosis)) {
                        tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== diagnosis);
                    } else {
                        tempSelectedDiagnoses.push(diagnosis);
                    }
                }
                if(diagnosisError) diagnosisError.textContent = '';
                console.log("선택된 진단/어려움 유형:", tempSelectedDiagnoses);
            };
        });

        if(submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => {
            if (tempSelectedDiagnoses.length === 0) {
                if(diagnosisError) diagnosisError.textContent = "하나 이상 선택해주세요."; return;
            }
            if(diagnosisError) diagnosisError.textContent = '';

            if (selectedUserType === 'caregiver') {
                if(nameBirthSelfTitleEl) nameBirthSelfTitleEl.textContent = "보호자님의 정보를 알려주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 18, 70);
            } else { // directUser
                if(nameBirthSelfTitleEl) nameBirthSelfTitleEl.textContent = "만나서 반가워요! 당신에 대해 알려주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90);
            }
            if(steps.nameBirthSelf) showStep(steps.nameBirthSelf);
            else console.error("nameBirthSelf 스텝 요소를 찾을 수 없습니다.");
        };

        if(submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            if (!name) { if(nameSelfError) nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.'; return; }
            if(nameSelfError) nameSelfError.textContent = '';
            if (!y || !m || !d) { if(birthSelfError) birthSelfError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            if(birthSelfError) birthSelfError.textContent = '';

            const age = calculateAge(y, m, d);
            if (age === null) { if(birthSelfError) birthSelfError.textContent = '유효한 생년월일을 입력해주세요.'; return; }
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                tempCaregiverSelfName = name;
                tempCaregiverSelfBirthDate = birthDate;
                tempCaregiverSelfAge = age;
                if(nameChildInput) nameChildInput.value = ''; // 자녀 이름 입력 필드 초기화
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18);
                if(steps.nameBirthChild) showStep(steps.nameBirthChild);
                else console.error("nameBirthChild 스텝 요소를 찾을 수 없습니다.");
            } else { // directUser
                tempDirectUserName = name;
                tempDirectUserBirthDate = birthDate;
                tempDirectUserAge = age;
                if(steps.finalStart) showStep(steps.finalStart);
                else console.error("finalStart 스텝 요소를 찾을 수 없습니다.");
            }
        };

        if(submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
            if (!name) { if(nameChildError) nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.'; return; }
            if(nameChildError) nameChildError.textContent = '';
            if (!y || !m || !d) { if(birthChildError) birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.'; return; }
            if(birthChildError) birthChildError.textContent = '';

            const age = calculateAge(y, m, d);
            if (age === null) { if(birthChildError) birthChildError.textContent = '유효한 생년월일을 입력해주세요.'; return; }
            tempChildName = name;
            tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            tempChildAge = age;
            if(steps.finalStart) showStep(steps.finalStart); // 자녀 정보 입력 후 최종 시작 단계로
            else console.error("finalStart 스텝 요소를 찾을 수 없습니다.");
        };

        // "로지와 대화 시작하기" 버튼 최종 로직
        if(startLozeeConversationBtn) startLozeeConversationBtn.onclick = async () => {
            if (!currentUserId) {
                alert("사용자 세션 정보를 가져오는 중입니다. 잠시 후 다시 시도하거나 페이지를 새로고침 해주세요.");
                return;
            }

            let finalProfileData = {
                role: selectedUserType === 'caregiver' ? 'parent' : 'child',
                userType: selectedUserType,
                name: selectedUserType === 'caregiver' ? tempCaregiverSelfName : tempDirectUserName,
                birthDate: selectedUserType === 'caregiver' ? tempCaregiverSelfBirthDate : tempDirectUserBirthDate,
                age: selectedUserType === 'caregiver' ? tempCaregiverSelfAge : tempDirectUserAge,
                // Firestore에 저장될 사용자의 실제 이메일 (Firebase Auth에서 가져오는 것이 이상적)
                // email: firebaseAuth.currentUser ? firebaseAuth.currentUser.email : null // 익명 사용자는 null
            };

            let finalUserNameForTalk = finalProfileData.name;
            let finalAgeForTalkContext = finalProfileData.age;

            if (selectedUserType === 'caregiver') {
                finalProfileData.caregiverInfo = {
                    caregiverNeurodiversity: tempSelectedCaregiverNd,
                    childName: tempChildName,
                    childBirthDate: tempChildBirthDate,
                    childAge: tempChildAge,
                    childDiagnoses: tempSelectedDiagnoses
                    // childLozeeUid: null, // 초기에는 null, 추후 연결 기능에서 설정
                };
                finalProfileData.diagnoses = []; // 보호자 본인 특성은 caregiverInfo.caregiverNeurodiversity로
                finalAgeForTalkContext = tempChildAge; // 대화 맥락 나이 = 자녀 나이
            } else { // directUser
                finalProfileData.diagnoses = tempSelectedDiagnoses;
            }

            const saveSuccess = await saveUserProfileToFirestore(currentUserId, finalProfileData);
            if (!saveSuccess) {
                return; // Firestore 저장 실패 시 진행 중단
            }

            // localStorage 업데이트 (talk.html 등에서 사용할 정보)
            localStorage.setItem('lozee_userId', currentUserId);
            localStorage.setItem('lozee_username', finalUserNameForTalk);
            localStorage.setItem('lozee_userAge', finalAgeForTalkContext !== null ? finalAgeForTalkContext.toString() : '0');
            localStorage.setItem('lozee_role', finalProfileData.role);
            localStorage.setItem('lozee_userType', finalProfileData.userType);

            if (selectedUserType === 'caregiver') {
                localStorage.setItem('lozee_childName', tempChildName);
                localStorage.setItem('lozee_childAge', tempChildAge !== null ? tempChildAge.toString() : '0');
                localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses)); // 자녀 특성
                localStorage.setItem('lozee_parentIsND', JSON.stringify(tempSelectedCaregiverNd.length > 0 && !tempSelectedCaregiverNd.includes('unsure_or_none')));
                localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(tempSelectedCaregiverNd));
            } else { // directUser
                localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses)); // 본인 특성
                localStorage.removeItem('lozee_childName');
                localStorage.removeItem('lozee_childAge');
                localStorage.removeItem('lozee_parentIsND');
                localStorage.removeItem('lozee_childId'); // 자녀 UID도 제거
                localStorage.removeItem('lozee_caregiver_neurodiversity');
            }
            window.location.href = 'talk.html';
        };

        // --- 페이지 로드 시 실행 (단일 DOMContentLoaded 리스너) ---
        // 위에서 선언한 DOMContentLoaded 리스너와 중복되므로, 아래 코드는 그 안으로 통합하거나,
        // onAuthStateChanged 로직을 DOMContentLoaded *밖으로* 빼서 즉시 실행하도록 수정합니다.
        // 여기서는 onAuthStateChanged를 DOMContentLoaded 밖으로 빼겠습니다.

    // ⭐ 이전에 중복되었던 DOMContentLoaded의 닫는 부분 삭제

    // 페이지 로드 시 Firebase Auth 상태 감지 및 UID 처리 (DOMContentLoaded 밖에서 즉시 실행)
    onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
            console.log("Index: Firebase Auth 기존 사용자 감지. UID:", user.uid);
            currentUserId = user.uid;
            localStorage.setItem('lozee_userId', currentUserId);

            // (선택적) Firestore에서 기존 사용자 정보 로드하여 UI에 미리 채우거나,
            // 특정 단계로 바로 보내는 로직 추가 가능.
            // 지금은 첫 단계(사용자 유형 선택)부터 시작하도록 함.
            if (steps.userType) showStep(steps.userType);
            else console.error("초기 단계(stepUserType) 요소를 찾을 수 없습니다.");

        } else {
            console.log("Index: Firebase Auth 세션 없음. 익명 로그인 시도.");
            try {
                const userCredential = await signInAnonymously(firebaseAuth);
                const newUser = userCredential.user;
                console.log('Index: 새로운 익명 사용자 UID 생성 및 저장:', newUser.uid);
                currentUserId = newUser.uid;
                localStorage.setItem('lozee_userId', currentUserId);
                // 익명 로그인 성공 후, users 문서가 없다면 마지막 단계에서 생성됨.
                if (steps.userType) showStep(steps.userType);
                 else console.error("초기 단계(stepUserType) 요소를 찾을 수 없습니다.");
            } catch (error) {
                console.error("Index: 익명 로그인 실패:", error.code, error.message);
                let userMessage = "사용자 세션을 시작하는 데 실패했습니다. 인터넷 연결을 확인하고 페이지를 새로고침 해주세요.";
                if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/admin-restricted-operation' || error.code === 'auth/configuration-not-found') {
                    userMessage += "\n(익명 로그인이 Firebase 프로젝트에서 활성화되지 않았거나, Firebase 설정에 문제가 있을 수 있습니다.)";
                }
                // 사용자에게 오류 메시지를 표시할 수 있는 DOM 요소가 있다면 거기에 표시
                // 여기서는 body에 직접 삽입 (임시)
                document.body.innerHTML = `<div class='container' style="background: none; color: #333;"><h1>서비스 접속 오류</h1><p>${userMessage.replace(/\n/g, '<br>')}</p><button onclick="window.location.reload()">새로고침</button></div>`;
            }
        }
    });
    </script>
</body>
</html>