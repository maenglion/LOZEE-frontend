<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 스타일 */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'KoPub World Dotum', sans-serif;
            color: #333;
            height: 100%;
            overflow: hidden;
        }

        .step {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            color: white;
        }

        .step.active {
            display: flex;
        }

        .step-background-main {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
        }
        .step-background-main input,
        .step-background-main select,
        .step-background-main textarea {
            color: #333;
        }
        .step-background-main .error-message {
            color: #ffdddd;
        }
        .step-background-main .info-text {
            color: #e0e0e0;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        p {
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        input[type="text"],
        select,
        textarea {
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 85%;
            max-width: 350px;
            box-sizing: border-box;
            font-size: 1em;
        }

        textarea {
            height: 120px;
            resize: none;
        }

        button {
            padding: 12px 25px;
            background-color: #ffffff;
            color: #6e8efb;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            margin-top: 15px;
            font-weight: bold;
            font-size: 1em;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0px);
        }

        button:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .error-message {
            color: #ffdddd;
            font-size: 0.9em;
            min-height: 1.2em;
            margin-top: -5px;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .topic-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            max-width: 400px;
        }

        .topic-options button, button.secondary-button {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.95em;
        }

        .topic-options button.selected, .topic-options button:hover, button.secondary-button:hover {
            background-color: white;
            color: #6e8efb;
            border-color: white;
        }
        
        button.secondary-button { /* "해당사항 없음" 버튼 스타일 */
            margin-top: 5px;
            background-color: transparent;
            border: 1px solid white;
        }
        button.secondary-button.hidden { /* "해당사항 없음" 버튼 숨김 처리 */
            display: none;
        }


        .loading-indicator {
            display: none;
            font-size: 0.9em;
            margin-top: 5px;
            color: white;
        }
        
        #customTopicContainer {
            background-color: rgba(0,0,0,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        #customTopicContainer p {
            font-size: 1em;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            h2 { font-size: 1.5em; }
            p { font-size: 1em; }
            input[type="text"],
            select,
            textarea {
                width: 90%;
                padding: 10px;
            }
            button { padding: 10px 20px; font-size: 0.95em;}
            .topic-options button, button.secondary-button {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body id="introBody" class="step-background-main"> 
    <div id="stepCBT" class="step">
        <h2>로지와 대화 시작하기</h2>
        <p>CBT 코드를 입력해주세요.</p>
        <input type="text" id="cbtCodeInput" placeholder="CBT 코드">
        <div class="error-message" id="cbtCodeError"></div>
        <button id="submitCbtCodeBtn">다음</button>
    </div>

    <div id="stepName" class="step">
        <h2>만나서 반가워요!</h2>
        <p>로지가 당신을 어떻게 부르면 좋을까요?</p>
        <input type="text" id="nameInput" placeholder="이름 또는 별명">
        <div class="error-message" id="nameError"></div>
        <button id="submitNameBtn">다음</button>
    </div>
    
    <div id="stepAge" class="step">
        <h2>나이를 알려주세요.</h2>
        <p class="info-text">로지와 깊이 있는 대화를 나누기 위해서는 나이 정보가 중요해요.<br>실제 나이를 선택해주세요.</p>
        <select id="ageSelectInput">
            <option value="">나이를 선택해주세요</option>
        </select>
        <div class="error-message" id="ageError"></div>
        <button id="submitAgeBtn">다음</button>
    </div>

    <div id="stepTopic" class="step">
        <h2>어떤 이야기를 나누고 싶으세요?</h2>
        <p><span id="topicUserAgeInfo"></span> 사용자를 위한 추천 주제입니다.<br>원하시는 주제를 선택해주세요.</p>
        <div id="topicSelection" class="topic-options">
        </div>
        <button id="noTopicBtn" class="secondary-button">해당사항 없음</button>
        <div id="customTopicContainer" style="display: none; width: 85%; max-width: 350px;">
            <p>어떤 주제로 이야기하고 싶으신지 직접 입력해주세요:</p>
            <textarea id="customTopicInput" placeholder="예: 최근에 겪은 일, 고민거리 등"></textarea>
            <div class="error-message" id="customTopicError"></div>
            <button id="submitCustomTopicBtn">이 주제로 시작</button>
        </div>
        <div class="error-message" id="topicOverallError"></div>
    </div>

    <div id="stepVoice" class="step">
        <h2>로지의 목소리를 선택해주세요.</h2>
        <p>선택한 목소리로 로지가 말을 걸어줄 거예요.</p>
        <select id="voiceSelectInput">
            <option value="">목소리 선택</option>
            <option value="ko-KR-Chirp3-HD-Vindemiatrix">Nova (여성 차분)</option>
            <option value="ko-KR-Chirp3-HD-Rasalgethi">Alloy (남성 차분)</option>
            <option value="ko-KR-Chirp3-HD-Leda">Echo (남성 활기참)</option> 
            <option value="ko-KR-Chirp3-HD-Sadachbia">Fable (여성 부드러움)</option> 
            <option value="ko-KR-Chirp3-HD-Kore">Onyx (남성 깊음)</option> 
            <option value="ko-KR-Chirp3-HD-Schedar">Shimmer (여성 밝음)</option> 
        </select>
        <button id="testVoiceBtn">목소리 미리 듣기</button>
        <div class="loading-indicator" id="ttsLoadingIndicator">음성 재생 중...</div>
        <div class="error-message" id="voiceError"></div>
        <button id="submitVoiceBtn">다음</button>
    </div>

    <div id="stepStart" class="step">
        <h2><span id="finalStepGreetingName">친구</span>님, 준비되셨나요?</h2>
        <p><span id="finalStepTopicInfo">선택하신 주제</span>에 대해<br>로지와 이야기를 시작합니다.</p>
        <button id="confirmStartChatBtn">로지와 대화 시작하기</button>
    </div>

    <script type="module">
        let counselingTopicsByAge;
        let counselingTopicsLoaded = false;
        let playTTSFromText;

        const introBody = document.getElementById('introBody');
        const stepCBT = document.getElementById('stepCBT');
        const stepName = document.getElementById('stepName'); // 이름 스텝
        const stepAge = document.getElementById('stepAge');   // 나이 스텝
        const stepTopic = document.getElementById('stepTopic');
        const stepVoice = document.getElementById('stepVoice');
        const stepStart = document.getElementById('stepStart');
        // 스텝 배열 순서 변경: 이름, 나이 분리
        const steps = [stepCBT, stepName, stepAge, stepTopic, stepVoice, stepStart];

        const cbtCodeInput = document.getElementById('cbtCodeInput');
        const cbtCodeError = document.getElementById('cbtCodeError');
        const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');

        const nameInput = document.getElementById('nameInput');
        const nameError = document.getElementById('nameError');
        const submitNameBtn = document.getElementById('submitNameBtn'); // 이름 제출 버튼

        const ageSelectInput = document.getElementById('ageSelectInput'); 
        const ageError = document.getElementById('ageError');
        const submitAgeBtn = document.getElementById('submitAgeBtn'); // 나이 제출 버튼

        const topicUserAgeInfo = document.getElementById('topicUserAgeInfo');
        const topicSelection = document.getElementById('topicSelection');
        const noTopicBtn = document.getElementById('noTopicBtn');
        const customTopicContainer = document.getElementById('customTopicContainer');
        const customTopicInput = document.getElementById('customTopicInput');
        const customTopicError = document.getElementById('customTopicError');
        const submitCustomTopicBtn = document.getElementById('submitCustomTopicBtn');
        const topicOverallError = document.getElementById('topicOverallError');

        const voiceSelectInput = document.getElementById('voiceSelectInput');
        const testVoiceBtn = document.getElementById('testVoiceBtn');
        const ttsLoadingIndicator = document.getElementById('ttsLoadingIndicator');
        const voiceError = document.getElementById('voiceError');
        const submitVoiceBtn = document.getElementById('submitVoiceBtn');

        const finalStepGreetingName = document.getElementById('finalStepGreetingName');
        const finalStepTopicInfo = document.getElementById('finalStepTopicInfo');
        const confirmStartChatBtn = document.getElementById('confirmStartChatBtn');

        let currentStep = 0;

        async function initializeApp() {
            try {
                const ttsModule = await import('./js/tts.js'); 
                playTTSFromText = ttsModule.playTTSFromText;
                if (typeof playTTSFromText !== 'function') {
                    console.error("Error: playTTSFromText is not a function in tts.js. Using mock TTS.");
                    throw new Error("playTTSFromText not a function in tts.js");
                }
                console.log("TTS module loaded successfully.");
            } catch (e) {
                console.warn("Failed to load ./js/tts.js module or it's invalid. Using mock TTS. Error:", e.message, e.stack);
                playTTSFromText = async (text, voice) => { 
                    console.log(`TTS Mock: "${text}" (목소리: ${voice})`);
                    alert(`(TTS Mock) 음성 재생 시도: ${text}`); 
                    return new Promise(resolve => setTimeout(resolve, 1000));
                };
                if(voiceError) voiceError.textContent = "음성 서비스를 불러오지 못했습니다. 목소리 테스트가 제한됩니다.";
            }
            populateAgeOptions();
            if (localStorage.getItem('lozee_onboarding_complete') === 'true') {
                showStep(0); 
            } else {
                showStep(0);
            }
        }

        async function loadCounselingTopics() {
            if (counselingTopicsLoaded) return; 
            try {
                // 파일 경로를 절대 경로 또는 Netlify 환경에 맞게 수정 시도
                // 예: const topicsModule = await import('/js/counseling_topics.js'); 
                // 또는 Netlify 함수를 통해 가져오는 방법도 고려할 수 있습니다.
                // 현재는 상대 경로 유지
                const topicsModule = await import('./js/counseling_topics.js');
                counselingTopicsByAge = topicsModule.counselingTopicsByAge;
                if (!counselingTopicsByAge || Object.keys(counselingTopicsByAge).length === 0) {
                    console.error("Error: counselingTopicsByAge is not defined or empty in counseling_topics.js. Using fallback.");
                    throw new Error("Counseling topics data is invalid."); 
                }
                counselingTopicsLoaded = true;
                console.log("Counseling topics loaded successfully from ./js/counseling_topics.js");
            } catch (e) {
                console.error("Failed to load ./js/counseling_topics.js. Error:", e.message, "\nStack:", e.stack);
                counselingTopicsByAge = {
                    '8-10': ['친구랑 싸웠어', '공부하기 싫어', '기타 고민(직접 입력)'],
                    '12-15': ['학교 성적이 고민이야', '내 미래가 걱정돼', '기타 고민(직접 입력)'],
                    '30+': ['스트레스', '번아웃', '워라밸', '기타 고민(직접 입력)']
                };
                counselingTopicsLoaded = true; 
                if(topicOverallError) topicOverallError.textContent = "주제 목록을 불러오지 못했습니다. 기본 목록이 표시됩니다.";
            }
        }

        function getTopicsForAge(age) {
            if (!counselingTopicsLoaded || !counselingTopicsByAge) {
                console.warn("getTopicsForAge: Counseling topics not loaded yet or invalid.");
                return ['주제 로딩 중...']; 
            }
            const ageInt = parseInt(age);
            let key;
            if (isNaN(ageInt)) { key = '30+'; }
            else if (ageInt >= 8 && ageInt <= 10) { key = '8-10'; }
            else if (ageInt >= 11 && ageInt <= 15) { key = '12-15'; } // 11세도 12-15 그룹으로 포함
            else if (ageInt >= 16) { key = '30+'; }
            else { return []; }
            return counselingTopicsByAge[key] || [];
        }
        
        function populateAgeOptions() {
            if (!ageSelectInput) return;
            while (ageSelectInput.options.length > 1) {
                ageSelectInput.remove(1);
            }
            for (let i = 8; i <= 100; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}세`;
                ageSelectInput.appendChild(option);
            }
        }
        
        async function showStep(stepIndex) { 
            steps.forEach((step, index) => {
                if (step) {
                    step.classList.toggle('active', index === stepIndex);
                }
            });
            currentStep = stepIndex;

            // 이름/나이 다음이 주제 선택 (인덱스 3)
            if (stepIndex === 3) { // 주제 선택 스텝 (0:CBT, 1:이름, 2:나이, 3:주제)
                await loadCounselingTopics(); 
                populateTopicOptions(); 
                const userAge = localStorage.getItem('lozee_userAge');
                if(topicUserAgeInfo && userAge) {
                    topicUserAgeInfo.textContent = `만 ${userAge}세`;
                } else if (topicUserAgeInfo) {
                    topicUserAgeInfo.textContent = ""; // 나이 정보 없으면 비움
                }
                customTopicContainer.style.display = 'none';
                customTopicInput.value = '';
                topicOverallError.textContent = '';
            }
            // 목소리 선택 다음이 최종 시작 (인덱스 5)
            if (stepIndex === 5) { // 최종 시작 스텝
                const currentUsername = localStorage.getItem('lozee_username') || '친구';
                if (finalStepGreetingName) finalStepGreetingName.textContent = currentUsername;
                const selectedTopicText = localStorage.getItem('lozee_selectedTopic') || '선택된 주제 없음';
                if (finalStepTopicInfo) finalStepTopicInfo.textContent = `"${selectedTopicText}"`;
            }
        }
        
        // Step 0: CBT 코드 처리
        submitCbtCodeBtn.addEventListener('click', () => {
            const cbtCode = cbtCodeInput.value.trim();
            cbtCodeError.textContent = '';
            if (!cbtCode) {
                cbtCodeError.textContent = 'CBT 코드를 입력해주세요.';
                return;
            }
            localStorage.setItem('lozee_cbtCode', cbtCode);
            showStep(1); // 이름 입력으로 이동
        });

        // Step 1: 이름 처리
        submitNameBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            nameError.textContent = '';
            if (!name) {
                nameError.textContent = '이름 또는 별명을 입력해주세요.';
                return;
            }
            localStorage.setItem('lozee_username', name);
            showStep(2); // 나이 입력으로 이동
        });

        // Step 2: 나이 처리
        submitAgeBtn.addEventListener('click', () => {
            const age = ageSelectInput.value; 
            ageError.textContent = '';
            if (!age) { 
                ageError.textContent = '나이를 선택해주세요.';
                return;
            }
            localStorage.setItem('lozee_userAge', age);
            showStep(3); // 주제 선택으로 이동
        });
        
        function populateTopicOptions() {
            if (!counselingTopicsLoaded) {
                topicSelection.innerHTML = '<p class="info-text">주제를 불러오는 중입니다...</p>';
                return;
            }

            const userAge = localStorage.getItem('lozee_userAge');
            let topics = getTopicsForAge(userAge);
            
            // "기타 고민(직접 입력)"과 유사한 문자열을 감지하는 정규식
            const customInputRegex = /기타.*직접\s?입력/;
            let hasCustomInputOption = false;

            topicSelection.innerHTML = ''; 
            
            topics.forEach(topicText => { 
                const button = document.createElement('button');
                button.textContent = topicText;

                if (customInputRegex.test(topicText)) {
                    hasCustomInputOption = true;
                    button.addEventListener('click', () => {
                        // "기타 고민(직접 입력)" 버튼 클릭 시
                        topicSelection.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); // 해당 버튼도 선택된 것처럼 표시 (선택사항)
                        customTopicContainer.style.display = 'block';
                        customTopicInput.value = ''; // 입력창 초기화
                        customTopicInput.focus();
                        topicOverallError.textContent = '';
                        // localStorage에는 아직 저장하지 않음. 사용자가 입력 후 '이 주제로 시작' 눌렀을 때 저장.
                    });
                } else {
                    button.addEventListener('click', () => {
                        topicSelection.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        customTopicContainer.style.display = 'none';
                        customTopicInput.value = '';
                        customTopicError.textContent = '';
                        topicOverallError.textContent = '';
                        localStorage.setItem('lozee_selectedTopic', topicText); 
                        showStep(4); // 목소리 선택으로 이동 (인덱스 4)
                    });
                }
                topicSelection.appendChild(button);
            });

            // "기타 고민(직접 입력)" 옵션이 주제 목록에 있으면 "해당사항 없음" 버튼 숨기기
            if (noTopicBtn) {
                noTopicBtn.classList.toggle('hidden', hasCustomInputOption);
            }

            if (topics.length === 0 && !hasCustomInputOption && customTopicContainer.style.display === 'none') {
                 topicOverallError.textContent = '추천드릴 주제가 없네요. "해당사항 없음"을 눌러 직접 입력해주세요.';
            } else if (topics.length === 0 && !hasCustomInputOption) {
                 topicOverallError.textContent = '"해당사항 없음"을 눌러 직접 입력해주세요.';
            }
             else {
                topicOverallError.textContent = '';
            }
        }

        // "해당사항 없음" 버튼 클릭 (이 버튼은 "기타 고민(직접 입력)"이 없을 때만 보임)
        noTopicBtn.addEventListener('click', () => {
            customTopicContainer.style.display = 'block';
            topicSelection.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            topicOverallError.textContent = '';
            customTopicInput.value = ''; // 입력창 초기화
            customTopicInput.focus();
        });

        // 사용자가 직접 입력한 주제 제출
        submitCustomTopicBtn.addEventListener('click', () => {
            const customTopic = customTopicInput.value.trim();
            customTopicError.textContent = '';
            if (!customTopic) {
                customTopicError.textContent = '주제를 입력해주세요.';
                return;
            }
            localStorage.setItem('lozee_selectedTopic', customTopic); 
            showStep(4); // 목소리 선택으로 이동 (인덱스 4)
        });

        // Step 4: 목소리 선택 및 다음 스텝 이동
        submitVoiceBtn.addEventListener('click', () => {
            const voice = voiceSelectInput.value;
            voiceError.textContent = '';
            if (!voice) {
                voiceError.textContent = '로지의 목소리를 선택해주세요.';
                return;
            }
            localStorage.setItem('lozee_selectedVoice', voice);
            showStep(5); // 최종 시작 단계로 이동 (인덱스 5)
        });

        testVoiceBtn.addEventListener('click', async () => {
            const selectedVoice = voiceSelectInput.value;
            voiceError.textContent = ''; 
            if (!selectedVoice) {
                voiceError.textContent = '목소리를 먼저 선택해주세요.';
                return;
            }
            if (typeof playTTSFromText !== 'function') {
                voiceError.textContent = '음성 재생 기능을 사용할 수 없습니다. (로드 실패)';
                console.error("playTTSFromText is not available or not a function.");
                return;
            }

            try {
                ttsLoadingIndicator.style.display = 'block';
                testVoiceBtn.disabled = true;
                await playTTSFromText('안녕하세요, 저는 로지예요. 만나서 반가워요.', selectedVoice);
            } catch (error) {
                console.error("TTS Error during testVoiceBtn click:", error);
                const errorMessage = error && error.message ? error.message : "알 수 없는 오류 발생";
                voiceError.textContent = `음성 재생 중 오류: ${errorMessage}. 백엔드 또는 tts.js 설정을 확인해주세요.`;
            } finally {
                ttsLoadingIndicator.style.display = 'none';
                testVoiceBtn.disabled = false;
            }
        });

        // Step 5: 로지 대화 시작 (페이지 이동)
        confirmStartChatBtn.addEventListener('click', () => {
            if (!localStorage.getItem('lozee_selectedTopic') || !localStorage.getItem('lozee_selectedVoice')) {
                alert("필수 정보(주제, 목소리)가 선택되지 않았습니다. 이전 단계로 돌아가 선택해주세요.");
                // 주제 없으면 주제(3)로, 목소리 없으면 목소리(4)로
                showStep(localStorage.getItem('lozee_selectedTopic') ? 4 : 3); 
                return;
            }
            localStorage.setItem('lozee_onboarding_complete', 'true');
            window.location.href = 'talk.html';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeApp(); 
            } catch (e) {
                console.error("Error during application initialization:", e.message, e.stack);
                if(steps[0] && cbtCodeError) { 
                    steps[0].classList.add('active'); 
                    cbtCodeError.textContent = "페이지 초기화 중 오류가 발생했습니다. 새로고침 해보세요.";
                } else if (steps[0]) { 
                     steps[0].classList.add('active');
                     steps[0].innerHTML = "<h2>오류 발생</h2><p>페이지 초기화 중 문제가 발생했습니다.</p>" + (steps[0].innerHTML || ""); 
                }
            }
        });
    </script>
</body>
</html>
