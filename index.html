<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        .select-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-bottom: 12px; }
        .select-row select { width: calc(33% - 6px); }
        
        #stepUserType h2 { font-size: 2em; margin-bottom: 40px; }
        .user-type-options { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; max-width: 700px; }
        .user-type-btn { flex: 1; padding: 25px 20px; font-size: 1.2em; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.4; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; }
        .btn-subtitle { font-size: 0.8em; font-weight: normal; color: #7b8dda; margin-top: 8px; }
        .user-type-btn:hover { background: #fff; transform: translateY(-1px); }

        .diagnosis-options { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; max-height: 60vh; overflow-y: auto; padding: 0 10px;}
        .diagnosis-btn, .caregiver-nd-btn { display: block; width: 85%; max-width: 480px; margin-bottom: 10px; padding: 12px; font-size: 1em; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .diagnosis-btn:hover, .caregiver-nd-btn:hover { background: #fff; }
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { background-color: #6e8efb; color: white; border-color: #6e8efb; }
        .optional-text { font-size: 0.8em; color: #e0e0e0; font-weight: normal; }
        
        .secondary-btn { background: #78909c; color: white; margin-top: 10px; }
        .secondary-btn:hover { background: #607d8b; }

        .input-group { margin-bottom: 20px; width: 85%; max-width: 350px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 1em; color: #f0f0f0; text-align: left; }
        .input-group input, .input-group .select-row { width: 100%; margin-bottom: 0; }


        /* index.html <style> 태그 내 수정 */
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { 
            background-color: #FFEB3B; /* 노란색 계열 (예시) */
            color: #333; /* 노란 배경에 어울리는 글자색 */
            border-color: #FBC02D; /* 노란색 계열 테두리 */
            font-weight: bold;
        }

        @media (max-width: 600px) { 
            h2 { font-size: 1.6em; margin-bottom: 15px;} 
            p, .info-text { font-size: 0.95em; margin-bottom:10px;} 
            button { font-size: 0.9em; padding: 12px 20px; margin-top: 15px;} 
            input, select { padding: 10px; margin-bottom:10px; font-size: 0.95em;}
            .select-row {max-width:100%;}

            #stepUserType h2 { font-size: 1.7em; margin-bottom: 25px; }
            .user-type-options { flex-direction: column; gap: 15px; }
            .user-type-btn { width: 90%; min-height: auto; padding: 18px; font-size: 1.05em; }
            .diagnosis-btn, .caregiver-nd-btn { max-width: 90%; font-size:0.95em; padding:10px; }
            .diagnosis-options {max-height: 50vh;}
            .input-group { width: 90%;}
        }
    </style>
</head>
<body class="step-background-main">
    <div id="stepUserType" class="step active">
        <h2>당신은 어디에 해당하시나요?</h2>
        <div class="user-type-options">
            <button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br><span class="btn-subtitle">(신경다양인 당사자)</span></button>
            <button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br><span class="btn-subtitle">(양육자, 배우자 등)</span></button>
        </div>
        <div class="error-message" id="userTypeError"></div>
    </div>

    <div id="stepCBT" class="step">
        <h2 id="cbtTitle">로지와 대화 시작하기</h2>
        <p id="cbtInfo">CBT 참여자 이메일 주소를 입력해주세요.</p>
        <input type="email" id="cbtCodeInput" placeholder="이메일 주소" />
        <div class="error-message" id="cbtCodeError"></div>
        <button id="submitCbtCodeBtn">다음</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step">
        <h2>보호자님에 대해서도 알려주시겠어요? <span class="optional-text">(선택 사항)</span></h2>
        <p>본인 또는 관계인(예: 배우자)께서 신경다양성 특성을 가지고 계시다면, 해당하는 항목을 모두 선택해주세요. <br>이는 로지가 더 깊이 공감하고 맞춤형 대화를 제공하는 데 도움이 됩니다.</p>
        <div class="diagnosis-options caregiver-nd-options">
            <button class="caregiver-nd-btn" data-nd="self_asd">저(보호자 본인)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="self_adhd">저(보호자 본인)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_asd">배우자(관계인)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_adhd">배우자(관계인)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="self_else">저(보호자 본인)에게 기타 신경다양성 특성이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_else">배우자(관계인)에게 기타 신경다양성 특성이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="unsure_or_none">잘 모르거나 해당 사항 없어요.</button>
        </div>
        <div class="error-message" id="caregiverNdError"></div>
        <button id="submitCaregiverNdBtn">다음 (또는 건너뛰기)</button>
    </div>

    <div id="stepDiagnosisType" class="step">
        <h2 id="diagnosisTitle">나의 신경다양성 정보</h2>
        <p id="diagnosisInfo">해당하는 항목을 모두 선택해주세요. (중복 선택 가능)</p>
        <div class="diagnosis-options">
            <button class="diagnosis-btn" data-diagnosis="ASD">자폐 스펙트럼 (ASD)</button>
            <button class="diagnosis-btn" data-diagnosis="ADHD">주의력 결핍 과잉행동 장애 (ADHD)</button>
            <button class="diagnosis-btn" data-diagnosis="Asperger">아스퍼거 증후군 (고기능 자폐)</button>
            <button class="diagnosis-btn" data-diagnosis="Tic">틱 장애</button>
            <button class="diagnosis-btn" data-diagnosis="LD">학습 장애</button>
            <button class="diagnosis-btn" data-diagnosis="Else">기타 어려움 또는 궁금증</button>
            <button class="diagnosis-btn" data-diagnosis="Unsure">아직 잘 모르겠어요 / 진단 없음</button>
            <button class="diagnosis-btn" data-diagnosis="NotApplicable">특별히 해당 없음</button> 
        </div>
        <div class="error-message" id="diagnosisError"></div>
        <button id="submitDiagnosisBtn">다음</button>
    </div>

    <div id="stepNameBirthSelf" class="step">
        <h2 id="nameBirthSelfTitle">만나서 반가워요!</h2>
        <p id="nameSelfPrompt">로지가 당신을 어떻게 부르면 좋을까요?</p>
        <input type="text" id="nameSelfInput" placeholder="이름 또는 별명" />
        <div class="error-message" id="nameSelfError"></div>
        <p id="birthSelfPrompt">생년월일을 선택해주세요.</p>
        <div class="info-text" id="birthSelfInfoText">정확한 나이를 계산하여 더 적절한 대화 경험을 제공합니다.</div>
        <div class="select-row">
            <select id="birthSelfYear"><option value="">년</option></select>
            <select id="birthSelfMonth"><option value="">월</option></select>
            <select id="birthSelfDay"><option value="">일</option></select>
        </div>
        <div class="error-message" id="birthSelfError"></div>
        <button id="submitNameBirthSelfBtn">다음</button>
    </div>
    
    <div id="stepNameBirthChild" class="step">
        <h2 id="nameBirthChildTitle">아이(또는 가족)의 정보를 알려주세요.</h2>
        <p id="nameChildPrompt">로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?</p>
        <input type="text" id="nameChildInput" placeholder="아이(또는 가족) 이름 또는 별명" />
        <div class="error-message" id="nameChildError"></div>
        <p id="birthChildPrompt">아이(또는 가족)의 생년월일을 선택해주세요.</p>
        <div class="info-text" id="birthChildInfoText">정확한 나이를 계산하여 아이(또는 가족)에게 더 적절한 대화 경험을 제공합니다.</div>
        <div class="select-row">
            <select id="birthChildYear"><option value="">년</option></select>
            <select id="birthChildMonth"><option value="">월</option></select>
            <select id="birthChildDay"><option value="">일</option></select>
        </div>
        <div class="error-message" id="birthChildError"></div>
        <button id="submitNameBirthChildBtn">다음</button>
    </div>


    <div id="stepChildEmail" class="step">
        <h2>아이/가족의 로지 계정 연결 <span class="optional-text">(선택 사항)</span></h2>
        <p>만약 아이(또는 가족)가 로지를 사용하고 있다면, 해당 계정의 로지 가입 이메일을 입력해주세요.<br>이를 통해 로지가 관련된 대화 내용을 참고하여 (상대방이 정보 공유에 동의한 경우에만) 보호자님께 더 도움이 되는 조언을 드릴 수 있습니다.</p>
        <p class="info-text" style="font-size: 0.85em; color: #ffeb3b;"><strong>[중요]</strong> 개인 정보 보호를 위해, 이 기능을 사용하려면 반드시 상대방의 동의가 필요하며, 로지는 상대방이 동의한 범위 내의 정보만을 참고합니다.</p>
        <input type="email" id="childLozeeEmailInput" placeholder="아이/가족의 로지 가입 이메일 (선택)" />
        <div class="error-message" id="childEmailError"></div>
        <button id="submitChildEmailBtn">저장 후 시작하기</button>
        <button id="skipChildEmailBtn" class="secondary-btn">건너뛰고 시작하기</button>
    </div>

    <script type="module">
        import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';
        import { db } from './js/firebase-config.js'; 
        import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

      // --- DOMContentLoaded 이벤트 리스너 ---
      // 모든 DOM 관련 작업과 초기화 로직을 이 안으로 옮깁니다.
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded 이벤트 발생: index.html");

        // --- DOM 요소 가져오기 ---
        const stepUserType = document.getElementById('stepUserType');
        const stepCBT = document.getElementById('stepCBT');
        const stepCaregiverNeurodiversity = document.getElementById('stepCaregiverNeurodiversity');
        const stepDiagnosisType = document.getElementById('stepDiagnosisType');
        const stepNameBirthSelf = document.getElementById('stepNameBirthSelf'); // 보호자/당사자 본인 정보 입력
        const stepNameBirthChild = document.getElementById('stepNameBirthChild'); // 보호자가 자녀 정보 입력
        const stepChildEmail = document.getElementById('stepChildEmail');

        const cbtTitleEl = document.getElementById('cbtTitle');
        const cbtInfoEl = document.getElementById('cbtInfo');
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const cbtCodeInput = document.getElementById('cbtCodeInput');
        const cbtCodeError = document.getElementById('cbtCodeError');
        const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');
        
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        
        // 본인 정보 입력 필드
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfPromptEl = document.getElementById('nameSelfPrompt');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfPromptEl = document.getElementById('birthSelfPrompt');
        const birthSelfInfoTextEl = document.getElementById('birthSelfInfoText');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');

        // 아이/가족 정보 입력 필드 (보호자용)
        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildPromptEl = document.getElementById('nameChildPrompt');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildPromptEl = document.getElementById('birthChildPrompt');
        const birthChildInfoTextEl = document.getElementById('birthChildInfoText');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');

        const childLozeeEmailInput = document.getElementById('childLozeeEmailInput');
        const childEmailError = document.getElementById('childEmailError');
        const submitChildEmailBtn = document.getElementById('submitChildEmailBtn');
        const skipChildEmailBtn = document.getElementById('skipChildEmailBtn');

        // --- 상태 변수 ---
        let selectedUserType = ''; 
        let caregiverSelfName = '', caregiverSelfBirthDate = '', caregiverSelfAge = 0; // 보호자 본인 정보
        let childName = '', childBirthDate = '', childAge = 0; // 아이/가족 정보
        let directUserName = '', directUserBirthDate = '', directUserAge = 0; // 당사자 정보
        let selectedCaregiverNd = [];
        let selectedDiagnoses = []; // 당사자 또는 아이/가족의 진단 정보

        // --- 헬퍼 함수 ---
        function showStep(elToShow) { /* ... 기존과 동일 ... */ }
        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 3, endYearOffset = 90) { /* ... 기존과 동일 ... */ }
        function calculateAge(y, m, d) { /* ... 기존과 동일 ... */ }
        function createBaseUserData(email, userTypeToSave) { /* ... 기존과 동일 ... */ }
        async function checkForExistingCbtUser(email) { /* ... 이전 답변의 로직을 참고하여, 보호자 본인 정보도 localStorage에 저장/로드 하도록 수정 ... */ }
 
 
        function showStep(elToShow) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            if (elToShow) elToShow.classList.add('active');
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 3, endYearOffset = 90) {
            // ... (이전 코드와 동일) ...
        }

        function calculateAge(y, m, d) {
            // ... (이전 코드와 동일) ...
        }
        
        function createBaseUserData(email, userTypeToSave) {
             return {
                email: email,
                userType: userTypeToSave,
                // createdAt은 최초 저장 시에만 추가 (setDoc 로직에서 처리)
                lastLogin: serverTimestamp()
            };
        }

        async function checkForExistingCbtUser(email) {
            // ... (이전 최종본의 checkForExistingCbtUser 함수 내용) ...
        }

        // 5. 이벤트 핸들러 ---
        // 5-1. 사용자 유형 선택
          userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                localStorage.setItem('lozee_userType', selectedUserType);
                // ... (cbtTitleEl 등 UI 업데이트) ...
                showStep(stepCBT);
            };
        });

        // 5-2. CBT 이메일 제출
        submitCbtCodeBtn.onclick = async () => {
            const email = cbtCodeInput.value.trim();
            // ... (유효성 검사) ...
            localStorage.setItem('cbtUserEmail', email.toLowerCase());
            localStorage.setItem('isCbtUser', 'true');

            const existingUserProcessed = await checkForExistingCbtUser(email);
            if (existingUserProcessed) return; 

            if (selectedUserType === 'caregiver') {
                // ...
                showStep(stepCaregiverNeurodiversity);
            } else { 
                // ...
                showStep(stepDiagnosisType);
            }
        };


        // 5-3. 보호자 본인/관계인 신경다양성 선택
        caregiverNdOptionBtns.forEach(button => { /* ... 이전과 동일한 선택 로직 (selectedCaregiverNd 업데이트) ... */ });
        submitCaregiverNdBtn.onclick = () => {
            localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(selectedCaregiverNd));
            diagnosisTitleEl.textContent = "아이(또는 가족)의 어떤 점에 대해 이야기 나누고 싶으세요?";
            diagnosisInfoEl.textContent = "해당하는 어려움을 모두 선택해주세요. (중복 선택 가능)";
            showStep(stepDiagnosisType);
        };

        // 5-4. (자신 또는 아이/가족의) 신경다양성 유형 선택
       diagnosisOptionBtns.forEach(button => {
        button.onclick = () => {
            const diagnosis = button.dataset.diagnosis;
            const isExclusiveOption = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');

            if (isExclusiveOption) {
            // "해당 없음" 또는 "잘 모르겠어요"를 클릭한 경우
            if (button.classList.contains('selected')) {
                // 이미 선택된 상태면 선택 해제
                button.classList.remove('selected');
                selectedDiagnoses = [];
            } else {
                // 다른 모든 버튼 선택 해제 후 이 버튼만 선택
                diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedDiagnoses = [diagnosis];
            }
        } else {
            // 일반 진단 유형을 클릭한 경우 (중복 선택 가능)
            // 만약 "해당 없음" 또는 "잘 모르겠어요"가 이전에 선택되어 있었다면 해제
            diagnosisOptionBtns.forEach(btn => {
                if (btn.dataset.diagnosis === 'NotApplicable' || btn.dataset.diagnosis === 'Unsure') {
                    btn.classList.remove('selected');
                }
            });
            // selectedDiagnoses 배열에서도 "NotApplicable", "Unsure" 제거
            selectedDiagnoses = selectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');

            // 현재 클릭한 버튼 선택/해제 토글
            button.classList.toggle('selected');
            if (selectedDiagnoses.includes(diagnosis)) {
                selectedDiagnoses = selectedDiagnoses.filter(d => d !== diagnosis);
            } else {
                selectedDiagnoses.push(diagnosis);
            }
        }
        
        // 선택된 진단이 하나도 없고, "해당 없음"이나 "잘 모르겠어요"도 선택 안 된 경우
        // 사용자가 모든 선택을 해제했을 때, selectedDiagnoses를 빈 배열로 유지
        if (!isExclusiveOption && !button.classList.contains('selected') && !selectedDiagnoses.some(val => button.dataset.diagnosis === val)) {
            // 이미 filter로 제거되었으므로 추가 동작 필요 없음
        }
        
        // 만약 일반 진단 유형을 선택했는데, selectedDiagnoses가 비게 되면 (모두 해제 시)
        // "해당 없음"이나 "잘 모르겠어요"를 기본으로 선택하게 할 수도 있지만, 지금은 그냥 비워둠.
        
        diagnosisError.textContent = ''; // 선택 시 오류 메시지 초기화
        console.log("선택된 진단 유형:", selectedDiagnoses);
    };
});

      // submitDiagnosisBtn.onclick 핸들러는 기존과 동일하게 유지 가능하나,
      // selectedDiagnoses 배열에 "NotApplicable" 또는 "Unsure"만 있거나,
      // 혹은 여러 일반 진단 유형이 함께 있는지만 확인합니다.
    submitDiagnosisBtn.onclick = () => {
        if (selectedDiagnoses.length === 0) { // 아무것도 선택 안 함
        diagnosisError.textContent = "하나 이상 선택해주세요. 특별히 해당사항이 없거나 잘 모르겠다면 관련 옵션을 선택할 수 있어요.";
        return;
        }
    // 만약 "NotApplicable"이나 "Unsure"가 다른 일반 진단과 함께 선택될 수 없도록 하려면,
    // 여기서 추가적인 유효성 검사 가능 (현재 로직은 이미 위에서 처리)
    
    diagnosisError.textContent = '';
    localStorage.setItem('lozee_diagnoses', JSON.stringify(selectedDiagnoses));

        // 다음 단계: 이름/생년월일 입력 (보호자면 본인 정보 먼저, 당사자면 본인 정보)
         if (selectedUserType === 'caregiver') {
             caregiverNameFromInput = name; // name은 nameSelfInput.value.trim()
             caregiverSelfBirthDate = birthDate; // birthDate는 y,m,d로 조합
             caregiverSelfAge = age; // age는 calculateAge 결과

        // 다음 단계: 자녀 정보 입력 UI 설정
             nameBirthChildTitleEl.textContent = "아이(또는 가족)의 정보를 알려주세요.";
             nameChildPromptEl.textContent = "로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?";
             nameChildInput.placeholder = "아이(또는 가족) 이름 또는 별명";
             nameChildInput.value = ''; // 이전 값 초기화
             birthChildPromptEl.textContent = "아이(또는 가족)의 생년월일을 선택해주세요.";
             populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // 👈 자녀 나이 범위로 호출
             showStep(stepNameBirthChild);


            } else { // directUser
                nameBirthSelfTitleEl.textContent = "만나서 반가워요! 당신에 대해 알려주세요.";
                nameSelfPromptEl.textContent = "로지가 당신을 어떻게 부르면 좋을까요?";
                nameSelfInput.placeholder = "이름 또는 별명";
                birthSelfPromptEl.textContent = "생년월일을 선택해주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay); // 당사자 나이 범위
                showStep(stepNameBirthSelf);
            }
        };
        
        // 5-5. 보호자/당사자 본인 이름/생년월일 제출
        submitNameBirthSelfBtn.onclick = async () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            
            if (!name) { nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.'; return; }
            nameSelfError.textContent = '';
            if (!y || !m || !d) { birthSelfError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            birthSelfError.textContent = '';
            
            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                caregiverNameFromInput = name;
                caregiverSelfBirthDate = birthDate;
                caregiverSelfAge = age;
                // 다음 단계: 자녀 정보 입력
                nameBirthChildTitleEl.textContent = "아이(또는 가족)의 정보를 알려주세요.";
                nameChildPromptEl.textContent = "로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?";
                nameChildInput.placeholder = "아이(또는 가족) 이름 또는 별명";
                birthChildPromptEl.textContent = "아이(또는 가족)의 생년월일을 선택해주세요.";
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // 자녀 나이 범위
                showStep(stepNameBirthChild);
            } else { // directUser
                directUserName = name;
                directUserBirthDate = birthDate;
                directUserAge = age;
                // 당사자는 자녀 정보 입력/연결 단계 없이 바로 Firestore 저장 및 talk.html로 이동
                await saveUserDataToFirestore();
                window.location.href = 'talk.html';
            }
        };

        // 5-2. (보호자 선택 시) 아이/가족 이름/생년월일 제출
        submitNameBirthChildBtn.onclick = async () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;

            if (!name) { nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.'; return; }
            nameChildError.textContent = '';
            if (!y || !m || !d) { birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.'; return; }
            birthChildError.textContent = '';

            childName = name;
            childBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            childAge = calculateAge(y, m, d);

            await saveUserDataToFirestore(); // 모든 정보 취합 후 저장
            showStep(stepChildEmail); // 다음: 아이/가족 로지 계정 연결
        };

       // --- 페이지 로드 시 초기 실행 로직 ---
        // populateBirthSelects는 각 이름/생년월일 입력 단계 진입 시 호출
        populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay); // 당사자/보호자 본인용은 미리 채워둘 수 있음
        // populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 20); // 자녀용은 해당 단계 진입 시

        showStep(stepUserType); // 첫 화면은 사용자 유형 선택
        }); // 여기가 DOMContentLoaded 리스너의 닫는 중괄호와 괄호입니다.

        
        // Firestore에 사용자 데이터 저장 함수
        async function saveUserDataToFirestore() {
            const cbtUserEmail = localStorage.getItem('cbtUserEmail');
            const userTypeToSave = localStorage.getItem('lozee_userType');
            // selectedDiagnoses는 당사자면 본인의 것, 보호자면 아이/가족의 것
            const diagnosesToSave = JSON.parse(localStorage.getItem('lozee_diagnoses') || '[]');
            const caregiverNdToSave = JSON.parse(localStorage.getItem('lozee_caregiver_neurodiversity') || '[]');

            if (!cbtUserEmail || !userTypeToSave) {
                console.error("필수 정보 누락으로 Firestore 저장 불가");
                return;
            }

            const userDocRef = doc(db, "users", cbtUserEmail);
            let userDataToSave = createBaseUserData(cbtUserEmail, userTypeToSave);

            if (userTypeToSave === 'caregiver') {
                userDataToSave.name = caregiverNameFromInput; 
                userDataToSave.birthDate = caregiverSelfBirthDate;
                userDataToSave.age = caregiverSelfAge;
                userDataToSave.caregiverNeurodiversity = caregiverNdToSave;
                userDataToSave.childName = childName; 
                userDataToSave.childBirthDate = childBirthDate;
                userDataToSave.childAge = childAge; 
                userDataToSave.childDiagnoses = diagnosesToSave; 
            } else { // directUser
                userDataToSave.name = directUserName;
                userDataToSave.birthDate = directUserBirthDate;
                userDataToSave.age = directUserAge;
                userDataToSave.diagnoses = diagnosesToSave;
            }
            
            try {
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists()) { 
                    delete userDataToSave.createdAt; // 기존 사용자면 createdAt은 업데이트 안 함
                }
                await setDoc(userDocRef, userDataToSave , { merge: true });
                console.log("Firestore에 모든 사용자 정보 저장/업데이트 완료.");

                // talk.html에서 사용할 localStorage 정보 최종 설정
                if (userTypeToSave === 'caregiver') {
                    localStorage.setItem('lozee_username', childName); // talk.html에서는 주로 아이 기준으로 대화
                    localStorage.setItem('lozee_userage', childAge.toString());
                    // 보호자 본인 정보도 필요시 mypage 등에서 사용하기 위해 별도 저장
                    localStorage.setItem('lozee_caregiver_name', caregiverNameFromInput);
                    localStorage.setItem('lozee_caregiver_age', caregiverSelfAge.toString());
                } else {
                    localStorage.setItem('lozee_username', directUserName);
                }

            } catch (error) {
                console.error("Firestore에 사용자 정보 저장 중 오류:", error);
            }
        }

        // 6. 아이/가족 로지 이메일 제출 (보호자 선택 시)
        submitChildEmailBtn.onclick = async () => { /* ... 이전과 동일 (childLozeeEmail Firestore에 저장) ... */ };
        skipChildEmailBtn.onclick = () => { /* ... 이전과 동일 ... */ };

    </script>
</body>
</html>