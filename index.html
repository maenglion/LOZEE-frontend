<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />

    <style>
        /* 기존 스타일 유지 */
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        .success-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #a5d6a7; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .success-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        button:disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
        .select-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-bottom: 12px; }
        .select-row select { width: calc(33% - 6px); }
        .terms-box { background-color: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px; width: 85%; max-width: 450px; text-align: left; }
        .term-item { margin-bottom: 10px; display: flex; align-items: center; }
        .term-item input[type="checkbox"] { width: auto; margin-right: 10px; transform: scale(1.2); }
        .term-item label { font-size: 0.95em; color: #f0f0f0; font-weight: normal; }
        .term-item label a { color: #fff2a8; text-decoration: underline; }
        #stepUserType h2 { font-size: 2em; margin-bottom: 40px; }
        .user-type-options { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; max-width: 700px; }
        .user-type-btn { flex: 1; padding: 25px 20px; font-size: 1.2em; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.4; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; }
        .btn-subtitle { font-size: 0.8em; font-weight: normal; color: #7b8dda; margin-top: 8px; }
        .user-type-btn:hover { background: #fff; transform: translateY(-1px); }
        .diagnosis-options { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; max-height: 60vh; overflow-y: auto; padding: 0 10px;}
        .diagnosis-btn, .caregiver-nd-btn { display: block; width: 85%; max-width: 480px; margin-bottom: 10px; padding: 12px; font-size: 1em; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .diagnosis-btn:hover, .caregiver-nd-btn:hover { background: #fff; }
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { background-color: #FFEB3B; color: #333; border-color: #FBC02D; font-weight:bold;}
        .optional-text { font-size: 0.8em; color: #e0e0e0; font-weight: normal; }
        .secondary-btn { background: #78909c; color: white; margin-top: 10px; }
        .secondary-btn:hover { background: #607d8b; }
        .input-group { margin-bottom: 20px; width: 85%; max-width: 350px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 1em; color: #f0f0f0; text-align: left; }
        .input-group input, .input-group .select-row { width: 100%; margin-bottom: 0; }
        /* 새로 추가된 라디오 버튼 스타일 */
        .radio-option-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .radio-option-group label {
            display: flex;
            align-items: center;
            font-size: 1em;
            color: #f0f0f0;
            cursor: pointer;
        }
        .radio-option-group input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #bdbdbd;
            border-radius: 50%;
            margin-right: 8px;
            transition: background-color 0.2s, border-color 0.2s;
            cursor: pointer;
            position: relative; /* 자식 요소 위치 지정을 위해 */
            top: 0; /* 라벨과의 정렬을 위해 */
        }
        .radio-option-group input[type="radio"]:checked {
            background-color: #6e8efb;
            border-color: #6e8efb;
        }
        .radio-option-group input[type="radio"]:checked::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @media (max-width: 600px) { h2 { font-size: 1.6em; } p, .info-text { font-size: 0.95em; } button { font-size: 0.9em; padding: 12px 20px; } input, select { padding: 10px; font-size: 0.95em;} .user-type-options { flex-direction: column; gap: 15px; } .user-type-btn { width: 90%; font-size: 1.05em; } }
    </style>
</head>
<body class="step-background-main">
    <div id="stepAuthChoice" class="step">
        <h2>LOZEE에 오신 것을 환영합니다!</h2>
        <div class="error-message" id="authChoiceError"></div>
        <button id="goToLoginBtn">로그인</button>
        <button id="goToSignUpBtn">회원가입</button>
    </div>

    <div id="stepLogin" class="step">
        <h2>로그인</h2>
        <div class="input-group"><label for="loginEmail">이메일</label><input type="email" id="loginEmail" placeholder="이메일 주소" autocomplete="email"></div>
        <div class="input-group"><label for="loginPassword">비밀번호</label><input type="password" id="loginPassword" placeholder="비밀번호" autocomplete="current-password"></div>
        <div class="error-message" id="loginError"></div>
        <button id="loginBtn">로그인</button>
        <button id="forgotPasswordBtn" class="secondary-btn">비밀번호를 잊으셨나요?</button>
        <p class="info-text" style="margin-top: 15px;">계정이 없으신가요? <a href="#" id="linkToSignUpFromLogin" style="color: #fff; text-decoration: underline;">회원가입</a></p>
    </div>

    <div id="stepPasswordReset" class="step">
        <h2>비밀번호 재설정</h2>
        <p>가입하신 이메일 주소를 입력하시면, 비밀번호 재설정 링크를 보내드립니다.</p>
        <div class="input-group"><label for="resetEmail">이메일</label><input type="email" id="resetEmail" placeholder="이메일 주소" autocomplete="email"></div>
        <div class="error-message" id="resetError"></div><div class="success-message" id="resetSuccess"></div>
        <button id="sendResetEmailBtn">재설정 이메일 발송</button>
        <button id="backToLoginBtn" class="secondary-btn">로그인으로 돌아가기</button>
    </div>

    <div id="stepUserType" class="step">
        <h2>회원가입</h2>
        <p>어떤 역할로 로지를 이용하시겠어요?</p>
        <div class="user-type-options"><button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br><span class="btn-subtitle">(신경다양인 당사자)</span></button><button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br><span class="btn-subtitle">(양육자, 배우자 등)</span></button></div>
        <p class="info-text" style="margin-top: 15px;">이미 계정이 있으신가요? <a href="#" id="linkToLoginFromSignUp" style="color: #fff; text-decoration: underline;">로그인</a></p>
    </div>

    <div id="stepTermsAgreement" class="step">
        <h2>서비스 이용 약관 및 개인정보처리방침 동의</h2>
        <p class="info-text">로지 서비스 이용을 위해 아래 약관에 동의해주세요.</p>
        <div class="terms-box">
            <div class="term-item"><input type="checkbox" id="agreeTerms" name="agreeTerms"><label for="agreeTerms">(필수) <a href="./terms.html" target="_blank">서비스 이용약관</a>에 동의합니다.</label></div>
            <div class="term-item"><input type="checkbox" id="agreePrivacy" name="agreePrivacy"><label for="agreePrivacy">(필수) <a href="./privacy.html" target="_blank">개인정보처리방침</a>에 동의합니다.</label></div>
            <div class="term-item" style="margin-top:10px;"><input type="checkbox" id="agreeMarketing" name="agreeMarketing"><label for="agreeMarketing">(선택) 마케팅 정보 수신에 동의합니다.</label></div>
        </div>
        <div class="error-message" id="termsError"></div>
        <button id="submitTermsBtn">다음</button>
        <button id="backToRoleChoiceBtn" class="secondary-btn" style="margin-top: 10px;">이전 (역할 다시 선택)</button>
    </div>


    <div id="stepSignUpEmailPassword" class="step">
        <h2>회원가입: 계정 정보 입력</h2>
        <p class="info-text">로지 서비스 이용을 위한 계정 정보를 입력해주세요.<br>이메일은 로그인 ID로 사용되며, 비밀번호 재설정 시 필요합니다.</p>
        <div class="input-group"><label for="signUpEmail">이메일</label><input type="email" id="signUpEmail" placeholder="이메일 주소" autocomplete="email"></div>
        <div class="input-group"><label for="signUpPassword">비밀번호 (6자리 이상)</label><input type="password" id="signUpPassword" placeholder="비밀번호" autocomplete="new-password"></div>
        <div class="input-group"><label for="signUpPasswordConfirm">비밀번호 확인</label><input type="password" id="signUpPasswordConfirm" placeholder="비밀번호 다시 입력" autocomplete="new-password"></div>
        <div class="error-message" id="signUpError"></div>
        <button id="createAccountBtn">계정 생성 및 인증 메일 발송</button>
    </div>

    <div id="stepEmailVerification" class="step">
        <h2>이메일 인증 안내</h2>
        <p>가입하신 이메일 주소(<strong id="verificationEmailDisplay"></strong>)로 인증 메일을 보냈습니다.<br>메일을 확인하고 인증 링크를 클릭해주세요.</p>
        <p class="info-text">인증을 완료하셨으면 아래 버튼을 눌러주세요.</p>
        <div class="error-message" id="verificationError"></div>
        <button id="checkVerificationBtn">이메일 인증 완료</button>
        <button id="resendVerificationBtn" class="secondary-btn">인증 메일 다시 보내기</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step">
        <h2>보호자님에 대해서도 알려주시겠어요? <span class="optional-text">(선택 사항)</span></h2>
        <p>본인 또는 관계인(예: 배우자)께서 신경다양성 특성을 가지고 계시다면, 해당하는 항목을 모두 선택해주세요.</p>
        <div class="diagnosis-options caregiver-nd-options"><button class="caregiver-nd-btn" data-nd="self_asd">저(보호자)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button><button class="caregiver-nd-btn" data-nd="self_adhd">저(보호자)에게 ADHD 성향이 있어요.</button><button class="caregiver-nd-btn" data-nd="spouse_asd">배우자에게 자폐 스펙트럼(ASD) 성향이 있어요.</button><button class="caregiver-nd-btn" data-nd="spouse_adhd">배우자에게 ADHD 성향이 있어요.</button><button class="caregiver-nd-btn" data-nd="unsure_or_none">잘 모르거나 해당 사항 없어요.</button></div>
        <div class="error-message" id="caregiverNdError"></div>
        <button id="submitCaregiverNdBtn">다음 (또는 건너뛰기)</button>
    </div>

    <div id="stepSpecialistDiagnosisDirectUser" class="step">
        <h2>전문의 진단 여부</h2>
        <p>선택하신 특성은 전문의에게 진단받은 정보인가요?</p>
        <div class="radio-option-group">
            <label><input type="radio" name="specialistDiagnosisDirectUser" value="true" /> 예</label>
            <label><input type="radio" name="specialistDiagnosisDirectUser" value="false" /> 아니요</label>
        </div>
        <div class="error-message" id="specialistDiagnosisDirectUserError"></div>
        <button id="submitSpecialistDiagnosisDirectUserBtn">다음</button>
    </div>

    <div id="stepSpecialistDiagnosisCaregiver" class="step">
        <h2>전문의 진단 여부</h2>
        <p>선택하신 **아이(또는 가족)의** 특성은 전문의에게 진단받은 정보인가요?</p>
        <div class="radio-option-group">
            <label><input type="radio" name="specialistDiagnosisCaregiver" value="true" /> 예</label>
            <label><input type="radio" name="specialistDiagnosisCaregiver" value="false" /> 아니요</label>
        </div>
        <div class="error-message" id="specialistDiagnosisCaregiverError"></div>
        <button id="submitSpecialistDiagnosisCaregiverBtn">다음</button>
    </div>

    <div id="stepDiagnosisType" class="step">
        <h2 id="diagnosisTitle">특성 이해하기</h2>
        <p id="diagnosisInfo">해당하는 항목을 모두 선택해주세요. (중복 선택 가능)</p>
        <div class="diagnosis-options"><button class="diagnosis-btn" data-diagnosis="ASD">자폐 스펙트럼 (ASD)</button><button class="diagnosis-btn" data-diagnosis="ADHD">주의력 결핍 과잉행동 장애 (ADHD)</button><button class="diagnosis-btn" data-diagnosis="Asperger">아스퍼거 증후군</button><button class="diagnosis-btn" data-diagnosis="Tic">틱 장애</button><button class="diagnosis-btn" data-diagnosis="LD">학습 장애</button><button class="diagnosis-btn" data-diagnosis="Else">기타 어려움/궁미증</button><button class="diagnosis-btn" data-diagnosis="Unsure">아직 잘 모르겠어요</button><button class="diagnosis-btn" data-diagnosis="NotApplicable">특별히 해당 없음</button></div>
        <div class="error-message" id="diagnosisError"></div>
        <button id="submitDiagnosisBtn">다음</button>
    </div>

    <div id="stepNameBirthSelf" class="step">
        <h2 id="nameBirthSelfTitle">정보 입력</h2>
        <div class="input-group"><label for="nameSelfInput">로지가 당신을 어떻게 부르면 좋을까요?</label><input type="text" id="nameSelfInput" placeholder="이름 또는 별명" /><div class="error-message" id="nameSelfError"></div></div>
        <div class="input-group"><label for="birthSelfYear">생년월일을 선택해주세요.</label><div class="info-text">만 나이를 계산하여 맞춤형 대화를 제공합니다.</div><div class="select-row"><select id="birthSelfYear"></select><select id="birthSelfMonth"></select><select id="birthSelfDay"></select></div><div class="error-message" id="birthSelfError"></div></div>
        <button id="submitNameBirthSelfBtn">다음</button>
    </div>

    <div id="stepNameBirthChild" class="step">
        <h2 id="nameBirthChildTitle">아이(또는 가족)의 정보를 알려주세요.</h2>
        <div class="input-group"><label for="nameChildInput">로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?</label><input type="text" id="nameChildInput" placeholder="아이(또는 가족) 이름" /><div class="error-message" id="nameChildError"></div></div>
        <div class="input-group"><label for="birthChildYear">아이(또는 가족)의 생년월일을 선택해주세요.</label><div class="info-text">아이에게 더 적절한 대화 경험을 제공합니다.</div><div class="select-row"><select id="birthChildYear"></select><select id="birthChildMonth"></select><select id="birthChildDay"></select></div><div class="error-message" id="birthChildError"></div></div>
        <button id="submitNameBirthChildBtn">다음</button>
    </div>
    
    <div id="stepFinalStart" class="step">
        <h2>모든 준비가 끝났어요!</h2>
        <p>입력해주신 정보를 바탕으로 로지가 더 의미있는 대화를 나눌 수 있을 거예요.</p>
        <button id="startLozeeConversationBtn">로지와 대화 시작하기</button>
    </div>

    <script type="module">
        // Firebase 설정 모듈 가져오기
        import { db, auth as firebaseAuth } from './js/firebase-config.js';

        // 인증 관련 함수 가져오기
        import {
            listenAuthState,
            signUpWithEmail,
            signInWithEmail,
            resetPassword,
            saveUserProfile,
            sendEmailVerification // 이 부분은 auth.js에서 export 되는 이름과 일치해야 합니다. (sendVerificationEmail)
        } from './js/auth.js';

        // Firestore 모듈 가져오기
        import { collection, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // DOM 요소 가져오기
        const steps = {
            authChoice: document.getElementById('stepAuthChoice'), // ID가 'authChoice'가 아니라 'stepAuthChoice'입니다.
            login: document.getElementById('stepLogin'),
            passwordReset: document.getElementById('stepPasswordReset'),
            userType: document.getElementById('stepUserType'),
            termsAgreement: document.getElementById('stepTermsAgreement'),
            signUpEmailPassword: document.getElementById('stepSignUpEmailPassword'),
            emailVerification: document.getElementById('stepEmailVerification'),
            caregiverNd: document.getElementById('stepCaregiverNeurodiversity'),
            diagnosisType: document.getElementById('stepDiagnosisType'),
            nameBirthSelf: document.getElementById('stepNameBirthSelf'),
            nameBirthChild: document.getElementById('stepNameBirthChild'),
            finalStart: document.getElementById('stepFinalStart'),
            verifyEmail: document.getElementById('verifyEmail'), // 이 ID는 HTML에 없습니다.
            resetPassword: document.getElementById('resetPassword'), // 이 ID는 HTML에 없습니다.
            specialistDiagnosisDirectUser: document.getElementById('stepSpecialistDiagnosisDirectUser'),
            specialistDiagnosisCaregiver: document.getElementById('stepSpecialistDiagnosisCaregiver')
        };

        const goToLoginBtn = document.getElementById('goToLoginBtn');
        const goToSignUpBtn = document.getElementById('goToSignUpBtn');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginErrorEl = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const linkToSignUpFromLogin = document.getElementById('linkToSignUpFromLogin');
        const linkToLoginFromSignUp = document.getElementById('linkToLoginFromSignUp'); 
        const resetEmailInput = document.getElementById('resetEmail');
        const resetErrorEl = document.getElementById('resetError');
        const resetSuccessEl = document.getElementById('resetSuccess');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const agreeTermsCheckbox = document.getElementById('agreeTerms');
        const agreePrivacyCheckbox = document.getElementById('agreePrivacy');
        const agreeMarketingCheckbox = document.getElementById('agreeMarketing');
        const termsErrorEl = document.getElementById('termsError');
        const submitTermsBtn = document.getElementById('submitTermsBtn');
        const backToRoleChoiceBtn = document.getElementById('backToRoleChoiceBtn');
        const signUpEmailInput = document.getElementById('signUpEmail');
        const signUpPasswordInput = document.getElementById('signUpPassword');
        const signUpPasswordConfirmInput = document.getElementById('signUpPasswordConfirm');
        const signUpErrorEl = document.getElementById('signUpError');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const verificationEmailDisplayEl = document.getElementById('verificationEmailDisplay');
        const verificationErrorEl = document.getElementById('verificationError');
        const checkVerificationBtn = document.getElementById('checkVerificationBtn');
        const resendVerificationBtn = document.getElementById('resendVerificationBtn');
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const caregiverNdError = document.getElementById('caregiverNdError');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');
        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');
        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn');
        const specialistDiagnosisDirectUserRadios = document.querySelectorAll('input[name="specialistDiagnosisDirectUser"]');
        const specialistDiagnosisDirectUserError = document.getElementById('specialistDiagnosisDirectUserError');
        const submitSpecialistDiagnosisDirectUserBtn = document.getElementById('submitSpecialistDiagnosisDirectUserBtn');
        const specialistDiagnosisCaregiverRadios = document.querySelectorAll('input[name="specialistDiagnosisCaregiver"]');
        const specialistDiagnosisCaregiverError = document.getElementById('specialistDiagnosisCaregiverError');
        const submitSpecialistDiagnosisCaregiverBtn = document.getElementById('submitSpecialistDiagnosisCaregiverBtn');
        
        // 이메일/비밀번호 입력 필드는 로그인/회원가입 섹션에 있으므로, 해당 섹션의 ID를 사용합니다.
        // 예를 들어, stepLogin 또는 stepSignUpEmailPassword 내의 input 필드를 가져와야 합니다.
        // 현재 전역으로 선언된 emailInput, passwordInput 등은 HTML에 ID가 정의되어 있지 않습니다.
        // 따라서 해당 ID들을 HTML에 추가하거나, 적절한 DOM 쿼리 셀렉터를 사용해야 합니다.
        // 아래는 HTML에 ID를 추가했다고 가정하고 수정합니다.
        // emailInput: loginEmail 또는 signUpEmail
        // passwordInput: loginPassword 또는 signUpPassword
        // signUpButton, signInButton, resetPasswordButton: HTML에 해당 ID가 없습니다.
        // showToast 함수에서 사용되는 DOM 요소들은 id가 없습니다.
        // showToast() 함수에서 사용하는 DOM 요소들을 추가합니다.
        // index.html의 DOM 구조에 맞게 ID를 정확히 맞춰주세요.

        // 회원가입/로그인/비밀번호 재설정 페이지에 있는 input과 button의 ID를 정확히 가져와야 합니다.
        // 현재 HTML에서 누락된 ID들을 추가했다고 가정하고 해당 요소를 가져옵니다.
        // 예: <input type="email" id="emailInput"> 이 있었다면
        // 하지만 실제 HTML에는 loginEmail, signUpEmail 등이 있으므로 이에 맞춰 수정합니다.
        // const emailInput = document.getElementById('emailInput'); // HTML에 이 ID가 없음
        // const passwordInput = document.getElementById('passwordInput'); // HTML에 이 ID가 없음
        // const signUpButton = document.getElementById('signUpButton'); // HTML에 이 ID가 없음
        // const signInButton = document.getElementById('signInButton'); // HTML에 이 ID가 없음
        // const resetPasswordButton = document.getElementById('resetPasswordButton'); // HTML에 이 ID가 없음

        // 이메일/비밀번호 필드는 로그인/회원가입 단계에 따라 다르게 참조될 수 있습니다.
        // 여기서는 가장 자주 사용되는 필드를 가져오거나, 필요 시 각 이벤트 핸들러 내부에서 가져옵니다.
        // 현재 코드에서는 loginEmailInput, loginPasswordInput, signUpEmailInput 등을 이미 사용하고 있습니다.
        // signUpButton, signInButton, resetPasswordButton 변수는 HTML에 해당 ID가 없으므로
        // 에러를 피하려면 HTML에 ID를 추가하거나, 이 변수들을 삭제해야 합니다.
        // 일단 이 변수 선언은 그대로 두고, HTML에 해당 ID가 있다고 가정합니다.

        // 상태 변수
        let currentUserId = null;
        let selectedUserType = '';
        let tempUserName = ''; 
        let tempUserBirthDate = ''; 
        let tempUserAge = null; 
        let tempChildName = ''; 
        let tempChildBirthDate = ''; 
        let tempChildAge = null; 
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = [];
        let tempAgreedTerms = false, tempAgreedPrivacy = false, tempAgreedMarketing = false;
        let tempIsSpecialistDiagnosedDirectUser = null; 
        let tempIsSpecialistDiagnosedCaregiver = null; 
        let tempIsSpecialistDiagnosedChild = null;

        // 헬퍼 함수: 단계 전환
        function showStep(stepId) { 
            console.log(`[showStep] 단계 전환: ${stepId}`);
            const stepElement = steps[stepId]; 
            document.querySelectorAll('.step').forEach(step => {
                step.style.display = 'none'; 
                step.classList.remove('active'); 
            }); 
            if (stepElement) { 
                stepElement.style.display = 'flex'; 
                stepElement.classList.add('active'); 
            } else { 
                console.error(`showStep: '${stepId}' 단계를 찾을 수 없습니다.`); 
                if(steps.authChoice) { // 'stepAuthChoice'로 ID 변경했으므로 이 부분도 수정
                    steps.authChoice.style.display = 'flex';
                    steps.authChoice.classList.add('active'); 
                }
            } 
        }

        // showToast 함수 (mypage.js에서 재사용)
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            Object.assign(toast.style, {
                position: 'fixed',
                bottom: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: 'rgba(0,0,0,0.75)',
                color: '#fff',
                padding: '12px 18px',
                borderRadius: '10px',
                zIndex: '9999',
                fontSize: '14px'
            });
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 헬퍼 함수: 입력 필드 초기화
        function clearInputFields() {
            console.log("[clearInputFields] 입력 필드 초기화 시작");
            document.querySelectorAll('input').forEach(input => {
                if (input.type === 'text' || input.type === 'email' || input.type === 'password' || input.type === 'date') {
                    input.value = '';
                } else if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                }
            });
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.success-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.diagnosis-btn.selected').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.caregiver-nd-btn.selected').forEach(btn => btn.classList.remove('selected'));
            tempSelectedCaregiverNd = [];
            tempSelectedDiagnoses = [];
            tempAgreedTerms = false;
            tempAgreedPrivacy = false;
            tempAgreedMarketing = false;
            tempIsSpecialistDiagnosedDirectUser = null;
            tempIsSpecialistDiagnosedCaregiver = null;
            tempIsSpecialistDiagnosedChild = null;
            selectedUserType = ''; // userType 초기화 추가
            tempUserName = ''; 
            tempUserBirthDate = ''; 
            tempUserAge = null; 
            tempChildName = ''; 
            tempChildBirthDate = ''; 
            tempChildAge = null; 
            console.log("[clearInputFields] 입력 필드 및 상태 초기화 완료");
        }

        // 헬퍼 함수: 생년월일 선택지 생성
        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) {
            if (!yearEl || !monthEl || !dayEl) return;
            yearEl.innerHTML = '<option value="">년</option>';
            monthEl.innerHTML = '<option value="">월</option>';
            dayEl.innerHTML = '<option value="">일</option>';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - startYearOffset; y >= currentYear - endYearOffset; y--) {
                const opt = new Option(`${y}년`, y); yearEl.add(opt);
            }
            for (let m = 1; m <= 12; m++) {
                const opt = new Option(`${m}월`, m); monthEl.add(opt);
            }
            for (let d = 1; d <= 31; d++) {
                const opt = new Option(`${d}일`, d); dayEl.add(opt);
            }
            console.log("[populateBirthSelects] 생년월일 선택지 생성 완료");
        }

        // 헬퍼 함수: 나이 계산
        function calculateAge(y, m, d) {
            if (!y || !m || !d) return null;
            const birth = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
            if (isNaN(birth.getTime())) return null;
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age >= 0 ? age : null;
        }

        // 헬퍼 함수: localStorage 설정 및 리다이렉트
        function setLocalStorageAndRedirect(userProfile, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse) {
            localStorage.setItem('lozee_profile', JSON.stringify(userProfile));
            localStorage.setItem('lozee_ageForTalkContext', ageForTalk !== null ? ageForTalk.toString() : (userProfile.age !== null ? userProfile.age.toString() : '30'));
            if (childDataForRedirect) {
                localStorage.setItem('lozee_childData', JSON.stringify(childDataForRedirect));
            } else {
                localStorage.removeItem('lozee_childData');
            }

            // 기존 lozee_ 접두사 localStorage 정리 (재로그인 시 불필요한 데이터 방지)
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('lozee_') && !['lozee_profile', 'lozee_ageForTalkContext', 'lozee_childData'].includes(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            // 새로운 방식으로 데이터 저장
            localStorage.setItem('lozee_userId', userProfile.uid);
            localStorage.setItem('lozee_username', userProfile.name);
            localStorage.setItem('lozee_role', userProfile.role);
            localStorage.setItem('lozee_userType', JSON.stringify(userProfile.userType)); 
            localStorage.setItem('lozee_userEmail', userProfile.email); 

            if (userProfile.userType.includes('caregiver')) {
                localStorage.setItem('lozee_childName', userProfile.caregiverInfo?.childName || '아이');
                localStorage.setItem('lozee_childAge', userProfile.caregiverInfo?.childAge?.toString() || '0');
                localStorage.setItem('lozee_diagnoses', JSON.stringify(userProfile.caregiverInfo?.childDiagnoses || []));
                localStorage.setItem('lozee_parentIsND', JSON.stringify(isCaregiverNeurodiverse));
                localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(userProfile.caregiverInfo?.caregiverNeurodiversity || []));
                localStorage.setItem('lozee_isChildDiagnosedBySpecialist', JSON.stringify(userProfile.caregiverInfo?.isChildDiagnosedBySpecialist || false));
                localStorage.setItem('lozee_isCaregiverDiagnosedBySpecialist', JSON.stringify(userProfile.caregiverInfo?.isCaregiverDiagnosedBySpecialist || false));
            } else if (userProfile.userType.includes('directUser')) {
                localStorage.setItem('lozee_diagnoses', JSON.stringify(userProfile.diagnoses || []));
                localStorage.setItem('lozee_isDirectUserDiagnosedBySpecialist', JSON.stringify(userProfile.isDirectUserDiagnosedBySpecialist || false));
            }
            console.log("모든 정보 localStorage 저장 완료. talk.html로 이동합니다."); 
            window.location.href = 'talk.html'; 
        }


        // --- 이벤트 핸들러 바인딩 ---
        if (goToLoginBtn) goToLoginBtn.onclick = () => { clearInputFields(); showStep('login'); };
        if (goToSignUpBtn) goToSignUpBtn.onclick = () => { clearInputFields(); showStep('userType'); };
        if (linkToSignUpFromLogin) linkToSignUpFromLogin.onclick = (e) => { e.preventDefault(); clearInputFields(); showStep('userType'); };
        if (linkToLoginFromSignUp) linkToLoginFromSignUp.onclick = (e) => { e.preventDefault(); clearInputFields(); showStep('login'); }; 
        if (forgotPasswordBtn) forgotPasswordBtn.onclick = () => { clearInputFields(); showStep('passwordReset'); };
        if (backToLoginBtn) backToLoginBtn.onclick = () => { clearInputFields(); showStep('login'); };
        if (backToRoleChoiceBtn) backToRoleChoiceBtn.onclick = () => showStep('userType');

        // 이벤트 핸들러: 로그인
        if (loginBtn) loginBtn.onclick = async () => {
            console.log("[loginBtn] 로그인 시도");
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if (loginErrorEl) loginErrorEl.textContent = '';
            if (!email || !password) {
                if (loginErrorEl) loginErrorEl.textContent = "이메일과 비밀번호를 모두 입력해주세요.";
                return;
            }
            loginBtn.disabled = true;
            loginBtn.textContent = "로그인 중...";
            const { user, error } = await signInWithEmail(email, password);
            loginBtn.disabled = false;
            loginBtn.textContent = "로그인";
            if (error) {
                console.error("[loginBtn] 로그인 실패:", error);
                let errorMessage = "로그인 실패: ";
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += `이미 사용 중인 이메일입니다. <a href="#" id="goToLoginLink" style="color: #fff; text-decoration: underline;">로그인 페이지로 이동</a>`;
                        break;
                    case 'auth/invalid-email':
                        errorMessage += "유효하지 않은 이메일 형식입니다.";
                        break;
                    case 'auth/weak-password':
                        errorMessage += "비밀번호가 너무 약합니다. 6자리 이상으로 설정해주세요.";
                        break;
                    case 'auth/invalid-credential': // 이메일/비번 불일치 오류 코드
                        errorMessage += "이메일 또는 비밀번호가 올바르지 않습니다.";
                        break;
                    default:
                        errorMessage += error.message;
                }
                if (loginErrorEl) {
                    loginErrorEl.innerHTML = errorMessage;
                    const goToLoginLink = document.getElementById('goToLoginLink');
                    if (goToLoginLink) {
                        goToLoginLink.onclick = (e) => {
                            e.preventDefault();
                            clearInputFields();
                            showStep('login');
                        };
                    }
                }
            } else if (user) {
                if (user.emailVerified) { // 이메일 인증이 이미 되어있으면
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists() && userDoc.data().userType) {
                        const userProfile = userDoc.data();
                        let ageForTalk = userProfile.age;
                        let childDataForRedirect = null;
                        let isCaregiverNeurodiverse = false;

                        // userType이 단일 문자열인 레거시 데이터를 배열로 변환
                        if (typeof userProfile.userType === 'string') {
                            userProfile.userType = [userProfile.userType];
                            if (userProfile.userType[0] === 'caregiver' && 
                                userProfile.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                                !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                                    userProfile.userType.push('directUser');
                            }
                        }

                        if (Array.isArray(userProfile.userType) && userProfile.userType.includes('caregiver') && userProfile.caregiverInfo) {
                            ageForTalk = userProfile.caregiverInfo.childAge;
                            childDataForRedirect = userProfile.caregiverInfo;
                            isCaregiverNeurodiverse = userProfile.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                                !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                        }
                        setLocalStorageAndRedirect(userProfile, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
                    } else {
                        // 프로필이 없으면 회원가입 절차 진행
                        console.log("[loginBtn] 사용자 프로필 없음, userType으로 이동");
                        showStep('userType');
                    }
                } else {
                    console.log("[loginBtn] 이메일 미인증, emailVerification으로 이동");
                    if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = user.email;
                    showStep('emailVerification');
                    localStorage.setItem('lozee_tempEmailForVerification', user.email);
                }
            }
        };

        // 이벤트 핸들러: 비밀번호 재설정 이메일 발송
        if (sendResetEmailBtn) sendResetEmailBtn.onclick = async () => {
            console.log("[sendResetEmailBtn] 비밀번호 재설정 이메일 발송 시도");
            const email = resetEmailInput.value.trim();
            if (resetErrorEl) resetErrorEl.textContent = '';
            if (resetSuccessEl) resetSuccessEl.textContent = '';
            if (!email) {
                if (resetErrorEl) resetErrorEl.textContent = "이메일을 입력해주세요.";
                return;
            }

            sendResetEmailBtn.disabled = true;
            sendResetEmailBtn.textContent = "발송 중...";

            try {
                await resetPassword(email); 
                if (resetSuccessEl) {
                    resetSuccessEl.textContent = "비밀번호 재설정 이메일을 보냈습니다. 이메일함을 확인해주세요. (등록된 계정이 없는 경우 메일이 발송되지 않을 수 있습니다.)";
                }
                console.log("비밀번호 재설정 이메일 전송 요청 완료 (Firebase는 사용자 존재 여부 숨김)");
            } catch (error) {
                console.error("[sendResetEmailBtn] 비밀번호 재설정 이메일 전송 실패:", error);
                if (resetErrorEl) {
                    resetErrorEl.textContent = "이메일 발송에 실패했습니다: " + (error ? error.message : "알 수 없는 오류");
                }
            } finally {
                sendResetEmailBtn.disabled = false;
                sendResetEmailBtn.textContent = "재설정 이메일 발송";
            }
        };

        // 이벤트 핸들러: 사용자 유형 선택
        userTypeButtons.forEach(button => { 
            button.onclick = () => { 
                selectedUserType = button.dataset.usertype; 
                showStep('termsAgreement'); 
            }; 
        });
        
        // 이벤트 핸들러: 약관 동의
        if (submitTermsBtn) submitTermsBtn.onclick = () => {
            console.log("[submitTermsBtn] 약관 동의 확인");
            if (termsErrorEl) termsErrorEl.textContent = '';
            if (!agreeTermsCheckbox.checked || !agreePrivacyCheckbox.checked) { 
                if (termsErrorEl) termsErrorEl.textContent = "필수 약관에 모두 동의해주세요."; 
                return; 
            }
            tempAgreedTerms = agreeTermsCheckbox.checked; 
            tempAgreedPrivacy = agreePrivacyCheckbox.checked; 
            tempAgreedMarketing = agreeMarketingCheckbox.checked;
            showStep('signUpEmailPassword');
        };
        
        // 이벤트 핸들러: 계정 생성
        if (createAccountBtn) createAccountBtn.onclick = async () => {
            console.log("[createAccountBtn] 계정 생성 시도");
            const email = signUpEmailInput.value.trim();
            const password = signUpPasswordInput.value;
            const passwordConfirm = signUpPasswordConfirmInput.value;
            if (signUpErrorEl) signUpErrorEl.textContent = '';
            if (!email || !password || !passwordConfirm) { 
                if (signUpErrorEl) signUpErrorEl.textContent = "모든 필드를 입력해주세요."; 
                return; 
            }
            if (password !== passwordConfirm) { 
                if (signUpErrorEl) signUpErrorEl.textContent = "비밀번호가 일치하지 않습니다."; 
                return; 
            } 
            if (password.length < 6) { 
                if (signUpErrorEl) signUpErrorEl.textContent = "비밀번호는 6자리 이상이어야 합니다."; 
                return; 
            }
            createAccountBtn.disabled = true;
            createAccountBtn.textContent = "계정 생성 중...";
            const { user, error } = await signUpWithEmail(email, password);
            createAccountBtn.disabled = false;
            createAccountBtn.textContent = "계정 생성 및 인증 메일 발송";
            if (error) {
                console.error("[createAccountBtn] 계정 생성 실패:", error);
                let errorMessage = "계정 생성 실패: ";
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += `이미 사용 중인 이메일입니다. <a href="#" id="goToLoginLink" style="color: #fff; text-decoration: underline;">로그인 페이지로 이동</a>`;
                        break;
                    case 'auth/invalid-email':
                        errorMessage += "유효하지 않은 이메일 형식입니다.";
                        break;
                    case 'auth/weak-password':
                        errorMessage += "비밀번호가 너무 약합니다. 6자리 이상으로 설정해주세요.";
                        break;
                    default:
                        errorMessage += error.message;
                }
                if (signUpErrorEl) {
                    signUpErrorEl.innerHTML = errorMessage;
                    const goToLoginLink = document.getElementById('goToLoginLink');
                    if (goToLoginLink) {
                        goToLoginLink.onclick = (e) => {
                            e.preventDefault();
                            clearInputFields();
                            showStep('login');
                        };
                    }
                }
            } else if (user) {
                if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                showStep('emailVerification');
            }
        };

        // 이벤트 핸들러: 이메일 인증 확인
        if (checkVerificationBtn) checkVerificationBtn.onclick = async () => {
            console.log("[checkVerificationBtn] 이메일 인증 확인");
            const currentUser = firebaseAuth.currentUser;
            if (!currentUser) { 
                console.log("[checkVerificationBtn] 현재 사용자 없음, 로그인 페이지로 이동");
                if (verificationErrorEl) verificationErrorEl.textContent = "사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요."; 
                showStep('login'); 
                return; 
            }
            checkVerificationBtn.disabled = true;
            checkVerificationBtn.textContent = "확인 중...";
            await currentUser.reload();
            checkVerificationBtn.disabled = false;
            checkVerificationBtn.textContent = "이메일 인증 완료";
            if (currentUser.emailVerified) {
                console.log("[checkVerificationBtn] 이메일 인증 완료, 사용자 ID:", currentUser.uid);
                currentUserId = currentUser.uid; 
                localStorage.setItem('lozee_userId', currentUserId);
                if (verificationErrorEl) verificationErrorEl.textContent = '';
                
                const userDoc = await getDoc(doc(db, 'users', currentUserId));
                if (userDoc.exists() && userDoc.data().userType) { 
                    const userProfile = userDoc.data();
                    let ageForTalk = userProfile.age;
                    let childDataForRedirect = null;
                    let isCaregiverNeurodiverse = false;

                    // userType이 단일 문자열인 레거시 데이터를 배열로 변환
                    if (typeof userProfile.userType === 'string') {
                        userProfile.userType = [userProfile.userType];
                        if (userProfile.userType[0] === 'caregiver' && 
                            userProfile.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                            !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                                userProfile.userType.push('directUser');
                        }
                    }

                    if (Array.isArray(userProfile.userType) && userProfile.userType.includes('caregiver') && userProfile.caregiverInfo) { 
                        ageForTalk = userProfile.caregiverInfo.childAge;
                        childDataForRedirect = userProfile.caregiverInfo;
                        isCaregiverNeurodiverse = userProfile.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                            !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                    }
                    setLocalStorageAndRedirect(userProfile, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
                } else {
                    // 프로필이 없으면 회원가입 절차 진행
                    console.log("[listenAuthState] 사용자 프로필 없음, userType으로 이동");
                    showStep('userType');
                }
            } else {
                console.log("[listenAuthState] 이메일 미인증, emailVerification으로 이동");
                if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = currentUser ? currentUser.email : "이메일 정보 없음";
                showStep('emailVerification');
                localStorage.setItem('lozee_tempEmailForVerification', currentUser ? currentUser.email : ''); 
            }
        };

        // 이벤트 핸들러: 인증 메일 재발송
        if (resendVerificationBtn) resendVerificationBtn.onclick = async () => {
            console.log("[resendVerificationBtn] 인증 메일 재발송 시도");
            const emailToResend = localStorage.getItem('lozee_tempEmailForVerification');
            if (!emailToResend && !firebaseAuth.currentUser) {
                showToast("사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.");
                showStep('login');
                return;
            }
            const userToResend = firebaseAuth.currentUser || { email: emailToResend };
            try {
                await sendEmailVerification(userToResend); // Firebase SDK 함수 호출
                showToast("인증 메일을 다시 보냈습니다.");
            } catch (error) {
                console.error("[resendVerificationBtn] 인증 메일 재발송 실패:", error);
                showToast("인증 메일 재발송에 실패했습니다: " + error.message);
            }
        };

        // 이벤트 핸들러: 보호자 신경다양성 선택
        caregiverNdOptionBtns.forEach(button => {
            button.onclick = () => {
                const ndType = button.dataset.nd;
                console.log("[caregiverNdOptionBtns] 신경다양성 선택:", ndType);
                if (ndType === 'unsure_or_none') {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected');
                        tempSelectedCaregiverNd = [];
                    } else {
                        caregiverNdOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        tempSelectedCaregiverNd = [ndType];
                    }
                } else {
                    document.querySelector('.caregiver-nd-btn[data-nd="unsure_or_none"]')?.classList.remove('selected');
                    tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== 'unsure_or_none');
                    button.classList.toggle('selected');
                    if (tempSelectedCaregiverNd.includes(ndType)) {
                        tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== ndType);
                    } else {
                        tempSelectedCaregiverNd.push(ndType);
                    }
                }
                if (caregiverNdError) caregiverNdError.textContent = '';
            };
        });

        // 이벤트 핸들러: 보호자 신경다양성 제출
        if (submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => {
            console.log("[submitCaregiverNdBtn] 보호자 신경다양성 제출:", tempSelectedCaregiverNd);
            if (caregiverNdError) caregiverNdError.textContent = '';
            tempSelectedCaregiverNd = Array.from(document.querySelectorAll('.caregiver-nd-btn.selected')).map(btn => btn.dataset.nd);
            if (tempSelectedCaregiverNd.length === 0) {
                tempSelectedCaregiverNd = ['unsure_or_none'];
            }
            showStep('specialistDiagnosisCaregiver'); // 보호자 본인/자녀 진단 여부 질문으로 이동
        };

        // 이벤트 핸들러: 보호자 및 자녀 전문의 진단 여부
        if (submitSpecialistDiagnosisCaregiverBtn) submitSpecialistDiagnosisCaregiverBtn.onclick = () => {
            console.log("[submitSpecialistDiagnosisCaregiverBtn] 전문의 진단 여부 확인");
            if (specialistDiagnosisCaregiverError) specialistDiagnosisCaregiverError.textContent = '';
            const selectedValue = document.querySelector('input[name="specialistDiagnosisCaregiver"]:checked')?.value;
            if (selectedValue === undefined) {
                if (specialistDiagnosisCaregiverError) specialistDiagnosisCaregiverError.textContent = "선택해주세요.";
                return;
            }
            // 이 단계는 자녀(또는 가족)의 전문의 진단 여부를 묻는 단계입니다.
            tempIsSpecialistDiagnosedChild = (selectedValue === 'true'); // 자녀 전문의 진단 여부로 저장

            // 보호자 본인의 전문의 진단 여부는 아직 입력받지 않았으므로,
            // 이전에 'caregiverNd' 단계에서 'self_asd' 등을 선택했다면,
            // 별도의 질문 단계나 입력 필드가 없다면 현재로서는 정확히 저장하기 어렵습니다.
            // 여기서는 'tempIsSpecialistDiagnosedCaregiver'를 자녀의 것으로 사용하고 있음에 유의.
            // 만약 보호자 본인의 진단 여부가 별도로 필요하면, 새로운 라디오 버튼 세트와 temp 변수가 필요합니다.
            
            console.log("[submitSpecialistDiagnosisCaregiverBtn] 자녀 전문의 진단 여부:", tempIsSpecialistDiagnosedChild);
            populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18);
            showStep('nameBirthChild');
        };

        // 이벤트 핸들러: 본인 신경다양성 선택
        diagnosisOptionBtns.forEach(button => {
            button.onclick = () => {
                const diagnosis = button.dataset.diagnosis;
                console.log("[diagnosisOptionBtns] 신경다양성 선택:", diagnosis);
                const isExclusive = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');
                if (isExclusive) {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected');
                        tempSelectedDiagnoses = [];
                    } else {
                        diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        tempSelectedDiagnoses = [diagnosis];
                    }
                } else {
                    document.querySelector('.diagnosis-btn[data-diagnosis="NotApplicable"]')?.classList.remove('selected');
                    document.querySelector('.diagnosis-btn[data-diagnosis="Unsure"]')?.classList.remove('selected');
                    tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');
                    button.classList.toggle('selected');
                    if (tempSelectedDiagnoses.includes(diagnosis)) {
                        tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== diagnosis);
                    } else {
                        tempSelectedDiagnoses.push(diagnosis);
                    }
                }
                if (diagnosisError) diagnosisError.textContent = '';
            };
        });

        // 이벤트 핸들러: 신경다양성 제출
        if (submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => {
            console.log("[submitDiagnosisBtn] 신경다양성 제출:", tempSelectedDiagnoses);
            if (tempSelectedDiagnoses.length === 0) {
                if (diagnosisError) diagnosisError.textContent = "하나 이상 선택해주세요.";
                return;
            }
            if (diagnosisError) diagnosisError.textContent = '';
            tempSelectedDiagnoses = Array.from(document.querySelectorAll('.diagnosis-btn.selected')).map(btn => btn.dataset.diagnosis);
            showStep('specialistDiagnosisDirectUser');
        };

        // 이벤트 핸들러: 본인 전문의 진단 여부
        if (submitSpecialistDiagnosisDirectUserBtn) submitSpecialistDiagnosisDirectUserBtn.onclick = () => {
            console.log("[submitSpecialistDiagnosisDirectUserBtn] 본인 전문의 진단 여부 확인");
            if (specialistDiagnosisDirectUserError) specialistDiagnosisDirectUserError.textContent = '';
            const selectedValue = document.querySelector('input[name="specialistDiagnosisDirectUser"]:checked')?.value;
            if (selectedValue === undefined) {
                if (specialistDiagnosisDirectUserError) specialistDiagnosisDirectUserError.textContent = "선택해주세요.";
                return;
            }
            tempIsSpecialistDiagnosedDirectUser = (selectedValue === 'true');

            populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90);
            showStep('nameBirthSelf');
        };

        // 이벤트 핸들러: 본인 이름 및 생년월일
        if (submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => {
            console.log("[submitNameBirthSelfBtn] 본인 정보 입력 확인");
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            if (!name) {
                if (nameSelfError) nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.';
                return;
            }
            if (nameSelfError) nameSelfError.textContent = '';
            if (!y || !m || !d) {
                if (birthSelfError) birthSelfError.textContent = '생년월일을 모두 선택해주세요.';
                return;
            }
            if (birthSelfError) birthSelfError.textContent = '';
            const age = calculateAge(y, m, d);
            if (age === null) {
                if (birthSelfError) birthSelfError.textContent = '유효한 생년월일을 입력해주세요.';
                return;
            }
            tempUserName = name;
            tempUserBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            tempUserAge = age;
            showStep('finalStart');
        };

        // 이벤트 핸들러: 자녀 이름 및 생년월일
        if (submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => {
            console.log("[submitNameBirthChildBtn] 자녀 정보 입력 확인");
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
            if (!name) {
                if (nameChildError) nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.';
                return;
            }
            if (nameChildError) nameChildError.textContent = '';
            if (!y || !m || !d) {
                if (birthChildError) birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.';
                return;
            }
            if (birthChildError) birthChildError.textContent = '';
            const age = calculateAge(y,m,d);
            if (age === null) {
                if (birthChildError) birthChildError.textContent = '유효한 생년월일을 입력해주세요.';
                return;
            }
            tempChildName = name;
            tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            tempChildAge = age;
            showStep('finalStart');
        };

        // 이벤트 핸들러: 대화 시작
        if (startLozeeConversationBtn) startLozeeConversationBtn.onclick = async () => {
            console.log("[startLozeeConversationBtn] 대화 시작, 프로필 저장 시도");
            if (!currentUserId) {
                console.error("[startLozeeConversationBtn] 사용자 인증 정보 없음");
                alert("사용자 인증 정보가 없습니다.");
                return;
            }

            let profileData = {
                name: tempUserName, // 사용자 이름
                email: firebaseAuth.currentUser?.email, // 사용자 이메일
                birthDate: tempUserBirthDate, // 사용자 생년월일
                age: tempUserAge, // 사용자 나이
                agreements: { // 약관 동의 정보
                    terms: tempAgreedTerms,
                    privacy: tempAgreedPrivacy,
                    marketing: tempAgreedMarketing,
                    agreedAt: serverTimestamp() // 동의 시간
                },
                lastUpdate: serverTimestamp(),
                userType: [], // userType을 배열로 초기화
                role: selectedUserType === 'caregiver' ? 'parent' : 'self',
                diagnoses: [], // directUser의 신경다양성 진단 정보 (기본값)
                isDirectUserDiagnosedBySpecialist: false // directUser의 전문의 진단 여부 (기본값)
            };

            // userType 배열에 선택된 유형 추가 (예: ['caregiver'] 또는 ['directUser'])
            profileData.userType.push(selectedUserType);

            // 보호자가 본인도 신경다양성 특성을 선택한 경우 'directUser' 추가
            const isCaregiverNeurodiverse = tempSelectedCaregiverNd.length > 0 && !tempSelectedCaregiverNd.includes('unsure_or_none');
            if (selectedUserType === 'caregiver' && isCaregiverNeurodiverse) {
                profileData.userType.push('directUser');
            }

            let ageForTalkContext;
            let childDataForRedirect = null;

            if (selectedUserType === 'caregiver') {
                profileData.caregiverInfo = {
                    caregiverNeurodiversity: tempSelectedCaregiverNd,
                    isCaregiverDiagnosedBySpecialist: tempIsSpecialistDiagnosedCaregiver, // 보호자 본인 전문의 진단
                    childName: tempChildName,
                    childBirthDate: tempChildBirthDate,
                    childAge: tempChildAge,
                    childDiagnoses: tempSelectedDiagnoses, // 자녀의 진단명
                    isChildDiagnosedBySpecialist: tempIsSpecialistDiagnosedChild // 자녀 전문의 진단
                };
                profileData.diagnoses = []; // caregiver는 본인 diagnoses는 비워둠
                ageForTalkContext = tempChildAge;
                childDataForRedirect = profileData.caregiverInfo;
            } else { // directUser
                profileData.diagnoses = tempSelectedDiagnoses;
                profileData.isDirectUserDiagnosedBySpecialist = tempIsSpecialistDiagnosedDirectUser;
                ageForTalkContext = profileData.age;
            }

            const saveSuccess = await saveUserProfile(currentUserId, profileData);
            if (saveSuccess) {
                console.log("[startLozeeConversationBtn] 프로필 저장 성공, 리다이렉트");
                setLocalStorageAndRedirect(profileData, ageForTalkContext, childDataForRedirect, isCaregiverNeurodiverse);
            } else {
                console.error("[startLozeeConversationBtn] 프로필 저장 실패");
                alert("프로필 저장에 실패했습니다. 다시 시도해주세요.");
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DOMContentLoaded] Index.html 로드 완료");
            // jQuery <path> 오류 방어 코드
            console.log("[DOMContentLoaded] jQuery 확인:", typeof window.jQuery !== 'undefined' ? "jQuery 로드됨" : "jQuery 로드되지 않음");
            const paths = document.querySelectorAll('path');
            paths.forEach(path => {
                try {
                    const dValue = path.getAttribute('d');
                    if (dValue && !dValue.match(/^[MLHVCSQTAmlhvcsqta][0-9,. -]*$/)) {
                        console.warn("[SVG Debug] 유효하지 않은 path d 속성:", dValue);
                        path.setAttribute('d', 'M0,0 L10,10');
                    }
                } catch (e) {
                    console.error("[SVG Debug] path 처리 오류:", e);
                }
            });

            // Firebase 인증 상태 감지 시작
            listenAuthState(
                async (user, userProfile) => {
                    console.log("[listenAuthState] 로그인 상태 감지. UID:", user.uid);
                    currentUserId = user.uid;
                    if (!user.emailVerified) {
                        showToast('이메일 인증이 필요합니다. 인증 이메일을 확인해주세요.');
                        showStep('emailVerification');
                        return;
                    }
                    if (userProfile && userProfile.userType) { // userProfile의 userType 필드 존재 여부 확인
                        const userProfileForRedirect = { ...userProfile }; 
                        if (typeof userProfileForRedirect.userType === 'string') {
                            userProfileForRedirect.userType = [userProfileForRedirect.userType];
                            if (userProfileForRedirect.userType[0] === 'caregiver' && 
                                userProfileForRedirect.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                                !userProfileForRedirect.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                                    userProfileForRedirect.userType.push('directUser');
                            }
                        }

                        let ageForTalk = userProfileForRedirect.age;
                        let childDataForRedirect = null;
                        let isCaregiverNeurodiverse = false;

                        if (userProfileForRedirect.caregiverInfo) {
                            isCaregiverNeurodiverse = userProfileForRedirect.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                                !userProfileForRedirect.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                        }

                        if (Array.isArray(userProfileForRedirect.userType) && userProfileForRedirect.userType.includes('caregiver') && userProfileForRedirect.caregiverInfo) { 
                            ageForTalk = userProfileForRedirect.caregiverInfo.childAge;
                            childDataForRedirect = userProfileForRedirect.caregiverInfo;
                        } 
                        setLocalStorageAndRedirect(userProfileForRedirect, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
                    } else {
                        console.log("[listenAuthState] 사용자 프로필 없음, userType으로 이동");
                        showStep('userType');
                    }
                },
                () => {
                    console.log("[listenAuthState] 로그아웃 상태입니다.");
                    currentUserId = null;
                    clearInputFields();
                    showStep('authChoice');
                    showToast('로그아웃 상태입니다.');
                },
                clearInputFields,
                showStep
            ); 

            // 이벤트 핸들러: 회원가입
            if (signUpButton) {
                signUpButton.addEventListener('click', async () => {
                    console.log("[signUpButton] 회원가입 시도");
                    const email = emailInput.value.trim();
                    const password = passwordInput.value.trim();
                    const passwordConfirm = password; // 또는 별도 입력 필드를 추가
                    
                    if (!email || !password || !passwordConfirm) {
                        showToast("이메일과 비밀번호를 입력해주세요.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        showToast("비밀번호가 일치하지 않습니다.");
                        return;
                    }
                    if (password.length < 6) {
                        showToast("비밀번호는 6자리 이상이어야 합니다.");
                        return;
                    }

                    signUpButton.disabled = true;
                    signUpButton.textContent = "가입 중...";

                    const { user, error } = await signUpWithEmail(email, password);

                    signUpButton.disabled = false;
                    signUpButton.textContent = "회원가입";

                    if (error) {
                        console.error("[signUpButton] 계정 생성 실패:", error);
                        let errorMessage = "계정 생성 실패: ";
                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                errorMessage += `이미 사용 중인 이메일입니다. <a href="#" id="goToLoginLink" style="color: #fff; text-decoration: underline;">로그인 페이지로 이동</a>`;
                                break;
                            case 'auth/invalid-email':
                                errorMessage += "유효하지 않은 이메일 형식입니다.";
                                break;
                            case 'auth/weak-password':
                                errorMessage += "비밀번호가 너무 약합니다. 6자리 이상으로 설정해주세요.";
                                break;
                            default:
                                errorMessage += error.message;
                        }
                        if (signUpErrorEl) {
                            signUpErrorEl.innerHTML = errorMessage;
                            const goToLoginLink = document.getElementById('goToLoginLink');
                            if (goToLoginLink) {
                                goToLoginLink.onclick = (e) => {
                                    e.preventDefault();
                                    clearInputFields();
                                    showStep('login');
                                };
                            }
                        }
                    } else if (user) {
                        if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                        showStep('emailVerification');
                    }
                });
            }

            // 이벤트 핸들러: 로그인
            if (signInButton) {
                signInButton.addEventListener('click', async () => {
                    console.log("[signInButton] 로그인 시도");
                    const email = emailInput.value.trim();
                    const password = passwordInput.value.trim();
                    if (!email || !password) {
                        showToast('이메일과 비밀번호를 입력해주세요.');
                        return;
                    }
                    signInButton.disabled = true;
                    signInButton.textContent = "로그인 중...";
                    const { user, error } = await signInWithEmail(email, password);
                    signInButton.disabled = false;
                    signInButton.textContent = "로그인";
                    if (error) {
                        console.error("[signInButton] 로그인 실패:", error);
                        showToast(`로그인 실패: ${error.message}`);
                    } else if (user) {
                        if (user.emailVerified) { // 이메일 인증이 이미 되어있으면
                            const userDoc = await getDoc(doc(db, 'users', user.uid));
                            if (userDoc.exists() && userDoc.data().userType) {
                                const userProfile = userDoc.data();
                                let ageForTalk = userProfile.age;
                                let childDataForRedirect = null;
                                let isCaregiverNeurodiverse = false;

                                // userType이 단일 문자열인 레거시 데이터를 배열로 변환
                                if (typeof userProfile.userType === 'string') {
                                    userProfile.userType = [userProfile.userType];
                                    if (userProfile.userType[0] === 'caregiver' && 
                                        userProfile.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                                        !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                                        userProfile.userType.push('directUser');
                                    }
                                }

                                if (Array.isArray(userProfile.userType) && userProfile.userType.includes('caregiver') && userProfile.caregiverInfo) { 
                                    ageForTalk = userProfile.caregiverInfo.childAge;
                                    childDataForRedirect = userProfile.caregiverInfo;
                                    isCaregiverNeurodiverse = userProfile.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                                        !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                                }
                                setLocalStorageAndRedirect(userProfile, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
                            } else {
                                console.log("[signInButton] 사용자 프로필 없음 또는 userType 누락, userType으로 이동");
                                showStep('userType');
                            }
                        } else {
                            console.log("[signInButton] 이메일 미인증, emailVerification으로 이동");
                            if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = user.email;
                            showStep('emailVerification');
                        }
                    }
                });
            }

            // 이벤트 핸들러: 비밀번호 재설정 이메일 발송
            if (sendResetEmailBtn) sendResetEmailBtn.onclick = async () => {
                console.log("[sendResetEmailBtn] 비밀번호 재설정 이메일 발송 시도");
                const email = resetEmailInput.value.trim();
                if (resetErrorEl) resetErrorEl.textContent = '';
                if (resetSuccessEl) resetSuccessEl.textContent = '';
                if (!email) {
                    if (resetErrorEl) resetErrorEl.textContent = "이메일을 입력해주세요.";
                    return;
                }
                sendResetEmailBtn.disabled = true;
                sendResetEmailBtn.textContent = "발송 중...";
                try {
                    await resetPassword(email); 
                    if (resetSuccessEl) {
                        resetSuccessEl.textContent = "비밀번호 재설정 이메일을 보냈습니다. 이메일함을 확인해주세요. (등록된 계정이 없는 경우 메일이 발송되지 않을 수 있습니다.)";
                    }
                    console.log("비밀번호 재설정 이메일 전송 요청 완료 (Firebase는 사용자 존재 여부 숨김)");
                } catch (error) {
                    console.error("[sendResetEmailBtn] 비밀번호 재설정 이메일 전송 실패:", error);
                    if (resetErrorEl) {
                        resetErrorEl.textContent = "이메일 발송에 실패했습니다: " + (error ? error.message : "알 수 없는 오류");
                    }
                } finally {
                    sendResetEmailBtn.disabled = false;
                    sendResetEmailBtn.textContent = "재설정 이메일 발송";
                }
            };

            // 이벤트 핸들러: 사용자 유형 선택
            userTypeButtons.forEach(button => { 
                button.onclick = () => { 
                    selectedUserType = button.dataset.usertype; 
                    showStep('termsAgreement'); 
                }; 
            });
            
            // 이벤트 핸들러: 약관 동의
            if (submitTermsBtn) submitTermsBtn.onclick = () => {
                console.log("[submitTermsBtn] 약관 동의 확인");
                if (termsErrorEl) termsErrorEl.textContent = '';
                if (!agreeTermsCheckbox.checked || !agreePrivacyCheckbox.checked) { 
                    if (termsErrorEl) termsErrorEl.textContent = "필수 약관에 모두 동의해주세요."; 
                    return; 
                }
                tempAgreedTerms = agreeTermsCheckbox.checked; 
                tempAgreedPrivacy = agreePrivacyCheckbox.checked; 
                tempAgreedMarketing = agreeMarketingCheckbox.checked;
                showStep('signUpEmailPassword');
            };
            
            // 이벤트 핸들러: 계정 생성
            if (createAccountBtn) createAccountBtn.onclick = async () => {
                console.log("[createAccountBtn] 계정 생성 시도");
                const email = signUpEmailInput.value.trim();
                const password = signUpPasswordInput.value;
                const passwordConfirm = signUpPasswordConfirmInput.value;
                if (signUpErrorEl) signUpErrorEl.textContent = '';
                if (!email || !password || !passwordConfirm) { 
                    if (signUpErrorEl) signUpErrorEl.textContent = "모든 필드를 입력해주세요."; 
                    return; 
                }
                if (password !== passwordConfirm) { 
                    if (signUpErrorEl) signUpErrorEl.textContent = "비밀번호가 일치하지 않습니다."; 
                    return; 
                } 
                if (password.length < 6) { 
                    if (signUpErrorEl) signUpErrorEl.textContent = "비밀번호는 6자리 이상이어야 합니다."; 
                    return; 
                }
                createAccountBtn.disabled = true;
                createAccountBtn.textContent = "계정 생성 중...";
                const { user, error } = await signUpWithEmail(email, password);
                createAccountBtn.disabled = false;
                createAccountBtn.textContent = "계정 생성 및 인증 메일 발송";
                if (error) {
                    console.error("[createAccountBtn] 계정 생성 실패:", error);
                    let errorMessage = "계정 생성 실패: ";
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage += `이미 사용 중인 이메일입니다. <a href="#" id="goToLoginLink" style="color: #fff; text-decoration: underline;">로그인 페이지로 이동</a>`;
                            break;
                        case 'auth/invalid-email':
                            errorMessage += "유효하지 않은 이메일 형식입니다.";
                            break;
                        case 'auth/weak-password':
                            errorMessage += "비밀번호가 너무 약합니다. 6자리 이상으로 설정해주세요.";
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    if (signUpErrorEl) {
                        signUpErrorEl.innerHTML = errorMessage;
                        const goToLoginLink = document.getElementById('goToLoginLink');
                        if (goToLoginLink) {
                            goToLoginLink.onclick = (e) => {
                                e.preventDefault();
                                clearInputFields();
                                showStep('login');
                            };
                        }
                    }
                } else if (user) {
                    if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                    showStep('emailVerification');
                }
            };

            // 이벤트 핸들러: 이메일 인증 확인
            if (checkVerificationBtn) checkVerificationBtn.onclick = async () => {
                console.log("[checkVerificationBtn] 이메일 인증 확인");
                const currentUser = firebaseAuth.currentUser;
                if (!currentUser) { 
                    console.log("[checkVerificationBtn] 현재 사용자 없음, 로그인 페이지로 이동");
                    if (verificationErrorEl) verificationErrorEl.textContent = "사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요."; 
                    showStep('login'); 
                    return; 
                }
                checkVerificationBtn.disabled = true;
                checkVerificationBtn.textContent = "확인 중...";
                await currentUser.reload();
                checkVerificationBtn.disabled = false;
                checkVerificationBtn.textContent = "이메일 인증 완료";
                if (currentUser.emailVerified) {
                    console.log("[checkVerificationBtn] 이메일 인증 완료, 사용자 ID:", currentUser.uid);
                    currentUserId = currentUser.uid; 
                    localStorage.setItem('lozee_userId', currentUserId);
                    if (verificationErrorEl) verificationErrorEl.textContent = '';
                    
                    const userDoc = await getDoc(doc(db, 'users', currentUserId));
                    if (userDoc.exists() && userDoc.data().userType) { 
                        const userProfile = userDoc.data();
                        let ageForTalk = userProfile.age;
                        let childDataForRedirect = null;
                        let isCaregiverNeurodiverse = false;

                        // userType이 단일 문자열인 레거시 데이터를 배열로 변환
                        if (typeof userProfile.userType === 'string') {
                            userProfile.userType = [userProfile.userType];
                            if (userProfile.userType[0] === 'caregiver' && 
                                userProfile.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                                !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                                    userProfile.userType.push('directUser');
                            }
                        }

                        if (Array.isArray(userProfile.userType) && userProfile.userType.includes('caregiver') && userProfile.caregiverInfo) { 
                            ageForTalk = userProfile.caregiverInfo.childAge;
                            childDataForRedirect = userProfile.caregiverInfo;
                            isCaregiverNeurodiverse = userProfile.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                                !userProfile.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                        }
                        setLocalStorageAndRedirect(userProfile, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
                    } else {
                        console.log("[listenAuthState] 사용자 프로필 없음, userType으로 이동");
                        showStep('userType');
                    }
                } else {
                    console.log("[listenAuthState] 이메일 미인증, emailVerification으로 이동");
                    if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = currentUser ? currentUser.email : "이메일 정보 없음";
                    showStep('emailVerification');
                    localStorage.setItem('lozee_tempEmailForVerification', currentUser ? currentUser.email : ''); 
                }
            };

            // 이벤트 핸들러: 인증 메일 재발송
            if (resendVerificationBtn) resendVerificationBtn.onclick = async () => {
                console.log("[resendVerificationBtn] 인증 메일 재발송 시도");
                const emailToResend = localStorage.getItem('lozee_tempEmailForVerification');
                if (!emailToResend && !firebaseAuth.currentUser) {
                    showToast("사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.");
                    showStep('login');
                    return;
                }
                const userToResend = firebaseAuth.currentUser || { email: emailToResend };
                try {
                    await sendEmailVerification(userToResend); // Firebase SDK 함수 호출
                    showToast("인증 메일을 다시 보냈습니다.");
                } catch (error) {
                    console.error("[resendVerificationBtn] 인증 메일 재발송 실패:", error);
                    showToast("인증 메일 재발송에 실패했습니다: " + error.message);
                }
            };

            // 이벤트 핸들러: 보호자 신경다양성 선택
            caregiverNdOptionBtns.forEach(button => {
                button.onclick = () => {
                    const ndType = button.dataset.nd;
                    console.log("[caregiverNdOptionBtns] 신경다양성 선택:", ndType);
                    if (ndType === 'unsure_or_none') {
                        if (button.classList.contains('selected')) {
                            button.classList.remove('selected');
                            tempSelectedCaregiverNd = [];
                        } else {
                            caregiverNdOptionBtns.forEach(btn => btn.classList.remove('selected'));
                            button.classList.add('selected');
                            tempSelectedCaregiverNd = [ndType];
                        }
                    } else {
                        document.querySelector('.caregiver-nd-btn[data-nd="unsure_or_none"]')?.classList.remove('selected');
                        tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== 'unsure_or_none');
                        button.classList.toggle('selected');
                        if (tempSelectedCaregiverNd.includes(ndType)) {
                            tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== ndType);
                        } else {
                            tempSelectedCaregiverNd.push(ndType);
                        }
                    }
                    if (caregiverNdError) caregiverNdError.textContent = '';
                };
            });

            // 이벤트 핸들러: 보호자 신경다양성 제출
            if (submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => {
                console.log("[submitCaregiverNdBtn] 보호자 신경다양성 제출:", tempSelectedCaregiverNd);
                if (caregiverNdError) caregiverNdError.textContent = '';
                tempSelectedCaregiverNd = Array.from(document.querySelectorAll('.caregiver-nd-btn.selected')).map(btn => btn.dataset.nd);
                if (tempSelectedCaregiverNd.length === 0) {
                    tempSelectedCaregiverNd = ['unsure_or_none'];
                }
                showStep('specialistDiagnosisCaregiver'); // 보호자 본인/자녀 진단 여부 질문으로 이동
            };

            // 이벤트 핸들러: 보호자 및 자녀 전문의 진단 여부
            if (submitSpecialistDiagnosisCaregiverBtn) submitSpecialistDiagnosisCaregiverBtn.onclick = () => {
                console.log("[submitSpecialistDiagnosisCaregiverBtn] 전문의 진단 여부 확인");
                if (specialistDiagnosisCaregiverError) specialistDiagnosisCaregiverError.textContent = '';
                const selectedValue = document.querySelector('input[name="specialistDiagnosisCaregiver"]:checked')?.value;
                if (selectedValue === undefined) {
                    if (specialistDiagnosisCaregiverError) specialistDiagnosisCaregiverError.textContent = "선택해주세요.";
                    return;
                }
                tempIsSpecialistDiagnosedCaregiver = (selectedValue === 'true'); // 보호자 본인의 전문의 진단 여부 (현재 이렇게 매핑됨)
                tempIsSpecialistDiagnosedChild = (selectedValue === 'true'); // 자녀의 전문의 진단 여부 (같은 라디오 버튼이므로 같은 값으로 매핑)
                console.log("[submitSpecialistDiagnosisCaregiverBtn] 보호자 전문의 진단 여부:", tempIsSpecialistDiagnosedCaregiver);
                console.log("[submitSpecialistDiagnosisCaregiverBtn] 자녀 전문의 진단 여부:", tempIsSpecialistDiagnosedChild);
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18);
                showStep('nameBirthChild');
            };

            // 이벤트 핸들러: 본인 신경다양성 선택
            diagnosisOptionBtns.forEach(button => {
                button.onclick = () => {
                    const diagnosis = button.dataset.diagnosis;
                    console.log("[diagnosisOptionBtns] 신경다양성 선택:", diagnosis);
                    const isExclusive = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');
                    if (isExclusive) {
                        if (button.classList.contains('selected')) {
                            button.classList.remove('selected');
                            tempSelectedDiagnoses = [];
                        } else {
                            diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                            button.classList.add('selected');
                            tempSelectedDiagnoses = [diagnosis];
                        }
                    } else {
                        document.querySelector('.diagnosis-btn[data-diagnosis="NotApplicable"]')?.classList.remove('selected');
                        document.querySelector('.diagnosis-btn[data-diagnosis="Unsure"]')?.classList.remove('selected');
                        tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');
                        button.classList.toggle('selected');
                        if (tempSelectedDiagnoses.includes(diagnosis)) {
                            tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== diagnosis);
                        } else {
                            tempSelectedDiagnoses.push(diagnosis);
                        }
                    }
                    if (diagnosisError) diagnosisError.textContent = '';
                };
            });

            // 이벤트 핸들러: 신경다양성 제출
            if (submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => {
                console.log("[submitDiagnosisBtn] 신경다양성 제출:", tempSelectedDiagnoses);
                if (tempSelectedDiagnoses.length === 0) {
                    if (diagnosisError) diagnosisError.textContent = "하나 이상 선택해주세요.";
                    return;
                }
                if (diagnosisError) diagnosisError.textContent = '';
                tempSelectedDiagnoses = Array.from(document.querySelectorAll('.diagnosis-btn.selected')).map(btn => btn.dataset.diagnosis);
                showStep('specialistDiagnosisDirectUser');
            };

            // 이벤트 핸들러: 본인 전문의 진단 여부
            if (submitSpecialistDiagnosisDirectUserBtn) submitSpecialistDiagnosisDirectUserBtn.onclick = () => {
                console.log("[submitSpecialistDiagnosisDirectUserBtn] 본인 전문의 진단 여부 확인");
                if (specialistDiagnosisDirectUserError) specialistDiagnosisDirectUserError.textContent = '';
                const selectedValue = document.querySelector('input[name="specialistDiagnosisDirectUser"]:checked')?.value;
                if (selectedValue === undefined) {
                    if (specialistDiagnosisDirectUserError) specialistDiagnosisDirectUserError.textContent = "선택해주세요.";
                    return;
                }
                tempIsSpecialistDiagnosedDirectUser = (selectedValue === 'true');

                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90);
                showStep('nameBirthSelf');
            };

            // 이벤트 핸들러: 본인 이름 및 생년월일
            if (submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => {
                console.log("[submitNameBirthSelfBtn] 본인 정보 입력 확인");
                const name = nameSelfInput.value.trim();
                const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
                if (!name) {
                    if (nameSelfError) nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.';
                    return;
                }
                if (nameSelfError) nameSelfError.textContent = '';
                if (!y || !m || !d) {
                    if (birthSelfError) birthSelfError.textContent = '생년월일을 모두 선택해주세요.';
                    return;
                }
                if (birthSelfError) birthSelfError.textContent = '';
                const age = calculateAge(y, m, d);
                if (age === null) {
                    if (birthSelfError) birthSelfError.textContent = '유효한 생년월일을 입력해주세요.';
                    return;
                }
                tempUserName = name;
                tempUserBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                tempUserAge = age;
                showStep('finalStart');
            };

            // 이벤트 핸들러: 자녀 이름 및 생년월일
            if (submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => {
                console.log("[submitNameBirthChildBtn] 자녀 정보 입력 확인");
                const name = nameChildInput.value.trim();
                const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
                if (!name) {
                    if (nameChildError) nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.';
                    return;
                }
                if (nameChildError) nameChildError.textContent = '';
                if (!y || !m || !d) {
                    if (birthChildError) birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.';
                    return;
                }
                if (birthChildError) birthChildError.textContent = '';
                const age = calculateAge(y,m,d);
                if (age === null) {
                    if (birthChildError) birthChildError.textContent = '유효한 생년월일을 입력해주세요.';
                    return;
                }
                tempChildName = name;
                tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                tempChildAge = age;
                showStep('finalStart');
            };

            // 이벤트 핸들러: 대화 시작
            if (startLozeeConversationBtn) startLozeeConversationBtn.onclick = async () => {
                console.log("[startLozeeConversationBtn] 대화 시작, 프로필 저장 시도");
                if (!currentUserId) {
                    console.error("[startLozeeConversationBtn] 사용자 인증 정보 없음");
                    alert("사용자 인증 정보가 없습니다.");
                    return;
                }

                let profileData = {
                    name: tempUserName, // 사용자 이름
                    email: firebaseAuth.currentUser?.email, // 사용자 이메일
                    birthDate: tempUserBirthDate, // 사용자 생년월일
                    age: tempUserAge, // 사용자 나이
                    agreements: { // 약관 동의 정보
                        terms: tempAgreedTerms,
                        privacy: tempAgreedPrivacy,
                        marketing: tempAgreedMarketing,
                        agreedAt: serverTimestamp() // 동의 시간
                    },
                    lastUpdate: serverTimestamp(),
                    userType: [], // userType을 배열로 초기화
                    role: selectedUserType === 'caregiver' ? 'parent' : 'self',
                    diagnoses: [], // directUser의 신경다양성 진단 정보 (기본값)
                    isDirectUserDiagnosedBySpecialist: false // directUser의 전문의 진단 여부 (기본값)
                };

                // userType 배열에 선택된 유형 추가 (예: ['caregiver'] 또는 ['directUser'])
                profileData.userType.push(selectedUserType);

                // 보호자가 본인도 신경다양성 특성을 선택한 경우 'directUser' 추가
                const isCaregiverNeurodiverse = tempSelectedCaregiverNd.length > 0 && !tempSelectedCaregiverNd.includes('unsure_or_none');
                if (selectedUserType === 'caregiver' && isCaregiverNeurodiverse) {
                    profileData.userType.push('directUser');
                }

                let ageForTalkContext;
                let childDataForRedirect = null;

                if (selectedUserType === 'caregiver') {
                    profileData.caregiverInfo = {
                        caregiverNeurodiversity: tempSelectedCaregiverNd,
                        isCaregiverDiagnosedBySpecialist: tempIsSpecialistDiagnosedCaregiver, // 보호자 본인 전문의 진단
                        childName: tempChildName,
                        childBirthDate: tempChildBirthDate,
                        childAge: tempChildAge,
                        childDiagnoses: tempSelectedDiagnoses, // 자녀의 진단명
                        isChildDiagnosedBySpecialist: tempIsSpecialistDiagnosedChild // 자녀 전문의 진단
                    };
                    profileData.diagnoses = []; // caregiver는 본인 diagnoses는 비워둠
                    ageForTalkContext = tempChildAge;
                    childDataForRedirect = profileData.caregiverInfo;
                } else { // directUser
                    profileData.diagnoses = tempSelectedDiagnoses;
                    profileData.isDirectUserDiagnosedBySpecialist = tempIsSpecialistDiagnosedDirectUser;
                    ageForTalkContext = profileData.age;
                }

                const saveSuccess = await saveUserProfile(currentUserId, profileData);
                if (saveSuccess) {
                    console.log("[startLozeeConversationBtn] 프로필 저장 성공, 리다이렉트");
                    setLocalStorageAndRedirect(profileData, ageForTalkContext, childDataForRedirect, isCaregiverNeurodiverse);
                } else {
                    console.error("[startLozeeConversationBtn] 프로필 저장 실패");
                    alert("프로필 저장에 실패했습니다. 다시 시도해주세요.");
                }
            };
        });
    </script>
</body>
</html>