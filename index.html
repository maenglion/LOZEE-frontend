<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¨ ë‚˜ì˜ ë¡œì§€ ë³´ê´€í•¨ - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* mypage.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
            --profile-placeholder-bg: #d0d9ff;
        }
        body {
            margin: 0;
            padding-top: var(--gnb-height); /* gnb.cssì— ì—†ë‹¤ë©´ í•„ìš” */
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        .page-title { color: var(--primary-color); text-align: center; font-size: 2em; margin-bottom: 30px; font-weight: 700; }
        
        .profile-section { /* í”„ë¡œí•„ ì¹´ë“œì™€ ê¸°ë³¸ ì •ë³´ ì¹´ë“œë¥¼ ë¬¶ëŠ” ì»¨í…Œì´ë„ˆ */
            display: grid;
            grid-template-columns: auto 1fr; /* ì‚¬ì§„ | ì´ë¦„/ì´ë©”ì¼/ë‚˜ì´/ì ‘ì†ì¼/ëŒ€í™”íšŸìˆ˜ */
            gap: 20px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            align-items: center;
        }
        .profile-photo-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .profile-photo-placeholder { width: 100px; height: 100px; border-radius: 50%; background-color: var(--profile-placeholder-bg); display: flex; align-items: center; justify-content: center; font-size: 2em; color: white; font-weight: bold; }
        .profile-photo-placeholder img { width:100%; height:100%; border-radius:50%; object-fit:cover;}

        .profile-details h2 { font-size: 1.5em; color: var(--primary-color); margin-top: 0; margin-bottom: 5px; text-align:left;}
        .profile-details .user-email { font-size: 0.9em; color: #777; margin-bottom:15px; text-align:left;}
        
        .info-grid { /* ë‚˜ë¨¸ì§€ ì •ë³´ ì¹´ë“œë“¤ì„ ìœ„í•œ ê·¸ë¦¬ë“œ */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info-card h2 { font-size: 1.2em; color: var(--primary-color); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; text-align:left;}
        
        .info-item { margin-bottom: 10px; font-size: 1em; display: flex; justify-content: space-between; align-items: baseline;}
        .info-item .label { font-weight: bold; color: #555; margin-right: 10px; white-space: nowrap; }
        .info-item .value { color: var(--text-color); text-align: right; word-break: keep-all; }
        
        .neurodiversity-info ul { list-style: none; padding:0; margin:0; text-align:left; }
        .neurodiversity-info li { background-color: #e9eaf6; color: #3f51b5; padding: 6px 10px; border-radius: 15px; font-size: 0.9em; display: inline-block; margin-right: 8px; margin-bottom: 8px;}

        .plans-card ul { list-style: none; padding: 0; text-align: left; }
        .plans-card li { background-color: #eef2f7; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.95em; }
        
        .recent-journals-title { font-size: 1.4em; color: var(--primary-color); margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; text-align: center; }
        .recent-journal-card-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .journal-card { background-color: var(--card-bg); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); border-radius: 12px; padding: 15px; box-sizing: border-box; text-align: left; }
        .journal-card .topic { font-size: 1em; font-weight: bold; color: var(--primary-color); margin-bottom: 5px;}
        .journal-card .emotion { font-size: 0.85em; color: #555; margin-bottom: 8px; font-style:italic;}
        .journal-card .summary { font-size: 0.9em; color: #444; max-height: 3.2em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;}

        @media (max-width: 700px) {
            .profile-section {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì—ì„œëŠ” í”„ë¡œí•„ ì‚¬ì§„ê³¼ ì •ë³´ê°€ ì„¸ë¡œë¡œ */
                text-align: center;
            }
            .profile-details h2, .profile-details .user-email {
                text-align: center;
            }
            .info-item {
                flex-direction: column; /* ë ˆì´ë¸”ê³¼ ê°’ì„ ì„¸ë¡œë¡œ */
                align-items: flex-start;
            }
            .info-item .value {
                text-align: left;
            }
        }
        @media (max-width: 600px) { .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <h1 id="pageMainTitle" class="page-title">ğŸ¨ ë‚˜ì˜ ë¡œì§€ ë³´ê´€í•¨</h1>

        <div class="profile-section">
            <div class="profile-photo-container">
                <div id="userPhotoPlaceholder" class="profile-photo-placeholder"></div>
            </div>
            <div class="profile-details">
                <h2 id="userNameDisplay">ë¡œë”© ì¤‘...</h2>
                <p id="userEmailDisplay" class="user-email">ë¡œë”© ì¤‘...</p>
                <div class="info-item"><span class="label" id="ageLabel">ë§Œ ë‚˜ì´:</span> <span id="userFullAge" class="value">ë¡œë”© ì¤‘...</span></div>
                <div class="info-item"><span class="label">ë§ˆì§€ë§‰ ì ‘ì†:</span> <span id="lastLoginDate" class="value">ë¡œë”© ì¤‘...</span></div>
                <div class="info-item"><span class="label" id="sessionCountLabel">ë¡œì§€ì™€ì˜ ì´ ëŒ€í™”:</span> <span id="totalSessionsCount" class="value">ë¡œë”© ì¤‘...</span></div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card neurodiversity-info" id="directUserDiagnosisCard" style="display:none;">
                <h2>âœ¨ ë‚˜ì˜ íŠ¹ì„± ì´í•´í•˜ê¸°</h2>
                <ul id="userDiagnosesList"><li>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
            </div>
            
            <div class="info-card neurodiversity-info" id="caregiverPersonalNDCard" style="display:none;">
                <h2>ğŸ™‹â€â™€ï¸ ë³´í˜¸ìë‹˜ íŠ¹ì„± ì´í•´</h2>
                <p class="module-explanation" style="font-size: 0.85em; text-align:left;">ë³¸ì¸ ë˜ëŠ” ë°°ìš°ìì˜ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±ì„ ì´í•´í•˜ëŠ” ê²ƒì€ ì–‘ìœ¡ê³¼ ê´€ê³„ì— ì¤‘ìš”í•œ ì²«ê±¸ìŒì´ ë  ìˆ˜ ìˆì–´ìš”.</p>
                <ul id="caregiverPersonalNeurodiversityList"><li>ì •ë³´ ì—†ìŒ</li></ul>
            </div>

            <div class="info-card neurodiversity-info" id="childInfoCard" style="display:none;">
                <h2>ğŸ§¸ ì•„ì´/ê°€ì¡± ì •ë³´</h2>
                <p class="info-item"><span class="label">ì´ë¦„:</span> <span id="childNameDisplay" class="value">ë¡œë”© ì¤‘...</span></p>
                <p class="info-item"><span class="label">ë§Œ ë‚˜ì´:</span> <span id="childFullAge" class="value">ë¡œë”© ì¤‘...</span></p>
                <p class="info-item"><span class="label">íŠ¹ì„± ì´í•´:</span></p>
                <ul id="childDiagnosesList" style="margin-top: -5px; margin-bottom:10px; text-align:left;"><li>ì •ë³´ ì—†ìŒ</li></ul>
                <p class="info-item" style="margin-top:15px;"><span class="label">ì—°ê²°ëœ ë¡œì§€ ê³„ì •:</span> <span id="childLozeeEmailDisplay" class="value">ì •ë³´ ì—†ìŒ</span></p>
            </div>
            
            <div class="info-card plans-card">
                <h2>ğŸ¤ ë¡œì§€ì™€ì˜ ì•½ì†!</h2>
                <ul id="lozeePlans">
                    <li style="color:#999; font-style:italic;">ì•„ì§ ë¡œì§€ì™€ì˜ íŠ¹ë³„í•œ ì•½ì†ì€ ì—†ì–´ìš”!</li>
                </ul>
            </div>
        </div>

        <h2 class="recent-journals-title">ğŸ’¬ ìµœê·¼ ë‚˜ëˆˆ ì´ì•¼ê¸° ì‚´ì§ ë³´ê¸°</h2>
        <div class="recent-journal-card-list" id="recentJournalList">
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const userPhotoPlaceholderEl = document.getElementById('userPhotoPlaceholder');
        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const userEmailDisplayEl = document.getElementById('userEmailDisplay');
        const ageLabelEl = document.getElementById('ageLabel');
        const userFullAgeEl = document.getElementById('userFullAge');
        const lastLoginDateEl = document.getElementById('lastLoginDate');
        const sessionCountLabelEl = document.getElementById('sessionCountLabel');
        const totalSessionsCountEl = document.getElementById('totalSessionsCount');
        
        const directUserDiagnosisCardEl = document.getElementById('directUserDiagnosisCard');
        const userDiagnosesListEl = document.getElementById('userDiagnosesList');
        
        const caregiverPersonalNDCardEl = document.getElementById('caregiverPersonalNDCard');
        const caregiverPersonalNeurodiversityListEl = document.getElementById('caregiverPersonalNeurodiversityList');
        
        const childInfoCardEl = document.getElementById('childInfoCard');
        const childNameDisplayEl = document.getElementById('childNameDisplay');
        const childFullAgeEl = document.getElementById('childFullAge');
        const childDiagnosesListEl = document.getElementById('childDiagnosesList');
        const childLozeeEmailDisplayEl = document.getElementById('childLozeeEmailDisplay');
        
        const lozeePlansEl = document.getElementById('lozeePlans');
        const recentJournalListEl = document.getElementById('recentJournalList');
        const reportShareButton = document.getElementById('reportShareButton');


        // --- í—¬í¼ í•¨ìˆ˜ ---
        function calculateAgeFromBirthDate(birthDateStr) {
            if (!birthDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(birthDateStr)) return null;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function getNeurodiversityText(code) {
            const map = {
                "ASD": "ìí ìŠ¤í™íŠ¸ëŸ¼ (ASD)", "ADHD": "ì£¼ì˜ë ¥ ê²°í• ê³¼ì‰í–‰ë™ ì¥ì•  (ADHD)",
                "Asperger": "ì•„ìŠ¤í¼ê±° ì¦í›„êµ°", "Tic": "í‹± ì¥ì• ", "LD": "í•™ìŠµ ì¥ì• ",
                "Else": "ê¸°íƒ€ ì–´ë ¤ì›€/ê¶ê¸ˆì¦", "Unsure": "ì•„ì§ ì˜ ëª¨ë¦„/ì§„ë‹¨ ì—†ìŒ",
                "NotApplicable": "íŠ¹ë³„íˆ í•´ë‹¹ ì—†ìŒ",
                "self_asd": "ë³¸ì¸: ìí ìŠ¤í™íŠ¸ëŸ¼(ASD) ì„±í–¥", "self_adhd": "ë³¸ì¸: ADHD ì„±í–¥",
                "spouse_asd": "ë°°ìš°ì/ê´€ê³„ì¸: ìí ìŠ¤í™íŠ¸ëŸ¼(ASD) ì„±í–¥",
                "spouse_adhd": "ë°°ìš°ì/ê´€ê³„ì¸: ADHD ì„±í–¥",
                "self_else": "ë³¸ì¸: ê¸°íƒ€ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±",
                "spouse_else": "ë°°ìš°ì/ê´€ê³„ì¸: ê¸°íƒ€ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±",
                "unsure_or_none": "ì˜ ëª¨ë¥´ê±°ë‚˜ í•´ë‹¹ ì‚¬í•­ ì—†ìŒ"
            };
            return map[code] || code;
        }

        // --- ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ë° í‘œì‹œ ---
        async function loadUserProfile() {
            const loggedInUserEmail = localStorage.getItem('cbtUserEmail') || ''; // Firestore users ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œ ID
            const userType = localStorage.getItem('lozee_userType') || ''; 

            if (!loggedInUserEmail || !userType) {
                if(userNameDisplayEl) userNameDisplayEl.textContent = 'ë¡œê·¸ì¸ ì •ë³´ê°€ í•„ìš”í•´ìš”.';
                if(pageMainTitleEl) pageMainTitleEl.textContent = 'ë‚´ ì •ë³´';
                if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';
                if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                if(childInfoCardEl) childInfoCardEl.style.display = 'none';
                return;
            }

            if(userEmailDisplayEl) userEmailDisplayEl.textContent = loggedInUserEmail;

            const userRef = doc(db, 'users', loggedInUserEmail);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    let profileName, profileAge, profileBirthDate;

                    if (userType === 'caregiver') {
                        // ë³´í˜¸ì ë³¸ì¸ ì •ë³´ (Firestoreì— 'name', 'birthDate'ë¡œ ì €ì¥ë˜ì—ˆë‹¤ê³  ê°€ì •)
                        profileName = data.name || 'ë³´í˜¸ì'; // ë³´í˜¸ì ë³¸ì¸ ì´ë¦„
                        profileBirthDate = data.birthDate; // ë³´í˜¸ì ë³¸ì¸ ìƒë…„ì›”ì¼
                        if(pageMainTitleEl) pageMainTitleEl.textContent = `${profileName}ë‹˜ì˜ ë¡œì§€ ë³´ê´€í•¨ ğŸ¨`;
                        
                        // ë³´í˜¸ì ìì‹ ì˜ íŠ¹ì„± ì¹´ë“œ í‘œì‹œ
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'block';
                        if (data.caregiverNeurodiversity && data.caregiverNeurodiversity.length > 0 && data.caregiverNeurodiversity[0] !== 'unsure_or_none') {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = data.caregiverNeurodiversity.map(nd => `<li>${getNeurodiversityText(nd)}</li>`).join('');
                        } else {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = '<li>ì„ íƒëœ ì‚¬í•­ ì—†ìŒ</li>';
                        }

                        // ì•„ì´/ê°€ì¡± ì •ë³´ ì¹´ë“œ í‘œì‹œ
                        if(childInfoCardEl) childInfoCardEl.style.display = 'block';
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';
                        if(childNameDisplayEl) childNameDisplayEl.textContent = data.childName || 'ì •ë³´ ì—†ìŒ';
                        const childAge = data.childBirthDate ? calculateAgeFromBirthDate(data.childBirthDate) : (data.childAge !== undefined ? data.childAge : null);
                        if(childFullAgeEl) childFullAgeEl.textContent = childAge !== null ? `ë§Œ ${childAge}ì„¸` : 'ì •ë³´ ì—†ìŒ';
                        
                        if (data.childDiagnoses && data.childDiagnoses.length > 0 && data.childDiagnoses[0] !== 'NotApplicable' && data.childDiagnoses[0] !== 'Unsure') {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = data.childDiagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = '<li>íŠ¹ë³„íˆ ì„ íƒëœ í•­ëª© ì—†ìŒ</li>';
                        }
                        if(childLozeeEmailDisplayEl) childLozeeEmailDisplayEl.textContent = data.childLozeeEmail || 'ì—°ê²°ëœ ê³„ì • ì—†ìŒ';

                    } else { // directUser (ë‹¹ì‚¬ì)
                        profileName = data.name || 'ì¹œêµ¬';
                        profileBirthDate = data.birthDate;
                        if(pageMainTitleEl) pageMainTitleEl.textContent = `${profileName}ì˜ ë¡œì§€ ë³´ê´€í•¨ ğŸ¨`;

                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'block';
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'none';

                        if (data.diagnoses && data.diagnoses.length > 0 && data.diagnoses[0] !== 'NotApplicable' && data.diagnoses[0] !== 'Unsure') {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = data.diagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = '<li>íŠ¹ë³„íˆ ì„ íƒëœ í•­ëª© ì—†ìŒ</li>';
                        }
                    }

                    // ê³µí†µ í”„ë¡œí•„ ì •ë³´ í‘œì‹œ (ë³´í˜¸ì ë³¸ì¸ ë˜ëŠ” ë‹¹ì‚¬ì ì •ë³´)
                    if(userNameDisplayEl) userNameDisplayEl.textContent = profileName;
                    if (userPhotoPlaceholderEl) {
                        if (data.photoURL) {
                            userPhotoPlaceholderEl.innerHTML = `<img src="${data.photoURL}" alt="${profileName} ì‚¬ì§„" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                        } else { 
                            userPhotoPlaceholderEl.textContent = profileName.charAt(0) || 'ğŸ˜Š';
                        }
                    }
                    profileAge = profileBirthDate ? calculateAgeFromBirthDate(profileBirthDate) : (data.age !== undefined ? data.age : null);
                    if(userFullAgeEl) userFullAgeEl.textContent = profileAge !== null ? `ë§Œ ${profileAge}ì„¸` : 'ì •ë³´ ì—†ìŒ';
                    if(ageLabelEl && userType === 'caregiver') ageLabelEl.textContent = "ë³´í˜¸ìë‹˜ ë§Œ ë‚˜ì´:"; // ë³´í˜¸ìì¼ë•Œ ë‚˜ì´ ë ˆì´ë¸” ë³€ê²½

                    if(lastLoginDateEl && data.lastLogin?.toDate) {
                        lastLoginDateEl.textContent = data.lastLogin.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric'});
                    } else {
                        if(lastLoginDateEl) lastLoginDateEl.textContent = 'ìµœê·¼ ê¸°ë¡ ì—†ìŒ';
                    }
                    
                    // ì´ ëŒ€í™” íšŸìˆ˜: ë³´í˜¸ìì˜ ê²½ìš° data.childTotalSessionCount, ë‹¹ì‚¬ìëŠ” data.totalSessionCount
                    let sessionCount = 0;
                    if (userType === 'caregiver') {
                        sessionCount = data.childTotalSessionCount || 0; // Firestoreì— ì´ í•„ë“œ ì €ì¥ í•„ìš”
                        if(sessionCountLabelEl) sessionCountLabelEl.textContent = `ì•„ì´/ê°€ì¡± ì´ ëŒ€í™”:`;
                    } else {
                        sessionCount = data.totalSessionCount || 0; // Firestoreì— ì´ í•„ë“œ ì €ì¥ í•„ìš”
                        if(sessionCountLabelEl) sessionCountLabelEl.textContent = `ë¡œì§€ì™€ì˜ ì´ ëŒ€í™”:`;
                    }
                    if(totalSessionsCountEl) totalSessionsCountEl.textContent = `${sessionCount}íšŒ`; 


                } else {
                    if(userNameDisplayEl) userNameDisplayEl.textContent = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.';
                }
            } catch (error) {
                console.error("í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(userNameDisplayEl) userNameDisplayEl.textContent = 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´ìš”.';
            }
        }
        
        // LOZEEì™€ì˜ ê³„íš í‘œì‹œ í•¨ìˆ˜
        function displayLozeePlans() {
            if (!lozeePlansEl) return;
            lozeePlansEl.innerHTML = ''; 
            const plans = []; 

            const continueTopicData = localStorage.getItem('lozee_continue_topic');
            if (continueTopicData) {
                try {
                    const topicToContinue = JSON.parse(continueTopicData);
                    plans.push(`â†ªï¸ ì €ë²ˆì— ì´ì•¼ê¸°í•˜ë‹¤ ë©ˆì¶˜ '${topicToContinue.details || 'ìƒê° íŒ¨í„´'}'ì— ëŒ€í•´ ë” ê¹Šì´ ì´ì•¼ê¸° ë‚˜ëˆ ë³´ê¸°ë¡œ í–ˆì–´ìš”!`);
                } catch (e) { console.error("ì´ì–´í•˜ê¸° ì£¼ì œ íŒŒì‹± ì˜¤ë¥˜", e); }
            }
            
            // ì˜ˆì‹œ: ì–¸ì–´ ì—°ìŠµ ê³„íš (localStorage ë˜ëŠ” Firestoreì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ)
            // if (localStorage.getItem('lozee_language_practice_plan_active') === 'true') {
            //     plans.push("ğŸŒ± ë¡œì§€ì™€ í•¨ê»˜ ë§ì†œì”¨ í‚¤ìš°ê¸° ì—°ìŠµì„ í•˜ê¸°ë¡œ í–ˆì–´ìš”!");
            // }

            if (plans.length > 0) {
                plans.forEach(planText => {
                    const li = document.createElement('li');
                    li.textContent = planText;
                    lozeePlansEl.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "ì•„ì§ ë¡œì§€ì™€ì˜ íŠ¹ë³„í•œ ì•½ì†ì€ ì—†ì–´ìš”! ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?";
                li.style.color = "#777";
                li.style.fontStyle = "italic";
                lozeePlansEl.appendChild(li);
            }
        }

        // ìµœê·¼ ì €ë„ 3ê°œ Firestoreì—ì„œ ë¡œë“œ ë° í‘œì‹œ
        async function displayRecentJournals() {
            if (!recentJournalListEl) return;
            recentJournalListEl.innerHTML = ''; 

            const loggedInUserEmail = localStorage.getItem('cbtUserEmail');
            const userType = localStorage.getItem('lozee_userType');
            let targetUserIdForJournals = loggedInUserEmail; // ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID

            if (userType === 'caregiver') {
                const childEmail = localStorage.getItem('lozee_child_email');
                if (childEmail) { // ì—°ê²°ëœ ìë…€ ê³„ì •ì´ ìˆë‹¤ë©´ í•´ë‹¹ ìë…€ì˜ ì €ë„ì„ ê°€ì ¸ì˜´
                    targetUserIdForJournals = childEmail;
                } else { // ì—°ê²°ëœ ìë…€ ê³„ì •ì´ ì—†ë‹¤ë©´, ë³´í˜¸ì ë³¸ì¸ì˜ ì €ë„ì„ ê°€ì ¸ì˜¤ê±°ë‚˜ (ë§Œì•½ ìˆë‹¤ë©´) ë©”ì‹œì§€ í‘œì‹œ
                    // ì§€ê¸ˆì€ ë³´í˜¸ì ë³¸ì¸ì˜ ì €ë„ì€ ì—†ë‹¤ê³  ê°€ì •í•˜ê³ , ìë…€ ê³„ì • ì—°ê²° ìœ ë„ ë©”ì‹œì§€ í‘œì‹œ
                    recentJournalListEl.innerHTML = '<p style="text-align:center; color:#777;">ì•„ì´/ê°€ì¡±ì˜ ë¡œì§€ ê³„ì •ì´ ì—°ê²°ë˜ë©´ ìµœê·¼ ëŒ€í™”ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>';
                    return;
                }
            }

            if (!targetUserIdForJournals) {
                recentJournalListEl.innerHTML = '<p style="text-align:center; color:#777;">ìµœê·¼ ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ìš”.</p>';
                return;
            }

            try {
                const q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', targetUserIdForJournals), 
                    orderBy('createdAt', 'desc'), 
                    limit(3)
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recentJournalListEl.innerHTML = `
                        <div class="journal-card" style="text-align:center; color:#777;">
                            <p>ì•„ì§ ë¡œì§€ì™€ì˜ ì´ì•¼ê¸°ê°€ ì¶©ë¶„íˆ ìŒ“ì´ì§€ ì•Šì•˜ë‚˜ ë´ìš”. ğŸ¤”</p>
                            <p>ë¡œì§€ì™€ ë” ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³  ë‹¤ì‹œ ì™€ë³´ì„¸ìš”!</p>
                        </div>`;
                } else {
                    querySnapshot.forEach((doc) => { /* ... ì´ì „ ë‹µë³€ì˜ ì¹´ë“œ ìƒì„± ë¡œì§ê³¼ ë™ì¼ ... */ });
                }
            } catch (error) {
                console.error("ìµœê·¼ ì €ë„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                recentJournalListEl.innerHTML = '<p style="text-align:center; color:red;">ìµœê·¼ ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ğŸ˜¥</p>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            displayLozeePlans(); 
            displayRecentJournals(); 

            if(reportShareButton) { /* ... ê¸°ì¡´ ê³µìœ  ë²„íŠ¼ ë¡œì§ ... */ }
        });
    </script>
</body>
</html>