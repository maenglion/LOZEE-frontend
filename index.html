<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        .success-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #a5d6a7; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .success-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        button:disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
        .select-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-bottom: 12px; }
        .select-row select { width: calc(33% - 6px); }

        #stepUserType h2 { font-size: 2em; margin-bottom: 40px; }
        .user-type-options { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; max-width: 700px; }
        .user-type-btn { flex: 1; padding: 25px 20px; font-size: 1.2em; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.4; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; }
        .btn-subtitle { font-size: 0.8em; font-weight: normal; color: #7b8dda; margin-top: 8px; }
        .user-type-btn:hover { background: #fff; transform: translateY(-1px); }

        .diagnosis-options { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; max-height: 60vh; overflow-y: auto; padding: 0 10px;}
        .diagnosis-btn, .caregiver-nd-btn { display: block; width: 85%; max-width: 480px; margin-bottom: 10px; padding: 12px; font-size: 1em; background: rgba(255, 255, 255, 0.9); color: #5f73e0; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .diagnosis-btn:hover, .caregiver-nd-btn:hover { background: #fff; }
        .diagnosis-btn.selected, .caregiver-nd-btn.selected { background-color: #FFEB3B; color: #333; border-color: #FBC02D; font-weight:bold;}
        .optional-text { font-size: 0.8em; color: #e0e0e0; font-weight: normal; }

        .secondary-btn { background: #78909c; color: white; margin-top: 10px; }
        .secondary-btn:hover { background: #607d8b; }

        .input-group { margin-bottom: 20px; width: 85%; max-width: 350px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 1em; color: #f0f0f0; text-align: left; }
        .input-group input, .input-group .select-row { width: 100%; margin-bottom: 0; }

        @media (max-width: 600px) {
            h2 { font-size: 1.6em; margin-bottom: 15px;}
            p, .info-text { font-size: 0.95em; margin-bottom:10px;}
            button { font-size: 0.9em; padding: 12px 20px; margin-top: 15px;}
            input, select { padding: 10px; margin-bottom:10px; font-size: 0.95em;}
            .select-row {max-width:100%;}

            #stepUserType h2 { font-size: 1.7em; margin-bottom: 25px; }
            .user-type-options { flex-direction: column; gap: 15px; }
            .user-type-btn { width: 90%; min-height: auto; padding: 18px; font-size: 1.05em; }
            .diagnosis-btn, .caregiver-nd-btn { max-width: 90%; font-size:0.95em; padding:10px; }
            .diagnosis-options {max-height: 50vh;}
            .input-group { width: 90%;}
        }
    </style>
</head>
<body class="step-background-main">
    <div id="stepAuthChoice" class="step"> <h2>LOZEE에 오신 것을 환영합니다!</h2>
        <button id="goToLoginBtn">로그인</button>
        <button id="goToSignUpBtn">회원가입</button>
    </div>

    <div id="stepLogin" class="step">
        <h2>로그인</h2>
        <div class="input-group">
            <label for="loginEmail">이메일</label>
            <input type="email" id="loginEmail" placeholder="이메일 주소" autocomplete="email">
        </div>
        <div class="input-group">
            <label for="loginPassword">비밀번호</label>
            <input type="password" id="loginPassword" placeholder="비밀번호" autocomplete="current-password">
        </div>
        <div class="error-message" id="loginError"></div>
        <button id="loginBtn">로그인</button>
        <button id="forgotPasswordBtn" class="secondary-btn">비밀번호를 잊으셨나요?</button>
        <p class="info-text" style="margin-top: 15px;">계정이 없으신가요? <a href="#" id="linkToSignUpFromLogin" style="color: #fff; text-decoration: underline;">회원가입</a></p>
    </div>

    <div id="stepPasswordReset" class="step">
        <h2>비밀번호 재설정</h2>
        <p>가입하신 이메일 주소를 입력하시면, 비밀번호 재설정 링크를 보내드립니다.</p>
        <div class="input-group">
            <label for="resetEmail">이메일</label>
            <input type="email" id="resetEmail" placeholder="이메일 주소" autocomplete="email">
        </div>
        <div class="error-message" id="resetError"></div>
        <div class="success-message" id="resetSuccess"></div>
        <button id="sendResetEmailBtn">재설정 이메일 발송</button>
        <button id="backToLoginBtn" class="secondary-btn">로그인으로 돌아가기</button>
    </div>

    <div id="stepUserType" class="step"> <h2>회원가입: 역할 선택</h2>
        <p>어떤 역할로 로지를 이용하시겠어요?</p>
        <div class="user-type-options">
            <button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br><span class="btn-subtitle">(신경다양인 당사자)</span></button>
            <button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br><span class="btn-subtitle">(양육자, 배우자 등)</span></button>
        </div>
        <div class="error-message" id="userTypeError"></div>
        <p class="info-text" style="margin-top: 15px;">이미 계정이 있으신가요? <a href="#" id="linkToLoginFromSignUp" style="color: #fff; text-decoration: underline;">로그인</a></p>
    </div>

    <div id="stepSignUpEmailPassword" class="step">
        <h2>회원가입: 계정 정보 입력</h2>
        <div class="input-group">
            <label for="signUpEmail">이메일</label>
            <input type="email" id="signUpEmail" placeholder="이메일 주소" autocomplete="email">
        </div>
        <div class="input-group">
            <label for="signUpPassword">비밀번호 (6자리 이상)</label>
            <input type="password" id="signUpPassword" placeholder="비밀번호" autocomplete="new-password">
        </div>
        <div class="input-group">
            <label for="signUpPasswordConfirm">비밀번호 확인</label>
            <input type="password" id="signUpPasswordConfirm" placeholder="비밀번호 다시 입력" autocomplete="new-password">
        </div>
        <div class="error-message" id="signUpError"></div>
        <button id="createAccountBtn">계정 생성 및 인증 메일 발송</button>
    </div>

    <div id="stepEmailVerification" class="step">
        <h2>이메일 인증 안내</h2>
        <p>가입하신 이메일 주소(<strong id="verificationEmailDisplay"></strong>)로 인증 메일을 보냈습니다.<br>메일을 확인하고 인증 링크를 클릭해주세요.</p>
        <p class="info-text">인증을 완료하셨으면 아래 버튼을 눌러주세요.</p>
        <div class="error-message" id="verificationError"></div>
        <button id="checkVerificationBtn">이메일 인증 완료</button>
        <button id="resendVerificationBtn" class="secondary-btn">인증 메일 다시 보내기</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step">
        <h2>보호자님에 대해서도 알려주시겠어요? <span class="optional-text">(선택 사항)</span></h2>
        <p>본인 또는 관계인(예: 배우자)께서 신경다양성 특성을 가지고 계시다면, 해당하는 항목을 모두 선택해주세요. <br>이는 로지가 더 깊이 공감하고 맞춤형 대화를 제공하는 데 도움이 됩니다.</p>
        <div class="diagnosis-options caregiver-nd-options">
            <button class="caregiver-nd-btn" data-nd="self_asd">저(보호자 본인)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="self_adhd">저(보호자 본인)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_asd">배우자(관계인)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_adhd">배우자(관계인)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="self_else">저(보호자 본인)에게 기타 신경다양성 특성이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="spouse_else">배우자(관계인)에게 기타 신경다양성 특성이 있어요.</button>
            <button class="caregiver-nd-btn" data-nd="unsure_or_none">잘 모르거나 해당 사항 없어요.</button>
        </div>
        <div class="error-message" id="caregiverNdError"></div>
        <button id="submitCaregiverNdBtn">다음 (또는 건너뛰기)</button>
    </div>

    <div id="stepDiagnosisType" class="step">
        <h2 id="diagnosisTitle">신경다양성 특성 이해하기</h2>
        <p id="diagnosisInfo">해당하는 항목을 모두 선택해주세요. (중복 선택 가능)</p>
        <div class="diagnosis-options">
            <button class="diagnosis-btn" data-diagnosis="ASD">자폐 스펙트럼 (ASD)</button>
            <button class="diagnosis-btn" data-diagnosis="ADHD">주의력 결핍 과잉행동 장애 (ADHD)</button>
            <button class="diagnosis-btn" data-diagnosis="Asperger">아스퍼거 증후군 (고기능 자폐)</button>
            <button class="diagnosis-btn" data-diagnosis="Tic">틱 장애</button>
            <button class="diagnosis-btn" data-diagnosis="LD">학습 장애</button>
            <button class="diagnosis-btn" data-diagnosis="Else">기타 어려움 또는 궁금증</button>
            <button class="diagnosis-btn" data-diagnosis="Unsure">아직 잘 모르겠어요 / 진단 없음</button>
            <button class="diagnosis-btn" data-diagnosis="NotApplicable">특별히 해당 없음</button>
        </div>
        <div class="error-message" id="diagnosisError"></div>
        <button id="submitDiagnosisBtn">다음</button>
    </div>

    <div id="stepNameBirthSelf" class="step">
        <h2 id="nameBirthSelfTitle">정보 입력</h2>
        <div class="input-group">
            <label for="nameSelfInput" id="nameSelfPromptLabel">로지가 당신을 어떻게 부르면 좋을까요?</label>
            <input type="text" id="nameSelfInput" placeholder="이름 또는 별명" />
            <div class="error-message" id="nameSelfError"></div>
        </div>
        <div class="input-group">
            <label for="birthSelfYear" id="birthSelfPromptLabel">생년월일을 선택해주세요.</label>
            <div class="info-text" id="birthSelfInfoText">정확한 나이를 계산하여 더 적절한 대화 경험을 제공합니다.</div>
            <div class="select-row">
                <select id="birthSelfYear"><option value="">년</option></select>
                <select id="birthSelfMonth"><option value="">월</option></select>
                <select id="birthSelfDay"><option value="">일</option></select>
            </div>
            <div class="error-message" id="birthSelfError"></div>
        </div>
        <button id="submitNameBirthSelfBtn">다음</button>
    </div>

    <div id="stepNameBirthChild" class="step">
        <h2 id="nameBirthChildTitle">아이(또는 가족)의 정보를 알려주세요.</h2>
        <div class="input-group">
            <label for="nameChildInput" id="nameChildPromptLabel">로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?</label>
            <input type="text" id="nameChildInput" placeholder="아이(또는 가족) 이름 또는 별명" />
            <div class="error-message" id="nameChildError"></div>
        </div>
        <div class="input-group">
            <label for="birthChildYear" id="birthChildPromptLabel">아이(또는 가족)의 생년월일을 선택해주세요.</label>
            <div class="info-text" id="birthChildInfoText">정확한 나이를 계산하여 아이(또는 가족)에게 더 적절한 대화 경험을 제공합니다.</div>
            <div class="select-row">
                <select id="birthChildYear"><option value="">년</option></select>
                <select id="birthChildMonth"><option value="">월</option></select>
                <select id="birthChildDay"><option value="">일</option></select>
            </div>
            <div class="error-message" id="birthChildError"></div>
        </div>
        <button id="submitNameBirthChildBtn">다음</button>
    </div>

    <div id="stepChildLink" class="step">
        <h2>자녀 계정 연결 (선택 사항)</h2>
        <p>자녀가 로지를 사용하고 있다면, 자녀의 로지 가입 이메일을 입력하여 연결 요청을 보낼 수 있습니다.<br>자녀가 수락하면, 자녀의 활동 중 특정 위험 신호에 대한 알림을 받으실 수 있습니다.</p>
        <p class="info-text" style="font-size: 0.85em; color: #ffeb3b;"><strong>[중요]</strong> 개인 정보 보호를 위해, 이 기능은 자녀의 동의가 반드시 필요합니다.</p>
        <div class="input-group">
            <label for="childLinkEmailInput">자녀 로지 가입 이메일</label>
            <input type="email" id="childLinkEmailInput" placeholder="자녀 이메일 주소 (선택 사항)" autocomplete="email">
        </div>
        <div class="error-message" id="childLinkError"></div>
        <button id="sendChildLinkRequestBtn">연결 요청 보내고 시작</button>
        <button id="skipChildLinkBtn" class="secondary-btn">건너뛰고 시작</button>
    </div>

    <div id="stepFinalStart" class="step">
        <h2>모든 준비가 끝났어요!</h2>
        <p>입력해주신 정보를 바탕으로 로지가 더 의미있는 대화를 나눌 수 있을 거예요.</p>
        <button id="startLozeeConversationBtn">로지와 대화 시작하기</button>
    </div>


    <script type="module">
        // Firebase SDK 및 유틸리티 함수 import
        import { db, auth as firebaseAuth } from './js/firebase-config.js'; // firebase-config.js에서 auth export
        import {
            createUserWithEmailAndPassword,
            sendEmailVerification,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { doc, setDoc, getDoc, serverTimestamp, updateDoc, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // --- DOM 요소 가져오기 ---
        const steps = {
            
            authChoice: document.getElementById('stepAuthChoice'),
            login: document.getElementById('stepLogin'),
            passwordReset: document.getElementById('stepPasswordReset'),
            userType: document.getElementById('stepUserType'),
            signUpEmailPassword: document.getElementById('stepSignUpEmailPassword'),
            emailVerification: document.getElementById('stepEmailVerification'),
            caregiverNd: document.getElementById('stepCaregiverNeurodiversity'),
            diagnosisType: document.getElementById('stepDiagnosisType'),
            nameBirthSelf: document.getElementById('stepNameBirthSelf'),
            nameBirthChild: document.getElementById('stepNameBirthChild'),
            childLink: document.getElementById('stepChildLink'),
            finalStart: document.getElementById('stepFinalStart')
        };

        const goToLoginBtn = document.getElementById('goToLoginBtn');
        const goToSignUpBtn = document.getElementById('goToSignUpBtn');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginErrorEl = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const linkToSignUpFromLogin = document.getElementById('linkToSignUpFromLogin');
        const resetEmailInput = document.getElementById('resetEmail');
        const resetErrorEl = document.getElementById('resetError');
        const resetSuccessEl = document.getElementById('resetSuccess');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const userTypeErrorEl = document.getElementById('userTypeError');
        const linkToLoginFromSignUp = document.getElementById('linkToLoginFromSignUp');
        const signUpEmailInput = document.getElementById('signUpEmail');
        const signUpPasswordInput = document.getElementById('signUpPassword');
        const signUpPasswordConfirmInput = document.getElementById('signUpPasswordConfirm');
        const signUpErrorEl = document.getElementById('signUpError');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const verificationEmailDisplayEl = document.getElementById('verificationEmailDisplay');
        const verificationErrorEl = document.getElementById('verificationError');
        const checkVerificationBtn = document.getElementById('checkVerificationBtn');
        const resendVerificationBtn = document.getElementById('resendVerificationBtn');
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const caregiverNdError = document.getElementById('caregiverNdError');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        const diagnosisTitleEl = document.getElementById('diagnosisTitle');
        const diagnosisInfoEl = document.getElementById('diagnosisInfo');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        const nameBirthSelfTitleEl = document.getElementById('nameBirthSelfTitle');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');
        const nameBirthChildTitleEl = document.getElementById('nameBirthChildTitle');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');
        const childLinkEmailInput = document.getElementById('childLinkEmailInput');
        const childLinkErrorEl = document.getElementById('childLinkError');
        const sendChildLinkRequestBtn = document.getElementById('sendChildLinkRequestBtn');
        const skipChildLinkBtn = document.getElementById('skipChildLinkBtn');
        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn');

        // --- 상태 변수 ---
        let currentAuthUser = null; // Firebase Auth User 객체 (로그인/회원가입 성공 시 할당)
        let currentUserId = null;   // Firebase Auth UID
        let selectedUserType = '';  // 'directUser' 또는 'caregiver'
        let tempCaregiverSelfName = '', tempCaregiverSelfBirthDate = null, tempCaregiverSelfAge = null;
        let tempChildName = '', tempChildBirthDate = null, tempChildAge = null;
        let tempDirectUserName = '', tempDirectUserBirthDate = null, tempDirectUserAge = null;
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = [];


        // --- 헬퍼 함수 ---
        function showStep(stepElement) { /* ... */ }
        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) { /* ... */ }
        function calculateAge(y, m, d) { /* ... */ }
        async function saveUserProfileToFirestore(uid, profileData) { /* ... */ }
        function setLocalStorageAndRedirect(profileData, userAgeForTalkContext, childData = null) { /* ... */ }

         // ⭐ clearInputFields 함수 정의 (이 위치에 추가 또는 이전에 이미 정의되어 있는지 확인) ⭐
        function clearInputFields() {
            // 로그인 관련 필드
            if(loginEmailInput) loginEmailInput.value = '';
            if(loginPasswordInput) loginPasswordInput.value = '';
            if(document.getElementById('loginError')) document.getElementById('loginError').textContent = '';

            // 회원가입 이메일/비번 관련 필드
            if(signUpEmailInput) signUpEmailInput.value = '';
            if(document.getElementById('signUpPassword')) document.getElementById('signUpPassword').value = '';
            if(document.getElementById('signUpPasswordConfirm')) document.getElementById('signUpPasswordConfirm').value = '';
            if(document.getElementById('signUpError')) document.getElementById('signUpError').textContent = '';

            // 비밀번호 재설정 관련 필드
            if(document.getElementById('resetEmail')) document.getElementById('resetEmail').value = '';
            if(document.getElementById('resetError')) document.getElementById('resetError').textContent = '';
            if(document.getElementById('resetSuccess')) document.getElementById('resetSuccess').textContent = '';
            
            // 프로필 입력 관련 필드 (이름, 생년월일)
            if(document.getElementById('nameSelfInput')) document.getElementById('nameSelfInput').value = '';
            if(document.getElementById('birthSelfYear')) document.getElementById('birthSelfYear').value = '';
            if(document.getElementById('birthSelfMonth')) document.getElementById('birthSelfMonth').value = '';
            if(document.getElementById('birthSelfDay')) document.getElementById('birthSelfDay').value = '';
            if(document.getElementById('nameSelfError')) document.getElementById('nameSelfError').textContent = '';
            if(document.getElementById('birthSelfError')) document.getElementById('birthSelfError').textContent = '';

            if(document.getElementById('nameChildInput')) document.getElementById('nameChildInput').value = '';
            if(document.getElementById('birthChildYear')) document.getElementById('birthChildYear').value = '';
            if(document.getElementById('birthChildMonth')) document.getElementById('birthChildMonth').value = '';
            if(document.getElementById('birthChildDay')) document.getElementById('birthChildDay').value = '';
            if(document.getElementById('nameChildError')) document.getElementById('nameChildError').textContent = '';
            if(document.getElementById('birthChildError')) document.getElementById('birthChildError').textContent = '';

            if(document.getElementById('childLinkEmailInput')) document.getElementById('childLinkEmailInput').value = '';
            if(document.getElementById('childLinkError')) document.getElementById('childLinkError').textContent = '';


            // 선택된 버튼 상태 초기화
            document.querySelectorAll('.diagnosis-btn.selected, .caregiver-nd-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            // 임시 상태 변수 초기화
            tempSelectedCaregiverNd = [];
            tempSelectedDiagnoses = [];
            selectedUserType = ''; // 선택된 사용자 유형도 초기화
            
            console.log("모든 입력 필드 및 선택 상태 초기화됨.");
        }

        // --- 이벤트 핸들러 바인딩 ---
        // (모든 DOM 요소 참조 변수가 위에 선언된 후에 핸들러 등록)

        if(goToLoginBtn) {
            goToLoginBtn.onclick = () => {
                clearInputFields(); // ⭐ 호출
                showStep(steps.login);
            };
        } else { console.error("goToLoginBtn 요소를 찾을 수 없습니다."); }

        if(goToSignUpBtn) {
            goToSignUpBtn.onclick = () => {
                clearInputFields(); // ⭐ 호출
                showStep(steps.userType);
            };
        } else { console.error("goToSignUpBtn 요소를 찾을 수 없습니다."); }

        // ... (나머지 모든 버튼의 onclick 핸들러 등록, 필요시 clearInputFields 호출) ...
        // 예: linkToSignUpFromLogin, linkToLoginFromSignUp 등에서도 필요에 따라 clearInputFields 호출


         // --- 페이지 로드 시 Firebase Auth 상태 감지 ---
        onAuthStateChanged(firebaseAuth, async (user) => {
            if (user) {
                console.log("Index: Firebase Auth 기존 사용자 감지. UID:", user.uid);
                currentUserId = user.uid;
                localStorage.setItem('lozee_userId', currentUserId);

                const userRef = doc(db, "users", currentUserId);
                try {
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        if (userData.name && userData.userType && user.emailVerified) { // 이메일 인증 완료 및 프로필 정보 충분
                            console.log("Index: 기존 사용자 프로필 및 이메일 인증 확인. talk.html로 이동합니다.");
                            let ageForTalk = userData.age; // 당사자 나이
                            if (userData.userType === 'caregiver' && userData.caregiverInfo) {
                                ageForTalk = userData.caregiverInfo.childAge; // 보호자면 자녀 나이로 대화
                            }
                             setLocalStorageAndRedirect(userData, ageForTalk, userData.caregiverInfo);
                            return; // 페이지 이동 후 추가 로직 실행 방지
                        } else if (!user.emailVerified) {
                             console.log("Index: 기존 사용자, 이메일 미인증 상태. 인증 단계로 이동합니다.");
                             if(verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = user.email;
                             if(steps.emailVerification) showStep(steps.emailVerification);
                             return;
                        }
                    }
                    // Firestore에 프로필이 없거나, 정보가 부족하거나, 이메일 미인증이면 역할 선택부터
                    console.log("Index: Firestore 프로필 정보 부족 또는 미인증. 역할 선택 단계부터 시작합니다.");
                    if(steps.userType) showStep(steps.userType);

                } catch (error) {
                    console.error("Index: Firestore에서 사용자 정보 로드 중 오류:", error);
                    if(steps.userType) showStep(steps.userType); // 오류 시에도 일단 첫 단계로
                }

            } else {
                console.log("Index: Firebase Auth 세션 없음. 로그인/회원가입 선택 화면 표시.");
                if(steps.authChoice) showStep(steps.authChoice); // ⭐ 로그인/가입 선택 화면부터 시작
            }
        });
    </script>
</body>
</html>