<script type="module">
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { db } from './js/firebase-config.js';
        import { doc, setDoc, getDoc, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        // firebase-utils.js의 getOrCreateUserId는 여기서는 사용하지 않고, 직접 UID를 관리합니다.

        const auth = getAuth();

        // --- DOM 요소 가져오기 ---
        const steps = {
            userType: document.getElementById('stepUserType'),
            caregiverNd: document.getElementById('stepCaregiverNeurodiversity'),
            diagnosisType: document.getElementById('stepDiagnosisType'),
            nameBirthSelf: document.getElementById('stepNameBirthSelf'),
            nameBirthChild: document.getElementById('stepNameBirthChild'),
            finalStart: document.getElementById('stepFinalStart') // CBT, ChildEmail 단계는 일단 제외하고 바로 시작으로
        };

        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-btn');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-btn');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');

        const nameSelfInput = document.getElementById('nameSelfInput');
        const birthSelfYear = document.getElementById('birthSelfYear');
        const birthSelfMonth = document.getElementById('birthSelfMonth');
        const birthSelfDay = document.getElementById('birthSelfDay');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthSelfError = document.getElementById('birthSelfError');

        const nameChildInput = document.getElementById('nameChildInput');
        const birthChildYear = document.getElementById('birthChildYear');
        const birthChildMonth = document.getElementById('birthChildMonth');
        const birthChildDay = document.getElementById('birthChildDay');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');
        const nameChildError = document.getElementById('nameChildError');
        const birthChildError = document.getElementById('birthChildError');

        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn'); // HTML에 이 ID 버튼 추가됨

        // --- 상태 변수 ---
        let currentUserId = null; // Firebase Auth UID
        let selectedUserType = ''; // 'directUser' 또는 'caregiver'
        // 각 단계에서 입력받는 정보를 저장할 변수들
        let tempCaregiverSelfName = '', tempCaregiverSelfBirthDate = '', tempCaregiverSelfAge = null;
        let tempChildName = '', tempChildBirthDate = '', tempChildAge = null;
        let tempDirectUserName = '', tempDirectUserBirthDate = '', tempDirectUserAge = null;
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = []; // 당사자 또는 자녀의 특성 저장용

        // --- 헬퍼 함수 ---
        function showStep(stepElement) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            if (stepElement) stepElement.classList.add('active');
            else console.error("showStep: 표시할 요소가 없습니다.");
        }

        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) {
            if (!yearEl || !monthEl || !dayEl) return;
            yearEl.innerHTML = '<option value="">년</option>';
            monthEl.innerHTML = '<option value="">월</option>';
            dayEl.innerHTML = '<option value="">일</option>';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - startYearOffset; y >= currentYear - endYearOffset; y--) {
                const opt = new Option(`${y}년`, y); yearEl.add(opt);
            }
            for (let m = 1; m <= 12; m++) {
                const opt = new Option(`${m}월`, m); monthEl.add(opt);
            }
            for (let d = 1; d <= 31; d++) {
                const opt = new Option(`${d}일`, d); dayEl.add(opt);
            }
        }

        function calculateAge(y, m, d) {
            if (!y || !m || !d) return null;
            const birth = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
            if (isNaN(birth.getTime())) return null;
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age >= 0 ? age : null;
        }

        async function saveOrUpdateUserProfile(uid, profileData) {
            if (!uid || !profileData) {
                console.error("saveOrUpdateUserProfile: UID 또는 프로필 데이터가 없습니다.");
                return;
            }
            const userRef = doc(db, "users", uid);
            const dataToSave = {
                uid: uid,
                ...profileData,
                lastLogin: serverTimestamp()
            };

            try {
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    dataToSave.createdAt = serverTimestamp(); // 최초 생성 시에만 createdAt 설정
                    await setDoc(userRef, dataToSave);
                    console.log(`[saveOrUpdateUserProfile] Firestore에 새 사용자 문서 생성: ${uid}`, dataToSave);
                } else {
                    // 기존 문서에는 병합하여 업데이트 (createdAt은 덮어쓰지 않음)
                    await setDoc(userRef, dataToSave, { merge: true });
                    console.log(`[saveOrUpdateUserProfile] Firestore 사용자 문서 업데이트: ${uid}`, dataToSave);
                }
            } catch (error) {
                console.error(`[saveOrUpdateUserProfile] 사용자 문서 저장/업데이트 실패 (${uid}):`, error.message, error);
                alert("사용자 정보를 저장하는 데 실패했습니다. 인터넷 연결을 확인하고 다시 시도해주세요.");
                throw error; // 오류를 다시 throw하여 호출한 곳에서 처리할 수 있도록 함
            }
        }

        // --- 이벤트 핸들러 ---
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                // userType에 따라 다음 단계 결정 (CBT 코드 입력 단계는 일단 제외)
                if (selectedUserType === 'caregiver') {
                    showStep(steps.caregiverNd);
                } else { // directUser
                    document.getElementById('diagnosisTitle').textContent = "현재 어떤 어려움을 느끼고 있나요?";
                    document.getElementById('diagnosisInfo').textContent = "해당하는 항목을 모두 선택해주세요. (중복 선택 가능)";
                    showStep(steps.diagnosisType);
                }
            };
        });

        caregiverNdOptionBtns.forEach(button => {
            button.onclick = () => {
                const ndType = button.dataset.nd;
                if (ndType === 'unsure_or_none') {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected'); tempSelectedCaregiverNd = [];
                    } else {
                        caregiverNdOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); tempSelectedCaregiverNd = [ndType];
                    }
                } else {
                    document.querySelector('.caregiver-nd-btn[data-nd="unsure_or_none"]')?.classList.remove('selected');
                    tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== 'unsure_or_none');
                    button.classList.toggle('selected');
                    if (tempSelectedCaregiverNd.includes(ndType)) {
                        tempSelectedCaregiverNd = tempSelectedCaregiverNd.filter(d => d !== ndType);
                    } else {
                        tempSelectedCaregiverNd.push(ndType);
                    }
                }
                console.log("선택된 보호자/배우자 신경다양성:", tempSelectedCaregiverNd);
            };
        });

        submitCaregiverNdBtn.onclick = () => {
            document.getElementById('diagnosisTitle').textContent = "아이(또는 가족)의 어떤 점에 대해 이야기 나누고 싶으세요?";
            document.getElementById('diagnosisInfo').textContent = "해당하는 어려움을 모두 선택해주세요. (중복 선택 가능)";
            showStep(steps.diagnosisType);
        };

        diagnosisOptionBtns.forEach(button => {
            button.onclick = () => {
                const diagnosis = button.dataset.diagnosis;
                const isExclusive = (diagnosis === 'NotApplicable' || diagnosis === 'Unsure');
                if (isExclusive) {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected'); tempSelectedDiagnoses = [];
                    } else {
                        diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected'); tempSelectedDiagnoses = [diagnosis];
                    }
                } else {
                    document.querySelector('.diagnosis-btn[data-diagnosis="NotApplicable"]')?.classList.remove('selected');
                    document.querySelector('.diagnosis-btn[data-diagnosis="Unsure"]')?.classList.remove('selected');
                    tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== 'NotApplicable' && d !== 'Unsure');
                    button.classList.toggle('selected');
                    if (tempSelectedDiagnoses.includes(diagnosis)) {
                        tempSelectedDiagnoses = tempSelectedDiagnoses.filter(d => d !== diagnosis);
                    } else {
                        tempSelectedDiagnoses.push(diagnosis);
                    }
                }
                console.log("선택된 진단/어려움 유형:", tempSelectedDiagnoses);
            };
        });

        submitDiagnosisBtn.onclick = () => {
            if (selectedUserType === 'caregiver' && tempSelectedDiagnoses.length === 0) {
                 document.getElementById('diagnosisError').textContent = "아이(또는 가족)의 특성을 하나 이상 선택해주세요."; return;
            } else if (selectedUserType === 'directUser' && tempSelectedDiagnoses.length === 0) {
                 document.getElementById('diagnosisError').textContent = "하나 이상 선택해주세요."; return;
            }
            document.getElementById('diagnosisError').textContent = '';

            if (selectedUserType === 'caregiver') {
                document.getElementById('nameBirthSelfTitle').textContent = "보호자님의 정보를 알려주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 18, 70);
            } else { // directUser
                document.getElementById('nameBirthSelfTitle').textContent = "만나서 반가워요! 당신에 대해 알려주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 7, 70);
            }
            showStep(steps.nameBirthSelf);
        };

        submitNameBirthSelfBtn.onclick = () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            if (!name) { nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.'; return; }
            nameSelfError.textContent = '';
            if (!y || !m || !d) { birthSelfError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            birthSelfError.textContent = '';

            const age = calculateAge(y, m, d);
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

            if (selectedUserType === 'caregiver') {
                tempCaregiverSelfName = name;
                tempCaregiverSelfBirthDate = birthDate;
                tempCaregiverSelfAge = age;
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18);
                showStep(steps.nameBirthChild);
            } else { // directUser
                tempDirectUserName = name;
                tempDirectUserBirthDate = birthDate;
                tempDirectUserAge = age;
                showStep(steps.finalStart); // 당사자는 정보 입력 후 바로 시작 단계로
            }
        };

        submitNameBirthChildBtn.onclick = () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
            if (!name) { nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.'; return; }
            nameChildError.textContent = '';
            if (!y || !m || !d) { birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.'; return; }
            birthChildError.textContent = '';

            tempChildName = name;
            tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            tempChildAge = calculateAge(y, m, d);
            showStep(steps.finalStart); // 자녀 정보 입력 후 시작 단계로
        };

        startLozeeConversationBtn.onclick = async () => {
            if (!currentUserId) {
                alert("사용자 세션 초기화 중 오류가 발생했습니다. 페이지를 새로고침 해주세요.");
                return;
            }

            // 최종적으로 localStorage 및 Firestore에 정보 저장
            let finalProfileData = {
                role: selectedUserType === 'caregiver' ? 'parent' : 'child',
                userType: selectedUserType
            };
            let finalUserName = '';
            let finalUserAge = null; // talk.js에서 사용할 대화 맥락 나이

            if (selectedUserType === 'caregiver') {
                finalUserName = tempCaregiverSelfName;
                finalUserAge = tempChildAge; // 보호자 모드 시 대화 맥락 나이는 자녀 나이

                finalProfileData.name = tempCaregiverSelfName;
                finalProfileData.birthDate = tempCaregiverSelfBirthDate;
                finalProfileData.age = tempCaregiverSelfAge; // 보호자 본인 나이
                finalProfileData.caregiver = { // Firestore 'caregiver' 맵
                    caregiverNeurodiversity: tempSelectedCaregiverNd,
                    childName: tempChildName,
                    childBirthDate: tempChildBirthDate,
                    childAge: tempChildAge,
                    childDiagnoses: tempSelectedDiagnoses // 여기서는 자녀의 특성
                    // childLozeeUid: childLozeeUid, // UID 연결 로직 추가 시
                };
                // 보호자 본인의 '진단/어려움'은 caregiverNeurodiversity로 관리하므로, users 최상위 diagnoses는 비워둠
                finalProfileData.diagnoses = [];
            } else { // directUser
                finalUserName = tempDirectUserName;
                finalUserAge = tempDirectUserAge; // 당사자 모드 시 대화 맥락 나이는 본인 나이

                finalProfileData.name = tempDirectUserName;
                finalProfileData.birthDate = tempDirectUserBirthDate;
                finalProfileData.age = tempDirectUserAge;
                finalProfileData.diagnoses = tempSelectedDiagnoses;
            }

            // localStorage 업데이트
            localStorage.setItem('lozee_username', finalUserName);
            localStorage.setItem('lozee_userAge', finalUserAge !== null ? finalUserAge.toString() : '0');
            localStorage.setItem('lozee_role', finalProfileData.role);
            localStorage.setItem('lozee_userType', finalProfileData.userType);

            if (selectedUserType === 'caregiver') {
                localStorage.setItem('lozee_childName', tempChildName);
                localStorage.setItem('lozee_childAge', tempChildAge !== null ? tempChildAge.toString() : '0');
                localStorage.setItem('lozee_parentIsND', JSON.stringify(tempSelectedCaregiverNd.length > 0 && tempSelectedCaregiverNd[0] !== 'unsure_or_none'));
                 // lozee_diagnoses는 자녀의 것이므로, talk.js에서 userTraits 로드 시 참고할 수 있도록
                 localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses)); // 자녀 특성
                 localStorage.setItem('lozee_caregiver_neurodiversity', JSON.stringify(tempSelectedCaregiverNd)); // 보호자 특성
            } else { // directUser인 경우, child 관련 정보 및 보호자 ND 정보 제거
                localStorage.removeItem('lozee_childName');
                localStorage.removeItem('lozee_childAge');
                localStorage.removeItem('lozee_parentIsND');
                localStorage.removeItem('lozee_childId');
                localStorage.removeItem('lozee_caregiver_neurodiversity');
                localStorage.setItem('lozee_diagnoses', JSON.stringify(tempSelectedDiagnoses)); // 본인 특성
            }


            try {
                await saveOrUpdateUserProfile(currentUserId, finalProfileData);
                window.location.href = 'talk.html';
            } catch (error) {
                // saveOrUpdateUserProfile 내부에서 이미 alert를 띄울 수 있음
                console.error("최종 사용자 정보 저장 실패:", error);
                // 여기서 추가적인 사용자 안내 메시지 가능
            }
        };

        // 페이지 로드 시: Firebase Auth 상태 확인 및 UID 설정
        onAuthStateChanged(auth, (user) => {
            if (user) { // 이미 (익명)로그인된 상태
                console.log("Index: 기존 Firebase Auth 세션 감지. UID:", user.uid);
                currentUserId = user.uid;
                localStorage.setItem('lozee_userId', currentUserId);
                // Firestore에서 사용자 정보 가져와서 localStorage 업데이트 및 다음 단계 결정 (선택적)
                // getDoc(doc(db, "users", currentUserId)).then(userSnap => {
                // if (userSnap.exists()) { /* localStorage 업데이트 */ }
                // });
            } else { // 로그인 안 된 상태 -> 익명 로그인 시도
                signInAnonymously(auth)
                    .then((userCredential) => {
                        const newUser = userCredential.user;
                        console.log('Index: 새로운 익명 사용자 UID 생성 및 저장:', newUser.uid);
                        currentUserId = newUser.uid;
                        localStorage.setItem('lozee_userId', currentUserId);
                    })
                    .catch((error) => {
                        console.error("Index: 익명 로그인 실패:", error);
                        // 익명 로그인 실패 시 임시 guest UID 사용 (최후의 수단)
                        currentUserId = localStorage.getItem('lozee_userId');
                        if (!currentUserId) {
                            currentUserId = 'guest_' + crypto.randomUUID();
                            localStorage.setItem('lozee_userId', currentUserId);
                            console.log('Index: 익명 로그인 실패, 임시 guest UID 사용:', currentUserId);
                        }
                    });
            }
            // UID가 설정된 후 첫 단계 표시
            showStep(steps.userType);
        });
        </script>
</body>
</html>