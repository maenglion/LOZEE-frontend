<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOZEE 시작하기</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'KoPub World Dotum', sans-serif; color: #ffffff; height: 100%; overflow: hidden; }
        .step { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .step.active { display: flex; }
        .step-background-main { background: linear-gradient(135deg, #6078ea, #a777e3); }
        h2 { font-size: 1.8em; margin-bottom: 20px; color: #fff; }
        p, .info-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; color: #f0f0f0; }
        .error-message { font-weight: bold; font-size: 0.9em; min-height: 1.2em; margin: 5px 0 10px; padding: 5px 8px; color: #ffcdd2; background-color: rgba(0,0,0,0.15); border-radius: 4px; }
        .error-message:empty { display: none; }
        input, select { padding: 12px; margin-bottom: 12px; border: 1px solid #bdbdbd; border-radius: 8px; width: 85%; max-width: 350px; font-size: 1em; background: #fdfdfd; box-sizing: border-box; color: #333; }
        button { padding: 13px 28px; background: #fff; color: #6e8efb; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1.05em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background: #f5f5f5; transform: translateY(-2px); }
        button:disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
        .select-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 500px; margin-bottom: 12px; }
        .select-row select { width: calc(33% - 6px); }
        @media (max-width: 600px) { h2 { font-size: 1.7em; } p, .info-text { font-size: 1em; } button { font-size: 0.95em; padding: 12px 24px; } }
    </style>
</head>
<body class="step-background-main">
    <div id="stepCBT" class="step active">
        <h2>로지와 대화 시작하기</h2>
        <p>CBT 참여자 이메일 주소를 입력해주세요.</p>
        <input type="email" id="cbtCodeInput" placeholder="CBT 이메일 주소" />
        <div class="error-message" id="cbtCodeError"></div>
        <button id="submitCbtCodeBtn">다음</button>
    </div>

    <div id="stepNameBirth" class="step">
        <h2>만나서 반가워요!</h2>
        <p>로지가 당신을 어떻게 부르면 좋을까요?</p>
        <input type="text" id="nameInput" placeholder="이름 또는 별명" />
        <div class="error-message" id="nameError"></div>
        <p>생년월일을 선택해주세요.</p>
        <div class="info-text">정확한 나이를 계산하여 더 적절한 대화 경험을 제공합니다.</div>
        <div class="select-row">
            <select id="birthYear"><option value="">년</option></select>
            <select id="birthMonth"><option value="">월</option></select>
            <select id="birthDay"><option value="">일</option></select>
        </div>
        <div class="error-message" id="birthError"></div>
        <button id="submitNameBirthBtn">시작하기</button>
    </div>

    <script type="module">
        // 1. 필요한 모듈 import
        import { validateCbtEmail, getCbtErrorMessage } from './js/cbt.js';
        import { db } from './js/firebase-config.js'; 
        import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // 2. DOM 요소 가져오기
        const stepCBT = document.getElementById('stepCBT');
        const stepNameBirth = document.getElementById('stepNameBirth');
        const cbtCodeInput = document.getElementById('cbtCodeInput');
        const cbtCodeError = document.getElementById('cbtCodeError');
        const submitCbtCodeBtn = document.getElementById('submitCbtCodeBtn');
        const nameInput = document.getElementById('nameInput');
        const nameError = document.getElementById('nameError');
        const birthYear = document.getElementById('birthYear');
        const birthMonth = document.getElementById('birthMonth');
        const birthDay = document.getElementById('birthDay');
        const birthError = document.getElementById('birthError');
        const submitNameBirthBtn = document.getElementById('submitNameBirthBtn');

        // 3. 헬퍼 함수 정의
        function showStep(el) {
            stepCBT.classList.remove('active');
            stepNameBirth.classList.remove('active');
            el.classList.add('active');
        }

        function populateBirthSelects() {
            const now = new Date();
            const currentYear = now.getFullYear();
            for (let y = currentYear - 5; y >= currentYear - 90; y--) {
                const opt = document.createElement('option'); opt.value = y; opt.textContent = y + '년'; birthYear.appendChild(opt);
            }
            for (let m = 1; m <= 12; m++) { const opt = document.createElement('option'); opt.value = m; opt.textContent = m + '월'; birthMonth.appendChild(opt); }
            for (let d = 1; d <= 31; d++) { const opt = document.createElement('option'); opt.value = d; opt.textContent = d + '일'; birthDay.appendChild(opt); }
        }

        // 4. CBT 사용자 확인 함수
        async function checkForExistingCbtUser() {
            const existingEmail = localStorage.getItem('cbtUserEmail');
            const isCbt = localStorage.getItem('isCbtUser') === 'true'; // CBT 참여자 플래그 확인

            if (existingEmail && isCbt) {
                console.log(`기존 CBT 사용자 이메일 발견: ${existingEmail}`);
                try {
                    // Firestore에서 사용자 정보 가져오기 (users 컬렉션, 문서 ID는 이메일로 가정)
                    const userDocRef = doc(db, "users", existingEmail); // 'users'는 Firestore 컬렉션 이름
                    const userSnap = await getDoc(userDocRef);

                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        const userName = userData.name; // Firestore에 저장된 이름 필드명
                        const userAge = userData.age;   // Firestore에 저장된 나이 필드명

                        if (userName && typeof userAge === 'number') {
                            localStorage.setItem('lozee_username', userName);
                            localStorage.setItem('lozee_userage', userAge.toString()); // 나이는 문자열로 저장
                            console.log(`사용자 정보 로드 완료: ${userName}, ${userAge}세. talk.html로 이동합니다.`);
                            window.location.href = 'talk.html'; // 바로 talk.html로 이동
                            return true; // 기존 사용자 처리 완료
                        } else {
                            console.log("Firestore에 사용자 이름 또는 나이 정보가 완전하지 않습니다. 새로 입력받습니다.");
                        }
                    } else {
                        console.log("Firestore에 해당 이메일의 사용자 정보가 없습니다. 새로 입력받습니다.");
                    }
                } catch (error) {
                    console.error("Firestore에서 사용자 정보 로드 중 오류:", error);
                }
            }
            return false; // 기존 사용자 처리 안 함 (새로 입력)
        }

        // 5. 이벤트 핸들러 정의 (중복 제거된 버전)
        submitCbtCodeBtn.onclick = () => {
            const email = cbtCodeInput.value.trim();
            if (!validateCbtEmail(email)) {
                cbtCodeError.textContent = getCbtErrorMessage(); return;
            }
            cbtCodeError.textContent = ''; // 오류 메시지 초기화
            localStorage.setItem('cbtUserEmail', email.toLowerCase());
            localStorage.setItem('isCbtUser', 'true'); // CBT 사용자 플래그 설정
            showStep(stepNameBirth);
        };

        submitNameBirthBtn.onclick = async () => {
            const name = nameInput.value.trim();
            const y = birthYear.value, m = birthMonth.value, d = birthDay.value;
            
            if (!name) { nameError.textContent = '이름을 입력해주세요.'; return; }
            nameError.textContent = '';
            if (!y || !m || !d) { birthError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            birthError.textContent = '';
            
            const dob = new Date(y, m - 1, d);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) {
                age--;
            }
            
            localStorage.setItem('lozee_username', name);
            localStorage.setItem('lozee_userage', age.toString()); // 나이는 문자열로 저장

            // Firestore에 사용자 정보 저장 (이름, 나이 등)
            const cbtUserEmail = localStorage.getItem('cbtUserEmail');
            if (cbtUserEmail && name && typeof age === 'number') {
                try {
                    const userDocRef = doc(db, "users", cbtUserEmail); // 'users' 컬렉션, 문서 ID는 이메일
                    await setDoc(userDocRef, { 
                        name: name, 
                        age: age,
                        email: cbtUserEmail, // 이메일도 함께 저장
                    }, { merge: true }); // merge: true 옵션으로 기존 문서가 있으면 병합, 없으면 생성
                    console.log("Firestore에 사용자 정보 저장/업데이트 완료.");
                } catch (error) {
                    console.error("Firestore에 사용자 정보 저장 중 오류:", error);
                }
            }
            
            window.location.href = 'talk.html';
        };

        // 6. DOMContentLoaded 이벤트 리스너 (메인 실행 로직)
        document.addEventListener('DOMContentLoaded', async () => {
            populateBirthSelects();
            const existingUserProcessed = await checkForExistingCbtUser();
            if (!existingUserProcessed) {
                // 기존 CBT 사용자 정보로 바로 넘어가지 않은 경우에만 초기 스텝 보여주기
                showStep(stepCBT);
            }
        });
    </script>
</body>
</html>