<body class="step-background-main">
    <div id="stepAuthChoice" class="step active">
        <h2>LOZEE에 오신 것을 환영합니다!</h2>
        <button id="goToLoginBtn">로그인</button>
        <button id="goToSignUpBtn">회원가입</button>
    </div>

    <div id="stepLogin" class="step">
        <h2>로그인</h2>
        <div class="input-group">
            <label for="loginEmail">이메일</label>
            <input type="email" id="loginEmail" placeholder="이메일 주소">
        </div>
        <div class="input-group">
            <label for="loginPassword">비밀번호</label>
            <input type="password" id="loginPassword" placeholder="비밀번호">
        </div>
        <div class="error-message" id="loginError"></div>
        <button id="loginBtn">로그인</button>
        <button id="forgotPasswordBtn" class="secondary-btn">비밀번호를 잊으셨나요?</button>
        <p class="info-text" style="margin-top: 15px;">계정이 없으신가요? <a href="#" id="linkToSignUpFromLogin" style="color: #fff; text-decoration: underline;">회원가입</a></p>
    </div>

    <div id="stepPasswordReset" class="step">
        <h2>비밀번호 재설정</h2>
        <p>가입하신 이메일 주소를 입력하시면, 비밀번호 재설정 링크를 보내드립니다.</p>
        <div class="input-group">
            <label for="resetEmail">이메일</label>
            <input type="email" id="resetEmail" placeholder="이메일 주소">
        </div>
        <div class="error-message" id="resetError"></div>
        <div class="success-message" id="resetSuccess" style="color: #a5d6a7;"></div>
        <button id="sendResetEmailBtn">재설정 이메일 발송</button>
        <button id="backToLoginBtn" class="secondary-btn">로그인으로 돌아가기</button>
    </div>

    <div id="stepUserType" class="step">
        <h2>회원가입: 역할 선택</h2>
        <p>어떤 역할로 로지를 이용하시겠어요?</p>
        <div class="user-type-options">
            <button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br><span class="btn-subtitle">(신경다양인 당사자)</span></button>
            <button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br><span class="btn-subtitle">(양육자, 배우자 등)</span></button>
        </div>
        <div class="error-message" id="userTypeError"></div>
         <p class="info-text" style="margin-top: 15px;">이미 계정이 있으신가요? <a href="#" id="linkToLoginFromSignUp" style="color: #fff; text-decoration: underline;">로그인</a></p>
    </div>

    <div id="stepSignUpEmailPassword" class="step"> <h2>회원가입: 계정 정보 입력</h2>
        <div class="input-group">
            <label for="signUpEmail">이메일</label>
            <input type="email" id="signUpEmail" placeholder="이메일 주소">
        </div>
        <div class="input-group">
            <label for="signUpPassword">비밀번호 (6자리 이상)</label>
            <input type="password" id="signUpPassword" placeholder="비밀번호">
        </div>
        <div class="input-group">
            <label for="signUpPasswordConfirm">비밀번호 확인</label>
            <input type="password" id="signUpPasswordConfirm" placeholder="비밀번호 다시 입력">
        </div>
        <div class="error-message" id="signUpError"></div>
        <button id="createAccountBtn">계정 생성 및 인증 메일 발송</button>
    </div>

    <div id="stepEmailVerification" class="step">
        <h2>이메일 인증 안내</h2>
        <p>가입하신 이메일 주소(<strong id="verificationEmailDisplay"></strong>)로 인증 메일을 보냈습니다.<br>메일을 확인하고 인증 링크를 클릭해주세요.</p>
        <p class="info-text">인증을 완료하셨으면 아래 버튼을 눌러주세요.</p>
        <div class="error-message" id="verificationError"></div>
        <button id="checkVerificationBtn">이메일 인증 완료</button>
        <button id="resendVerificationBtn" class="secondary-btn">인증 메일 다시 보내기</button>
    </div>

    <div id="stepCaregiverNeurodiversity" class="step"> </div>
    <div id="stepDiagnosisType" class="step"> </div>
    <div id="stepNameBirthSelf" class="step"> </div>
    <div id="stepNameBirthChild" class="step"> </div>

    <div id="stepChildLink" class="step">
        <h2>자녀 계정 연결 (선택 사항)</h2>
        <p>자녀가 로지를 사용하고 있다면, 자녀의 로지 가입 이메일을 입력하여 연결 요청을 보낼 수 있습니다.<br>자녀가 수락하면, 자녀의 활동 중 특정 위험 신호에 대한 알림을 받으실 수 있습니다.</p>
        <p class="info-text" style="font-size: 0.85em; color: #ffeb3b;"><strong>[중요]</strong> 개인 정보 보호를 위해, 이 기능은 자녀의 동의가 반드시 필요합니다.</p>
        <div class="input-group">
            <label for="childLinkEmailInput">자녀 로지 가입 이메일</label>
            <input type="email" id="childLinkEmailInput" placeholder="자녀 이메일 주소 (선택 사항)">
        </div>
        <div class="error-message" id="childLinkError"></div>
        <button id="sendChildLinkRequestBtn">연결 요청 보내고 시작</button>
        <button id="skipChildLinkBtn" class="secondary-btn">건너뛰고 시작</button>
    </div>

    <div id="stepFinalStart" class="step">
        <h2>모든 준비가 끝났어요!</h2>
        <p>입력해주신 정보를 바탕으로 로지가 더 의미있는 대화를 나눌 수 있을 거예요.</p>
        <button id="startLozeeConversationBtn">로지와 대화 시작하기</button>
    </div>

    <script type="module">
        // Firebase SDK 및 유틸리티 함수 import
        import { db } from './js/firebase-config.js'; // db만 필요
        import {
            listenAuthState,
            signUpWithEmail,
            signInWithEmail,
            resetPassword,
            signOutUser,
            saveUserProfile
        } from './js/auth.js'; // ⭐ 새로운 auth.js에서 함수 가져오기
        // import { doc, setDoc, getDoc, serverTimestamp, updateDoc } from '...'; // Firestore 직접 접근은 auth.js로 이동

        // --- DOM 요소 가져오기 (이전과 동일) ---
        const steps = { /* ... */ };
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        // ... (모든 버튼 및 입력 필드 DOM 요소들) ...
        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginErrorEl = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        const signUpEmailInput = document.getElementById('signUpEmail');
        // ... (나머지 DOM 요소들)

        // --- 상태 변수 ---
        let currentUserId = null; // listenAuthState를 통해 설정됨
        let selectedUserType = '';
        // ... (temp 변수들은 이전과 동일) ...
        let tempCaregiverSelfName = '', tempCaregiverSelfBirthDate = null, tempCaregiverSelfAge = null;
        let tempChildName = '', tempChildBirthDate = null, tempChildAge = null;
        let tempDirectUserName = '', tempDirectUserBirthDate = null, tempDirectUserAge = null;
        let tempSelectedCaregiverNd = [];
        let tempSelectedDiagnoses = [];

        // --- 헬퍼 함수 (UI 관련) ---
        function showStep(stepElement) { /* ... 이전과 동일 ... */ }
        function populateBirthSelects(yearEl, monthEl, dayEl, startYearOffset = 0, endYearOffset = 100) { /* ... 이전과 동일 ... */ }
        function calculateAge(y, m, d) { /* ... 이전과 동일 ... */ }

        function clearInputFields() {
            // 회원가입/로그인 관련 입력 필드 초기화
            if(loginEmailInput) loginEmailInput.value = '';
            if(loginPasswordInput) loginPasswordInput.value = '';
            if(signUpEmailInput) signUpEmailInput.value = '';
            // ... 기타 모든 입력 필드 초기화 ...
            tempSelectedCaregiverNd = [];
            tempSelectedDiagnoses = [];
            // ... 버튼 선택 상태 초기화 ...
            document.querySelectorAll('.diagnosis-btn.selected, .caregiver-nd-btn.selected').forEach(btn => btn.classList.remove('selected'));
        }

        // --- 이벤트 핸들러 바인딩 ---

        // 로그인/회원가입 선택 버튼
        if(goToLoginBtn) goToLoginBtn.onclick = () => showStep(steps.login);
        if(goToSignUpBtn) goToSignUpBtn.onclick = () => { clearInputFields(); showStep(steps.userType); }; // 회원가입 시작 시 필드 초기화
        if(linkToSignUpFromLogin) linkToSignUpFromLogin.onclick = (e) => { e.preventDefault(); clearInputFields(); showStep(steps.userType); };
        if(linkToLoginFromSignUp) linkToLoginFromSignUp.onclick = (e) => { e.preventDefault(); clearInputFields(); showStep(steps.login); };
        if(forgotPasswordBtn) forgotPasswordBtn.onclick = () => { clearInputFields(); showStep(steps.passwordReset); };
        if(backToLoginBtn) backToLoginBtn.onclick = () => { clearInputFields(); showStep(steps.login); };

        // 로그인 버튼
        if(loginBtn) loginBtn.onclick = async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if(loginErrorEl) loginErrorEl.textContent = '';
            if (!email || !password) { if(loginErrorEl) loginErrorEl.textContent = "이메일과 비밀번호를 모두 입력해주세요."; return; }

            loginBtn.disabled = true; loginBtn.textContent = "로그인 중...";
            const { user, error } = await signInWithEmail(email, password);
            loginBtn.disabled = false; loginBtn.textContent = "로그인";

            if (error) {
                if(loginErrorEl) loginErrorEl.textContent = "로그인에 실패했습니다: " + (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' ? '이메일 또는 비밀번호가 올바르지 않습니다.' : error.message);
            } else if (user && !user.emailVerified) {
                if(loginErrorEl) loginErrorEl.textContent = "이메일 인증이 완료되지 않았습니다. 메일함의 인증 링크를 클릭해주세요.";
                // (선택) 로그아웃 처리 후 이메일 인증 단계로 보낼 수 있음
                // await signOutUser();
                // if(verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                // showStep(steps.emailVerification);
            } else if (user && user.emailVerified) {
                // 로그인 성공 및 이메일 인증 완료 -> onAuthStateChanged가 처리하여 talk.html로 이동할 것임
                console.log("로그인 성공 및 이메일 인증 확인. onAuthStateChanged가 페이지 이동 처리합니다.");
                // Firestore에서 사용자 프로필 로드하여 localStorage 설정
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    let ageForTalk = userData.age;
                    if (userData.userType === 'caregiver' && userData.caregiverInfo) {
                        ageForTalk = userData.caregiverInfo.childAge;
                    }
                    setLocalStorageAndRedirect(userData, ageForTalk, userData.caregiverInfo);
                } else {
                     // 프로필이 없다면, 역할 선택부터 다시 (이론상 회원가입 시 생성됨)
                    console.warn("로그인 성공했으나 Firestore 프로필 없음. 역할 선택으로 이동.");
                    showStep(steps.userType);
                }
            }
        };

        // 비밀번호 재설정 버튼
        if(sendResetEmailBtn) sendResetEmailBtn.onclick = async () => {
            const email = resetEmailInput.value.trim();
            if(resetErrorEl) resetErrorEl.textContent = '';
            if(resetSuccessEl) resetSuccessEl.textContent = '';
            if (!email) { if(resetErrorEl) resetErrorEl.textContent = "이메일을 입력해주세요."; return; }

            sendResetEmailBtn.disabled = true; sendResetEmailBtn.textContent = "발송 중...";
            const { success, error } = await resetPassword(email);
            sendResetEmailBtn.disabled = false; sendResetEmailBtn.textContent = "재설정 이메일 발송";

            if (success) {
                if(resetSuccessEl) resetSuccessEl.textContent = "비밀번호 재설정 이메일을 보냈습니다. 메일함을 확인해주세요.";
            } else {
                if(resetErrorEl) resetErrorEl.textContent = "이메일 발송에 실패했습니다: " + (error.code === 'auth/user-not-found' ? '가입되지 않은 이메일입니다.' : error.message);
            }
        };

        // 회원가입: 역할 선택
        userTypeButtons.forEach(button => {
            button.onclick = () => {
                selectedUserType = button.dataset.usertype;
                if(steps.signUpEmailPassword) showStep(steps.signUpEmailPassword);
            };
        });

        // 회원가입: 계정 생성 버튼
        if(createAccountBtn) createAccountBtn.onclick = async () => {
            const email = signUpEmailInput.value.trim();
            const password = signUpPasswordInput.value;
            const passwordConfirm = signUpPasswordConfirmInput.value;
            if(signUpErrorEl) signUpErrorEl.textContent = '';

            if (!email || !password || !passwordConfirm) { if(signUpErrorEl) signUpErrorEl.textContent = "모든 필드를 입력해주세요."; return; }
            if (password !== passwordConfirm) { if(signUpErrorEl) signUpErrorEl.textContent = "비밀번호가 일치하지 않습니다."; return; }
            if (password.length < 6) { if(signUpErrorEl) signUpErrorEl.textContent = "비밀번호는 6자리 이상이어야 합니다."; return; }

            createAccountBtn.disabled = true; createAccountBtn.textContent = "계정 생성 중...";
            const { user, error } = await signUpWithEmail(email, password);
            createAccountBtn.disabled = false; createAccountBtn.textContent = "계정 생성 및 인증 메일 발송";

            if (error) {
                if(signUpErrorEl) signUpErrorEl.textContent = "계정 생성 실패: " + (error.code === 'auth/email-already-in-use' ? '이미 사용 중인 이메일입니다.' : error.message);
            } else if (user) {
                currentAuthUser = user; // 임시로 auth user 객체 저장
                currentUserId = user.uid; // UID 저장
                localStorage.setItem('lozee_userId', currentUserId); // UID 즉시 저장
                if(verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                if(steps.emailVerification) showStep(steps.emailVerification);
            }
        };

        // 이메일 인증 확인 버튼
        if(checkVerificationBtn) checkVerificationBtn.onclick = async () => {
            if (!firebaseAuth.currentUser) { // firebaseAuth는 firebase-config.js에서 import
                if(verificationErrorEl) verificationErrorEl.textContent = "사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.";
                showStep(steps.login);
                return;
            }
            checkVerificationBtn.disabled = true; checkVerificationBtn.textContent = "확인 중...";
            await firebaseAuth.currentUser.reload(); // 최신 사용자 상태 가져오기
            checkVerificationBtn.disabled = false; checkVerificationBtn.textContent = "이메일 인증 완료";

            if (firebaseAuth.currentUser.emailVerified) {
                console.log("이메일 인증 완료!");
                if(verificationErrorEl) verificationErrorEl.textContent = '';
                // 인증 완료 후 프로필 입력 단계로 이동
                if (selectedUserType === 'caregiver') {
                    if(steps.caregiverNd) showStep(steps.caregiverNd);
                } else { // directUser
                    if(diagnosisTitleEl) diagnosisTitleEl.textContent = "현재 어떤 어려움을 느끼고 있나요?";
                    if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 항목을 모두 선택해주세요. (중복 선택 가능)";
                    if(steps.diagnosisType) showStep(steps.diagnosisType);
                }
            } else {
                if(verificationErrorEl) verificationErrorEl.textContent = "아직 이메일 인증이 완료되지 않았습니다. 메일함의 인증 링크를 클릭해주세요.";
            }
        };

        // 인증 메일 다시 보내기 버튼
        if(resendVerificationBtn) resendVerificationBtn.onclick = async () => {
            if (firebaseAuth.currentUser) {
                try {
                    await sendEmailVerification(firebaseAuth.currentUser);
                    alert("인증 메일을 다시 보냈습니다. 메일함을 확인해주세요.");
                } catch (error) {
                    console.error("인증 메일 재발송 실패:", error);
                    alert("인증 메일 재발송에 실패했습니다: " + error.message);
                }
            } else {
                alert("사용자 정보를 찾을 수 없습니다. 로그인 단계로 이동합니다.");
                showStep(steps.login);
            }
        };

        // --- 프로필 정보 입력 단계 이벤트 핸들러들 (temp 변수에 정보 저장) ---
        // (이전과 동일하게 각 버튼 클릭 시 temp 변수 업데이트 및 showStep 호출)
        if(submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => {
            // tempSelectedCaregiverNd는 버튼 클릭 시 이미 업데이트됨
            if(diagnosisTitleEl) diagnosisTitleEl.textContent = "아이(또는 가족)의 어떤 점에 대해 이야기 나누고 싶으세요?";
            if(diagnosisInfoEl) diagnosisInfoEl.textContent = "해당하는 어려움을 모두 선택해주세요. (중복 선택 가능)";
            if(steps.diagnosisType) showStep(steps.diagnosisType);
        };

        if(submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => {
            if (tempSelectedDiagnoses.length === 0) {
                if(diagnosisError) diagnosisError.textContent = "하나 이상 선택해주세요."; return;
            }
            if(diagnosisError) diagnosisError.textContent = '';
            if (selectedUserType === 'caregiver') {
                if(nameBirthSelfTitleEl) nameBirthSelfTitleEl.textContent = "보호자님의 정보를 알려주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 18, 70);
            } else {
                if(nameBirthSelfTitleEl) nameBirthSelfTitleEl.textContent = "만나서 반가워요! 당신에 대해 알려주세요.";
                populateBirthSelects(birthSelfYear, birthSelfMonth, birthSelfDay, 3, 90);
            }
            if(steps.nameBirthSelf) showStep(steps.nameBirthSelf);
        };

        if(submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => {
            const name = nameSelfInput.value.trim();
            const y = birthSelfYear.value, m = birthSelfMonth.value, d = birthSelfDay.value;
            if (!name) { if(nameSelfError) nameSelfError.textContent = '이름(또는 별명)을 입력해주세요.'; return; }
            if(nameSelfError) nameSelfError.textContent = '';
            if (!y || !m || !d) { if(birthSelfError) birthSelfError.textContent = '생년월일을 모두 선택해주세요.'; return; }
            if(birthSelfError) birthSelfError.textContent = '';
            const age = calculateAge(y, m, d);
            if (age === null) { if(birthSelfError) birthSelfError.textContent = '유효한 생년월일을 입력해주세요.'; return; }
            const birthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            if (selectedUserType === 'caregiver') {
                tempCaregiverSelfName = name; tempCaregiverSelfBirthDate = birthDate; tempCaregiverSelfAge = age;
                if(nameChildInput) nameChildInput.value = '';
                populateBirthSelects(birthChildYear, birthChildMonth, birthChildDay, 0, 18);
                if(steps.nameBirthChild) showStep(steps.nameBirthChild);
            } else {
                tempDirectUserName = name; tempDirectUserBirthDate = birthDate; tempDirectUserAge = age;
                if(steps.finalStart) showStep(steps.finalStart); // 당사자는 바로 최종 단계로
            }
        };

        if(submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => {
            const name = nameChildInput.value.trim();
            const y = birthChildYear.value, m = birthChildMonth.value, d = birthChildDay.value;
            if (!name) { if(nameChildError) nameChildError.textContent = '아이(또는 가족)의 이름을 입력해주세요.'; return; }
            if(nameChildError) nameChildError.textContent = '';
            if (!y || !m || !d) { if(birthChildError) birthChildError.textContent = '아이(또는 가족)의 생년월일을 모두 선택해주세요.'; return; }
            if(birthChildError) birthChildError.textContent = '';
            const age = calculateAge(y,m,d);
            if (age === null) { if(birthChildError) birthChildError.textContent = '유효한 생년월일을 입력해주세요.'; return; }
            tempChildName = name; tempChildBirthDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; tempChildAge = age;
            if(steps.childLink) showStep(steps.childLink); // 자녀 정보 입력 후 자녀 계정 연결 단계로
        };
        
        // 자녀 계정 연결 시도 버튼
        if(sendChildLinkRequestBtn) sendChildLinkRequestBtn.onclick = async () => {
            const childEmailToLink = childLinkEmailInput.value.trim();
            if(childLinkErrorEl) childLinkErrorEl.textContent = '';
            if (childEmailToLink) {
                // TODO: 자녀에게 연결 요청 보내는 로직 구현 (예: Firestore에 connectionRequests 문서 생성)
                // 이메일 유효성 검사 추가 가능
                if (!/^\S+@\S+\.\S+$/.test(childEmailToLink)) {
                    if(childLinkErrorEl) childLinkErrorEl.textContent = "올바른 이메일 형식이 아닙니다.";
                    return;
                }
                try {
                    const requestRef = await addDoc(collection(db, "connectionRequests"), {
                        parentUid: currentUserId,
                        parentName: tempCaregiverSelfName, // 보호자 이름
                        childEmail: childEmailToLink.toLowerCase(),
                        status: "pending",
                        requestedAt: serverTimestamp()
                    });
                    console.log("자녀 계정 연결 요청 전송됨, ID:", requestRef.id);
                    alert(`${childEmailToLink}로 자녀 계정 연결 요청을 보냈습니다. 자녀가 수락하면 연결됩니다.`);
                } catch (e) {
                    console.error("자녀 계정 연결 요청 저장 실패:", e);
                    if(childLinkErrorEl) childLinkErrorEl.textContent = "연결 요청을 보내는 데 실패했습니다. 다시 시도해주세요.";
                    return; // 실패 시 중단
                }
            }
            if(steps.finalStart) showStep(steps.finalStart); // 연결 요청 후 (또는 입력 안 함) 최종 시작 단계로
        };

        // 자녀 계정 연결 건너뛰기 버튼
        if(skipChildLinkBtn) skipChildLinkBtn.onclick = () => {
            if(childLinkEmailInput) childLinkEmailInput.value = '';
            if(steps.finalStart) showStep(steps.finalStart);
        };

        // 최종 "로지와 대화 시작하기" 버튼
        if(startLozeeConversationBtn) startLozeeConversationBtn.onclick = async () => {
            if (!currentUserId) {
                alert("사용자 인증 정보가 없습니다. 페이지를 새로고침하거나 다시 시도해주세요.");
                return;
            }

            let profileData = {
                role: selectedUserType === 'caregiver' ? 'parent' : 'child',
                userType: selectedUserType,
                name: selectedUserType === 'caregiver' ? tempCaregiverSelfName : tempDirectUserName,
                birthDate: selectedUserType === 'caregiver' ? tempCaregiverSelfBirthDate : tempDirectUserBirthDate,
                age: selectedUserType === 'caregiver' ? tempCaregiverSelfAge : tempDirectUserAge,
            };

            let userNameForTalk = profileData.name;
            let ageForTalkContext = profileData.age;

            if (selectedUserType === 'caregiver') {
                profileData.caregiverInfo = {
                    caregiverNeurodiversity: tempSelectedCaregiverNd,
                    childName: tempChildName,
                    childBirthDate: tempChildBirthDate,
                    childAge: tempChildAge,
                    childDiagnoses: tempSelectedDiagnoses,
                    childLozeeEmail: childLinkEmailInput.value.trim() || null // 연결 시도한 자녀 이메일 저장
                };
                profileData.diagnoses = [];
                ageForTalkContext = tempChildAge;
            } else {
                profileData.diagnoses = tempSelectedDiagnoses;
            }

            const saveSuccess = await saveUserProfile(currentUserId, profileData); // auth.js의 함수 사용
            if (saveSuccess) {
                setLocalStorageAndRedirect(profileData, ageForTalkContext, profileData.caregiverInfo);
            }
        };


        // --- 페이지 로드 시 실행: Firebase Auth 상태 감지 및 UI 초기화 ---
        listenAuthState(
            async (user, userProfile) => { // 로그인된 경우
                console.log("Index: 로그인 상태. UID:", user.uid, "프로필:", userProfile);
                currentUserId = user.uid; // 전역 변수 currentUserId 설정

                if (userProfile && userProfile.name && userProfile.userType) {
                    // 프로필 정보가 충분하면 바로 talk.html로 (필요시)
                    console.log("Index: 기존 사용자 프로필 로드 완료. talk.html로 이동합니다.");
                    let ageForTalk = userProfile.age;
                    if (userProfile.userType === 'caregiver' && userProfile.caregiverInfo) {
                        ageForTalk = userProfile.caregiverInfo.childAge;
                    }
                    setLocalStorageAndRedirect(userProfile, ageForTalk, userProfile.caregiverInfo);
                } else {
                    // 프로필 정보가 부족하면 역할 선택부터 시작
                    console.log("Index: 기존 사용자 프로필 정보 부족. 역할 선택 단계부터 시작합니다.");
                    if(userProfile && userProfile.userType) selectedUserType = userProfile.userType; // 기존 타입 유지
                    if(steps.userType) showStep(steps.userType);
                }
            },
            () => { // 로그아웃된 경우
                console.log("Index: 로그아웃 상태. 로그인/회원가입 선택 화면 표시.");
                currentUserId = null;
                clearInputFields();
                if(steps.authChoice) showStep(steps.authChoice);
            }
        );

    </script>
</body>
</html>