<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOZEE - 신경다양성을 위한 대화 플랫폼</title>
    <style>
        body { font-family: 'KoPub World Dotum', sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .step { display: none; max-width: 400px; margin: 0 auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .step.active { display: block; }
        input, button { width: 85%; max-width: 350px; padding: 10px; margin: 10px 0; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; }
        button { background: #6e8efb; color: #fff; border: none; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error { color: #ffcdd2; font-size: 0.9em; }
        .optional-text { color: #888; font-size: 0.8em; }
        .progress-bar { width: 85%; max-width: 350px; height: 10px; background: #e0e0e0; border-radius: 5px; margin: 10px auto; }
        .progress { height: 100%; background: #6e8efb; border-radius: 5px; transition: width 0.3s ease; }
        .progress-text { text-align: center; font-size: 0.9em; color: #333; margin-bottom: 10px; }
        .animation-toggle { margin: 10px auto; text-align: center; }
    </style>
</head>
<body>
    <main>
        <!-- 진행 바 -->
        <div class="progress-bar">
            <div id="progress" class="progress" style="width: 0%;"></div>
        </div>
        <div class="progress-text" id="progressText">1/9단계</div>
        <div class="animation-toggle">
            <label><input type="checkbox" id="disableAnimations"> 애니메이션 비활성화</label>
        </div>

        <!-- stepAuthChoice -->
        <section id="stepAuthChoice" class="step">
            <h2>LOZEE에 오신 것을 환영합니다!</h2>
            <button id="goToLoginBtn">로그인</button>
            <button id="goToSignUpBtn">회원가입</button>
        </section>

        <!-- stepLogin -->
        <section id="stepLogin" class="step">
            <h2>로그인</h2>
            <input type="email" id="loginEmailInput" placeholder="이메일">
            <div id="loginEmailError" class="error"></div>
            <input type="password" id="loginPasswordInput" placeholder="비밀번호">
            <div id="loginPasswordError" class="error"></div>
            <button id="loginBtn">로그인</button>
            <a href="#" id="forgotPasswordBtn">비밀번호를 잊으셨나요?</a>
            <a href="#" id="goToSignUpFromLoginBtn">계정이 없으신가요? 회원가입</a>
        </section>

        <!-- stepResetPassword -->
        <section id="stepResetPassword" class="step">
            <h2>비밀번호 재설정</h2>
            <p>가입하신 이메일 주소를 입력하시면, 비밀번호 재설정 링크를 보내드립니다.</p>
            <input type="email" id="resetEmailInput" placeholder="이메일">
            <div id="resetEmailError" class="error"></div>
            <button id="sendResetEmailBtn">재설정 이메일 발송</button>
            <a href="#" id="backToLoginBtn">로그인으로 돌아가기</a>
        </section>

        <!-- stepUserType -->
        <section id="stepUserType" class="step">
            <h2>회원가입</h2>
            <p>어떤 역할로 로지를 이용하시겠어요?</p>
            <button class="user-type-btn" data-usertype="directUser">제가 직접 이야기 나눌 거예요<br>(신경다양인 당사자)</button>
            <button class="user-type-btn" data-usertype="caregiver">제가 보호자예요<br>(양육자, 배우자 등)</button>
            <div id="userTypeError" class="error"></div>
            <a href="#" id="goToLoginFromUserTypeBtn">이미 계정이 있으신가요? 로그인</a>
        </section>

        <!-- stepTermsAgreement -->
        <section id="stepTermsAgreement" class="step">
            <h2>서비스 이용 약관 및 개인정보처리방침 동의</h2>
            <p>로지 서비스 이용을 위해 아래 약관에 동의해주세요.</p>
            <label><input type="checkbox" id="agreeTerms"> (필수) <a href="./terms.html" target="_blank">서비스 이용약관</a>에 동의합니다.</label>
            <label><input type="checkbox" id="agreePrivacy"> (필수) <a href="./privacy.html" target="_blank">개인정보처리방침</a>에 동의합니다.</label>
            <label><input type="checkbox" id="agreeMarketing"> (선택) 마케팅 정보 수신에 동의합니다.</label>
            <div id="termsError" class="error"></div>
            <button id="submitTermsBtn">다음</button>
            <a href="#" id="backToUserTypeBtn">이전 (역할 다시 선택)</a>
        </section>

        <!-- stepSignUpEmailPassword -->
        <section id="stepSignUpEmailPassword" class="step">
            <h2>회원가입: 계정 정보 입력</h2>
            <p>로지 서비스 이용을 위한 계정 정보를 입력해주세요.<br>이메일은 로그인 ID로 사용되며, 비밀번호 재설정 시 필요합니다.</p>
            <input type="email" id="signUpEmailInput" placeholder="이메일">
            <div id="signUpEmailError" class="error"></div>
            <input type="password" id="signUpPasswordInput" placeholder="비밀번호 (6자리 이상)">
            <div id="signUpPasswordError" class="error"></div>
            <input type="password" id="signUpPasswordConfirmInput" placeholder="비밀번호 확인">
            <div id="signUpPasswordConfirmError" class="error"></div>
            <button id="createAccountBtn">계정 생성 및 인증 메일 발송</button>
        </section>

        <!-- stepEmailVerification -->
        <section id="stepEmailVerification" class="step">
            <h2>이메일 인증 안내</h2>
            <p>가입하신 이메일 주소(<strong id="verificationEmailDisplay"></strong>)로 인증 메일을 보냈습니다.<br>메일을 확인하고 인증 링크를 클릭해주세요.</p>
            <p>인증을 완료하셨으면 아래 버튼을 눌러주세요.</p>
            <div id="verificationError" class="error"></div>
            <button id="checkVerificationBtn">이메일 인증 완료</button>
            <button id="resendVerificationBtn">인증 메일 다시 보내기</button>
        </section>

        <!-- stepCaregiverNeurodiversity -->
        <section id="stepCaregiverNeurodiversity" class="step">
            <h2>보호자님에 대해서도 알려주시겠어요? <span class="optional-text">(선택 사항)</span></h2>
            <p>본인 또는 관계인(예: 배우자)께서 신경다양성 특성을 가지고 계시다면, 해당하는 항목을 모두 선택해주세요.</p>
            <button class="caregiver-nd-option" data-value="caregiver_asd">저(보호자)에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-option" data-value="caregiver_adhd">저(보호자)에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-option" data-value="spouse_asd">배우자에게 자폐 스펙트럼(ASD) 성향이 있어요.</button>
            <button class="caregiver-nd-option" data-value="spouse_adhd">배우자에게 ADHD 성향이 있어요.</button>
            <button class="caregiver-nd-option" data-value="unsure_or_none">잘 모르거나 해당 사항 없어요.</button>
            <div id="caregiverNdError" class="error"></div>
            <button id="submitCaregiverNdBtn">다음 (또는 건너뛰기)</button>
        </section>

        <!-- stepSpecialistDiagnosisCaregiver -->
        <section id="stepSpecialistDiagnosisCaregiver" class="step">
            <h2>전문의 진단 여부</h2>
            <p>선택하신 특성은 전문의에게 진단받은 정보인가요?</p>
            <label><input type="radio" name="specialistDiagnosisCaregiver" value="true"> 예</label>
            <label><input type="radio" name="specialistDiagnosisCaregiver" value="false"> 아니요</label>
            <div id="specialistDiagnosisCaregiverError" class="error"></div>
            <button id="submitSpecialistDiagnosisCaregiverBtn">다음</button>
        </section>

        <!-- stepDiagnosisType -->
        <section id="stepDiagnosisType" class="step">
            <h2>특성 이해하기</h2>
            <p>해당하는 항목을 모두 선택해주세요. (중복 선택 가능)</p>
            <button class="diagnosis-option" data-value="ASD">자폐 스펙트럼 (ASD)</button>
            <button class="diagnosis-option" data-value="ADHD">주의력 결핍 과잉행동 장애 (ADHD)</button>
            <button class="diagnosis-option" data-value="Asperger">아스퍼거 증후군</button>
            <button class="diagnosis-option" data-value="Tic">틱 장애</button>
            <button class="diagnosis-option" data-value="Learning">학습 장애</button>
            <button class="diagnosis-option" data-value="Other">기타 어려움/궁미증</button>
            <button class="diagnosis-option" data-value="Unsure">아직 잘 모르겠어요</button>
            <button class="diagnosis-option" data-value="NotApplicable">특별히 해당 없음</button>
            <div id="diagnosisError" class="error"></div>
            <button id="submitDiagnosisBtn">다음</button>
        </section>

        <!-- stepSpecialistDiagnosisDirectUser -->
        <section id="stepSpecialistDiagnosisDirectUser" class="step">
            <h2>전문의 진단 여부</h2>
            <p>선택하신 특성은 전문의에게 진단받은 정보인가요?</p>
            <label><input type="radio" name="specialistDiagnosisDirectUser" value="true"> 예</label>
            <label><input type="radio" name="specialistDiagnosisDirectUser" value="false"> 아니요</label>
            <div id="specialistDiagnosisDirectUserError" class="error"></div>
            <button id="submitSpecialistDiagnosisDirectUserBtn">다음</button>
        </section>

        <!-- stepNameBirthSelf -->
        <section id="stepNameBirthSelf" class="step">
            <h2>정보 입력</h2>
            <p>로지가 당신을 어떻게 부르면 좋을까요?</p>
            <input type="text" id="nameSelfInput" placeholder="이름">
            <div id="nameSelfError" class="error"></div>
            <p>생년월일을 선택해주세요.<br>만 나이를 계산하여 맞춤형 대화를 제공합니다.</p>
            <select id="birthYearSelf"></select>
            <select id="birthMonthSelf"></select>
            <select id="birthDaySelf"></select>
            <div id="birthSelfError" class="error"></div>
            <button id="submitNameBirthSelfBtn">다음</button>
        </section>

        <!-- stepNameBirthChild -->
        <section id="stepNameBirthChild" class="step">
            <h2>아이(또는 가족)의 정보를 알려주세요.</h2>
            <p>로지가 아이(또는 가족)를 어떻게 부르면 좋을까요?</p>
            <input type="text" id="nameChildInput" placeholder="이름">
            <div id="nameChildError" class="error"></div>
            <p>아이(또는 가족)의 생년월일을 선택해주세요.<br>아이에게 더 적절한 대화 경험을 제공합니다.</p>
            <select id="birthYearChild"></select>
            <select id="birthMonthChild"></select>
            <select id="birthDayChild"></select>
            <div id="birthChildError" class="error"></div>
            <button id="submitNameBirthChildBtn">다음</button>
        </section>

        <!-- stepFinalStart -->
        <section id="stepFinalStart" class="step">
            <h2>모든 준비가 끝났어요!</h2>
            <p>입력해주신 정보를 바탕으로 로지가 더 의미있는 대화를 나눌 수 있을 거예요.</p>
            <button id="startLozeeConversationBtn">로지와 대화 시작하기</button>
        </section>
    </main>

    <script type="module">
        // Firebase 설정 모듈 가져오기
        import { db, auth as firebaseAuth } from './js/firebase-config.js';
        import {
            listenAuthState,
            signUpWithEmail,
            signInWithEmail,
            resetPassword,
            saveUserProfile,
            sendVerificationEmail
        } from './js/auth.js';
        import { collection, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // DOM 요소
        const steps = document.querySelectorAll('.step');
        const goToLoginBtn = document.getElementById('goToLoginBtn');
        const goToSignUpBtn = document.getElementById('goToSignUpBtn');
        const loginEmailInput = document.getElementById('loginEmailInput');
        const loginPasswordInput = document.getElementById('loginPasswordInput');
        const loginEmailError = document.getElementById('loginEmailError');
        const loginPasswordError = document.getElementById('loginPasswordError');
        const loginBtn = document.getElementById('loginBtn');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const goToSignUpFromLoginBtn = document.getElementById('goToSignUpFromLoginBtn');
        const resetEmailInput = document.getElementById('resetEmailInput');
        const resetEmailError = document.getElementById('resetEmailError');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const userTypeError = document.getElementById('userTypeError');
        const userTypeButtons = document.querySelectorAll('.user-type-btn');
        const goToLoginFromUserTypeBtn = document.getElementById('goToLoginFromUserTypeBtn');
        const agreeTerms = document.getElementById('agreeTerms');
        const agreePrivacy = document.getElementById('agreePrivacy');
        const agreeMarketing = document.getElementById('agreeMarketing');
        const termsError = document.getElementById('termsError');
        const submitTermsBtn = document.getElementById('submitTermsBtn');
        const backToUserTypeBtn = document.getElementById('backToUserTypeBtn');
        const signUpEmailInput = document.getElementById('signUpEmailInput');
        const signUpPasswordInput = document.getElementById('signUpPasswordInput');
        const signUpPasswordConfirmInput = document.getElementById('signUpPasswordConfirmInput');
        const signUpEmailError = document.getElementById('signUpEmailError');
        const signUpPasswordError = document.getElementById('signUpPasswordError');
        const signUpPasswordConfirmError = document.getElementById('signUpPasswordConfirmError');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const verificationEmailDisplayEl = document.getElementById('verificationEmailDisplay');
        const verificationErrorEl = document.getElementById('verificationError');
        const checkVerificationBtn = document.getElementById('checkVerificationBtn');
        const resendVerificationBtn = document.getElementById('resendVerificationBtn');
        const caregiverNdOptionBtns = document.querySelectorAll('.caregiver-nd-option');
        const caregiverNdError = document.getElementById('caregiverNdError');
        const submitCaregiverNdBtn = document.getElementById('submitCaregiverNdBtn');
        const specialistDiagnosisCaregiverRadios = document.querySelectorAll('input[name="specialistDiagnosisCaregiver"]');
        const specialistDiagnosisCaregiverError = document.getElementById('specialistDiagnosisCaregiverError');
        const submitSpecialistDiagnosisCaregiverBtn = document.getElementById('submitSpecialistDiagnosisCaregiverBtn');
        const diagnosisOptionBtns = document.querySelectorAll('.diagnosis-option');
        const diagnosisError = document.getElementById('diagnosisError');
        const submitDiagnosisBtn = document.getElementById('submitDiagnosisBtn');
        const specialistDiagnosisDirectUserRadios = document.querySelectorAll('input[name="specialistDiagnosisDirectUser"]');
        const specialistDiagnosisDirectUserError = document.getElementById('specialistDiagnosisDirectUserError');
        const submitSpecialistDiagnosisDirectUserBtn = document.getElementById('submitSpecialistDiagnosisDirectUserBtn');
        const nameSelfInput = document.getElementById('nameSelfInput');
        const nameSelfError = document.getElementById('nameSelfError');
        const birthYearSelf = document.getElementById('birthYearSelf');
        const birthMonthSelf = document.getElementById('birthMonthSelf');
        const birthDaySelf = document.getElementById('birthDaySelf');
        const birthSelfError = document.getElementById('birthSelfError');
        const submitNameBirthSelfBtn = document.getElementById('submitNameBirthSelfBtn');
        const nameChildInput = document.getElementById('nameChildInput');
        const nameChildError = document.getElementById('nameChildError');
        const birthYearChild = document.getElementById('birthYearChild');
        const birthMonthChild = document.getElementById('birthMonthChild');
        const birthDayChild = document.getElementById('birthDayChild');
        const birthChildError = document.getElementById('birthChildError');
        const submitNameBirthChildBtn = document.getElementById('submitNameBirthChildBtn');
        const startLozeeConversationBtn = document.getElementById('startLozeeConversationBtn');

        // 상태 변수
        let currentUserId = null;
        let selectedUserType = null;
        let tempUserName = null;
        let tempUserBirthDate = null;
        let tempUserAge = null;
        let tempAgreedTerms = false;
        let tempAgreedPrivacy = false;
        let tempAgreedMarketing = false;
        let tempSelectedCaregiverNd = [];
        let tempIsSpecialistDiagnosedCaregiver = false;
        let tempSelectedDiagnoses = [];
        let tempIsSpecialistDiagnosedChild = false;
        let tempIsSpecialistDiagnosedDirectUser = false;
        let tempChildName = null;
        let tempChildBirthDate = null;
        let tempChildAge = null;

        // 헬퍼 함수: 토스트 메시지 표시
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = '#333';
            toast.style.color = '#fff';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '5px';
            toast.style.zIndex = '1000';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        // 헬퍼 함수: 입력 필드 초기화
        function clearInputFields() {
            [loginEmailInput, loginPasswordInput, resetEmailInput, signUpEmailInput, signUpPasswordInput, signUpPasswordConfirmInput, nameSelfInput, nameChildInput].forEach(input => {
                if (input) input.value = '';
            });
            [loginEmailError, loginPasswordError, resetEmailError, signUpEmailError, signUpPasswordError, signUpPasswordConfirmError, userTypeError, termsError, verificationError, caregiverNdError, specialistDiagnosisCaregiverError, diagnosisError, specialistDiagnosisDirectUserError, nameSelfError, birthSelfError, nameChildError, birthChildError].forEach(error => {
                if (error) error.textContent = '';
            });
            [agreeTerms, agreePrivacy, agreeMarketing].forEach(checkbox => {
                if (checkbox) checkbox.checked = false;
            });
            document.querySelectorAll('input[name="specialistDiagnosisCaregiver"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('input[name="specialistDiagnosisDirectUser"]').forEach(radio => radio.checked = false);
            caregiverNdOptionBtns.forEach(btn => btn.classList.remove('selected'));
            diagnosisOptionBtns.forEach(btn => btn.classList.remove('selected'));
            [birthYearSelf, birthMonthSelf, birthDaySelf, birthYearChild, birthMonthChild, birthDayChild].forEach(select => {
                if (select) select.value = '';
            });
            tempUserName = tempUserBirthDate = tempUserAge = tempAgreedTerms = tempAgreedPrivacy = tempAgreedMarketing = null;
            tempSelectedCaregiverNd = [];
            tempIsSpecialistDiagnosedCaregiver = tempIsSpecialistDiagnosedChild = tempIsSpecialistDiagnosedDirectUser = false;
            tempSelectedDiagnoses = [];
            tempChildName = tempChildBirthDate = tempChildAge = null;
        }

        // 헬퍼 함수: 단계 전환 및 진행 바 업데이트
        function showStep(stepId) {
            steps.forEach(step => step.classList.remove('active'));
            const targetStep = document.getElementById(`step${stepId.charAt(0).toUpperCase() + stepId.slice(1)}`);
            if (targetStep) targetStep.classList.add('active');

            // 진행 바 업데이트
            const caregiverSteps = ['userType', 'termsAgreement', 'signUpEmailPassword', 'emailVerification', 'caregiverNeurodiversity', 'specialistDiagnosisCaregiver', 'diagnosisType', 'nameBirthChild', 'finalStart'];
            const directUserSteps = ['userType', 'termsAgreement', 'signUpEmailPassword', 'emailVerification', 'diagnosisType', 'specialistDiagnosisDirectUser', 'nameBirthSelf', 'finalStart'];
            const stepsOrder = selectedUserType === 'caregiver' ? caregiverSteps : directUserSteps;
            const currentStepIndex = stepsOrder.indexOf(stepId);
            const totalSteps = stepsOrder.length;
            const progressPercent = ((currentStepIndex + 1) / totalSteps) * 100;
            const progressBar = document.getElementById('progress');
            const progressText = document.getElementById('progressText');
            if (progressBar && progressText) {
                progressBar.style.width = `${progressPercent}%`;
                progressText.textContent = `${currentStepIndex + 1}/${totalSteps}단계`;
            }
        }

        // 헬퍼 함수: 생년월일 선택지 생성
        function populateBirthDateOptions(yearSelect, monthSelect, daySelect, maxAge = 90, minAge = 0) {
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '<option value="">년</option>';
            for (let y = currentYear - minAge; y >= currentYear - maxAge; y--) {
                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
            }
            monthSelect.innerHTML = '<option value="">월</option>';
            for (let m = 1; m <= 12; m++) {
                monthSelect.innerHTML += `<option value="${m}">${m}</option>`;
            }
            daySelect.innerHTML = '<option value="">일</option>';
            for (let d = 1; d <= 31; d++) {
                daySelect.innerHTML += `<option value="${d}">${d}</option>`;
            }
        }

        // 헬퍼 함수: 나이 계산
        function calculateAge(year, month, day) {
            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // 헬퍼 함수: localStorage 설정 및 리다이렉트
        function setLocalStorageAndRedirect(userProfile, ageForTalk, childData, isCaregiverNeurodiverse) {
            localStorage.setItem('lozee_userProfile', JSON.stringify(userProfile));
            localStorage.setItem('lozee_ageForTalk', ageForTalk);
            if (childData) localStorage.setItem('lozee_childData', JSON.stringify(childData));
            localStorage.setItem('lozee_isCaregiverNeurodiverse', isCaregiverNeurodiverse);
            window.location.href = './mypage.html';
        }

        // 이벤트 핸들러: 초기 화면 이동
        if (goToLoginBtn) goToLoginBtn.onclick = () => showStep('login');
        if (goToSignUpBtn) goToSignUpBtn.onclick = () => showStep('userType');
        if (goToSignUpFromLoginBtn) goToSignUpFromLoginBtn.onclick = (e) => { e.preventDefault(); showStep('userType'); };
        if (goToLoginFromUserTypeBtn) goToLoginFromUserTypeBtn.onclick = (e) => { e.preventDefault(); showStep('login'); };
        if (backToLoginBtn) backToLoginBtn.onclick = (e) => { e.preventDefault(); showStep('login'); };
        if (backToUserTypeBtn) backToUserTypeBtn.onclick = (e) => { e.preventDefault(); showStep('userType'); };

        // 이벤트 핸들러: 로그인
        if (loginBtn) loginBtn.onclick = async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if (!email) loginEmailError.textContent = "이메일을 입력해주세요.";
            if (!password) loginPasswordError.textContent = "비밀번호를 입력해주세요.";
            if (!email || !password) return;
            loginBtn.disabled = true;
            loginBtn.textContent = "로그인 중...";
            const { user, error } = await signInWithEmail(email, password);
            loginBtn.disabled = false;
            loginBtn.textContent = "로그인";
            if (error) {
                if (error.code === 'auth/invalid-email') loginEmailError.textContent = "유효하지 않은 이메일 형식입니다.";
                else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') loginPasswordError.textContent = "이메일 또는 비밀번호가 잘못되었습니다.";
                else loginPasswordError.textContent = "로그인에 실패했습니다. 다시 시도해주세요.";
            } else {
                showToast("로그인 성공!");
            }
        };

        // 이벤트 핸들러: 비밀번호 재설정
        if (forgotPasswordBtn) forgotPasswordBtn.onclick = (e) => { e.preventDefault(); showStep('resetPassword'); };
        if (sendResetEmailBtn) sendResetEmailBtn.onclick = async () => {
            const email = resetEmailInput.value.trim();
            if (!email) {
                resetEmailError.textContent = "이메일을 입력해주세요.";
                return;
            }
            sendResetEmailBtn.disabled = true;
            sendResetEmailBtn.textContent = "발송 중...";
            const { success, error } = await resetPassword(email);
            sendResetEmailBtn.disabled = false;
            sendResetEmailBtn.textContent = "재설정 이메일 발송";
            if (success) {
                showToast("비밀번호 재설정 이메일을 보냈습니다.");
                showStep('login');
            } else {
                if (error.code === 'auth/invalid-email') resetEmailError.textContent = "유효하지 않은 이메일 형식입니다.";
                else if (error.code === 'auth/user-not-found') resetEmailError.textContent = "등록되지 않은 이메일입니다.";
                else resetEmailError.textContent = "이메일 발송에 실패했습니다. 다시 시도해주세요.";
            }
        };

        // 이벤트 핸들러: 역할 선택
        userTypeButtons.forEach(btn => {
            btn.onclick = () => {
                selectedUserType = btn.dataset.usertype;
                userTypeButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                userTypeError.textContent = '';
                showStep('termsAgreement');
            };
        });

        // 이벤트 핸들러: 약관 동의
        if (submitTermsBtn) submitTermsBtn.onclick = () => {
            if (!agreeTerms.checked || !agreePrivacy.checked) {
                termsError.textContent = "필수 약관에 모두 동의해주세요.";
                return;
            }
            tempAgreedTerms = agreeTerms.checked;
            tempAgreedPrivacy = agreePrivacy.checked;
            tempAgreedMarketing = agreeMarketing.checked;
            showStep('signUpEmailPassword');
        };

        // 이벤트 핸들러: 계정 생성
        if (createAccountBtn) createAccountBtn.onclick = async () => {
            const email = signUpEmailInput.value.trim();
            const password = signUpPasswordInput.value;
            const passwordConfirm = signUpPasswordConfirmInput.value;
            signUpEmailError.textContent = '';
            signUpPasswordError.textContent = '';
            signUpPasswordConfirmError.textContent = '';
            if (!email) signUpEmailError.textContent = "이메일을 입력해주세요.";
            if (!password) signUpPasswordError.textContent = "비밀번호를 입력해주세요.";
            if (password !== passwordConfirm) signUpPasswordConfirmError.textContent = "비밀번호가 일치하지 않습니다.";
            if (!email || !password || password !== passwordConfirm) return;
            if (password.length < 6) {
                signUpPasswordError.textContent = "비밀번호는 6자리 이상이어야 합니다.";
                return;
            }
            createAccountBtn.disabled = true;
            createAccountBtn.textContent = "계정 생성 중...";
            const { user, error } = await signUpWithEmail(email, password);
            createAccountBtn.disabled = false;
            createAccountBtn.textContent = "계정 생성 및 인증 메일 발송";
            if (error) {
                if (error.code === 'auth/email-already-in-use') {
                    signUpEmailError.textContent = "이미 사용 중인 이메일입니다. <a href='#' onclick='showStep(\"login\")'>로그인 페이지로 이동</a>.";
                } else if (error.code === 'auth/invalid-email') {
                    signUpEmailError.textContent = "유효하지 않은 이메일 형식입니다.";
                } else {
                    signUpEmailError.textContent = "계정 생성에 실패했습니다. 다시 시도해주세요.";
                }
            } else {
                showToast("인증 메일을 보냈습니다.");
                if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = email;
                localStorage.setItem('lozee_tempEmailForVerification', email);
                showStep('emailVerification');
            }
        };

        // 이벤트 핸들러: 이메일 인증 확인
        if (checkVerificationBtn) checkVerificationBtn.onclick = async () => {
            console.log("[checkVerificationBtn] 이메일 인증 확인");
            const currentUser = firebaseAuth.currentUser;
            if (!currentUser) {
                console.log("[checkVerificationBtn] 현재 사용자 없음, 로그인 페이지로 이동");
                if (verificationErrorEl) verificationErrorEl.textContent = "사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.";
                showStep('login');
                return;
            }
            checkVerificationBtn.disabled = true;
            checkVerificationBtn.textContent = "확인 중...";
            await currentUser.reload();
            checkVerificationBtn.disabled = false;
            checkVerificationBtn.textContent = "이메일 인증 완료";
            if (currentUser.emailVerified) {
                console.log("[checkVerificationBtn] 이메일 인증 완료, 사용자 ID:", currentUser.uid);
                currentUserId = currentUser.uid;
                localStorage.setItem('lozee_userId', currentUserId);

                // 초기 프로필 저장
                const userDoc = await getDoc(doc(db, 'users', currentUserId));
                if (!userDoc.exists()) {
                    console.log("[checkVerificationBtn] 사용자 프로필 없음, 초기 프로필 생성");
                    const initialProfile = {
                        uid: currentUserId,
                        email: currentUser.email,
                        createdAt: serverTimestamp(),
                        lastUpdate: serverTimestamp()
                    };
                    const saveSuccess = await saveUserProfile(currentUserId, initialProfile);
                    if (!saveSuccess) {
                        console.error("[checkVerificationBtn] 초기 프로필 저장 실패");
                        showToast("계정 설정에 실패했습니다. 다시 시도해주세요.");
                        showStep('login');
                        return;
                    }
                }

                // 루프 방지 플래그 설정
                localStorage.setItem('lozee_profile_check', 'true');
                showStep(selectedUserType === 'caregiver' ? 'caregiverNeurodiversity' : 'diagnosisType');
            } else {
                console.log("[checkVerificationBtn] 이메일 인증 미완료");
                if (verificationErrorEl) verificationErrorEl.textContent = "아직 이메일 인증이 완료되지 않았습니다. 메일함의 인증 링크를 클릭해주세요.";
            }
        };

        // 이벤트 핸들러: 인증 메일 재발송
        if (resendVerificationBtn) resendVerificationBtn.onclick = async () => {
            const currentUser = firebaseAuth.currentUser;
            if (!currentUser) {
                if (verificationErrorEl) verificationErrorEl.textContent = "사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.";
                showStep('login');
                return;
            }
            resendVerificationBtn.disabled = true;
            resendVerificationBtn.textContent = "발송 중...";
            try {
                await sendVerificationEmail(currentUser);
                showToast("인증 메일을 다시 보냈습니다.");
            } catch (error) {
                if (verificationErrorEl) verificationErrorEl.textContent = "인증 메일 재발송에 실패했습니다. 다시 시도해주세요.";
            }
            resendVerificationBtn.disabled = false;
            resendVerificationBtn.textContent = "인증 메일 다시 보내기";
        };

        // 이벤트 핸들러: 보호자 신경다양성 선택
        caregiverNdOptionBtns.forEach(btn => {
            btn.onclick = () => {
                if (btn.dataset.value === 'unsure_or_none') {
                    caregiverNdOptionBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    tempSelectedCaregiverNd = ['unsure_or_none'];
                } else {
                    caregiverNdOptionBtns.forEach(b => {
                        if (b.dataset.value === 'unsure_or_none') b.classList.remove('selected');
                    });
                    btn.classList.toggle('selected');
                    tempSelectedCaregiverNd = Array.from(caregiverNdOptionBtns)
                        .filter(b => b.classList.contains('selected'))
                        .map(b => b.dataset.value);
                }
                caregiverNdError.textContent = '';
            };
        });

        if (submitCaregiverNdBtn) submitCaregiverNdBtn.onclick = () => {
            if (tempSelectedCaregiverNd.length === 0) {
                tempSelectedCaregiverNd = ['unsure_or_none'];
            }
            showStep('specialistDiagnosisCaregiver');
        };

        // 이벤트 핸들러: 보호자 전문의 진단 여부
        if (submitSpecialistDiagnosisCaregiverBtn) submitSpecialistDiagnosisCaregiverBtn.onclick = () => {
            const selected = Array.from(specialistDiagnosisCaregiverRadios).find(radio => radio.checked);
            if (!selected) {
                specialistDiagnosisCaregiverError.textContent = "선택해주세요.";
                return;
            }
            tempIsSpecialistDiagnosedCaregiver = selected.value === 'true';
            showStep('diagnosisType');
        };

        // 이벤트 핸들러: 신경다양성 선택
        diagnosisOptionBtns.forEach(btn => {
            btn.onclick = () => {
                if (btn.dataset.value === 'Unsure' || btn.dataset.value === 'NotApplicable') {
                    diagnosisOptionBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    tempSelectedDiagnoses = [btn.dataset.value];
                } else {
                    diagnosisOptionBtns.forEach(b => {
                        if (b.dataset.value === 'Unsure' || b.dataset.value === 'NotApplicable') b.classList.remove('selected');
                    });
                    btn.classList.toggle('selected');
                    tempSelectedDiagnoses = Array.from(diagnosisOptionBtns)
                        .filter(b => b.classList.contains('selected'))
                        .map(b => b.dataset.value);
                }
                diagnosisError.textContent = '';
            };
        });

        if (submitDiagnosisBtn) submitDiagnosisBtn.onclick = () => {
            if (tempSelectedDiagnoses.length === 0) {
                diagnosisError.textContent = "하나 이상 선택해주세요.";
                return;
            }
            showStep(selectedUserType === 'caregiver' ? 'specialistDiagnosisCaregiver' : 'specialistDiagnosisDirectUser');
        };

        // 이벤트 핸들러: 당사자 전문의 진단 여부
        if (submitSpecialistDiagnosisDirectUserBtn) submitSpecialistDiagnosisDirectUserBtn.onclick = () => {
            const selected = Array.from(specialistDiagnosisDirectUserRadios).find(radio => radio.checked);
            if (!selected) {
                specialistDiagnosisDirectUserError.textContent = "선택해주세요.";
                return;
            }
            tempIsSpecialistDiagnosedDirectUser = selected.value === 'true';
            showStep('nameBirthSelf');
        };

        // 이벤트 핸들러: 본인 이름 및 생년월일
        if (submitNameBirthSelfBtn) submitNameBirthSelfBtn.onclick = () => {
            const name = nameSelfInput.value.trim();
            const year = birthYearSelf.value;
            const month = birthMonthSelf.value;
            const day = birthDaySelf.value;
            nameSelfError.textContent = '';
            birthSelfError.textContent = '';
            if (!name) {
                nameSelfError.textContent = "이름을 입력해주세요.";
                return;
            }
            if (!year || !month || !day) {
                birthSelfError.textContent = "생년월일을 모두 선택해주세요.";
                return;
            }
            tempUserName = name;
            tempUserBirthDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            tempUserAge = calculateAge(year, month, day);
            showStep('finalStart');
        };

        // 이벤트 핸들러: 자녀 이름 및 생년월일
        if (submitNameBirthChildBtn) submitNameBirthChildBtn.onclick = () => {
            const name = nameChildInput.value.trim();
            const year = birthYearChild.value;
            const month = birthMonthChild.value;
            const day = birthDayChild.value;
            nameChildError.textContent = '';
            birthChildError.textContent = '';
            if (!name) {
                nameChildError.textContent = "아이(또는 가족)의 이름을 입력해주세요.";
                return;
            }
            if (!year || !month || !day) {
                birthChildError.textContent = "생년월일을 모두 선택해주세요.";
                return;
            }
            tempChildName = name;
            tempChildBirthDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            tempChildAge = calculateAge(year, month, day);
            showStep('finalStart');
        };

        // 이벤트 핸들러: 최종 시작
        if (startLozeeConversationBtn) startLozeeConversationBtn.onclick = async () => {
            let profileData = {
                name: tempUserName,
                email: firebaseAuth.currentUser?.email,
                birthDate: tempUserBirthDate,
                age: tempUserAge,
                agreements: { terms: tempAgreedTerms, privacy: tempAgreedPrivacy, marketing: tempAgreedMarketing, agreedAt: serverTimestamp() },
                lastUpdate: serverTimestamp(),
                userType: selectedUserType,
                role: selectedUserType === 'caregiver' ? 'parent' : 'self',
                diagnoses: tempSelectedDiagnoses,
                isDirectUserDiagnosedBySpecialist: tempIsSpecialistDiagnosedDirectUser
            };
            if (selectedUserType === 'caregiver') {
                profileData.caregiverInfo = {
                    caregiverNeurodiversity: tempSelectedCaregiverNd,
                    isCaregiverDiagnosedBySpecialist: tempIsSpecialistDiagnosedCaregiver,
                    childName: tempChildName,
                    childBirthDate: tempChildBirthDate,
                    childAge: tempChildAge,
                    childDiagnoses: tempSelectedDiagnoses,
                    isChildDiagnosedBySpecialist: tempIsSpecialistDiagnosedChild
                };
            }
            startLozeeConversationBtn.disabled = true;
            startLozeeConversationBtn.textContent = "저장 중...";
            const saveSuccess = await saveUserProfile(currentUserId, profileData);
            startLozeeConversationBtn.disabled = false;
            startLozeeConversationBtn.textContent = "로지와 대화 시작하기";
            if (saveSuccess) {
                showToast("로그인 성공!");
                const userProfileForRedirect = { ...profileData };
                if (typeof userProfileForRedirect.userType === 'string') {
                    userProfileForRedirect.userType = [userProfileForRedirect.userType];
                    if (userProfileForRedirect.userType[0] === 'caregiver' &&
                        userProfileForRedirect.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                        !userProfileForRedirect.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                        userProfileForRedirect.userType.push('directUser');
                    }
                }
                let ageForTalk = userProfileForRedirect.age;
                let childDataForRedirect = null;
                let isCaregiverNeurodiverse = false;
                if (userProfileForRedirect.caregiverInfo) {
                    isCaregiverNeurodiverse = userProfileForRedirect.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                        !userProfileForRedirect.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                }
                if (Array.isArray(userProfileForRedirect.userType) && 
                    userProfileForRedirect.userType.includes('caregiver') && 
                    userProfileForRedirect.caregiverInfo) {
                    ageForTalk = userProfileForRedirect.caregiverInfo.childAge;
                    childDataForRedirect = userProfileForRedirect.caregiverInfo;
                }
                setLocalStorageAndRedirect(userProfileForRedirect, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
            } else {
                showToast("프로필 저장에 실패했습니다. 다시 시도해주세요.");
            }
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DOMContentLoaded] Index.html 로드 완료");
            populateBirthDateOptions(birthYearSelf, birthMonthSelf, birthDaySelf, 90, 3);
            populateBirthDateOptions(birthYearChild, birthMonthChild, birthDayChild, 18, 0);

            // 애니메이션 비활성화 설정
            const disableAnimationsCheckbox = document.getElementById('disableAnimations');
            if (disableAnimationsCheckbox) {
                disableAnimationsCheckbox.checked = localStorage.getItem('lozee_disable_animations') === 'true';
                disableAnimationsCheckbox.addEventListener('change', (e) => {
                    localStorage.setItem('lozee_disable_animations', e.target.checked);
                    document.querySelectorAll('.step, button, .progress').forEach(el => {
                        el.style.transition = e.target.checked ? 'none' : '';
                    });
                });
                if (disableAnimationsCheckbox.checked) {
                    document.querySelectorAll('.step, button, .progress').forEach(el => el.style.transition = 'none');
                }
            }

            // Firebase 인증 상태 감지
            listenAuthState(
                async (user, userProfile) => {
                    console.log("[listenAuthState] 로그인 상태 감지. UID:", user.uid);
                    currentUserId = user.uid;

                    // 이메일 미인증 시 인증 페이지로 이동
                    if (!user.emailVerified) {
                        console.log("[listenAuthState] 이메일 미인증, emailVerification으로 이동");
                        if (verificationEmailDisplayEl) verificationEmailDisplayEl.textContent = user.email;
                        localStorage.setItem('lozee_tempEmailForVerification', user.email);
                        showToast('이메일 인증이 필요합니다. 인증 이메일을 확인해주세요.');
                        showStep('emailVerification');
                        return;
                    }

                    // 프로필이 존재하고 userType이 있는 경우 로그인 처리
                    if (userProfile && userProfile.userType) {
                        console.log("[listenAuthState] 사용자 프로필 존재:", userProfile);
                        const userProfileForRedirect = { ...userProfile };

                        // userType이 단일 문자열인 레거시 데이터 처리
                        if (typeof userProfileForRedirect.userType === 'string') {
                            userProfileForRedirect.userType = [userProfileForRedirect.userType];
                            if (userProfileForRedirect.userType[0] === 'caregiver' &&
                                userProfileForRedirect.caregiverInfo?.caregiverNeurodiversity?.length > 0 &&
                                !userProfileForRedirect.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none')) {
                                userProfileForRedirect.userType.push('directUser');
                            }
                        }

                        let ageForTalk = userProfileForRedirect.age;
                        let childDataForRedirect = null;
                        let isCaregiverNeurodiverse = false;

                        if (userProfileForRedirect.caregiverInfo) {
                            isCaregiverNeurodiverse = userProfileForRedirect.caregiverInfo.caregiverNeurodiversity?.length > 0 &&
                                !userProfileForRedirect.caregiverInfo.caregiverNeurodiversity.includes('unsure_or_none');
                        }

                        if (Array.isArray(userProfileForRedirect.userType) && 
                            userProfileForRedirect.userType.includes('caregiver') && 
                            userProfileForRedirect.caregiverInfo) {
                            ageForTalk = userProfileForRedirect.caregiverInfo.childAge;
                            childDataForRedirect = userProfileForRedirect.caregiverInfo;
                        }

                        setLocalStorageAndRedirect(userProfileForRedirect, ageForTalk, childDataForRedirect, isCaregiverNeurodiverse);
                    } else {
                        // 프로필이 없으면 userType으로 이동, 루프 방지 확인
                        if (localStorage.getItem('lozee_profile_check') === 'true') {
                            console.log("[listenAuthState] 프로필 체크 완료, userType 유지");
                            showStep('userType');
                        } else {
                            console.log("[listenAuthState] 사용자 프로필 없음, 초기 프로필 생성");
                            const initialProfile = {
                                uid: currentUserId,
                                email: user.email,
                                createdAt: serverTimestamp(),
                                lastUpdate: serverTimestamp()
                            };
                            const saveSuccess = await saveUserProfile(currentUserId, initialProfile);
                            if (saveSuccess) {
                                localStorage.setItem('lozee_profile_check', 'true');
                                showStep('userType');
                            } else {
                                console.error("[listenAuthState] 초기 프로필 저장 실패");
                                showToast("계정 설정에 실패했습니다. 다시 시도해주세요.");
                                showStep('login');
                            }
                        }
                    }
                },
                () => {
                    console.log("[listenAuthState] 로그아웃 상태 감지.");
                    currentUserId = null;
                    clearInputFields();
                    showStep('authChoice');
                    showToast('로그아웃 상태입니다.');
                },
                clearInputFields,
                showStep
            );
        });
    </script>
</body>
</html>