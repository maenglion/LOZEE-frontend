<div class="container">
        <h1>ë‚˜ì˜ ëŒ€í™” ì„±ì°° ë³´ê³ ì„œ ğŸ§</h1>
        <div class="share-button-container">
            <button id="reportShareButton">ë³´ê³ ì„œ ê³µìœ í•˜ê¸° ğŸ”—</button>
        </div>

        <div class="section" id="conversationSummarySection">
            <h2>ğŸ“ ë¡œì§€ì™€ì˜ ëŒ€í™” ìš”ì•½</h2>
            <p class="assistant-analysis-notice">LOZEE AI ìš”ì•½</p>
            <p class="module-explanation">
                ë¡œì§€ì™€ì˜ ìµœê·¼ ëŒ€í™” ë‚´ìš©ì„ í•œëˆˆì— ë³¼ ìˆ˜ ìˆë„ë¡ ìš”ì•½í–ˆì–´ìš”. ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ì—ˆëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ ì‚´í´ë³´ì„¸ìš”.
            </p>
            <div id="conversationSummaryContent">
                <p>ìš”ì•½ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <div class="section" id="emotionToneSection">
            <h2>ğŸŒŠ ê°ì • íë¦„ ì‚´í´ë³´ê¸°</h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <p class="module-explanation">
                ëŒ€í™” ì¤‘ ë‚˜íƒ€ë‚œ ê°ì •ì˜ ë¶„í¬ë¥¼ í†µí•´ ìì‹ ì˜ ì£¼ëœ ê°ì • ê²½í–¥ì„ íŒŒì•…í•´ë³¼ ìˆ˜ ìˆì–´ìš”. ì–´ë–¤ ê°ì •ë“¤ì´ ì£¼ë¡œ ë‚˜íƒ€ë‚¬ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.
            </p>
            <div id="emotionChartContainer"> <canvas id="emotionChart"></canvas>
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p>
        </div>

        <div class="section" id="keywordsSection">
            <h2>ğŸ”‘ ë‚˜ì˜ ëŒ€í™” í‚¤ì›Œë“œ</h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
             <p class="module-explanation">
                ëŒ€í™”ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì¤‘ìš”í•˜ê²Œ ë‹¤ë¤„ì§„ í•µì‹¬ ë‹¨ì–´ë“¤ì´ì—ìš”. ì´ í‚¤ì›Œë“œë“¤ì„ í†µí•´ ëŒ€í™”ì˜ ì£¼ìš” ë§¥ë½ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>ğŸ’¡ í•¨ê»˜ ìƒê°í•´ ë³¼ ì </h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <p class="module-explanation">
                ëŒ€í™” ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë¡œì§€ê°€ í•¨ê»˜ ë” ê¹Šì´ íƒìƒ‰í•´ë³´ê³  ì‹¶ì€ ìƒê°ì´ë‚˜ ê´€ì ì„ ë°œê²¬í–ˆì–´ìš”. ì•„ë˜ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ìì‹ ì— ëŒ€í•œ ì´í•´ë¥¼ ë„“í˜€ë³´ì„¸ìš”. ë•Œë¡œëŠ” ìµìˆ™í•œ ìƒê°ì˜ í‹€ì—ì„œ ë²—ì–´ë‚˜ ìƒˆë¡œìš´ ê´€ì ì„ ë°œê²¬í•˜ëŠ” ê²ƒì´ ì„±ì¥ì˜ ê¸°íšŒê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">ì´ ì£¼ì œë¡œ ë¡œì§€ì™€ ë” ì´ì•¼ê¸°í•˜ê¸° ğŸ¤”</button>
        </div>

        <div class="section" id="analysisMethodologySection">
             <h2>LOZEEì˜ ë¶„ì„ ë°©ë²•ë¡ </h2>
            <p class="assistant-analysis-notice">LOZEE AI ë¶„ì„</p>
            <ul class="methodology-list">
                <li><strong>Russellì˜ ê°ì • ì›í˜• ëª¨í˜•</strong>: Valence(ì¾Œ-ë¶ˆì¾Œ)ì™€ Arousal(ê°ì„±-ì´ì™„) ì¶•ì„ ê¸°ë°˜ìœ¼ë¡œ ê°ì •ì˜ ìœ„ì¹˜ë¥¼ ë‹¤ì°¨ì›ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</li>
                <li><strong>Plutchikì˜ ê°ì • ë°”í€´</strong>: 8ê°€ì§€ ê¸°ë³¸ ê°ì •ê³¼ ê·¸ ê°•ë„ ë° ìœ ì‚¬ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë³µí•©ì ì¸ ê°ì • ìƒíƒœë¥¼ ì´í•´í•©ë‹ˆë‹¤.</li>
                <li><strong>Lexicon ê¸°ë°˜ ê°ì„± ë¶„ì„</strong>: í•œêµ­ì–´ ê°ì„± ì‚¬ì „(ì˜ˆ: KOSAC)ì„ í™œìš©í•˜ì—¬ í…ìŠ¤íŠ¸ì˜ ê¸ì •, ë¶€ì •, ì¤‘ë¦½ ê·¹ì„±ì„ íŒë‹¨í•©ë‹ˆë‹¤.</li>
                <li><strong>ë”¥ëŸ¬ë‹ ë¶„ë¥˜ ëª¨ë¸ (BERT/KoBERT)</strong>: ìµœì‹  ìì—°ì–´ ì²˜ë¦¬ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ë§¥ì„ ê³ ë ¤í•œ ê³ ì •ë°€ ê°ì • ê·¹ì„± ë° ì„¸ë¶€ ê°ì •(ì˜ˆ: ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸ ë“±)ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.</li>
                <li><strong>ì¸ì§€ì™œê³¡ ì´ë¡  (Beckì˜ CBT)</strong>: ì¸ì§€í–‰ë™ì¹˜ë£Œ ì´ë¡ ì— ê¸°ë°˜í•˜ì—¬ ëŒ€í™”ì—ì„œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆëŠ” ëŒ€í‘œì ì¸ ì¸ì§€ì™œê³¡ íŒ¨í„´(ì˜ˆ: í‘ë°±ë…¼ë¦¬, ê³¼ì‰ì¼ë°˜í™” ë“±)ì„ ê°ì§€í•©ë‹ˆë‹¤.</li>
                <li><strong>ëŒ€í™” ì£¼ì œ êµ¬ì¡°í™”</strong>: LOZEE AIì˜ ìì²´ ìƒë‹´ í† í”½ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ëŒ€í™”ì˜ íë¦„ê³¼ ì£¼ìš” ì£¼ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ íŒŒì•…í•˜ê³  ê´€ë ¨ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
            </ul>
        </div>

        <p class="footer-assistant-notice">ë³¸ ë¶„ì„ì€ ë¡œì§€ AIê°€ ë§ˆìŒì„ ë‹´ì•„ ì¤€ë¹„í–ˆì–´ìš”. ê°œì¸ì ì¸ ì„±ì°°ì„ ìœ„í•œ ì°¸ê³  ìë£Œë¡œ í™œìš©í•´ì£¼ì„¸ìš”.</p>
    </div>

    <script type="module">
        // --- í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í™•ì¸ (15ì„¸ ì´ìƒ) ---
        const ADULT_ANALYSIS_MIN_AGE = 15;
        const currentUserAgeForAccessCheck = parseInt(localStorage.getItem('lozee_userage'), 10);

        if (isNaN(currentUserAgeForAccessCheck) || currentUserAgeForAccessCheck < ADULT_ANALYSIS_MIN_AGE) {
            console.warn(`Adult Analysis Page: ì ‘ê·¼ ì œí•œ. ì‚¬ìš©ì ë‚˜ì´(${currentUserAgeForAccessCheck})ê°€ ${ADULT_ANALYSIS_MIN_AGE}ì„¸ ë¯¸ë§Œì…ë‹ˆë‹¤. analysis.htmlë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.`);
            window.location.replace('analysis.html'); // 15ì„¸ ë¯¸ë§Œì€ ì¼ë°˜ analysis.htmlë¡œ
        } else {
            // 15ì„¸ ì´ìƒ ì‚¬ìš©ìë§Œ ì•„ë˜ì˜ ë‚˜ë¨¸ì§€ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            console.log("Adult Analysis Page: ì ‘ê·¼ í—ˆìš©. ì‚¬ìš©ì ë‚˜ì´:", currentUserAgeForAccessCheck);

            let chartLibraryInitialized = false; // â­ initializeChartJsGlobal í•¨ìˆ˜ ë‚´ì—ì„œë§Œ ì‚¬ìš©ë˜ë„ë¡ ìœ„ì¹˜ ë³€ê²½ (ë˜ëŠ” ì „ì—­ ìœ ì§€)

            function initializeChartJsGlobal() { // â­ ì¤‘ë³µ ì„ ì–¸ ì œê±°, ì´ í•¨ìˆ˜ë§Œ ë‚¨ê¹€
                try {
                    if (typeof Chart !== 'undefined' && Chart) {
                        Chart.defaults.color = '#333';
                        Chart.defaults.borderColor = '#e0e0e0';
                        Chart.defaults.font.family = "'KoPub World Dotum', sans-serif";
                        Chart.defaults.font.size = 12;
                        console.log("Adult Analysis Page: Chart.js(UMD) ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¸ì‹ë˜ê³  ê¸°ë³¸ê°’ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        chartLibraryInitialized = true; // â­ let ì„ ì–¸ ì œê±°, í• ë‹¹ë§Œ
                        return true;
                    } else {
                        console.error("Adult Analysis Page: Chart.js(UMD) ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        const emotionChartContainer = document.getElementById('emotionChartContainer');
                        if (emotionChartContainer) {
                            emotionChartContainer.innerHTML = '<p style="text-align:center; color:red; padding:20px;">ì°¨íŠ¸ ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìˆì–´ìš”. ğŸ˜­<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.</p>';
                        }
                        return false;
                    }
                } catch (error) {
                    console.error("Adult Analysis Page: Chart.js(UMD) ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜!", error);
                    return false;
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                console.log("Adult Analysis Page: DOMContentLoaded ì´ë²¤íŠ¸ ì‹œì‘");
                const chartJsIsReady = initializeChartJsGlobal();

                // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
                const conversationSummaryContentEl = document.getElementById('conversationSummaryContent');
                const emotionChartEl = document.getElementById('emotionChart');
                const emotionChartContainerEl = document.getElementById('emotionChartContainer');
                const empathyMessageEl = document.getElementById('empathyMessage');
                const tagCloudEl = document.getElementById('tagCloud');
                const situationAlertsEl = document.getElementById('situationAlerts');
                const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
                const reportShareButton = document.getElementById('reportShareButton');
                const containerEl = document.querySelector('.container');

                // --- ë°ì´í„° ë¡œë“œ ---
                const userAge = currentUserAgeForAccessCheck; // í˜ì´ì§€ ìƒë‹¨ì—ì„œ ì´ë¯¸ ê°€ì ¸ì˜¨ ë‚˜ì´ ì‚¬ìš©
                console.log("Adult Analysis Page - User Age (confirmed for access):", userAge);

                const analysisDataString = localStorage.getItem('lozee_conversation_analysis');
                let analysisResults = null;
                // accumulatedDurationMinutesëŠ” ì´ í˜ì´ì§€ì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°

                if (!analysisDataString) {
                    console.warn("Adult Analysis Page: localStorageì— 'lozee_conversation_analysis' ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    if (containerEl) {
                        // ë¶„ì„ ë°©ë²•ë¡  ì„¹ì…˜ì„ ì œì™¸í•œ ëª¨ë“  ë¶„ì„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                        document.querySelectorAll('.section').forEach(sec => {
                            if(sec && sec.id !== 'analysisMethodologySection') sec.style.display = 'none';
                        });
                        if (!containerEl.querySelector('.no-data-message')) { // ì¤‘ë³µ ë°©ì§€
                            const noDataMsgDiv = document.createElement('div');
                            noDataMsgDiv.className = 'feedback neutral no-data-message';
                            noDataMsgDiv.style.textAlign = 'center';
                            noDataMsgDiv.style.marginTop = '20px';
                            noDataMsgDiv.innerHTML = '<h2>ì•„ì§ ë¡œì§€ì™€ ì¶©ë¶„í•œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì§€ ì•Šìœ¼ì…¨êµ°ìš”! ğŸ˜®</h2><p>ë¨¼ì € ë¡œì§€ì™€ í¸ì•ˆí•˜ê²Œ ëŒ€í™”í•˜ì‹  í›„, ëŒ€í™” ì„±ì°° ë³´ê³ ì„œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>';
                            const pageTitleH1 = containerEl.querySelector('h1');
                             if (pageTitleH1 && pageTitleH1.nextElementSibling) {
                                pageTitleH1.nextElementSibling.insertAdjacentElement('afterend', noDataMsgDiv);
                            } else if (pageTitleH1) { // ê³µìœ  ë²„íŠ¼ ì»¨í…Œì´ë„ˆê°€ ì—†ë‹¤ë©´ h1 ë‹¤ìŒì—
                                containerEl.insertBefore(noDataMsgDiv, pageTitleH1.nextSibling);
                            } else { // h1ë„ ì—†ë‹¤ë©´ ì»¨í…Œì´ë„ˆ ë§¨ ì•ì—
                                 containerEl.insertBefore(noDataMsgDiv, containerEl.firstChild);
                            }
                        }
                    }
                    return;
                }

                 try {
        const fullAnalysis = JSON.parse(analysisDataString);
        analysisResults = fullAnalysis.results; // GPT ì‘ë‹µì˜ analysis ê°ì²´ ë˜ëŠ” talk.jsì—ì„œ ì €ì¥í•œ results ê°ì²´
        accumulatedDurationMinutes = parseFloat(fullAnalysis.accumulatedDurationMinutes) || 0; // ì´ ê°’ì€ ì–¸ì–´ ì—°ë ¹ ë¶„ì„ì— ì‚¬ìš©ë¨
    } catch (e) {
        console.error("ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜:", e);
        if (containerEl) containerEl.innerHTML = '<h1>ì•—! ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš” ğŸ˜¥</h1><p style="text-align:center;">ì´ì „ ëŒ€í™”ë¡œ ëŒì•„ê°€ê±°ë‚˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
        // languageAgeSectionì´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ìˆ¨ê¸°ê±°ë‚˜, ë‹¤ë¥¸ ì„¹ì…˜ë„ ì²˜ë¦¬
        if (languageAgeSection) languageAgeSection.style.display = 'none';
        // emotionToneSection ë“± ë‹¤ë¥¸ ì„¹ì…˜ë„ ìˆ¨ê¸°ê±°ë‚˜ "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
        return;
    }

    if (!analysisResults) {
        // ... (analysisResultsê°€ nullì¼ ë•Œì˜ ì²˜ë¦¬) ...
        return;
    }

                // --- ê° ë¶„ì„ ì„¹ì…˜ ë Œë”ë§ ---
                // 1. ë¡œì§€ì™€ì˜ ëŒ€í™” ìš”ì•½
                if (conversationSummaryContentEl) {
                    if (analysisResults.conversationSummary) {
                        conversationSummaryContentEl.textContent = analysisResults.conversationSummary;
                    } else {
                        conversationSummaryContentEl.innerHTML = '<p>ëŒ€í™” ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œì§€ì™€ ë” ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”.</p>';
                    }
                }

                // 2. ê°ì • íë¦„ ì‚´í´ë³´ê¸°
                const emotionToneSection = document.getElementById('emotionToneSection');
                if (emotionToneSection) {
                    if (chartJsIsReady && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                        if(emotionChartEl) emotionChartEl.style.display = 'block';
                        if(emotionChartContainerEl && emotionChartContainerEl.querySelector('.no-chart-message')) {
                             emotionChartContainerEl.querySelector('.no-chart-message').remove();
                        }
                        renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                        if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                    } else {
                        if(emotionChartEl) emotionChartEl.style.display = 'none';
                        if(emotionChartContainerEl && !emotionChartContainerEl.querySelector('.no-chart-message')) {
                            const noDataMsg = document.createElement('p');
                            noDataMsg.textContent = chartJsIsReady ? "ëŒ€í™”ë¥¼ í†µí•´ ë‚˜íƒ€ë‚œ ê°ì •ë“¤ì„ ì´ê³³ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ˜Š" : "ì°¨íŠ¸ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ğŸ˜¥";
                            noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888'; noDataMsg.classList.add('no-chart-message');
                            emotionChartContainerEl.appendChild(noDataMsg);
                        }
                        if(empathyMessageEl) { empathyMessageEl.textContent = "ëŒ€í™”ì—ì„œ ë‚˜íƒ€ë‚œ ì£¼ëœ ê°ì •ì„ íŒŒì•…í•˜ê¸° ìœ„í•´ ë¡œì§€ì™€ ë” ê¹Šì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”."; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; }
                    }
                }

                // 3. ë‚˜ì˜ ëŒ€í™” í‚¤ì›Œë“œ
                const keywordsSection = document.getElementById('keywordsSection');
                if (keywordsSection && tagCloudEl) {
                    if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                        const weightedKeywords = analysisResults.keywords.map(kw => ({ text: kw, weight: Math.floor(5 + Math.random() * 10) }));
                        renderTagCloud('tagCloud', weightedKeywords);
                    } else {
                        tagCloudEl.innerHTML = '<p style="text-align:center; color:#888;">ëŒ€í™”ì˜ ì£¼ìš” í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¶©ë¶„í•œ ëŒ€í™”ê°€ í•„ìš”í•´ìš”.</p>';
                    }
                }

                // 4. í•¨ê»˜ ìƒê°í•´ ë³¼ ì  (ì¸ì§€ì™œê³¡)
                const situationSection = document.getElementById('situationSection');
                if (situationSection) {
                    if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                        if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions);
                        if (continueDistortionTalkBtn) {
                            continueDistortionTalkBtn.style.display = 'inline-block';
                            continueDistortionTalkBtn.onclick = () => {
                                createImprovementPlanIfNeeded(analysisResults, userAge); // userAgeëŠ” ëŒ€í™” ëŒ€ìƒì˜ ë‚˜ì´
                                // ì•½ì† ìƒì„± í›„, ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ ì¸ì§€ì™œê³¡ ê´€ë ¨ ì•½ì†ì„ ì°¾ì•„ ì´ì–´í•˜ê¸° ì •ë³´ êµ¬ì„±
                                const plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]');
                                const currentDistortions = analysisResults.cognitiveDistortions;
                                let planToContinue = null;
                                // í˜„ì¬ ë¶„ì„ëœ ì¸ì§€ì™œê³¡ ì¤‘ í•˜ë‚˜ì™€ ë§¤ì¹­ë˜ëŠ” ê°€ì¥ ìµœì‹  ì•½ì†ì„ ì°¾ìŒ
                                for (let i = plans.length - 1; i >= 0; i--) {
                                    if (plans[i].type === 'cognitive_distortion' && currentDistortions.includes(plans[i].details)) {
                                        planToContinue = plans[i];
                                        break;
                                    }
                                }

                                if (planToContinue) {
                                    const continueTopicData = {
                                        type: 'continue_improvement_plan',
                                        planType: planToContinue.type,
                                        details: planToContinue.topic || planToContinue.details,
                                        prompt: planToContinue.promptForContinuation || `"${planToContinue.details}" ìƒê° íŒ¨í„´ì— ëŒ€í•´ ë” ì´ì•¼ê¸° ë‚˜ëˆ ë³¼ê¹Œìš”?`
                                    };
                                    localStorage.setItem('lozee_talk_init_topic', JSON.stringify(continueTopicData));
                                    window.location.href = 'talk.html';
                                } else {
                                    alert("ì´ì–´ê°ˆ ì•½ì† ì •ë³´ë¥¼ ì°¾ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                                }
                            };
                        }
                    } else {
                        if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">ëŒ€í™”ì—ì„œ íŠ¹ë³„íˆ ì¹˜ìš°ì¹œ ìƒê° ìŠµê´€ì€ ë°œê²¬ë˜ì§€ ì•Šì•˜ì–´ìš”. ê· í˜• ì¡íŒ ì‹œê°ì„ ì˜ ìœ ì§€í•˜ê³  ê³„ì‹œëŠ”êµ°ìš”! ğŸ‘</p>';
                        if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                    }
                }

                // ê³µìœ  ë²„íŠ¼ ë¡œì§
                if(reportShareButton) {
                    reportShareButton.onclick = () => {
                        const reportOwnerName = localStorage.getItem('lozee_username') || 'user'; // UID ëŒ€ì‹  ì´ë¦„ ì‚¬ìš©
                        const reportId = reportOwnerName + "_" + new Date().getTime();
                        const shareableLink = `${window.location.origin}${window.location.pathname}?report_id=${reportId}`;
                        // ì‹¤ì œ ë³´ê³ ì„œ ì €ì¥ ë¡œì§ì€ Firebase Functions ë“±ì„ í†µí•´ êµ¬í˜„ í•„ìš”

                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(shareableLink)
                                .then(() => {
                                    alert('ì„±ì°° ë³´ê³ ì„œ ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n' + shareableLink + '\n(ì‹¤ì œ ê³µìœ ë¥¼ ìœ„í•´ì„œëŠ” ë³´ê³ ì„œ ì €ì¥ ê¸°ëŠ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.)');
                                })
                                .catch(err => {
                                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                                    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n' + shareableLink);
                                });
                        } else {
                            prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ê³µìœ í•˜ì„¸ìš” (ì‹¤ì œ ê³µìœ  ê¸°ëŠ¥ì€ ì¶”ê°€ êµ¬í˜„ í•„ìš”):', shareableLink);
                        }
                    };
                }
                 // ë¶„ì„ ê²°ê³¼ ë¡œë“œ í›„, "ë¡œì§€ì™€ì˜ ì•½ì†" ìƒì„± (ì¸ì§€ì™œê³¡ë§Œ)
                if (analysisResults) {
                     createImprovementPlanIfNeeded(analysisResults, userAge); // userAge ì „ë‹¬
                }
            }); // DOMContentLoaded ë

            // --- ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ë“¤ ---
            // (renderTagCloud, alertCognitiveDistortions, renderEmotionChart, displayEmpathyMessageëŠ” ì´ì „ ë‹µë³€ì˜ ì™„ì„±ëœ ì½”ë“œ ì‚¬ìš©)
            function renderTagCloud(elementId, tags) { /* ... ì´ì „ ë‹µë³€ì˜ í•¨ìˆ˜ ë‚´ìš© ... */ }
            function alertCognitiveDistortions(elementId, distortions) { /* ... ì´ì „ ë‹µë³€ì˜ í•¨ìˆ˜ ë‚´ìš© ... */ }
            function renderEmotionChart(canvasId, emotionData) { /* ... ì´ì „ ë‹µë³€ì˜ í•¨ìˆ˜ ë‚´ìš© ... */ }
            function displayEmpathyMessage(emotionData) { /* ... ì´ì „ ë‹µë³€ì˜ í•¨ìˆ˜ ë‚´ìš© ... */ }

            // "ë¡œì§€ì™€ì˜ ì•½ì†" ìƒì„± í•¨ìˆ˜ (ì„±ì¸ìš© - ì¸ì§€ì™œê³¡ë§Œ ì²˜ë¦¬)
            function createImprovementPlanIfNeeded(analysisResults, userAge) { // userAgeëŠ” ì—¬ê¸°ì„œ ì§ì ‘ ì‚¬ìš© ì•ˆí•¨ (ì–¸ì–´ ì—°ë ¹ì€ ì´ í˜ì´ì§€ì—ì„œ ì œì™¸)
                let plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]' );
                const currentJournalId = localStorage.getItem('lozee_selected_journal_id') || `session_${new Date().getTime()}`; // ì‹¤ì œ ì €ë„ ID ë˜ëŠ” ì„¸ì…˜ ì‹ë³„ì ì‚¬ìš©

                // 1. ì¸ì§€ì™œê³¡ ê´€ë ¨ ì•½ì† ìƒì„±
                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    analysisResults.cognitiveDistortions.forEach(distortion => {
                        // ì•½ì† IDë¥¼ ì¢€ ë” ê³ ìœ í•˜ê²Œ (ì €ë„ ID + ì¸ì§€ì™œê³¡ íƒ€ì… + ë‚´ìš© ì¼ë¶€)
                        const planId = `cog_${currentJournalId}_${distortion.replace(/\s+/g, '_').substring(0,20)}`;
                        const existingPlan = plans.find(p => p.id === planId);
                        if (!existingPlan) {
                            plans.push({
                                id: planId, // ê° ì•½ì†ì— ê³ ìœ  ID ë¶€ì—¬
                                type: 'cognitive_distortion',
                                title: `ìƒê° ìŠµê´€ ëŒì•„ë³´ê¸°: "${distortion}"`, // ì•½ì† ëª©ë¡ì— í‘œì‹œë  ì œëª©
                                details: distortion, // ì–´ë–¤ ì¸ì§€ì™œê³¡ì¸ì§€
                                topic: analysisResults.summaryTitle || "ìµœê·¼ ëŒ€í™” ì£¼ì œ", // ê´€ë ¨ ëŒ€í™” ì£¼ì œ
                                promptForContinuation: `ì´ì „ì— "${analysisResults.summaryTitle || 'ì´ ëŒ€í™”'}"ì—ì„œ ë‚˜íƒ€ë‚¬ë˜ "${distortion}" ìƒê° íŒ¨í„´ì— ëŒ€í•´ ë” ê¹Šì´ ì´ì•¼ê¸° ë‚˜ëˆ ë³¼ê¹Œìš”? ì–´ë–¤ ìƒí™©ì—ì„œ ê·¸ëŸ° ìƒê°ì´ ë“¤ì—ˆëŠ”ì§€, ê·¸ë¡œ ì¸í•´ ì–´ë–¤ ê°ì •ì„ ëŠë¼ì…¨ëŠ”ì§€ í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”.`
                            });
                        }
                    });
                }

                // ì¤‘ë³µ ì œê±° (ê°™ì€ IDì˜ ì•½ì†ì´ ì—¬ëŸ¬ ë²ˆ ì¶”ê°€ë˜ëŠ” ê²ƒ ë°©ì§€)
                const uniquePlans = plans.filter((plan, index, self) =>
                    index === self.findIndex((p) => (p.id === plan.id))
                );

                if (uniquePlans.length > 0) {
                    localStorage.setItem('lozee_improvement_plans', JSON.stringify(uniquePlans));
                    console.log("Adult Analysis Page: ê°œì„  ê³„íš ì €ì¥ë¨:", uniquePlans);
                } else {
                     console.log("Adult Analysis Page: ìƒì„±í•  ìƒˆë¡œìš´ ê°œì„  ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            }

        } // í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í™•ì¸ else ë¸”ë¡ì˜ ë‹«ëŠ” ë¶€ë¶„
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>