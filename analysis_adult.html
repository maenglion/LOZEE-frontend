<div class="container">
        <h1>나의 대화 성찰 보고서 🧐</h1>
        <div class="share-button-container">
            <button id="reportShareButton">보고서 공유하기 🔗</button>
        </div>

        <div class="section" id="conversationSummarySection">
            <h2>📝 로지와의 대화 요약</h2>
            <p class="assistant-analysis-notice">LOZEE AI 요약</p>
            <p class="module-explanation">
                로지와의 최근 대화 내용을 한눈에 볼 수 있도록 요약했어요. 어떤 이야기를 나누었는지 다시 한번 살펴보세요.
            </p>
            <div id="conversationSummaryContent">
                <p>요약 내용을 불러오는 중입니다...</p>
            </div>
        </div>

        <div class="section" id="emotionToneSection">
            <h2>🌊 감정 흐름 살펴보기</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                대화 중 나타난 감정의 분포를 통해 자신의 주된 감정 경향을 파악해볼 수 있어요. 어떤 감정들이 주로 나타났는지 확인해보세요.
            </p>
            <div id="emotionChartContainer"> <canvas id="emotionChart"></canvas>
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p>
        </div>

        <div class="section" id="keywordsSection">
            <h2>🔑 나의 대화 키워드</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
             <p class="module-explanation">
                대화에서 자주 사용하거나 중요하게 다뤄진 핵심 단어들이에요. 이 키워드들을 통해 대화의 주요 맥락을 파악할 수 있습니다.
            </p>
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>💡 함께 생각해 볼 점</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                대화 내용을 바탕으로 로지가 함께 더 깊이 탐색해보고 싶은 생각이나 관점을 발견했어요. 아래 내용을 참고하여 자신에 대한 이해를 넓혀보세요. 때로는 익숙한 생각의 틀에서 벗어나 새로운 관점을 발견하는 것이 성장의 기회가 될 수 있습니다.
            </p>
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">이 주제로 로지와 더 이야기하기 🤔</button>
        </div>

        <div class="section" id="analysisMethodologySection">
             <h2>LOZEE의 분석 방법론</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <ul class="methodology-list">
                <li><strong>Russell의 감정 원형 모형</strong>: Valence(쾌-불쾌)와 Arousal(각성-이완) 축을 기반으로 감정의 위치를 다차원적으로 분석합니다.</li>
                <li><strong>Plutchik의 감정 바퀴</strong>: 8가지 기본 감정과 그 강도 및 유사성을 바탕으로 복합적인 감정 상태를 이해합니다.</li>
                <li><strong>Lexicon 기반 감성 분석</strong>: 한국어 감성 사전(예: KOSAC)을 활용하여 텍스트의 긍정, 부정, 중립 극성을 판단합니다.</li>
                <li><strong>딥러닝 분류 모델 (BERT/KoBERT)</strong>: 최신 자연어 처리 모델을 사용하여 문맥을 고려한 고정밀 감정 극성 및 세부 감정(예: 기쁨, 슬픔, 분노 등)을 분류합니다.</li>
                <li><strong>인지왜곡 이론 (Beck의 CBT)</strong>: 인지행동치료 이론에 기반하여 대화에서 나타날 수 있는 대표적인 인지왜곡 패턴(예: 흑백논리, 과잉일반화 등)을 감지합니다.</li>
                <li><strong>대화 주제 구조화</strong>: LOZEE AI의 자체 상담 토픽 데이터를 활용하여 대화의 흐름과 주요 주제를 체계적으로 파악하고 관련 피드백을 제공합니다.</li>
            </ul>
        </div>

        <p class="footer-assistant-notice">본 분석은 로지 AI가 마음을 담아 준비했어요. 개인적인 성찰을 위한 참고 자료로 활용해주세요.</p>
    </div>

    <script type="module">
        // --- 페이지 접근 권한 확인 (15세 이상) ---
        const ADULT_ANALYSIS_MIN_AGE = 15;
        const currentUserAgeForAccessCheck = parseInt(localStorage.getItem('lozee_userage'), 10);

        if (isNaN(currentUserAgeForAccessCheck) || currentUserAgeForAccessCheck < ADULT_ANALYSIS_MIN_AGE) {
            console.warn(`Adult Analysis Page: 접근 제한. 사용자 나이(${currentUserAgeForAccessCheck})가 ${ADULT_ANALYSIS_MIN_AGE}세 미만입니다. analysis.html로 리디렉션합니다.`);
            window.location.replace('analysis.html'); // 15세 미만은 일반 analysis.html로
        } else {
            // 15세 이상 사용자만 아래의 나머지 코드를 실행합니다.
            console.log("Adult Analysis Page: 접근 허용. 사용자 나이:", currentUserAgeForAccessCheck);

            let chartLibraryInitialized = false; // ⭐ initializeChartJsGlobal 함수 내에서만 사용되도록 위치 변경 (또는 전역 유지)

            function initializeChartJsGlobal() { // ⭐ 중복 선언 제거, 이 함수만 남김
                try {
                    if (typeof Chart !== 'undefined' && Chart) {
                        Chart.defaults.color = '#333';
                        Chart.defaults.borderColor = '#e0e0e0';
                        Chart.defaults.font.family = "'KoPub World Dotum', sans-serif";
                        Chart.defaults.font.size = 12;
                        console.log("Adult Analysis Page: Chart.js(UMD) 라이브러리가 인식되고 기본값이 설정되었습니다.");
                        chartLibraryInitialized = true; // ⭐ let 선언 제거, 할당만
                        return true;
                    } else {
                        console.error("Adult Analysis Page: Chart.js(UMD) 라이브러리를 찾을 수 없습니다.");
                        const emotionChartContainer = document.getElementById('emotionChartContainer');
                        if (emotionChartContainer) {
                            emotionChartContainer.innerHTML = '<p style="text-align:center; color:red; padding:20px;">차트 기능에 문제가 있어요. 😭<br>페이지를 새로고침 해보세요.</p>';
                        }
                        return false;
                    }
                } catch (error) {
                    console.error("Adult Analysis Page: Chart.js(UMD) 초기화 중 오류!", error);
                    return false;
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                console.log("Adult Analysis Page: DOMContentLoaded 이벤트 시작");
                const chartJsIsReady = initializeChartJsGlobal();

                // --- DOM 요소 가져오기 ---
                const conversationSummaryContentEl = document.getElementById('conversationSummaryContent');
                const emotionChartEl = document.getElementById('emotionChart');
                const emotionChartContainerEl = document.getElementById('emotionChartContainer');
                const empathyMessageEl = document.getElementById('empathyMessage');
                const tagCloudEl = document.getElementById('tagCloud');
                const situationAlertsEl = document.getElementById('situationAlerts');
                const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
                const reportShareButton = document.getElementById('reportShareButton');
                const containerEl = document.querySelector('.container');

                // --- 데이터 로드 ---
                const userAge = currentUserAgeForAccessCheck; // 페이지 상단에서 이미 가져온 나이 사용
                console.log("Adult Analysis Page - User Age (confirmed for access):", userAge);

                const analysisDataString = localStorage.getItem('lozee_conversation_analysis');
                let analysisResults = null;
                // accumulatedDurationMinutes는 이 페이지에서 직접 사용하지 않으므로 제거

                if (!analysisDataString) {
                    console.warn("Adult Analysis Page: localStorage에 'lozee_conversation_analysis' 데이터가 없습니다.");
                    if (containerEl) {
                        // 분석 방법론 섹션을 제외한 모든 분석 섹션 숨기기
                        document.querySelectorAll('.section').forEach(sec => {
                            if(sec && sec.id !== 'analysisMethodologySection') sec.style.display = 'none';
                        });
                        if (!containerEl.querySelector('.no-data-message')) { // 중복 방지
                            const noDataMsgDiv = document.createElement('div');
                            noDataMsgDiv.className = 'feedback neutral no-data-message';
                            noDataMsgDiv.style.textAlign = 'center';
                            noDataMsgDiv.style.marginTop = '20px';
                            noDataMsgDiv.innerHTML = '<h2>아직 로지와 충분한 대화를 나누지 않으셨군요! 😮</h2><p>먼저 로지와 편안하게 대화하신 후, 대화 성찰 보고서를 확인해보세요.</p>';
                            const pageTitleH1 = containerEl.querySelector('h1');
                             if (pageTitleH1 && pageTitleH1.nextElementSibling) {
                                pageTitleH1.nextElementSibling.insertAdjacentElement('afterend', noDataMsgDiv);
                            } else if (pageTitleH1) { // 공유 버튼 컨테이너가 없다면 h1 다음에
                                containerEl.insertBefore(noDataMsgDiv, pageTitleH1.nextSibling);
                            } else { // h1도 없다면 컨테이너 맨 앞에
                                 containerEl.insertBefore(noDataMsgDiv, containerEl.firstChild);
                            }
                        }
                    }
                    return;
                }

                 try {
        const fullAnalysis = JSON.parse(analysisDataString);
        analysisResults = fullAnalysis.results; // GPT 응답의 analysis 객체 또는 talk.js에서 저장한 results 객체
        accumulatedDurationMinutes = parseFloat(fullAnalysis.accumulatedDurationMinutes) || 0; // 이 값은 언어 연령 분석에 사용됨
    } catch (e) {
        console.error("저장된 분석 결과 파싱 오류:", e);
        if (containerEl) containerEl.innerHTML = '<h1>앗! 분석 결과를 불러오는 데 문제가 생겼어요 😥</h1><p style="text-align:center;">이전 대화로 돌아가거나, 잠시 후 다시 시도해주세요.</p>';
        // languageAgeSection이 있다면 여기서 숨기거나, 다른 섹션도 처리
        if (languageAgeSection) languageAgeSection.style.display = 'none';
        // emotionToneSection 등 다른 섹션도 숨기거나 "데이터 없음" 메시지 표시
        return;
    }

    if (!analysisResults) {
        // ... (analysisResults가 null일 때의 처리) ...
        return;
    }

                // --- 각 분석 섹션 렌더링 ---
                // 1. 로지와의 대화 요약
                if (conversationSummaryContentEl) {
                    if (analysisResults.conversationSummary) {
                        conversationSummaryContentEl.textContent = analysisResults.conversationSummary;
                    } else {
                        conversationSummaryContentEl.innerHTML = '<p>대화 요약 정보가 없습니다. 로지와 더 많은 이야기를 나눠보세요.</p>';
                    }
                }

                // 2. 감정 흐름 살펴보기
                const emotionToneSection = document.getElementById('emotionToneSection');
                if (emotionToneSection) {
                    if (chartJsIsReady && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                        if(emotionChartEl) emotionChartEl.style.display = 'block';
                        if(emotionChartContainerEl && emotionChartContainerEl.querySelector('.no-chart-message')) {
                             emotionChartContainerEl.querySelector('.no-chart-message').remove();
                        }
                        renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                        if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                    } else {
                        if(emotionChartEl) emotionChartEl.style.display = 'none';
                        if(emotionChartContainerEl && !emotionChartContainerEl.querySelector('.no-chart-message')) {
                            const noDataMsg = document.createElement('p');
                            noDataMsg.textContent = chartJsIsReady ? "대화를 통해 나타난 감정들을 이곳에서 확인하실 수 있습니다. 😊" : "차트 기능을 불러오지 못했어요. 😥";
                            noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888'; noDataMsg.classList.add('no-chart-message');
                            emotionChartContainerEl.appendChild(noDataMsg);
                        }
                        if(empathyMessageEl) { empathyMessageEl.textContent = "대화에서 나타난 주된 감정을 파악하기 위해 로지와 더 깊은 이야기를 나눠보세요."; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; }
                    }
                }

                // 3. 나의 대화 키워드
                const keywordsSection = document.getElementById('keywordsSection');
                if (keywordsSection && tagCloudEl) {
                    if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                        const weightedKeywords = analysisResults.keywords.map(kw => ({ text: kw, weight: Math.floor(5 + Math.random() * 10) }));
                        renderTagCloud('tagCloud', weightedKeywords);
                    } else {
                        tagCloudEl.innerHTML = '<p style="text-align:center; color:#888;">대화의 주요 키워드를 추출하고 있습니다. 충분한 대화가 필요해요.</p>';
                    }
                }

                // 4. 함께 생각해 볼 점 (인지왜곡)
                const situationSection = document.getElementById('situationSection');
                if (situationSection) {
                    if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                        if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions);
                        if (continueDistortionTalkBtn) {
                            continueDistortionTalkBtn.style.display = 'inline-block';
                            continueDistortionTalkBtn.onclick = () => {
                                createImprovementPlanIfNeeded(analysisResults, userAge); // userAge는 대화 대상의 나이
                                // 약속 생성 후, 가장 최근에 생성된 인지왜곡 관련 약속을 찾아 이어하기 정보 구성
                                const plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]');
                                const currentDistortions = analysisResults.cognitiveDistortions;
                                let planToContinue = null;
                                // 현재 분석된 인지왜곡 중 하나와 매칭되는 가장 최신 약속을 찾음
                                for (let i = plans.length - 1; i >= 0; i--) {
                                    if (plans[i].type === 'cognitive_distortion' && currentDistortions.includes(plans[i].details)) {
                                        planToContinue = plans[i];
                                        break;
                                    }
                                }

                                if (planToContinue) {
                                    const continueTopicData = {
                                        type: 'continue_improvement_plan',
                                        planType: planToContinue.type,
                                        details: planToContinue.topic || planToContinue.details,
                                        prompt: planToContinue.promptForContinuation || `"${planToContinue.details}" 생각 패턴에 대해 더 이야기 나눠볼까요?`
                                    };
                                    localStorage.setItem('lozee_talk_init_topic', JSON.stringify(continueTopicData));
                                    window.location.href = 'talk.html';
                                } else {
                                    alert("이어갈 약속 정보를 찾는 데 실패했습니다. 다시 시도해주세요.");
                                }
                            };
                        }
                    } else {
                        if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">대화에서 특별히 치우친 생각 습관은 발견되지 않았어요. 균형 잡힌 시각을 잘 유지하고 계시는군요! 👍</p>';
                        if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                    }
                }

                // 공유 버튼 로직
                if(reportShareButton) {
                    reportShareButton.onclick = () => {
                        const reportOwnerName = localStorage.getItem('lozee_username') || 'user'; // UID 대신 이름 사용
                        const reportId = reportOwnerName + "_" + new Date().getTime();
                        const shareableLink = `${window.location.origin}${window.location.pathname}?report_id=${reportId}`;
                        // 실제 보고서 저장 로직은 Firebase Functions 등을 통해 구현 필요

                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(shareableLink)
                                .then(() => {
                                    alert('성찰 보고서 공유 링크가 복사되었습니다!\n' + shareableLink + '\n(실제 공유를 위해서는 보고서 저장 기능이 필요합니다.)');
                                })
                                .catch(err => {
                                    console.error('클립보드 복사 실패:', err);
                                    alert('링크 복사에 실패했어요. 수동으로 복사해주세요:\n' + shareableLink);
                                });
                        } else {
                            prompt('아래 링크를 복사하여 공유하세요 (실제 공유 기능은 추가 구현 필요):', shareableLink);
                        }
                    };
                }
                 // 분석 결과 로드 후, "로지와의 약속" 생성 (인지왜곡만)
                if (analysisResults) {
                     createImprovementPlanIfNeeded(analysisResults, userAge); // userAge 전달
                }
            }); // DOMContentLoaded 끝

            // --- 데이터 렌더링 함수들 ---
            // (renderTagCloud, alertCognitiveDistortions, renderEmotionChart, displayEmpathyMessage는 이전 답변의 완성된 코드 사용)
            function renderTagCloud(elementId, tags) { /* ... 이전 답변의 함수 내용 ... */ }
            function alertCognitiveDistortions(elementId, distortions) { /* ... 이전 답변의 함수 내용 ... */ }
            function renderEmotionChart(canvasId, emotionData) { /* ... 이전 답변의 함수 내용 ... */ }
            function displayEmpathyMessage(emotionData) { /* ... 이전 답변의 함수 내용 ... */ }

            // "로지와의 약속" 생성 함수 (성인용 - 인지왜곡만 처리)
            function createImprovementPlanIfNeeded(analysisResults, userAge) { // userAge는 여기서 직접 사용 안함 (언어 연령은 이 페이지에서 제외)
                let plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]' );
                const currentJournalId = localStorage.getItem('lozee_selected_journal_id') || `session_${new Date().getTime()}`; // 실제 저널 ID 또는 세션 식별자 사용

                // 1. 인지왜곡 관련 약속 생성
                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    analysisResults.cognitiveDistortions.forEach(distortion => {
                        // 약속 ID를 좀 더 고유하게 (저널 ID + 인지왜곡 타입 + 내용 일부)
                        const planId = `cog_${currentJournalId}_${distortion.replace(/\s+/g, '_').substring(0,20)}`;
                        const existingPlan = plans.find(p => p.id === planId);
                        if (!existingPlan) {
                            plans.push({
                                id: planId, // 각 약속에 고유 ID 부여
                                type: 'cognitive_distortion',
                                title: `생각 습관 돌아보기: "${distortion}"`, // 약속 목록에 표시될 제목
                                details: distortion, // 어떤 인지왜곡인지
                                topic: analysisResults.summaryTitle || "최근 대화 주제", // 관련 대화 주제
                                promptForContinuation: `이전에 "${analysisResults.summaryTitle || '이 대화'}"에서 나타났던 "${distortion}" 생각 패턴에 대해 더 깊이 이야기 나눠볼까요? 어떤 상황에서 그런 생각이 들었는지, 그로 인해 어떤 감정을 느끼셨는지 편하게 말씀해주세요.`
                            });
                        }
                    });
                }

                // 중복 제거 (같은 ID의 약속이 여러 번 추가되는 것 방지)
                const uniquePlans = plans.filter((plan, index, self) =>
                    index === self.findIndex((p) => (p.id === plan.id))
                );

                if (uniquePlans.length > 0) {
                    localStorage.setItem('lozee_improvement_plans', JSON.stringify(uniquePlans));
                    console.log("Adult Analysis Page: 개선 계획 저장됨:", uniquePlans);
                } else {
                     console.log("Adult Analysis Page: 생성할 새로운 개선 계획이 없습니다.");
                }
            }

        } // 페이지 접근 권한 확인 else 블록의 닫는 부분
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>