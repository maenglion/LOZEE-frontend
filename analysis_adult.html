<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>나의 대화 성찰 보고서 - LOZEE</title>
    <link
        href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" href="gnb.css">
    <link rel="stylesheet" href="css/common.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* analysis.html 페이지 스타일과 거의 동일하게 사용, 일부 조정 가능 */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8; /* 페이지 배경 통일 */
            --text-color: #333333;
            --card-bg-analysis: #ffffff; /* 카드 배경 통일 */
            --explanation-bg-analysis: #eef2f7; /* 설명 영역 배경 */
            --primary-color-analysis: var(--primary-color); /* h1 제목 색상 */
            --gnb-height: 56px;
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width:900px;
            margin:25px auto;
            padding:0 25px;
            box-sizing: border-box;
        }
        h1 { /* 페이지 메인 타이틀 */
            color: var(--primary-color-analysis);
            text-align: center;
            font-size: 2em;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .share-button-container {
            text-align: center;
            margin-bottom: 30px;
        }
        #reportShareButton {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #reportShareButton:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .assistant-analysis-notice {
            font-size: 0.75em;
            color: #78909c;
            margin-top: -12px;
            margin-bottom: 15px;
            text-align: right;
        }
        .module-explanation {
            font-size:0.9em;
            color:#555;
            margin-bottom:15px;
            padding: 10px;
            background-color: var(--explanation-bg-analysis);
            border-radius: 6px;
            line-height: 1.6;
        }

        h2 { /* 각 섹션 제목 */
            margin-top:0;
            margin-bottom: 8px;
            font-size:1.5em;
            color:#34495e; /* 남색 계열 */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
        }
        .section {
            background:var(--card-bg-analysis);
            padding:25px;
            margin-top:25px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.08);
        }
        .section p {
            color: #555555;
            line-height: 1.7;
            font-size: 1em;
        }
         .section p strong { /* 강조 텍스트 */
            color: var(--secondary-color);
            font-weight: bold;
        }
        .feedback {
            margin-top:15px;
            padding:12px 18px;
            border-left-width:5px;
            border-left-style:solid;
            border-radius:8px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .feedback.negative { background:#ffebee; border-left-color: #c62828; color:#c62828; }
        .feedback.positive { background:#e8f5e9; border-left-color: #2e7d32; color:#2e7d32; }
        .feedback.neutral { background:#eceff1; border-left-color: #546e7a; color:#37474f; }

        #emotionChartContainer {
            position: relative;
            max-width: 450px;
            min-height: 100px;
            height: auto;
            margin: 20px auto 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #emotionChart {
            width:100% !important;
            height:auto !important;
            aspect-ratio: 1 / 1;
            background-color: #fdfdfd;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            box-sizing: border-box;
            display: none; /* JS로 표시 */
        }
        #tagCloud {
            min-height:100px;
            border:1px dashed #cccccc;
            padding:15px;
            margin-top: 20px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        .badge { display:inline-block; margin:4px; padding:8px 12px; background:#e8eaf6; color: #3f51b5; border-radius:16px; font-size:0.9em; transition: background-color 0.2s, color 0.2s; font-weight: 500; }
        .badge:hover { background-color: #c5cae9; color: #303f9f; }

        #conversationSummaryContent { /* 대화 요약 표시 영역 */
            white-space: pre-wrap; /* 줄바꿈 및 공백 유지 */
            line-height: 1.7;
            font-size: 1em;
            color: #444;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        #situationAlerts { margin-top: 15px; min-height: 50px; }
        #situationAlerts .cognitive-distortion-item { background:#fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9em; }
        .footer-assistant-notice { text-align: center; margin-top: 40px; margin-bottom: 20px; font-size: 0.8em; color: #78909c; }
        .methodology-list { list-style-type: none; padding-left: 0; font-size: 0.9em; color: #555; }
        .methodology-list li { margin-bottom: 12px; padding-left: 25px; position: relative; }
        .methodology-list li::before { content: "💡"; color: var(--primary-color); position: absolute; left: 0; font-size: 1.1em; }
        .methodology-list li strong { color: #34495e; }
        .action-button { display: inline-block; margin-top: 15px; background-color: var(--primary-color); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .action-button:hover { background-color: var(--secondary-color); }

        @media (max-width: 768px) { h1 { font-size: 1.7em; } h2 { font-size: 1.3em; } .section { padding: 20px; } #emotionChartContainer { max-width: 100%; } #emotionChart { aspect-ratio: 4 / 3; } .methodology-list { font-size: 0.85em; } }
        @media (max-width: 480px) { .container { margin: 15px auto; padding: 0 15px; } h1 { font-size: 1.5em; margin-bottom: 25px; } h2 { font-size: 1.2em; } .section { padding: 15px; margin-top: 20px;} .section p { font-size: 0.95em; } .feedback { padding: 10px 15px; font-size: 0.9em;} #emotionChartContainer { max-width: 100%; } #emotionChart { aspect-ratio: 1 / 1; } .badge { font-size: 0.85em; padding: 6px 10px;} .assistant-analysis-notice { font-size: 0.7em; } .methodology-list { font-size: 0.8em; } }
    </style>
</head>
<body>
    <div class="app-container"> </div>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a>
          <a href="index.html">✨ 새로운 이야기 시작!</a>
          <a href="analysis_adult.html">📊 나의 대화 성찰</a> <a href="journal-list.html">📖 이야기 모음집</a>
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a>
        </div>
    </nav>

    <div class="container">
        <h1>나의 대화 성찰 보고서 🧐</h1>
        <div class="share-button-container">
            <button id="reportShareButton">보고서 공유하기 🔗</button>
        </div>

        <div class="section" id="conversationSummarySection">
            <h2>📝 로지와의 대화 요약</h2>
            <p class="assistant-analysis-notice">LOZEE AI 요약</p>
            <p class="module-explanation">
                로지와의 최근 대화 내용을 한눈에 볼 수 있도록 요약했어요. 어떤 이야기를 나누었는지 다시 한번 살펴보세요.
            </p>
            <div id="conversationSummaryContent">
                <p>요약 내용을 불러오는 중입니다...</p>
            </div>
        </div>

        <div class="section" id="emotionToneSection">
            <h2>🌊 감정 흐름 살펴보기</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                대화 중 나타난 감정의 분포를 통해 자신의 주된 감정 경향을 파악해볼 수 있어요. 어떤 감정들이 주로 나타났는지 확인해보세요.
            </p>
            <div id="emotionChartContainer"> <canvas id="emotionChart"></canvas>
            </div>
            <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p>
        </div>

        <div class="section" id="keywordsSection">
            <h2>🔑 나의 대화 키워드</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
             <p class="module-explanation">
                대화에서 자주 사용하거나 중요하게 다뤄진 핵심 단어들이에요. 이 키워드들을 통해 대화의 주요 맥락을 파악할 수 있습니다.
            </p>
            <div id="tagCloud"></div>
        </div>

        <div class="section" id="situationSection">
            <h2>💡 함께 생각해 볼 점</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <p class="module-explanation">
                대화 내용을 바탕으로 로지가 함께 더 깊이 탐색해보고 싶은 생각이나 관점을 발견했어요. 아래 내용을 참고하여 자신에 대한 이해를 넓혀보세요. 때로는 익숙한 생각의 틀에서 벗어나 새로운 관점을 발견하는 것이 성장의 기회가 될 수 있습니다.
            </p>
            <div id="situationAlerts" style="margin-top:15px;"></div>
            <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">이 주제로 로지와 더 이야기하기 🤔</button>
        </div>

        <div class="section" id="analysisMethodologySection">
             <h2>LOZEE의 분석 방법론</h2>
            <p class="assistant-analysis-notice">LOZEE AI 분석</p>
            <ul class="methodology-list">
                <li><strong>Russell의 감정 원형 모형</strong>: Valence(쾌-불쾌)와 Arousal(각성-이완) 축을 기반으로 감정의 위치를 다차원적으로 분석합니다.</li>
                <li><strong>Plutchik의 감정 바퀴</strong>: 8가지 기본 감정과 그 강도 및 유사성을 바탕으로 복합적인 감정 상태를 이해합니다.</li>
                <li><strong>Lexicon 기반 감성 분석</strong>: 한국어 감성 사전(예: KOSAC)을 활용하여 텍스트의 긍정, 부정, 중립 극성을 판단합니다.</li>
                <li><strong>딥러닝 분류 모델 (BERT/KoBERT)</strong>: 최신 자연어 처리 모델을 사용하여 문맥을 고려한 고정밀 감정 극성 및 세부 감정(예: 기쁨, 슬픔, 분노 등)을 분류합니다.</li>
                <li><strong>인지왜곡 이론 (Beck의 CBT)</strong>: 인지행동치료 이론에 기반하여 대화에서 나타날 수 있는 대표적인 인지왜곡 패턴(예: 흑백논리, 과잉일반화 등)을 감지합니다.</li>
                <li><strong>대화 주제 구조화</strong>: LOZEE AI의 자체 상담 토픽 데이터를 활용하여 대화의 흐름과 주요 주제를 체계적으로 파악하고 관련 피드백을 제공합니다.</li>
            </ul>
        </div>

        <p class="footer-assistant-notice">본 분석은 로지 AI가 마음을 담아 준비했어요. 개인적인 성찰을 위한 참고 자료로 활용해주세요.</p>
    </div>

    <script type="module">
        let chartLibraryInitialized = false;

        function initializeChartJsGlobal() {
            // ... (기존 analysis.html의 initializeChartJsGlobal 함수와 동일하게 사용) ...
            try {
                if (typeof Chart !== 'undefined' && Chart) {
                    Chart.defaults.color = '#333';
                    Chart.defaults.borderColor = '#e0e0e0';
                    Chart.defaults.font.family = "'KoPub World Dotum', sans-serif";
                    Chart.defaults.font.size = 12;
                    console.log("Adult Analysis Page: Chart.js(UMD) 라이브러리가 인식되고 기본값이 설정되었습니다.");
                    chartLibraryInitialized = true;
                    return true;
                } else {
                    console.error("Adult Analysis Page: Chart.js(UMD) 라이브러리를 찾을 수 없습니다.");
                    const emotionChartContainer = document.getElementById('emotionChartContainer');
                    if (emotionChartContainer) {
                        emotionChartContainer.innerHTML = '<p style="text-align:center; color:red; padding:20px;">차트 기능에 문제가 있어요. 😭<br>페이지를 새로고침 해보세요.</p>';
                    }
                    return false;
                }
            } catch (error) {
                console.error("Adult Analysis Page: Chart.js(UMD) 초기화 중 오류!", error);
                return false;
            }
        }

        // --- 페이지 접근 권한 확인 (15세 이상) ---
        const ADULT_ANALYSIS_MIN_AGE = 15;
        const currentUserAgeForAccessCheck = parseInt(localStorage.getItem('lozee_userage'), 10);

        if (isNaN(currentUserAgeForAccessCheck) || currentUserAgeForAccessCheck < ADULT_ANALYSIS_MIN_AGE) {
            console.warn(`Adult Analysis Page: 접근 제한. 사용자 나이(${currentUserAgeForAccessCheck})가 ${ADULT_ANALYSIS_MIN_AGE}세 미만입니다. analysis.html로 리디렉션합니다.`);
            // 15세 미만 사용자는 기존 analysis.html로 보냅니다.
            // 또는 "이용할 수 없는 페이지입니다"라는 메시지를 보여줄 수도 있습니다.
            window.location.replace('analysis.html'); 
            // window.location.replace를 사용하여 뒤로 가기로 이 페이지에 다시 접근하는 것을 방지합니다.
            // 만약 analysis.html이 없다면, index.html이나 다른 적절한 페이지로 보냅니다.
        } else {
            // 15세 이상 사용자만 아래의 나머지 코드를 실행합니다.
            console.log("Adult Analysis Page: 접근 허용. 사용자 나이:", currentUserAgeForAccessCheck);

            let chartLibraryInitialized = false;

            function initializeChartJsGlobal() {
                // ... (기존 initializeChartJsGlobal 함수 내용) ...
                try {
                    if (typeof Chart !== 'undefined' && Chart) {
                        Chart.defaults.color = '#333';
                        Chart.defaults.borderColor = '#e0e0e0';
                        Chart.defaults.font.family = "'KoPub World Dotum', sans-serif";
                        Chart.defaults.font.size = 12;
                        console.log("Adult Analysis Page: Chart.js(UMD) 라이브러리가 인식되고 기본값이 설정되었습니다.");
                        chartLibraryInitialized = true;
                        return true;
                    } else {
                        console.error("Adult Analysis Page: Chart.js(UMD) 라이브러리를 찾을 수 없습니다.");
                        const emotionChartContainer = document.getElementById('emotionChartContainer');
                        if (emotionChartContainer) {
                            emotionChartContainer.innerHTML = '<p style="text-align:center; color:red; padding:20px;">차트 기능에 문제가 있어요. 😭<br>페이지를 새로고침 해보세요.</p>';
                        }
                        return false;
                    }
                } catch (error) {
                    console.error("Adult Analysis Page: Chart.js(UMD) 초기화 중 오류!", error);
                    return false;
                }
            }
        

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Adult Analysis Page: DOMContentLoaded 이벤트 시작");
            const chartJsIsReady = initializeChartJsGlobal();


            // --- DOM 요소 가져오기 ---
            const conversationSummaryContentEl = document.getElementById('conversationSummaryContent');
            const emotionChartEl = document.getElementById('emotionChart');
            const emotionChartContainerEl = document.getElementById('emotionChartContainer');
            const empathyMessageEl = document.getElementById('empathyMessage');
            const tagCloudEl = document.getElementById('tagCloud'); // 키워드 섹션용

            
            // const patternDashboardEl = document.getElementById('patternDashboard'); // 패턴 섹션이 별도로 없으므로 주석 처리 또는 활용 방안 재고
            const situationAlertsEl = document.getElementById('situationAlerts');
            const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
            const reportShareButton = document.getElementById('reportShareButton');
            const containerEl = document.querySelector('.container');




         // --- 데이터 로드 ---
                // userAge는 페이지 상단에서 이미 currentUserAgeForAccessCheck로 가져왔으므로 재활용 가능
                const userAge = currentUserAgeForAccessCheck; 
                console.log("Adult Analysis Page - User Age (confirmed for access):", userAge);

                const analysisDataString = localStorage.getItem('lozee_conversation_analysis');
                let analysisResults = null;

                if (!analysisDataString) {
                    console.warn("Adult Analysis Page: localStorage에 'lozee_conversation_analysis' 데이터가 없습니다.");
                    if (containerEl) {
                        document.querySelectorAll('.section:not(#analysisMethodologySection)').forEach(sec => {
                            if(sec) sec.style.display = 'none';
                        });
                        if (!containerEl.querySelector('.no-data-message')) {
                            const noDataMsgDiv = document.createElement('div');
                            noDataMsgDiv.className = 'feedback neutral no-data-message';
                            noDataMsgDiv.style.textAlign = 'center';
                            noDataMsgDiv.style.marginTop = '20px';
                            noDataMsgDiv.innerHTML = '<h2>아직 로지와 충분한 대화를 나누지 않으셨군요! 😮</h2><p>먼저 로지와 편안하게 대화하신 후, 대화 성찰 보고서를 확인해보세요.</p>';
                            const pageTitleH1 = containerEl.querySelector('h1');
                            if (pageTitleH1 && pageTitleH1.nextElementSibling) {
                                pageTitleH1.nextElementSibling.insertAdjacentElement('afterend', noDataMsgDiv);
                            } else if (pageTitleH1) {
                                containerEl.insertBefore(noDataMsgDiv, pageTitleH1.nextSibling);
                            } else {
                                containerEl.insertBefore(noDataMsgDiv, containerEl.firstChild);
                            }
                        }
                    }
                    return;
                }

                try {
                    const fullAnalysis = JSON.parse(analysisDataString);
                    analysisResults = fullAnalysis.results;
                } catch (e) {
                    console.error("저장된 분석 결과 파싱 오류:", e);
                    if (containerEl) containerEl.innerHTML = '<h1>앗! 분석 결과를 불러오는 데 문제가 생겼어요 😥</h1><p style="text-align:center;">이전 대화로 돌아가거나, 잠시 후 다시 시도해주세요.</p>';
                    return;
                }

                if (!analysisResults) {
                    console.warn("Adult Analysis Page: 파싱 후 analysisResults 객체가 null입니다.");
                    if (conversationSummaryContentEl) conversationSummaryContentEl.innerHTML = '<p>분석 결과가 없습니다.</p>';
                    return;
                }


          // --- 각 분석 섹션 렌더링 ---
                // 1. 로지와의 대화 요약
                if (conversationSummaryContentEl) {
                    if (analysisResults.conversationSummary) {
                        conversationSummaryContentEl.textContent = analysisResults.conversationSummary;
                    } else {
                        conversationSummaryContentEl.innerHTML = '<p>대화 요약 정보가 없습니다. 로지와 더 많은 이야기를 나눠보세요.</p>';
                    }
                }

                // 2. 감정 흐름 살펴보기
                const emotionToneSection = document.getElementById('emotionToneSection');
                if (emotionToneSection) {
                    if (chartJsIsReady && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                        if(emotionChartEl) emotionChartEl.style.display = 'block';
                        if(emotionChartContainerEl && emotionChartContainerEl.querySelector('.no-chart-message')) {
                             emotionChartContainerEl.querySelector('.no-chart-message').remove();
                        }
                        renderEmotionChart('emotionChart', analysisResults.emotionToneData);
                        if(empathyMessageEl) displayEmpathyMessage(analysisResults.emotionToneData);
                    } else {
                        if(emotionChartEl) emotionChartEl.style.display = 'none';
                        if(emotionChartContainerEl && !emotionChartContainerEl.querySelector('.no-chart-message')) {
                            const noDataMsg = document.createElement('p');
                            noDataMsg.textContent = chartJsIsReady ? "대화를 통해 나타난 감정들을 이곳에서 확인하실 수 있습니다. 😊" : "차트 기능을 불러오지 못했어요. 😥";
                            noDataMsg.style.textAlign = 'center'; noDataMsg.style.color = '#888'; noDataMsg.classList.add('no-chart-message');
                            emotionChartContainerEl.appendChild(noDataMsg);
                        }
                        if(empathyMessageEl) { empathyMessageEl.textContent = "대화에서 나타난 주된 감정을 파악하기 위해 로지와 더 깊은 이야기를 나눠보세요."; empathyMessageEl.className = 'feedback neutral'; empathyMessageEl.style.display = 'block'; }
                    }
                }

                // 3. 나의 대화 키워드
                const keywordsSection = document.getElementById('keywordsSection');
                if (keywordsSection && tagCloudEl) {
                    if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                        const weightedKeywords = analysisResults.keywords.map(kw => ({ text: kw, weight: Math.floor(5 + Math.random() * 10) }));
                        renderTagCloud('tagCloud', weightedKeywords);
                    } else {
                        tagCloudEl.innerHTML = '<p style="text-align:center; color:#888;">대화의 주요 키워드를 추출하고 있습니다. 충분한 대화가 필요해요.</p>';
                    }
                }

                // 4. 함께 생각해 볼 점 (인지왜곡)
                const situationSection = document.getElementById('situationSection');
                if (situationSection) {
                    if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                        if(situationAlertsEl) alertCognitiveDistortions('situationAlerts', analysisResults.cognitiveDistortions);
                        if (continueDistortionTalkBtn) {
                            continueDistortionTalkBtn.style.display = 'inline-block';
                            continueDistortionTalkBtn.onclick = () => {
                                createImprovementPlanIfNeeded(analysisResults, userAge);
                                const plan = (JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]')).find(p => p.type === 'cognitive_distortion' && analysisResults.cognitiveDistortions.includes(p.details));
                                if (plan) {
                                    const continueTopicData = {
                                        type: 'continue_improvement_plan',
                                        planType: plan.type,
                                        details: plan.topic || plan.details,
                                        prompt: plan.promptForContinuation || `"${plan.details}" 생각 패턴에 대해 더 이야기 나눠볼까요?`
                                    };
                                    localStorage.setItem('lozee_talk_init_topic', JSON.stringify(continueTopicData));
                                    window.location.href = 'talk.html';
                                } else {
                                    alert("이어갈 약속 정보를 생성하는 데 실패했습니다.");
                                }
                            };
                        }
                    } else {
                        if(situationAlertsEl) situationAlertsEl.innerHTML = '<p style="text-align:center; color:#888;">대화에서 특별히 치우친 생각 습관은 발견되지 않았어요. 균형 잡힌 시각을 잘 유지하고 계시는군요! 👍</p>';
                        if(continueDistortionTalkBtn) continueDistortionTalkBtn.style.display = 'none';
                    }
                }
                
                // 공유 버튼 로직
                if(reportShareButton) {
                    reportShareButton.onclick = () => {
                        const reportId = (localStorage.getItem('lozee_username') || 'user') + "_" + new Date().getTime();
                        const shareableLink = `${window.location.origin}${window.location.pathname}?report_id=${reportId}`; 

                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(shareableLink)
                                .then(() => {
                                    alert('성찰 보고서 공유 링크가 복사되었습니다!\n' + shareableLink + '\n(실제 공유를 위해서는 보고서 저장 기능이 필요합니다.)');
                                })
                                .catch(err => {
                                    console.error('클립보드 복사 실패:', err);
                                    alert('링크 복사에 실패했어요. 수동으로 복사해주세요:\n' + shareableLink);
                                });
                        } else {
                            prompt('아래 링크를 복사하여 공유하세요 (실제 공유 기능은 추가 구현 필요):', shareableLink);
                        }
                    };
                }
                 // 분석 결과 로드 후, "로지와의 약속" 생성
                if (analysisResults) {
                     createImprovementPlanIfNeeded(analysisResults, userAge);
                }
            }); // DOMContentLoaded 끝

            // --- 데이터 렌더링 함수들 ---
            // (renderTagCloud, alertCognitiveDistortions, renderEmotionChart, displayEmpathyMessage는 여기에 위치)
            // ... (이전 답변에서 제공된 함수들) ...
            function renderTagCloud(elementId, tags) { const cloudEl = document.getElementById(elementId); if(!cloudEl) return; if(tags && tags.length > 0) { cloudEl.innerHTML = tags.map(tag => { const size = 0.8 + ( (tag.weight || 5) / 15); const opacity = Math.max(0.5, (tag.weight || 5) / 10); return `<span class="badge" style="opacity:${opacity}; font-size:${size}em;">${tag.text}</span>`; }).join(''); } else { cloudEl.innerHTML = '<p style="text-align:center; color:#888;">대화의 주요 키워드를 추출하고 있습니다.</p>'; } }
            function alertCognitiveDistortions(elementId, distortions) { const alertEl = document.getElementById(elementId); if(!alertEl) return; if(distortions && distortions.length > 0) { alertEl.innerHTML = distortions.map(d => `<p class="cognitive-distortion-item">${d}</p>`).join(''); } else { alertEl.innerHTML = '<p style="text-align:center; color:#888;">특별히 한쪽으로 기울어진 생각 없이 이야기를 잘 나누고 있구나! 잘했어! 👍</p>';} }
            function renderEmotionChart(canvasId, emotionData) {
                 if (!chartLibraryInitialized || typeof Chart === 'undefined') { 
                    console.error("Chart.js가 준비되지 않아 차트를 그릴 수 없습니다."); 
                    const chartContainer = document.getElementById('emotionChartContainer');
                    if(chartContainer && !chartContainer.querySelector('.no-chart-library-message')) {
                         const noLibMsg = document.createElement('p');
                         noLibMsg.textContent = "차트 라이브러리를 불러오는 데 문제가 발생했어요. 😥";
                         noLibMsg.style.textAlign = 'center'; noLibMsg.style.color = 'red';
                         noLibMsg.classList.add('no-chart-library-message');
                         chartContainer.innerHTML = ''; 
                         chartContainer.appendChild(noLibMsg);
                    }
                    return; 
                }
                const ctx = document.getElementById(canvasId)?.getContext('2d');
                const chartContainer = document.getElementById('emotionChartContainer'); 
                const chartEl = document.getElementById(canvasId);


            if (!ctx) { /* ... 오류 처리 ... */ return; }
                if (!emotionData || Object.keys(emotionData).length === 0) { /* ... 데이터 없음 처리 ... */ return; }
                
                if(chartContainer) { 
                    const existingMsg = chartContainer.querySelector('.no-chart-message') || chartContainer.querySelector('.no-chart-library-message');
                    if (existingMsg) existingMsg.remove();
                    if(chartEl) chartEl.style.display = 'block';
                }

                const existingChart = Chart.getChart(ctx); 
                if (existingChart) { existingChart.destroy(); }

                const emotionColors = { '기쁨': 'rgba(255, 205, 86, 0.7)','슬픔': 'rgba(54, 162, 235, 0.7)','분노': 'rgba(255, 99, 132, 0.7)','불안': 'rgba(153, 102, 255, 0.7)','수치': 'rgba(255, 159, 64, 0.7)','중립': 'rgba(201, 203, 207, 0.7)'};
                const labels = Object.keys(emotionData);
                const dataValues = Object.values(emotionData);
                const backgroundColors = labels.map(label => emotionColors[label] || 'rgba(100, 100, 100, 0.7)');

                new Chart(ctx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: labels, 
                        datasets: [{ label: '나의 마음 비율', data: dataValues, backgroundColor: backgroundColors, borderColor: '#ffffff', borderWidth: 2 }] 
                    }, 
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { 
                            legend: { position: 'bottom', labels: { color: Chart.defaults.color, font: { family: Chart.defaults.font.family, size: 11 }, padding: 15 } }, 
                            tooltip: { titleFont: { family: Chart.defaults.font.family }, bodyFont: { family: Chart.defaults.font.family } } 
                        } 
                    } 
                });
            }
            function displayEmpathyMessage(emotionData) {
                const empathyMessageEl = document.getElementById('empathyMessage');
                if (!empathyMessageEl || !emotionData || Object.keys(emotionData).length === 0) {
                    if (empathyMessageEl) empathyMessageEl.style.display = 'none';
                    return;
                }

                const entries = Object.entries(emotionData).filter(([, score]) => score > 0); 
                if (entries.length === 0) { 
                     empathyMessageEl.textContent = '대화에서 다양한 감정들을 탐색해볼 수 있어요. 어떤 이야기를 나누고 싶으신가요?';
                     empathyMessageEl.className = 'feedback neutral';
                     empathyMessageEl.style.display = 'block';
                     return;
                }

                entries.sort((a, b) => b[1] - a[1]); 
                const [dominantEmotion, score] = entries[0];
                let msg = '';
                let sentimentClass = 'neutral';

                if (score > 0.3) { 
                    switch (dominantEmotion) {
                        case '기쁨': msg = `대화에서 <strong>긍정적이고 즐거운</strong> 감정이 많이 느껴지네요. 좋은 일이 있으셨나 봐요!`; sentimentClass = 'positive'; break;
                        case '슬픔': msg = `마음이 다소 가라앉거나 <strong>속상한 부분</strong>이 있으셨던 것 같아요. 괜찮으시다면 더 자세히 이야기해주셔도 좋아요.`; sentimentClass = 'negative'; break;
                        case '분노': msg = `혹시 <strong>불편하거나 화나는 일</strong>이 있으셨을까요? 대화에서 그런 기운이 감지되었어요.`; sentimentClass = 'negative'; break;
                        case '불안': msg = `<strong>걱정이나 긴장감</strong>이 느껴지는 부분이 있었어요. 마음에 담아두지 마시고 로지에게 편히 이야기해주세요.`; sentimentClass = 'negative'; break;
                        case '수치': msg = `혹시 <strong>당황스럽거나 부끄러운 감정</strong>을 느끼신 부분이 있었나요? 로지는 항상 당신을 지지해요.`; sentimentClass = 'neutral'; break;
                        case '중립': msg = `대화가 전반적으로 <strong>차분한 분위기</strong>에서 진행된 것 같아요. 편안하게 이야기 나눌 수 있어서 좋았습니다.`; sentimentClass = 'neutral'; break;
                        default: msg = '대화를 통해 다양한 감정들을 표현해주셨네요. 자신의 감정을 알아차리는 것은 매우 중요합니다.'; sentimentClass = 'neutral';
                    }
                } else {
                    msg = '대화에서 다양한 감정들을 탐색해볼 수 있었어요. 자신의 감정에 귀 기울이는 시간을 가져보세요.';
                    sentimentClass = 'neutral';
                }
                
                empathyMessageEl.innerHTML = msg; 
                empathyMessageEl.className = `feedback ${sentimentClass}`;
                empathyMessageEl.style.display = 'block';
            }
            function createImprovementPlanIfNeeded(analysisResults, userAge) {
                let plans = JSON.parse(localStorage.getItem('lozee_improvement_plans') || '[]' );
                const currentJournalId = localStorage.getItem('lozee_selected_journal_id') || `session_${new Date().getTime()}`;

                if (analysisResults.cognitiveDistortions && analysisResults.cognitiveDistortions.length > 0) {
                    analysisResults.cognitiveDistortions.forEach(distortion => {
                        const planId = `cog_${currentJournalId}_${distortion.replace(/\s+/g, '_')}`;
                        const existingPlan = plans.find(p => p.id === planId);
                        if (!existingPlan) {
                            plans.push({
                                id: planId,
                                type: 'cognitive_distortion',
                                title: `생각 습관 돌아보기: "${distortion}"`,
                                details: distortion,
                                topic: analysisResults.summaryTitle || "최근 대화 주제",
                                promptForContinuation: `이전에 "${analysisResults.summaryTitle || '이 대화'}"에서 나타났던 "${distortion}" 생각 패턴에 대해 더 깊이 이야기 나눠볼까요? 어떤 상황에서 그런 생각이 들었는지, 그로 인해 어떤 감정을 느끼셨는지 편하게 말씀해주세요.`
                            });
                        }
                    });
                }

                const uniquePlans = plans.filter((plan, index, self) => 
                    index === self.findIndex((p) => ( p.id === plan.id ))
                );

                if (uniquePlans.length > 0) {
                    localStorage.setItem('lozee_improvement_plans', JSON.stringify(uniquePlans));
                    console.log("Adult Analysis Page: 개선 계획 저장됨:", uniquePlans);
                } else {
                     console.log("Adult Analysis Page: 생성할 새로운 개선 계획이 없습니다.");
                }
            }

        } // <--- 여기가 페이지 접근 권한 확인 (15세 이상) else 블록의 닫는 부분
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>