<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTabTitle">이야기 모음집 - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <link rel="stylesheet" href="css/base.css"> <link rel="stylesheet" href="css/journal-list.css"> </head>
<body>
 <div class="app-container">
        <nav id="gnb">
            <button id="menu-toggle">☰</button>
            <div id="gnb-title">LOZEE</div>
            <div style="width: 44px;"></div>
            <div id="dropdown-menu">
                <a href="mypage.html">🎨 내 정보 보기</a>
                <a href="index.html">✨ 새로운 이야기 시작!</a>
                <a id="gnb-analysis-link" href="analysis.html">📊 우리 이야기 분석</a>
                <a href="journal-list.html">📖 이야기 모음집</a>
                <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a>
            </div>
        </nav>
    <main class="container journal-list-content-area" id="mainContainer"> <h1 id="pageMainTitle" class="page-title">나의 이야기 모음집 📖</h1>

        <div class="main-tags-area">
            <h2>✨ 나의 주요 이야기 태그 ✨</h2>
            <div id="mainTagButtons" class="tag-button-list">
                </div>
        </div>

        <div class="topic-summary-card-list" id="topicCardList">
            </div>

        <div class="pagination" id="paginationControls" style="display:none;">
            </div>
    </main>

      <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, doc, getDoc, limit, startAfter } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js'; // getCountFromServer import
        import { counselingTopicsByAge } from './js/counseling_topics.js'; // counselingTopicsByAge import
        import { saveReservation } from './js/firebase-utils.js'; // saveReservation import

        const topicCardListEl = document.getElementById('topicCardList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTabTitleEl = document.querySelector('title');
        const mainTagButtonsEl = document.getElementById('mainTagButtons');

        const userName = localStorage.getItem('lozee_username') || '나';
        const loggedInUserId = localStorage.getItem('lozee_userId'); // 로그인된 사용자 ID 가져오기

        if (pageMainTitleEl) pageMainTitleEl.textContent = `${userName}의 이야기 모음집 📖`;
        if (pageTabTitleEl) pageTabTitleEl.textContent = `${userName}의 이야기 모음집 - LOZEE`;

        let allUserTopicStats = []; 
        let currentFilterTag = '전체보기';

        // --- 헬퍼 함수: findMainCategoryOfTopic (복붙 또는 import) ---
        // 이 함수는 counseling_topics.js에 직접 정의되어 있지 않으므로, talk.js나 journal.html의 스크립트에서 가져오거나 다시 정의해야 합니다.
        // 여기서는 journal-list.html 스크립트 내부에 다시 정의하겠습니다.
        function findMainCategoryOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName]; // 실제 메인 주제 객체
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return mainTopicObject.name; // 메인 주제의 name 반환
                                }
                            }
                        }
                    }
                }
            }
            return '';
        }

        // --- 헬퍼 함수: getDisplayNameOfTopic (복붙 또는 import) ---
        function getDisplayNameOfTopic(topicKey, topicsData) {
             for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName];
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return subTopic.displayText;
                                }
                            }
                        }
                    }
                }
            }
            return topicKey;
        }

        // --- 주제별 요약 카드 생성 함수 ---
        function createTopicSummaryCard(topicName, statData) {
            const card = document.createElement('div');
            card.className = 'topic-summary-card';

            const mainTitle = statData.topicDisplayName || topicName;
            const subTitle = statData.latestSubTopicTitle || `"${mainTitle}"에 대한 이야기`;
            const lastChattedDate = statData.lastChattedAt?.toDate
                ? statData.lastChattedAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric'})
                : '알 수 없음';
            const sessionCount = statData.count || 0;
            const assessment = statData.overallAssessment || `이 주제로 ${sessionCount}번 이야기했어요.`;

            let analysisBannerHTML = '';
            if (statData.sentimentExample) {
                 let bannerClass = 'neutral';
                 if (statData.sentimentExample === 'positive') bannerClass = 'positive';
                 else if (statData.sentimentExample === 'negative') bannerClass = 'negative';
                 analysisBannerHTML = `<div class="journal-analysis-banner ${bannerClass}">✨ 로지 생각: ${statData.sentimentExample} 느낌의 대화였어요!</div>`;
            }

            card.innerHTML = `
                <div class="topic-main-title">${mainTitle}</div>
                <div class="topic-sub-title">${subTitle}</div>
                <div class="topic-meta-info">
                    <span class="meta-item">마지막 이야기: ${lastChattedDate}</span>
                    <span class="meta-item">총 이야기: ${sessionCount}회</span>
                </div>
                <p class="journal-summary-preview">${assessment}</p>
                ${analysisBannerHTML}
                <a href="journal.html?journalId=${statData.id}" class="view-sessions-button">${sessionCount > 0 ? sessionCount : '이야기'} 자세히 보기</a>
            `;
            return card;
        }

        // --- 자주 사용된 태그 버튼 표시 함수 ---
        function displayMainTags(statsForTagExtraction) {
            if (!mainTagButtonsEl) return;
            mainTagButtonsEl.innerHTML = '';

            const tagCounts = {};
            statsForTagExtraction.forEach(stat => {
                if (stat.keywords && Array.isArray(stat.keywords)) {
                    stat.keywords.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });

            const sortedTags = Object.entries(tagCounts)
                .sort(([,a],[,b]) => b-a).slice(0, 5).map(([tag]) => tag);

            const allViewBtn = document.createElement('button');
            allViewBtn.className = 'tag-filter-btn';
            allViewBtn.textContent = '✨ 전체 이야기';
            allViewBtn.dataset.tag = '전체보기';
            allViewBtn.onclick = () => { currentFilterTag = '전체보기'; renderFilteredTopicCards(); updateTagButtonStates(); };
            mainTagButtonsEl.appendChild(allViewBtn);

            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                button.className = 'tag-filter-btn';
                button.textContent = `#${tag}`;
                button.dataset.tag = tag;
                button.onclick = () => { currentFilterTag = tag; renderFilteredTopicCards(); updateTagButtonStates();};
                mainTagButtonsEl.appendChild(button);
            });
            updateTagButtonStates(); // 초기 로드 시 활성화된 태그 설정
        }

        function updateTagButtonStates() {
            if (!mainTagButtonsEl) return;
            const buttons = mainTagButtonsEl.querySelectorAll('.tag-filter-btn');
            buttons.forEach(btn => {
                if (btn.dataset.tag === currentFilterTag) { btn.classList.add('active'); }
                else { btn.classList.remove('active'); }
            });
        }
        
        // --- 필터링된 주제 요약 카드를 화면에 렌더링하는 함수 ---
        function renderFilteredTopicCards() {
            if (!topicCardListEl) return;
            topicCardListEl.innerHTML = '';

            const topicsToDisplay = currentFilterTag && currentFilterTag !== '전체보기'
                ? allUserTopicStats.filter(stat => stat.keywords && stat.keywords.includes(currentFilterTag))
                : allUserTopicStats;

            if (topicsToDisplay.length === 0) {
                topicCardListEl.innerHTML = currentFilterTag && currentFilterTag !== '전체보기'
                    ? `<p style="text-align:center;">'#${currentFilterTag}' 태그가 포함된 주제의 이야기가 아직 없어요. 🧐</p>`
                    : '<p style="text-align:center;">아직 로지랑 나눈 이야기가 없는 것 같아요. 대화를 시작해볼까요? 😊</p>';
                return;
            }
            
            topicsToDisplay.forEach(topicStatData => {
                const card = createTopicSummaryCard(topicStatData.id, topicStatData);
                topicCardListEl.appendChild(card);
            });
        }

        // --- Firestore에서 초기 데이터 로드 함수 ---
        async function loadInitialPageData() {
            if (!loggedInUserId) {
                if(pageMainTitleEl) pageMainTitleEl.textContent = `${localStorage.getItem('lozee_username') || '나'}의 이야기 모음집 📖 (로그인 필요)`;
                console.log("사용자 ID 없음, 예시 데이터를 표시합니다.");
                displaySampleJournalTopicCards(); // 사용자 ID 없으면 예시 데이터 표시
                return;
            }

            try {
                const statsQuery = query(collection(db, `users/${loggedInUserId}/topicStats`), orderBy('lastChattedAt', 'desc'));
                const statsSnapshot = await getDocs(statsQuery);

                if (statsSnapshot.empty) {
                    console.log("Firestore에 topicStats 데이터 없음, 예시 데이터를 표시합니다.");
                    if(mainTagButtonsEl) mainTagButtonsEl.innerHTML = '<p>이야기를 나누면 자주 나온 마음 조각들을 여기서 볼 수 있어요!</p>';
                    displaySampleJournalTopicCards(); // 데이터 없으면 예시 데이터 표시
                    return;
                }

                allUserTopicStats = statsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allUserTopicStats.forEach(stat => { if (!stat.keywords) stat.keywords = []; });

                displayMainTags(allUserTopicStats);
                currentFilterTag = '전체보기';
                renderFilteredTopicCards();

            } catch (error) {
                console.error("초기 데이터 로드 중 오류:", error);
                if(topicCardListEl) topicCardListEl.innerHTML = '<p>이야기 모음집을 불러오는 데 문제가 발생했어요. 😭 잠시 후 다시 시도해주세요.</p>';
                console.log("오류 발생, 예시 데이터를 표시합니다.");
                displaySampleJournalTopicCards(); // 오류 발생 시 예시 데이터 표시
            }
        }
        
        // --- [임시] Firestore 데이터가 없을 때 표시할 샘플 데이터 ---
        function displaySampleJournalTopicCards() {
            if (!topicCardListEl) return;
            topicCardListEl.innerHTML = ''; 
            
            const sampleTopics = [
                {
                    id: "가족_관계",
                    topicDisplayName: "가족 관계 👨‍👩‍👧‍👦",
                    latestSubTopicTitle: "반복되는 가족 패턴과 나의 대처",
                    lastChattedAt: { toDate: () => new Date() },
                    count: 5,
                    overallAssessment: "가족 내에서 반복되는 특정 행동 패턴과 그에 대한 라이언님의 명확한 분석, 그리고 직면 대응 방식에 대한 깊이 있는 대화였어요. 자신의 특성을 이해하고 관계를 주체적으로 관리하려는 모습이 인상적이네요.",
                    keywords: ["가족", "패턴", "회피", "직면대응", "아스퍼거"],
                    sentimentExample: "neutral"
                },
                {
                    id: "학교생활_이야기",
                    topicDisplayName: "학교생활 이야기 🎒",
                    latestSubTopicTitle: "새 학기, 새로운 친구들",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 3) },
                    count: 3,
                    overallAssessment: "새 학년이 되어 새로운 친구들을 사귀는 것에 대한 기대와 약간의 긴장감이 느껴지는 대화였어요. 로지가 응원할게요!",
                    keywords: ["학교", "새학기", "친구", "기대"],
                    sentimentExample: "positive"
                },
                {
                    id: "감정_표현하기",
                    topicDisplayName: "감정 표현하기 😠",
                    latestSubTopicTitle: "화 조절이 너무 어려워요",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 7) },
                    count: 8,
                    overallAssessment: "화 조절의 어려움에 대해 깊이 있게 이야기 나누었습니다. 로지와 함께 감정을 파악하고 표현하는 방법을 연습해 보아요.",
                    keywords: ["분노", "감정조절", "짜증"],
                    sentimentExample: "negative"
                }
            ];

            // 샘플 데이터로 태그 버튼 표시
            if (mainTagButtonsEl) {
                const sampleKeywordsForTags = sampleTopics.reduce((acc, curr) => {
                    if(curr.keywords) acc.push(...curr.keywords);
                    return acc;
                }, []);
                const uniqueSampleKeywords = [...new Set(sampleKeywordsForTags)];
                // displayMainTags는 {id: topic명, keywords: [...]} 형태를 기대하므로 변환
                const tagsDataForDisplay = uniqueSampleKeywords.map(kw => ({ id: kw, keywords: [kw] })); 
                displayMainTags(tagsDataForDisplay);
            }

            sampleTopics.forEach(topicData => {
                const card = createTopicSummaryCard(topicData.id, topicData);
                topicCardListEl.appendChild(card);
            });
            updateTagButtonStates();
        }

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialPageData();
        });
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>