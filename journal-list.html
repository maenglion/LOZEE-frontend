<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTabTitle">ì´ì•¼ê¸° ëª¨ìŒì§‘ - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <link rel="stylesheet" href="css/base.css"> <link rel="stylesheet" href="css/journal-list.css"> </head>
<body>
 <div class="app-container">
        <nav id="gnb">
            <button id="menu-toggle">â˜°</button>
            <div id="gnb-title">LOZEE</div>
            <div style="width: 44px;"></div>
            <div id="dropdown-menu">
                <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a>
                <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a>
                <a id="gnb-analysis-link" href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a>
                <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a>
                <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
            </div>
        </nav>
    <main class="container journal-list-content-area" id="mainContainer"> <h1 id="pageMainTitle" class="page-title">ë‚˜ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–</h1>

        <div class="main-tags-area">
            <h2>âœ¨ ë‚˜ì˜ ì£¼ìš” ì´ì•¼ê¸° íƒœê·¸ âœ¨</h2>
            <div id="mainTagButtons" class="tag-button-list">
                </div>
        </div>

        <div class="topic-summary-card-list" id="topicCardList">
            </div>

        <div class="pagination" id="paginationControls" style="display:none;">
            </div>
    </main>

      <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, doc, getDoc, limit, startAfter } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js'; // getCountFromServer import
        import { counselingTopicsByAge } from './js/counseling_topics.js'; // counselingTopicsByAge import
        import { saveReservation } from './js/firebase-utils.js'; // saveReservation import

        const topicCardListEl = document.getElementById('topicCardList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTabTitleEl = document.querySelector('title');
        const mainTagButtonsEl = document.getElementById('mainTagButtons');

        const userName = localStorage.getItem('lozee_username') || 'ë‚˜';
        const loggedInUserId = localStorage.getItem('lozee_userId'); // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°

        if (pageMainTitleEl) pageMainTitleEl.textContent = `${userName}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–`;
        if (pageTabTitleEl) pageTabTitleEl.textContent = `${userName}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ - LOZEE`;

        let allUserTopicStats = []; 
        let currentFilterTag = 'ì „ì²´ë³´ê¸°';

        // --- í—¬í¼ í•¨ìˆ˜: findMainCategoryOfTopic (ë³µë¶™ ë˜ëŠ” import) ---
        // ì´ í•¨ìˆ˜ëŠ” counseling_topics.jsì— ì§ì ‘ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šìœ¼ë¯€ë¡œ, talk.jsë‚˜ journal.htmlì˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ë‹¤ì‹œ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” journal-list.html ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì— ë‹¤ì‹œ ì •ì˜í•˜ê² ìŠµë‹ˆë‹¤.
        function findMainCategoryOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName]; // ì‹¤ì œ ë©”ì¸ ì£¼ì œ ê°ì²´
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return mainTopicObject.name; // ë©”ì¸ ì£¼ì œì˜ name ë°˜í™˜
                                }
                            }
                        }
                    }
                }
            }
            return '';
        }

        // --- í—¬í¼ í•¨ìˆ˜: getDisplayNameOfTopic (ë³µë¶™ ë˜ëŠ” import) ---
        function getDisplayNameOfTopic(topicKey, topicsData) {
             for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName];
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return subTopic.displayText;
                                }
                            }
                        }
                    }
                }
            }
            return topicKey;
        }

        // --- ì£¼ì œë³„ ìš”ì•½ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ ---
        function createTopicSummaryCard(topicName, statData) {
            const card = document.createElement('div');
            card.className = 'topic-summary-card';

            const mainTitle = statData.topicDisplayName || topicName;
            const subTitle = statData.latestSubTopicTitle || `"${mainTitle}"ì— ëŒ€í•œ ì´ì•¼ê¸°`;
            const lastChattedDate = statData.lastChattedAt?.toDate
                ? statData.lastChattedAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric'})
                : 'ì•Œ ìˆ˜ ì—†ìŒ';
            const sessionCount = statData.count || 0;
            const assessment = statData.overallAssessment || `ì´ ì£¼ì œë¡œ ${sessionCount}ë²ˆ ì´ì•¼ê¸°í–ˆì–´ìš”.`;

            let analysisBannerHTML = '';
            if (statData.sentimentExample) {
                 let bannerClass = 'neutral';
                 if (statData.sentimentExample === 'positive') bannerClass = 'positive';
                 else if (statData.sentimentExample === 'negative') bannerClass = 'negative';
                 analysisBannerHTML = `<div class="journal-analysis-banner ${bannerClass}">âœ¨ ë¡œì§€ ìƒê°: ${statData.sentimentExample} ëŠë‚Œì˜ ëŒ€í™”ì˜€ì–´ìš”!</div>`;
            }

            card.innerHTML = `
                <div class="topic-main-title">${mainTitle}</div>
                <div class="topic-sub-title">${subTitle}</div>
                <div class="topic-meta-info">
                    <span class="meta-item">ë§ˆì§€ë§‰ ì´ì•¼ê¸°: ${lastChattedDate}</span>
                    <span class="meta-item">ì´ ì´ì•¼ê¸°: ${sessionCount}íšŒ</span>
                </div>
                <p class="journal-summary-preview">${assessment}</p>
                ${analysisBannerHTML}
                <a href="journal.html?journalId=${statData.id}" class="view-sessions-button">${sessionCount > 0 ? sessionCount : 'ì´ì•¼ê¸°'} ìì„¸íˆ ë³´ê¸°</a>
            `;
            return card;
        }

        // --- ìì£¼ ì‚¬ìš©ëœ íƒœê·¸ ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜ ---
        function displayMainTags(statsForTagExtraction) {
            if (!mainTagButtonsEl) return;
            mainTagButtonsEl.innerHTML = '';

            const tagCounts = {};
            statsForTagExtraction.forEach(stat => {
                if (stat.keywords && Array.isArray(stat.keywords)) {
                    stat.keywords.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });

            const sortedTags = Object.entries(tagCounts)
                .sort(([,a],[,b]) => b-a).slice(0, 5).map(([tag]) => tag);

            const allViewBtn = document.createElement('button');
            allViewBtn.className = 'tag-filter-btn';
            allViewBtn.textContent = 'âœ¨ ì „ì²´ ì´ì•¼ê¸°';
            allViewBtn.dataset.tag = 'ì „ì²´ë³´ê¸°';
            allViewBtn.onclick = () => { currentFilterTag = 'ì „ì²´ë³´ê¸°'; renderFilteredTopicCards(); updateTagButtonStates(); };
            mainTagButtonsEl.appendChild(allViewBtn);

            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                button.className = 'tag-filter-btn';
                button.textContent = `#${tag}`;
                button.dataset.tag = tag;
                button.onclick = () => { currentFilterTag = tag; renderFilteredTopicCards(); updateTagButtonStates();};
                mainTagButtonsEl.appendChild(button);
            });
            updateTagButtonStates(); // ì´ˆê¸° ë¡œë“œ ì‹œ í™œì„±í™”ëœ íƒœê·¸ ì„¤ì •
        }

        function updateTagButtonStates() {
            if (!mainTagButtonsEl) return;
            const buttons = mainTagButtonsEl.querySelectorAll('.tag-filter-btn');
            buttons.forEach(btn => {
                if (btn.dataset.tag === currentFilterTag) { btn.classList.add('active'); }
                else { btn.classList.remove('active'); }
            });
        }
        
        // --- í•„í„°ë§ëœ ì£¼ì œ ìš”ì•½ ì¹´ë“œë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ ---
        function renderFilteredTopicCards() {
            if (!topicCardListEl) return;
            topicCardListEl.innerHTML = '';

            const topicsToDisplay = currentFilterTag && currentFilterTag !== 'ì „ì²´ë³´ê¸°'
                ? allUserTopicStats.filter(stat => stat.keywords && stat.keywords.includes(currentFilterTag))
                : allUserTopicStats;

            if (topicsToDisplay.length === 0) {
                topicCardListEl.innerHTML = currentFilterTag && currentFilterTag !== 'ì „ì²´ë³´ê¸°'
                    ? `<p style="text-align:center;">'#${currentFilterTag}' íƒœê·¸ê°€ í¬í•¨ëœ ì£¼ì œì˜ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”. ğŸ§</p>`
                    : '<p style="text-align:center;">ì•„ì§ ë¡œì§€ë‘ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì—†ëŠ” ê²ƒ ê°™ì•„ìš”. ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸ˜Š</p>';
                return;
            }
            
            topicsToDisplay.forEach(topicStatData => {
                const card = createTopicSummaryCard(topicStatData.id, topicStatData);
                topicCardListEl.appendChild(card);
            });
        }

        // --- Firestoreì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ---
        async function loadInitialPageData() {
            if (!loggedInUserId) {
                if(pageMainTitleEl) pageMainTitleEl.textContent = `${localStorage.getItem('lozee_username') || 'ë‚˜'}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“– (ë¡œê·¸ì¸ í•„ìš”)`;
                console.log("ì‚¬ìš©ì ID ì—†ìŒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                displaySampleJournalTopicCards(); // ì‚¬ìš©ì ID ì—†ìœ¼ë©´ ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ
                return;
            }

            try {
                const statsQuery = query(collection(db, `users/${loggedInUserId}/topicStats`), orderBy('lastChattedAt', 'desc'));
                const statsSnapshot = await getDocs(statsQuery);

                if (statsSnapshot.empty) {
                    console.log("Firestoreì— topicStats ë°ì´í„° ì—†ìŒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                    if(mainTagButtonsEl) mainTagButtonsEl.innerHTML = '<p>ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©´ ìì£¼ ë‚˜ì˜¨ ë§ˆìŒ ì¡°ê°ë“¤ì„ ì—¬ê¸°ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>';
                    displaySampleJournalTopicCards(); // ë°ì´í„° ì—†ìœ¼ë©´ ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ
                    return;
                }

                allUserTopicStats = statsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allUserTopicStats.forEach(stat => { if (!stat.keywords) stat.keywords = []; });

                displayMainTags(allUserTopicStats);
                currentFilterTag = 'ì „ì²´ë³´ê¸°';
                renderFilteredTopicCards();

            } catch (error) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(topicCardListEl) topicCardListEl.innerHTML = '<p>ì´ì•¼ê¸° ëª¨ìŒì§‘ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜­ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                console.log("ì˜¤ë¥˜ ë°œìƒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                displaySampleJournalTopicCards(); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ
            }
        }
        
        // --- [ì„ì‹œ] Firestore ë°ì´í„°ê°€ ì—†ì„ ë•Œ í‘œì‹œí•  ìƒ˜í”Œ ë°ì´í„° ---
        function displaySampleJournalTopicCards() {
            if (!topicCardListEl) return;
            topicCardListEl.innerHTML = ''; 
            
            const sampleTopics = [
                {
                    id: "ê°€ì¡±_ê´€ê³„",
                    topicDisplayName: "ê°€ì¡± ê´€ê³„ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
                    latestSubTopicTitle: "ë°˜ë³µë˜ëŠ” ê°€ì¡± íŒ¨í„´ê³¼ ë‚˜ì˜ ëŒ€ì²˜",
                    lastChattedAt: { toDate: () => new Date() },
                    count: 5,
                    overallAssessment: "ê°€ì¡± ë‚´ì—ì„œ ë°˜ë³µë˜ëŠ” íŠ¹ì • í–‰ë™ íŒ¨í„´ê³¼ ê·¸ì— ëŒ€í•œ ë¼ì´ì–¸ë‹˜ì˜ ëª…í™•í•œ ë¶„ì„, ê·¸ë¦¬ê³  ì§ë©´ ëŒ€ì‘ ë°©ì‹ì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì˜€ì–´ìš”. ìì‹ ì˜ íŠ¹ì„±ì„ ì´í•´í•˜ê³  ê´€ê³„ë¥¼ ì£¼ì²´ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë ¤ëŠ” ëª¨ìŠµì´ ì¸ìƒì ì´ë„¤ìš”.",
                    keywords: ["ê°€ì¡±", "íŒ¨í„´", "íšŒí”¼", "ì§ë©´ëŒ€ì‘", "ì•„ìŠ¤í¼ê±°"],
                    sentimentExample: "neutral"
                },
                {
                    id: "í•™êµìƒí™œ_ì´ì•¼ê¸°",
                    topicDisplayName: "í•™êµìƒí™œ ì´ì•¼ê¸° ğŸ’",
                    latestSubTopicTitle: "ìƒˆ í•™ê¸°, ìƒˆë¡œìš´ ì¹œêµ¬ë“¤",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 3) },
                    count: 3,
                    overallAssessment: "ìƒˆ í•™ë…„ì´ ë˜ì–´ ìƒˆë¡œìš´ ì¹œêµ¬ë“¤ì„ ì‚¬ê·€ëŠ” ê²ƒì— ëŒ€í•œ ê¸°ëŒ€ì™€ ì•½ê°„ì˜ ê¸´ì¥ê°ì´ ëŠê»´ì§€ëŠ” ëŒ€í™”ì˜€ì–´ìš”. ë¡œì§€ê°€ ì‘ì›í• ê²Œìš”!",
                    keywords: ["í•™êµ", "ìƒˆí•™ê¸°", "ì¹œêµ¬", "ê¸°ëŒ€"],
                    sentimentExample: "positive"
                },
                {
                    id: "ê°ì •_í‘œí˜„í•˜ê¸°",
                    topicDisplayName: "ê°ì • í‘œí˜„í•˜ê¸° ğŸ˜ ",
                    latestSubTopicTitle: "í™” ì¡°ì ˆì´ ë„ˆë¬´ ì–´ë ¤ì›Œìš”",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 7) },
                    count: 8,
                    overallAssessment: "í™” ì¡°ì ˆì˜ ì–´ë ¤ì›€ì— ëŒ€í•´ ê¹Šì´ ìˆê²Œ ì´ì•¼ê¸° ë‚˜ëˆ„ì—ˆìŠµë‹ˆë‹¤. ë¡œì§€ì™€ í•¨ê»˜ ê°ì •ì„ íŒŒì•…í•˜ê³  í‘œí˜„í•˜ëŠ” ë°©ë²•ì„ ì—°ìŠµí•´ ë³´ì•„ìš”.",
                    keywords: ["ë¶„ë…¸", "ê°ì •ì¡°ì ˆ", "ì§œì¦"],
                    sentimentExample: "negative"
                }
            ];

            // ìƒ˜í”Œ ë°ì´í„°ë¡œ íƒœê·¸ ë²„íŠ¼ í‘œì‹œ
            if (mainTagButtonsEl) {
                const sampleKeywordsForTags = sampleTopics.reduce((acc, curr) => {
                    if(curr.keywords) acc.push(...curr.keywords);
                    return acc;
                }, []);
                const uniqueSampleKeywords = [...new Set(sampleKeywordsForTags)];
                // displayMainTagsëŠ” {id: topicëª…, keywords: [...]} í˜•íƒœë¥¼ ê¸°ëŒ€í•˜ë¯€ë¡œ ë³€í™˜
                const tagsDataForDisplay = uniqueSampleKeywords.map(kw => ({ id: kw, keywords: [kw] })); 
                displayMainTags(tagsDataForDisplay);
            }

            sampleTopics.forEach(topicData => {
                const card = createTopicSummaryCard(topicData.id, topicData);
                topicCardListEl.appendChild(card);
            });
            updateTagButtonStates();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialPageData();
        });
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>