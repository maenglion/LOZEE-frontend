<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTabTitle">ì´ì•¼ê¸° ëª¨ìŒì§‘ - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css">
    <style>
        /* ... (ì´ì „ journal-list.htmlì˜ CSS ìŠ¤íƒ€ì¼ ëŒ€ë¶€ë¶„ ìœ ì§€) ... */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
            --yellow-highlight: #fff9c4; 
            --blue-button: #6e8efb; 
        }
        body { margin: 0; padding-top: var(--gnb-height); font-family: 'KoPub World Dotum', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1100px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        .page-title { color: var(--primary-color); text-align: center; font-size: 2em; margin-bottom: 30px; font-weight: 700; }

        .main-tags-area { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; text-align: center; }
        .main-tags-area h2 { font-size: 1.2em; color: var(--primary-color); margin-top: 0; margin-bottom: 15px; border-bottom: none; }
        .tag-button-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .tag-filter-btn { padding: 8px 15px; background-color: #e8eaf6; color: #3f51b5; border: none; border-radius: 20px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: background-color 0.2s, transform 0.1s; }
        .tag-filter-btn:hover { background-color: #c5cae9; transform: translateY(-1px); }
        .tag-filter-btn.active { background-color: var(--primary-color); color: white; font-weight: bold; }

        .topic-summary-card-list { display: grid; gap: 25px; } /* journal-list.htmlì—ì„œ topicCardListElë¡œ ì‚¬ìš© */
        .topic-summary-card { /* journal-list.htmlì˜ ì£¼ì œë³„ ìš”ì•½ ì¹´ë“œ */
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px; /* íŒ¨ë”© ì¼ê´€ì„± */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        .topic-main-title { font-size: 1.4em; font-weight: bold; color: var(--primary-color); margin-bottom: 5px; }
        .topic-sub-title { font-size: 1.1em; color: var(--text-color); margin-bottom: 15px; font-weight: 500; }
        .topic-meta-info { display: flex; flex-wrap:wrap; gap: 10px; margin-bottom: 15px; }
        .meta-item { background-color: var(--yellow-highlight); color: #5d4037; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
        
        .journal-summary-preview { /* journal-listì—ì„œë„ ê°„ë‹¨ ìš”ì•½ ë³´ì—¬ì¤„ ë•Œ ì‚¬ìš© */
            font-size: 0.95em;
            color: #444;
            margin-bottom: 12px;
            flex-grow: 1; 
            display: -webkit-box;
            -webkit-line-clamp: 3; /* ìš”ì•½ ë¯¸ë¦¬ë³´ê¸° ì¤„ ìˆ˜ */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 4.5em; /* ëŒ€ëµì ì¸ ë†’ì´ (0.95em * 1.6 * 3ì¤„) */
        }
        .journal-analysis-banner { /* journal-listì˜ ì¹´ë“œì—ë„ ì ìš© */
            padding: 8px 12px; border-radius: 6px; margin-top: 12px; margin-bottom: 8px; font-size: 0.9em; text-align: center;
        }
        .journal-analysis-banner.positive { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9;}
        .journal-analysis-banner.neutral { background-color: #eceff1; color: #37474f; border: 1px solid #cfd8dc;}
        .journal-analysis-banner.negative { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2;}

        .view-sessions-button { display: inline-block; background-color: var(--blue-button); color: white; padding: 10px 20px; border: none; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 0.95em; transition: background-color 0.2s; margin-top: auto; /* ì¹´ë“œ í•˜ë‹¨ ì •ë ¬ */ align-self: flex-start; /* ì™¼ìª½ ì •ë ¬ */}
        .view-sessions-button:hover { background-color: var(--secondary-color); }

        @media (min-width: 1024px) { .topic-summary-card-list { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 601px) and (max-width: 1023px) { .topic-summary-card-list { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .topic-summary-card-list { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav id="gnb">
        </nav> 

    <main class="container">
        <h1 id="pageMainTitle" class="page-title">ë‚˜ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–</h1>

        <div class="main-tags-area">
            <h2>âœ¨ ë‚˜ì˜ ì£¼ìš” ì´ì•¼ê¸° íƒœê·¸ âœ¨</h2>
            <div id="mainTagButtons" class="tag-button-list">
                </div>
        </div>

        <div class="topic-summary-card-list" id="topicCardList">
            </div>

        <div class="pagination" style="display:none;"> 
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, doc, getDoc, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const topicCardListEl = document.getElementById('topicCardList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTabTitleEl = document.querySelector('title');
        const mainTagButtonsEl = document.getElementById('mainTagButtons');

        const userName = localStorage.getItem('lozee_username') || 'ë‚˜';
        if (pageMainTitleEl) pageMainTitleEl.textContent = `${userName}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–`;
        if (pageTabTitleEl) pageTabTitleEl.textContent = `${userName}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ - LOZEE`;

        let allUserTopicStats = []; // ëª¨ë“  ì£¼ì œ í†µê³„ ë°ì´í„°ë¥¼ ìºì‹± (topicStats ë¬¸ì„œë“¤)
        let allUserJournalsForTags = []; // íƒœê·¸ ì¶”ì¶œì„ ìœ„í•œ ì „ì²´ ì €ë„ ë°ì´í„° (ê°„ì†Œí™”ëœ ì •ë³´ë§Œ)
        let currentFilterTag = 'ì „ì²´ë³´ê¸°';

        // --- ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ í•¨ìˆ˜ (ì‹ ì„¤) ---
        function displaySampleJournalTopicCards() {
            if (!topicCardListEl) return;
            topicCardListEl.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°
            
            const sampleTopics = [
                {
                    topicDisplayName: "í•™êµìƒí™œ ì´ì•¼ê¸° ğŸ’",
                    latestSubTopicTitle: "ì§ê¿ì´ë‘ ë¹„ë°€ í”„ë¡œì íŠ¸ ì‹œì‘!",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 1) }, // 1ì¼ ì „
                    count: 5,
                    overallAssessment: "ì¹œêµ¬ì™€ì˜ ë¹„ë°€ ë§Œë“¤ê¸°ëŠ” ì •ë§ ì‹ ë‚˜ëŠ” ì¼ì´ì§€! ë¡œì§€ë„ ê¶ê¸ˆí•œê±¸? ğŸ˜Š",
                    keywords: ["í•™êµ", "ì¹œêµ¬", "ë¹„ë°€"] // íƒœê·¸ í´ë¼ìš°ë“œìš© ì˜ˆì‹œ í‚¤ì›Œë“œ
                },
                {
                    topicDisplayName: "ê°€ì¡± ì´ì•¼ê¸° ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
                    latestSubTopicTitle: "ì—„ë§ˆì˜ ë”°ëœ»í•œ ìœ„ë¡œ",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 3) }, // 3ì¼ ì „
                    count: 2,
                    overallAssessment: "ê°€ì¡±ì—ê²Œ ìœ„ë¡œë°›ëŠ” ê±´ ì •ë§ í° í˜ì´ ë¼. ë§ˆìŒì´ ë”°ëœ»í•´ì§€ëŠ” ì´ì•¼ê¸°ì˜€ì–´. â¤ï¸",
                    keywords: ["ê°€ì¡±", "ì—„ë§ˆ", "ìœ„ë¡œ"]
                },
                {
                    topicDisplayName: "ë‚´ ë§ˆìŒ ì´ì•¼ê¸° ğŸ’­",
                    latestSubTopicTitle: "ë¡¤ëŸ¬ì½”ìŠ¤í„° ê°™ì€ ë‚´ ê¸°ë¶„",
                    lastChattedAt: { toDate: () => new Date(Date.now() - 86400000 * 5) }, // 5ì¼ ì „
                    count: 1,
                    overallAssessment: "ë§ˆìŒì´ ì—¬ëŸ¬ ê°€ì§€ ìƒ‰ê¹”ì„ ê°€ì§€ëŠ” ê±´ ìì—°ìŠ¤ëŸ¬ìš´ ê±°ì•¼. ë¡œì§€ê°€ í•­ìƒ ë„¤ ë§ˆìŒì„ ì‚´í´ì¤„ê²Œ! ğŸ‘",
                    keywords: ["ê°ì •", "ë‚˜", "ê¸°ë¶„"]
                }
            ];

            if (mainTagButtonsEl) { // ìƒ˜í”Œ íƒœê·¸ ë²„íŠ¼ í‘œì‹œ
                const sampleKeywordsForTags = sampleTopics.reduce((acc, curr) => {
                    if(curr.keywords) acc.push(...curr.keywords);
                    return acc;
                }, []);
                const uniqueSampleKeywords = [...new Set(sampleKeywordsForTags)];
                const journalsForSampleTags = uniqueSampleKeywords.map(kw => ({keywords: [kw]})); // displayMainTags í˜•ì‹ì— ë§ì¶¤
                displayMainTags(journalsForSampleTags.length > 0 ? journalsForSampleTags : [{keywords:['ìƒ˜í”Œíƒœê·¸']}]); // íƒœê·¸ê°€ í•˜ë‚˜ë¼ë„ ìˆë„ë¡
            }


            sampleTopics.forEach(topicData => {
                const card = createTopicSummaryCard(topicData.topicDisplayName, topicData); // topicNameì€ topicDisplayNameê³¼ ë™ì¼í•˜ê²Œ
                topicCardListEl.appendChild(card);
            });
            updateTagButtonStates(); // "ì „ì²´ë³´ê¸°" ë²„íŠ¼ í™œì„±í™”
        }
        
        // --- ì£¼ì œë³„ ìš”ì•½ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (ë¶„ë¦¬) ---
        function createTopicSummaryCard(topicName, statData) {
            const card = document.createElement('div');
            card.className = 'topic-summary-card';

            const mainTitle = statData.topicDisplayName || topicName;
            // ì†Œì£¼ì œë‚˜ ìµœê·¼ ì €ë„ ì œëª©ì€ Firestoreì— ì €ì¥ëœ ê°’ì„ ì‚¬ìš©í•˜ê±°ë‚˜,
            // topicStatsì— latestJournalTitle í•„ë“œë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ. ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œ.
            const subTitle = statData.latestSubTopicTitle || `"${mainTitle}"ì— ëŒ€í•œ ìµœê·¼ ì´ì•¼ê¸°`; 
            const lastChattedDate = statData.lastChattedAt?.toDate 
                ? statData.lastChattedAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric'}) 
                : 'ì•Œ ìˆ˜ ì—†ìŒ';
            const sessionCount = statData.count || 0;
            const assessment = statData.overallAssessment || `ì´ ì£¼ì œë¡œ ${sessionCount}ë²ˆ ì´ì•¼ê¸°í–ˆì–´ìš”.`;
            
            // ë¶„ì„ ë°°ë„ˆ ìƒì„± (ì˜ˆì‹œ: ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í…ìŠ¤íŠ¸ë¡œë§Œ)
            // ì‹¤ì œë¡œëŠ” statDataì— overallSentiment ê°™ì€ í•„ë“œê°€ ìˆì–´ì•¼ í•¨
            let analysisBannerHTML = '';
            if (statData.sentimentExample) { // ì˜ˆì‹œë¡œ sentimentExample í•„ë“œ ì‚¬ìš©
                 let bannerClass = 'neutral';
                 if (statData.sentimentExample === 'positive') bannerClass = 'positive';
                 else if (statData.sentimentExample === 'negative') bannerClass = 'negative';
                 analysisBannerHTML = `<div class="journal-analysis-banner ${bannerClass}">ë¡œì§€ ìƒê°: ${statData.sentimentExample} ëŠë‚Œì˜ ëŒ€í™”ì˜€ì–´ìš”.</div>`;
            }


            card.innerHTML = `
                <div class="topic-main-title">${mainTitle}</div>
                <div class="topic-sub-title">${subTitle}</div>
                <div class="topic-meta-info">
                    <span class="meta-item">ìµœê·¼ ì´ì•¼ê¸°: ${lastChattedDate}</span>
                    <span class="meta-item">ì´ ì´ì•¼ê¸°: ${sessionCount}íšŒ</span>
                </div>
                <p class="journal-summary-preview">${assessment}</p> ${analysisBannerHTML}
                <a href="journal.html?topic=${encodeURIComponent(topicName)}" class="view-sessions-button">${sessionCount}ê°œì˜ ì´ì•¼ê¸° ìì„¸íˆ ë³´ê¸°</a>
            `;
            return card;
        }


        // --- ìì£¼ ì‚¬ìš©ëœ íƒœê·¸ ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜ (ìˆ˜ì •) ---
        function displayMainTags(journalsForTagExtraction) { // journals ë°°ì—´ì„ ì¸ìë¡œ ë°›ìŒ
            if (!mainTagButtonsEl) return;
            mainTagButtonsEl.innerHTML = ''; 

            const tagCounts = {};
            journalsForTagExtraction.forEach(journal => {
                if (journal.keywords && Array.isArray(journal.keywords)) {
                    journal.keywords.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });

            const sortedTags = Object.entries(tagCounts)
                .sort(([,a],[,b]) => b-a)
                .slice(0, 5) 
                .map(([tag]) => tag);

            const allViewBtn = document.createElement('button');
            allViewBtn.className = 'tag-filter-btn active'; 
            allViewBtn.textContent = 'âœ¨ ì „ì²´ ì´ì•¼ê¸°';
            allViewBtn.dataset.tag = 'ì „ì²´ë³´ê¸°'; 
            allViewBtn.onclick = () => {
                currentFilterTag = 'ì „ì²´ë³´ê¸°';
                renderFilteredTopicCards(); 
                updateTagButtonStates();
            };
            mainTagButtonsEl.appendChild(allViewBtn);

            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                button.className = 'tag-filter-btn';
                button.textContent = `#${tag}`;
                button.dataset.tag = tag;
                button.onclick = () => {
                    currentFilterTag = tag;
                    renderFilteredTopicCards();
                    updateTagButtonStates();
                };
                mainTagButtonsEl.appendChild(button);
            });
        }

        function updateTagButtonStates() { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        
        // --- í•„í„°ë§ëœ ì£¼ì œ ìš”ì•½ ì¹´ë“œë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ ---
        function renderFilteredTopicCards() {
            if (!topicCardListEl) return;
            topicCardListEl.innerHTML = ''; 

            // allUserTopicStatsëŠ” { "ì£¼ì œëª…": {count, lastChattedAt, ... , keywords:[]}, ... } í˜•íƒœë¼ê³  ê°€ì •
            const topicsToDisplay = currentFilterTag && currentFilterTag !== 'ì „ì²´ë³´ê¸°'
                ? allUserTopicStats.filter(stat => stat.keywords && stat.keywords.includes(currentFilterTag))
                : allUserTopicStats;

            if (topicsToDisplay.length === 0) {
                topicCardListEl.innerHTML = currentFilterTag && currentFilterTag !== 'ì „ì²´ë³´ê¸°'
                    ? `<p>'#${currentFilterTag}' íƒœê·¸ê°€ í¬í•¨ëœ ì£¼ì œì˜ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”. ğŸ§</p>`
                    : '<p>ì•„ì§ ë¡œì§€ë‘ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì—†ëŠ” ê²ƒ ê°™ì•„ìš”. ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸ˜Š</p>';
                return;
            }
            
            // allUserTopicStatsëŠ” ì´ë¯¸ lastChattedAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆë‹¤ê³  ê°€ì • (loadInitialPageDataì—ì„œ ì²˜ë¦¬)
            topicsToDisplay.forEach(topicStatData => {
                // topicStatData.id ê°€ ì£¼ì œëª…ì´ë¼ê³  ê°€ì • (Firestoreì—ì„œ doc.idë¥¼ ì£¼ì œëª…ìœ¼ë¡œ ì‚¬ìš©)
                const card = createTopicSummaryCard(topicStatData.id, topicStatData); 
                topicCardListEl.appendChild(card);
            });
        }

        // --- Firestoreì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ìˆ˜ì •) ---
        async function loadInitialPageData() {
            const userId = localStorage.getItem('cbtUserEmail');
            if (!userId) {
                if(topicCardListEl) topicCardListEl.innerHTML = '<p>ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œì§€ì™€ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”!</p>';
                if(mainTagButtonsEl) mainTagButtonsEl.innerHTML = '';
                console.log("ì‚¬ìš©ì ID ì—†ìŒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                displaySampleJournalTopicCards(); // ì‚¬ìš©ì ID ì—†ì„ ë•Œ ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ
                return;
            }

            try {
                // 1. ì‚¬ìš©ìì˜ ëª¨ë“  topicStatsë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ (lastChattedAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬).
                // users/{userId}/topicStats/{ì£¼ì œëª…} ë¬¸ì„œë“¤
                const statsQuery = query(collection(db, `users/${userId}/topicStats`), orderBy('lastChattedAt', 'desc'));
                const statsSnapshot = await getDocs(statsQuery);

                if (statsSnapshot.empty) { // Firestoreì— topicStats ë°ì´í„°ê°€ ì—†ì„ ë•Œ
                    console.log("Firestoreì— topicStats ë°ì´í„° ì—†ìŒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                    if(mainTagButtonsEl) mainTagButtonsEl.innerHTML = '<p>ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©´ ìì£¼ ë‚˜ì˜¨ ë§ˆìŒ ì¡°ê°ë“¤ì„ ì—¬ê¸°ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>';
                    displaySampleJournalTopicCards(); // ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
                    return;
                }
                
                // ì‹¤ì œ topicStats ë°ì´í„°ê°€ ìˆì„ ê²½ìš°
                allUserTopicStats = statsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // íƒœê·¸ ì¶”ì¶œì„ ìœ„í•´ journals ë°ì´í„°ë„ ì¼ë¶€ ê°€ì ¸ì˜¤ê±°ë‚˜, topicStatsì— keywords ìš”ì•½ ì €ì¥ í•„ìš”
                // ì—¬ê¸°ì„œëŠ” topicStatsì— keywordsê°€ ìš”ì•½ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ê³ , ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
                allUserTopicStats.forEach(stat => {
                    if (!stat.keywords) stat.keywords = []; 
                });
                
                displayMainTags(allUserTopicStats); // topicStatsì— ìˆëŠ” keywordsë¡œ íƒœê·¸ ë²„íŠ¼ í‘œì‹œ
                currentFilterTag = 'ì „ì²´ë³´ê¸°'; 
                renderFilteredTopicCards(); 

            } catch (error) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(topicCardListEl) topicCardListEl.innerHTML = '<p>ì´ì•¼ê¸° ëª¨ìŒì§‘ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜­ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                console.log("ì˜¤ë¥˜ ë°œìƒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                displaySampleJournalTopicCards(); // ì˜¤ë¥˜ ì‹œì—ë„ ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ
            }
        }
                
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialPageData(); 
        });
    </script>
</body>
</html>