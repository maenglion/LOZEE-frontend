<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‚˜ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* journal-list.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px; 
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .page-title {
            color: var(--primary-color);
            text-align: center;
            font-size: 2em; 
            margin-bottom: 30px; 
            font-weight: 700;
        }

        .main-tags-area {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .main-tags-area h2 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: none;
        }

        .tag-button-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .tag-filter-btn {
            padding: 8px 15px;
            background-color: #e8eaf6;
            color: #3f51b5;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }

        .tag-filter-btn:hover {
            background-color: #c5cae9;
            transform: translateY(-1px);
        }

        .tag-filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .card-list {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .journal-card {
            background-color: var(--card-bg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-sizing: border-box;
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .journal-topic {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .journal-emotion {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 12px;
            font-style: italic;
        }

        .journal-summary-preview {
            font-size: 0.95em;
            color: #444;
            margin-bottom: 12px;
            flex-grow: 1; 
            /* ì—¬ëŸ¬ ì¤„ ë§ì¤„ì„ (í•„ìš”ì‹œ) */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* ë³´ì—¬ì¤„ ì¤„ ìˆ˜ */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.85em; /* 0.95em * 1.6 * 2ì¤„ (ëŒ€ëµì ì¸ ë†’ì´) */
        }

        .journal-session-info { /* ë‚ ì§œì™€ íšŸìˆ˜ë¥¼ ë¬¶ëŠ” div */
            font-size: 0.8em;
            color: #777;
            text-align: right;
            margin-top: auto; 
        }
        .journal-date, .journal-session-count {
             display: block; /* ê° ì •ë³´ë¥¼ ë‹¤ë¥¸ ì¤„ì— í‘œì‹œ */
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 1em;
            margin-top: 30px;
        }

        .pagination a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .pagination a:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        .pagination .current {
            color: var(--text-color);
            background-color: #e0e0e0;
        }

        @media (min-width: 1024px) { 
            .card-list { grid-template-columns: repeat(3, 1fr); }
        }
        @media (min-width: 601px) and (max-width: 1023px) { 
            .card-list { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) { 
            .card-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <h1 id="pageMainTitle" class="page-title">ë‚˜ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–</h1>

        <div class="main-tags-area">
            <h2>âœ¨ ë‚˜ì˜ ì£¼ìš” ì´ì•¼ê¸° ì¡°ê°ë“¤ âœ¨</h2>
            <div id="mainTagButtons" class="tag-button-list">
                </div>
        </div>

        <div class="card-list" id="journalCardList">
            </div>

        <div class="pagination" style="display:none;"> 
            <a href="#">ã€ˆ</a>
            <a href="#" class="current">1</a>
            <a href="#">2</a>
            <a href="#">3</a>
            <a href="#">ã€‰</a>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        // counseling_topics.jsëŠ” ì´ í˜ì´ì§€ì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ import ì œì™¸ ê°€ëŠ¥

        const journalCardListEl = document.getElementById('journalCardList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const mainTagButtonsEl = document.getElementById('mainTagButtons');

        const userName = localStorage.getItem('lozee_username') || 'ë‚˜';
        if (pageMainTitleEl) {
            pageMainTitleEl.textContent = `${userName}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–`;
        }

        let allUserJournals = []; 
        let userTopicStats = {}; // ì£¼ì œë³„ í†µê³„ (íšŸìˆ˜, ë§ˆì§€ë§‰ ëŒ€í™”ì¼)
        let currentFilterTag = 'ì „ì²´ë³´ê¸°';

        function displayMainTags(journals) {
            if (!mainTagButtonsEl) return;
            mainTagButtonsEl.innerHTML = ''; 

            const tagCounts = {};
            journals.forEach(journal => {
                if (journal.keywords && Array.isArray(journal.keywords)) {
                    journal.keywords.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });

            const sortedTags = Object.entries(tagCounts)
                .sort(([,a],[,b]) => b-a)
                .slice(0, 5) 
                .map(([tag]) => tag);

            const allViewBtn = document.createElement('button');
            allViewBtn.className = 'tag-filter-btn active'; // ì´ˆê¸°ì—” ì „ì²´ë³´ê¸°ê°€ í™œì„±
            allViewBtn.textContent = 'âœ¨ ì „ì²´ ì´ì•¼ê¸°';
            allViewBtn.dataset.tag = 'ì „ì²´ë³´ê¸°'; 
            allViewBtn.onclick = () => {
                currentFilterTag = 'ì „ì²´ë³´ê¸°';
                renderJournalCards(); // renderJournalCards í˜¸ì¶œ
                updateTagButtonStates();
            };
            mainTagButtonsEl.appendChild(allViewBtn);

            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                button.className = 'tag-filter-btn';
                button.textContent = `#${tag}`;
                button.dataset.tag = tag;
                button.onclick = () => {
                    currentFilterTag = tag;
                    renderJournalCards(); // renderJournalCards í˜¸ì¶œ
                    updateTagButtonStates();
                };
                mainTagButtonsEl.appendChild(button);
            });
        }

        function updateTagButtonStates() {
            if (!mainTagButtonsEl) return;
            const buttons = mainTagButtonsEl.querySelectorAll('.tag-filter-btn');
            buttons.forEach(btn => {
                if (btn.dataset.tag === currentFilterTag) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // ì €ë„ ì¹´ë“œë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ (ì£¼ì œë³„ ìš”ì•½ ë° ìµœì‹ ìˆœ ì •ë ¬ ë°˜ì˜)
        function renderJournalCards() {
            if (!journalCardListEl) return;
            journalCardListEl.innerHTML = ''; 

            const filteredByTag = currentFilterTag && currentFilterTag !== 'ì „ì²´ë³´ê¸°'
                ? allUserJournals.filter(journal => journal.keywords && journal.keywords.includes(currentFilterTag))
                : allUserJournals;

            if (filteredByTag.length === 0) {
                journalCardListEl.innerHTML = currentFilterTag && currentFilterTag !== 'ì „ì²´ë³´ê¸°'
                    ? `<p>'#${currentFilterTag}' íƒœê·¸ê°€ í¬í•¨ëœ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”. ğŸ§</p>`
                    : '<p>ì•„ì§ ê¸°ë¡ëœ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”. ë¡œì§€ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ˜Š</p>';
                return;
            }

            // ì£¼ì œë³„ë¡œ ê·¸ë£¹í™” (ìš”ì²­í•˜ì‹  "ê·¸ ì£¼ì œë¡œ ì—¬ëŸ¬ ë²ˆ ëŒ€í™”í–ˆìœ¼ë©´ ë§ˆì§€ë§‰ SERVER_TIMESTAMP ê¸°ì¤€ìœ¼ë¡œ")
            const topicsMap = new Map();
            filteredByTag.forEach(journal => {
                const topicKey = journal.topic || 'ê¸°íƒ€ ì´ì•¼ê¸°';
                if (!topicsMap.has(topicKey) || journal.createdAt.toMillis() > topicsMap.get(topicKey).latestTimestamp) {
                    topicsMap.set(topicKey, {
                        latestJournal: journal,
                        latestTimestamp: journal.createdAt.toMillis(),
                        count: (userTopicStats[topicKey] ? userTopicStats[topicKey].count : 1), // DBì—ì„œ ê°€ì ¸ì˜¨ íšŸìˆ˜ ì‚¬ìš©
                        emotions: new Set(), // í•„ìš”ì‹œ í™œìš©
                        keywordsSummary: new Set() // í•„ìš”ì‹œ í™œìš©
                    });
                }
                // countëŠ” userTopicStatsì—ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ë” ì •í™•í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì§‘ê³„í•˜ì§€ ì•ŠìŒ.
                // ë§Œì•½ userTopicStatsê°€ ì—†ë‹¤ë©´, ì•„ë˜ì™€ ê°™ì´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„ì‹œë¡œ ì§‘ê³„í•  ìˆ˜ ìˆìŒ.
                // else {
                //    const existing = topicsMap.get(topicKey);
                //    existing.count = (existing.count || 0) +1; // ì´ ë°©ì‹ì€ ì •í™•í•œ íšŸìˆ˜ ë°˜ì˜ì´ ì•„ë‹˜.
                // }
                if (journal.mood) topicsMap.get(topicKey).emotions.add(journal.mood);
                if (journal.keywords) journal.keywords.forEach(kw => topicsMap.get(topicKey).keywordsSummary.add(kw));
            });

            const displayableTopics = Array.from(topicsMap.values())
                                         .sort((a,b) => b.latestTimestamp - a.latestTimestamp);

            displayableTopics.forEach(topicSummary => {
                const journal = topicSummary.latestJournal;
                const card = document.createElement('div');
                card.className = 'journal-card';
                
                const dateStr = journal.createdAt?.toDate ? journal.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : 'ë‚ ì§œ ì—†ìŒ';
                const topicDisplay = journal.topic || 'ë‚˜ëˆˆ ì´ì•¼ê¸°';
                const emotionDisplay = journal.mood || (journal.detailedAnalysis?.overallSentiment) || 'ê¸°ë¡ëœ ë§ˆìŒ'; 
                const summaryPreview = journal.summary ? journal.summary.substring(0, 40) + (journal.summary.length > 40 ? '...' : '') : 'ìš”ì•½ ì—†ìŒ';
                const sessionCount = topicSummary.count; // userTopicStatsì—ì„œ ê°€ì ¸ì˜¨ ê°’

                card.innerHTML = `
                    <div class="journal-topic">${topicDisplay}</div>
                    <div class="journal-emotion">ìµœê·¼ ë§ˆìŒ: ${emotionDisplay}</div>
                    <div class="journal-summary-preview">${summaryPreview}</div>
                    <div class="journal-session-info">
                        <span class="journal-date">ë§ˆì§€ë§‰ ì´ì•¼ê¸°: ${dateStr}</span>
                        <span class="journal-session-count">ì´ ì£¼ì œë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸°: ${sessionCount}ë²ˆ</span>
                    </div>
                `;
                // ì¹´ë“œ í´ë¦­ ì‹œ, í•´ë‹¹ ì£¼ì œì˜ ê°€ì¥ ìµœê·¼ ì €ë„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ë„ë¡ ìˆ˜ì •
                card.onclick = () => { 
                    // ìƒì„¸ í˜ì´ì§€ê°€ ìˆë‹¤ë©´ ID ì „ë‹¬, ì—†ë‹¤ë©´ alert ë“±
                    // location.href = `journal-detail.html?id=${journal.id}`; 
                    alert(`'${topicDisplay}' ì£¼ì œì˜ ê°€ì¥ ìµœê·¼ ëŒ€í™”ì…ë‹ˆë‹¤. (ìƒì„¸ë³´ê¸° ì¤€ë¹„ ì¤‘)`);
                };
                journalCardListEl.appendChild(card);
            });
        }

        async function loadInitialData() {
            const userId = localStorage.getItem('cbtUserEmail');
            if (!userId) {
                if(journalCardListEl) journalCardListEl.innerHTML = '<p>ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œì§€ì™€ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”!</p>';
                if(mainTagButtonsEl) mainTagButtonsEl.innerHTML = '';
                return;
            }

            try {
                // 1. ì£¼ì œë³„ í†µê³„ ë¡œë“œ (DBì— ì €ì¥ëœ íšŸìˆ˜ ë° ë§ˆì§€ë§‰ ëŒ€í™”ì¼)
                const statsQuery = query(collection(db, `users/${userId}/topicStats`));
                const statsSnapshot = await getDocs(statsQuery);
                statsSnapshot.forEach((doc) => {
                    userTopicStats[doc.id] = doc.data(); // { count: 5, lastChattedAt: Timestamp, ... }
                });

                // 2. ì „ì²´ ì €ë„ ë¡œë“œ (ìµœì‹ ìˆœ)
                const journalsQuery = query(collection(db, 'journals'), where('userId', '==', userId), orderBy('createdAt', 'desc'));
                const journalsSnapshot = await getDocs(journalsQuery);
                allUserJournals = journalsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (allUserJournals.length === 0) {
                    if(journalCardListEl) journalCardListEl.innerHTML = '<p>ì•„ì§ ê¸°ë¡ëœ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”. ë¡œì§€ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ˜Š</p>';
                    if(mainTagButtonsEl) mainTagButtonsEl.innerHTML = '<p>ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©´ ìì£¼ ë‚˜ì˜¨ ë§ˆìŒ ì¡°ê°ë“¤ì„ ì—¬ê¸°ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>';
                    return;
                }
                
                displayMainTags(allUserJournals); 
                currentFilterTag = 'ì „ì²´ë³´ê¸°'; 
                renderJournalCards(); // ì €ë„ ì¹´ë“œ ë Œë”ë§ (ë‚´ë¶€ì—ì„œ userTopicStats ì‚¬ìš©)

            } catch (error) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(journalCardListEl) journalCardListEl.innerHTML = '<p>ì´ì•¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜­</p>';
            }
        }
                
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData(); 
        });
    </script>
</body>
</html>