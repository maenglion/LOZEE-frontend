<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‚˜ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ - LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* journal-list.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb; /* talk.htmlê³¼ ì¼ê´€ì„± */
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8; /* analysis.htmlê³¼ ìœ ì‚¬í•œ ë°°ê²½ */
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px; /* gnb.cssì™€ ì¼ì¹˜í•´ì•¼ í•¨ */
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height); /* GNB ë†’ì´ë§Œí¼ íŒ¨ë”© (gnb.cssì— ì—†ë‹¤ë©´ í•„ìš”) */
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1100px; /* PCì—ì„œ ì¢€ ë” ë„“ê²Œ */
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .page-title { /* ê¸°ì¡´ h1 ìŠ¤íƒ€ì¼ ëŒ€ì²´ */
            color: var(--primary-color);
            text-align: center;
            font-size: 2em; 
            margin-bottom: 30px; 
            font-weight: 700;
        }

.main-tags-area {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center; /* ë‚´ë¶€ ìš”ì†Œë“¤ ê°€ìš´ë° ì •ë ¬ */
        }

        .main-tags-area h2 { /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: none; /* ê¸°ì¡´ h2 ë°‘ì¤„ ì œê±° */
        }

        .tag-button-list {
            display: flex;
            flex-wrap: wrap; /* íƒœê·¸ê°€ ë§ìœ¼ë©´ ë‹¤ìŒ ì¤„ë¡œ */
            justify-content: center; /* ë²„íŠ¼ë“¤ ê°€ìš´ë° ì •ë ¬ */
            gap: 10px;
        }

        .tag-filter-btn {
            padding: 8px 15px;
            background-color: #e8eaf6; /* íƒœê·¸ í´ë¼ìš°ë“œì˜ .badgeì™€ ìœ ì‚¬í•œ ìƒ‰ */
            color: #3f51b5;
            border: none;
            border-radius: 20px; /* ì¢€ ë” ë‘¥ê¸€ê²Œ */
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }

        .tag-filter-btn:hover {
            background-color: #c5cae9;
            transform: translateY(-1px);
        }

        .tag-filter-btn.active { /* í˜„ì¬ ì„ íƒëœ íƒœê·¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }



        .card-list {
            display: grid;
            /* grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); PCì—ì„œëŠ” ì—¬ëŸ¬ ì—´ */
            gap: 20px;
            margin-bottom: 30px;
        }

        .journal-card {
            background-color: var(--card-bg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-sizing: border-box;
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .journal-topic { /* ì£¼ì œ */
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .journal-emotion { /* ê°ì • */
            font-size: 0.9em;
            color: #555;
            margin-bottom: 12px;
            font-style: italic;
        }

        .journal-summary-preview { /* Journal ì‹œì‘ 40ê¸€ì */
            font-size: 0.95em;
            color: #444;
            margin-bottom: 12px;
            flex-grow: 1; /* ìš”ì•½ì´ ë‚¨ì€ ê³µê°„ì„ ì±„ìš°ë„ë¡ */
        }

        .journal-session-count { /* ê·¸ ì£¼ì œë¡œ ëŒ€í™”ë¥¼ í•œ íšŸìˆ˜ */
            font-size: 0.8em;
            color: #777;
            text-align: right;
            margin-top: auto; /* ì¹´ë“œ í•˜ë‹¨ì— ìœ„ì¹˜í•˜ë„ë¡ */
        }
        
        .journal-date { /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ í™œìš© ë˜ëŠ” ìˆ˜ì • */
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
        }


        .pagination { /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ í™œìš© */
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 1em; /* í¬ê¸° ì•½ê°„ ì¡°ì • */
            margin-top: 30px;
        }

        .pagination a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .pagination a:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        .pagination .current {
            color: var(--text-color);
            background-color: #e0e0e0;
        }

        /* ë°˜ì‘í˜• ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        @media (min-width: 1024px) { /* ë„“ì€ PC í™”ë©´: 3ì—´ */
            .card-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 601px) and (max-width: 1023px) { /* íƒœë¸”ë¦¿ ë° ì¤‘ê°„ PC í™”ë©´: 2ì—´ */
            .card-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) { /* ëª¨ë°”ì¼ í™”ë©´: 1ì—´ */
            .card-list {
                grid-template-columns: 1fr;
            }
            .search-filter-area input[type="text"],
            .search-filter-area input[type="date"],
            .search-filter-area select,
            .search-filter-area button {
                width: 100%; /* ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ í•„í„° ìš”ì†Œë“¤ ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
                margin-bottom: 10px;
            }
            .search-filter-area {
                flex-direction: column;
            }
        }

    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

       <main class="container">
        <h1 id="pageMainTitle" class="page-title">ë‚˜ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–</h1>

        <div class="main-tags-area">
            <h2>âœ¨ ë‚˜ì˜ ì£¼ìš” ì´ì•¼ê¸° ì¡°ê°ë“¤ âœ¨</h2>
            <div id="mainTagButtons" class="tag-button-list">
                </div>
        </div>

        <div class="card-list" id="journalCardList">
            </div>

        <div class="pagination" style="display:none;"> <a href="#">ã€ˆ</a>
            <a href="#" class="current">1</a>
            <a href="#">2</a>
            <a href="#">3</a>
            <a href="#">ã€‰</a>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        // Firebase ê´€ë ¨ import (firebase-config.jsì—ì„œ dbë¥¼ exportí•´ì•¼ í•¨)
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { counselingTopicsByAge } from './js/counseling_topics.js'; // ì£¼ì œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°

        const journalCardListEl = document.getElementById('journalCardList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const topicSearchEl = document.getElementById('topicSearch');
        const searchBtn = document.getElementById('searchBtn');

        // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì™€ì„œ ì œëª©ì— ë°˜ì˜
        const userName = localStorage.getItem('lozee_username') || 'ë‚˜';
        if (pageMainTitleEl) {
            pageMainTitleEl.textContent = `${userName}ì˜ ì´ì•¼ê¸° ëª¨ìŒì§‘ ğŸ“–`;
        }

        // ì£¼ì œ ê²€ìƒ‰ í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
        function populateTopicFilter() {
            if (!topicSearchEl) return;
            // counselingTopicsByAgeì—ì„œ ëª¨ë“  ì£¼ì œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ (ëª¨ë“  ì—°ë ¹ëŒ€ í†µí•© ë˜ëŠ” í˜„ì¬ ì‚¬ìš©ì ì—°ë ¹ëŒ€ë§Œ)
            // ì—¬ê¸°ì„œëŠ” ëª¨ë“  ì—°ë ¹ëŒ€ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ í•©ì³ì„œ ì¤‘ë³µ ì œê±°í•˜ì—¬ ì‚¬ìš©
            let allTopics = new Set();
            for (const ageGroup in counselingTopicsByAge) {
                Object.keys(counselingTopicsByAge[ageGroup]).forEach(topic => allTopics.add(topic));
            }
            allTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSearchEl.appendChild(option);
            });
        }

        // Firestoreì—ì„œ ì €ë„ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ì˜ˆì‹œ)
        async function loadJournals(filters = {}) {
            if (!journalCardListEl) return;
            journalCardListEl.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

            const userId = localStorage.getItem('cbtUserEmail'); // ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ìš©ì ì‹ë³„ì
            if (!userId) {
                journalCardListEl.innerHTML = '<p>ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let q = query(collection(db, 'journals'), where('userId', '==', userId), orderBy('createdAt', 'desc'));
            
            // í•„í„° ì ìš© (ì‹¤ì œ êµ¬í˜„ ì‹œ ë” ì •êµí•œ ì¿¼ë¦¬ í•„ìš”)
            if (filters.topic) {
                q = query(q, where('topic', '==', filters.topic));
            }
            if (filters.date) { // ë‚ ì§œ í•„í„°ëŠ” ë²”ìœ„ë¡œ êµ¬í˜„í•´ì•¼ í•  ìˆ˜ ìˆìŒ (ì˜ˆ: í•´ë‹¹ ë‚ ì§œì˜ ì‹œì‘~ë)
                // q = query(q, where('createdAt', '>=', startDate), where('createdAt', '<=', endDate));
                console.warn("ë‚ ì§œ í•„í„°ëŠ” ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
            if (filters.tag) { // íƒœê·¸ í•„í„°ëŠ” keywords ë°°ì—´ì— ëŒ€í•œ array-contains ì¿¼ë¦¬ ì‚¬ìš©
                // q = query(q, where('keywords', 'array-contains', filters.tag));
                console.warn("íƒœê·¸ í•„í„°ëŠ” ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    journalCardListEl.innerHTML = '<p>ì•„ì§ ê¸°ë¡ëœ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”. ë¡œì§€ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const journal = doc.data();
                    const card = document.createElement('div');
                    card.className = 'journal-card';
                    
                    // ì¹´ë“œ ë‚´ìš© êµ¬ì„± (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
                    const dateStr = journal.createdAt?.toDate ? journal.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : 'ë‚ ì§œ ì—†ìŒ';
                    const topic = journal.topic || 'ì•Œ ìˆ˜ ì—†ëŠ” ì£¼ì œ';
                    const emotion = journal.mood || (journal.detailedAnalysis?.overallSentiment) || 'ê°ì • ê¸°ë¡ ì—†ìŒ'; // mood ë˜ëŠ” sentiment ì‚¬ìš©
                    const summaryPreview = journal.summary ? journal.summary.substring(0, 40) + (journal.summary.length > 40 ? '...' : '') : 'ìš”ì•½ ì—†ìŒ';
                    const sessionCount = journal.sessionCount || 1; // DBì— ì´ í•„ë“œê°€ ìˆì–´ì•¼ í•¨ (ì˜ˆì‹œ)

                    card.innerHTML = `
                        <div class="journal-date">${dateStr}</div>
                        <div class="journal-topic">${topic}</div>
                        <div class="journal-emotion">ì£¼ìš” ê°ì •: ${emotion}</div>
                        <div class="journal-summary-preview">${summaryPreview}</div>
                        <div class="journal-session-count">ì´ ì£¼ì œ ëŒ€í™” íšŸìˆ˜: ${sessionCount}íšŒ</div>
                    `;
                    // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ì €ë„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                    // card.onclick = () => { location.href = `journal-detail.html?id=${doc.id}`; };
                    journalCardListEl.appendChild(card);
                });
            } catch (error) {
                console.error("ì €ë„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                journalCardListEl.innerHTML = '<p>ì´ì•¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.</p>';
            }
        }
        
        // ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (searchBtn) {
            searchBtn.onclick = () => {
                const filters = {
                    topic: document.getElementById('topicSearch').value,
                    date: document.getElementById('dateSearch').value,
                    tag: document.getElementById('tagSearch').value.trim()
                };
                // ë¹ˆ ê°’ í•„í„°ëŠ” ì œê±°
                for (const key in filters) {
                    if (!filters[key]) {
                        delete filters[key];
                    }
                }
                loadJournals(filters);
            };
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            populateTopicFilter(); // ì£¼ì œ í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
            loadJournals(); // ì´ˆê¸° ì €ë„ ëª©ë¡ ë¡œë“œ
        });
    </script>
     <script src="./js/gnb.js" defer></script>
</body>
</html>