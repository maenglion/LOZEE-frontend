<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">ì£¼ì œë³„ ì´ì•¼ê¸° ê¸°ë¡ - LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css">
    <style>
        /* journal.html ê³ ìœ  ìŠ¤íƒ€ì¼ (journal-list.htmlê³¼ ìœ ì‚¬í•œ ë¶€ë¶„ ë§ìŒ) */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
        }
        body { margin: 0; padding-top: var(--gnb-height); font-family: 'KoPub World Dotum', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        .page-header { text-align: center; margin-bottom: 20px; background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
        .topic-display-title { color: var(--primary-color); font-size: 1.8em; font-weight: 700; margin-top:0; margin-bottom: 5px;}
        .topic-stats-info { font-size: 0.9em; color: #555; margin-bottom: 0px; }
        .topic-stats-info span { margin: 0 8px; }

        .session-card-list { display: flex; flex-direction: column; gap: 20px; margin-top:30px;}
        .session-card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom:1px dashed #eee; padding-bottom:8px;}
        .session-date { font-size: 0.9em; color: #777; font-weight:bold;}
        .session-card h3 { font-size: 1.2em; color: var(--secondary-color); margin-top: 0; margin-bottom: 8px; }
        .session-summary { font-size: 0.95em; margin-bottom: 15px; white-space: pre-wrap; word-break:keep-all; max-height: 150px; overflow-y:auto; padding-right:5px;}
        .session-analysis-summary { background-color: #eef2f7; padding: 12px; border-radius: 6px; font-size: 0.9em; }
        .session-analysis-summary h4 { margin-top: 0; font-size: 1em; color: #333; margin-bottom:5px; }
        .session-analysis-summary p {margin:0; line-height:1.5;}
        
        .pagination { display: flex; justify-content: center; gap: 12px; font-size: 1em; margin-top: 30px; padding-bottom:20px;}
        .pagination a { text-decoration: none; color: var(--primary-color); font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .pagination a:hover { background-color: var(--secondary-color); color: white; }
        .pagination .current { color: var(--text-color); background-color: #e0e0e0; }
    </style>
</head>
<body>
    <nav id="gnb">
        </nav> 

    <main class="container">
        <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">ì´ 0íšŒ</span> | <span id="lastSessionDate">ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>

        <div class="session-card-list" id="sessionCardList">
            </div>

        <div class="pagination" id="paginationControls" style="display:none;">
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, limit, doc, getDoc, startAfter,getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js'; // getCountFromServer ì¶”ê°€

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        const paginationControlsEl = document.getElementById('paginationControls');
        const pageTabTitleEl = document.querySelector('title');

        const urlParams = new URLSearchParams(window.location.search);
        const currentDisplayTopic = decodeURIComponent(urlParams.get('topic') || ''); // ì£¼ì œëª… ë””ì½”ë”©
        const userId = localStorage.getItem('cbtUserEmail');

        const ITEMS_PER_PAGE = 5; // í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ íšŒì°¨ ìˆ˜
        let lastVisibleDoc = null; // í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ ë§ˆì§€ë§‰ ë¬¸ì„œ ì°¸ì¡°
        let currentPage = 1;
        let totalSessionDocs = 0;

        async function fetchTopicStats() {
            if (!userId || !currentDisplayTopic) return;
            try {
                // users/{userId}/topicStats/{topicName} ì—ì„œ í†µê³„ ê°€ì ¸ì˜¤ê¸°
                const topicStatRef = doc(db, `users/${userId}/topicStats`, currentDisplayTopic);
                const topicStatSnap = await getDoc(topicStatRef);
                if (topicStatSnap.exists()) {
                    const data = topicStatSnap.data();
                    totalSessionDocs = data.count || 0; // topicStatsì˜ countë¥¼ ì´ ë¬¸ì„œ ìˆ˜ë¡œ ì‚¬ìš©
                    if(totalSessionCountEl) totalSessionCountEl.textContent = `ì´ ${totalSessionDocs}íšŒ ì´ì•¼ê¸°`;
                    if(lastSessionDateEl && data.lastChattedAt?.toDate) {
                        lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ì´ì•¼ê¸°: ${data.lastChattedAt.toDate().toLocaleDateString('ko-KR')}`;
                    }
                } else { // topicStats ë¬¸ì„œê°€ ì—†ì„ ê²½ìš°, journals ì»¬ë ‰ì…˜ì—ì„œ ì§ì ‘ ì¹´ìš´íŠ¸ (ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ)
                    const countQuery = query(collection(db, 'journals'), where('userId', '==', userId), where('topic', '==', currentDisplayTopic));
                    const snapshot = await getCountFromServer(countQuery);
                    totalSessionDocs = snapshot.data().count;
                    if(totalSessionCountEl) totalSessionCountEl.textContent = `ì´ ${totalSessionDocs}íšŒ ì´ì•¼ê¸°`;
                    // ë§ˆì§€ë§‰ ëŒ€í™”ì¼ì€ ì²« í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œ ìˆ˜ ìˆìŒ
                }
            } catch (error) {
                console.error("ì£¼ì œ í†µê³„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
            }
        }
        
        async function loadSessionsForTopicPage(page = 1) {
            if (!userId || !currentDisplayTopic || !sessionCardListEl || !topicTitleDisplayEl) {
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° í•„ìš”í•œ ê°’ì´ ë¶€ì¡±í•´ìš”.</p>";
                return;
            }

            if(page === 1) { // ì²« í˜ì´ì§€ ë¡œë“œ ì‹œì—ë§Œ ì œëª© ì„¤ì • ë° ëª©ë¡ ë¹„ìš°ê¸°
                topicTitleDisplayEl.textContent = `"${currentDisplayTopic}" ì´ì•¼ê¸° ëª¨ìŒ`;
                if(pageTabTitleEl) pageTabTitleEl.textContent = `"${currentDisplayTopic}" ì´ì•¼ê¸° - LOZEE`;
                sessionCardListEl.innerHTML = '';
                lastVisibleDoc = null; // í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ ì´ˆê¸°í™”
            }
            
            try {
                let q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', userId),
                    where('topic', '==', currentDisplayTopic), 
                    orderBy('createdAt', 'desc'),
                    limit(ITEMS_PER_PAGE)
                );

                if (page > 1 && lastVisibleDoc) {
                    q = query(q, startAfter(lastVisibleDoc));
                }
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty && page === 1) { // ì²« í˜ì´ì§€ì¸ë° ë°ì´í„°ê°€ ì—†ì„ ë•Œ
                    sessionCardListEl.innerHTML = `<p>'${currentDisplayTopic}' ì£¼ì œë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”.</p>`;
                    if(paginationControlsEl) paginationControlsEl.style.display = 'none';
                    return;
                }
                if (querySnapshot.empty && page > 1) { // ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ì„ ë•Œ
                     console.log("ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                     // "ë” ë³´ê¸°" ë²„íŠ¼ ë¹„í™œì„±í™” ë“± ì²˜ë¦¬
                     const loadMoreBtn = document.getElementById('loadMoreBtn');
                     if (loadMoreBtn) loadMoreBtn.disabled = true;
                     return;
                }


                querySnapshot.forEach((docSnap, index) => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'session-card';

                    const dateStr = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : 'ë‚ ì§œ ì—†ìŒ';
                    // íšŒì°¨ë³„ ì œëª©: Firestoreì˜ title í•„ë“œ ì‚¬ìš©, ì—†ìœ¼ë©´ ìˆœë²ˆìœ¼ë¡œ
                    const sessionTitle = data.title || `${totalSessionDocs - ((page - 1) * ITEMS_PER_PAGE) - index}íšŒì°¨ ì´ì•¼ê¸°`; 
                    const summary = data.summary ? data.summary.substring(0, 800) : 'ìš”ì•½ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
                    
                    let lozeeAnalysisSummary = "ë¡œì§€ ë¶„ì„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.";
                    if (data.detailedAnalysis) {
                        const da = data.detailedAnalysis;
                        lozeeAnalysisSummary = "";
                        if(da.overallSentiment) lozeeAnalysisSummary += `ì´ë•Œ ë„ˆì˜ ë§ˆìŒì€ ì „ë°˜ì ìœ¼ë¡œ '${da.overallSentiment}' í–ˆë˜ ê²ƒ ê°™ì•„. `;
                        if(da.keywords && da.keywords.length > 0) lozeeAnalysisSummary += `ì´ì•¼ê¸° ì†ì—ì„œ '${da.keywords.slice(0,2).join(', ')}' ê°™ì€ ë‹¨ì–´ë“¤ì´ ëˆˆì— ë„ì—ˆì–´.`;
                        if (!lozeeAnalysisSummary) lozeeAnalysisSummary = "ë¡œì§€ê°€ ì—´ì‹¬íˆ ë¶„ì„í•˜ê³  ìˆì–´!";
                    }

                    card.innerHTML = `
                        <div class="session-header">
                            <span class="session-date">${dateStr}</span>
                        </div>
                        <h3>${sessionTitle}</h3>
                        <p class="session-summary">${summary}</p>
                        <div class="session-analysis-summary">
                            <h4>ë¡œì§€ ìƒê° ì—¿ë³´ê¸° ğŸ§</h4>
                            <p>${lozeeAnalysisSummary}</p>
                        </div>
                    `;
                    card.onclick = () => {
                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            results: data.detailedAnalysis || {}, 
                            accumulatedDurationMinutes: data.sessionDurationMinutes || 0, 
                            journalId: docSnap.id // í˜„ì¬ ë³´ê³  ìˆëŠ” ì €ë„ ID ì „ë‹¬
                        }));
                        window.location.href = `analysis.html?journalId=${docSnap.id}`;
                    };
                    sessionCardListEl.appendChild(card);
                });

                // í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ ë§ˆì§€ë§‰ ë¬¸ì„œ ì €ì¥
                if (querySnapshot.docs.length > 0) {
                    lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                }
                updatePaginationUI(page);

            } catch (error) {
                console.error(`'${currentDisplayTopic}' ì£¼ì œì˜ ì„¸ì…˜ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                sessionCardListEl.innerHTML = '<p>ì´ì•¼ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥</p>';
            }
        }
        
        function updatePaginationUI(currentPageNum) {
            if (!paginationControlsEl || totalSessionDocs <= ITEMS_PER_PAGE) {
                if(paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }
            if(paginationControlsEl) paginationControlsEl.style.display = 'flex';
            paginationControlsEl.innerHTML = ''; // ê¸°ì¡´ ë²„íŠ¼ ë¹„ìš°ê¸°

            // "ë” ë³´ê¸°" ë²„íŠ¼ìœ¼ë¡œ ê°„ì†Œí™” ë˜ëŠ” ì‹¤ì œ í˜ì´ì§€ ë²„íŠ¼ ìƒì„±
            if (currentPageNum * ITEMS_PER_PAGE < totalSessionDocs) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.textContent = 'ì´ì „ ì´ì•¼ê¸° ë” ë³´ê¸°';
                loadMoreBtn.className = 'action-button'; // CSS ìŠ¤íƒ€ì¼ ì ìš©
                loadMoreBtn.onclick = () => {
                    currentPage++;
                    loadSessionsForTopicPage(currentPage);
                };
                paginationControlsEl.appendChild(loadMoreBtn);
            }
        }

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Journal Detail Page: DOMContentLoaded");
            if (currentDisplayTopic && userId) {
                await fetchTopicStats(); // ì´ íšŸìˆ˜ ë“± ë¨¼ì € ë¡œë“œ
                await loadSessionsForTopicPage(1); // ì²« í˜ì´ì§€ ë¡œë“œ
            } else {
                if(topicTitleDisplayEl) topicTitleDisplayEl.textContent = "ì„ íƒëœ ì£¼ì œ ì—†ìŒ";
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>í‘œì‹œí•  ì£¼ì œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ì–´ìš”. 'ì´ì•¼ê¸° ëª¨ìŒì§‘'ì—ì„œ ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>";
            }
        });
    </script>
</body>
</html>