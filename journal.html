<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageSessionTitle">로지와의 이야기 상세보기 - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <link rel="stylesheet" href="analysis.css"> 
    <style>
        /* journal.html 고유 스타일 추가 (필요시) */
 
        :root {
            /* ... (journal.html용 변수들) ... */
            --gnb-height: 56px; /* gnb.css의 값과 일치 또는 gnb.css 변수 사용 */
        }
        body { 
            /* padding-top: var(--gnb-height); */ /* gnb.css에서 body 스타일을 관리한다면 이 줄은 주석 처리 또는 삭제 */
            /* font-family:'KoPub World Dotum', sans-serif; */ /* gnb.css에서 관리 시 주석 처리 */
            margin:0;
            background-color: #f4f6f8;
            /* ... (나머지 journal.html body 스타일) ... */
        }
        .session-summary-section {
            background-color: var(--card-bg-analysis, #ffffff);
            padding: 25px;
            margin-top: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .session-summary-section h2 {
            color: var(--primary-color-analysis, #6078ea);
            font-size: 1.5em;
            margin-top:0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .session-summary-content {
            white-space: pre-wrap; /* 줄바꿈 유지 */
            line-height: 1.7;
            font-size: 1em;
            color: #333;
        }
        .session-date-display {
            text-align: right;
            font-size: 0.9em;
            color: #777;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
   <nav id="gnb">
   <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">☰</button>
    <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a> 
          <a href="index.html">✨ 새로운 이야기 시작!</a> 
          <a href="analysis.html">📊 우리 이야기 분석</a> 
          <a href="journal-list.html">📖 이야기 모음집</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a> 
        </div>
    </nav> 

    <main class="container">
        <h1 id="journalPageTitle" style="text-align:center;">로지와의 소중한 이야기</h1>
        <p id="sessionDateDisplay" class="session-date-display">대화 날짜: 불러오는 중...</p>

        <div class="session-summary-section">
            <h2>✨ 로지가 기억하는 우리 이야기 ✨</h2>
            <p id="sessionSummaryContent" class="session-summary-content">요약 내용을 불러오는 중입니다...</p>
        </div>

        <div id="analysisSectionsContainer">
            <div class="section" id="languageAgeSection" style="display:none;"> 
                </div>

            <div class="section" id="emotionToneSection">
                </div>

            <div class="section" id="patternSection">
                </div>

            <div class="section" id="situationSection">
                </div>
             </div>
        
        <p class="footer-assistant-notice">본 분석은 로지 AI가 마음을 담아 준비했어요.</p>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        // Firestore 및 Chart.js 관련 import 및 초기화 (analysis.html과 유사)
        import { db } from './js/firebase-config.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        // Chart.js는 전역으로 로드되었으므로 import 필요 없음

        // 전역 Chart 객체 기본값 설정 (analysis.html과 동일하게)
        if (typeof Chart !== 'undefined' && Chart) {
            Chart.defaults.color = '#333'; 
            Chart.defaults.borderColor = '#e0e0e0'; 
            Chart.defaults.font.family = "'KoPub World Dotum', sans-serif"; 
            Chart.defaults.font.size = 12; 
            console.log("Journal Detail: Chart.js(UMD) 인식 및 기본값 설정됨.");
        } else {
            console.error("Journal Detail: Chart.js(UMD)를 찾을 수 없습니다.");
        }


        // DOM 요소 가져오기
        const pageTabTitleEl = document.getElementById('pageSessionTitle');
        const journalPageTitleEl = document.getElementById('journalPageTitle');
        const sessionDateDisplayEl = document.getElementById('sessionDateDisplay');
        const sessionSummaryContentEl = document.getElementById('sessionSummaryContent');
        const analysisSectionsContainerEl = document.getElementById('analysisSectionsContainer'); // 분석 섹션들 담는 컨테이너

        // analysis.html에서 사용하는 모든 분석 섹션 관련 DOM 요소들도 여기서 가져와야 함
        const languageAgeSection = document.getElementById('languageAgeSection');
        // ... (realAgeEl, predictedLangAgeEl, emotionChartEl, empathyMessageEl, tagCloudEl 등 모두 가져오기) ...

        async function loadJournalDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            const journalId = urlParams.get('journalId') || urlParams.get('sessionId'); // journal-list2.html에서 전달한 ID
            const userId = localStorage.getItem('cbtUserEmail');

            if (!journalId || !userId) {
                if(containerEl) containerEl.innerHTML = '<h1>정보를 불러올 수 없습니다.</h1><p>올바른 경로로 접근했는지 확인해주세요.</p>';
                return;
            }

            try {
                const journalRef = doc(db, 'journals', journalId);
                const journalSnap = await getDoc(journalRef);

                if (journalSnap.exists()) {
                    const journalData = journalSnap.data();

                    if(pageTabTitleEl) pageTabTitleEl.textContent = `${journalData.title || '이야기'} 상세보기 - LOZEE`;
                    if(journalPageTitleEl) journalPageTitleEl.textContent = journalData.title || '로지와의 소중한 이야기';
                    if(sessionDateDisplayEl && journalData.createdAt?.toDate) {
                        sessionDateDisplayEl.textContent = `대화 날짜: ${journalData.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'})}`;
                    }
                    if(sessionSummaryContentEl) sessionSummaryContentEl.textContent = journalData.summary || '요약된 내용이 없습니다.';

                    // --- 이제 analysisResults 객체를 구성하여 analysis.html의 렌더링 함수들 호출 ---
                    const analysisResultsForPage = journalData.detailedAnalysis || {};
                    const userAgeForPage = parseInt(localStorage.getItem('lozee_userage'), 10) || 0; // 필요시 실제 사용자 나이
                    
                    // localStorage에 임시로 저장하여 analysis.html의 로직 재활용 (또는 직접 렌더링)
                    // 여기서는 analysis.html의 렌더링 함수들을 이 페이지에서 직접 호출한다고 가정
                    // (해당 함수들이 이 스크립트 내에 정의되어 있거나, import 되어야 함)

                    // 1. 언어·나이 분석 렌더링 (analysis.html의 로직과 유사하게)
                    if (languageAgeSection) {
                        // userAgeForPage와 analysisResultsForPage.ageLanguageAnalysis를 사용하여 표시
                        // (analysis.html의 언어 연령 표시 로직을 여기에 적용)
                        languageAgeSection.style.display = 'block'; // 예시로 일단 보이게
                        // ... 상세 렌더링 로직 ...
                    }

                    // 2. 감정 어조 차트 및 공감 메시지 (analysis.html의 로직과 유사하게)
                    if (typeof Chart !== 'undefined' && analysisResultsForPage.emotionToneData) {
                        // renderEmotionChart('emotionChart', analysisResultsForPage.emotionToneData);
                        // displayEmpathyMessage(analysisResultsForPage.emotionToneData);
                        // 임시: 차트 영역에 데이터 있음을 알림
                        const emotionChartContainer = document.getElementById('emotionChartContainer');
                        if (emotionChartContainer) emotionChartContainer.innerHTML = `<p style="text-align:center;color:#555;">감정 분석 데이터가 있어요! (차트 구현 필요)</p>`;

                    } else { /* 감정 데이터 없음 처리 */ }
                    
                    // ... (태그 클라우드, 반복 패턴, 상황 분석 등도 유사하게 analysisResultsForPage를 사용하여 렌더링) ...
                    // alertCognitiveDistortions('situationAlerts', analysisResultsForPage.cognitiveDistortions);
                    // 등등

                } else {
                    if(containerEl) containerEl.innerHTML = '<h1>해당 이야기 기록을 찾을 수 없어요. 😥</h1>';
                }
            } catch (error) {
                console.error("저널 상세 정보 로드 중 오류:", error);
                if(containerEl) containerEl.innerHTML = '<h1>이야기를 불러오는 데 문제가 생겼어요. 😥</h1>';
            }
        }

        // analysis.html에서 가져온 렌더링 함수들 (renderTagCloud, renderPatternDashboard 등)
        // function renderTagCloud(elementId, tags) { /* ... */ }
        // function renderEmotionChart(canvasId, emotionData) { /* ... new Chart(...) ... */ }
        // function displayEmpathyMessage(emotionData) { /* ... */ }
        // function alertCognitiveDistortions(elementId, distortions) { /* ... */ }
        // function getKoreanVocativeParticle(name) { /* ... */ }


        document.addEventListener('DOMContentLoaded', () => {
            console.log("Journal Detail Page (journal.html): DOMContentLoaded");
            loadJournalDetail();
        });
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>