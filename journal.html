<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">주제별 이야기 기록 - LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css">
    <style>
        /* journal.html 고유 스타일 (journal-list.html과 유사한 부분 많음) */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
        }
        body { margin: 0; padding-top: var(--gnb-height); font-family: 'KoPub World Dotum', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        .page-header { text-align: center; margin-bottom: 20px; background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
        .topic-display-title { color: var(--primary-color); font-size: 1.8em; font-weight: 700; margin-top:0; margin-bottom: 5px;}
        .topic-stats-info { font-size: 0.9em; color: #555; margin-bottom: 0px; }
        .topic-stats-info span { margin: 0 8px; }

        .session-card-list { display: flex; flex-direction: column; gap: 20px; margin-top:30px;}
        .session-card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom:1px dashed #eee; padding-bottom:8px;}
        .session-date { font-size: 0.9em; color: #777; font-weight:bold;}
        .session-card h3 { font-size: 1.2em; color: var(--secondary-color); margin-top: 0; margin-bottom: 8px; }
        .session-summary { font-size: 0.95em; margin-bottom: 15px; white-space: pre-wrap; word-break:keep-all; max-height: 150px; overflow-y:auto; padding-right:5px;}
        .session-analysis-summary { background-color: #eef2f7; padding: 12px; border-radius: 6px; font-size: 0.9em; }
        .session-analysis-summary h4 { margin-top: 0; font-size: 1em; color: #333; margin-bottom:5px; }
        .session-analysis-summary p {margin:0; line-height:1.5;}
        
        .pagination { display: flex; justify-content: center; gap: 12px; font-size: 1em; margin-top: 30px; padding-bottom:20px;}
        .pagination a { text-decoration: none; color: var(--primary-color); font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .pagination a:hover { background-color: var(--secondary-color); color: white; }
        .pagination .current { color: var(--text-color); background-color: #e0e0e0; }
    </style>
</head>
<body>
    <nav id="gnb">
        </nav> 

    <main class="container">
        <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">주제 불러오는 중...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">총 0회</span> | <span id="lastSessionDate">마지막 대화: 정보 없음</span>
            </div>
        </div>

        <div class="session-card-list" id="sessionCardList">
            </div>

        <div class="pagination" id="paginationControls" style="display:none;">
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, limit, doc, getDoc, startAfter,getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js'; // getCountFromServer 추가

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        const paginationControlsEl = document.getElementById('paginationControls');
        const pageTabTitleEl = document.querySelector('title');

        const urlParams = new URLSearchParams(window.location.search);
        const currentDisplayTopic = decodeURIComponent(urlParams.get('topic') || ''); // 주제명 디코딩
        const userId = localStorage.getItem('cbtUserEmail');

        const ITEMS_PER_PAGE = 5; // 페이지당 보여줄 회차 수
        let lastVisibleDoc = null; // 페이지네이션을 위한 마지막 문서 참조
        let currentPage = 1;
        let totalSessionDocs = 0;

        async function fetchTopicStats() {
            if (!userId || !currentDisplayTopic) return;
            try {
                // users/{userId}/topicStats/{topicName} 에서 통계 가져오기
                const topicStatRef = doc(db, `users/${userId}/topicStats`, currentDisplayTopic);
                const topicStatSnap = await getDoc(topicStatRef);
                if (topicStatSnap.exists()) {
                    const data = topicStatSnap.data();
                    totalSessionDocs = data.count || 0; // topicStats의 count를 총 문서 수로 사용
                    if(totalSessionCountEl) totalSessionCountEl.textContent = `총 ${totalSessionDocs}회 이야기`;
                    if(lastSessionDateEl && data.lastChattedAt?.toDate) {
                        lastSessionDateEl.textContent = `마지막 이야기: ${data.lastChattedAt.toDate().toLocaleDateString('ko-KR')}`;
                    }
                } else { // topicStats 문서가 없을 경우, journals 컬렉션에서 직접 카운트 (비효율적일 수 있음)
                    const countQuery = query(collection(db, 'journals'), where('userId', '==', userId), where('topic', '==', currentDisplayTopic));
                    const snapshot = await getCountFromServer(countQuery);
                    totalSessionDocs = snapshot.data().count;
                    if(totalSessionCountEl) totalSessionCountEl.textContent = `총 ${totalSessionDocs}회 이야기`;
                    // 마지막 대화일은 첫 페이지 로드 시 알 수 있음
                }
            } catch (error) {
                console.error("주제 통계 로드 중 오류:", error);
            }
        }
        
        async function loadSessionsForTopicPage(page = 1) {
            if (!userId || !currentDisplayTopic || !sessionCardListEl || !topicTitleDisplayEl) {
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>정보를 불러오는 데 필요한 값이 부족해요.</p>";
                return;
            }

            if(page === 1) { // 첫 페이지 로드 시에만 제목 설정 및 목록 비우기
                topicTitleDisplayEl.textContent = `"${currentDisplayTopic}" 이야기 모음`;
                if(pageTabTitleEl) pageTabTitleEl.textContent = `"${currentDisplayTopic}" 이야기 - LOZEE`;
                sessionCardListEl.innerHTML = '';
                lastVisibleDoc = null; // 페이지네이션 상태 초기화
            }
            
            try {
                let q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', userId),
                    where('topic', '==', currentDisplayTopic), 
                    orderBy('createdAt', 'desc'),
                    limit(ITEMS_PER_PAGE)
                );

                if (page > 1 && lastVisibleDoc) {
                    q = query(q, startAfter(lastVisibleDoc));
                }
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty && page === 1) { // 첫 페이지인데 데이터가 없을 때
                    sessionCardListEl.innerHTML = `<p>'${currentDisplayTopic}' 주제로 나눈 이야기가 아직 없어요.</p>`;
                    if(paginationControlsEl) paginationControlsEl.style.display = 'none';
                    return;
                }
                if (querySnapshot.empty && page > 1) { // 다음 페이지가 없을 때
                     console.log("더 이상 불러올 이야기가 없습니다.");
                     // "더 보기" 버튼 비활성화 등 처리
                     const loadMoreBtn = document.getElementById('loadMoreBtn');
                     if (loadMoreBtn) loadMoreBtn.disabled = true;
                     return;
                }


                querySnapshot.forEach((docSnap, index) => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'session-card';

                    const dateStr = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : '날짜 없음';
                    // 회차별 제목: Firestore의 title 필드 사용, 없으면 순번으로
                    const sessionTitle = data.title || `${totalSessionDocs - ((page - 1) * ITEMS_PER_PAGE) - index}회차 이야기`; 
                    const summary = data.summary ? data.summary.substring(0, 800) : '요약 내용이 없습니다.';
                    
                    let lozeeAnalysisSummary = "로지 분석을 기다리고 있어요.";
                    if (data.detailedAnalysis) {
                        const da = data.detailedAnalysis;
                        lozeeAnalysisSummary = "";
                        if(da.overallSentiment) lozeeAnalysisSummary += `이때 너의 마음은 전반적으로 '${da.overallSentiment}' 했던 것 같아. `;
                        if(da.keywords && da.keywords.length > 0) lozeeAnalysisSummary += `이야기 속에서 '${da.keywords.slice(0,2).join(', ')}' 같은 단어들이 눈에 띄었어.`;
                        if (!lozeeAnalysisSummary) lozeeAnalysisSummary = "로지가 열심히 분석하고 있어!";
                    }

                    card.innerHTML = `
                        <div class="session-header">
                            <span class="session-date">${dateStr}</span>
                        </div>
                        <h3>${sessionTitle}</h3>
                        <p class="session-summary">${summary}</p>
                        <div class="session-analysis-summary">
                            <h4>로지 생각 엿보기 🧐</h4>
                            <p>${lozeeAnalysisSummary}</p>
                        </div>
                    `;
                    card.onclick = () => {
                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            results: data.detailedAnalysis || {}, 
                            accumulatedDurationMinutes: data.sessionDurationMinutes || 0, 
                            journalId: docSnap.id // 현재 보고 있는 저널 ID 전달
                        }));
                        window.location.href = `analysis.html?journalId=${docSnap.id}`;
                    };
                    sessionCardListEl.appendChild(card);
                });

                // 페이지네이션을 위한 마지막 문서 저장
                if (querySnapshot.docs.length > 0) {
                    lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                }
                updatePaginationUI(page);

            } catch (error) {
                console.error(`'${currentDisplayTopic}' 주제의 세션 로드 중 오류:`, error);
                sessionCardListEl.innerHTML = '<p>이야기 기록을 불러오는 데 문제가 발생했어요. 😥</p>';
            }
        }
        
        function updatePaginationUI(currentPageNum) {
            if (!paginationControlsEl || totalSessionDocs <= ITEMS_PER_PAGE) {
                if(paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }
            if(paginationControlsEl) paginationControlsEl.style.display = 'flex';
            paginationControlsEl.innerHTML = ''; // 기존 버튼 비우기

            // "더 보기" 버튼으로 간소화 또는 실제 페이지 버튼 생성
            if (currentPageNum * ITEMS_PER_PAGE < totalSessionDocs) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.textContent = '이전 이야기 더 보기';
                loadMoreBtn.className = 'action-button'; // CSS 스타일 적용
                loadMoreBtn.onclick = () => {
                    currentPage++;
                    loadSessionsForTopicPage(currentPage);
                };
                paginationControlsEl.appendChild(loadMoreBtn);
            }
        }

        // --- 페이지 로드 시 실행 ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Journal Detail Page: DOMContentLoaded");
            if (currentDisplayTopic && userId) {
                await fetchTopicStats(); // 총 횟수 등 먼저 로드
                await loadSessionsForTopicPage(1); // 첫 페이지 로드
            } else {
                if(topicTitleDisplayEl) topicTitleDisplayEl.textContent = "선택된 주제 없음";
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>표시할 주제가 선택되지 않았어요. '이야기 모음집'에서 주제를 선택해주세요.</p>";
            }
        });
    </script>
</body>
</html>