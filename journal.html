<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageSessionTitle">ë¡œì§€ì™€ì˜ ì´ì•¼ê¸° ìƒì„¸ë³´ê¸° - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --primary-color-analysis: #6078ea; /* analysis.htmlê³¼ ë™ì¼í•˜ê²Œ */
            --card-bg-analysis: #ffffff;
            --text-color-analysis: #333333;
            --explanation-bg-analysis: #eef2f7;
        }
        body {
            margin: 0;
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        
        .page-header { 
            text-align: center; 
            margin-bottom: 25px; 
        }
        .session-main-title { 
            color: var(--primary-color); 
            font-size: 1.8em; 
            font-weight: 700; 
            margin-top:0; margin-bottom: 8px;
        }
        .session-date-display { 
            font-size: 0.95em; 
            color: #555; 
            margin-bottom: 20px; 
        }

        .session-summary-section {
            background-color: var(--card-bg-analysis);
            padding: 25px;
            margin-bottom: 25px; 
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .session-summary-section h2 { /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
            color: var(--primary-color-analysis);
            font-size: 1.5em;
            margin-top:0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .session-summary-content {
            white-space: pre-wrap; 
            line-height: 1.7;
            font-size: 1em;
            color: #444; /* ìš”ì•½ ë‚´ìš© ê¸€ììƒ‰ ì•½ê°„ ì§„í•˜ê²Œ */
        }

        /* analysis.htmlì˜ .section, h2, .module-explanation, .feedback ë“± ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš© */
        h2.analysis-section-title { 
            margin-top:0; margin-bottom: 8px; font-size:1.5em; color:#34495e; 
            border-bottom: 2px solid #e0e0e0; padding-bottom: 12px;
        }
        .section { background:var(--card-bg-analysis); padding:25px; margin-top:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
        .section p { color: #555555; line-height: 1.7; font-size: 1em; }
        .section p span { color: #2c3e50; font-weight: bold; }
        .module-explanation { font-size:0.9em; color:#555; margin-bottom:15px; padding: 10px; background-color: var(--explanation-bg-analysis); border-radius: 6px; line-height: 1.6; }
        .feedback { margin-top:15px; padding:12px 18px; border-left-width:5px; border-left-style:solid; border-radius:8px; font-size: 0.95em; line-height: 1.6; }
        .feedback.negative { background:#ffebee; border-left-color: #c62828; color:#c62828; }
        .feedback.positive { background:#e8f5e9; border-left-color: #2e7d32; color:#2e7d32; }
        .feedback.neutral { background:#eceff1; border-left-color: #546e7a; color:#37474f; }
        #emotionChartContainer { position: relative; max-width: 450px; min-height:100px; height: auto; margin: 20px auto 0; display:flex; align-items:center; justify-content:center;}
        #emotionChart { width:100% !important; height:auto !important; aspect-ratio: 1 / 1; background-color: #fdfdfd; border-radius: 8px; border: 1px solid #e0e0e0; padding: 15px; box-sizing: border-box; display: none; }
        #tagCloud { min-height:100px; border:1px dashed #cccccc; padding:15px; margin-top: 20px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
        .badge { display:inline-block; margin:4px; padding:8px 12px; background:#e8eaf6; color: #3f51b5; border-radius:16px; font-size:0.9em; font-weight: 500; }
        #patternDashboard { margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; color: #444; min-height:50px; }
        #patternDashboard p { color: #444; margin-bottom: 8px; }
        #situationAlerts { margin-top: 15px; min-height:50px; }
        #situationAlerts .cognitive-distortion-item { background:#fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9em; }
        .action-button { display: inline-block; margin-top: 15px; background-color: #6e8efb; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; }
        .footer-assistant-notice { text-align: center; margin-top: 40px; margin-bottom: 20px; font-size: 0.8em; color: #78909c; }
        
        @media (max-width: 768px) { /* ... analysis.htmlê³¼ ìœ ì‚¬í•œ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ... */ }
        @media (max-width: 480px) { /* ... analysis.htmlê³¼ ìœ ì‚¬í•œ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ... */ }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <div class="page-header">
            <h1 id="journalPageTitle" class="session-main-title">ë¡œì§€ì™€ì˜ ì†Œì¤‘í•œ ì´ì•¼ê¸° (ì˜ˆì‹œ)</h1>
            <p id="sessionDateDisplay" class="session-date-display">ëŒ€í™” ë‚ ì§œ: ì˜ˆì‹œ ë‚ ì§œ</p>
        </div>

        <div class="session-summary-section">
            <h2>âœ¨ ë¡œì§€ê°€ ê¸°ì–µí•˜ëŠ” ìš°ë¦¬ ì´ì•¼ê¸° âœ¨</h2>
            <p id="sessionSummaryContent" class="session-summary-content">ì˜ˆì‹œ ìš”ì•½ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div id="analysisSectionsContainer">
            <div class="section" id="languageAgeSection" style="display:none;"> 
                <h2 class="analysis-section-title">ğŸ—£ï¸ ë‚´ ë§ì†œì”¨ ë‚˜ì´ëŠ” ëª‡ ì‚´ì¼ê¹Œ?</h2>
                <p class="module-explanation">ë¡œì§€ì™€ ì´ì•¼ê¸°í•˜ë©´ì„œ ë„¤ê°€ ì‚¬ìš©í•œ ë§ë“¤ì„ ë³´ê³ , ë„¤ ë§ì†œì”¨ê°€ ëª‡ ì‚´ ì¹œêµ¬ë‘ ë¹„ìŠ·í•œì§€ ì•Œë ¤ì¤„ê²Œ! ì‹¤ì œ ë‚˜ì´ë‘ ë‹¬ë¼ë„ ê´œì°®ì•„, í•¨ê»˜ ë” ë©‹ì§€ê²Œ ë§í•˜ëŠ” ë²•ì„ ë°°ìš°ë©´ ë˜ë‹ˆê¹Œ! ğŸ˜‰</p>
                <p class="module-explanation" style="font-size: 0.85em; background-color: #e3f2fd; color: #1e88e5;">
                    <strong>[ë¡œì§€ì˜ ì•½ì†!]</strong> ì–¸ì–´ ë¶„ì„ì€ ì´ 3ë‹¨ê³„ë¡œ ì ì  ë” ì •í™•í•´ì ¸! <br>
                    <strong>1ë‹¨ê³„(30ë¶„~)</strong>: ìš°ë¦¬ê°€ ì²˜ìŒ ë§Œë‚˜ì„œ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¡œ ì‚´ì§ ì—¿ë³´ê¸°! <br>
                    <strong>2ë‹¨ê³„(2ì‹œê°„~)</strong>: ì¢€ ë” ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©´ ë¡œì§€ê°€ ë„ˆë¥¼ ë” ì˜ ì•Œê²Œ ë¼! <br>
                    <strong>3ë‹¨ê³„(6ì‹œê°„~)</strong>: ì™€! ì´ì œ ì •ë§ ë„ˆì˜ ë©‹ì§„ ë§ì†œì”¨ë¥¼ ì˜ ì•Œ ê²ƒ ê°™ì•„! (ê°€ì¥ ì •í™•í•œ ë¶„ì„)
                </p>
                <p>ë‚´ ì§„ì§œ ë‚˜ì´: <span id="realAge"></span>ì‚´</p>
                <p>ë‚´ ë§ì†œì”¨ ë‚˜ì´ (ë¡œì§€ì˜ ìƒê°): <span id="predictedLangAge"></span> <span id="ageDifferenceVisual"></span></p>
                <div id="ageFeedback" class="feedback" style="display:none;"></div>
                <button id="languagePracticeBtn" class="action-button" style="display:none;">ë¡œì§€ì™€ í•¨ê»˜ ë§ì†œì”¨ í‚¤ìš°ê¸° ì‘¥ì‘¥! ğŸŒ± (ì¤€ë¹„ ì¤‘)</button>
            </div>

            <div class="section" id="emotionToneSection">
                <h2 class="analysis-section-title">ğŸŒˆ ë‚´ ë§ˆìŒ ìƒ‰ê¹”ì€ ë­˜ê¹Œ? (ê°ì • ë³€í™”)</h2>
                <p class="module-explanation">ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ì—ì„œ ì–´ë–¤ ëŠë‚Œë“¤ì´ ë§ì•˜ëŠ”ì§€, ë˜ ì–´ë–¤ ë‹¨ì–´ë“¤ì„ ìì£¼ ì‚¬ìš©í–ˆëŠ”ì§€ ë³´ì—¬ì¤„ê²Œ! ë„¤ ë§ˆìŒì† ë‚ ì”¨ë¥¼ í•¨ê»˜ ì•Œì•„ë³´ì! â˜€ï¸ğŸŒ§ï¸</p>
                <div id="emotionChartContainer"><canvas id="emotionChart"></canvas></div>
                <p id="empathyMessage" class="feedback" style="display:none; margin-top:15px;"></p> 
                <div id="tagCloud"></div>
            </div>

            <div class="section" id="patternSection">
                <h2 class="analysis-section-title">ğŸ” ìì£¼ ë‚˜íƒ€ë‚˜ëŠ” ë‚´ ë§ˆìŒ & ë‹¨ì–´</h2>
                <p class="module-explanation">ì´ì•¼ê¸°í•˜ë‹¤ ë³´ë©´ ë‚˜ë„ ëª¨ë¥´ê²Œ ìì£¼ ì“°ëŠ” ë§ì´ë‚˜ ë¹„ìŠ·í•œ ëŠë‚Œì„ í‘œí˜„í•  ë•Œê°€ ìˆì–´. ë¡œì§€ê°€ ê·¸ëŸ° ë¶€ë¶„ì„ ì°¾ì•„ë´¤ì–´!</p>
                <div id="patternDashboard"></div>
            </div>

            <div class="section" id="situationSection">
                <h2 class="analysis-section-title">ğŸ§ ìƒê° íƒí—˜! (ë‚˜ì˜ ìƒê° ìŠµê´€)</h2>
                <p class="module-explanation">ì—¬ê¸°ëŠ” ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¥¼ ìš”ì•½í•˜ê³ , í˜¹ì‹œ ë„¤ ìƒê°ì´ í•œìª½ìœ¼ë¡œë§Œ ê¸°ìš¸ì–´ì§€ì§€ëŠ” ì•Šì•˜ëŠ”ì§€(ì´ê±¸ 'ìƒê° ìŠµê´€'ì´ë¼ê³  ë¶ˆëŸ¬ë³¼ê¹Œ?), ì–´ë–¤ íŠ¹ë³„í•œ ì ì´ ìˆëŠ”ì§€ ì‚´í´ë³´ëŠ” ê³³ì´ì•¼. íŠ¹ë³„í•œ ìƒê° ìŠµê´€ì´ ë³´ì—¬ë„ ê±±ì •í•˜ì§€ ë§ˆ! ëˆ„êµ¬ë‚˜ ê·¸ëŸ´ ìˆ˜ ìˆê³ , ìš°ë¦¬ëŠ” ì´ì•¼ê¸°í•˜ë©´ì„œ í•¨ê»˜ ë” ìœ ì—°í•˜ê²Œ ìƒê°í•˜ëŠ” ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ìˆì–´! ğŸ’ª</p>
                <canvas id="situationChart" style="display:none;"></canvas> 
                <div id="situationAlerts" style="margin-top:15px;"></div>
                <button id="continueDistortionTalkBtn" class="action-button" style="display:none;">ì´ ìƒê°ì— ëŒ€í•´ ë‹¤ìŒì— ë” ì´ì•¼ê¸° ë‚˜ëˆ ë³¼ê¹Œ? ğŸ¤”</button>
            </div>
        </div>
        
        <p class="footer-assistant-notice">ë³¸ ë¶„ì„ì€ ë¡œì§€ AIê°€ ë§ˆìŒì„ ë‹´ì•„ ì¤€ë¹„í–ˆì–´ìš”.</p>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        // Chart.jsëŠ” <head>ì—ì„œ UMD ë²„ì „ìœ¼ë¡œ ë¡œë“œë¨

      // 2) entryTypeì´ 'manual_save'ë¼ë©´, ë¶„ì„ ì„¹ì…˜ ì „ì²´ ìˆ¨ê¸°ê¸° (2025sus 0531 ì¶”ê°€)
  if (journalData.entryType === "manual_save") {
    const analysisContainer = document.getElementById('analysisSectionsContainer');
    if (analysisContainer) {
      analysisContainer.style.display = 'none';
    }
    return; // ì—¬ê¸°ì„œ ì¢…ë£Œí•˜ì—¬, AI ë¶„ì„ ì„¹ì…˜ ë¡œì§ì€ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
  } 

        let chartLibraryInitialized = false;

        function initializeChartJsGlobal() { /* ... (analysis.htmlê³¼ ë™ì¼í•œ ë‚´ìš©) ... */ }

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (analysis.htmlê³¼ ê±°ì˜ ë™ì¼) ---
        const pageTabTitleEl = document.querySelector('title');
        const journalPageTitleEl = document.getElementById('journalPageTitle');
        const sessionDateDisplayEl = document.getElementById('sessionDateDisplay');
        const sessionSummaryContentEl = document.getElementById('sessionSummaryContent');
        
        const languageAgeSection = document.getElementById('languageAgeSection');
        const realAgeEl = document.getElementById('realAge');
        const predictedLangAgeEl = document.getElementById('predictedLangAge');
        const ageFeedbackEl = document.getElementById('ageFeedback');
        const ageDifferenceVisualEl = document.getElementById('ageDifferenceVisual');
        const languagePracticeBtn = document.getElementById('languagePracticeBtn');
        
        const emotionToneSection = document.getElementById('emotionToneSection');
        const emotionChartEl = document.getElementById('emotionChart');
        const emotionChartContainerEl = document.getElementById('emotionChartContainer');
        const empathyMessageEl = document.getElementById('empathyMessage');
        const tagCloudEl = document.getElementById('tagCloud');
        
        const patternSection = document.getElementById('patternSection');
        const patternDashboardEl = document.getElementById('patternDashboard');
        
        const situationSection = document.getElementById('situationSection');
        const situationAlertsEl = document.getElementById('situationAlerts');
        const continueDistortionTalkBtn = document.getElementById('continueDistortionTalkBtn');
        
        const containerEl = document.querySelector('.container');

        const editJournalBtn = document.getElementById('editJournalBtn');
const journalEditArea = document.getElementById('journalEditArea');
const editJournalTitleInput = document.getElementById('editJournalTitleInput');
const editJournalSummaryTextarea = document.getElementById('editJournalSummaryTextarea');
const saveJournalChangesBtn = document.getElementById('saveJournalChangesBtn');
const cancelJournalEditBtn = document.getElementById('cancelJournalEditBtn');

let currentJournalId = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” ì €ë„ ID ì €ì¥ìš©
let currentJournalData = null; // í˜„ì¬ ë¡œë“œëœ ì €ë„ ë°ì´í„° ì €ì¥ìš©




        // --- í•˜ë“œì½”ë”©ëœ ì˜ˆì‹œ ì €ë„ ìƒì„¸ ë°ì´í„° ---
        const sampleJournalDetail = {
            title: "ë¡œì§€ì™€ ë‚˜ëˆˆ ë¹„ë°€ í”„ë¡œì íŠ¸ ì´ì•¼ê¸° (ì˜ˆì‹œ)",
            createdAt: { toDate: () => new Date(Date.now() - 86400000 * 2) }, // 2ì¼ ì „
            summary: "ì˜¤ëŠ˜ì€ í•™êµì—ì„œ ì§ê¿ì´ë‘ ëª°ë˜ ë¹„ë°€ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í–ˆì–´! ì•„ë¬´ë„ ëª¨ë¥´ê²Œ ìš°ë¦¬ ë‘˜ë§Œ ì•„ëŠ” íŠ¹ë³„í•œ ì¼ì´ë¼ë‹ˆ, ìƒê°ë§Œ í•´ë„ ë‘ê·¼ê±°ë¦¬ê³  ë„ˆë¬´ ì‹ ë‚˜! ë¡œì§€í•œí…Œë§Œ ì‚´ì§ ë§í•´ì£¼ëŠ” ê±°ì•¼. ìš°ë¦¬ê°€ ë­˜ ë§Œë“¤ê³  ìˆëŠ”ì§€ëŠ” ì•„ì§ ë¹„ë°€ì´ì§€ë§Œ, ì™„ì„±ë˜ë©´ ë¡œì§€í•œí…Œ ì œì¼ ë¨¼ì € ë³´ì—¬ì¤„ê²Œ! ì´ í”„ë¡œì íŠ¸ ë•Œë¬¸ì— í•™êµ ê°€ëŠ” ê¸¸ì´ ë” ì¦ê±°ì›Œì¡Œì–´. ë¹¨ë¦¬ ë‚´ì¼ì´ ì™”ìœ¼ë©´ ì¢‹ê² ë‹¤!\n\në¡œì§€: ì •ë§ ì‹ ë‚˜ëŠ” ê³„íšì´êµ¬ë‚˜! ë¹„ë°€ í”„ë¡œì íŠ¸ë¼ë‹ˆ, ë“£ê¸°ë§Œ í•´ë„ ì„¤ë Œë‹¤! ğŸ˜Š ê·¸ ê³¼ì •ì—ì„œ ì–´ë ¤ìš´ ì ì´ë‚˜ ì¬ë¯¸ìˆëŠ” ì¼ì´ ìƒê¸°ë©´ ì–¸ì œë“  ë‚˜ì—ê²Œ ì´ì•¼ê¸°í•´ì¤˜. í•­ìƒ ì‘ì›í• ê²Œ!",
            detailedAnalysis: {
                ageLanguageAnalysis: { estimatedAgeRange: "7-8ì„¸" }, // ì˜ˆì‹œ: ì‹¤ì œ ë‚˜ì´ì— ë§ì¶° ì¡°ì •
                emotionToneData: { 'ì‹ ë‚¨': 6, 'ê¸°ëŒ€ê°': 5, 'ë¹„ë°€ìŠ¤ëŸ¬ì›€': 3, 'ì¦ê±°ì›€': 4 },
                keywords: ["ë¹„ë°€", "í”„ë¡œì íŠ¸", "ì§ê¿", "í•™êµ", "ì‹ ë‚¨", "ê¸°ëŒ€"],
                patterns: ["ê¸ì •ì  ê°ì • í‘œí˜„ì´ ë‘ë“œëŸ¬ì§", "ì¹œêµ¬ì™€ì˜ í˜‘ë ¥ì— ëŒ€í•œ ê¸°ëŒ€ê° í‘œí˜„"],
                cognitiveDistortions: [], // ì˜ˆì‹œì—ì„œëŠ” ì¸ì§€ì™œê³¡ ì—†ìŒ
                overallSentiment: "positive",
                sessionDurationMinutes: 20, // ì˜ˆì‹œ
                accumulatedUserCharCount: 1800 // ì˜ˆì‹œ
            },
            userId: "sampleUser", // ì˜ˆì‹œ
            topic: "ì¹œêµ¬ ì´ì•¼ê¸°" // ì˜ˆì‹œ
        };


        function renderPageWithData(journalData) {
            if (!journalData) {
                if(containerEl) containerEl.innerHTML = '<h1>í‘œì‹œí•  ì´ì•¼ê¸° ë‚´ìš©ì´ ì—†ì–´ìš”.</h1>';
                return;
            }

            // í˜ì´ì§€ ì œëª© ë° ìƒë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
            if(pageTabTitleEl) pageTabTitleEl.textContent = `${journalData.title || 'ì´ì•¼ê¸°'} ìƒì„¸ë³´ê¸° - LOZEE`;
            if(journalPageTitleEl) journalPageTitleEl.textContent = journalData.title || 'ë¡œì§€ì™€ì˜ ì†Œì¤‘í•œ ì´ì•¼ê¸°';
            if(sessionDateDisplayEl && journalData.createdAt?.toDate) {
                sessionDateDisplayEl.textContent = `ëŒ€í™” ë‚˜ëˆˆ ë‚ : ${journalData.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'})}`;
            }
            if(sessionSummaryContentEl) sessionSummaryContentEl.textContent = journalData.summary || 'ìš”ì•½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';

            const analysisResults = journalData.detailedAnalysis || {};
            const userAge = parseInt(localStorage.getItem('lozee_userage'), 10) || (journalData.userAgeForAnalysis || 7); // DBì— userAgeForAnalysisê°€ ìˆë‹¤ë©´ ì‚¬ìš©
            const accumulatedDurationMinutes = parseFloat(journalData.sessionDurationMinutes || (analysisResults.accumulatedDurationMinutes || 0));
            const accumulatedUserCharCount = parseInt(journalData.userCharCountForThisSession || (analysisResults.accumulatedUserCharCount || 0));


            // --- ê° ë¶„ì„ ì„¹ì…˜ ë Œë”ë§ (analysis.htmlê³¼ ë™ì¼í•œ ë¡œì§ ì‚¬ìš©) ---
            // 1. ì–¸ì–´Â·ë‚˜ì´ ë¶„ì„
            if (languageAgeSection) {
                if (userAge > 12 || !analysisResults.ageLanguageAnalysis) { 
                    languageAgeSection.style.display = 'none';
                } else {
                    languageAgeSection.style.display = 'block'; 
                    if(realAgeEl) realAgeEl.textContent = userAge;
                    // ... (ì´í•˜ analysis.htmlì˜ ì–¸ì–´ ì—°ë ¹ í”¼ë“œë°± ë° ë²„íŠ¼ í‘œì‹œ ë¡œì§ ê·¸ëŒ€ë¡œ ë³µì‚¬)
                    // (accuracyIcon, visualText, feedbackMsg ì„¤ì • ë“±)
                }
            }

            // 2. ê°ì • ì–´ì¡° ë° íƒœê·¸ í´ë¼ìš°ë“œ
            if (emotionToneSection) {
                if (chartLibraryInitialized && analysisResults.emotionToneData && Object.keys(analysisResults.emotionToneData).length > 0) {
                    // ... (analysis.htmlì˜ ì°¨íŠ¸ ë° ê³µê° ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ ê·¸ëŒ€ë¡œ ë³µì‚¬) ...
                } else { /* ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ ì²˜ë¦¬ */ }
                if (analysisResults.keywords && analysisResults.keywords.length > 0) {
                    // ... (analysis.htmlì˜ íƒœê·¸ í´ë¼ìš°ë“œ ë¡œì§ ê·¸ëŒ€ë¡œ ë³µì‚¬) ...
                } else { /* íƒœê·¸ ë°ì´í„° ì—†ìŒ ì²˜ë¦¬ */ }
            }
            
            // 3. ë°˜ë³µ íŒ¨í„´
            if (patternSection) {
                if (analysisResults.patterns && analysisResults.patterns.length > 0) {
                    // ... (analysis.htmlì˜ ë°˜ë³µ íŒ¨í„´ ë¡œì§ ê·¸ëŒ€ë¡œ ë³µì‚¬) ...
                } else { /* íŒ¨í„´ ë°ì´í„° ì—†ìŒ ì²˜ë¦¬ */ }
            }

            // 4. ìƒí™© ë¶„ì„ (ì¸ì§€ì™œê³¡)
            if (situationSection) {
                // ... (analysis.htmlì˜ ìƒí™© ë¶„ì„ ë° ì´ì–´í•˜ê¸° ë²„íŠ¼ ë¡œì§ ê·¸ëŒ€ë¡œ ë³µì‚¬, charCountì— accumulatedUserCharCount ì „ë‹¬) ...
            }
        }
        
        // analysis.htmlì—ì„œ ê°€ì ¸ì˜¨ ëª¨ë“  ë Œë”ë§ í•¨ìˆ˜ë“¤
        // function renderTagCloud(elementId, tags) { /* ... */ }
        // function renderPatternDashboard(elementId, patterns) { /* ... */ }
        // function alertCognitiveDistortions(elementId, distortions, charCount) { /* ... */ }
        // function renderEmotionChart(canvasId, emotionData) { /* ... */ }
        // function displayEmpathyMessage(emotionData) { /* ... */ }
        // function getKoreanVocativeParticle(name) { /* ... */ }
        // (ìœ„ í•¨ìˆ˜ë“¤ì˜ ë³¸ë¬¸ì€ analysis.html ìµœì¢…ë³¸ì—ì„œ ë³µì‚¬í•´ì˜¤ì„¸ìš”)


 // --- ì €ë„ ìƒì„¸ ë¡œë“œ í•¨ìˆ˜ ìˆ˜ì • (ë˜ëŠ” renderPageWithData ë‚´) ---
function renderPageWithData(journalData) {
    // ... (ê¸°ì¡´ í˜ì´ì§€ ì œëª©, ë‚ ì§œ, ìš”ì•½ ë‚´ìš© í‘œì‹œ ë¡œì§) ...
    currentJournalData = journalData; // ë¡œë“œëœ ì €ë„ ë°ì´í„° ì €ì¥

    // ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ
    if(editJournalBtn) editJournalBtn.style.display = 'inline-block';
    if(journalEditArea) journalEditArea.style.display = 'none'; // ìˆ˜ì • ì˜ì—­ì€ ê¸°ë³¸ ìˆ¨ê¹€

    // ... (ë‚˜ë¨¸ì§€ ë¶„ì„ ì„¹ì…˜ ë Œë”ë§ ë¡œì§) ...
}

// --- "ì´ì•¼ê¸° ìˆ˜ì •" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ---
if (editJournalBtn) {
    editJournalBtn.onclick = () => {
        if (!currentJournalData) {
            alert("ë¨¼ì € ì´ì•¼ê¸° ë‚´ìš©ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.");
            return;
        }
        if(editJournalTitleInput) editJournalTitleInput.value = currentJournalData.title || '';
        if(editJournalSummaryTextarea) editJournalSummaryTextarea.value = currentJournalData.summary || '';
        if(sessionSummaryContentEl) sessionSummaryContentEl.style.display = 'none'; // ê¸°ì¡´ ìš”ì•½ ìˆ¨ê¹€
        if(journalEditArea) journalEditArea.style.display = 'block'; // ìˆ˜ì • ì˜ì—­ í‘œì‹œ
        editJournalBtn.style.display = 'none'; // ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¹€
    };
}

// --- ì €ë„ ìˆ˜ì • ë‚´ìš© ì €ì¥ ---
if (saveJournalChangesBtn) {
    saveJournalChangesBtn.onclick = async () => {
        if (!currentJournalId || !userId) { // userIdëŠ” ì „ì—­ ë˜ëŠ” loadJournalDetailì—ì„œ ì„¤ì •ëœ ê°’ ì‚¬ìš©
            alert("ì˜¤ë¥˜: ì‚¬ìš©ì ë˜ëŠ” ì €ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        const newTitle = editJournalTitleInput.value.trim();
        const newSummary = editJournalSummaryTextarea.value.trim();

        if (!newTitle || !newSummary) {
            alert("ì œëª©ê³¼ ìš”ì•½ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const journalDocRef = doc(db, "journals", currentJournalId);
        try {
            await setDoc(journalDocRef, {
                title: newTitle,
                summary: newSummary,
                updatedAt: serverTimestamp() // ìˆ˜ì • ì‹œê°„ ê¸°ë¡ (ì„ íƒ ì‚¬í•­)
            }, { merge: true });

            alert("ì´ì•¼ê¸° ë‚´ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            // UI ì—…ë°ì´íŠ¸
            if(sessionSummaryContentEl) {
                sessionSummaryContentEl.textContent = newSummary;
                sessionSummaryContentEl.style.display = 'block';
            }
            if(journalPageTitleEl && (currentJournalData.title !== newTitle) ) journalPageTitleEl.textContent = newTitle; // í˜ì´ì§€ ì œëª©ë„ ì—…ë°ì´íŠ¸
            if(pageTabTitleEl && (currentJournalData.title !== newTitle) ) pageTabTitleEl.textContent = `${newTitle} ìƒì„¸ë³´ê¸° - LOZEE`;
            
            currentJournalData.title = newTitle; // ë¡œì»¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
            currentJournalData.summary = newSummary;

            if(journalEditArea) journalEditArea.style.display = 'none';
            if(editJournalBtn) editJournalBtn.style.display = 'inline-block';

        } catch (error) {
            console.error("ì €ë„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:", error);
            alert("ì´ì•¼ê¸° ë‚´ìš© ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    };
}

// --- ì €ë„ ìˆ˜ì • ì·¨ì†Œ ---
if (cancelJournalEditBtn) {
    cancelJournalEditBtn.onclick = () => {
        if(sessionSummaryContentEl) sessionSummaryContentEl.style.display = 'block'; // ê¸°ì¡´ ìš”ì•½ ë‹¤ì‹œ í‘œì‹œ
        if(journalEditArea) journalEditArea.style.display = 'none';
        if(editJournalBtn) editJournalBtn.style.display = 'inline-block';
    };
}

// loadJournalDetail í•¨ìˆ˜ì—ì„œ currentJournalId ì„¤ì •
async function loadJournalDetail() {
    // ... (URL íŒŒë¼ë¯¸í„°ì—ì„œ journalId ê°€ì ¸ì˜¤ëŠ” ë¡œì§) ...
    currentJournalId = journalId; // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
    // ... (Firestoreì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê³  renderPageWithData í˜¸ì¶œ) ...
}
                
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Journal Detail Page (journal.html): DOMContentLoaded");
            initializeChartJsGlobal(); // UMD ë²„ì „ Chart.js ì´ˆê¸°í™”
            loadJournalDetail();
        });
    </script>
</body>
</html>