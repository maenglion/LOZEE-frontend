<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageSessionTitle">ë¡œì§€ì™€ì˜ ì´ì•¼ê¸° ìƒì„¸ë³´ê¸° - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <link rel="stylesheet" href="analysis.css"> 
    <style>
        /* journal.html ê³ ìœ  ìŠ¤íƒ€ì¼ ì¶”ê°€ (í•„ìš”ì‹œ) */
 
        :root {
            /* ... (journal.htmlìš© ë³€ìˆ˜ë“¤) ... */
            --gnb-height: 56px; /* gnb.cssì˜ ê°’ê³¼ ì¼ì¹˜ ë˜ëŠ” gnb.css ë³€ìˆ˜ ì‚¬ìš© */
        }
        body { 
            /* padding-top: var(--gnb-height); */ /* gnb.cssì—ì„œ body ìŠ¤íƒ€ì¼ì„ ê´€ë¦¬í•œë‹¤ë©´ ì´ ì¤„ì€ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì‚­ì œ */
            /* font-family:'KoPub World Dotum', sans-serif; */ /* gnb.cssì—ì„œ ê´€ë¦¬ ì‹œ ì£¼ì„ ì²˜ë¦¬ */
            margin:0;
            background-color: #f4f6f8;
            /* ... (ë‚˜ë¨¸ì§€ journal.html body ìŠ¤íƒ€ì¼) ... */
        }
        .session-summary-section {
            background-color: var(--card-bg-analysis, #ffffff);
            padding: 25px;
            margin-top: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .session-summary-section h2 {
            color: var(--primary-color-analysis, #6078ea);
            font-size: 1.5em;
            margin-top:0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .session-summary-content {
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
            line-height: 1.7;
            font-size: 1em;
            color: #333;
        }
        .session-date-display {
            text-align: right;
            font-size: 0.9em;
            color: #777;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
   <nav id="gnb">
   <div id="gnb-title">LOZEE</div>
    <button id="menu-toggle">â˜°</button>
    <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <h1 id="journalPageTitle" style="text-align:center;">ë¡œì§€ì™€ì˜ ì†Œì¤‘í•œ ì´ì•¼ê¸°</h1>
        <p id="sessionDateDisplay" class="session-date-display">ëŒ€í™” ë‚ ì§œ: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>

        <div class="session-summary-section">
            <h2>âœ¨ ë¡œì§€ê°€ ê¸°ì–µí•˜ëŠ” ìš°ë¦¬ ì´ì•¼ê¸° âœ¨</h2>
            <p id="sessionSummaryContent" class="session-summary-content">ìš”ì•½ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div id="analysisSectionsContainer">
            <div class="section" id="languageAgeSection" style="display:none;"> 
                </div>

            <div class="section" id="emotionToneSection">
                </div>

            <div class="section" id="patternSection">
                </div>

            <div class="section" id="situationSection">
                </div>
             </div>
        
        <p class="footer-assistant-notice">ë³¸ ë¶„ì„ì€ ë¡œì§€ AIê°€ ë§ˆìŒì„ ë‹´ì•„ ì¤€ë¹„í–ˆì–´ìš”.</p>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        // Firestore ë° Chart.js ê´€ë ¨ import ë° ì´ˆê¸°í™” (analysis.htmlê³¼ ìœ ì‚¬)
        import { db } from './js/firebase-config.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        // Chart.jsëŠ” ì „ì—­ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìœ¼ë¯€ë¡œ import í•„ìš” ì—†ìŒ

        // ì „ì—­ Chart ê°ì²´ ê¸°ë³¸ê°’ ì„¤ì • (analysis.htmlê³¼ ë™ì¼í•˜ê²Œ)
        if (typeof Chart !== 'undefined' && Chart) {
            Chart.defaults.color = '#333'; 
            Chart.defaults.borderColor = '#e0e0e0'; 
            Chart.defaults.font.family = "'KoPub World Dotum', sans-serif"; 
            Chart.defaults.font.size = 12; 
            console.log("Journal Detail: Chart.js(UMD) ì¸ì‹ ë° ê¸°ë³¸ê°’ ì„¤ì •ë¨.");
        } else {
            console.error("Journal Detail: Chart.js(UMD)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }


        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const pageTabTitleEl = document.getElementById('pageSessionTitle');
        const journalPageTitleEl = document.getElementById('journalPageTitle');
        const sessionDateDisplayEl = document.getElementById('sessionDateDisplay');
        const sessionSummaryContentEl = document.getElementById('sessionSummaryContent');
        const analysisSectionsContainerEl = document.getElementById('analysisSectionsContainer'); // ë¶„ì„ ì„¹ì…˜ë“¤ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ

        // analysis.htmlì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ë¶„ì„ ì„¹ì…˜ ê´€ë ¨ DOM ìš”ì†Œë“¤ë„ ì—¬ê¸°ì„œ ê°€ì ¸ì™€ì•¼ í•¨
        const languageAgeSection = document.getElementById('languageAgeSection');
        // ... (realAgeEl, predictedLangAgeEl, emotionChartEl, empathyMessageEl, tagCloudEl ë“± ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°) ...

        async function loadJournalDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            const journalId = urlParams.get('journalId') || urlParams.get('sessionId'); // journal-list2.htmlì—ì„œ ì „ë‹¬í•œ ID
            const userId = localStorage.getItem('cbtUserEmail');

            if (!journalId || !userId) {
                if(containerEl) containerEl.innerHTML = '<h1>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1><p>ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ì ‘ê·¼í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            try {
                const journalRef = doc(db, 'journals', journalId);
                const journalSnap = await getDoc(journalRef);

                if (journalSnap.exists()) {
                    const journalData = journalSnap.data();

                    if(pageTabTitleEl) pageTabTitleEl.textContent = `${journalData.title || 'ì´ì•¼ê¸°'} ìƒì„¸ë³´ê¸° - LOZEE`;
                    if(journalPageTitleEl) journalPageTitleEl.textContent = journalData.title || 'ë¡œì§€ì™€ì˜ ì†Œì¤‘í•œ ì´ì•¼ê¸°';
                    if(sessionDateDisplayEl && journalData.createdAt?.toDate) {
                        sessionDateDisplayEl.textContent = `ëŒ€í™” ë‚ ì§œ: ${journalData.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'})}`;
                    }
                    if(sessionSummaryContentEl) sessionSummaryContentEl.textContent = journalData.summary || 'ìš”ì•½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';

                    // --- ì´ì œ analysisResults ê°ì²´ë¥¼ êµ¬ì„±í•˜ì—¬ analysis.htmlì˜ ë Œë”ë§ í•¨ìˆ˜ë“¤ í˜¸ì¶œ ---
                    const analysisResultsForPage = journalData.detailedAnalysis || {};
                    const userAgeForPage = parseInt(localStorage.getItem('lozee_userage'), 10) || 0; // í•„ìš”ì‹œ ì‹¤ì œ ì‚¬ìš©ì ë‚˜ì´
                    
                    // localStorageì— ì„ì‹œë¡œ ì €ì¥í•˜ì—¬ analysis.htmlì˜ ë¡œì§ ì¬í™œìš© (ë˜ëŠ” ì§ì ‘ ë Œë”ë§)
                    // ì—¬ê¸°ì„œëŠ” analysis.htmlì˜ ë Œë”ë§ í•¨ìˆ˜ë“¤ì„ ì´ í˜ì´ì§€ì—ì„œ ì§ì ‘ í˜¸ì¶œí•œë‹¤ê³  ê°€ì •
                    // (í•´ë‹¹ í•¨ìˆ˜ë“¤ì´ ì´ ìŠ¤í¬ë¦½íŠ¸ ë‚´ì— ì •ì˜ë˜ì–´ ìˆê±°ë‚˜, import ë˜ì–´ì•¼ í•¨)

                    // 1. ì–¸ì–´Â·ë‚˜ì´ ë¶„ì„ ë Œë”ë§ (analysis.htmlì˜ ë¡œì§ê³¼ ìœ ì‚¬í•˜ê²Œ)
                    if (languageAgeSection) {
                        // userAgeForPageì™€ analysisResultsForPage.ageLanguageAnalysisë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œì‹œ
                        // (analysis.htmlì˜ ì–¸ì–´ ì—°ë ¹ í‘œì‹œ ë¡œì§ì„ ì—¬ê¸°ì— ì ìš©)
                        languageAgeSection.style.display = 'block'; // ì˜ˆì‹œë¡œ ì¼ë‹¨ ë³´ì´ê²Œ
                        // ... ìƒì„¸ ë Œë”ë§ ë¡œì§ ...
                    }

                    // 2. ê°ì • ì–´ì¡° ì°¨íŠ¸ ë° ê³µê° ë©”ì‹œì§€ (analysis.htmlì˜ ë¡œì§ê³¼ ìœ ì‚¬í•˜ê²Œ)
                    if (typeof Chart !== 'undefined' && analysisResultsForPage.emotionToneData) {
                        // renderEmotionChart('emotionChart', analysisResultsForPage.emotionToneData);
                        // displayEmpathyMessage(analysisResultsForPage.emotionToneData);
                        // ì„ì‹œ: ì°¨íŠ¸ ì˜ì—­ì— ë°ì´í„° ìˆìŒì„ ì•Œë¦¼
                        const emotionChartContainer = document.getElementById('emotionChartContainer');
                        if (emotionChartContainer) emotionChartContainer.innerHTML = `<p style="text-align:center;color:#555;">ê°ì • ë¶„ì„ ë°ì´í„°ê°€ ìˆì–´ìš”! (ì°¨íŠ¸ êµ¬í˜„ í•„ìš”)</p>`;

                    } else { /* ê°ì • ë°ì´í„° ì—†ìŒ ì²˜ë¦¬ */ }
                    
                    // ... (íƒœê·¸ í´ë¼ìš°ë“œ, ë°˜ë³µ íŒ¨í„´, ìƒí™© ë¶„ì„ ë“±ë„ ìœ ì‚¬í•˜ê²Œ analysisResultsForPageë¥¼ ì‚¬ìš©í•˜ì—¬ ë Œë”ë§) ...
                    // alertCognitiveDistortions('situationAlerts', analysisResultsForPage.cognitiveDistortions);
                    // ë“±ë“±

                } else {
                    if(containerEl) containerEl.innerHTML = '<h1>í•´ë‹¹ ì´ì•¼ê¸° ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ğŸ˜¥</h1>';
                }
            } catch (error) {
                console.error("ì €ë„ ìƒì„¸ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(containerEl) containerEl.innerHTML = '<h1>ì´ì•¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ğŸ˜¥</h1>';
            }
        }

        // analysis.htmlì—ì„œ ê°€ì ¸ì˜¨ ë Œë”ë§ í•¨ìˆ˜ë“¤ (renderTagCloud, renderPatternDashboard ë“±)
        // function renderTagCloud(elementId, tags) { /* ... */ }
        // function renderEmotionChart(canvasId, emotionData) { /* ... new Chart(...) ... */ }
        // function displayEmpathyMessage(emotionData) { /* ... */ }
        // function alertCognitiveDistortions(elementId, distortions) { /* ... */ }
        // function getKoreanVocativeParticle(name) { /* ... */ }


        document.addEventListener('DOMContentLoaded', () => {
            console.log("Journal Detail Page (journal.html): DOMContentLoaded");
            loadJournalDetail();
        });
    </script>
    <script src="./js/gnb.js" defer></script>
</body>
</html>