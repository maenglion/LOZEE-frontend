<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageSessionTitle">로지와의 이야기 상세보기 - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <link rel="stylesheet" href="css/base.css"> <link rel="stylesheet" href="css/journal.css"> </head>
<body>
  <div class="app-container">
        <nav id="gnb">
            <button id="menu-toggle">☰</button>
            <div id="gnb-title">LOZEE</div>
            <div style="width: 44px;"></div>
            <div id="dropdown-menu">
                <a href="mypage.html">🎨 내 정보 보기</a>
                <a href="index.html">✨ 새로운 이야기 시작!</a>
                <a id="gnb-analysis-link" href="analysis.html">📊 우리 이야기 분석</a>
                <a href="journal-list.html">📖 이야기 모음집</a>
                <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a>
            </div>
        </nav>

    <main class="container journal-detail-content-area"> <div class="page-header">
            <h1 id="journalPageTitle" class="session-main-title">로지와의 소중한 이야기</h1>
            <p id="sessionDateDisplay" class="session-date-display">대화 날짜: 불러오는 중...</p>
        </div>

        <div class="session-summary-section">
            <h2>✨ 오늘의 요약 ✨</h2>
            <p id="sessionSummaryContent" class="session-summary-content">
                요약된 내용이 없습니다.
            </p>
        </div>

        <div class="section keywords-section"> <h2>🔖 키워드</h2>
            <div id="tagCloud"></div>
        </div>

        <div id="detailedAnalysisSection" class="section detailed-analysis-section" style="display:none;">
            <h2>✨ 상세 분석 ✨</h2>
            <div id="detailedAnalysisContent">
                </div>
        </div>

        <div class="navigation-buttons">
             <button id="backToListBtn" class="action-button">이야기 모음집으로 돌아가기</button>
             <button id="viewAnalysisBtn" class="action-button">이 날의 분석 자세히 보기</button>
        </div>

    </main>

    <script src="./js/gnb.js" defer></script>
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { renderKeywordCloud } from './js/keywordCloud.js'; // renderKeywordCloud import
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        // URL 쿼리 파라미터로부터 journalId 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const journalId = urlParams.get("journalId") || "";

        const loggedInUserId = localStorage.getItem('lozee_userId'); // 로그인 사용자 ID 가져오기

        // DOM 요소들
        const pageTabTitleEl       = document.querySelector('title');
        const journalPageTitleEl   = document.getElementById('journalPageTitle');
        const sessionDateDisplayEl = document.getElementById('sessionDateDisplay');
        const sessionSummaryEl     = document.getElementById('sessionSummaryContent');
        const tagCloudEl           = document.getElementById('tagCloud');
        const detailedAnalysisSectionEl = document.getElementById('detailedAnalysisSection'); // 상세 분석 섹션
        const detailedAnalysisContentEl = document.getElementById('detailedAnalysisContent'); // 상세 분석 내용
        const backToListBtnEl      = document.getElementById('backToListBtn');
        const viewAnalysisBtnEl    = document.getElementById('viewAnalysisBtn');

        // 깊이: “대분류 → 서브토픽” 매핑
        function findMainCategoryOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName];
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return mainTopicObject.name;
                                }
                            }
                        }
                    }
                }
            }
            return '';
        }

        async function loadJournalDetail() {
            if (!journalId) {
                if (journalPageTitleEl) journalPageTitleEl.innerText = "잘못된 접근: journalId가 없습니다.";
                if (sessionDateDisplayEl) sessionDateDisplayEl.innerText = "";
                return;
            }

            try {
                const journalRef = doc(db, "journals", journalId);
                const journalSnap = await getDoc(journalRef);
                if (!journalSnap.exists()) {
                    if (journalPageTitleEl) journalPageTitleEl.innerText = "해당 저널을 찾을 수 없습니다.";
                    if (sessionDateDisplayEl) sessionDateDisplayEl.innerText = "";
                    return;
                }

                const data = journalSnap.data();

                // 보안 검사: 현재 로그인한 사용자가 이 저널의 소유자(userId) 또는 관련자(relatedChildId)인지 확인
                const journalOwnerUid = data.userId || data.ownerId;
                const journalRelatedChildUid = data.relatedChildId;
                const currentUserRole = localStorage.getItem('lozee_role');
                const isViewingChildJournal = (currentUserRole === 'caregiver' && loggedInUserId === data.ownerId && journalRelatedChildUid && journalRelatedChildUid === localStorage.getItem('lozee_childId_being_viewed_by_parent'));

                if (loggedInUserId !== journalOwnerUid && !isViewingChildJournal) {
                    if (journalPageTitleEl) journalPageTitleEl.innerText = "이 저널을 볼 권한이 없습니다.";
                    if (sessionDateDisplayEl) sessionDateDisplayEl.innerText = "";
                    if (sessionSummaryEl) sessionSummaryEl.innerText = "";
                    if (tagCloudEl) tagCloudEl.innerHTML = '';
                    if (detailedAnalysisSectionEl) detailedAnalysisSectionEl.style.display = 'none';
                    if (backToListBtnEl) backToListBtnEl.style.display = 'none';
                    if (viewAnalysisBtnEl) viewAnalysisBtnEl.style.display = 'none';
                    return;
                }


                // ─────────────────────────────────────────────────────────────────
                // 1) 제목(title) 렌더링
                let titleText = "";
                if (data.title && data.title.trim()) {
                    titleText = data.title;
                } else {
                    const mainCategory = findMainCategoryOfTopic(data.topic || "", counselingTopicsByAge) || "주제";
                    const gptSummary = data.summary ? data.summary.split('\n')[0] : "요약 내용이 없습니다.";
                    titleText = `${mainCategory} – ${gptSummary}`;
                }
                if (pageTabTitleEl) pageTabTitleEl.innerText = `${titleText} – LOZEE`;
                if (journalPageTitleEl) journalPageTitleEl.innerText = titleText;

                // 2) 날짜 렌더링
                if (data.createdAt?.toDate) {
                    if (sessionDateDisplayEl) sessionDateDisplayEl.innerText = `대화 날짜: ${
                        data.createdAt.toDate().toLocaleDateString('ko-KR', {
                            year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                        })
                    }`;
                } else {
                    if (sessionDateDisplayEl) sessionDateDisplayEl.innerText = "대화 날짜: 정보 없음";
                }

                // 3) 요약(summary) 렌더링
                if (sessionSummaryEl) sessionSummaryEl.innerText = data.summary || "요약된 내용이 없습니다.";

                // 4) 키워드(tags) 렌더링
                const keywords = (data.detailedAnalysis && data.detailedAnalysis.keywords)
                    ? data.detailedAnalysis.keywords
                    : [];
                if (tagCloudEl) renderKeywordCloud(keywords, tagCloudEl); // renderKeywordCloud에 tagCloudEl 전달

                // 5) 상세 분석 (detailedAnalysis) 섹션 렌더링
                if (data.detailedAnalysis && detailedAnalysisContentEl && detailedAnalysisSectionEl) {
                    const da = data.detailedAnalysis;
                    let daHtml = '';

                    if (da.overallSentiment) {
                        daHtml += `<h3>전반적인 감정: <span style="color:${da.overallSentiment === 'positive' ? 'green' : da.overallSentiment === 'negative' ? 'red' : 'gray'};">${da.overallSentiment}</span></h3>`;
                    }
                    if (da.situationAnalysis) {
                        daHtml += `<h4>상황 분석</h4><p>${da.situationAnalysis}</p>`;
                    }
                    if (da.moodChanges) {
                        daHtml += `<h4>기분 변화</h4><p>${da.moodChanges}</p>`;
                    }
                    if (da.cognitiveDistortions && da.cognitiveDistortions.length > 0) {
                        daHtml += `<h4>인지 왜곡 패턴</h4><ul>`;
                        da.cognitiveDistortions.forEach(cd => {
                            daHtml += `<li><strong>${cd.type || '알 수 없음'}:</strong> ${cd.example || '예시 없음'}</li>`;
                        });
                        daHtml += `</ul>`;
                    }
                    if (da.summaryTitle) { // 추가적인 GPT 요약 제목 등
                         daHtml += `<h4>GPT 요약 제목</h4><p>${da.summaryTitle}</p>`;
                    }
                    
                    if (daHtml) {
                        detailedAnalysisContentEl.innerHTML = daHtml;
                        detailedAnalysisSectionEl.style.display = 'block';
                    }
                }

            } catch (error) {
                console.error("저널 로드 중 오류:", error);
                if (journalPageTitleEl) journalPageTitleEl.innerText = "오류가 발생했습니다.";
                if (sessionDateDisplayEl) sessionDateDisplayEl.innerText = "";
                if (sessionSummaryEl) sessionSummaryEl.innerText = "";
                if (tagCloudEl) tagCloudEl.innerHTML = `<p style="color: #666;">키워드를 불러오는 데 실패했습니다.</p>`;
                if (detailedAnalysisSectionEl) detailedAnalysisSectionEl.style.display = 'none';
            }
        }

        // 버튼 이벤트 리스너
        if (backToListBtnEl) {
            backToListBtnEl.onclick = () => {
                window.location.href = `journal-list.html?topic=${encodeURIComponent(urlParams.get('topic') || '')}`;
            };
        }
        if (viewAnalysisBtnEl) {
            viewAnalysisBtnEl.onclick = () => {
                window.location.href = `analysis.html?journalId=${journalId}`;
            };
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadJournalDetail();
        });
    </script>
</body>
</html>