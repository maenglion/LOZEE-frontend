<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‚˜ì˜ ì´ì•¼ê¸° ê¸°ë¡ - LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* journal.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
        }
        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .page-header { text-align: center; margin-bottom: 30px; }
        .topic-title { color: var(--primary-color); font-size: 1.8em; font-weight: 700; margin-bottom: 5px;}
        .topic-stats { font-size: 0.9em; color: #555; margin-bottom: 20px; }
        .topic-stats span { margin: 0 10px; }
        .session-card-list { display: flex; flex-direction: column; gap: 20px; }
        .session-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .session-date { font-size: 0.9em; color: #777; }
        .session-card h3 { /* íšŒì°¨ë³„ ì œëª© */
            font-size: 1.2em;
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 8px;
        }
        .session-summary { font-size: 0.95em; margin-bottom: 15px; white-space: pre-wrap; }
        .session-analysis-summary {
            background-color: #eef2f7;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .session-analysis-summary h4 { margin-top: 0; font-size: 1em; color: #333; }
        .pagination { display: flex; justify-content: center; gap: 12px; font-size: 1em; margin-top: 30px; }
        .pagination a { text-decoration: none; color: var(--primary-color); font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .pagination a:hover { background-color: var(--secondary-color); color: white; }
        .pagination .current { color: var(--text-color); background-color: #e0e0e0; }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-title">ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="topic-stats">
                <span id="totalSessionCount">ì´ 0íšŒ</span> | <span id="lastSessionDate">ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>

        <div class="session-card-list" id="sessionCardList">
            </div>

        <div class="pagination" style="display:none;">
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, limit, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        // const paginationEl = document.querySelector('.pagination'); // í˜ì´ì§€ë„¤ì´ì…˜ ìš”ì†Œ

        // URLì—ì„œ ì£¼ì œëª…(ë˜ëŠ” ì£¼ì œ ID) ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const currentDisplayTopic = urlParams.get('topic'); // journal-list.htmlì—ì„œ ë„˜ê²¨ì¤€ ì£¼ì œëª… ë˜ëŠ” ID
        const userId = localStorage.getItem('cbtUserEmail'); // ì‚¬ìš©ì ì‹ë³„

        // Firestoreì—ì„œ topicStats ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ìˆìœ¼ë©´ ì¢‹ìŒ)
        async function loadTopicStats() {
            if (!userId || !currentDisplayTopic || !totalSessionCountEl || !lastSessionDateEl) return;

            try {
                // users/{userId}/topicStats/{topicName} ê²½ë¡œ ë˜ëŠ”
                // journals ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ topicìœ¼ë¡œ ê·¸ë£¹í™”í•˜ì—¬ count ë° ìµœì‹  ë‚ ì§œ ê³„ì‚° (ë” ë³µì¡)
                // ì—¬ê¸°ì„œëŠ” topicStats ì»¬ë ‰ì…˜ì´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ê°€ì ¸ì˜µë‹ˆë‹¤.
                const topicStatRef = doc(db, `users/${userId}/topicStats`, currentDisplayTopic);
                const topicStatSnap = await getDoc(topicStatRef);

                if (topicStatSnap.exists()) {
                    const data = topicStatSnap.data();
                    totalSessionCountEl.textContent = `ì´ ${data.count || 0}íšŒ ì´ì•¼ê¸° ë‚˜ëˆ”`;
                    if (data.lastChattedAt?.toDate) {
                        lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ${data.lastChattedAt.toDate().toLocaleDateString('ko-KR')}`;
                    }
                } else {
                     totalSessionCountEl.textContent = `ì´ ?íšŒ ì´ì•¼ê¸° ë‚˜ëˆ”`; // ì •ë³´ ì—†ì„ ì‹œ
                     lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
                }
            } catch (error) {
                console.error("ì£¼ì œ í†µê³„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
            }
        }

        // Firestoreì—ì„œ í•´ë‹¹ ì£¼ì œì˜ íšŒì°¨ë³„ ì €ë„(ì„¸ì…˜) ë°ì´í„° ë¡œë“œ
        async function loadSessionsForTopic() {
            if (!userId || !currentDisplayTopic || !sessionCardListEl || !topicTitleDisplayEl) {
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° í•„ìš”í•œ ê°’ì´ ë¶€ì¡±í•´ìš”.</p>";
                return;
            }

            topicTitleDisplayEl.textContent = currentDisplayTopic; // URLì—ì„œ ê°€ì ¸ì˜¨ ì£¼ì œëª… í‘œì‹œ
            sessionCardListEl.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

            try {
                // journals ì»¬ë ‰ì…˜ì—ì„œ userIdì™€ topicì´ ì¼ì¹˜í•˜ëŠ” ë¬¸ì„œë“¤ì„ createdAt ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ê°€ì ¸ì˜´
                const q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', userId),
                    where('topic', '==', currentDisplayTopic), // topic í•„ë“œë¡œ í•„í„°ë§
                    orderBy('createdAt', 'desc') 
                    // TODO: í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„ ì‹œ limit() ë° startAfter() ë“± ì‚¬ìš©
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    sessionCardListEl.innerHTML = `<p>'${currentDisplayTopic}' ì£¼ì œë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”.</p>`;
                    // ë§Œì•½ topicStatsì—ì„œ countë¥¼ ëª» ê°€ì ¸ì™”ë‹¤ë©´ ì—¬ê¸°ì„œ querySnapshot.sizeë¡œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
                    if(totalSessionCountEl && querySnapshot.size === 0) totalSessionCountEl.textContent = 'ì´ 0íšŒ ì´ì•¼ê¸° ë‚˜ëˆ”';
                    return;
                }

                // topicStatsê°€ ì—†ë‹¤ë©´ ì—¬ê¸°ì„œ íšŸìˆ˜ ì—…ë°ì´íŠ¸
                if (totalSessionCountEl && !userTopicStatsLoaded) { // userTopicStatsLoaded í”Œë˜ê·¸ë¡œ ì¤‘ë³µ ì—…ë°ì´íŠ¸ ë°©ì§€
                     totalSessionCountEl.textContent = `ì´ ${querySnapshot.size}íšŒ ì´ì•¼ê¸° ë‚˜ëˆ”`;
                }


                querySnapshot.forEach((docSnap, index) => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'session-card';

                    const dateStr = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : 'ë‚ ì§œ ì—†ìŒ';
                    const sessionTitle = data.title || `${querySnapshot.size - index}íšŒì°¨ ì´ì•¼ê¸°`; // title í•„ë“œê°€ ì—†ë‹¤ë©´ íšŒì°¨ë¡œ í‘œì‹œ
                    const summary = data.summary ? data.summary.substring(0, 800) : 'ìš”ì•½ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'; // 800ì ì œí•œ
                    
                    // ê°„ë‹¨í•œ ë¡œì§€ ë¶„ì„ ìš”ì•½ (detailedAnalysis ê°ì²´ í™œìš©)
                    let lozeeAnalysisSummary = "ë¡œì§€ ë¶„ì„ ì¤€ë¹„ ì¤‘...";
                    if (data.detailedAnalysis) {
                        const da = data.detailedAnalysis;
                        lozeeAnalysisSummary = "";
                        if(da.overallSentiment) lozeeAnalysisSummary += `ì „ë°˜ì ì¸ ëŠë‚Œ: ${da.overallSentiment}. `;
                        if(da.emotionIntensity) lozeeAnalysisSummary += `ê°ì • ê°•ë„: ${(da.emotionIntensity * 100).toFixed(0)}%. `;
                        if(da.keywords && da.keywords.length > 0) lozeeAnalysisSummary += `ì£¼ìš” ë‹¨ì–´: ${da.keywords.slice(0,2).join(', ')}. `;
                        // í•„ìš”í•œ ë¶„ì„ ë‚´ìš© ì¶”ê°€
                    }

                    card.innerHTML = `
                        <div class="session-header">
                            <span class="session-date">${dateStr}</span>
                        </div>
                        <h3>${sessionTitle}</h3>
                        <p class="session-summary">${summary}</p>
                        <div class="session-analysis-summary">
                            <h4>ë¡œì§€ ìƒê° ì—¿ë³´ê¸° ğŸ§</h4>
                            <p>${lozeeAnalysisSummary}</p>
                        </div>
                    `;
                    // ì¹´ë“œ í´ë¦­ ì‹œ analysis.htmlë¡œ ì´ë™í•˜ì—¬ í•´ë‹¹ ì„¸ì…˜ì˜ ìƒì„¸ ë¶„ì„ ë³´ì—¬ì£¼ê¸°
                    card.onclick = () => {
                        // í•´ë‹¹ ì„¸ì…˜ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ localStorageì— ì €ì¥í•˜ê±°ë‚˜, sessionIdë¥¼ ì „ë‹¬
                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            results: data.detailedAnalysis || {}, // ìƒì„¸ ë¶„ì„ ê²°ê³¼ ì „ë‹¬
                            accumulatedDurationMinutes: data.sessionDurationMinutes || 0, // ì„¸ì…˜ ì§€ì† ì‹œê°„ (DBì— ì €ì¥ë˜ì–´ ìˆì–´ì•¼ í•¨)
                            // ê¸°íƒ€ í•„ìš”í•œ ì •ë³´
                        }));
                        window.location.href = `analysis.html?sessionId=${docSnap.id}`; // ë˜ëŠ” journalId
                    };
                    sessionCardListEl.appendChild(card);
                });
                 // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸ ë¡œì§ (í•„ìš”ì‹œ)

            } catch (error) {
                console.error(`'${currentDisplayTopic}' ì£¼ì œì˜ ì„¸ì…˜ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                sessionCardListEl.innerHTML = '<p>ì´ì•¼ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥</p>';
            }
        }

        let userTopicStatsLoaded = false; // topicStats ë¡œë“œ ì—¬ë¶€ í”Œë˜ê·¸

        document.addEventListener('DOMContentLoaded', async () => {
            if (currentDisplayTopic) {
                await loadTopicStats(); // ì£¼ì œ í†µê³„ ë¨¼ì € ë¡œë“œ (ì„ íƒ ì‚¬í•­)
                userTopicStatsLoaded = true;
                await loadSessionsForTopic(); // ê·¸ ë‹¤ìŒ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
            } else {
                if(topicTitleDisplayEl) topicTitleDisplayEl.textContent = "ì„ íƒëœ ì£¼ì œ ì—†ìŒ";
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>í‘œì‹œí•  ì£¼ì œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ì–´ìš”. 'ì´ì•¼ê¸° ëª¨ìŒì§‘'ì—ì„œ ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>";
            }
        });
    </script>
    <script src="./js/gnb.js" defer></script> 
</body>
</html>