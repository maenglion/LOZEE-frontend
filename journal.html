<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageSessionTitle">ë¡œì§€ì™€ì˜ ì´ì•¼ê¸° ìƒì„¸ë³´ê¸° - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css">
    <style>
        :root {
            --primary-color: #6e8efb;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
        }
        body {
            margin: 0;
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        .page-header { 
            text-align: center; 
            margin-bottom: 25px; 
        }
        .session-main-title { 
            color: var(--primary-color); 
            font-size: 1.8em; 
            font-weight: 700; 
            margin-top: 0; 
            margin-bottom: 8px;
        }
        .session-date-display { 
            font-size: 0.95em; 
            color: #555; 
            margin-bottom: 20px; 
        }
        .session-summary-section {
            background-color: var(--card-bg);
            padding: 25px;
            margin-bottom: 25px; 
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .session-summary-section h2 { 
            color: var(--primary-color);
            font-size: 1.5em;
            margin-top: 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .session-summary-content {
            white-space: pre-wrap; 
            line-height: 1.7;
            font-size: 1em;
            color: #444;
        }
        #tagCloud {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #cccccc;
            border-radius: 8px;
            min-height: 50px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: start;
        }
        .badge {
            display: inline-block;
            margin: 4px;
            padding: 8px 12px;
            background: #e8eaf6;
            color: #3f51b5;
            border-radius: 16px;
            font-size: 0.9em;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .session-main-title { font-size: 1.6em; }
            .session-summary-section { padding: 20px; }
        }
        @media (max-width: 480px) {
            .session-main-title { font-size: 1.4em; }
            .session-summary-section { padding: 15px; }
        }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <div class="page-header">
            <!-- 1) ì œëª©: journal.jsì—ì„œ dynamicí•˜ê²Œ ì±„ì›Œì¤Œ -->
            <h1 id="journalPageTitle" class="session-main-title">ë¡œì§€ì™€ì˜ ì†Œì¤‘í•œ ì´ì•¼ê¸°</h1>
            <!-- 2) ë‚ ì§œ: journal.jsì—ì„œ dynamicí•˜ê²Œ ì±„ì›Œì¤Œ -->
            <p id="sessionDateDisplay" class="session-date-display">ëŒ€í™” ë‚ ì§œ: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- 3) ìš”ì•½ ì„¹ì…˜: journal.jsì—ì„œ dynamicí•˜ê²Œ ì±„ì›Œì¤Œ -->
        <div class="session-summary-section">
            <h2>âœ¨ ì˜¤ëŠ˜ì˜ ìš”ì•½ âœ¨</h2>
            <p id="sessionSummaryContent" class="session-summary-content">
                ìš”ì•½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.
            </p>
        </div>

        <!-- 4) íƒœê·¸ í´ë¼ìš°ë“œ(í‚¤ì›Œë“œ): journal.jsì—ì„œ renderKeywordCloudë¡œ ì±„ì›Œì¤Œ -->
        <div>
            <h2 style="color: var(--primary-color); font-size: 1.2em; margin: 0 0 10px 0;">
                ğŸ”– í‚¤ì›Œë“œ
            </h2>
            <div id="tagCloud"></div>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <!-- keywordCloud.jsë¥¼ import í•´ì„œ tagCloudì— í‚¤ì›Œë“œ ë±ƒì§€ë¥¼ ë Œë”ë§ -->
    <script type="module">
                import { db } from './js/firebase-config.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { renderKeywordCloud } from './js/keywordCloud.js'; // ì´ íŒŒì¼ì´ ì¡´ì¬í•˜ê³ , í•¨ìˆ˜ê°€ export ë˜ì–´ì•¼ í•¨
        import { counselingTopicsByAge } from './js/counseling_topics.js'; // ëŒ€ë¶„ë¥˜ ì°¾ê¸°ì— ì‚¬ìš©

        const urlParams = new URLSearchParams(window.location.search);
        const journalId = urlParams.get("journalId") || "";

        const pageTabTitleEl       = document.querySelector('title');
        const journalPageTitleEl   = document.getElementById('journalPageTitle');
        const sessionDateDisplayEl = document.getElementById('sessionDateDisplay');
        const sessionSummaryEl     = document.getElementById('sessionSummaryContent');
        const tagCloudEl           = document.getElementById('tagCloud');

        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ (í•„ìš”ì‹œ í™œìš©)
        const loggedInUserId = localStorage.getItem('lozee_userId');
        const loggedInUserName = localStorage.getItem('lozee_username') || 'ë‚˜';

        function findMainCategoryOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const subTopicsArray = mainTopicCategories[mainTopicName];
                        if (!Array.isArray(subTopicsArray)) continue;
                        for (const subTopic of subTopicsArray) {
                            if (subTopic.displayText === topicKey) {
                                return mainTopicName;
                            }
                        }
                    }
                }
            }
            return '';
        }

            async function loadJournalDetail() {
            if (!journalId) {
                journalPageTitleEl.innerText = "ì˜ëª»ëœ ì ‘ê·¼: journalIdê°€ ì—†ìŠµë‹ˆë‹¤.";
                sessionDateDisplayEl.innerText = "";
                return;
            }

            try {
                // journals ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œë¥¼ ì§ì ‘ ì°¸ì¡° (userId í•„í„°ë§ì€ ë¶ˆí•„ìš”, journalIdë¡œ ì§ì ‘ ì ‘ê·¼)
                const journalRef = doc(db, "journals", journalId);
                const journalSnap = await getDoc(journalRef);

                if (!journalSnap.exists()) {
                    journalPageTitleEl.innerText = "í•´ë‹¹ ì €ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    sessionDateDisplayEl.innerText = "";
                    return;
                }

                const data = journalSnap.data();
                // ë³´ì•ˆ ê²€ì‚¬: í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì´ ì €ë„ì˜ ì†Œìœ ì(userId) ë˜ëŠ” ê´€ë ¨ì(relatedChildId)ì¸ì§€ í™•ì¸ (ì„ íƒ ì‚¬í•­)
                // const journalOwnerUid = data.userId || data.ownerId;
                // const journalRelatedChildUid = data.relatedChildId;
                // const currentUserRole = localStorage.getItem('lozee_role');
                // if (loggedInUserId !== journalOwnerUid && !(currentUserRole === 'parent' && loggedInUserId === data.ownerId && journalRelatedChildUid === localStorage.getItem('lozee_childId_being_viewed_by_parent'))) {
                //     journalPageTitleEl.innerText = "ì´ ì €ë„ì„ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
                //     sessionDateDisplayEl.innerText = "";
                //     sessionSummaryEl.innerText = "";
                //     if(tagCloudEl) tagCloudEl.innerHTML = "";
                //     return;
                // }


                let titleText = "";
                if (data.title && data.title.trim()) {
                    titleText = data.title;
                } else {
                    const mainCategory = findMainCategoryOfTopic(data.topic || "", counselingTopicsByAge) || "ì£¼ì œ"; //
                    const gptSummary = data.summary ? data.summary.split('\n')[0] : "ìš”ì•½ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."; //
                    titleText = `${mainCategory} â€“ ${gptSummary}`;
                }
                // document.title = `${titleText} â€“ LOZEE`; // pageTabTitleEl ì‚¬ìš©
                if(pageTabTitleEl) pageTabTitleEl.textContent = `${titleText} â€“ LOZEE`;
                if(journalPageTitleEl) journalPageTitleEl.innerText = titleText;

                if (data.createdAt?.toDate) {
                    sessionDateDisplayEl.innerText = `ëŒ€í™” ë‚ ì§œ: ${
                        data.createdAt.toDate().toLocaleDateString('ko-KR', {
                            year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                        })
                    }`;
                } else {
                    sessionDateDisplayEl.innerText = "ëŒ€í™” ë‚ ì§œ: ì •ë³´ ì—†ìŒ";
                }

                sessionSummaryEl.innerText = data.summary || "ìš”ì•½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";

                const keywords = (data.detailedAnalysis && data.detailedAnalysis.keywords) ? data.detailedAnalysis.keywords : (data.tags || []); // data.tagsë„ ê³ ë ¤
                
                // renderKeywordCloud í•¨ìˆ˜ê°€ ë°°ì—´ì„ ë°›ëŠ”ì§€, ê°ì²´ ë°°ì—´ì„ ë°›ëŠ”ì§€ í™•ì¸ í•„ìš”
                // í˜„ì¬ëŠ” ë¬¸ìì—´ ë°°ì—´ì„ ì „ë‹¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •
                if (typeof renderKeywordCloud === 'function') {
                    renderKeywordCloud(keywords); // keywordCloud.jsì˜ í•¨ìˆ˜ ì‚¬ìš©
                } else if (tagCloudEl) { // renderKeywordCloudê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„
                    tagCloudEl.innerHTML = keywords.length > 0
                        ? keywords.map(kw => `<span class="badge">${kw}</span>`).join('')
                        : '<p style="color: #666;">í‘œì‹œí•  í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }


            } catch (error) {
                console.error("ì €ë„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(journalPageTitleEl) journalPageTitleEl.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                if(sessionDateDisplayEl) sessionDateDisplayEl.innerText = "";
                if(sessionSummaryEl) sessionSummaryEl.innerText = "";
                if(tagCloudEl) tagCloudEl.innerHTML = `<p style="color: #666;">í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadJournalDetail();
        });
    </script>
</body>
</html>
