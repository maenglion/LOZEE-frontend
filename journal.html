<!DOCTYPE html>
<html lang="ko">
<head>
  <script>
    // ì´ˆê¸° ì„¤ì • í™•ì¸ ë° ë¦¬ë‹¤ì´ë ‰ì…˜ ë¡œì§
    const isConfigured = localStorage.getItem('lozee_username') &&
                         localStorage.getItem('lozee_voice') &&
                         localStorage.getItem('lozee_userage');

    // 'currentTopic' ë³€ìˆ˜ ì´ë¦„ ë³€ê²½ (ì¤‘ë³µ ì„ ì–¸ ë°©ì§€)
    const topicForRedirect = localStorage.getItem('lozee_current_topic');

    if (isConfigured) {
      const targetUrl = topicForRedirect ? `talk.html?topic=${encodeURIComponent(topicForRedirect)}` : 'talk.html';
      window.location.href = targetUrl;
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOZEEì™€ ëŒ€í™”í•˜ê¸°</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: #222;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.3rem;
    }
    #chat-window {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ë° ê³µë°± ìœ ì§€ */
    }
    .user {
      align-self: flex-end;
      background-color: #ffffff;
      border: 1px solid #e0e0e0; /* í…Œë‘ë¦¬ ì¶”ê°€ */
      border-bottom-right-radius: 0;
    }
    .ai {
      align-self: flex-start;
      background-color: #eaeaea;
      border-bottom-left-radius: 0;
    }
    .ai_feedback { /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë˜ëŠ” AIì˜ ë¶€ê°€ì  í”¼ë“œë°± ìŠ¤íƒ€ì¼ */
      align-self: center;
      background-color: #e0f7fa; /* ë‹¤ë¥¸ ë°°ê²½ìƒ‰ */
      color: #00796b;            /* ë‹¤ë¥¸ ê¸€ììƒ‰ */
      font-size: 13px;
      max-width: 80%;
      text-align: center;
      border-radius: 10px;
      margin-top: 5px;
      margin-bottom: 5px;
    }
    #talk-btn {
      background-color: #ffd400;
      border: none;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      border-radius: 30px;
      width: 90%;
      max-width: 360px;
      align-self: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* ê·¸ë¦¼ì íš¨ê³¼ */
    }
    #talk-btn.active {
      background-color: #ffae00;
    }
  </style>
</head>
<body>
  <header>LOZEEì™€ ëŒ€í™”í•˜ê¸°</header>
  <div id="chat-window"></div>
  <button id="talk-btn">ğŸ¤ ë§í•˜ê¸°</button>

  <script type="module">
    // gpt-dialog.jsì—ì„œ í•¨ìˆ˜ë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. getKoreanVocativeParticleë„ ì—¬ê¸°ì„œ ì‚¬ìš© ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤.
    import { getInitialGreeting, getGptResponse, getKoreanVocativeParticle } from './js/gpt-dialog.js';
    import { playTTSFromText } from './js/tts.js';
    import { getSTTFromAudio } from './js/stt.js';
    // Firebase ê´€ë ¨ import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";


    // Firebase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ í•„ìš”)
  const firebaseConfig = {
  apiKey: "AIzaSyBnuL-CEvcU4NiIyG4yOe6mQjMnh9aArIY",                // Web API key
  authDomain: "lozee-af4d3.firebaseapp.com",                        // Auth ë„ë©”ì¸
  projectId: "lozee-af4d3",                                        // í”„ë¡œì íŠ¸ ID
  storageBucket: "lozee-af4d3.firebasestorage.app",                // ìŠ¤í† ë¦¬ì§€ ë²„í‚·
  messagingSenderId: "838397276113",                               // ë©”ì‹œì§• ë°œì‹ ì ID
  appId: "1:838397276113:web:fc8cb3bdf59ecd52fabaf0",               // ì•± ID
  measurementId: "G-C23DLE9GZ4"                                    // Analytics ì¸¡ì • ID (ì„ íƒ)
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

    // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬ ---
    const chatWindow = document.getElementById('chat-window');
    const talkBtn = document.getElementById('talk-btn');

    let hasGreeted = false;
    let isRecording = false;
    let mediaRecorder;
    let mediaStream;
    let audioChunks = [];
    let chatHistory = []; // ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•  ë°°ì—´ (í•„ìˆ˜ ì„ ì–¸)

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const userName = localStorage.getItem('lozee_username') || 'ì¹œêµ¬';
    const hasVisited = localStorage.getItem('lozee_hasVisited') === 'true';
    const voiceId = localStorage.getItem('lozee_voice') || 'ko-KR-Chirp3-HD-Zephyr'; // ê¸°ë³¸ ìŒì„± ì„¤ì •
    const lastSummary = localStorage.getItem('lozee_lastSummary') || '';
    
    // 'currentTopic' ë³€ìˆ˜ ì´ë¦„ ë³€ê²½ (ì¤‘ë³µ ì„ ì–¸ ë°©ì§€) ë° URLì—ì„œ í† í”½ ê°€ì ¸ì˜¤ê¸°
    const topicFromUrl = new URLSearchParams(window.location.search).get('topic');

    // ì‚¬ìš©ì ì´ë¦„ì— ë§ëŠ” í˜¸ê²© ì¡°ì‚¬ ì ìš© (í•„ìˆ˜ ì„ ì–¸)
    let userNameWithVocative = userName; // ê¸°ë³¸ê°’
    // gpt-dialog.jsê°€ ë¡œë“œë˜ì–´ LOZEE_DIALOG ê°ì²´ì™€ í•´ë‹¹ í•¨ìˆ˜ê°€ ì‚¬ìš© ê°€ëŠ¥í•  ë•Œ í˜¸ì¶œ
    // ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” type="module"ì´ë¯€ë¡œ, importëœ getKoreanVocativeParticleì„ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
    if (typeof getKoreanVocativeParticle === 'function') {
        const vocativeParticle = getKoreanVocativeParticle(userName);
        userNameWithVocative = `${userName}${vocativeParticle}`;
    } else {
        console.warn("getKoreanVocativeParticle í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. userNameWithVocativeê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.");
        userNameWithVocative = `${userName}ì•¼`; // ì•ˆì „í•œ ê¸°ë³¸ê°’
    }

    // ëŒ€í™” ìƒíƒœ ê´€ë¦¬ ê°ì²´ (ìš”ì•½ ì œì•ˆ í™•ì¸ ë“±)
    window.LOZEE_STATE = window.LOZEE_STATE || {};

    // journals ì»¬ë ‰ì…˜ ì½ì–´ì˜¤ê¸°
    async function renderJournals() {
    const listContainer = document.getElementById("journal-list");
    const snapshot = await getDocs(collection(db, "journals"));
    snapshot.forEach(doc => {
      const data = doc.data();
      const card = document.createElement("div");
      card.className = "journal-card";
      card.innerHTML = `
        <h3>${data.title}</h3>
        <p>${data.summary}</p>
        <small>${data.createdAt?.toDate().toLocaleString()}</small>
      `;
      listContainer.append(card);
    });
  }

   // í˜ì´ì§€ ë¡œë“œ ì‹œ ë Œë” í˜¸ì¶œ
   document.addEventListener("DOMContentLoaded", renderJournals);


    // --- Firestore ì €ì¥ í•¨ìˆ˜ë“¤ ---
    async function saveUserProfile() {
      const userId = localStorage.getItem('lozee_username');
      // 'lozee_usernote'ëŠ” ë¯¼í›„ì˜ íŠ¹ì„± ë©”ëª¨ ë“±ì— ì‚¬ìš©ë  ìˆ˜ ìˆìŒ (ì˜ˆ: 'asd_traits')
      const diagnosis = localStorage.getItem('lozee_usernote') || ''; 
      const voice = localStorage.getItem('lozee_voice');

      if (!userId) return;

      try {
        await setDoc(doc(db, 'users', userId), {
          name: userId,
          diagnosis, // ë˜ëŠ” userTraits, notes ë“± ë” ì¼ë°˜ì ì¸ ì´ë¦„ ì‚¬ìš© ê°€ëŠ¥
          voice,
          createdAt: serverTimestamp(),
          lastLogin: serverTimestamp() // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ë“± ì¶”ê°€ ì •ë³´
        }, { merge: true }); // ê¸°ì¡´ ë¬¸ì„œì— ë³‘í•© (ë®ì–´ì“°ì§€ ì•ŠìŒ)
        console.log("ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥ë¨.");
      } catch (error) {
        console.error("ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
      }
    }
    saveUserProfile(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥/ì—…ë°ì´íŠ¸

    async function saveSessionLog(userUtterance, aiResponse, analysisData = null) {
      const userId = localStorage.getItem('lozee_username');
      if (!userId) return;

      try {
        await addDoc(collection(db, 'sessions'), {
          userId,
          timestamp: serverTimestamp(),
          userText: userUtterance,
          aiReply: aiResponse,
          analysis: analysisData // GPTì˜ ë¶„ì„ ë°ì´í„°ë„ í•¨ê»˜ ì €ì¥
        });
        console.log("ì„¸ì…˜ ë¡œê·¸ ì €ì¥ë¨.");
      } catch (error) {
        console.error("ì„¸ì…˜ ë¡œê·¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
      }
    }

    // ê¸°ì¡´ ì§§ì€ AI ë‹µë³€ ì €ì¥ í•¨ìˆ˜ (ìš”ì•½ ê¸°ëŠ¥ê³¼ ë³„ê°œ)
    async function saveJournalEntry(topic, summaryText) {
      const userId = localStorage.getItem('lozee_username');
      if (!userId || !topic || !summaryText) return;

      try {
        await addDoc(collection(db, 'journals'), {
          userId,
          topic,
          title: summaryText.substring(0, 25) + (summaryText.length > 25 ? "..." : ""), // ê°„ë‹¨ ì œëª©
          summary: summaryText, // AIì˜ ì§§ì€ ë‹µë³€
          createdAt: serverTimestamp(),
          entryType: "ai_reply_snippet" // ìœ í˜• êµ¬ë¶„
        });
        console.log("AI ë‹µë³€ ìŠ¤ë‹ˆí« ì¼ê¸° ì €ì¥ë¨.");
      } catch (error) {
        console.error("AI ë‹µë³€ ìŠ¤ë‹ˆí« ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
      }
    }

    // ëŒ€í™” ìš”ì•½ë³¸ ì €ì¥ í•¨ìˆ˜
    async function saveConversationSummaryAsJournal(summaryText, summaryAnalysis, conversationContext) {
      const userId = localStorage.getItem('lozee_username');
      if (!userId || !summaryText) {
        console.log("User ID ë˜ëŠ” ìš”ì•½ ë‚´ìš©ì´ ì—†ì–´ ì¼ê¸°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      let title = `ëŒ€í™” ìš”ì•½ (${new Date().toLocaleDateString()})`;
      const currentTopicTextFromContext = conversationContext.selectedTopic?.displayText;
      const currentStageFromContext = conversationContext.currentStage;

      if (currentTopicTextFromContext && currentTopicTextFromContext !== 'USER_WILL_DEFINE_IN_CHAT' && currentTopicTextFromContext.trim() !== '') {
        title = currentTopicTextFromContext;
      } else if (currentStageFromContext) {
        title = `${currentStageFromContext} ëŒ€í™” ìš”ì•½`;
      } else {
        title = summaryText.substring(0, 25) + (summaryText.length > 25 ? "..." : "");
      }

      let moodDisplay = "ê¸°ë¶„ ì •ë³´ ì—†ìŒ";
      let keywordsDisplay = [];

      if (summaryAnalysis && summaryAnalysis.sentiment) {
        moodDisplay = `ì „ë°˜ì  ëŠë‚Œ: ${summaryAnalysis.sentiment}`;
        if (summaryAnalysis.emotion_intensity) {
          moodDisplay += ` (ê°•ë„: ${(summaryAnalysis.emotion_intensity * 10).toFixed(1)}/10ì )`;
        }
      }
      if (summaryAnalysis && summaryAnalysis.keywords && summaryAnalysis.keywords.length > 0) {
          keywordsDisplay = summaryAnalysis.keywords;
      }

      try {
        await addDoc(collection(db, 'journals'), {
          userId: userId,
          topic: currentTopicTextFromContext || currentStageFromContext || "ëŒ€í™” ìš”ì•½",
          title: title,
          summary: summaryText,
          mood: moodDisplay,
          keywords: keywordsDisplay,
          createdAt: serverTimestamp(),
          entryType: "conversation_summary"
        });
        console.log("ëŒ€í™” ìš”ì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì¼ê¸°ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (error) {
        console.error("ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ", error);
      }
    }

    // --- UI ë° ëŒ€í™” ë¡œì§ í•¨ìˆ˜ ---
    function appendMessage(text, role = 'ai') {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${role}`; // roleì— ë”°ë¼ 'ai_feedback' ë“±ë„ ê°€ëŠ¥
      bubble.textContent = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight; // í•­ìƒ ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
    }

    async function initGreeting() {
      // getInitialGreeting í•¨ìˆ˜ëŠ” topicFromUrl(URLì—ì„œ ê°€ì ¸ì˜¨ ì£¼ì œ)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ë‹¬
      const greeting = getInitialGreeting(userName, hasVisited, lastSummary, topicFromUrl);
      appendMessage(greeting, 'ai');
      chatHistory.push({ role: 'assistant', content: greeting }); // ì²« ì¸ì‚¬ë„ ê¸°ë¡
      await playTTSFromText(greeting, voiceId);
      localStorage.setItem('lozee_hasVisited', 'true'); // ë°©ë¬¸ ê¸°ë¡ ì €ì¥
    }

    async function startRecording() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(mediaStream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = mediaRecorderStopHandler; // ë¶„ë¦¬ëœ í•¸ë“¤ëŸ¬ ì‚¬ìš©
        mediaRecorder.start();
        console.log("ë…¹ìŒ ì‹œì‘ë¨.");
      } catch (err) {
        console.error("ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜:", err);
        appendMessage("ìŒì„± ë…¹ìŒì„ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "ai_feedback");
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        isRecording = false;
        talkBtn.classList.remove('active');
        talkBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°';
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        console.log("ë…¹ìŒ ì¤‘ì§€ë¨.");
        // ìŠ¤íŠ¸ë¦¼ íŠ¸ë™ ì¤‘ì§€ (ë§ˆì´í¬ ì‚¬ìš© í•´ì œ)
        if (mediaStream) {
          mediaStream.getTracks().forEach(track => track.stop());
        }
      }
    }
    
    // mediaRecorder.onstop ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (í•µì‹¬ ë¡œì§)
    // ì´ í•¨ìˆ˜ëŠ” ì´ì „ì˜ ë³µì¡í–ˆë˜ mediaRecorder.onstop ë‚´ìš©ì„ ë‹´ìŠµë‹ˆë‹¤.
    const mediaRecorderStopHandler = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' }); // ì˜¤ë””ì˜¤ íƒ€ì… ëª…ì‹œ
      const userText = await getSTTFromAudio(blob);
      
      if (!userText || userText.trim() === "") {
        console.log("STT ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
        appendMessage("ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”. ì¡°ê¸ˆ ë” í¬ê³  ë¶„ëª…í•˜ê²Œ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”? ğŸ˜Š", 'ai_feedback');
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        isRecording = false;
        talkBtn.classList.remove('active');
        talkBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°';
        return;
      }

      appendMessage(userText, 'user');
      chatHistory.push({ role: 'user', content: userText });

      const currentConversationContext = {
          userAge: localStorage.getItem('lozee_userage'),
          userDisease: JSON.parse(localStorage.getItem('lozee_userdisease') || '[]'),
          userName: userName,
          currentStage: localStorage.getItem('currentStage') || 'Stage 1',
          selectedTopic: JSON.parse(localStorage.getItem('selectedTopic') || '{}'),
          chatHistory: chatHistory.slice(0, -1) // í˜„ì¬ ì‚¬ìš©ì ë°œí™”(userText)ë¥¼ ì œì™¸í•œ ì´ì „ íˆìŠ¤í† ë¦¬
      };
      currentConversationContext.selectedTopicText = currentConversationContext.selectedTopic?.displayText || '';

      let isSummarizationConfirmed = false;
      if (window.LOZEE_STATE && window.LOZEE_STATE.awaitingSummaryConfirmation) {
        if (userText.includes("1") || userText.toLowerCase().includes("ì‘") || userText.includes("ì •ë¦¬") || userText.includes("ìš”ì•½") || userText.toLowerCase().includes("ê·¸ë˜") || userText.toLowerCase().includes("ì˜ˆ")) {
            isSummarizationConfirmed = true;
        }
        window.LOZEE_STATE.awaitingSummaryConfirmation = false; // ìƒíƒœ ì´ˆê¸°í™”
      }

      let aiReplyText;
      let aiReplyAnalysis;

      try {
        if (isSummarizationConfirmed) {
          appendMessage("ì•Œê² ì–´, ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¥¼ ì •ë¦¬í•´ë³¼ê²Œ! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜ ğŸ˜Š", 'ai_feedback');
          await playTTSFromText("ì•Œê² ì–´, ìš°ë¦¬ê°€ ë‚˜ëˆˆ ì´ì•¼ê¸°ë¥¼ ì •ë¦¬í•´ë³¼ê²Œ! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜", voiceId);

          const summaryResponse = await getGptResponse("SYSTEM_COMMAND_SUMMARIZE_HISTORY", {
              ...currentConversationContext, // userAge, userName ë“± ê¸°ë³¸ ì •ë³´ ì „ë‹¬
              chatHistory: currentConversationContext.chatHistory // ìš”ì•½í•  ì‹¤ì œ ëŒ€í™” ë‚´ì—­
          });
          
          if (!summaryResponse.ok) throw new Error(`GPT API ì˜¤ë¥˜: ${summaryResponse.status}`);
          const summaryData = await summaryResponse.json();

          aiReplyText = summaryData.text;
          aiReplyAnalysis = summaryData.analysis;

          appendMessage(aiReplyText, 'ai'); // ìš”ì•½ë¬¸ í‘œì‹œ
          await playTTSFromText(aiReplyText, voiceId);
          await saveSessionLog(`ëŒ€í™” ìš”ì•½ ìš”ì²­ (${userText})`, aiReplyText, aiReplyAnalysis);

          await saveConversationSummaryAsJournal(aiReplyText, aiReplyAnalysis, currentConversationContext);

          const saveConfirmMsg = `${userNameWithVocative}, ë°©ê¸ˆ ì •ë¦¬í•œ ë‚´ìš©ì€ ì¼ê¸°ì—ë„ ì˜ ë‚¨ê²¨ë’€ì–´! ì–¸ì œë“  ë‹¤ì‹œ í¼ì³ë³¼ ìˆ˜ ìˆì„ ê±°ì•¼. âœ¨`;
          appendMessage(saveConfirmMsg, 'ai');
          await playTTSFromText(saveConfirmMsg, voiceId);
          
          chatHistory.push({ role: 'assistant', content: aiReplyText }); // ìš”ì•½ë¬¸ì„ ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
          chatHistory.push({ role: 'assistant', content: saveConfirmMsg }); // ì €ì¥ í™•ì¸ ë©”ì‹œì§€ë„ ê¸°ë¡

        } else {
          // ì¼ë°˜ ëŒ€í™” ì²˜ë¦¬
          const gptResponse = await getGptResponse(userText, {
              ...currentConversationContext, // userName, userAge ë“± ì „ë‹¬
              chatHistory: currentConversationContext.chatHistory // í˜„ì¬ ì‚¬ìš©ì ë°œí™” ì œì™¸í•œ íˆìŠ¤í† ë¦¬
          });

          if (!gptResponse.ok) throw new Error(`GPT API ì˜¤ë¥˜: ${gptResponse.status}`);
          const gptData = await gptResponse.json();

          aiReplyText = gptData.text || 'ìŒ... ë‹¤ì‹œ ë§í•´ì¤„ë˜?';
          aiReplyAnalysis = gptData.analysis;

          appendMessage(aiReplyText, 'ai');
          await playTTSFromText(aiReplyText, voiceId);
          await saveSessionLog(userText, aiReplyText, aiReplyAnalysis);
          chatHistory.push({ role: 'assistant', content: aiReplyText });

          // ê¸°ì¡´ì˜ ì§§ì€ AI ë‹µë³€ ì €ì¥ ë¡œì§ (topicFromUrl ê¸°ë°˜)
          if (topicFromUrl && aiReplyText.length < 1000) {
            await saveJournalEntry(topicFromUrl, aiReplyText);
          }

          if (aiReplyText.includes("ì •ë¦¬í•´ë³¼ê¹Œ?") && (aiReplyText.includes("1.") || aiReplyText.includes("ì²« ë²ˆì§¸")) && (aiReplyText.includes("2.") || aiReplyText.includes("ë‘ ë²ˆì§¸"))) {
              window.LOZEE_STATE = window.LOZEE_STATE || {};
              window.LOZEE_STATE.awaitingSummaryConfirmation = true;
          }
        }
      } catch (error) {
          console.error("GPT ì‘ë‹µ ì²˜ë¦¬ ë˜ëŠ” ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
          const errorMsg = "ë¯¸ì•ˆí•´, ì§€ê¸ˆì€ ì‘ë‹µí•˜ê¸° ì¡°ê¸ˆ ì–´ë ¤ìš´ ê²ƒ ê°™ì•„. ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?";
          appendMessage(errorMsg, 'ai_feedback');
          await playTTSFromText(errorMsg, voiceId);
          chatHistory.push({ role: 'assistant', content: errorMsg }); // ì˜¤ë¥˜ ì‘ë‹µë„ ê¸°ë¡
      }

      isRecording = false;
      talkBtn.classList.remove('active');
      talkBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°';
    };


    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    talkBtn.addEventListener('click', async () => {
      if (!hasGreeted) {
        await initGreeting();
        hasGreeted = true;
        // ì²« ì¸ì‚¬ í›„ ë°”ë¡œ ë…¹ìŒ ì‹œì‘í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ë‹¤ì‹œ ë²„íŠ¼ ëˆ„ë¥´ë„ë¡)
        return; 
      }

      if (!isRecording) {
        await startRecording();
        // startRecording ë‚´ë¶€ì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ìƒíƒœê°€ ë³µì›ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì„±ê³µ ê°€ì •
        if (mediaRecorder && mediaRecorder.state === "recording") {
            talkBtn.classList.add('active');
            talkBtn.textContent = 'â¹ï¸ ë©ˆì¶”ê¸°';
            isRecording = true;
        }
      } else {
        stopRecording();
        // onstop í•¸ë“¤ëŸ¬ì—ì„œ isRecording = falseë¡œ ì„¤ì •í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë²„íŠ¼ í…ìŠ¤íŠ¸ë§Œ ë³€ê²½
        // talkBtn.classList.remove('active'); // onstopì—ì„œ ì²˜ë¦¬
        // talkBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°'; // onstopì—ì„œ ì²˜ë¦¬
        // isRecording = false; // onstopì—ì„œ ì²˜ë¦¬
      }
      // isRecording ìƒíƒœëŠ” startRecording ì„±ê³µ ì—¬ë¶€ ë° stopRecording í˜¸ì¶œ ì‹œì ì— ë”°ë¼ ê²°ì •ë¨
    });

  </script>
</body>
</html>