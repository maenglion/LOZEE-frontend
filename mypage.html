<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTitle">마이 로지</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* mypage.html 고유 스타일 */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            /* --gnb-height는 gnb.css에서 정의된 var(--gnb-height)를 사용합니다. */
            /* 만약 gnb.css에 --gnb-height 변수가 없다면 여기에 정의해야 합니다: */
            /* --gnb-height: 56px;  */
            --profile-placeholder-bg: #d0d9ff; 
            --light-blue-bg: #eef2f7;
            --action-button-bg: #6078ea;
        }
        body {
            margin: 0;
            /* gnb.css에서 body padding-top을 var(--gnb-height)로 설정해야 합니다. */
            /* 만약 gnb.css에 없다면 아래 주석 해제: */
            /* padding-top: var(--gnb-height);  */
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        .page-title { color: var(--primary-color); text-align: center; font-size: 2em; margin-bottom: 30px; font-weight: 700; }
        
        .profile-section { 
            display: grid;
            grid-template-columns: auto 1fr; 
            gap: 20px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            align-items: center;
        }
       
       .diagnosis-options-modal button { /* 모달 내 선택 버튼 스타일 */
    display: inline-block; /* 가로로 배치되도록 */
    margin: 5px;
    padding: 8px 12px;
    font-size: 0.9em;
    /* .diagnosis-btn 스타일과 유사하게 또는 동일하게 적용 */
    background-color: #e8eaf6; color: #3f51b5; border: 1px solid #c5cae9;
    border-radius: 15px; cursor: pointer;
}
.diagnosis-options-modal button.selected {
    background-color: var(--primary-color); color: white;
    border-color: var(--primary-color);
}
.input-group { margin-bottom: 15px; } /* 스타일 일관성 */
.input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555;}
.input-group input, .input-group .select-row select { width: 100%; box-sizing: border-box; }
       
       
       
        .profile-photo-container { display: flex; justify-content: center; align-items: center; }
        .profile-photo-placeholder { width: 100px; height: 100px; border-radius: 50%; background-color: var(--profile-placeholder-bg); display: flex; align-items: center; justify-content: center; font-size: 2em; color: white; font-weight: bold; }
        .profile-photo-placeholder img { width:100%; height:100%; border-radius:50%; object-fit:cover;}
        .profile-details h2 { font-size: 1.5em; color: var(--primary-color); margin-top: 0; margin-bottom: 5px; text-align:left;}
        .profile-details .user-email { font-size: 0.9em; color: #777; margin-bottom:15px; text-align:left;}
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info-card h2 { font-size: 1.2em; color: var(--primary-color); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; text-align:left;}
        .info-item { margin-bottom: 10px; font-size: 1em; display: flex; justify-content: space-between; align-items: baseline;}
        .info-item .label { font-weight: bold; color: #555; margin-right: 10px; white-space: nowrap; }
        .info-item .value { color: var(--text-color); text-align: right; word-break: keep-all; }
        .neurodiversity-info ul { list-style: none; padding:0; margin:0; text-align:left; }
        .neurodiversity-info li { background-color: #e9eaf6; color: #3f51b5; padding: 6px 10px; border-radius: 15px; font-size: 0.9em; display: inline-block; margin-right: 8px; margin-bottom: 8px;}
        .plans-card ul { list-style: none; padding: 0; text-align: left; }
        .plans-card li { background-color: #eef2f7; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.95em; cursor:pointer; transition: background-color 0.2s; }
        .plans-card li:hover { background-color: #dbe4f0; }
        .recent-journals-section h2 { text-align: center; font-size: 1.4em; color: var(--primary-color); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .recent-journal-card-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .session-card-wide { background-color: var(--card-bg, #ffffff); border-radius: 10px; padding: 15px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-left: 4px solid var(--secondary-color, #5a7edf); display: flex; flex-direction: column; cursor: pointer; transition: box-shadow 0.2s;}
        .session-card-wide:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        .session-card-wide .session-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; border-bottom: none; padding-bottom: 5px; }
        .session-card-wide .session-date { font-size: 0.85em; color: #777; font-weight:normal; }
        .session-card-wide .session-meta { font-size: 0.85em; color: var(--primary-color); font-weight: bold; }
        .session-card-wide h3 { font-size: 1.1em; color: var(--text-color); margin-top: 0; margin-bottom: 8px; font-weight: 500; }
        .session-card-wide .session-summary { font-size: 0.9em; color: #555; margin-bottom: 10px; white-space: normal; word-break:keep-all; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(0.9em * 1.5 * 2); padding-left: 0; border-left: none; }
        .journal-analysis-banner { padding: 8px 12px; border-radius: 6px; margin-top: 10px; margin-bottom:0; font-size: 0.85em; text-align: center; }
        .journal-analysis-banner.positive { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9;}
        .journal-analysis-banner.neutral { background-color: #eceff1; color: #37474f; border: 1px solid #cfd8dc;}
        .journal-analysis-banner.negative { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2;}
        .action-button { display: inline-block; margin-top: 15px; background-color: #6e8efb; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .action-button:hover { background-color: #5a7edf; }
        .view-all-journals-btn { display: block; width: fit-content; margin: 20px auto 0 auto; }
        .connection-status { margin-left: 8px; font-size: 0.9em; }
        .connection-status .connected { color: green; font-weight: bold; }
        .connection-status .disconnected { color: #aaa; }
        .module-explanation { font-size:0.9em; color:#555; margin-bottom:15px; padding: 10px; background-color: #eef2f7; border-radius: 6px; line-height: 1.6; text-align: left; }
        @media (max-width: 700px) { .profile-section { grid-template-columns: 1fr; text-align: center; } .profile-details h2, .profile-details .user-email { text-align: center; } .info-item { flex-direction: column; align-items: flex-start; } .info-item .value { text-align: left; } .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a> 
          <a href="index.html">✨ 새로운 이야기 시작!</a> 
          <a href="analysis.html">📊 우리 이야기 분석</a> 
          <a href="journal-list.html">📖 이야기 모음집</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a> 
        </div>
    </nav> 

    <main class="container">
        <h1 id="pageMainTitle" class="page-title">🎨 마이 로지</h1>

<div class="profile-section">
    <button id="editProfileBtn" class="action-button" style="margin-top: 15px; grid-column: 1 / -1; justify-self: center;">프로필 정보 수정</button>
</div>

<div id="profileEditModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; align-items:center; justify-content:center; display:none;">
    <div style="background:white; padding:30px; border-radius:10px; width:90%; max-width:500px; color: #333;">
        <h2 id="modalTitle">프로필 정보 수정</h2>
        
        <div class="input-group">
            <label for="editNameInput">닉네임:</label>
            <input type="text" id="editNameInput" placeholder="새 닉네임">
        </div>

        <div id="editDirectUserNDSection" style="display:none;">
            <p>나의 신경다양성 특성 (중복 선택 가능):</p>
            <div id="editUserDiagnosesOptions" class="diagnosis-options-modal">
                </div>
        </div>

        <div id="editCaregiverInfoSection" style="display:none;">
            <p>보호자님 본인 또는 배우자/관계인의 신경다양성 특성:</p>
            <div id="editCaregiverNDOptions" class="diagnosis-options-modal">
                </div>
            <hr style="margin: 20px 0;">
            <h4>아이/가족 정보 수정</h4>
            <div class="input-group">
                <label for="editChildNameInput">아이/가족 이름:</label>
                <input type="text" id="editChildNameInput" placeholder="아이/가족 새 닉네임">
            </div>
            <div class="input-group">
                <label>아이/가족 생년월일:</label>
                <div class="select-row">
                    <select id="editChildBirthYear"><option value="">년</option></select>
                    <select id="editChildBirthMonth"><option value="">월</option></select>
                    <select id="editChildBirthDay"><option value="">일</option></select>
                </div>
            </div>
            <p>아이/가족의 신경다양성 특성 (중복 선택 가능):</p>
            <div id="editChildDiagnosesOptions" class="diagnosis-options-modal">
                </div>
             <div class="input-group" style="margin-top:15px;">
                <label for="editChildLozeeEmailInput">연결된 로지 계정 (아이/가족):</label>
                <input type="email" id="editChildLozeeEmailInput" placeholder="아이/가족 로지 이메일">
            </div>
        </div>

        <div style="text-align:right; margin-top:20px;">
            <button id="saveProfileChangesBtn" class="action-button">저장하기</button>
            <button id="cancelProfileEditBtn" class="secondary-btn" style="margin-left:10px;">취소</button>
        </div>
    </div>
</div>
            
            <div class="info-card plans-card">
                <h2>🤝 로지와의 약속! (로지 숙제)</h2>
                <p class="module-explanation">로지랑 이런 이야기를 더 나누기로 했었지! 언제든 다시 시작할 수 있어.</p>
                <ul id="lozeePlans"><li>약속을 불러오는 중...</li></ul>
            </div>
        </div>

        <div class="section recent-journals-section">
            <h2 class="recent-journals-title">💬 최근에 나눈 이야기들</h2>
            <div id="recentJournalCardList" class="recent-journal-card-list">
                <p style="text-align:center; color:#777;">최근 이야기 목록을 불러오는 중...</p>
            </div>
            <button id="goToJournalListBtn" class="action-button view-all-journals-btn">📖 전체 이야기 모음집 가기</button>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // --- DOM 요소 가져오기 ---
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTitleEl = document.querySelector('title'); // <title> 태그
        const userPhotoPlaceholderEl = document.getElementById('userPhotoPlaceholder');
        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const userEmailDisplayEl = document.getElementById('userEmailDisplay');
        const ageLabelEl = document.getElementById('ageLabel');
        const userFullAgeEl = document.getElementById('userFullAge'); // 로그인한 사용자(당사자/보호자) 본인 나이
        const lastLoginDateEl = document.getElementById('lastLoginDate');
        const sessionCountLabelEl = document.getElementById('sessionCountLabel');
        const totalSessionsCountEl = document.getElementById('totalSessionsCount');
        
        const directUserDiagnosisCardEl = document.getElementById('directUserDiagnosisCard');
        const userDiagnosesListEl = document.getElementById('userDiagnosesList');
        
        const caregiverPersonalNDCardEl = document.getElementById('caregiverPersonalNDCard');
        const caregiverPersonalNeurodiversityListEl = document.getElementById('caregiverPersonalNeurodiversityList');
        
        const childInfoCardEl = document.getElementById('childInfoCard');
        const childNameDisplayEl = document.getElementById('childNameDisplay');
        const childFullAgeDisplayEl = document.getElementById('childFullAgeDisplay'); // 아이/가족 나이 표시용
        const childDiagnosesListEl = document.getElementById('childDiagnosesList');
        const childLozeeEmailDisplayEl = document.getElementById('childLozeeEmailDisplay');
        const childConnectionStatusEl = document.getElementById('childConnectionStatus');
        
        const lozeePlansEl = document.getElementById('lozeePlans');
        const recentJournalCardListEl = document.getElementById('recentJournalCardList');
        const goToJournalListBtn = document.getElementById('goToJournalListBtn');

        const editProfileBtn = document.getElementById('editProfileBtn');
const profileEditModal = document.getElementById('profileEditModal');
const modalTitleEl = document.getElementById('modalTitle');

const editNameInput = document.getElementById('editNameInput');

const editDirectUserNDSection = document.getElementById('editDirectUserNDSection');
const editUserDiagnosesOptionsEl = document.getElementById('editUserDiagnosesOptions');

const editCaregiverInfoSection = document.getElementById('editCaregiverInfoSection');
const editCaregiverNDOptionsEl = document.getElementById('editCaregiverNDOptions');
const editChildNameInput = document.getElementById('editChildNameInput');
const editChildBirthYear = document.getElementById('editChildBirthYear');
const editChildBirthMonth = document.getElementById('editChildBirthMonth');
const editChildBirthDay = document.getElementById('editChildBirthDay');
const editChildDiagnosesOptionsEl = document.getElementById('editChildDiagnosesOptions');
const editChildLozeeEmailInput = document.getElementById('editChildLozeeEmailInput');

const saveProfileChangesBtn = document.getElementById('saveProfileChangesBtn');
const cancelProfileEditBtn = document.getElementById('cancelProfileEditBtn');

        // --- 헬퍼 함수 ---
        function calculateAgeFromBirthDate(birthDateStr) {
            if (!birthDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(birthDateStr)) return null;
            try {
                const birthDate = new Date(birthDateStr);
                if (isNaN(birthDate.getTime())) return null; 
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
                return age >= 0 ? age : null;
            } catch (e) {
                console.error("calculateAgeFromBirthDate 오류:", e, "입력값:", birthDateStr);
                return null;
            }
        }

        function getNeurodiversityText(code) {
            const map = { "ASD": "자폐 스펙트럼 (ASD)", "ADHD": "주의력 결핍 과잉행동 장애 (ADHD)", "Asperger": "아스퍼거 증후군", "Tic": "틱 장애", "LD": "학습 장애", "Else": "기타 어려움/궁금증", "Unsure": "아직 잘 모름/진단 없음", "NotApplicable": "특별히 해당 없음", "self_asd": "본인: 자폐 스펙트럼(ASD) 성향", "self_adhd": "본인: ADHD 성향", "spouse_asd": "배우자/관계인: 자폐 스펙트럼(ASD) 성향", "spouse_adhd": "배우자/관계인: ADHD 성향", "self_else": "본인: 기타 신경다양성 특성", "spouse_else": "배우자/관계인: 기타 신경다양성 특성", "unsure_or_none": "잘 모르거나 해당 사항 없음" };
            return map[code] || code; 
        }

        // --- 사용자 프로필 로드 및 표시 ---
        async function loadUserProfile() {
            let loggedInUserEmail = localStorage.getItem('cbtUserEmail') || '';
            let userType = localStorage.getItem('lozee_userType') || ''; 

            if (loggedInUserEmail === 'unbearable_@naver.com') { // 테스트 계정 처리
                userType = 'caregiver';
            }

            if (!loggedInUserEmail) { 
                if(pageMainTitleEl) pageMainTitleEl.textContent = '로그인이 필요해요';
                if(userNameDisplayEl) userNameDisplayEl.textContent = '로그인 정보 없음';
                // 모든 정보 카드 숨김
                if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';
                if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                if(childInfoCardEl) childInfoCardEl.style.display = 'none';
                return; 
            }
            if (!userType && loggedInUserEmail !== 'unbearable_@naver.com') {
                if(pageMainTitleEl) pageMainTitleEl.textContent = '사용자 유형 정보가 없습니다.';
                // 모든 정보 카드 숨김
                if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';
                if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                if(childInfoCardEl) childInfoCardEl.style.display = 'none';
                return;
            }

            if(userEmailDisplayEl) userEmailDisplayEl.textContent = loggedInUserEmail;
            
            const userRef = doc(db, 'users', loggedInUserEmail);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    console.log("Mypage: Firestore 사용자 데이터:", data); 
                    
                    const profileNameForCard = data.name || (userType === 'caregiver' ? '보호자님' : '친구'); // Firestore의 name 필드
                    const profileBirthDate = data.birthDate; 
                    const profileAge = profileBirthDate ? calculateAgeFromBirthDate(profileBirthDate) : (data.age !== undefined ? data.age : null);

                    if(pageTitleEl) pageTitleEl.textContent = `${profileNameForCard}의 마이 로지`;
                    if(pageMainTitleEl) pageMainTitleEl.textContent = `${profileNameForCard}님의 마이 로지 🎨`;
                    if(userNameDisplayEl) userNameDisplayEl.textContent = profileNameForCard;
                    
                    if(userFullAgeEl) userFullAgeEl.textContent = profileAge !== null ? `만 ${profileAge}세` : '정보 없음';
                    if(ageLabelEl) ageLabelEl.textContent = "만 나이:"; 

                    if (userPhotoPlaceholderEl) {
                        if (data.photoURL) { userPhotoPlaceholderEl.innerHTML = `<img src="${data.photoURL}" alt="${profileNameForCard} 사진">`;} 
                        else { userPhotoPlaceholderEl.textContent = profileNameForCard.charAt(0).toUpperCase() || '😊';}
                    }
                    if(lastLoginDateEl && data.lastLogin?.toDate) { 
                    lastLoginDateEl.textContent = data.lastLogin.toDate().toLocaleString('ko-KR', { 
                     year: 'numeric',  month: 'short', day: 'numeric', hour: 'numeric', // 시간 추가
                     minute: '2-digit', // 분 추가 (두 자리로)
                     hour12: true // true 또는 false로 오전/오후 표시 여부 결정
                     });
                     } else { 
                     if(lastLoginDateEl) lastLoginDateEl.textContent = '기록 없음';
                     }
                    
                    let sessionCountToDisplay = 0;
                    if (userType === 'caregiver') {
                        sessionCountToDisplay = data.childTotalSessionCount || 0; 
                        if(sessionCountLabelEl) sessionCountLabelEl.textContent = `아이/가족 총 대화:`;
                    } else { 
                        sessionCountToDisplay = data.totalSessionCount || 0;
                        if(sessionCountLabelEl) sessionCountLabelEl.textContent = `로지와의 총 대화:`;
                    }
                    if(totalSessionsCountEl) totalSessionsCountEl.textContent = `${sessionCountToDisplay}회`; 

                    // 사용자 유형별 카드 표시
                    if (userType === 'caregiver') {
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'block';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'block';
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';

                        if (data.caregiverNeurodiversity && data.caregiverNeurodiversity.length > 0 && data.caregiverNeurodiversity[0] !== 'unsure_or_none') {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = data.caregiverNeurodiversity.map(nd => `<li>${getNeurodiversityText(nd)}</li>`).join('');
                        } else { if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = '<li>선택된 사항 없음</li>'; }
                        
                        if(childNameDisplayEl) childNameDisplayEl.textContent = data.childName || '정보 없음';
                        const childAgeVal = data.childBirthDate ? calculateAgeFromBirthDate(data.childBirthDate) : (data.childAge !== undefined ? data.childAge : null);
                        if(childFullAgeDisplayEl) childFullAgeDisplayEl.textContent = childAgeVal !== null ? `만 ${childAgeVal}세` : '정보 없음'; 
                        
                        if (data.childDiagnoses && data.childDiagnoses.length > 0 && data.childDiagnoses[0] !== 'NotApplicable' && data.childDiagnoses[0] !== 'Unsure') {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = data.childDiagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else { if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = '<li>특별히 선택된 항목 없음</li>'; }
                        if(childLozeeEmailDisplayEl) childLozeeEmailDisplayEl.textContent = data.childLozeeEmail || '연결 안 됨';
                        if(childConnectionStatusEl) childConnectionStatusEl.innerHTML = data.childLozeeEmail ? '<span class="connected" title="연결됨">🔗</span>' : '<span class="disconnected" title="연결 안 됨">💔</span>';
                    } else { // directUser (당사자)
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'block';
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'none';
                        if (data.diagnoses && data.diagnoses.length > 0 && data.diagnoses[0] !== 'NotApplicable' && data.diagnoses[0] !== 'Unsure') {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = data.diagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else { if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = '<li>선택된 항목 없음</li>'; }
                    }
                } else { 
                    if(userNameDisplayEl) userNameDisplayEl.textContent = '사용자 정보를 찾을 수 없어요.';
                    if(pageMainTitleEl) pageMainTitleEl.textContent = '내 정보';
                    console.warn(`Mypage: Firestore에 사용자 문서 없음 (${loggedInUserEmail})`);
                    if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';
                    if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                    if(childInfoCardEl) childInfoCardEl.style.display = 'none';
                }
            } catch (error) { 
                console.error("Mypage: 프로필 로드 중 오류:", error);
                if(userNameDisplayEl) userNameDisplayEl.textContent = '정보 로드 실패';
            }
        }
        

// 신경다양성 선택 옵션 (index.html과 동일한 옵션 사용)
const neurodiversityOptions = [
    { text: "자폐 스펙트럼 (ASD)", value: "ASD" },
    { text: "주의력 결핍 과잉행동 장애 (ADHD)", value: "ADHD" },
    { text: "아스퍼거 증후군 (고기능 자폐)", value: "Asperger" },
    { text: "틱 장애", value: "Tic" },
    { text: "학습 장애", value: "LD" },
    { text: "기타 어려움 또는 궁금증", value: "Else" },
    { text: "아직 잘 모르겠어요 / 진단 없음", value: "Unsure" },
    { text: "특별히 해당 없음", value: "NotApplicable" }
];
const caregiverNDOptionsList = [ // 보호자 본인/배우자용
    { text: "저(보호자 본인): 자폐 스펙트럼(ASD) 성향", value: "self_asd"},
    { text: "저(보호자 본인): ADHD 성향", value: "self_adhd"},
    { text: "배우자/관계인: 자폐 스펙트럼(ASD) 성향", value: "spouse_asd"},
    // ... (index.html의 caregiver-nd-btn 옵션과 동일하게)
    { text: "잘 모르거나 해당 사항 없어요.", value: "unsure_or_none"}
];

let currentEditingUserType = '';
let currentSelectedDiagnoses = [];
let currentSelectedCaregiverND = [];
let currentSelectedChildDiagnoses = [];



// --- 모달 내 선택 옵션 버튼 생성 함수 ---
function createOptionButtons(containerEl, options, currentSelectedArray, arrayToUpdate) {
    if (!containerEl) return;
    containerEl.innerHTML = '';
    options.forEach(opt => {
        const button = document.createElement('button');
        button.textContent = opt.text;
        button.dataset.value = opt.value;
        if (currentSelectedArray && currentSelectedArray.includes(opt.value)) {
            button.classList.add('selected');
        }
        button.onclick = () => {
            // 단독 선택 옵션 (NotApplicable, Unsure, unsure_or_none) 처리
            const isExclusive = (opt.value === 'NotApplicable' || opt.value === 'Unsure' || opt.value === 'unsure_or_none');
            if (isExclusive) {
                if (button.classList.contains('selected')) {
                    button.classList.remove('selected');
                    arrayToUpdate.length = 0; // 배열 비우기
                } else {
                    containerEl.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    arrayToUpdate.length = 0; // 배열 비우고
                    arrayToUpdate.push(opt.value); // 현재 옵션만 추가
                }
            } else { // 중복 선택 가능 옵션
                // 단독 선택 옵션이 눌려있었다면 해제
                containerEl.querySelectorAll('button').forEach(btn => {
                    if (btn.dataset.value === 'NotApplicable' || btn.dataset.value === 'Unsure' || btn.dataset.value === 'unsure_or_none') {
                        btn.classList.remove('selected');
                    }
                });
                const indexInExclusive = arrayToUpdate.findIndex(val => val === 'NotApplicable' || val === 'Unsure' || val === 'unsure_or_none');
                if (indexInExclusive > -1) arrayToUpdate.splice(indexInExclusive, 1);


                button.classList.toggle('selected');
                const index = arrayToUpdate.indexOf(opt.value);
                if (index > -1) {
                    arrayToUpdate.splice(index, 1);
                } else {
                    arrayToUpdate.push(opt.value);
                }
            }
            console.log("Updated selection:", arrayToUpdate);
        };
        containerEl.appendChild(button);
    });
}

// --- 프로필 수정 모달 열기 ---
if (editProfileBtn) {
    editProfileBtn.onclick = async () => {
        const loggedInUserEmail = localStorage.getItem('cbtUserEmail');
        currentEditingUserType = localStorage.getItem('lozee_userType') || '';
        if (loggedInUserEmail === 'unbearable_@naver.com') { currentEditingUserType = 'caregiver'; }


        if (!loggedInUserEmail || !currentEditingUserType) {
            alert("로그인 정보 또는 사용자 유형 정보가 없습니다.");
            return;
        }

        const userRef = doc(db, 'users', loggedInUserEmail);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            const data = userSnap.data();
            
            // 공통: 닉네임 채우기 (Firestore의 최상위 name 필드 사용)
            if(editNameInput) editNameInput.value = data.name || '';

            if (currentEditingUserType === 'directUser') {
                if(modalTitleEl) modalTitleEl.textContent = "나의 정보 수정";
                if(editDirectUserNDSection) editDirectUserNDSection.style.display = 'block';
                if(editCaregiverInfoSection) editCaregiverInfoSection.style.display = 'none';
                
                currentSelectedDiagnoses = data.directUser?.diagnoses || data.diagnoses || []; // 최상위 diagnoses도 고려
                if(editUserDiagnosesOptionsEl) createOptionButtons(editUserDiagnosesOptionsEl, neurodiversityOptions, currentSelectedDiagnoses, currentSelectedDiagnoses);

            } else if (currentEditingUserType === 'caregiver') {
                if(modalTitleEl) modalTitleEl.textContent = "보호자 및 아이/가족 정보 수정";
                if(editDirectUserNDSection) editDirectUserNDSection.style.display = 'none';
                if(editCaregiverInfoSection) editCaregiverInfoSection.style.display = 'block';

                // 보호자 본인 특성
                currentSelectedCaregiverND = data.caregiver?.caregiverNeurodiversity || data.caregiverNeurodiversity || [];
                if(editCaregiverNDOptionsEl) createOptionButtons(editCaregiverNDOptionsEl, caregiverNDOptionsList, currentSelectedCaregiverND, currentSelectedCaregiverND);
                
                // 아이/가족 정보 채우기
                const childData = data.caregiver || {}; // caregiver 맵 안에 child 정보가 있다고 가정
                if(editChildNameInput) editChildNameInput.value = childData.childName || '';
                
                if(editChildBirthYear && editChildBirthMonth && editChildBirthDay){
                    populateBirthSelects(editChildBirthYear, editChildBirthMonth, editChildBirthDay, 0, 20); // 자녀 나이 범위
                    if (childData.childBirthDate) {
                        const [year, month, day] = childData.childBirthDate.split('-');
                        editChildBirthYear.value = year;
                        editChildBirthMonth.value = parseInt(month, 10);
                        editChildBirthDay.value = parseInt(day, 10);
                    }
                }
                currentSelectedChildDiagnoses = childData.childDiagnoses || [];
                if(editChildDiagnosesOptionsEl) createOptionButtons(editChildDiagnosesOptionsEl, neurodiversityOptions, currentSelectedChildDiagnoses, currentSelectedChildDiagnoses);
                if(editChildLozeeEmailInput) editChildLozeeEmailInput.value = childData.childLozeeEmail || '';
            }
            if(profileEditModal) profileEditModal.style.display = 'flex';
        } else {
            alert("사용자 정보를 불러올 수 없습니다.");
        }
    };
}

// --- 프로필 변경사항 저장 ---
if (saveProfileChangesBtn) {
    saveProfileChangesBtn.onclick = async () => {
        const loggedInUserEmail = localStorage.getItem('cbtUserEmail');
        if (!loggedInUserEmail || !currentEditingUserType) {
            alert("오류: 사용자 정보가 없습니다.");
            return;
        }

        const userDocRef = doc(db, "users", loggedInUserEmail);
        const updatedData = {};

        // 공통: 닉네임 업데이트 (Firestore 최상위 name 필드)
        if (editNameInput && editNameInput.value.trim() !== '') {
            updatedData.name = editNameInput.value.trim();
        }

        if (currentEditingUserType === 'directUser') {
            // 당사자 맵 안에 저장하거나, Firestore 구조에 따라 최상위 필드로 저장
            // 스크린샷 구조를 따른다면:
            updatedData['directUser.name'] = editNameInput.value.trim() || (await getDoc(userDocRef)).data()?.directUser?.name; // 기존 이름 유지
            updatedData['directUser.diagnoses'] = currentSelectedDiagnoses;
            // 만약 name, age, birthDate가 directUser 맵 안에 있다면 여기서 함께 업데이트
            // updatedData['directUser.birthDate'] = ...
            // updatedData['directUser.age'] = ...
        } else if (currentEditingUserType === 'caregiver') {
            // 보호자 본인 정보 (Firestore 최상위 name 필드 또는 caregiver 맵 내부 name)
            updatedData['caregiver.name'] = editNameInput.value.trim() || (await getDoc(userDocRef)).data()?.caregiver?.name;
            updatedData['caregiver.caregiverNeurodiversity'] = currentSelectedCaregiverND;
            
            // 아이/가족 정보 (caregiver 맵 내부)
            if(editChildNameInput) updatedData['caregiver.childName'] = editChildNameInput.value.trim();
            if(editChildBirthYear && editChildBirthYear.value) {
                const y = editChildBirthYear.value;
                const m = editChildBirthMonth.value;
                const d = editChildBirthDay.value;
                if (y && m && d) {
                    updatedData['caregiver.childBirthDate'] = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    updatedData['caregiver.childAge'] = calculateAge(y,m,d);
                }
            }
            updatedData['caregiver.childDiagnoses'] = currentSelectedChildDiagnoses;
            if(editChildLozeeEmailInput) updatedData['caregiver.childLozeeEmail'] = editChildLozeeEmailInput.value.trim();
        }

        try {
            await setDoc(userDocRef, updatedData, { merge: true }); // 점 표기법 사용 시 mergeFields도 가능
            alert("프로필 정보가 성공적으로 업데이트되었습니다!");
            if(profileEditModal) profileEditModal.style.display = 'none';
            loadUserProfile(); // 변경된 정보 다시 로드
        } catch (error) {
            console.error("프로필 정보 업데이트 중 오류:", error);
            alert("프로필 정보 업데이트에 실패했습니다.");
        }
    };
}

// --- 프로필 수정 취소 ---
if (cancelProfileEditBtn) {
    cancelProfileEditBtn.onclick = () => {
        if(profileEditModal) profileEditModal.style.display = 'none';
    };
}




        function displayLozeePlans() {
            if (!lozeePlansEl) { console.warn("Mypage: lozeePlansEl 요소를 찾을 수 없습니다."); return; }
            lozeePlansEl.innerHTML = '<li>로딩 중...</li>'; 
            const plans = []; 
            const userType = localStorage.getItem('lozee_userType') || '';
            const continueTopicDataString = localStorage.getItem('lozee_continue_topic');
            if (continueTopicDataString) {
                try {
                    const topicToContinue = JSON.parse(continueTopicDataString);
                    const planItem = document.createElement('li');
                    planItem.innerHTML = `↪️ 저번에 이야기하다 멈춘 '<strong>${topicToContinue.details || '생각 패턴'}</strong>'에 대해 더 깊이 이야기 나눠보기로 했어요!`;
                    planItem.style.cursor = "pointer";
                    planItem.onclick = () => {
                        localStorage.setItem('lozee_talk_init_topic', JSON.stringify(topicToContinue)); 
                        window.location.href = 'talk.html';
                    };
                    plans.push(planItem);
                } catch (e) { console.error("이어하기 주제 파싱 오류", e); localStorage.removeItem('lozee_continue_topic');}
            }
            
            const needsLanguagePractice = localStorage.getItem('lozee_trigger_language_practice') === 'true';
            if (userType === 'directUser' && needsLanguagePractice) {
                 const langPlanItem = document.createElement('li');
                 langPlanItem.innerHTML = "🌱 로지와 함께 말솜씨 키우기 연습을 해볼까요? (클릭하면 시작 - 준비 중)";
                 langPlanItem.style.cursor = "pointer";
                 langPlanItem.onclick = () => {
                     alert("말솜씨 키우기 연습 기능은 열심히 준비 중이에요! 조금만 기다려주세요 😊");
                     // localStorage.removeItem('lozee_trigger_language_practice'); // 완료 시 제거
                 };
                 plans.push(langPlanItem);
            }

            if (plans.length > 0) {
                lozeePlansEl.innerHTML = ''; // 로딩 메시지 제거
                plans.forEach(planElement => lozeePlansEl.appendChild(planElement));
            } else {
                lozeePlansEl.innerHTML = '<li style="color:#777; font-style:italic;">아직 로지와의 특별한 약속은 없어요!</li>';
            }
        }

        async function displayRecentJournals() {
            if (!recentJournalCardListEl) { console.warn("Mypage: recentJournalCardListEl 요소를 찾을 수 없습니다."); return;}
            recentJournalCardListEl.innerHTML = '<p style="text-align:center; color:#777;">최근 이야기 목록을 불러오는 중...</p>'; 
            const loggedInUserEmail = localStorage.getItem('cbtUserEmail');
            const userType = localStorage.getItem('lozee_userType');
            let targetUserIdForJournals = loggedInUserEmail; 

            if (userType === 'caregiver') {
                const childEmail = localStorage.getItem('lozee_child_email');
                if (childEmail) { targetUserIdForJournals = childEmail; } 
                else { recentJournalCardListEl.innerHTML = '<p style="text-align:center; color:#777; padding: 20px 0;">아이/가족의 로지 계정이 연결되면 최근 대화를 볼 수 있어요.</p>'; return; }
            }
            if (!targetUserIdForJournals) { recentJournalCardListEl.innerHTML = '<p style="text-align:center; color:#777; padding: 20px 0;">최근 대화를 불러올 사용자 정보가 없어요.</p>'; return; }

            console.log("Mypage: 최근 저널 로드 시도 for userId -", targetUserIdForJournals);
            try {
                const q = query( collection(db, 'journals'), where('userId', '==', targetUserIdForJournals), orderBy('createdAt', 'desc'), limit(10) );
                const querySnapshot = await getDocs(q);
                console.log("Mypage: 최근 저널 쿼리 결과 size -", querySnapshot.size);

                if (querySnapshot.empty) {
                    recentJournalCardListEl.innerHTML = `<p style="text-align:center; color:#777; padding: 20px 0;">아직 로지와의 이야기가 충분히 쌓이지 않았나 봐요. 🤔</p>`;
                } else {
                    recentJournalCardListEl.innerHTML = ''; 
                    let sessionCounter = querySnapshot.size; 
                    querySnapshot.forEach((docSnap) => {
                        const journal = docSnap.data();
                        console.log("Mypage displayRecentJournals - 개별 저널 데이터:", journal); 
                        const card = document.createElement('div');
                        card.className = 'session-card-wide'; 
                        const dateStr = journal.createdAt?.toDate ? journal.createdAt.toDate().toLocaleDateString('ko-KR', {month: 'short', day: 'numeric'}) : '날짜 없음';
                        const title = journal.title || journal.topic || '제목 없는 이야기';
                        const summaryPreview = journal.summary ? journal.summary.substring(0, 100) + (journal.summary.length > 100 ? '...' : '') : '요약이 없어요.';
                        let lozeeAnalysisHTML = "";
                        if(journal.detailedAnalysis && journal.detailedAnalysis.overallSentiment) { 
                            let sentimentText = ""; let sentimentClass = "neutral";
                            const sentiment = String(journal.detailedAnalysis.overallSentiment).toLowerCase();
                            if (sentiment.includes("positive") || sentiment.includes("긍정")) { sentimentText = "긍정적인 대화였어요 👍"; sentimentClass = "positive"; }
                            else if (sentiment.includes("negative") || sentiment.includes("부정")) { sentimentText = "조금 힘든 대화였나봐요 😟"; sentimentClass = "negative"; }
                            else { sentimentText = "차분한 대화였어요 😌"; }
                            lozeeAnalysisHTML = `<div class="journal-analysis-banner ${sentimentClass}">${sentimentText}</div>`;
                        }
                        card.innerHTML = `<div class="session-header"><span class="session-date">${dateStr}</span><span class="session-meta">${sessionCounter}회차</span></div><h3>${title}</h3><p class="session-summary">${summaryPreview}</p>${lozeeAnalysisHTML}`;
                        card.onclick = () => { 
                            localStorage.setItem('lozee_selected_journal_id', docSnap.id); 
                            localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                                results: journal.detailedAnalysis || {},
                                accumulatedDurationMinutes: journal.sessionDurationMinutes || 0,
                                accumulatedUserCharCount: journal.userCharCountForThisSession || 0, 
                                journalId: docSnap.id,
                                journalTitle: title, 
                                journalDate: journal.createdAt?.toDate ? journal.createdAt.toDate().toISOString() : null,
                                journalSummaryFull: journal.summary 
                            }));
                            window.location.href = `journal.html?journalId=${docSnap.id}`; 
                        };
                        recentJournalCardListEl.appendChild(card);
                        sessionCounter--; 
                    });
                }
            } catch (error) { console.error("Mypage: 최근 저널 로드 중 오류:", error); recentJournalCardListEl.innerHTML = '<p style="text-align:center; color:red; padding: 20px 0;">최근 대화를 불러오는 데 문제가 생겼어요. 😥</p>'; }
        }

        if(goToJournalListBtn) { goToJournalListBtn.onclick = () => { window.location.href = 'journal-list.html'; }; }
        else { console.warn("Mypage: goToJournalListBtn 요소를 찾을 수 없습니다.");}
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Mypage: DOMContentLoaded");
            loadUserProfile();
            displayLozeePlans(); 
            displayRecentJournals(); 
        });
    </script>
    <script src="./js/gnb.js" defer></script> 
</body>
</html>