<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTitle">ë§ˆì´ ë¡œì§€</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <style>
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
            --profile-placeholder-bg: #d0d9ff;
            --light-blue-bg: #eef2f7;
            --action-button-bg: #6078ea;
            --danger-alert-bg: #ffebee;
            --danger-alert-border: #e57373;
            --danger-alert-text: #c62828;
        }
        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        .page-title { color: var(--primary-color); text-align: center; font-size: 2em; margin-bottom: 30px; font-weight: 700; }

        .profile-section { display: grid; grid-template-columns: auto 1fr; gap: 20px; background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; align-items: center; }
        .profile-photo-container { display: flex; justify-content: center; align-items: center; }
        .profile-photo-placeholder { width: 100px; height: 100px; border-radius: 50%; background-color: var(--profile-placeholder-bg); display: flex; align-items: center; justify-content: center; font-size: 2em; color: white; font-weight: bold; cursor: pointer; }
        .profile-photo-placeholder img { width:100%; height:100%; border-radius:50%; object-fit:cover;}
        .profile-details h2 { font-size: 1.5em; color: var(--primary-color); margin-top: 0; margin-bottom: 5px; text-align:left;}
        .profile-details .user-email { font-size: 0.9em; color: #777; margin-bottom:15px; text-align:left;}

        .info-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }
        .info-card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .plans-card, .emergency-alerts-card { grid-column: 1 / -1; }

        .info-card h2 { font-size: 1.2em; color: var(--primary-color); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; text-align:left;}
        .info-item { margin-bottom: 10px; font-size: 1em; display: flex; justify-content: space-between; align-items: baseline;}
        .info-item .label { font-weight: bold; color: #555; margin-right: 10px; white-space: nowrap; }
        .info-item .value { color: var(--text-color); text-align: right; word-break: keep-all; }
        .neurodiversity-info ul { list-style: none; padding:0; margin:0; text-align:left; }
        .neurodiversity-info li { background-color: #e9eaf6; color: #3f51b5; padding: 6px 10px; border-radius: 15px; font-size: 0.9em; display: inline-block; margin-right: 8px; margin-bottom: 8px;}

        .plans-card ul { list-style: none; padding: 0; text-align: left; }
        .plans-card li { background-color: #eef2f7; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.95em; cursor:pointer; transition: background-color 0.2s; }
        .plans-card li:hover { background-color: #dbe4f0; }

        .emergency-alerts-card { margin-top: 20px; }
        .emergency-alerts-card h2 { color: var(--danger-alert-text); border-bottom-color: var(--danger-alert-border); }
        .emergency-alerts-card ul { list-style: none; padding: 0; margin: 0; }
        .emergency-alerts-card li { background-color: var(--danger-alert-bg); color: var(--danger-alert-text); border: 1px solid var(--danger-alert-border); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s; }
        .emergency-alerts-card li:hover { background-color: #ffcdd2; }
        .emergency-alerts-card li .alert-date { font-size: 0.8em; display: block; color: #d32f2f; margin-top: 5px; }
        .emergency-alerts-card .no-alerts { text-align: center; color: #777; padding: 15px 0; }

        .recent-journals-section h2 { text-align: center; font-size: 1.4em; color: var(--primary-color); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .recent-journal-card-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .session-card-wide { background-color: var(--card-bg); border-radius: 10px; padding: 15px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-left: 4px solid var(--secondary-color); display: flex; flex-direction: column; cursor: pointer; transition: box-shadow 0.2s;}
        .session-card-wide:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        .session-card-wide .session-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .session-card-wide .session-date { font-size: 0.85em; color: #777; }
        .session-card-wide .session-meta { font-size: 0.85em; color: var(--primary-color); font-weight: bold; }
        .session-card-wide .topic-info { font-size: 0.8em; color: #888; margin-bottom: 5px; font-style: italic;}
        .session-card-wide h3 { font-size: 1.1em; color: var(--text-color); margin-top: 0; margin-bottom: 8px; font-weight: 500; }
        .session-card-wide .session-summary { font-size: 0.9em; color: #555; margin-bottom: 10px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(0.9em * 1.5 * 2); }
        .journal-analysis-banner { padding: 8px 12px; border-radius: 6px; margin-top: 10px; font-size: 0.85em; text-align: center; }
        .journal-analysis-banner.positive { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9;}
        .journal-analysis-banner.neutral { background-color: #eceff1; color: #37474f; border: 1px solid #cfd8dc;}
        .journal-analysis-banner.negative { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2;}

        .action-button { display: inline-block; margin-top: 15px; background-color: var(--primary-color); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .action-button:hover { background-color: var(--secondary-color); }
        .view-all-journals-btn { display: block; width: fit-content; margin: 20px auto 0 auto; }
        .connection-status { margin-left: 8px; font-size: 0.9em; }
        .connection-status .connected { color: green; font-weight: bold; }
        .connection-status .disconnected { color: #aaa; }
        .module-explanation { font-size:0.9em; color:#555; margin-bottom:15px; padding: 10px; background-color: var(--light-blue-bg); border-radius: 6px; line-height: 1.6; text-align: left; }

        @media (min-width: 701px) {
            .info-grid { grid-template-columns: repeat(2, 1fr); }
            .info-card:not(.plans-card):not(.emergency-alerts-card) { grid-column: auto; }
        }
        @media (max-width: 700px) {
            .profile-section { grid-template-columns: 1fr; text-align: center; }
            .profile-details h2, .profile-details .user-email { text-align: center; }
            .info-item { flex-direction: column; align-items: flex-start; }
            .info-item .value { text-align: left; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="./js/gnb.js" defer></script>
</head>
<body>
        <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
            <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a>
            <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a>
            <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a>
            <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a>
            <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
        </div>
    </nav>

    <main class="container">
        <h1 id="pageMainTitle" class="page-title">ğŸ¨ ë§ˆì´ ë¡œì§€</h1>

        <div class="profile-section">
            <div class="profile-photo-container">
                <div id="userPhotoPlaceholder" class="profile-photo-placeholder">L</div>
            </div>
            <div class="profile-details">
                <h2 id="userNameDisplay">ì •ë³´ ë¡œë”© ì¤‘...</h2>
                <p id="userEmailDisplay" class="user-email">ì´ë©”ì¼ ì •ë³´ ë¡œë”© ì¤‘...</p>
                <div class="info-item"><span class="label" id="ageLabel">ë§Œ ë‚˜ì´:</span> <span id="userFullAge" class="value">ë¡œë”© ì¤‘...</span></div>
                <div class="info-item"><span class="label">ë§ˆì§€ë§‰ ì ‘ì†:</span> <span id="lastLoginDate" class="value">ë¡œë”© ì¤‘...</span></div>
                <div class="info-item"><span class="label" id="sessionCountLabel">ë¡œì§€ì™€ì˜ ì´ ëŒ€í™”:</span> <span id="totalSessionsCount" class="value">ë¡œë”© ì¤‘...</span></div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card neurodiversity-info" id="directUserDiagnosisCard" style="display:none;">
                <h2>âœ¨ ë‚˜ì˜ íŠ¹ì„± ì´í•´í•˜ê¸°</h2>
                <p class="module-explanation">ë‚´ê°€ ì„ íƒí–ˆë˜ ë‚˜ì˜ íŠ¹ì„±ë“¤ì´ì•¼. ì´ íŠ¹ì„±ë“¤ì€ ë¡œì§€ì™€ì˜ ëŒ€í™”ì— ì°¸ê³ ë  ìˆ˜ ìˆì–´!</p>
                <ul id="userDiagnosesList"><li>ì •ë³´ ë¡œë”© ì¤‘...</li></ul>
            </div>

            <div class="info-card neurodiversity-info" id="caregiverPersonalNDCard" style="display:none;">
                <h2>ğŸ™‹â€â™€ï¸ ë³´í˜¸ìë‹˜ íŠ¹ì„± ì´í•´</h2>
                <p class="module-explanation">ë³´í˜¸ìë‹˜ ë˜ëŠ” ë°°ìš°ìë‹˜ì˜ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±ì„ ì´í•´í•˜ëŠ” ê²ƒì€ ì–‘ìœ¡ê³¼ ê´€ê³„ì— ì¤‘ìš”í•œ ì²«ê±¸ìŒì´ ë  ìˆ˜ ìˆì–´ìš”.</p>
                <ul id="caregiverPersonalNeurodiversityList"><li>ì •ë³´ ë¡œë”© ì¤‘...</li></ul>
            </div>

            <div class="info-card child-info-card" id="childInfoCard" style="display:none;">
                <h2>ğŸ§¸ ì•„ì´/ê°€ì¡± ì •ë³´</h2>
                <p class="info-item"><span class="label">ì´ë¦„:</span> <span id="childNameDisplay" class="value">ë¡œë”© ì¤‘...</span></p>
                <p class="info-item"><span class="label">ë§Œ ë‚˜ì´:</span> <span id="childFullAgeDisplay" class="value">ë¡œë”© ì¤‘...</span></p>
                <p class="info-item"><span class="label">íŠ¹ì„± ì´í•´:</span></p>
                <ul id="childDiagnosesList" style="margin-top: -5px; margin-bottom:10px; text-align:left;"><li>ì •ë³´ ë¡œë”© ì¤‘...</li></ul>
                <p class="info-item" style="margin-top:15px;">
                    <span class="label">ì—°ê²°ëœ ë¡œì§€ ê³„ì • (ìë…€UID):</span>
                    <span id="childLozeeUidDisplay" class="value">ë¡œë”© ì¤‘...</span>
                    <span id="childConnectionStatus" class="connection-status"></span>
                </p>
            </div>

            <div class="info-card plans-card">
                <h2>ğŸ¤ ë¡œì§€ì™€ì˜ ì•½ì†! (ê°œì„  ê³„íš)</h2>
                <p class="module-explanation">ë¡œì§€ë‘ ì´ëŸ° ì´ì•¼ê¸°ë¥¼ ë” ë‚˜ëˆ„ê¸°ë¡œ í–ˆì—ˆì§€! ì–¸ì œë“  ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´.</p>
                <ul id="lozeePlans"><li>ì•½ì†ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
            </div>

            <div class="info-card emergency-alerts-card" id="emergencyAlertsSection" style="display:none;">
                <h2>ğŸš¨ ê¸´ê¸‰ ì•Œë¦¼: ì•„ì´/ê°€ì¡± í™•ì¸ í•„ìš” ğŸš¨</h2>
                <p class="module-explanation">ì•„ì´ ë˜ëŠ” ê°€ì¡± êµ¬ì„±ì›ì˜ ëŒ€í™”ì—ì„œ ì£¼ì˜ê°€ í•„ìš”í•œ ë‚´ìš©ì´ ê°ì§€ë˜ì—ˆì–´ìš”. ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                <ul id="emergencyAlertsList"></ul>
            </div>
        </div>

        <div class="section recent-journals-section">
            <h2 class="recent-journals-title">ğŸ’¬ ìµœê·¼ì— ë‚˜ëˆˆ ì´ì•¼ê¸°ë“¤</h2>
            <div id="recentJournalCardList" class="recent-journal-card-list">
                <p style="text-align:center; color:#777;">ìµœê·¼ ì´ì•¼ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <button id="goToJournalListBtn" class="action-button view-all-journals-btn">ğŸ“– ì „ì²´ ì´ì•¼ê¸° ëª¨ìŒì§‘ ê°€ê¸°</button>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script>

    <script type="module">
     import { db } from './js/firebase-config.js';
     import {
        doc, getDoc, updateDoc, // updateDoc ì¶”ê°€
        collection, query, where, orderBy, limit,
        getDocs, getCountFromServer
     } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTitleEl = document.querySelector('title');
        const userPhotoPlaceholderEl = document.getElementById('userPhotoPlaceholder');
        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const userEmailDisplayEl = document.getElementById('userEmailDisplay');
        const ageLabelEl = document.getElementById('ageLabel');
        const userFullAgeEl = document.getElementById('userFullAge');
        const lastLoginDateEl = document.getElementById('lastLoginDate');
        const sessionCountLabelEl = document.getElementById('sessionCountLabel');
        const totalSessionsCountEl = document.getElementById('totalSessionsCount');

        const directUserDiagnosisCardEl = document.getElementById('directUserDiagnosisCard');
        const userDiagnosesListEl = document.getElementById('userDiagnosesList');

        const caregiverPersonalNDCardEl = document.getElementById('caregiverPersonalNDCard');
        const caregiverPersonalNeurodiversityListEl = document.getElementById('caregiverPersonalNeurodiversityList');

        const childInfoCardEl = document.getElementById('childInfoCard');
        const childNameDisplayEl = document.getElementById('childNameDisplay');
        const childFullAgeDisplayEl = document.getElementById('childFullAgeDisplay');
        const childDiagnosesListEl = document.getElementById('childDiagnosesList');
        const childLozeeUidDisplayEl = document.getElementById('childLozeeUidDisplay'); // ID ë³€ê²½ë¨
        const childConnectionStatusEl = document.getElementById('childConnectionStatus');

        const lozeePlansEl = document.getElementById('lozeePlans');
        const emergencyAlertsSectionEl = document.getElementById('emergencyAlertsSection');
        const emergencyAlertsListEl = document.getElementById('emergencyAlertsList');
        const recentJournalCardListEl = document.getElementById('recentJournalCardList');
        const goToJournalListBtn = document.getElementById('goToJournalListBtn');

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function calculateAgeFromBirthDate(birthDateStr) {
            if (!birthDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(birthDateStr)) { console.warn("calculateAge: ìœ íš¨í•˜ì§€ ì•Šì€ birthDateStr í˜•ì‹:", birthDateStr); return null; }
            try {
                const birthDate = new Date(birthDateStr);
                if (isNaN(birthDate.getTime())) { console.warn("calculateAge: ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ ê°ì²´:", birthDateStr); return null; }
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
                return age >= 0 ? age : null;
            } catch (e) { console.error("calculateAgeFromBirthDate ì˜¤ë¥˜:", e, "ì…ë ¥ê°’:", birthDateStr); return null; }
        }

        function getNeurodiversityText(code) {
            const map = { "ASD": "ìí ìŠ¤í™íŠ¸ëŸ¼ (ASD)", "ADHD": "ì£¼ì˜ë ¥ ê²°í• ê³¼ì‰í–‰ë™ ì¥ì•  (ADHD)", "Asperger": "ì•„ìŠ¤í¼ê±° ì¦í›„êµ°", "Tic": "í‹± ì¥ì• ", "LD": "í•™ìŠµ ì¥ì• ", "Else": "ê¸°íƒ€ ì–´ë ¤ì›€/ê¶ê¸ˆì¦", "Unsure": "ì•„ì§ ì˜ ëª¨ë¦„/ì§„ë‹¨ ì—†ìŒ", "NotApplicable": "íŠ¹ë³„íˆ í•´ë‹¹ ì—†ìŒ", "self_asd": "ë³¸ì¸: ìí ìŠ¤í™íŠ¸ëŸ¼(ASD) ì„±í–¥", "self_adhd": "ë³¸ì¸: ADHD ì„±í–¥", "spouse_asd": "ë°°ìš°ì/ê´€ê³„ì¸: ìí ìŠ¤í™íŠ¸ëŸ¼(ASD) ì„±í–¥", "spouse_adhd": "ë°°ìš°ì/ê´€ê³„ì¸: ADHD ì„±í–¥", "self_else": "ë³¸ì¸: ê¸°íƒ€ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±", "spouse_else": "ë°°ìš°ì/ê´€ê³„ì¸: ê¸°íƒ€ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±", "unsure_or_none": "ì˜ ëª¨ë¥´ê±°ë‚˜ í•´ë‹¹ ì‚¬í•­ ì—†ìŒ" };
            return map[code] || code;
        }

        // --- ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ë° í‘œì‹œ ---
        async function loadUserProfile() {
            const loggedInUserId = localStorage.getItem('lozee_userId'); // â­ UID ì‚¬ìš©
            const userType = localStorage.getItem('lozee_userType') || ''; // 'directUser' ë˜ëŠ” 'caregiver'

            console.log("Mypage loadUserProfile - ì´ˆê¸° loggedInUserId:", loggedInUserId, "userType:", userType);

            if (!loggedInUserId) {
                if(pageMainTitleEl) pageMainTitleEl.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”';
                if(userNameDisplayEl) userNameDisplayEl.textContent = 'ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ';
                if(userEmailDisplayEl) userEmailDisplayEl.textContent = '';
                [directUserDiagnosisCardEl, caregiverPersonalNDCardEl, childInfoCardEl, emergencyAlertsSectionEl, lozeePlansEl.parentElement].forEach(el => { if(el) el.style.display = 'none'; });
                return;
            }
            if (!userType) {
                if(pageMainTitleEl) pageMainTitleEl.textContent = 'ì‚¬ìš©ì ìœ í˜• ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
                 [directUserDiagnosisCardEl, caregiverPersonalNDCardEl, childInfoCardEl, emergencyAlertsSectionEl, lozeePlansEl.parentElement].forEach(el => { if(el) el.style.display = 'none'; });
                return;
            }

            const userRef = doc(db, 'users', loggedInUserId);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    console.log("Mypage: Firestore ì‚¬ìš©ì ë°ì´í„° (users ì»¬ë ‰ì…˜):", JSON.stringify(data, null, 2).substring(0, 500) + "...");

                    if(userEmailDisplayEl && data.email) { // Firestoreì— email í•„ë“œê°€ ìˆë‹¤ë©´ í‘œì‹œ
                        userEmailDisplayEl.textContent = data.email;
                    } else if (userEmailDisplayEl) {
                        userEmailDisplayEl.textContent = 'ì´ë©”ì¼ ì •ë³´ ì—†ìŒ';
                    }


                    let loggedInUserName = data.name || (userType === 'caregiver' ? 'ë³´í˜¸ìë‹˜' : 'ì¹œêµ¬');
                    let loggedInUserBirthDate = data.birthDate; // Firestoreì˜ users/{UID}/birthDate
                    let loggedInUserAge = data.age; // Firestoreì˜ users/{UID}/age

                    // userTypeì— ë”°ë¼ 'caregiver' ë˜ëŠ” 'directUser' ë§µì—ì„œ ì´ë¦„, ìƒì¼, ë‚˜ì´ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ (ì„ íƒì )
                    if (userType === 'caregiver' && data.caregiver) {
                        loggedInUserName = data.caregiver.name || loggedInUserName;
                        loggedInUserBirthDate = data.caregiver.birthDate || loggedInUserBirthDate;
                        loggedInUserAge = data.caregiver.age !== undefined ? data.caregiver.age : loggedInUserAge;
                    } else if (userType === 'directUser' && data.directUser) {
                        loggedInUserName = data.directUser.name || loggedInUserName;
                        loggedInUserBirthDate = data.directUser.birthDate || loggedInUserBirthDate;
                        loggedInUserAge = data.directUser.age !== undefined ? data.directUser.age : loggedInUserAge;
                    }


                    if ((loggedInUserAge === undefined || loggedInUserAge === null) && loggedInUserBirthDate) {
                        loggedInUserAge = calculateAgeFromBirthDate(loggedInUserBirthDate);
                    }
                    localStorage.setItem('lozee_username_for_mypage', loggedInUserName);

                    if(pageTitleEl) pageTitleEl.textContent = `${loggedInUserName}ì˜ ë§ˆì´ ë¡œì§€`;
                    if(pageMainTitleEl) pageMainTitleEl.textContent = `${loggedInUserName}ë‹˜ì˜ ë§ˆì´ ë¡œì§€ ğŸ¨`;
                    if(userNameDisplayEl) userNameDisplayEl.textContent = loggedInUserName;
                    if(userFullAgeEl) userFullAgeEl.textContent = loggedInUserAge !== null ? `ë§Œ ${loggedInUserAge}ì„¸` : 'ì •ë³´ ì—†ìŒ';
                    if(ageLabelEl) ageLabelEl.textContent = (userType === 'caregiver' ? "ë³´í˜¸ìë‹˜ ë§Œ ë‚˜ì´:" : "ë§Œ ë‚˜ì´:");

                    if (userPhotoPlaceholderEl) {
                        if (data.photoURL) { userPhotoPlaceholderEl.innerHTML = `<img src="${data.photoURL}" alt="${loggedInUserName} ì‚¬ì§„">`;}
                        else { userPhotoPlaceholderEl.textContent = loggedInUserName.charAt(0).toUpperCase() || 'ğŸ˜Š';}
                    }

                    if(lastLoginDateEl) {
                        if (data.lastLogin && typeof data.lastLogin.toDate === 'function') {
                            lastLoginDateEl.textContent = data.lastLogin.toDate().toLocaleString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
                        } else { lastLoginDateEl.textContent = 'ê¸°ë¡ ì—†ìŒ'; }
                    }

                    // --- â€œì´ ëŒ€í™” íšŸìˆ˜â€ ê³„ì‚° & í‘œì‹œ ë¡œì§ (UID ê¸°ë°˜) ---
                    let queryForCount;
                    let countLabelText = "ë¡œì§€ì™€ì˜ ì´ ëŒ€í™”:"; // ê¸°ë³¸ê°’

                    if (userType === 'caregiver') {
                        // ë³´í˜¸ìì˜ ê²½ìš°, ì—°ê²°ëœ ìë…€ì˜ UIDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                        const targetChildUid = localStorage.getItem('lozee_childId') || data.caregiver?.childLozeeUid || data.childLozeeUid; // Firestore í•„ë“œëª… í™•ì¸ í•„ìš”
                        if (targetChildUid) {
                            // ìë…€ì˜ ì €ë„ ìˆ˜ë¥¼ ì…‰ë‹ˆë‹¤ (ìë…€ê°€ ì§ì ‘ ì‘ì„±í•œ ì €ë„ ê¸°ì¤€).
                            queryForCount = query(
                                collection(db, 'journals'),
                                where('userId', '==', targetChildUid) // ìë…€ì˜ UIDë¡œ ìë…€ì˜ ì €ë„ì„ ì¿¼ë¦¬
                            );
                            countLabelText = `ì•„ì´/ê°€ì¡± ì´ ëŒ€í™”:`;
                        } else {
                            console.warn("Mypage: ë³´í˜¸ì ëª¨ë“œì´ë‚˜ ì—°ê²°ëœ ìë…€ UIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            totalSessionsCountEl.textContent = `0íšŒ`; // ìë…€ ì •ë³´ ì—†ìœ¼ë©´ 0íšŒ
                        }
                    } else { // directUser (ë‹¹ì‚¬ì)
                        queryForCount = query(
                            collection(db, 'journals'),
                            where('userId', '==', loggedInUserId) // ë³¸ì¸ UIDë¡œ ì¿¼ë¦¬
                        );
                    }
                    if(sessionCountLabelEl) sessionCountLabelEl.textContent = countLabelText;


                    if (queryForCount) {
                        try {
                            const snapshot = await getCountFromServer(queryForCount);
                            const totalCount = snapshot.data().count || 0;
                            if(totalSessionsCountEl) totalSessionsCountEl.textContent = `${totalCount}íšŒ`;
                        } catch (countError) {
                            console.error("Mypage: journals count ê°€ì ¸ì˜¤ë˜ ì¤‘ ì˜¤ë¥˜:", countError);
                            if(totalSessionsCountEl) totalSessionsCountEl.textContent = `0íšŒ (ì˜¤ë¥˜)`;
                        }
                    } else if (userType === 'directUser') { // ë‹¹ì‚¬ìì¸ë° queryForCountê°€ ìƒì„± ì•ˆ ëœ ê²½ìš° (ê±°ì˜ ë°œìƒ ì•ˆ í•¨)
                         if(totalSessionsCountEl) totalSessionsCountEl.textContent = `0íšŒ`;
                    }


                    // ì‚¬ìš©ì ìœ í˜•ë³„ ìƒì„¸ ì •ë³´ ì¹´ë“œ í‘œì‹œ
                    if (userType === 'directUser') {
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'block';
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'none';
                        if(emergencyAlertsSectionEl) emergencyAlertsSectionEl.style.display = 'none';

                        const diagnoses = data.diagnoses || data.directUser?.diagnoses || [];
                        if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = (diagnoses.length > 0 && diagnoses[0] !== 'NotApplicable' && diagnoses[0] !== 'Unsure')
                            ? diagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('')
                            : '<li>ì„ íƒëœ íŠ¹ì„± ì—†ìŒ</li>';
                    } else if (userType === 'caregiver') {
                        const caregiverData = data.caregiver || {};
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'block';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'block';
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';
                        if(emergencyAlertsSectionEl) emergencyAlertsSectionEl.style.display = 'block';

                        const caregiverND = caregiverData.caregiverNeurodiversity || [];
                        if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = (caregiverND.length > 0 && caregiverND[0] !== 'unsure_or_none')
                            ? caregiverND.map(nd => `<li>${getNeurodiversityText(nd)}</li>`).join('')
                            : '<li>ì„ íƒëœ ì‚¬í•­ ì—†ìŒ</li>';

                        const childName = caregiverData.childName || 'ì •ë³´ ì—†ìŒ';
                        if(childNameDisplayEl) childNameDisplayEl.textContent = childName;
                        localStorage.setItem('lozee_childName_for_mypage', childName);

                        const childBirthDt = caregiverData.childBirthDate;
                        const childStoredAge = caregiverData.childAge;
                        const childAgeVal = childBirthDt ? calculateAgeFromBirthDate(childBirthDt) : (childStoredAge !== undefined ? childStoredAge : null);
                        if(childFullAgeDisplayEl) childFullAgeDisplayEl.textContent = childAgeVal !== null ? `ë§Œ ${childAgeVal}ì„¸` : 'ì •ë³´ ì—†ìŒ';

                        const cDiagnoses = caregiverData.childDiagnoses || [];
                        if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = (cDiagnoses.length > 0 && cDiagnoses[0] !== 'NotApplicable' && cDiagnoses[0] !== 'Unsure')
                            ? cDiagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('')
                            : '<li>íŠ¹ë³„íˆ ì„ íƒëœ í•­ëª© ì—†ìŒ</li>';

                        const cLozeeUid = caregiverData.childLozeeUid || 'ì—°ê²° ì•ˆ ë¨';
                        if(childLozeeUidDisplayEl) childLozeeUidDisplayEl.textContent = cLozeeUid;
                        if(childConnectionStatusEl) childConnectionStatusEl.innerHTML = (cLozeeUid && cLozeeUid !=='ì—°ê²° ì•ˆ ë¨') ? '<span class="connected" title="ì—°ê²°ë¨">ğŸ”—</span>' : '<span class="disconnected" title="ì—°ê²° ì•ˆ ë¨">ğŸ’”</span>';
                    }
                } else {
                    if(userNameDisplayEl) userNameDisplayEl.textContent = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.';
                    if(pageMainTitleEl) pageMainTitleEl.textContent = 'ë‚´ ì •ë³´';
                    console.warn(`Mypage: Firestoreì— ì‚¬ìš©ì ë¬¸ì„œ ì—†ìŒ (UID: ${loggedInUserId})`);
                     [directUserDiagnosisCardEl, caregiverPersonalNDCardEl, childInfoCardEl, emergencyAlertsSectionEl, lozeePlansEl.parentElement].forEach(el => { if(el) el.style.display = 'none'; });
                }
            } catch (error) {
                console.error("Mypage: í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(userNameDisplayEl) userNameDisplayEl.textContent = 'ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
            }
        }

        // --- 'ë¡œì§€ì™€ì˜ ì•½ì†' (ê°œì„  ê³„íš) í‘œì‹œ í•¨ìˆ˜ ---
        function displayLozeePlans() {
            const loggedInUserId = localStorage.getItem('lozee_userId'); // UID ì‚¬ìš©
            if (!loggedInUserId || !lozeePlansEl) {
                if (lozeePlansEl) lozeePlansEl.innerHTML = '<li>ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ ì•½ì†ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            lozeePlansEl.innerHTML = '<li><p>ì•½ì†ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></li>';

            const plansDataString = localStorage.getItem('lozee_improvement_plans');
            if (!plansDataString) {
                lozeePlansEl.innerHTML = '<li><p>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¡œì§€ì™€ì˜ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š<br>ì´ì•¼ê¸° ë¶„ì„ í›„ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p></li>';
                return;
            }
            try {
                const plans = JSON.parse(plansDataString);
                if (!Array.isArray(plans) || plans.length === 0) {
                    lozeePlansEl.innerHTML = '<li><p>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¡œì§€ì™€ì˜ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š<br>ì´ì•¼ê¸° ë¶„ì„ í›„ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p></li>';
                    return;
                }
                lozeePlansEl.innerHTML = '';
                plans.forEach((plan, index) => {
                    const listItem = document.createElement('li');
                    let planText = '';
                    let icon = 'ğŸ“';
                    if (plan.type === 'cognitive_distortion') {
                        icon = 'ğŸ¤”';
                        planText = `[ìƒê° ìŠµê´€ ì ê²€] "${plan.topic || plan.details || 'íŠ¹ì • ìƒê°'}"ì— ëŒ€í•´ ë” ê¹Šì´ ì´ì•¼ê¸° ë‚˜ëˆ„ê¸°`;
                    } else if (plan.type === 'language_practice') {
                        icon = 'ğŸ—£ï¸';
                        planText = `[ë§ì†œì”¨ ì—°ìŠµ] "${plan.topic || plan.details || 'ì–¸ì–´ í‘œí˜„'}" ê´€ë ¨ ì—°ìŠµí•˜ê¸° (ì˜ˆìƒ ì—°ë ¹: ${plan.predictedAge || 'N/A'}, ì‹¤ì œ ì—°ë ¹: ${plan.userAge || 'N/A'})`;
                    } else {
                        planText = plan.title || plan.details || `ì•½ì† ${index + 1}`;
                    }
                    listItem.innerHTML = `${icon} ${planText}`;
                    if(plan.details) listItem.title = `ìƒì„¸: ${plan.details}`;
                    listItem.onclick = () => {
                        const continueTopicData = {
                            type: 'continue_improvement_plan', planType: plan.type,
                            details: plan.topic || plan.details,
                            prompt: plan.promptForContinuation || `"${plan.details || planText}" ì•½ì†ì— ëŒ€í•´ ì´ì•¼ê¸° ì´ì–´ê°ˆê¹Œìš”?`,
                        };
                        localStorage.setItem('lozee_talk_init_topic', JSON.stringify(continueTopicData));
                        window.location.href = 'talk.html';
                    };
                    lozeePlansEl.appendChild(listItem);
                });
            } catch (error) {
                console.error("Mypage: ë¡œì§€ì™€ì˜ ì•½ì† ë¡œë“œ/íŒŒì‹± ì¤‘ ì˜¤ë¥˜:", error);
                lozeePlansEl.innerHTML = '<li><p>ì•½ì†ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥</p></li>';
                localStorage.removeItem('lozee_improvement_plans');
            }
        }

        // --- ê¸´ê¸‰ ì•Œë¦¼ ë¡œë“œ ë° í‘œì‹œ í•¨ìˆ˜ ---
        async function displayEmergencyAlerts() {
            const loggedInUserId = localStorage.getItem('lozee_userId'); // UID ì‚¬ìš©
            const userType = localStorage.getItem('lozee_userType');

            if (userType !== 'caregiver' || !loggedInUserId) {
                if (emergencyAlertsSectionEl) emergencyAlertsSectionEl.style.display = 'none';
                return;
            }
            if (!emergencyAlertsSectionEl || !emergencyAlertsListEl) {
                console.warn("Mypage: ê¸´ê¸‰ ì•Œë¦¼ ê´€ë ¨ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            emergencyAlertsSectionEl.style.display = 'block';
            emergencyAlertsListEl.innerHTML = '<li><p>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></li>';
            try {
                const q = query(
                    collection(db, "notifications"),
                    where("parentId", "==", loggedInUserId), // ë¶€ëª¨ UIDë¡œ ì¿¼ë¦¬
                    orderBy("createdAt", "desc"),
                    limit(5)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    emergencyAlertsListEl.innerHTML = '<li><p class="no-alerts">ìƒˆë¡œìš´ ê¸´ê¸‰ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š</p></li>';
                } else {
                    emergencyAlertsListEl.innerHTML = '';
                    querySnapshot.forEach((docSnap) => {
                        const alertData = docSnap.data();
                        const listItem = document.createElement('li');
                        const alertDate = alertData.createdAt?.toDate
                            ? alertData.createdAt.toDate().toLocaleString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                            : 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                        const childNameForAlert = localStorage.getItem('lozee_childName_for_mypage') || alertData.childName || `ì•„ì´ (ID: ${String(alertData.childId || '').substring(0,6)}...)`;
                        listItem.innerHTML = `<strong>[${childNameForAlert}] ${alertData.message || 'í™•ì¸ í•„ìš”í•œ ë‚´ìš© ê°ì§€'}</strong><span class="alert-date">${alertDate}</span>`;
                        if (alertData.journalId) {
                            listItem.style.cursor = "pointer";
                            listItem.onclick = async () => {
                                try {
                                    const journalRef = doc(db, "journals", alertData.journalId);
                                    const journalSnap = await getDoc(journalRef);
                                    if (journalSnap.exists()) {
                                        const journalData = journalSnap.data();
                                        localStorage.setItem('lozee_selected_journal_id', alertData.journalId);
                                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                                            results: journalData.detailedAnalysis || {},
                                            accumulatedDurationMinutes: journalData.sessionDurationMinutes || 0,
                                            accumulatedUserCharCount: journalData.userCharCountForThisSession || 0,
                                            journalId: alertData.journalId,
                                            journalTitle: journalData.title,
                                            journalDate: journalData.createdAt?.toDate ? journalData.createdAt.toDate().toISOString() : null,
                                            journalSummaryFull: journalData.summary
                                        }));
                                        // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ (ì˜ˆì‹œ, ì‹¤ì œ êµ¬í˜„ ì‹œ updateDoc ì‚¬ìš©)
                                        // await updateDoc(doc(db, "notifications", docSnap.id), { isRead: true });
                                        window.location.href = `journal.html?journalId=${alertData.journalId}`;
                                    } else { alert("í•´ë‹¹ ëŒ€í™” ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
                                } catch (err) { console.error("ì•Œë¦¼ ì €ë„ ë¡œë“œ ì˜¤ë¥˜:", err); alert("ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
                            };
                        }
                        emergencyAlertsListEl.appendChild(listItem);
                    });
                }
            } catch (error) {
                console.error("Mypage: ê¸´ê¸‰ ì•Œë¦¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                emergencyAlertsListEl.innerHTML = '<li><p>ê¸´ê¸‰ ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ğŸ˜¥</p></li>';
            }
        }

        // --- ìµœê·¼ ì €ë„ ë¡œë“œ ë° í‘œì‹œ í•¨ìˆ˜ ---
        async function displayRecentJournals() {
            if (!recentJournalCardListEl) { console.warn("Mypage: recentJournalCardListEl ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return;}
            recentJournalCardListEl.innerHTML = '<p style="text-align:center; color:#777;">ìµœê·¼ ì´ì•¼ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            const loggedInUserId = localStorage.getItem('lozee_userId'); // UID ì‚¬ìš©
            const userType = localStorage.getItem('lozee_userType');

            if (!loggedInUserId) {
                 recentJournalCardListEl.innerHTML = '<p style="text-align:center; color:#777; padding: 20px 0;">ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ì–´ ìµœê·¼ ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                 return;
            }
            console.log("Mypage: ìµœê·¼ ì €ë„ ë¡œë“œ for userId (UID) -", loggedInUserId, "UserType -", userType);
            try {
                let q;
                if (userType === 'caregiver') {
                    q = query(
                        collection(db, 'journals'),
                        where('userId', '==', loggedInUserId), // ë³´í˜¸ì ìì‹ ì˜ UID
                        where('entryType', '==', 'standard'),    // ë³´í˜¸ì ìì‹ ì˜ ì €ë„ë§Œ
                        orderBy('createdAt', 'desc'),
                        limit(3)
                    );
                    console.log("Mypage: ë³´í˜¸ì ìœ í˜• - ë³¸ì¸ì˜ 'standard' ì €ë„(UID ê¸°ë°˜)ë§Œ ë¡œë“œí•©ë‹ˆë‹¤.");
                } else { // directUser (ë˜ëŠ” child ì—­í• )
                    q = query(
                        collection(db, 'journals'),
                        where('userId', '==', loggedInUserId), // ë³¸ì¸ UID
                        orderBy('createdAt', 'desc'),
                        limit(3)
                    );
                    console.log("Mypage: ë‹¹ì‚¬ì/ìë…€ ìœ í˜• - ë³¸ì¸ì˜ ì €ë„(UID ê¸°ë°˜)ì„ ë¡œë“œí•©ë‹ˆë‹¤.");
                }
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                     recentJournalCardListEl.innerHTML = `<p style="text-align:center; color:#777; padding: 20px 0;">ì•„ì§ ë¡œì§€ì™€ì˜ ì´ì•¼ê¸°ê°€ ì¶©ë¶„íˆ ìŒ“ì´ì§€ ì•Šì•˜ë‚˜ ë´ìš”. ğŸ¤”</p>`;
                } else {
                    recentJournalCardListEl.innerHTML = '';
                    let sessionCounter = 0;
                    querySnapshot.forEach((docSnap) => {
                        sessionCounter++;
                        const journal = docSnap.data();
                        const card = document.createElement('div');
                        card.className = 'session-card-wide';
                        const dateStr = journal.createdAt?.toDate ? journal.createdAt.toDate().toLocaleDateString('ko-KR', {month: 'short', day: 'numeric'}) : 'ë‚ ì§œ ì—†ìŒ';
                        const title = journal.title || journal.topic || 'ì œëª© ì—†ëŠ” ì´ì•¼ê¸°';
                        const topicDisplay = journal.topic ? `<div class="topic-info">ì£¼ì œ: ${journal.topic}</div>` : '';
                        const summaryPreview = journal.summary ? journal.summary.substring(0, 100) + (journal.summary.length > 100 ? '...' : '') : 'ìš”ì•½ì´ ì—†ì–´ìš”.';
                        let lozeeAnalysisHTML = "";
                        if(journal.detailedAnalysis && journal.detailedAnalysis.overallSentiment) {
                            let sentimentText = ""; let sentimentClass = "neutral";
                            const sentiment = String(journal.detailedAnalysis.overallSentiment).toLowerCase();
                            if (sentiment.includes("positive") || sentiment.includes("ê¸ì •")) { sentimentText = "ê¸ì •ì ì¸ ëŒ€í™” ğŸ‘"; sentimentClass = "positive"; }
                            else if (sentiment.includes("negative") || sentiment.includes("ë¶€ì •")) { sentimentText = "í˜ë“  ëŒ€í™”ì˜€ë‚˜ë´ìš” ğŸ˜Ÿ"; sentimentClass = "negative"; }
                            else { sentimentText = "ì°¨ë¶„í•œ ëŒ€í™” ğŸ˜Œ"; }
                            lozeeAnalysisHTML = `<div class="journal-analysis-banner ${sentimentClass}">${sentimentText}</div>`;
                        }
                        card.innerHTML = `
                            <div class="session-header">
                                <span class="session-date">${dateStr}</span>
                                <span class="session-meta">ìµœê·¼ ${sessionCounter}</span>
                            </div>
                            <h3>${title}</h3>
                            ${topicDisplay}
                            <p class="session-summary">${summaryPreview}</p>
                            ${lozeeAnalysisHTML}`;
                        card.onclick = () => {
                            localStorage.setItem('lozee_selected_journal_id', docSnap.id);
                            localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                                results: journal.detailedAnalysis || {},
                                accumulatedDurationMinutes: journal.sessionDurationMinutes || 0,
                                accumulatedUserCharCount: journal.userCharCountForThisSession || 0,
                                journalId: docSnap.id,
                                journalTitle: title,
                                journalDate: journal.createdAt?.toDate ? journal.createdAt.toDate().toISOString() : null,
                                journalSummaryFull: journal.summary
                            }));
                            window.location.href = `journal.html?journalId=${docSnap.id}`;
                        };
                        recentJournalCardListEl.appendChild(card);
                    });
                }
            } catch (error) {
                console.error("Mypage: ìµœê·¼ ì €ë„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                let errorMessage = '<p style="text-align:center; color:red; padding: 20px 0;">ìµœê·¼ ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ğŸ˜¥';
                if (error.message && error.message.includes("index")) {
                    errorMessage += "<br>ë°ì´í„°ë² ì´ìŠ¤ ìƒ‰ì¸(index) ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì½˜ì†”ì˜ ì˜¤ë¥˜ ë©”ì‹œì§€ ë§í¬ë¥¼ í†µí•´ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>";
                } else {
                    errorMessage += ` (${error.message})</p>`;
                }
                recentJournalCardListEl.innerHTML = errorMessage;
            }
        }

        if(goToJournalListBtn) { goToJournalListBtn.onclick = () => { window.location.href = 'journal-list.html'; }; }

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Mypage: DOMContentLoaded");
            loadUserProfile();      // í”„ë¡œí•„ ë¡œë“œ
            displayLozeePlans();    // 'ë¡œì§€ì™€ì˜ ì•½ì†' í‘œì‹œ
            displayRecentJournals(); // 'ìµœê·¼ ì €ë„' í‘œì‹œ
            displayEmergencyAlerts(); // 'ê¸´ê¸‰ ì•Œë¦¼' í‘œì‹œ
        });
    </script>
</body>
</html>