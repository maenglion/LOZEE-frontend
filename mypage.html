<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¨ ë‚˜ì˜ ë¡œì§€ ë³´ê´€í•¨ - LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* mypage.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
            --profile-placeholder-bg: #d0d9ff; /* í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ì²´ ë™ê·¸ë¼ë¯¸ ë°°ê²½ìƒ‰ */
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 800px; /* ë‚´ìš© ì˜ì—­ ë„ˆë¹„ */
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .page-title {
            color: var(--primary-color);
            text-align: center;
            font-size: 2em; 
            margin-bottom: 30px; 
            font-weight: 700;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-card, .info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center; /* ê¸°ë³¸ ê°€ìš´ë° ì •ë ¬ */
        }

        .profile-card h2, .info-card h2 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* 1. ìœ ì € ì´ë¯¸ì§€ (ë™ê·¸ë¼ë¯¸ ìƒ‰ìƒ) */
        .profile-photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--profile-placeholder-bg); /* ì§€ì •ëœ ìƒ‰ìƒ */
            margin: 0 auto 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em; /* ì´ëª¨í‹°ì½˜ ë˜ëŠ” ì²« ê¸€ììš© */
            color: white; /* ì´ëª¨í‹°ì½˜ ë˜ëŠ” ì²« ê¸€ì ìƒ‰ìƒ */
            font-weight: bold;
        }
        /* ì‹¤ì œ ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš° (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì¬í™œìš© ë˜ëŠ” ìˆ˜ì •) */
        /* .profile img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px auto; display:block; } */


        .info-item {
            margin-bottom: 10px;
            font-size: 1em;
        }
        .info-item .label {
            font-weight: bold;
            color: #555;
        }
        .info-item .value {
            color: var(--text-color);
        }

        /* 6. LOZEEì™€ì˜ ê³„íš */
        .plans-card ul {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .plans-card li {
            background-color: #eef2f7;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        /* 7. ë‚˜ì˜ ìµœê·¼ ê°ì • ëŒ€í™” ì¹´ë“œ */
        .recent-journals-title { /* h2ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ì ìš© */
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 30px; /* ìœ„ìª½ ì¹´ë“œì™€ì˜ ê°„ê²© */
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: center;
        }
        .recent-journal-card-list { /* journal-list.htmlì˜ .card-listì™€ ìœ ì‚¬í•˜ê²Œ */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .journal-card { /* journal-list.htmlì˜ .journal-card ìŠ¤íƒ€ì¼ ì¬í™œìš© ë˜ëŠ” ìœ ì‚¬í•˜ê²Œ */
            background-color: var(--card-bg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            box-sizing: border-box;
            text-align: left;
        }
        .journal-card .topic { font-size: 1em; font-weight: bold; color: var(--primary-color); margin-bottom: 5px;}
        .journal-card .emotion { font-size: 0.85em; color: #555; margin-bottom: 8px; font-style:italic;}
        .journal-card .summary { font-size: 0.9em; color: #444; max-height: 3.2em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;}


        @media (max-width: 600px) {
            .profile-grid {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì—ì„œëŠ” 1ì—´ë¡œ */
            }
        }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <h1 id="pageMainTitle" class="page-title">ğŸ¨ ë‚˜ì˜ ë¡œì§€ ë³´ê´€í•¨</h1>

        <div class="profile-grid">
            <div class="profile-card">
                <div id="userPhotoPlaceholder" class="profile-photo-placeholder">
                    </div>
                <h2 id="userNameDisplay" style="border-bottom:none; margin-bottom:5px;">ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
                <p id="userEmailDisplay" style="font-size:0.9em; color:#777;">ì´ë©”ì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <div class="info-card">
                <h2>ğŸ‚ ë‚´ ì •ë³´</h2>
                <p class="info-item"><span class="label">ë§Œ ë‚˜ì´:</span> <span id="userFullAge" class="value">ì •ë³´ ì—†ìŒ</span></p>
                <p class="info-item"><span class="label">ë§ˆì§€ë§‰ ì ‘ì†:</span> <span id="lastLoginDate" class="value">ì •ë³´ ì—†ìŒ</span></p>
                <p class="info-item"><span class="label">ë¡œì§€ì™€ì˜ ì´ ëŒ€í™”:</span> <span id="totalSessionsCount" class="value">ì •ë³´ ì—†ìŒ</span></p>
            </div>
            
            <div class="info-card plans-card">
                <h2>ğŸ¤ ë¡œì§€ì™€ì˜ ì•½ì†!</h2>
                <ul id="lozeePlans">
                    <li>ğŸ“ ì–¸ì–´ í‘œí˜„ ì—°ìŠµ í•¨ê»˜ í•˜ê¸° (ì˜ˆì •)</li>
                    <li>ğŸ’¡ ìƒê° ìŠµê´€ íƒí—˜ ì´ì–´ê°€ê¸° (ì˜ˆì •)</li>
                    <li style="color:#999; font-style:italic;">ì•„ì§ ë¡œì§€ì™€ì˜ íŠ¹ë³„í•œ ì•½ì†ì€ ì—†ì–´ìš”!</li>
                </ul>
            </div>
        </div>

        <h2 class="recent-journals-title">ğŸ’¬ ìµœê·¼ ë‚˜ëˆˆ ì´ì•¼ê¸° ì‚´ì§ ë³´ê¸°</h2>
        <div class="recent-journal-card-list" id="recentJournalList">
            <div class="journal-card">
                <div class="topic">í•™êµìƒí™œ ì´ì•¼ê¸°</div>
                <div class="emotion">ë§ˆìŒ ë‚ ì”¨: ê±±ì •, ì¡°ê¸ˆ ë‹µë‹µ</div>
                <div class="summary">ì„ ìƒë‹˜ì´ ê°‘ìê¸° ì§ˆë¬¸í•´ì„œ ê¹œì§ ë†€ëì§€ë§Œ, ê·¸ë˜ë„ ì”©ì”©í•˜ê²Œ ëŒ€ë‹µí•˜ë ¤ê³  ë…¸ë ¥í–ˆì–´...</div>
            </div>
            <div class="journal-card">
                <div class="topic">ì¹œêµ¬ ì´ì•¼ê¸°</div>
                <div class="emotion">ë§ˆìŒ ë‚ ì”¨: ì‹ ë‚¨! ì¡°ê¸ˆì€ ì•„ì‰¬ì›€</div>
                <div class="summary">ë‹¨ì§ ì¹œêµ¬ë‘ ë¹„ë°€ ë†€ì´ë¥¼ í–ˆëŠ”ë°, ì‹œê°„ì´ ë„ˆë¬´ ë¹¨ë¦¬ ê°€ì„œ ì•„ì‰¬ì› ì§€ë§Œ ì •ë§ ì¬ë¯¸ìˆì—ˆì–´! ë˜ í•˜ê³  ì‹¶ë‹¤!</div>
            </div>
            <div class="journal-card">
                <div class="topic">ë‚˜ì˜ ê¿ˆ ì´ì•¼ê¸°</div>
                <div class="emotion">ë§ˆìŒ ë‚ ì”¨: ì„¤ë ˜, ê¸°ëŒ€ê°</div>
                <div class="summary">ë‚´ê°€ ë§Œì•½ í•˜ëŠ˜ì„ ë‚˜ëŠ” ë°œëª…ê°€ê°€ ëœë‹¤ë©´, êµ¬ë¦„ ìœ„ì—ì„œ ì•„ì´ìŠ¤í¬ë¦¼ì„ ë§Œë“¤ì–´ ë¨¹ì„ ê±°ì•¼! ì–¼ë§ˆë‚˜ ì‹ ë‚ ê¹Œ?</div>
            </div>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const userEmailDisplayEl = document.getElementById('userEmailDisplay');
        const userFullAgeEl = document.getElementById('userFullAge');
        const userPhotoPlaceholderEl = document.getElementById('userPhotoPlaceholder');
        const lastLoginDateEl = document.getElementById('lastLoginDate');
        const totalSessionsCountEl = document.getElementById('totalSessionsCount');
        const lozeePlansEl = document.getElementById('lozeePlans');
        const recentJournalListEl = document.getElementById('recentJournalList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');


        async function loadUserProfile() {
            const userId = localStorage.getItem('cbtUserEmail') || ''; // users ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œ IDë¡œ ì‚¬ìš©
            if (!userId) {
                userNameDisplayEl.textContent = 'ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ';
                return;
            }

            const userRef = doc(db, 'users', userId);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    
                    const displayName = data.name || 'ì¹œêµ¬';
                    userNameDisplayEl.textContent = displayName;
                    if (pageMainTitleEl) pageMainTitleEl.textContent = `${displayName}ì˜ ë¡œì§€ ë³´ê´€í•¨ ğŸ¨`;


                    if (userPhotoPlaceholderEl) {
                        if (data.photoURL) { // ì‹¤ì œ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´
                            userPhotoPlaceholderEl.innerHTML = `<img src="${data.photoURL}" alt="${displayName} ì‚¬ì§„" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                        } else { // ì´ë¯¸ì§€ê°€ ì—†ë‹¤ë©´ ë‹‰ë„¤ì„ ì²« ê¸€ì ë˜ëŠ” ê¸°ë³¸ ì´ëª¨í‹°ì½˜
                            userPhotoPlaceholderEl.textContent = displayName.charAt(0) || 'ğŸ˜Š';
                        }
                    }
                    
                    if(userEmailDisplayEl) userEmailDisplayEl.textContent = userId; // ì´ë©”ì¼ì€ userIdë¡œ ì‚¬ìš©
                    
                    if(userFullAgeEl) {
                        // Firestoreì— birthDateê°€ "YYYY-MM-DD" í˜•ì‹ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
                        if (data.birthDate) {
                            const birthDate = new Date(data.birthDate);
                            const today = new Date();
                            let age = today.getFullYear() - birthDate.getFullYear();
                            const m = today.getMonth() - birthDate.getMonth();
                            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                                age--;
                            }
                            userFullAgeEl.textContent = `ë§Œ ${age}ì„¸`;
                        } else if (data.age) { // birthDateê°€ ì—†ê³  age í•„ë“œë§Œ ìˆë‹¤ë©´ ê·¸ê²ƒ ì‚¬ìš©
                             userFullAgeEl.textContent = `ë§Œ ${data.age}ì„¸ (ê¸°ë¡ëœ ë‚˜ì´)`;
                        } else {
                            userFullAgeEl.textContent = 'ë‚˜ì´ ì •ë³´ ì—†ìŒ';
                        }
                    }

                    if(lastLoginDateEl && data.lastLogin?.toDate) { // Firestore íƒ€ì„ìŠ¤íƒ¬í”„ ê°ì²´ë¼ë©´ toDate() ì‚¬ìš©
                        lastLoginDateEl.textContent = data.lastLogin.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric'});
                    } else {
                        if(lastLoginDateEl) lastLoginDateEl.textContent = 'ìµœê·¼ ê¸°ë¡ ì—†ìŒ';
                    }

                    // ì´ ëŒ€í™” íšŸìˆ˜ (sessions ì»¬ë ‰ì…˜ì—ì„œ userIdë¡œ ì¹´ìš´íŠ¸ í•„ìš”)
                    // ì´ ë¶€ë¶„ì€ Firestore ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ í•„ìš”í•˜ì—¬ ë³µì¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // users ë¬¸ì„œì— totalSessionCount ê°™ì€ í•„ë“œë¥¼ ë§Œë“¤ì–´ talk.htmlì—ì„œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤.
                    // ì§€ê¸ˆì€ ì„ì‹œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                    if(totalSessionsCountEl) totalSessionsCountEl.textContent = data.totalSessionCount ? `${data.totalSessionCount}íšŒ` : 'ê¸°ë¡ ì¤€ë¹„ ì¤‘'; 

                } else {
                    userNameDisplayEl.textContent = 'ì‚¬ìš©ì ì •ë³´ ì—†ìŒ';
                }
            } catch (error) {
                console.error("í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                if(userNameDisplayEl) userNameDisplayEl.textContent = 'ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
            }
        }

        function displayLozeePlans() {
            if (!lozeePlansEl) return;
            lozeePlansEl.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°
            const plans = []; // ì‹¤ì œë¡œëŠ” Firestore ë˜ëŠ” localStorageì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨

            // ì˜ˆì‹œ: "ë‹¤ìŒë²ˆì— ì´ì–´ ì´ì•¼ê¸°í•˜ê¸°" ë°ì´í„° í™•ì¸
            const continueTopicData = localStorage.getItem('lozee_continue_topic');
            if (continueTopicData) {
                try {
                    const topicToContinue = JSON.parse(continueTopicData);
                    plans.push(`â†ªï¸ ì €ë²ˆì— ì´ì•¼ê¸°í•˜ë‹¤ ë©ˆì¶˜ '${topicToContinue.details || 'ìƒê° íŒ¨í„´'}'ì— ëŒ€í•´ ë” ê¹Šì´ ì´ì•¼ê¸° ë‚˜ëˆ ë³´ê¸°ë¡œ í–ˆì–´ìš”!`);
                } catch (e) { console.error("ì´ì–´í•˜ê¸° ì£¼ì œ íŒŒì‹± ì˜¤ë¥˜", e); }
            }
            // ì˜ˆì‹œ: ì–¸ì–´ ì—°ìŠµ
            // if (localStorage.getItem('lozee_needs_language_practice') === 'true') {
            // plans.push("ğŸŒ± ë¡œì§€ì™€ í•¨ê»˜ ë§ì†œì”¨ í‚¤ìš°ê¸° ì—°ìŠµì„ í•˜ê¸°ë¡œ í–ˆì–´ìš”!");
            // }


            if (plans.length > 0) {
                plans.forEach(planText => {
                    const li = document.createElement('li');
                    li.textContent = planText;
                    lozeePlansEl.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "ì•„ì§ ë¡œì§€ì™€ì˜ íŠ¹ë³„í•œ ì•½ì†ì€ ì—†ì–´ìš”! ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?";
                li.style.color = "#777";
                li.style.fontStyle = "italic";
                lozeePlansEl.appendChild(li);
            }
        }

        function displayRecentJournals() { // í•˜ë“œì½”ë”©ëœ ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©
            if (!recentJournalListEl) return;
            recentJournalListEl.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

            const sampleJournals = [
                { topic: "í•™êµìƒí™œ ì´ì•¼ê¸°", emotion: "ê±±ì •, ì¡°ê¸ˆ ë‹µë‹µ", summary: "ì„ ìƒë‹˜ì´ ê°‘ìê¸° ì§ˆë¬¸í•´ì„œ ê¹œì§ ë†€ëì§€ë§Œ, ê·¸ë˜ë„ ì”©ì”©í•˜ê²Œ ëŒ€ë‹µí•˜ë ¤ê³  ë…¸ë ¥í–ˆì–´. ë‹¤ìŒì—” ë” ì˜í•  ìˆ˜ ìˆê² ì§€?"},
                { topic: "ì¹œêµ¬ ì´ì•¼ê¸°", emotion: "ì‹ ë‚¨! ì¡°ê¸ˆì€ ì•„ì‰¬ì›€", summary: "ë‹¨ì§ ì¹œêµ¬ë‘ ë¹„ë°€ ë†€ì´ë¥¼ í–ˆëŠ”ë°, ì‹œê°„ì´ ë„ˆë¬´ ë¹¨ë¦¬ ê°€ì„œ ì•„ì‰¬ì› ì§€ë§Œ ì •ë§ ì¬ë¯¸ìˆì—ˆì–´! ë˜ í•˜ê³  ì‹¶ë‹¤!"},
                { topic: "ë‚˜ì˜ ê¿ˆ ì´ì•¼ê¸°", emotion: "ì„¤ë ˜, ê¸°ëŒ€ê°", summary: "ë‚´ê°€ ë§Œì•½ í•˜ëŠ˜ì„ ë‚˜ëŠ” ë°œëª…ê°€ê°€ ëœë‹¤ë©´, êµ¬ë¦„ ìœ„ì—ì„œ ì•„ì´ìŠ¤í¬ë¦¼ì„ ë§Œë“¤ì–´ ë¨¹ì„ ê±°ì•¼! ì–¼ë§ˆë‚˜ ì‹ ë‚ ê¹Œ? ìƒìƒë§Œ í•´ë„ ì¦ê±°ì›Œ."}
            ];

            sampleJournals.forEach(journal => {
                const card = document.createElement('div');
                card.className = 'journal-card';
                card.innerHTML = `
                    <div class="topic">${journal.topic}</div>
                    <div class="emotion">ë§ˆìŒ ë‚ ì”¨: ${journal.emotion}</div>
                    <div class="summary">${journal.summary}</div>
                `;
                recentJournalListEl.appendChild(card);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            displayLozeePlans(); // "LOZEEì™€ì˜ ê³„íš" í‘œì‹œ
            displayRecentJournals(); // "ìµœê·¼ ê°ì • ëŒ€í™”" í•˜ë“œì½”ë”©ëœ ë‚´ìš©ìœ¼ë¡œ í‘œì‹œ
            // loadJournalList(); // ì‹¤ì œ ì €ë„ ëª©ë¡ ë¡œë“œëŠ” journal-list.htmlì—ì„œì™€ ìœ ì‚¬í•˜ê²Œ êµ¬í˜„ í•„ìš”
        });
    </script>
</body>
</html>