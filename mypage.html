<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🎨 MY LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* mypage.html 고유 스타일 */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
            --profile-placeholder-bg: #d0d9ff; /* 프로필 사진 대체 동그라미 배경색 */
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 800px; /* 내용 영역 너비 */
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .page-title {
            color: var(--primary-color);
            text-align: center;
            font-size: 2em; 
            margin-bottom: 30px; 
            font-weight: 700;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* 반응형 그리드 */
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-card, .info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center; /* 기본 가운데 정렬 */
        }

        .profile-card h2, .info-card h2 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* 1. 유저 이미지 (동그라미 색상) */
        .profile-photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--profile-placeholder-bg); /* 지정된 색상 */
            margin: 0 auto 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em; /* 이모티콘 또는 첫 글자용 */
            color: white; /* 이모티콘 또는 첫 글자 색상 */
            font-weight: bold;
        }
        /* 실제 이미지가 있을 경우 (기존 스타일 재활용 또는 수정) */
        /* .profile img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px auto; display:block; } */


        .info-item {
            margin-bottom: 10px;
            font-size: 1em;
        }
        .info-item .label {
            font-weight: bold;
            color: #555;
        }
        .info-item .value {
            color: var(--text-color);
        }

        /* 6. LOZEE와의 계획 */
        .plans-card ul {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .plans-card li {
            background-color: #eef2f7;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        /* 7. 나의 최근 감정 대화 카드 */
        .recent-journals-title { /* h2와 동일한 스타일 적용 */
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 30px; /* 위쪽 카드와의 간격 */
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: center;
        
        }

        /* 신경다양성 정보 카드 및 아이/가족 정보 카드 제목 정렬 */
        .info-card.neurodiversity-info h2, 
        .info-card.child-info-card h2 { /* 아이/가족 정보 카드용 새 클래스 */
            text-align: left; /* 제목 왼쪽 정렬 */
        }
        .info-card.plans-card h2 { text-align: center; } /* 로지와의 약속은 가운데 정렬 유지 */

        .connection-status { margin-left: 8px; font-size: 0.9em; }
        .connection-status .connected { color: green; font-weight: bold; }
        .connection-status .disconnected { color: #aaa; }

        .recent-journals-section h2 { text-align: center; }
        .journal-summary-item {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer; /* 클릭 가능 암시 */
            transition: background-color 0.2s;
        }
        .journal-summary-item:hover {
            background-color: #eef2f7;
        }
        .journal-summary-item .date { font-size: 0.8em; color: #777; margin-right: 10px; }
        .view-all-journals-btn {
            display: block;
            width: fit-content;
            margin: 20px auto 0 auto;
            padding: 10px 20px;
        }

        .recent-journal-card-list { /* journal-list.html의 .card-list와 유사하게 */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .journal-card { /* journal-list.html의 .journal-card 스타일 재활용 또는 유사하게 */
            background-color: var(--card-bg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            box-sizing: border-box;
            text-align: left;
        }
        .journal-card .topic { font-size: 1em; font-weight: bold; color: var(--primary-color); margin-bottom: 5px;}
        .journal-card .emotion { font-size: 0.85em; color: #555; margin-bottom: 8px; font-style:italic;}
        .journal-card .summary { font-size: 0.9em; color: #444; max-height: 3.2em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;}


        @media (max-width: 600px) {
            .profile-grid {
                grid-template-columns: 1fr; /* 모바일에서는 1열로 */
            }
        }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a> 
          <a href="index.html">✨ 새로운 이야기 시작!</a> 
          <a href="analysis.html">📊 우리 이야기 분석</a> 
          <a href="journal-list.html">📖 이야기 모음집</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a> 
        </div>
    </nav> 

     <main class="container">
        <h1 id="pageMainTitle" class="page-title">🎨 마이 로지</h1>

        <div class="profile-section">
            </div>

        <div class="info-grid">
            <div class="info-card neurodiversity-info" id="directUserDiagnosisCard" style="display:none;">
                <h2>✨ 나의 특성 이해하기</h2>
                <p class="module-explanation">내가 선택했던 나의 특성들이야. 언제든지 다시 생각해보고 로지와 이야기 나눌 수 있어!</p>
                <ul id="userDiagnosesList"><li>정보를 불러오는 중...</li></ul>
            </div>
            
            <div class="info-card neurodiversity-info" id="caregiverPersonalNDCard" style="display:none;">
                <h2>🙋‍♀️ 보호자님 특성 이해</h2>
                <p class="module-explanation">보호자님 또는 배우자님의 신경다양성 특성을 이해하는 것은 양육과 관계에 중요한 첫걸음이 될 수 있어요.</p>
                <ul id="caregiverPersonalNeurodiversityList"><li>정보 없음</li></ul>
            </div>

            <div class="info-card child-info-card" id="childInfoCard" style="display:none;"> <h2>🧸 아이/가족 정보</h2>
                <p class="info-item"><span class="label">이름:</span> <span id="childNameDisplay" class="value">로딩 중...</span></p>
                <p class="info-item"><span class="label">만 나이:</span> <span id="childFullAge" class="value">로딩 중...</span></p>
                <p class="info-item"><span class="label">특성 이해:</span></p>
                <ul id="childDiagnosesList" style="margin-top: -5px; margin-bottom:10px; text-align:left;"><li>정보 없음</li></ul>
                <p class="info-item" style="margin-top:15px;">
                    <span class="label">연결된 로지 계정:</span> 
                    <span id="childLozeeEmailDisplay" class="value">정보 없음</span>
                    <span id="childConnectionStatus" class="connection-status"></span> </p>
            </div>
            
            <div class="info-card plans-card">
                <h2>🤝 로지와의 약속!</h2>
                <p class="module-explanation">로지랑 이런 이야기를 더 나누기로 했었지! 언제든 다시 시작할 수 있어.</p>
                <ul id="lozeePlans">
                    <li style="color:#999; font-style:italic;">아직 로지와의 특별한 약속은 없어요!</li>
                </ul>
            </div>
        </div>

        <div class="section recent-journals-section">
            <h2 class="recent-journals-title">💬 최근 나눈 이야기들 (최신 10개)</h2>
            <div id="recentJournalSummaryList">
                </div>
            <button id="goToJournalListBtn" class="action-button view-all-journals-btn">📖 전체 이야기 모음집 가기</button>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const userEmailDisplayEl = document.getElementById('userEmailDisplay');
        const userFullAgeEl = document.getElementById('userFullAge');
        const userPhotoPlaceholderEl = document.getElementById('userPhotoPlaceholder');
        const lastLoginDateEl = document.getElementById('lastLoginDate');
        const totalSessionsCountEl = document.getElementById('totalSessionsCount');
        const lozeePlansEl = document.getElementById('lozeePlans');
        const recentJournalListEl = document.getElementById('recentJournalList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTitleEl = document.getElementById('pageTitle'); // <title> 태그
        const childConnectionStatusEl = document.getElementById('childConnectionStatus');
        const recentJournalSummaryListEl = document.getElementById('recentJournalSummaryList');
        const goToJournalListBtn = document.getElementById('goToJournalListBtn');


        async function loadUserProfile() {
let loggedInUserEmail = localStorage.getItem('cbtUserEmail') || '';
            let userType = localStorage.getItem('lozee_userType') || ''; 

            // 테스트 계정 강제 caregiver 처리
            if (loggedInUserEmail === 'unbearable_@naver.com') {
                userType = 'caregiver';
                localStorage.setItem('lozee_userType', 'caregiver'); // localStorage도 동기화
                console.log("테스트 계정 unbearable_@naver.com: caregiver 모드로 강제 설정됨");
            }

            if (!loggedInUserEmail) { /* ... 로그인 정보 없음 처리 ... */ return; }
            if (!userType && loggedInUserEmail !== 'unbearable_@naver.com') { // unbearable_@naver.com 외에는 userType이 반드시 있어야 함
                console.warn("사용자 유형(userType) 정보가 없습니다. index.html에서 재설정 필요.");
                // 사용자 유형 선택 페이지로 보내거나, 기본값 설정 후 정보 요청
                // 여기서는 일단 정보 없음으로 표시
                if(pageMainTitleEl) pageMainTitleEl.textContent = '사용자 정보 오류';
                return;
            }


            if(userEmailDisplayEl) userEmailDisplayEl.textContent = loggedInUserEmail;
            if(pageTitleEl) pageTitleEl.textContent = `${localStorage.getItem('lozee_username') || '나'}의 마이 로지`;


            const userRef = doc(db, 'users', loggedInUserEmail);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    let profileName, profileAge, profileBirthDate;

                    // --- 공통 프로필 정보 (로그인한 사용자 기준) ---
                    profileName = data.name || (userType === 'caregiver' ? '보호자' : '친구');
                    profileBirthDate = data.birthDate; 
                    profileAge = profileBirthDate ? calculateAgeFromBirthDate(profileBirthDate) : (data.age !== undefined ? data.age : null);

                    if(pageMainTitleEl) pageMainTitleEl.textContent = `${profileName}님의 마이 로지 🎨`;
                    if(userNameDisplayEl) userNameDisplayEl.textContent = profileName;
                    if(userFullAgeEl) userFullAgeEl.textContent = profileAge !== null ? `만 ${profileAge}세` : '정보 없음';
                    if(ageLabelEl) ageLabelEl.textContent = "만 나이:"; // 공통 레이블

                    if (userPhotoPlaceholderEl) { /* ... 사진 처리 ... */ }
                    if(lastLoginDateEl && data.lastLogin?.toDate) { /* ... 마지막 로그인 ... */ }
                    
                    let sessionCountToDisplay = data.totalSessionCount || 0; // 기본값은 당사자용 카운트
                    if(sessionCountLabelEl) sessionCountLabelEl.textContent = `로지와의 총 대화:`;


                    // --- 사용자 유형별 카드 표시 ---
                    if (userType === 'caregiver') {
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'block';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'block';
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';

                        // 보호자 본인/배우자 신경다양성
                        if (data.caregiverNeurodiversity && data.caregiverNeurodiversity.length > 0 && data.caregiverNeurodiversity[0] !== 'unsure_or_none') {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = data.caregiverNeurodiversity.map(nd => `<li>${getNeurodiversityText(nd)}</li>`).join('');
                        } else {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = '<li>선택된 사항 없음</li>';
                        }
                        
                        // 아이/가족 정보
                        if(childNameDisplayEl) childNameDisplayEl.textContent = data.childName || '정보 없음';
                        const childAge = data.childBirthDate ? calculateAgeFromBirthDate(data.childBirthDate) : (data.childAge !== undefined ? data.childAge : null);
                        if(childFullAgeEl) childFullAgeEl.textContent = childAge !== null ? `만 ${childAge}세` : '정보 없음';
                        
                        if (data.childDiagnoses && data.childDiagnoses.length > 0 && data.childDiagnoses[0] !== 'NotApplicable' && data.childDiagnoses[0] !== 'Unsure') {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = data.childDiagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = '<li>특별히 선택된 항목 없음</li>';
                        }
                        if(childLozeeEmailDisplayEl) childLozeeEmailDisplayEl.textContent = data.childLozeeEmail || '연결 안 됨';
                        if(childConnectionStatusEl) { // 연결 아이콘 표시
                            childConnectionStatusEl.innerHTML = data.childLozeeEmail ? '<span class="connected" title="연결됨">🔗</span>' : '<span class="disconnected" title="연결 안 됨">💔</span>';
                        }
                        // 보호자의 경우, "총 대화 횟수"는 아이 기준일 수 있음 (DB 필드명 childTotalSessionCount 필요)
                        sessionCountToDisplay = data.childTotalSessionCount || 0;
                         if(sessionCountLabelEl) sessionCountLabelEl.textContent = `아이/가족 총 대화:`;


                    } else { // directUser (당사자)
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'block';
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'none';

                        if (data.diagnoses && data.diagnoses.length > 0 && data.diagnoses[0] !== 'NotApplicable' && data.diagnoses[0] !== 'Unsure') {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = data.diagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = '<li>선택된 항목 없음</li>';
                        }
                    }
                    if(totalSessionsCountEl) totalSessionsCountEl.textContent = `${sessionCountToDisplay}회`; 

                } else { /* ... 사용자 정보 없음 처리 ... */ }
            } catch (error) { /* ... 오류 처리 ... */ }
        }
        

        function displayLozeePlans() {
            if (!lozeePlansEl) return;
            lozeePlansEl.innerHTML = ''; 
            const plans = []; 
            const userType = localStorage.getItem('lozee_userType') || '';

            const continueTopicData = localStorage.getItem('lozee_continue_topic');
            if (continueTopicData) {
                try {
                    const topicToContinue = JSON.parse(continueTopicData);
                    plans.push(`↪️ 저번에 이야기하다 멈춘 '${topicToContinue.details || '생각 패턴'}'에 대해 더 깊이 이야기 나눠보기로 했어요!`);
                } catch (e) { console.error("이어하기 주제 파싱 오류", e); }
            }
            
            // 언어 연습 필요 여부 (예시: localStorage 또는 Firestore에서 가져옴)
            // const needsLanguagePractice = localStorage.getItem('lozee_needs_language_practice') === 'true';
            // if (userType === 'directUser' && needsLanguagePractice) { // 당사자이고 연습 필요 플래그가 있다면
            //     plans.push("🌱 로지와 함께 말솜씨 키우기 연습을 하기로 했어요!");
            // }

            if (plans.length > 0) {
                plans.forEach(planText => { /* ... li 생성 및 추가 ... */ });
            } else { /* ... 약속 없음 메시지 ... */ }
        }

        
        function displayRecentJournals() { // 하드코딩된 예시 데이터 사용
           if (!recentJournalSummaryListEl) return;
            recentJournalSummaryListEl.innerHTML = ''; 

            const loggedInUserEmail = localStorage.getItem('cbtUserEmail');
            const userType = localStorage.getItem('lozee_userType');
            let targetUserIdForJournals = loggedInUserEmail; 

            if (userType === 'caregiver') {
                const childEmail = localStorage.getItem('lozee_child_email');
                if (childEmail) { 
                    targetUserIdForJournals = childEmail;
                } else { 
                    recentJournalSummaryListEl.innerHTML = '<p style="text-align:center; color:#777;">아이/가족의 로지 계정이 연결되면 최근 대화를 볼 수 있어요.</p>';
                    return;
                }
            }

            if (!targetUserIdForJournals) { /* ... 사용자 정보 없음 처리 ... */ return; }

            try {
                const q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', targetUserIdForJournals), 
                    orderBy('createdAt', 'desc'), 
                    limit(10) // 최근 10개
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recentJournalSummaryListEl.innerHTML = `<p style="text-align:center; color:#777;">아직 로지와의 이야기가 충분히 쌓이지 않았나 봐요. 🤔</p>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const journal = doc.data();
                        const item = document.createElement('div');
                        item.className = 'journal-summary-item';
                        
                        const dateStr = journal.createdAt?.toDate ? journal.createdAt.toDate().toLocaleDateString('ko-KR') : '날짜 없음';
                        const title = journal.title || journal.topic || '제목 없음'; // title 필드가 우선
                        const summaryPreview = journal.summary ? journal.summary.substring(0, 50) + (journal.summary.length > 50 ? '...' : '') : '요약 없음';

                        item.innerHTML = `<span class="date">${dateStr}</span> <strong>${title}</strong> - ${summaryPreview}`;
                        item.onclick = () => { 
                            // 상세 페이지로 이동 또는 journal-list.html로 이동하여 해당 저널 필터링
                            // window.location.href = `journal-detail.html?id=${doc.id}`; 
                            alert(`'${title}' 이야기의 상세 내용을 보려면 '이야기 모음집'으로 가보세요! (준비 중)`);
                        };
                        recentJournalSummaryListEl.appendChild(item);
                    });
                }
            } catch (error) { /* ... 오류 처리 ... */ }
        }

        // "이야기 모음집 가기" 버튼 이벤트
        if(goToJournalListBtn) {
            goToJournalListBtn.onclick = () => {
                window.location.href = 'journal-list.html';
            };
        }

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            displayLozeePlans(); 
            displayRecentJournals(); 
            if(reportShareButton) { /* ... 공유 버튼 로직 ... */ }
        });
    </script>
</body>
</html>