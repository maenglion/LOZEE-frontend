<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¨ MY LOZEE</title> <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* mypage.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --gnb-height: 56px;
            --profile-placeholder-bg: #d0d9ff; /* í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ì²´ ë™ê·¸ë¼ë¯¸ ë°°ê²½ìƒ‰ */
        }

        body {
            margin: 0;
            padding-top: var(--gnb-height);
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 800px; /* ë‚´ìš© ì˜ì—­ ë„ˆë¹„ */
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .page-title {
            color: var(--primary-color);
            text-align: center;
            font-size: 2em; 
            margin-bottom: 30px; 
            font-weight: 700;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-card, .info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center; /* ê¸°ë³¸ ê°€ìš´ë° ì •ë ¬ */
        }

        .profile-card h2, .info-card h2 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* 1. ìœ ì € ì´ë¯¸ì§€ (ë™ê·¸ë¼ë¯¸ ìƒ‰ìƒ) */
        .profile-photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--profile-placeholder-bg); /* ì§€ì •ëœ ìƒ‰ìƒ */
            margin: 0 auto 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em; /* ì´ëª¨í‹°ì½˜ ë˜ëŠ” ì²« ê¸€ììš© */
            color: white; /* ì´ëª¨í‹°ì½˜ ë˜ëŠ” ì²« ê¸€ì ìƒ‰ìƒ */
            font-weight: bold;
        }
        /* ì‹¤ì œ ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš° (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì¬í™œìš© ë˜ëŠ” ìˆ˜ì •) */
        /* .profile img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px auto; display:block; } */


        .info-item {
            margin-bottom: 10px;
            font-size: 1em;
        }
        .info-item .label {
            font-weight: bold;
            color: #555;
        }
        .info-item .value {
            color: var(--text-color);
        }

        /* 6. LOZEEì™€ì˜ ê³„íš */
        .plans-card ul {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .plans-card li {
            background-color: #eef2f7;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        /* 7. ë‚˜ì˜ ìµœê·¼ ê°ì • ëŒ€í™” ì¹´ë“œ */
        .recent-journals-title { /* h2ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ì ìš© */
            font-size: 1.2em;
            color: var(--primary-color);
            margin-top: 30px; /* ìœ„ìª½ ì¹´ë“œì™€ì˜ ê°„ê²© */
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: center;
        
        }

        /* ì‹ ê²½ë‹¤ì–‘ì„± ì •ë³´ ì¹´ë“œ ë° ì•„ì´/ê°€ì¡± ì •ë³´ ì¹´ë“œ ì œëª© ì •ë ¬ */
        .info-card.neurodiversity-info h2, 
        .info-card.child-info-card h2 { /* ì•„ì´/ê°€ì¡± ì •ë³´ ì¹´ë“œìš© ìƒˆ í´ë˜ìŠ¤ */
            text-align: left; /* ì œëª© ì™¼ìª½ ì •ë ¬ */
        }
        .info-card.plans-card h2 { text-align: center; } /* ë¡œì§€ì™€ì˜ ì•½ì†ì€ ê°€ìš´ë° ì •ë ¬ ìœ ì§€ */

        .connection-status { margin-left: 8px; font-size: 0.9em; }
        .connection-status .connected { color: green; font-weight: bold; }
        .connection-status .disconnected { color: #aaa; }

        .recent-journals-section h2 { text-align: center; }
        .journal-summary-item {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ ì•”ì‹œ */
            transition: background-color 0.2s;
        }
        .journal-summary-item:hover {
            background-color: #eef2f7;
        }
        .journal-summary-item .date { font-size: 0.8em; color: #777; margin-right: 10px; }
        .view-all-journals-btn {
            display: block;
            width: fit-content;
            margin: 20px auto 0 auto;
            padding: 10px 20px;
        }

        .recent-journal-card-list { /* journal-list.htmlì˜ .card-listì™€ ìœ ì‚¬í•˜ê²Œ */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .journal-card { /* journal-list.htmlì˜ .journal-card ìŠ¤íƒ€ì¼ ì¬í™œìš© ë˜ëŠ” ìœ ì‚¬í•˜ê²Œ */
            background-color: var(--card-bg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            box-sizing: border-box;
            text-align: left;
        }
        .journal-card .topic { font-size: 1em; font-weight: bold; color: var(--primary-color); margin-bottom: 5px;}
        .journal-card .emotion { font-size: 0.85em; color: #555; margin-bottom: 8px; font-style:italic;}
        .journal-card .summary { font-size: 0.9em; color: #444; max-height: 3.2em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;}


        @media (max-width: 600px) {
            .profile-grid {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì—ì„œëŠ” 1ì—´ë¡œ */
            }
        }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

     <main class="container">
        <h1 id="pageMainTitle" class="page-title">ğŸ¨ ë§ˆì´ ë¡œì§€</h1>

        <div class="profile-section">
            </div>

        <div class="info-grid">
            <div class="info-card neurodiversity-info" id="directUserDiagnosisCard" style="display:none;">
                <h2>âœ¨ ë‚˜ì˜ íŠ¹ì„± ì´í•´í•˜ê¸°</h2>
                <p class="module-explanation">ë‚´ê°€ ì„ íƒí–ˆë˜ ë‚˜ì˜ íŠ¹ì„±ë“¤ì´ì•¼. ì–¸ì œë“ ì§€ ë‹¤ì‹œ ìƒê°í•´ë³´ê³  ë¡œì§€ì™€ ì´ì•¼ê¸° ë‚˜ëˆŒ ìˆ˜ ìˆì–´!</p>
                <ul id="userDiagnosesList"><li>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
            </div>
            
            <div class="info-card neurodiversity-info" id="caregiverPersonalNDCard" style="display:none;">
                <h2>ğŸ™‹â€â™€ï¸ ë³´í˜¸ìë‹˜ íŠ¹ì„± ì´í•´</h2>
                <p class="module-explanation">ë³´í˜¸ìë‹˜ ë˜ëŠ” ë°°ìš°ìë‹˜ì˜ ì‹ ê²½ë‹¤ì–‘ì„± íŠ¹ì„±ì„ ì´í•´í•˜ëŠ” ê²ƒì€ ì–‘ìœ¡ê³¼ ê´€ê³„ì— ì¤‘ìš”í•œ ì²«ê±¸ìŒì´ ë  ìˆ˜ ìˆì–´ìš”.</p>
                <ul id="caregiverPersonalNeurodiversityList"><li>ì •ë³´ ì—†ìŒ</li></ul>
            </div>

            <div class="info-card child-info-card" id="childInfoCard" style="display:none;"> <h2>ğŸ§¸ ì•„ì´/ê°€ì¡± ì •ë³´</h2>
                <p class="info-item"><span class="label">ì´ë¦„:</span> <span id="childNameDisplay" class="value">ë¡œë”© ì¤‘...</span></p>
                <p class="info-item"><span class="label">ë§Œ ë‚˜ì´:</span> <span id="childFullAge" class="value">ë¡œë”© ì¤‘...</span></p>
                <p class="info-item"><span class="label">íŠ¹ì„± ì´í•´:</span></p>
                <ul id="childDiagnosesList" style="margin-top: -5px; margin-bottom:10px; text-align:left;"><li>ì •ë³´ ì—†ìŒ</li></ul>
                <p class="info-item" style="margin-top:15px;">
                    <span class="label">ì—°ê²°ëœ ë¡œì§€ ê³„ì •:</span> 
                    <span id="childLozeeEmailDisplay" class="value">ì •ë³´ ì—†ìŒ</span>
                    <span id="childConnectionStatus" class="connection-status"></span> </p>
            </div>
            
            <div class="info-card plans-card">
                <h2>ğŸ¤ ë¡œì§€ì™€ì˜ ì•½ì†!</h2>
                <p class="module-explanation">ë¡œì§€ë‘ ì´ëŸ° ì´ì•¼ê¸°ë¥¼ ë” ë‚˜ëˆ„ê¸°ë¡œ í–ˆì—ˆì§€! ì–¸ì œë“  ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´.</p>
                <ul id="lozeePlans">
                    <li style="color:#999; font-style:italic;">ì•„ì§ ë¡œì§€ì™€ì˜ íŠ¹ë³„í•œ ì•½ì†ì€ ì—†ì–´ìš”!</li>
                </ul>
            </div>
        </div>

        <div class="section recent-journals-section">
            <h2 class="recent-journals-title">ğŸ’¬ ìµœê·¼ ë‚˜ëˆˆ ì´ì•¼ê¸°ë“¤ (ìµœì‹  10ê°œ)</h2>
            <div id="recentJournalSummaryList">
                </div>
            <button id="goToJournalListBtn" class="action-button view-all-journals-btn">ğŸ“– ì „ì²´ ì´ì•¼ê¸° ëª¨ìŒì§‘ ê°€ê¸°</button>
        </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const userEmailDisplayEl = document.getElementById('userEmailDisplay');
        const userFullAgeEl = document.getElementById('userFullAge');
        const userPhotoPlaceholderEl = document.getElementById('userPhotoPlaceholder');
        const lastLoginDateEl = document.getElementById('lastLoginDate');
        const totalSessionsCountEl = document.getElementById('totalSessionsCount');
        const lozeePlansEl = document.getElementById('lozeePlans');
        const recentJournalListEl = document.getElementById('recentJournalList');
        const pageMainTitleEl = document.getElementById('pageMainTitle');
        const pageTitleEl = document.getElementById('pageTitle'); // <title> íƒœê·¸
        const childConnectionStatusEl = document.getElementById('childConnectionStatus');
        const recentJournalSummaryListEl = document.getElementById('recentJournalSummaryList');
        const goToJournalListBtn = document.getElementById('goToJournalListBtn');


        async function loadUserProfile() {
let loggedInUserEmail = localStorage.getItem('cbtUserEmail') || '';
            let userType = localStorage.getItem('lozee_userType') || ''; 

            // í…ŒìŠ¤íŠ¸ ê³„ì • ê°•ì œ caregiver ì²˜ë¦¬
            if (loggedInUserEmail === 'unbearable_@naver.com') {
                userType = 'caregiver';
                localStorage.setItem('lozee_userType', 'caregiver'); // localStorageë„ ë™ê¸°í™”
                console.log("í…ŒìŠ¤íŠ¸ ê³„ì • unbearable_@naver.com: caregiver ëª¨ë“œë¡œ ê°•ì œ ì„¤ì •ë¨");
            }

            if (!loggedInUserEmail) { /* ... ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ ì²˜ë¦¬ ... */ return; }
            if (!userType && loggedInUserEmail !== 'unbearable_@naver.com') { // unbearable_@naver.com ì™¸ì—ëŠ” userTypeì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨
                console.warn("ì‚¬ìš©ì ìœ í˜•(userType) ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. index.htmlì—ì„œ ì¬ì„¤ì • í•„ìš”.");
                // ì‚¬ìš©ì ìœ í˜• ì„ íƒ í˜ì´ì§€ë¡œ ë³´ë‚´ê±°ë‚˜, ê¸°ë³¸ê°’ ì„¤ì • í›„ ì •ë³´ ìš”ì²­
                // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì •ë³´ ì—†ìŒìœ¼ë¡œ í‘œì‹œ
                if(pageMainTitleEl) pageMainTitleEl.textContent = 'ì‚¬ìš©ì ì •ë³´ ì˜¤ë¥˜';
                return;
            }


            if(userEmailDisplayEl) userEmailDisplayEl.textContent = loggedInUserEmail;
            if(pageTitleEl) pageTitleEl.textContent = `${localStorage.getItem('lozee_username') || 'ë‚˜'}ì˜ ë§ˆì´ ë¡œì§€`;


            const userRef = doc(db, 'users', loggedInUserEmail);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    let profileName, profileAge, profileBirthDate;

                    // --- ê³µí†µ í”„ë¡œí•„ ì •ë³´ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ê¸°ì¤€) ---
                    profileName = data.name || (userType === 'caregiver' ? 'ë³´í˜¸ì' : 'ì¹œêµ¬');
                    profileBirthDate = data.birthDate; 
                    profileAge = profileBirthDate ? calculateAgeFromBirthDate(profileBirthDate) : (data.age !== undefined ? data.age : null);

                    if(pageMainTitleEl) pageMainTitleEl.textContent = `${profileName}ë‹˜ì˜ ë§ˆì´ ë¡œì§€ ğŸ¨`;
                    if(userNameDisplayEl) userNameDisplayEl.textContent = profileName;
                    if(userFullAgeEl) userFullAgeEl.textContent = profileAge !== null ? `ë§Œ ${profileAge}ì„¸` : 'ì •ë³´ ì—†ìŒ';
                    if(ageLabelEl) ageLabelEl.textContent = "ë§Œ ë‚˜ì´:"; // ê³µí†µ ë ˆì´ë¸”

                    if (userPhotoPlaceholderEl) { /* ... ì‚¬ì§„ ì²˜ë¦¬ ... */ }
                    if(lastLoginDateEl && data.lastLogin?.toDate) { /* ... ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ... */ }
                    
                    let sessionCountToDisplay = data.totalSessionCount || 0; // ê¸°ë³¸ê°’ì€ ë‹¹ì‚¬ììš© ì¹´ìš´íŠ¸
                    if(sessionCountLabelEl) sessionCountLabelEl.textContent = `ë¡œì§€ì™€ì˜ ì´ ëŒ€í™”:`;


                    // --- ì‚¬ìš©ì ìœ í˜•ë³„ ì¹´ë“œ í‘œì‹œ ---
                    if (userType === 'caregiver') {
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'block';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'block';
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'none';

                        // ë³´í˜¸ì ë³¸ì¸/ë°°ìš°ì ì‹ ê²½ë‹¤ì–‘ì„±
                        if (data.caregiverNeurodiversity && data.caregiverNeurodiversity.length > 0 && data.caregiverNeurodiversity[0] !== 'unsure_or_none') {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = data.caregiverNeurodiversity.map(nd => `<li>${getNeurodiversityText(nd)}</li>`).join('');
                        } else {
                            if(caregiverPersonalNeurodiversityListEl) caregiverPersonalNeurodiversityListEl.innerHTML = '<li>ì„ íƒëœ ì‚¬í•­ ì—†ìŒ</li>';
                        }
                        
                        // ì•„ì´/ê°€ì¡± ì •ë³´
                        if(childNameDisplayEl) childNameDisplayEl.textContent = data.childName || 'ì •ë³´ ì—†ìŒ';
                        const childAge = data.childBirthDate ? calculateAgeFromBirthDate(data.childBirthDate) : (data.childAge !== undefined ? data.childAge : null);
                        if(childFullAgeEl) childFullAgeEl.textContent = childAge !== null ? `ë§Œ ${childAge}ì„¸` : 'ì •ë³´ ì—†ìŒ';
                        
                        if (data.childDiagnoses && data.childDiagnoses.length > 0 && data.childDiagnoses[0] !== 'NotApplicable' && data.childDiagnoses[0] !== 'Unsure') {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = data.childDiagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else {
                           if(childDiagnosesListEl) childDiagnosesListEl.innerHTML = '<li>íŠ¹ë³„íˆ ì„ íƒëœ í•­ëª© ì—†ìŒ</li>';
                        }
                        if(childLozeeEmailDisplayEl) childLozeeEmailDisplayEl.textContent = data.childLozeeEmail || 'ì—°ê²° ì•ˆ ë¨';
                        if(childConnectionStatusEl) { // ì—°ê²° ì•„ì´ì½˜ í‘œì‹œ
                            childConnectionStatusEl.innerHTML = data.childLozeeEmail ? '<span class="connected" title="ì—°ê²°ë¨">ğŸ”—</span>' : '<span class="disconnected" title="ì—°ê²° ì•ˆ ë¨">ğŸ’”</span>';
                        }
                        // ë³´í˜¸ìì˜ ê²½ìš°, "ì´ ëŒ€í™” íšŸìˆ˜"ëŠ” ì•„ì´ ê¸°ì¤€ì¼ ìˆ˜ ìˆìŒ (DB í•„ë“œëª… childTotalSessionCount í•„ìš”)
                        sessionCountToDisplay = data.childTotalSessionCount || 0;
                         if(sessionCountLabelEl) sessionCountLabelEl.textContent = `ì•„ì´/ê°€ì¡± ì´ ëŒ€í™”:`;


                    } else { // directUser (ë‹¹ì‚¬ì)
                        if(directUserDiagnosisCardEl) directUserDiagnosisCardEl.style.display = 'block';
                        if(caregiverPersonalNDCardEl) caregiverPersonalNDCardEl.style.display = 'none';
                        if(childInfoCardEl) childInfoCardEl.style.display = 'none';

                        if (data.diagnoses && data.diagnoses.length > 0 && data.diagnoses[0] !== 'NotApplicable' && data.diagnoses[0] !== 'Unsure') {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = data.diagnoses.map(d => `<li>${getNeurodiversityText(d)}</li>`).join('');
                        } else {
                           if(userDiagnosesListEl) userDiagnosesListEl.innerHTML = '<li>ì„ íƒëœ í•­ëª© ì—†ìŒ</li>';
                        }
                    }
                    if(totalSessionsCountEl) totalSessionsCountEl.textContent = `${sessionCountToDisplay}íšŒ`; 

                } else { /* ... ì‚¬ìš©ì ì •ë³´ ì—†ìŒ ì²˜ë¦¬ ... */ }
            } catch (error) { /* ... ì˜¤ë¥˜ ì²˜ë¦¬ ... */ }
        }
        

        function displayLozeePlans() {
            if (!lozeePlansEl) return;
            lozeePlansEl.innerHTML = ''; 
            const plans = []; 
            const userType = localStorage.getItem('lozee_userType') || '';

            const continueTopicData = localStorage.getItem('lozee_continue_topic');
            if (continueTopicData) {
                try {
                    const topicToContinue = JSON.parse(continueTopicData);
                    plans.push(`â†ªï¸ ì €ë²ˆì— ì´ì•¼ê¸°í•˜ë‹¤ ë©ˆì¶˜ '${topicToContinue.details || 'ìƒê° íŒ¨í„´'}'ì— ëŒ€í•´ ë” ê¹Šì´ ì´ì•¼ê¸° ë‚˜ëˆ ë³´ê¸°ë¡œ í–ˆì–´ìš”!`);
                } catch (e) { console.error("ì´ì–´í•˜ê¸° ì£¼ì œ íŒŒì‹± ì˜¤ë¥˜", e); }
            }
            
            // ì–¸ì–´ ì—°ìŠµ í•„ìš” ì—¬ë¶€ (ì˜ˆì‹œ: localStorage ë˜ëŠ” Firestoreì—ì„œ ê°€ì ¸ì˜´)
            // const needsLanguagePractice = localStorage.getItem('lozee_needs_language_practice') === 'true';
            // if (userType === 'directUser' && needsLanguagePractice) { // ë‹¹ì‚¬ìì´ê³  ì—°ìŠµ í•„ìš” í”Œë˜ê·¸ê°€ ìˆë‹¤ë©´
            //     plans.push("ğŸŒ± ë¡œì§€ì™€ í•¨ê»˜ ë§ì†œì”¨ í‚¤ìš°ê¸° ì—°ìŠµì„ í•˜ê¸°ë¡œ í–ˆì–´ìš”!");
            // }

            if (plans.length > 0) {
                plans.forEach(planText => { /* ... li ìƒì„± ë° ì¶”ê°€ ... */ });
            } else { /* ... ì•½ì† ì—†ìŒ ë©”ì‹œì§€ ... */ }
        }

        
        function displayRecentJournals() { // í•˜ë“œì½”ë”©ëœ ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©
           if (!recentJournalSummaryListEl) return;
            recentJournalSummaryListEl.innerHTML = ''; 

            const loggedInUserEmail = localStorage.getItem('cbtUserEmail');
            const userType = localStorage.getItem('lozee_userType');
            let targetUserIdForJournals = loggedInUserEmail; 

            if (userType === 'caregiver') {
                const childEmail = localStorage.getItem('lozee_child_email');
                if (childEmail) { 
                    targetUserIdForJournals = childEmail;
                } else { 
                    recentJournalSummaryListEl.innerHTML = '<p style="text-align:center; color:#777;">ì•„ì´/ê°€ì¡±ì˜ ë¡œì§€ ê³„ì •ì´ ì—°ê²°ë˜ë©´ ìµœê·¼ ëŒ€í™”ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>';
                    return;
                }
            }

            if (!targetUserIdForJournals) { /* ... ì‚¬ìš©ì ì •ë³´ ì—†ìŒ ì²˜ë¦¬ ... */ return; }

            try {
                const q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', targetUserIdForJournals), 
                    orderBy('createdAt', 'desc'), 
                    limit(10) // ìµœê·¼ 10ê°œ
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recentJournalSummaryListEl.innerHTML = `<p style="text-align:center; color:#777;">ì•„ì§ ë¡œì§€ì™€ì˜ ì´ì•¼ê¸°ê°€ ì¶©ë¶„íˆ ìŒ“ì´ì§€ ì•Šì•˜ë‚˜ ë´ìš”. ğŸ¤”</p>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const journal = doc.data();
                        const item = document.createElement('div');
                        item.className = 'journal-summary-item';
                        
                        const dateStr = journal.createdAt?.toDate ? journal.createdAt.toDate().toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                        const title = journal.title || journal.topic || 'ì œëª© ì—†ìŒ'; // title í•„ë“œê°€ ìš°ì„ 
                        const summaryPreview = journal.summary ? journal.summary.substring(0, 50) + (journal.summary.length > 50 ? '...' : '') : 'ìš”ì•½ ì—†ìŒ';

                        item.innerHTML = `<span class="date">${dateStr}</span> <strong>${title}</strong> - ${summaryPreview}`;
                        item.onclick = () => { 
                            // ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ ë˜ëŠ” journal-list.htmlë¡œ ì´ë™í•˜ì—¬ í•´ë‹¹ ì €ë„ í•„í„°ë§
                            // window.location.href = `journal-detail.html?id=${doc.id}`; 
                            alert(`'${title}' ì´ì•¼ê¸°ì˜ ìƒì„¸ ë‚´ìš©ì„ ë³´ë ¤ë©´ 'ì´ì•¼ê¸° ëª¨ìŒì§‘'ìœ¼ë¡œ ê°€ë³´ì„¸ìš”! (ì¤€ë¹„ ì¤‘)`);
                        };
                        recentJournalSummaryListEl.appendChild(item);
                    });
                }
            } catch (error) { /* ... ì˜¤ë¥˜ ì²˜ë¦¬ ... */ }
        }

        // "ì´ì•¼ê¸° ëª¨ìŒì§‘ ê°€ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸
        if(goToJournalListBtn) {
            goToJournalListBtn.onclick = () => {
                window.location.href = 'journal-list.html';
            };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            displayLozeePlans(); 
            displayRecentJournals(); 
            if(reportShareButton) { /* ... ê³µìœ  ë²„íŠ¼ ë¡œì§ ... */ }
        });
    </script>
</body>
</html>