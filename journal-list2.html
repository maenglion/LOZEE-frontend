<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">ì£¼ì œë³„ ì´ì•¼ê¸° íšŒì°¨ ëª©ë¡ â€“ LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <link rel="stylesheet" href="css/base.css"> <link rel="stylesheet" href="css/journal-list2.css"> </head>
<body>
 <div class="app-container">
        <nav id="gnb">
            <button id="menu-toggle">â˜°</button>
            <div id="gnb-title">LOZEE</div>
            <div style="width: 44px;"></div>
            <div id="dropdown-menu">
                <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a>
                <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a>
                <a id="gnb-analysis-link" href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a>
                <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a>
                <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
            </div>
        </nav>

    <main class="container journal-list-detail-content-area" id="mainContainer"> <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">ì´ 0íšŒ</span> |
                <span id="lastSessionDate">ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>
        <div class="session-card-list" id="sessionCardList"></div>
        <div class="pagination" id="paginationControls"></div>
    </main>

    <script src="./js/gnb.js" defer></script>
    <script type="module">
        import { db } from './js/firebase-config.js';
        import {
            collection, query, where, getDocs, orderBy, doc, getDoc, limit,
            getCountFromServer, startAfter
        } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // counselingTopicsByAge: â€œëŒ€ë¶„ë¥˜ â†’ ì—°ë ¹ëŒ€ë³„ ì„œë¸Œí† í”½â€ êµ¬ì¡°
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        //ì£¼ì œ ì˜ˆì•½
        import { saveReservation } from './js/firebase-utils.js';

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // [í—¬í¼1] â€œì„œë¸Œí† í”½(ì˜ˆ: â€˜ì—„ë§ˆì˜ í–‰ë™ìœ¼ë¡œ ì¸í•œ ë¶„ë…¸â€™) â†’ ëŒ€ë¶„ë¥˜(ì˜ˆ: â€˜ê°ì • ì´ì•¼ê¸°â€™)â€ë¥¼ ì°¾ì•„ ë°˜í™˜
        function findMainCategoryOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName]; // ì‹¤ì œ ë©”ì¸ ì£¼ì œ ê°ì²´
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return mainTopicObject.name; // ë©”ì¸ ì£¼ì œì˜ name ë°˜í™˜
                                }
                            }
                        }
                    }
                }
            }
            return '';
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // [í—¬í¼2] â€œí† í”½ì˜ displayTextâ€ë¥¼ ë‹¤ì‹œ ëŒë ¤ì£¼ëŠ” í•¨ìˆ˜ (í˜„ì¬ëŠ” topicKey ê·¸ëŒ€ë¡œ ë°˜í™˜)
        function getDisplayNameOfTopic(topicKey, topicsData) {
             for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName];
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return subTopic.displayText;
                                }
                            }
                        }
                    }
                }
            }
            return topicKey;
        }

        const topicTitleDisplayEl   = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl   = document.getElementById('totalSessionCount');
        const lastSessionDateEl     = document.getElementById('lastSessionDate');
        const sessionCardListEl     = document.getElementById('sessionCardList');
        const paginationControlsEl  = document.getElementById('paginationControls');
        const pageTabTitleEl        = document.querySelector('title');

        const urlParams          = new URLSearchParams(window.location.search);
        const topicKeyFromUrl    = decodeURIComponent(urlParams.get('topic') || '');
        const userId = localStorage.getItem('lozee_userId');
        const userType = localStorage.getItem('lozee_userType'); // ì‚¬ìš©ì ìœ í˜• ê°€ì ¸ì˜¤ê¸°

        const ITEMS_PER_PAGE         = 5;
        let lastVisibleDocForPaging  = null;
        let currentPageNum           = 1;
        let totalJournalDocsForTopic = 0;


        // â€œí™”ë©´ìš© í† í”½ ì´ë¦„â€ (í˜„ì¬ëŠ” displayText ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        const topicDisplayName = getDisplayNameOfTopic(topicKeyFromUrl, counselingTopicsByAge);

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // ì„¸ì…˜ ì¹´ë“œ ìƒì„±: â€œê¸°ë³¸ì€ sessionData.title(ë¡œê·¸) â†’ ì—†ìœ¼ë©´ ëŒ€ë¶„ë¥˜ â€“ GPT ìš”ì•½â€ í˜•íƒœë¡œ ì œëª© êµ¬ì„±
        function createSessionCard(sessionData) {
            const card = document.createElement('div');
            card.className = 'session-card-wide';

            // 1) ë‚ ì§œ ë¬¸ìì—´
            const dateStr = sessionData.createdAt?.toDate
                ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      weekday: 'long'
                  })
                : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';

            // 2) GPT ìš”ì•½ì˜ ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ ì¶”ì¶œ
            const gptSummary = sessionData.summary
                ? sessionData.summary.split('\n')[0]
                : 'ìš”ì•½ ë‚´ìš©ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.';

            // 3) ëŒ€ë¶„ë¥˜(ë©”ì¸í† í”½) ì°¾ê¸° (ì˜ˆ: â€œê°ì • ì´ì•¼ê¸°â€)
            const mainCategory = findMainCategoryOfTopic(topicKeyFromUrl, counselingTopicsByAge) || 'ì£¼ì œ';

            // 4) ìµœì¢… ì¹´ë“œ ì œëª©:
            //    (1) sessionData.titleì´ ìˆìœ¼ë©´ â€œë¡œê·¸ ê¸°ë°˜ ì œëª©â€ì„ ìš°ì„  ì‚¬ìš©í•˜ê³ ,
            //    (2) ì—†ìœ¼ë©´ â€œëŒ€ë¶„ë¥˜ â€“ GPT ìš”ì•½ ì²« ë¬¸ì¥â€ìœ¼ë¡œ í‘œì‹œ
            const sessionTitle = sessionData.title && sessionData.title.trim()
                ? sessionData.title
                : `${mainCategory} â€“ ${gptSummary}`;

            // 5) ì¹´ë“œ HTML ìƒì„± (í—¤ë”: ë‚ ì§œ + ì œëª©)
            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                </div>
                <h3 class="session-title" data-journalid="${sessionData.id}">${sessionTitle}</h3>
            `;

            // 6) ì„¸ì…˜ ìš”ì•½(ì²« ì¤„ ìš”ì•½ ë³¸ë¬¸) ìƒì„± (ìµœëŒ€ 300ìê¹Œì§€ ë…¸ì¶œ, í´ë¦­ ì‹œ í™•ì¥)
            const fullSummary = sessionData.summary || 'ìš”ì•½ ë‚´ìš©ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.';
            const summaryParagraph = document.createElement('p');
            summaryParagraph.className = 'session-summary collapsed';
            summaryParagraph.textContent = fullSummary;
            card.appendChild(summaryParagraph);

            if (fullSummary.length > 300) {
                const moreBtn = document.createElement('span');
                moreBtn.className = 'more-summary-btn';
                moreBtn.textContent = 'ë”ë³´ê¸°';
                moreBtn.onclick = (e) => {
                    e.stopPropagation();
                    summaryParagraph.classList.toggle('expanded');
                    moreBtn.textContent = summaryParagraph.classList.contains('expanded') ? 'ì ‘ê¸°' : 'ë”ë³´ê¸°';
                };
                card.appendChild(moreBtn);
            }

            // 7) ê°„ë‹¨í•œ ë¡œì§€ ë¶„ì„ ìš”ì•½
            let lozeeAnalysisSummaryHTML = "<p>ì´ë‚  ëŒ€í™”ì— ëŒ€í•œ ë¡œì§€ì˜ ìƒê°ì„ ë³´ë ¤ë©´ 'ë¶„ì„ ë³´ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”! ğŸ˜Š</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = '';
                if (da.overallSentiment) {
                    tempSummary += `ì´ë‚  ëŒ€í™”ëŠ” ì „ë°˜ì ìœ¼ë¡œ '${da.overallSentiment}' ëŠë‚Œì´ì—ˆì–´ìš”. `;
                }
                if (da.keywords && da.keywords.length > 0) {
                    tempSummary += `ì£¼ìš” í‚¤ì›Œë“œ: '${da.keywords.slice(0, 2).join(', ')}' ë“±. `;
                }
                if (tempSummary.trim()) {
                    lozeeAnalysisSummaryHTML = `<p>${tempSummary.trim()}</p>`;
                }
            }
            card.insertAdjacentHTML(
                'beforeend',
                `
                <div class="session-analysis-summary">
                  <h4>âœ¨ ë¡œì§€ê°€ ì‚´í´ë³¸ ì´ì•¼ê¸° âœ¨</h4>
                  ${lozeeAnalysisSummaryHTML}
                </div>
            `
            );

            // 8) â€œì´ ë‚ ì˜ ë¶„ì„ ìì„¸íˆ ë³´ê¸°â€ ë²„íŠ¼ (detailedAnalysis ìœ ë¬´ì— ë”°ë¼ ë…¸ì¶œ)
            if (sessionData.detailedAnalysis) {
                const analysisBtn = document.createElement('button');
                analysisBtn.className = 'analysis-view-button';
                analysisBtn.textContent = 'ì´ ë‚ ì˜ ë¶„ì„ ìì„¸íˆ ë³´ê¸° ğŸ“Š';
                analysisBtn.dataset.journalid = sessionData.id;
                analysisBtn.onclick = (e) => {
                    e.preventDefault();
                    const journalId = e.currentTarget.dataset.journalid;
                    window.location.href = `analysis.html?journalId=${journalId}`;
                };
                card.appendChild(analysisBtn);
            }

            // 9) ì œëª© í´ë¦­ ì‹œ journal.htmlë¡œ ì´ë™
            const titleEl = card.querySelector('.session-title');
            if (titleEl) {
                titleEl.onclick = (e) => {
                    const journalId = e.currentTarget.dataset.journalid;
                    if (journalId) {
                        window.location.href = `journal.html?journalId=${journalId}`;
                    }
                };
            }

            return card;
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // í˜ì´ì§€ ìƒë‹¨ â€œì´ â—‹íšŒâ€, â€œë§ˆì§€ë§‰ ëŒ€í™”â€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchTopicHeaderStats() {
            if (!topicKeyFromUrl || !userId) return;
            try {
                const countQuery = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl)
                );
                const snapshot = await getCountFromServer(countQuery);
                totalJournalDocsForTopic = snapshot.data().count;

                if (totalSessionCountEl) {
                    totalSessionCountEl.textContent = `ì´ ${totalJournalDocsForTopic}íšŒ`;
                }

                if (totalJournalDocsForTopic > 0) {
                    const lastDocQuery = query(
                        collection(db, 'journals'),
                        where('userId', '==', userId),
                        where('topic', '==', topicKeyFromUrl),
                        orderBy('createdAt', 'desc'),
                        limit(1)
                    );
                    const lastSnapshot = await getDocs(lastDocQuery);
                    if (!lastSnapshot.empty) {
                        const lastData = lastSnapshot.docs[0].data();
                        const dateStr = lastData.createdAt?.toDate
                            ? lastData.createdAt.toDate().toLocaleDateString('ko-KR', {
                                  year: 'numeric',
                                  month: 'long',
                                  day: 'numeric'
                              })
                            : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                        if (lastSessionDateEl) {
                            lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ${dateStr}`;
                        }
                    }
                } else {
                    if (lastSessionDateEl) {
                        lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
                    }
                }
            } catch (error) {
                console.error(`fetchTopicHeaderStats ì˜¤ë¥˜: ${error}`);
                if (totalSessionCountEl) totalSessionCountEl.textContent = `ì´ ?íšŒ`;
                if (lastSessionDateEl) lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
            }
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // ì„¸ì…˜ ëª©ë¡ì„ Firestoreì—ì„œ ê°€ì ¸ì™€ ì¹´ë“œë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) {
            if (!userId || !topicKeyFromUrl) return;
            if (!sessionCardListEl || !topicTitleDisplayEl) return;

            if (page === 1) {
                sessionCardListEl.innerHTML = '';
                lastVisibleDocForPaging = null;
                currentPageNum = 1;
            }

            // í˜ì´ì§€ ìƒë‹¨ ì œëª© ì„¤ì • (â€œâ€œ{í† í”½}â€ ì´ì•¼ê¸° ëª¨ìŒâ€)
            if (topicTitleDisplayEl) {
                topicTitleDisplayEl.textContent = `"${topicDisplayName}" ì´ì•¼ê¸° ëª¨ìŒ`;
            }
            if (pageTabTitleEl) {
                pageTabTitleEl.textContent = `"${topicDisplayName}" ì´ì•¼ê¸° â€“ LOZEE`;
            }

            try {
                let q = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl),
                    orderBy('createdAt', 'desc'),
                    startAfter(lastDoc || null), // lastDocì´ nullì´ë©´ ì¿¼ë¦¬ ì‹œì‘ì ì—ì„œ ì‹œì‘
                    limit(ITEMS_PER_PAGE)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty && page === 1) {
                    sessionCardListEl.innerHTML =
                        '<p class="no-data-message">ì•„ì§ ì´ ì£¼ì œì— ëŒ€í•œ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”. ë¡œì§€ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ˜Š</p>';
                    if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                    return;
                }

                snapshot.forEach(doc => {
                    sessionCardListEl.appendChild(createSessionCard(doc.data()));
                });

                // ë‹¤ìŒ í˜ì´ì§€ë¥¼ ìœ„í•œ ë§ˆì§€ë§‰ ë¬¸ì„œ ì €ì¥
                lastVisibleDocForPaging = snapshot.docs[snapshot.docs.length - 1];
                updatePaginationUI(currentPageNum);

            } catch (error) {
                console.error(`'${topicKeyFromUrl}' ì£¼ì œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                sessionCardListEl.innerHTML =
                    '<p class="no-data-message">ì´ì•¼ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
            }
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // â€œì´ì „ ì´ì•¼ê¸° ë” ë³´ê¸°â€ ë²„íŠ¼ ìƒì„±/ì œì–´
        function updatePaginationUI(loadedPageNum) {
            if (!paginationControlsEl) return;
            // ì´ ë¬¸ì„œ ìˆ˜ê°€ í˜„ì¬ê¹Œì§€ ë¡œë“œëœ ë¬¸ì„œ ìˆ˜ë³´ë‹¤ ì ìœ¼ë©´ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¹€
            if (totalJournalDocsForTopic <= loadedPageNum * ITEMS_PER_PAGE) {
                paginationControlsEl.style.display = 'none';
                return;
            }
            paginationControlsEl.style.display = 'flex';

            let loadMoreBtn = document.getElementById('loadMoreBtn');
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.className = 'action-button'; // mypage action-buttonê³¼ ë™ì¼ ìŠ¤íƒ€ì¼
                paginationControlsEl.innerHTML = '';
                paginationControlsEl.appendChild(loadMoreBtn);
            }
            loadMoreBtn.textContent = 'ì´ì „ ì´ì•¼ê¸° ë” ë³´ê¸°';
            loadMoreBtn.disabled = false;
            loadMoreBtn.onclick = () => {
                currentPageNum++;
                loadSessionsForTopicPage(currentPageNum, lastVisibleDocForPaging);
            };
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // ì´ˆê¸° ë¡œì§: â€œì´ ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸°â€ ë²„íŠ¼ ì‚½ì… ë° ì²« í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Journal Topic Detail Page (journal-list2.html): DOMContentLoaded');

            if (!userId) { // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
                if (topicTitleDisplayEl) topicTitleDisplayEl.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                if (sessionCardListEl) sessionCardListEl.innerHTML = '<p class="no-data-message">ë¡œê·¸ì¸ í›„ ì´ì•¼ê¸° ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }
            if (!topicKeyFromUrl) { // URL íŒŒë¼ë¯¸í„°ë¡œ ì£¼ì œê°€ ë„˜ì–´ì˜¤ì§€ ì•Šì€ ê²½ìš°
                if (topicTitleDisplayEl) topicTitleDisplayEl.textContent = 'ì£¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                if (sessionCardListEl) sessionCardListEl.innerHTML = '<p class="no-data-message">ì„ íƒëœ ì£¼ì œê°€ ì—†ê±°ë‚˜ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }

            // â€œì´ ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸°â€ ë²„íŠ¼ ìƒì„± (í˜ì´ì§€ í—¤ë” ì•„ë˜ ì‚½ì…)
            const pageHeaderEl = document.querySelector('.page-header');
            if (pageHeaderEl) {
                const continueTopicButton = document.createElement('button');
                continueTopicButton.className = 'action-button continue-topic-button'; // âœ… í´ë˜ìŠ¤ ì¶”ê°€
                continueTopicButton.innerHTML = `"${topicDisplayName}" ì£¼ì œë¡œ ëŒ€í™” ì‹œì‘í•˜ê¸° ğŸ—£ï¸`; // âœ… ë²„íŠ¼ í…ìŠ¤íŠ¸
                continueTopicButton.onclick = async () => {
                    try {
                        const currentUserId = localStorage.getItem('lozee_userId');
                        if (!currentUserId) {
                            alert("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ ëŒ€í™”ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            return;
                        }
                        // â­ talk.html í˜ì´ì§€ë¡œ ì´ë™í•˜ë©° ì£¼ì œ ì •ë³´ ì „ë‹¬
                        window.location.href = `talk.html?topic=${encodeURIComponent(topicKeyFromUrl)}`;
                    } catch (error) {
                        console.error("ëŒ€í™” ì‹œì‘ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                        alert("ëŒ€í™” ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
                    }
                };
                // ê¸°ì¡´ 'ì´ ì£¼ì œë¡œ ìƒë‹´ ì˜ˆì•½í•˜ê¸°' ë¡œì§ ëŒ€ì‹  'ëŒ€í™” ì‹œì‘í•˜ê¸°'ë¡œ ë³€ê²½
                // pageHeaderEl.insertAdjacentElement('afterend', continueTopicButton); // ì´ ìœ„ì¹˜ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ê³¼ ê²¹ì¹  ìˆ˜ ìˆìŒ
                // í˜ì´ì§€ í—¤ë” ì•„ë˜ ìƒˆë¡œìš´ divì— ë²„íŠ¼ ì‚½ì… (ìƒˆë¡œìš´ HTML êµ¬ì¡°)
                const continueButtonContainer = document.createElement('div');
                continueButtonContainer.className = 'continue-topic-button-container'; // âœ… ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ
                continueButtonContainer.appendChild(continueTopicButton);
                // page-header ë’¤ì— ì‚½ì…
                pageHeaderEl.parentNode.insertBefore(continueButtonContainer, pageHeaderEl.nextSibling);
            }

            // ìƒë‹¨ í†µê³„ â†’ ì„¸ì…˜ ë¡œë“œ
            await fetchTopicHeaderStats();
            await loadSessionsForTopicPage(1);
         });
    </script>
</body>
</html>