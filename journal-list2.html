<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">주제별 이야기 회차 목록 - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> 
    <style>
        /* journal-list2.html 고유 스타일 */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            /* --gnb-height는 gnb.css에서 정의된 var(--gnb-height)를 사용 */
            /* 만약 gnb.css에 없다면 여기에 정의: --gnb-height: 56px; */
            --light-blue-bg: #eef2f7; 
            --action-button-bg: #6078ea; 
        }
        body {
            margin: 0;
            /* gnb.css에서 body padding-top을 관리한다고 가정 */
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        
        .page-header { 
            text-align: center; 
            margin-bottom: 15px; /* 버튼 추가로 간격 조정 */
            padding: 20px;
            background-color: var(--card-bg, #ffffff);
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .topic-display-title { 
            color: var(--primary-color, #6e8efb); 
            font-size: 1.8em; 
            font-weight: 700; 
            margin-top:0; margin-bottom: 8px;
        }
        .topic-stats-info { 
            font-size: 0.95em; 
            color: #555; 
            margin-bottom: 0px; 
        }
        .topic-stats-info span { margin: 0 10px; display: inline-block; }

        /* "이 주제로 이어 말하기" 버튼을 위한 스타일 (기존 .action-button 활용) */
        .continue-topic-button-container {
            text-align: center;
            margin-bottom: 25px; /* 카드 목록과의 간격 */
        }

        .session-card-list { display: flex; flex-direction: column; gap: 15px; margin-top:20px;}
        .session-card-wide { background-color: var(--card-bg, #ffffff); border-radius: 10px; padding: 15px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-left: 4px solid var(--secondary-color, #5a7edf); display: flex; flex-direction: column; }
        .session-card-wide:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        .session-card-wide .session-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; border-bottom: none; padding-bottom: 5px;}
        .session-card-wide .session-date { font-size: 0.85em; color: #777; font-weight:normal; }
        .session-card-wide .session-meta { font-size: 0.85em; color: var(--primary-color); font-weight: bold;}
        .session-card-wide h3 { font-size: 1.15em; color: var(--text-color); margin-top: 0; margin-bottom: 8px; font-weight: 500; }
        .session-card-wide .session-summary { font-size: 0.9em; color: #555; margin-bottom: 10px; white-space: normal; word-break:keep-all; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(0.9em * 1.5 * 3); padding-left: 0; border-left: none; cursor:pointer; /* 요약 클릭 시 확장/축소 가능 암시 */ }
        .session-card-wide .session-summary.expanded { -webkit-line-clamp: unset; max-height: none; }
        .session-card-wide .more-summary-btn { font-size: 0.85em; color: var(--primary-color); cursor: pointer; text-decoration: underline; display: block; margin-top: 5px; text-align: right;}
        .session-card-wide .session-analysis-summary { background-color: transparent; padding: 8px 0 0 0; border-radius: 0; font-size: 0.85em; margin-top: 8px; border: none; }
        .session-card-wide .session-analysis-summary h4 { font-size: 0.9em; color: var(--secondary-color); margin-bottom:3px; font-weight: bold;}
        .session-card-wide .session-analysis-summary p { margin:0; line-height:1.4; color: #666; }
        .session-card-wide .analysis-view-button { align-self: flex-end; margin-top: 10px; padding: 6px 12px; font-size: 0.85em; background-color: var(--action-button-bg); color: white; border: none; border-radius: 18px; text-decoration: none; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .session-card-wide .analysis-view-button:hover { background-color: var(--secondary-color, #5a7edf); }
        .pagination { display: flex; justify-content: center; gap: 12px; font-size: 1em; margin-top: 30px; padding-bottom:20px;}
        .pagination button { text-decoration: none; color: var(--primary-color); font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; background-color: transparent; border: 1px solid var(--primary-color); cursor: pointer;}
        .pagination button:hover { background-color: var(--secondary-color); color: white; }
        .pagination button.current { color: var(--text-color); background-color: #e0e0e0; border-color: #e0e0e0; }
        .pagination button:disabled { background-color: #eee; color: #aaa; border-color: #ddd; cursor: default;}
        .no-data-message { text-align: center; padding: 30px; background-color: var(--card-bg, #ffffff); border-radius: 12px; color: #777; font-size: 1.1em;}
        .no-data-message h2 { color: var(--primary-color, #6e8efb); font-size: 1.3em; margin-bottom: 10px;}
        .action-button { /* "이어 말하기" 버튼 등 공용 버튼 스타일 */ display: inline-block; margin-top: 15px; background-color: var(--action-button-bg); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; }
        .action-button:hover { background-color: var(--secondary-color); }

    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a> 
          <a href="index.html">✨ 새로운 이야기 시작!</a> 
          <a href="analysis.html">📊 우리 이야기 분석</a> 
          <a href="journal-list.html">📖 이야기 모음집</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a> 
        </div>
    </nav> 

     <main class="container" id="mainContainer">
        <div class="page-header">
            <!-- ① topicTitleDisplayEl: counseling_topics.js에서 정의한 “화면용 이름”으로 바뀌도록 수정 -->
            <h1 id="topicTitleDisplay" class="topic-display-title">주제 불러오는 중...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">총 0회</span> | <span id="lastSessionDate">마지막 대화: 정보 없음</span>
            </div>
        </div>
        <div class="session-card-list" id="sessionCardList"></div>
        <div class="pagination" id="paginationControls"></div>
    </main>

    <script src="./js/gnb.js" defer></script>
    <script type="module">
        import { db } from './js/firebase-config.js';
        import {
            collection,
            query,
            where,
            getDocs,
            orderBy,
            limit,
            doc,
            getDoc,
            getCountFromServer,
            startAfter
        } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // 추가로 counseling_topics.js를 import하여 “키 → 화면명” 매핑을 가져옵니다.
        import counselingTopics from './js/counseling_topics.js';

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        const paginationControlsEl = document.getElementById('paginationControls');
        const pageTabTitleEl = document.querySelector('title');
        const mainContainerEl = document.getElementById('mainContainer');

        // URL 파라미터로 넘어온 “토픽 키” (예: “family_conflict_pattern”)
        const urlParams = new URLSearchParams(window.location.search);
        const topicKeyFromUrl = urlParams.get('topic') || '';
        const userId = localStorage.getItem('cbtUserEmail');

        // 페이지당 아이템 수
        const ITEMS_PER_PAGE = 5;
        let lastVisibleDocForPaging = null;
        let currentPageNum = 1;
        let totalJournalDocsForTopic = 0;

        // ——————————————————————————————————————————————
        // 1) counseling_topics.js에서 해당 키(topicKeyFromUrl)에 대응하는 displayName(화면용 이름)을 가져오는 헬퍼
        function getDisplayNameOfTopic(topicKey) {
            // counselingTopics 객체의 구조가 { key1: [ { displayText, icon, … }, … ], key2: … } 라고 가정
            for (const categoryName in counselingTopics) {
                const arr = counselingTopics[categoryName];
                if (!Array.isArray(arr)) continue;
                // 각 배열 요소 객체 중 value(토픽 키)나 displayText가 topicKey와 동일한지 확인
                for (const opt of arr) {
                    if (opt.value === topicKey || opt.displayText === topicKey) {
                        return opt.displayText; // 화면 표시용 이름
                    }
                }
            }
            // 매핑이 없으면, 키를 그대로 반환
            return topicKey;
        }
        // 페이지에 실제로 보여줄 “화면용 이름”
        const topicDisplayName = getDisplayNameOfTopic(topicKeyFromUrl);

        // ——————————————————————————————————————————————
        // 2) 카드 생성 함수 (기존 createSessionCard)
        function createSessionCard(sessionData) {
            const card = document.createElement('div');
            card.className = 'session-card-wide';

            // (가) 날짜: Firebase timestamp → 한국어 로컬 문자열로 포맷
            const dateStr = sessionData.createdAt?.toDate
                ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      weekday: 'long'
                  })
                : '날짜 정보 없음';

            // (나) 실제 세션 제목: sessionData.title (GPT가 세션 저장 시 주는 요약 제목)
            //     필드가 없으면 “로지와의 N 번째 이야기” 형태로 기본값을 사용
            const sessionTitle = sessionData.title
                ? sessionData.title
                : `로지와의 ${sessionData.sessionNumber || '?'}번째 이야기`;

            // (다) 세션 요약(본문): sessionData.summary 필드
            const fullSummary = sessionData.summary || '요약 내용이 준비되지 않았어요.';

            // (라) 회차 표시: 총 문서 수에서 현재 페이지, index 기반으로 계산
            const sessionMetaText = `${sessionData.sessionNumber || 'N'}회차`;

            // (마) “로지가 살펴본 요약” 영역: detailedAnalysis가 있으면 감정/키워드 일부 노출
            let lozeeAnalysisSummaryHTML = "<p>이날 대화에 대한 로지의 생각을 보려면 '분석 보기'를 눌러주세요! 😊</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = '';
                if (da.overallSentiment) {
                    tempSummary += `이날 대화는 전반적으로 '${da.overallSentiment}' 느낌이었어요. `;
                }
                if (da.keywords && da.keywords.length > 0) {
                    tempSummary += `주요 키워드: '${da.keywords.slice(0, 2).join(', ')}' 등. `;
                }
                if (tempSummary.trim()) {
                    lozeeAnalysisSummaryHTML = `<p>${tempSummary.trim()}</p>`;
                }
            }

            // (바) 카드 내부 HTML 구조
            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                    <span class="session-meta">${sessionMetaText}</span>
                </div>
                <h3>${sessionTitle}</h3>
            `;

            // 요약 <p>
            const summaryParagraph = document.createElement('p');
            summaryParagraph.className = 'session-summary collapsed';
            summaryParagraph.textContent = fullSummary;
            card.appendChild(summaryParagraph);

            // 요약이 너무 길면 “더보기” 버튼 삽입
            if (fullSummary.length > 120) {
                const moreBtn = document.createElement('span');
                moreBtn.className = 'more-summary-btn';
                moreBtn.textContent = '더보기';
                moreBtn.onclick = (e) => {
                    e.stopPropagation();
                    summaryParagraph.classList.toggle('expanded');
                    moreBtn.textContent = summaryParagraph.classList.contains('expanded') ? '접기' : '더보기';
                };
                card.appendChild(moreBtn);
            }

            // 로지 분석 요약 (detailedAnalysis)
            card.insertAdjacentHTML(
                'beforeend',
                `
                <div class="session-analysis-summary">
                    <h4>✨ 로지가 살펴본 이야기 ✨</h4>
                    ${lozeAnalysisSummaryHTML}
                </div>
            `
            );

            // (사) “분석 보기” 버튼: detailedAnalysis가 있을 때만 노출
            if (sessionData.detailedAnalysis) {
                const analysisBtn = document.createElement('button');
                analysisBtn.className = 'analysis-view-button';
                analysisBtn.textContent = '이 날의 분석 자세히 보기 📊';
                analysisBtn.dataset.journalid = sessionData.id; // 클릭 시 해당 journalId를 넘기도록
                analysisBtn.onclick = (e) => {
                    window.location.href = `journal.html?journalId=${e.currentTarget.dataset.journalid}`;
                };
                card.appendChild(analysisBtn);
            }

            return card;
        }

        // ——————————————————————————————————————————————
        // 3) 페이징 UI 업데이트 함수: “더 보기” 버튼 생성
        function updatePaginationUI(loadedPageNum) {
            if (!paginationControlsEl) return;
            // 마지막 페이지(불러올 문서가 없으면) 페이징 영역 숨김
            if (totalJournalDocsForTopic <= loadedPageNum * ITEMS_PER_PAGE) {
                paginationControlsEl.style.display = 'none';
                return;
            }
            paginationControlsEl.style.display = 'flex';

            let loadMoreBtn = document.getElementById('loadMoreBtn');
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.className = 'action-button';
                paginationControlsEl.innerHTML = '';
                paginationControlsEl.appendChild(loadMoreBtn);
            }
            loadMoreBtn.textContent = '이전 이야기 더 보기';
            loadMoreBtn.disabled = false;
            loadMoreBtn.onclick = () => {
                currentPageNum++;
                loadSessionsForTopicPage(currentPageNum, lastVisibleDocForPaging);
            };
        }

        // ——————————————————————————————————————————————
        // 4) Firestore에서 ‘topic = 현재 페이지 토픽’인 문서 개수를 미리 카운트
        async function fetchTopicHeaderStats() {
            if (!topicKeyFromUrl || !userId) return;
            try {
                // 사람 수가 많을 때 getCountFromServer를 쓰면 페이징 없이 총 개수만 반환
                const countQuery = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl)
                );
                const snapshot = await getCountFromServer(countQuery);
                totalJournalDocsForTopic = snapshot.data().count;

                // 총 개수 → 페이지 헤더에 표시
                if (totalSessionCountEl) {
                    totalSessionCountEl.textContent = `총 ${totalJournalDocsForTopic}회`;
                }

                // 마지막 대화 날짜: 가장 최신 생성일 하나를 가져와서 표시
                if (totalJournalDocsForTopic > 0) {
                    const lastDocQuery = query(
                        collection(db, 'journals'),
                        where('userId', '==', userId),
                        where('topic', '==', topicKeyFromUrl),
                        orderBy('createdAt', 'desc'),
                        limit(1)
                    );
                    const lastSnapshot = await getDocs(lastDocQuery);
                    if (!lastSnapshot.empty) {
                        const lastData = lastSnapshot.docs[0].data();
                        const dateStr = lastData.createdAt?.toDate
                            ? lastData.createdAt
                                  .toDate()
                                  .toLocaleDateString('ko-KR', {
                                      year: 'numeric',
                                      month: 'long',
                                      day: 'numeric'
                                  })
                            : '날짜 정보 없음';
                        lastSessionDateEl.textContent = `마지막 대화: ${dateStr}`;
                    }
                }
            } catch (error) {
                console.error(`fetchTopicHeaderStats 오류: ${error}`);
            }
        }

        // ——————————————————————————————————————————————
        // 5) 실제 Firestore에서 페이지별로 저널 문서 가져오기
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) {
            if (!userId || !topicKeyFromUrl) {
                console.log('loadSessionsForTopicPage: userId 또는 topicKeyFromUrl 없음. 예시 데이터 표시.');
                return;
            }
            if (!sessionCardListEl || !topicTitleDisplayEl) return;

            // 첫 페이지일 때는 기존 내용 초기화
            if (page === 1) {
                sessionCardListEl.innerHTML = '';
                lastVisibleDocForPaging = null;
                currentPageNum = 1;
            }

            // (가) 페이지 헤더: “{화면용 이름} 이야기 모음”으로 표기
            if (topicTitleDisplayEl) {
                topicTitleDisplayEl.textContent = `"${topicDisplayName}" 이야기 모음`;
            }
            // (나) HTML <title> 태그도 함께 설정
            if (pageTabTitleEl) {
                pageTabTitleEl.textContent = `"${topicDisplayName}" 이야기 - LOZEE`;
            }

            try {
                let q = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl),
                    orderBy('createdAt', 'desc'),
                    limit(ITEMS_PER_PAGE)
                );
                if (page > 1 && lastDoc) {
                    q = query(q, startAfter(lastDoc));
                }

                const querySnapshot = await getDocs(q);
                console.log(
                    `journal-list2: '${topicKeyFromUrl}' 주제 쿼리 결과 size = `,
                    querySnapshot.size
                );

                // (가) 첫 페이지인데 문서가 한 건도 없으면 → “아직 대화가 없습니다” 안내문만 띄우고 리턴
                if (querySnapshot.empty && page === 1) {
                    sessionCardListEl.innerHTML =
                        `<p class="no-data-message">“${topicDisplayName}” 주제로 나눈 이야기가 아직 없어요. 대화를 시작해보세요! 😊</p>`;
                    paginationControlsEl.style.display = 'none';
                    return;
                }

                // (나) 페이지별로 세션 카드 추가
                querySnapshot.forEach((docSnap, index) => {
                    const sessionData = { id: docSnap.id, ...docSnap.data() };
                    // 회차를 “총개수 − ((현재페이지−1)×페이지당개수) − index” 방식으로 계산
                    sessionData.sessionNumber =
                        totalJournalDocsForTopic - ((page - 1) * ITEMS_PER_PAGE) - index;
                    const card = createSessionCard(sessionData);
                    sessionCardListEl.appendChild(card);
                });

                // (다) 페이징을 위해 마지막 문서 객체 저장
                if (querySnapshot.docs.length > 0) {
                    lastVisibleDocForPaging = querySnapshot.docs[querySnapshot.docs.length - 1];
                }

                // (라) 페이지 UI 업데이트
                updatePaginationUI(currentPageNum);
            } catch (error) {
                console.error(`'${topicKeyFromUrl}' 주제 로드 중 오류:`, error);
                sessionCardListEl.innerHTML =
                    '<p class="no-data-message">이야기 기록을 불러오는 중 문제가 발생했어요. 😥</p>';
                paginationControlsEl.style.display = 'none';
            }
        }

        // ——————————————————————————————————————————————
        // 6) 페이지 로드시 실행되는 초기 로직
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Journal Topic Detail Page (journal-list2.html): DOMContentLoaded');

            // “이 주제로 이어 말하기” 버튼 생성 (화면 표시용 이름을 사용)
            const pageHeaderEl = document.querySelector('.page-header');
            if (topicKeyFromUrl && userId && pageHeaderEl) {
                const continueTopicButton = document.createElement('button');
                continueTopicButton.className = 'action-button continue-topic-button-container';
                continueTopicButton.style.display = 'block';
                continueTopicButton.style.margin = '10px auto 25px auto';
                continueTopicButton.style.fontSize = '1em';
                continueTopicButton.innerHTML = `"${topicDisplayName}" 주제로 이어 말하기 🗣️`;

                continueTopicButton.onclick = () => {
                    // localStorage에 이어 말할 토픽 정보를 담아 talk.html로 이동
                    localStorage.setItem(
                        'lozee_talk_init_topic',
                        JSON.stringify({
                            type: 'continue_specific_topic',
                            details: topicKeyFromUrl,
                            prompt: `'${topicDisplayName}'에 대해 어떤 점이 더 이야기하고 싶으세요?`
                        })
                    );
                    window.location.href = 'talk.html';
                };
                pageHeaderEl.insertAdjacentElement('afterend', continueTopicButton);
            }

            // (가) Firestore에서 총 문서 개수 및 헤더 정보 가져오기
            if (topicKeyFromUrl && userId) {
                await fetchTopicHeaderStats();
                await loadSessionsForTopicPage(1);
            } else {
                // 파라미터가 비어 있으면 안내 문구만 보여줌
                if (topicTitleDisplayEl) {
                    topicTitleDisplayEl.textContent = '선택된 주제가 없습니다.';
                }
                sessionCardListEl.innerHTML =
                    '<p class="no-data-message">URL에 주제 키가 누락되었거나, 사용자 ID가 없습니다.</p>';
                paginationControlsEl.style.display = 'none';
            }
        });
    </script>
</body>
</html>