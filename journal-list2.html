<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">ì£¼ì œë³„ ì´ì•¼ê¸° íšŒì°¨ ëª©ë¡ - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> 
    <style>
        /* journal-list2.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            /* --gnb-heightëŠ” gnb.cssì—ì„œ ì •ì˜ëœ var(--gnb-height)ë¥¼ ì‚¬ìš© */
            /* ë§Œì•½ gnb.cssì— ì—†ë‹¤ë©´ ì—¬ê¸°ì— ì •ì˜: --gnb-height: 56px; */
            --light-blue-bg: #eef2f7; 
            --action-button-bg: #6078ea; 
        }
        body {
            margin: 0;
            /* gnb.cssì—ì„œ body padding-topì„ ê´€ë¦¬í•œë‹¤ê³  ê°€ì • */
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; box-sizing: border-box; }
        
        .page-header { 
            text-align: center; 
            margin-bottom: 15px; /* ë²„íŠ¼ ì¶”ê°€ë¡œ ê°„ê²© ì¡°ì • */
            padding: 20px;
            background-color: var(--card-bg, #ffffff);
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .topic-display-title { 
            color: var(--primary-color, #6e8efb); 
            font-size: 1.8em; 
            font-weight: 700; 
            margin-top:0; margin-bottom: 8px;
        }
        .topic-stats-info { 
            font-size: 0.95em; 
            color: #555; 
            margin-bottom: 0px; 
        }
        .topic-stats-info span { margin: 0 10px; display: inline-block; }

        /* "ì´ ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸°" ë²„íŠ¼ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ .action-button í™œìš©) */
        .continue-topic-button-container {
            text-align: center;
            margin-bottom: 25px; /* ì¹´ë“œ ëª©ë¡ê³¼ì˜ ê°„ê²© */
        }

        .session-card-list { display: flex; flex-direction: column; gap: 15px; margin-top:20px;}
        .session-card-wide { background-color: var(--card-bg, #ffffff); border-radius: 10px; padding: 15px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-left: 4px solid var(--secondary-color, #5a7edf); display: flex; flex-direction: column; }
        .session-card-wide:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
        .session-card-wide .session-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; border-bottom: none; padding-bottom: 5px;}
        .session-card-wide .session-date { font-size: 0.85em; color: #777; font-weight:normal; }
        .session-card-wide .session-meta { font-size: 0.85em; color: var(--primary-color); font-weight: bold;}
        .session-card-wide h3 { font-size: 1.15em; color: var(--text-color); margin-top: 0; margin-bottom: 8px; font-weight: 500; }
        .session-card-wide .session-summary { font-size: 0.9em; color: #555; margin-bottom: 10px; white-space: normal; word-break:keep-all; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(0.9em * 1.5 * 3); padding-left: 0; border-left: none; cursor:pointer; /* ìš”ì•½ í´ë¦­ ì‹œ í™•ì¥/ì¶•ì†Œ ê°€ëŠ¥ ì•”ì‹œ */ }
        .session-card-wide .session-summary.expanded { -webkit-line-clamp: unset; max-height: none; }
        .session-card-wide .more-summary-btn { font-size: 0.85em; color: var(--primary-color); cursor: pointer; text-decoration: underline; display: block; margin-top: 5px; text-align: right;}
        .session-card-wide .session-analysis-summary { background-color: transparent; padding: 8px 0 0 0; border-radius: 0; font-size: 0.85em; margin-top: 8px; border: none; }
        .session-card-wide .session-analysis-summary h4 { font-size: 0.9em; color: var(--secondary-color); margin-bottom:3px; font-weight: bold;}
        .session-card-wide .session-analysis-summary p { margin:0; line-height:1.4; color: #666; }
        .session-card-wide .analysis-view-button { align-self: flex-end; margin-top: 10px; padding: 6px 12px; font-size: 0.85em; background-color: var(--action-button-bg); color: white; border: none; border-radius: 18px; text-decoration: none; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .session-card-wide .analysis-view-button:hover { background-color: var(--secondary-color, #5a7edf); }
        .pagination { display: flex; justify-content: center; gap: 12px; font-size: 1em; margin-top: 30px; padding-bottom:20px;}
        .pagination button { text-decoration: none; color: var(--primary-color); font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; background-color: transparent; border: 1px solid var(--primary-color); cursor: pointer;}
        .pagination button:hover { background-color: var(--secondary-color); color: white; }
        .pagination button.current { color: var(--text-color); background-color: #e0e0e0; border-color: #e0e0e0; }
        .pagination button:disabled { background-color: #eee; color: #aaa; border-color: #ddd; cursor: default;}
        .no-data-message { text-align: center; padding: 30px; background-color: var(--card-bg, #ffffff); border-radius: 12px; color: #777; font-size: 1.1em;}
        .no-data-message h2 { color: var(--primary-color, #6e8efb); font-size: 1.3em; margin-bottom: 10px;}
        .action-button { /* "ì´ì–´ ë§í•˜ê¸°" ë²„íŠ¼ ë“± ê³µìš© ë²„íŠ¼ ìŠ¤íƒ€ì¼ */ display: inline-block; margin-top: 15px; background-color: var(--action-button-bg); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; }
        .action-button:hover { background-color: var(--secondary-color); }

    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

     <main class="container" id="mainContainer">
        <div class="page-header">
            <!-- â‘  topicTitleDisplayEl: counseling_topics.jsì—ì„œ ì •ì˜í•œ â€œí™”ë©´ìš© ì´ë¦„â€ìœ¼ë¡œ ë°”ë€Œë„ë¡ ìˆ˜ì • -->
            <h1 id="topicTitleDisplay" class="topic-display-title">ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">ì´ 0íšŒ</span> | <span id="lastSessionDate">ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>
        <div class="session-card-list" id="sessionCardList"></div>
        <div class="pagination" id="paginationControls"></div>
    </main>

    <script src="./js/gnb.js" defer></script>
    <script type="module">
       import { db } from './js/firebase-config.js';
        import {
            collection,
            query,
            where,
            getDocs,
            orderBy,
            limit,
            // doc, // doc was imported but not used, can be removed if not needed elsewhere
            // getDoc, // getDoc was imported but not used, can be removed if not needed elsewhere
            getCountFromServer,
            startAfter
        } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // Corrected import: Use named import for counselingTopicsByAge
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        const paginationControlsEl = document.getElementById('paginationControls');
        const pageTabTitleEl = document.querySelector('title');
        // const mainContainerEl = document.getElementById('mainContainer'); // Not used in the provided script logic

        const urlParams = new URLSearchParams(window.location.search);
        const topicKeyFromUrl = urlParams.get('topic') || ''; // This will be a displayText like "ê±°ì ˆì„ ë°›ì•„ë“¤ì´ê¸° ì–´ë ¤ì›Œ"
        const userId = localStorage.getItem('cbtUserEmail');

        const ITEMS_PER_PAGE = 5;
        let lastVisibleDocForPaging = null;
        let currentPageNum = 1;
        let totalJournalDocsForTopic = 0;

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // 1) Helper to get the displayText for a topicKey (which is itself a displayText in this case)
        //    This function now correctly iterates through the nested structure.
        function getDisplayNameOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) { // e.g., 'directUser', 'caregiver'
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) { // e.g., '10ì„¸ë¯¸ë§Œ', '11-15ì„¸'
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) { // e.g., "ê°ì • ì´ì•¼ê¸°", "ì¹œêµ¬ ì´ì•¼ê¸°"
                           const subTopicsArray = mainTopicCategories[mainTopicName];
                      // â˜… subTopicsArrayê°€ ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬ â˜…
                      if (!Array.isArray(subTopicsArray)) {
                          continue;
                      }
                      for (const subTopic of subTopicsArray) {
                          if (subTopic.displayText === topicKey) {
                              return subTopic.displayText;
                          }
                      }
                    }
                }
            }
            return topicKey;
        }

        // Use counselingTopicsByAge here
        const topicDisplayName = getDisplayNameOfTopic(topicKeyFromUrl, counselingTopicsByAge);


        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // 2) ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (createSessionCard) - No changes needed to its internal logic based on the fix
        function createSessionCard(sessionData) {
            const card = document.createElement('div');
            card.className = 'session-card-wide';

            const dateStr = sessionData.createdAt?.toDate
                ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      weekday: 'long'
                  })
                : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';

            const sessionTitle = sessionData.title
                ? sessionData.title
                : `ë¡œì§€ì™€ì˜ ${sessionData.sessionNumber || '?'}ë²ˆì§¸ ì´ì•¼ê¸°`;

            const fullSummary = sessionData.summary || 'ìš”ì•½ ë‚´ìš©ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.';
            const sessionMetaText = `${sessionData.sessionNumber || 'N'}íšŒì°¨`;

            let lozeeAnalysisSummaryHTML = "<p>ì´ë‚  ëŒ€í™”ì— ëŒ€í•œ ë¡œì§€ì˜ ìƒê°ì„ ë³´ë ¤ë©´ 'ë¶„ì„ ë³´ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”! ğŸ˜Š</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = '';
                if (da.overallSentiment) {
                    tempSummary += `ì´ë‚  ëŒ€í™”ëŠ” ì „ë°˜ì ìœ¼ë¡œ '${da.overallSentiment}' ëŠë‚Œì´ì—ˆì–´ìš”. `;
                }
                if (da.keywords && da.keywords.length > 0) {
                    tempSummary += `ì£¼ìš” í‚¤ì›Œë“œ: '${da.keywords.slice(0, 2).join(', ')}' ë“±. `;
                }
                if (tempSummary.trim()) {
                    lozeeAnalysisSummaryHTML = `<p>${tempSummary.trim()}</p>`;
                }
            }

            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                    <span class="session-meta">${sessionMetaText}</span>
                </div>
                <h3>${sessionTitle}</h3>
            `;

            const summaryParagraph = document.createElement('p');
            summaryParagraph.className = 'session-summary collapsed';
            summaryParagraph.textContent = fullSummary;
            card.appendChild(summaryParagraph);

            if (fullSummary.length > 120) { // Or some other sensible length
                const moreBtn = document.createElement('span');
                moreBtn.className = 'more-summary-btn';
                moreBtn.textContent = 'ë”ë³´ê¸°';
                moreBtn.onclick = (e) => {
                    e.stopPropagation();
                    summaryParagraph.classList.toggle('expanded');
                    moreBtn.textContent = summaryParagraph.classList.contains('expanded') ? 'ì ‘ê¸°' : 'ë”ë³´ê¸°';
                };
                card.appendChild(moreBtn);
            }

            card.insertAdjacentHTML(
                'beforeend',
                `
                <div class="session-analysis-summary">
                    <h4>âœ¨ ë¡œì§€ê°€ ì‚´í´ë³¸ ì´ì•¼ê¸° âœ¨</h4>
                    ${lozeeAnalysisSummaryHTML}
                </div>
            `
            );

            // "ë¶„ì„ ë³´ê¸°" ë²„íŠ¼: detailedAnalysisê°€ ìˆì„ ë•Œë§Œ ë…¸ì¶œ
            // This correctly links to journal.html which should display the analysis for that specific journalId
            if (sessionData.detailedAnalysis) {
                const analysisBtn = document.createElement('button');
                analysisBtn.className = 'analysis-view-button';
                analysisBtn.textContent = 'ì´ ë‚ ì˜ ë¶„ì„ ìì„¸íˆ ë³´ê¸° ğŸ“Š';
                analysisBtn.dataset.journalid = sessionData.id;
                analysisBtn.onclick = (e) => {
                    window.location.href = `journal.html?journalId=${e.currentTarget.dataset.journalid}`;
                };
                card.appendChild(analysisBtn);
            }
            return card;
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // 3) í˜ì´ì§• UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (updatePaginationUI) - No changes needed
        function updatePaginationUI(loadedPageNum) {
            if (!paginationControlsEl) return;
            if (totalJournalDocsForTopic <= loadedPageNum * ITEMS_PER_PAGE) {
                paginationControlsEl.style.display = 'none';
                return;
            }
            paginationControlsEl.style.display = 'flex';

            let loadMoreBtn = document.getElementById('loadMoreBtn');
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.className = 'action-button'; // Using existing class for styling
                paginationControlsEl.innerHTML = '';
                paginationControlsEl.appendChild(loadMoreBtn);
            }
            loadMoreBtn.textContent = 'ì´ì „ ì´ì•¼ê¸° ë” ë³´ê¸°';
            loadMoreBtn.disabled = false;
            loadMoreBtn.onclick = () => {
                currentPageNum++;
                loadSessionsForTopicPage(currentPageNum, lastVisibleDocForPaging);
            };
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // 4) Firestoreì—ì„œ â€˜topic = í˜„ì¬ í˜ì´ì§€ í† í”½â€™ì¸ ë¬¸ì„œ ê°œìˆ˜ë¥¼ ë¯¸ë¦¬ ì¹´ìš´íŠ¸ (fetchTopicHeaderStats) - No changes needed
        async function fetchTopicHeaderStats() {
            if (!topicKeyFromUrl || !userId) return;
            try {
                const countQuery = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl) // topicKeyFromUrl is the displayText
                );
                const snapshot = await getCountFromServer(countQuery);
                totalJournalDocsForTopic = snapshot.data().count;

                if (totalSessionCountEl) {
                    totalSessionCountEl.textContent = `ì´ ${totalJournalDocsForTopic}íšŒ`;
                }

                if (totalJournalDocsForTopic > 0) {
                    const lastDocQuery = query(
                        collection(db, 'journals'),
                        where('userId', '==', userId),
                        where('topic', '==', topicKeyFromUrl),
                        orderBy('createdAt', 'desc'),
                        limit(1)
                    );
                    const lastSnapshot = await getDocs(lastDocQuery);
                    if (!lastSnapshot.empty) {
                        const lastData = lastSnapshot.docs[0].data();
                        const dateStr = lastData.createdAt?.toDate
                            ? lastData.createdAt
                                  .toDate()
                                  .toLocaleDateString('ko-KR', {
                                      year: 'numeric',
                                      month: 'long',
                                      day: 'numeric'
                                  })
                            : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                        if (lastSessionDateEl) {
                            lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ${dateStr}`;
                        }
                    }
                } else {
                     if (lastSessionDateEl) {
                        lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
                     }
                }
            } catch (error) {
                console.error(`fetchTopicHeaderStats ì˜¤ë¥˜: ${error}`);
                if (totalSessionCountEl) totalSessionCountEl.textContent = `ì´ ?íšŒ`;
                if (lastSessionDateEl) lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
            }
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // 5) ì‹¤ì œ Firestoreì—ì„œ í˜ì´ì§€ë³„ë¡œ ì €ë„ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸° (loadSessionsForTopicPage) - No changes needed
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) {
            if (!userId || !topicKeyFromUrl) {
                // This case should ideally be handled by the DOMContentLoaded check earlier
                console.warn('loadSessionsForTopicPage: userId ë˜ëŠ” topicKeyFromUrl ì—†ìŒ.');
                return;
            }
            if (!sessionCardListEl || !topicTitleDisplayEl) return;

            if (page === 1) {
                sessionCardListEl.innerHTML = '';
                lastVisibleDocForPaging = null;
                currentPageNum = 1;
            }

            if (topicTitleDisplayEl) {
                topicTitleDisplayEl.textContent = `"${topicDisplayName}" ì´ì•¼ê¸° ëª¨ìŒ`;
            }
            if (pageTabTitleEl) {
                pageTabTitleEl.textContent = `"${topicDisplayName}" ì´ì•¼ê¸° - LOZEE`;
            }

            try {
                let q = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl), // Querying by the displayText
                    orderBy('createdAt', 'desc'),
                    limit(ITEMS_PER_PAGE)
                );
                if (page > 1 && lastDoc) {
                    q = query(q, startAfter(lastDoc));
                }

                const querySnapshot = await getDocs(q);
                console.log(
                    `journal-list2: '${topicKeyFromUrl}' ì£¼ì œ ì¿¼ë¦¬ ê²°ê³¼ size = `,
                    querySnapshot.size
                );

                if (querySnapshot.empty && page === 1) {
                    sessionCardListEl.innerHTML =
                        `<div class="no-data-message"><h2>â€œ${topicDisplayName}â€ ì£¼ì œë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”.</h2><p>ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ˜Š</p></div>`;
                    if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                    return;
                }

                querySnapshot.forEach((docSnap, index) => {
                    const sessionData = { id: docSnap.id, ...docSnap.data() };
                    sessionData.sessionNumber =
                        totalJournalDocsForTopic - ((page - 1) * ITEMS_PER_PAGE) - index;
                    const card = createSessionCard(sessionData);
                    sessionCardListEl.appendChild(card);
                });

                if (querySnapshot.docs.length > 0) {
                    lastVisibleDocForPaging = querySnapshot.docs[querySnapshot.docs.length - 1];
                }
                updatePaginationUI(currentPageNum);

            } catch (error) {
                console.error(`'${topicKeyFromUrl}' ì£¼ì œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                sessionCardListEl.innerHTML =
                    '<p class="no-data-message">ì´ì•¼ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
            }
        }

        // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // 6) í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸° ë¡œì§
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Journal Topic Detail Page (journal-list2.html): DOMContentLoaded');
            const pageHeaderEl = document.querySelector('.page-header');

            if (!userId || !topicKeyFromUrl) {
                if (topicTitleDisplayEl) {
                    topicTitleDisplayEl.textContent = 'ì£¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
                if (sessionCardListEl) {
                    sessionCardListEl.innerHTML =
                        '<p class="no-data-message">ì„ íƒëœ ì£¼ì œê°€ ì—†ê±°ë‚˜ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                }
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return; // Stop further execution if essential params are missing
            }
            
            // "ì´ ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸°" ë²„íŠ¼ ìƒì„±
            // topicDisplayName should be correctly resolved by getDisplayNameOfTopic at this point
            if (pageHeaderEl) { // Ensure pageHeaderEl exists
                const continueTopicButton = document.createElement('button');
                continueTopicButton.className = 'action-button'; // Use the general action-button style
                // Custom styles for this specific button if needed, or add a new class
                continueTopicButton.style.display = 'block'; 
                continueTopicButton.style.margin = '10px auto 25px auto'; // Center it
                continueTopicButton.style.fontSize = '1em';
                continueTopicButton.innerHTML = `"${topicDisplayName}" ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸° ğŸ—£ï¸`;

                continueTopicButton.onclick = () => {
                    localStorage.setItem(
                        'lozee_talk_init_topic',
                        JSON.stringify({
                            type: 'continue_specific_topic',
                            details: topicKeyFromUrl, // This is the displayText, e.g., "ê±°ì ˆì„ ë°›ì•„ë“¤ì´ê¸° ì–´ë ¤ì›Œ"
                            prompt: `'${topicDisplayName}'ì— ëŒ€í•´ ì–´ë–¤ ì ì´ ë” ì´ì•¼ê¸°í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?`
                        })
                    );
                    window.location.href = 'talk.html';
                };
                // Insert after the page-header, but before the session-card-list
                pageHeaderEl.insertAdjacentElement('afterend', continueTopicButton);
            }


            await fetchTopicHeaderStats(); // Fetch count and last date first
            await loadSessionsForTopicPage(1); // Then load the first page of sessions

        });
    </script>
</body>
</html>