<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">주제별 이야기 회차 목록 – LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <link rel="stylesheet" href="css/base.css"> <link rel="stylesheet" href="css/journal-list2.css"> </head>
<body>
 <div class="app-container">
        <nav id="gnb">
            <button id="menu-toggle">☰</button>
            <div id="gnb-title">LOZEE</div>
            <div style="width: 44px;"></div>
            <div id="dropdown-menu">
                <a href="mypage.html">🎨 내 정보 보기</a>
                <a href="index.html">✨ 새로운 이야기 시작!</a>
                <a id="gnb-analysis-link" href="analysis.html">📊 우리 이야기 분석</a>
                <a href="journal-list.html">📖 이야기 모음집</a>
                <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a>
            </div>
        </nav>

    <main class="container journal-list-detail-content-area" id="mainContainer"> <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">주제 불러오는 중...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">총 0회</span> |
                <span id="lastSessionDate">마지막 대화: 정보 없음</span>
            </div>
        </div>
        <div class="session-card-list" id="sessionCardList"></div>
        <div class="pagination" id="paginationControls"></div>
    </main>

    <script src="./js/gnb.js" defer></script>
    <script type="module">
        import { db } from './js/firebase-config.js';
        import {
            collection, query, where, getDocs, orderBy, doc, getDoc, limit,
            getCountFromServer, startAfter
        } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        // counselingTopicsByAge: “대분류 → 연령대별 서브토픽” 구조
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        //주제 예약
        import { saveReservation } from './js/firebase-utils.js';

        // ——————————————————————————————————————————————
        // [헬퍼1] “서브토픽(예: ‘엄마의 행동으로 인한 분노’) → 대분류(예: ‘감정 이야기’)”를 찾아 반환
        function findMainCategoryOfTopic(topicKey, topicsData) {
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName]; // 실제 메인 주제 객체
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return mainTopicObject.name; // 메인 주제의 name 반환
                                }
                            }
                        }
                    }
                }
            }
            return '';
        }

        // ——————————————————————————————————————————————
        // [헬퍼2] “토픽의 displayText”를 다시 돌려주는 함수 (현재는 topicKey 그대로 반환)
        function getDisplayNameOfTopic(topicKey, topicsData) {
             for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    for (const mainTopicName in mainTopicCategories) {
                        const mainTopicObject = mainTopicCategories[mainTopicName];
                        if (mainTopicObject.subTopics && Array.isArray(mainTopicObject.subTopics)) {
                            for (const subTopic of mainTopicObject.subTopics) {
                                if (subTopic.displayText === topicKey) {
                                    return subTopic.displayText;
                                }
                            }
                        }
                    }
                }
            }
            return topicKey;
        }

        const topicTitleDisplayEl   = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl   = document.getElementById('totalSessionCount');
        const lastSessionDateEl     = document.getElementById('lastSessionDate');
        const sessionCardListEl     = document.getElementById('sessionCardList');
        const paginationControlsEl  = document.getElementById('paginationControls');
        const pageTabTitleEl        = document.querySelector('title');

        const urlParams          = new URLSearchParams(window.location.search);
        const topicKeyFromUrl    = decodeURIComponent(urlParams.get('topic') || '');
        const userId = localStorage.getItem('lozee_userId');
        const userType = localStorage.getItem('lozee_userType'); // 사용자 유형 가져오기

        const ITEMS_PER_PAGE         = 5;
        let lastVisibleDocForPaging  = null;
        let currentPageNum           = 1;
        let totalJournalDocsForTopic = 0;


        // “화면용 토픽 이름” (현재는 displayText 그대로 사용)
        const topicDisplayName = getDisplayNameOfTopic(topicKeyFromUrl, counselingTopicsByAge);

        // ——————————————————————————————————————————————
        // 세션 카드 생성: “기본은 sessionData.title(로그) → 없으면 대분류 – GPT 요약” 형태로 제목 구성
        function createSessionCard(sessionData) {
            const card = document.createElement('div');
            card.className = 'session-card-wide';

            // 1) 날짜 문자열
            const dateStr = sessionData.createdAt?.toDate
                ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      weekday: 'long'
                  })
                : '날짜 정보 없음';

            // 2) GPT 요약의 첫 번째 문장만 추출
            const gptSummary = sessionData.summary
                ? sessionData.summary.split('\n')[0]
                : '요약 내용이 준비되지 않았어요.';

            // 3) 대분류(메인토픽) 찾기 (예: “감정 이야기”)
            const mainCategory = findMainCategoryOfTopic(topicKeyFromUrl, counselingTopicsByAge) || '주제';

            // 4) 최종 카드 제목:
            //    (1) sessionData.title이 있으면 “로그 기반 제목”을 우선 사용하고,
            //    (2) 없으면 “대분류 – GPT 요약 첫 문장”으로 표시
            const sessionTitle = sessionData.title && sessionData.title.trim()
                ? sessionData.title
                : `${mainCategory} – ${gptSummary}`;

            // 5) 카드 HTML 생성 (헤더: 날짜 + 제목)
            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                </div>
                <h3 class="session-title" data-journalid="${sessionData.id}">${sessionTitle}</h3>
            `;

            // 6) 세션 요약(첫 줄 요약 본문) 생성 (최대 300자까지 노출, 클릭 시 확장)
            const fullSummary = sessionData.summary || '요약 내용이 준비되지 않았어요.';
            const summaryParagraph = document.createElement('p');
            summaryParagraph.className = 'session-summary collapsed';
            summaryParagraph.textContent = fullSummary;
            card.appendChild(summaryParagraph);

            if (fullSummary.length > 300) {
                const moreBtn = document.createElement('span');
                moreBtn.className = 'more-summary-btn';
                moreBtn.textContent = '더보기';
                moreBtn.onclick = (e) => {
                    e.stopPropagation();
                    summaryParagraph.classList.toggle('expanded');
                    moreBtn.textContent = summaryParagraph.classList.contains('expanded') ? '접기' : '더보기';
                };
                card.appendChild(moreBtn);
            }

            // 7) 간단한 로지 분석 요약
            let lozeeAnalysisSummaryHTML = "<p>이날 대화에 대한 로지의 생각을 보려면 '분석 보기'를 눌러주세요! 😊</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = '';
                if (da.overallSentiment) {
                    tempSummary += `이날 대화는 전반적으로 '${da.overallSentiment}' 느낌이었어요. `;
                }
                if (da.keywords && da.keywords.length > 0) {
                    tempSummary += `주요 키워드: '${da.keywords.slice(0, 2).join(', ')}' 등. `;
                }
                if (tempSummary.trim()) {
                    lozeeAnalysisSummaryHTML = `<p>${tempSummary.trim()}</p>`;
                }
            }
            card.insertAdjacentHTML(
                'beforeend',
                `
                <div class="session-analysis-summary">
                  <h4>✨ 로지가 살펴본 이야기 ✨</h4>
                  ${lozeeAnalysisSummaryHTML}
                </div>
            `
            );

            // 8) “이 날의 분석 자세히 보기” 버튼 (detailedAnalysis 유무에 따라 노출)
            if (sessionData.detailedAnalysis) {
                const analysisBtn = document.createElement('button');
                analysisBtn.className = 'analysis-view-button';
                analysisBtn.textContent = '이 날의 분석 자세히 보기 📊';
                analysisBtn.dataset.journalid = sessionData.id;
                analysisBtn.onclick = (e) => {
                    e.preventDefault();
                    const journalId = e.currentTarget.dataset.journalid;
                    window.location.href = `analysis.html?journalId=${journalId}`;
                };
                card.appendChild(analysisBtn);
            }

            // 9) 제목 클릭 시 journal.html로 이동
            const titleEl = card.querySelector('.session-title');
            if (titleEl) {
                titleEl.onclick = (e) => {
                    const journalId = e.currentTarget.dataset.journalid;
                    if (journalId) {
                        window.location.href = `journal.html?journalId=${journalId}`;
                    }
                };
            }

            return card;
        }

        // ——————————————————————————————————————————————
        // 페이지 상단 “총 ○회”, “마지막 대화” 정보를 불러오는 함수
        async function fetchTopicHeaderStats() {
            if (!topicKeyFromUrl || !userId) return;
            try {
                const countQuery = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl)
                );
                const snapshot = await getCountFromServer(countQuery);
                totalJournalDocsForTopic = snapshot.data().count;

                if (totalSessionCountEl) {
                    totalSessionCountEl.textContent = `총 ${totalJournalDocsForTopic}회`;
                }

                if (totalJournalDocsForTopic > 0) {
                    const lastDocQuery = query(
                        collection(db, 'journals'),
                        where('userId', '==', userId),
                        where('topic', '==', topicKeyFromUrl),
                        orderBy('createdAt', 'desc'),
                        limit(1)
                    );
                    const lastSnapshot = await getDocs(lastDocQuery);
                    if (!lastSnapshot.empty) {
                        const lastData = lastSnapshot.docs[0].data();
                        const dateStr = lastData.createdAt?.toDate
                            ? lastData.createdAt.toDate().toLocaleDateString('ko-KR', {
                                  year: 'numeric',
                                  month: 'long',
                                  day: 'numeric'
                              })
                            : '날짜 정보 없음';
                        if (lastSessionDateEl) {
                            lastSessionDateEl.textContent = `마지막 대화: ${dateStr}`;
                        }
                    }
                } else {
                    if (lastSessionDateEl) {
                        lastSessionDateEl.textContent = `마지막 대화: 정보 없음`;
                    }
                }
            } catch (error) {
                console.error(`fetchTopicHeaderStats 오류: ${error}`);
                if (totalSessionCountEl) totalSessionCountEl.textContent = `총 ?회`;
                if (lastSessionDateEl) lastSessionDateEl.textContent = `마지막 대화: 정보 없음`;
            }
        }

        // ——————————————————————————————————————————————
        // 세션 목록을 Firestore에서 가져와 카드로 렌더링하는 함수
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) {
            if (!userId || !topicKeyFromUrl) return;
            if (!sessionCardListEl || !topicTitleDisplayEl) return;

            if (page === 1) {
                sessionCardListEl.innerHTML = '';
                lastVisibleDocForPaging = null;
                currentPageNum = 1;
            }

            // 페이지 상단 제목 설정 (““{토픽}” 이야기 모음”)
            if (topicTitleDisplayEl) {
                topicTitleDisplayEl.textContent = `"${topicDisplayName}" 이야기 모음`;
            }
            if (pageTabTitleEl) {
                pageTabTitleEl.textContent = `"${topicDisplayName}" 이야기 – LOZEE`;
            }

            try {
                let q = query(
                    collection(db, 'journals'),
                    where('userId', '==', userId),
                    where('topic', '==', topicKeyFromUrl),
                    orderBy('createdAt', 'desc'),
                    startAfter(lastDoc || null), // lastDoc이 null이면 쿼리 시작점에서 시작
                    limit(ITEMS_PER_PAGE)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty && page === 1) {
                    sessionCardListEl.innerHTML =
                        '<p class="no-data-message">아직 이 주제에 대한 이야기가 없어요. 로지와 대화를 시작해보세요! 😊</p>';
                    if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                    return;
                }

                snapshot.forEach(doc => {
                    sessionCardListEl.appendChild(createSessionCard(doc.data()));
                });

                // 다음 페이지를 위한 마지막 문서 저장
                lastVisibleDocForPaging = snapshot.docs[snapshot.docs.length - 1];
                updatePaginationUI(currentPageNum);

            } catch (error) {
                console.error(`'${topicKeyFromUrl}' 주제 로드 중 오류:`, error);
                sessionCardListEl.innerHTML =
                    '<p class="no-data-message">이야기 기록을 불러오는 중 문제가 발생했어요. 😥</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
            }
        }

        // ——————————————————————————————————————————————
        // “이전 이야기 더 보기” 버튼 생성/제어
        function updatePaginationUI(loadedPageNum) {
            if (!paginationControlsEl) return;
            // 총 문서 수가 현재까지 로드된 문서 수보다 적으면 더보기 버튼 숨김
            if (totalJournalDocsForTopic <= loadedPageNum * ITEMS_PER_PAGE) {
                paginationControlsEl.style.display = 'none';
                return;
            }
            paginationControlsEl.style.display = 'flex';

            let loadMoreBtn = document.getElementById('loadMoreBtn');
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.className = 'action-button'; // mypage action-button과 동일 스타일
                paginationControlsEl.innerHTML = '';
                paginationControlsEl.appendChild(loadMoreBtn);
            }
            loadMoreBtn.textContent = '이전 이야기 더 보기';
            loadMoreBtn.disabled = false;
            loadMoreBtn.onclick = () => {
                currentPageNum++;
                loadSessionsForTopicPage(currentPageNum, lastVisibleDocForPaging);
            };
        }

        // ——————————————————————————————————————————————
        // 초기 로직: “이 주제로 이어 말하기” 버튼 삽입 및 첫 페이지 로드
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Journal Topic Detail Page (journal-list2.html): DOMContentLoaded');

            if (!userId) { // 로그인 여부 확인
                if (topicTitleDisplayEl) topicTitleDisplayEl.textContent = '로그인이 필요합니다.';
                if (sessionCardListEl) sessionCardListEl.innerHTML = '<p class="no-data-message">로그인 후 이야기 기록을 확인할 수 있습니다.</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }
            if (!topicKeyFromUrl) { // URL 파라미터로 주제가 넘어오지 않은 경우
                if (topicTitleDisplayEl) topicTitleDisplayEl.textContent = '주제 정보를 불러올 수 없습니다.';
                if (sessionCardListEl) sessionCardListEl.innerHTML = '<p class="no-data-message">선택된 주제가 없거나 사용자 정보를 찾을 수 없어요. 이전 페이지로 돌아가 다시 시도해 주세요.</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }

            // “이 주제로 이어 말하기” 버튼 생성 (페이지 헤더 아래 삽입)
            const pageHeaderEl = document.querySelector('.page-header');
            if (pageHeaderEl) {
                const continueTopicButton = document.createElement('button');
                continueTopicButton.className = 'action-button continue-topic-button'; // ✅ 클래스 추가
                continueTopicButton.innerHTML = `"${topicDisplayName}" 주제로 대화 시작하기 🗣️`; // ✅ 버튼 텍스트
                continueTopicButton.onclick = async () => {
                    try {
                        const currentUserId = localStorage.getItem('lozee_userId');
                        if (!currentUserId) {
                            alert("사용자 정보가 없어 대화를 진행할 수 없습니다.");
                            return;
                        }
                        // ⭐ talk.html 페이지로 이동하며 주제 정보 전달
                        window.location.href = `talk.html?topic=${encodeURIComponent(topicKeyFromUrl)}`;
                    } catch (error) {
                        console.error("대화 시작 처리 중 오류:", error);
                        alert("대화 시작 중 오류가 발생했습니다. 개발자에게 문의해주세요.");
                    }
                };
                // 기존 '이 주제로 상담 예약하기' 로직 대신 '대화 시작하기'로 변경
                // pageHeaderEl.insertAdjacentElement('afterend', continueTopicButton); // 이 위치는 페이지네이션과 겹칠 수 있음
                // 페이지 헤더 아래 새로운 div에 버튼 삽입 (새로운 HTML 구조)
                const continueButtonContainer = document.createElement('div');
                continueButtonContainer.className = 'continue-topic-button-container'; // ✅ 새로운 컨테이너
                continueButtonContainer.appendChild(continueTopicButton);
                // page-header 뒤에 삽입
                pageHeaderEl.parentNode.insertBefore(continueButtonContainer, pageHeaderEl.nextSibling);
            }

            // 상단 통계 → 세션 로드
            await fetchTopicHeaderStats();
            await loadSessionsForTopicPage(1);
         });
    </script>
</body>
</html>