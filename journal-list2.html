<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">ì£¼ì œë³„ ì´ì•¼ê¸° íšŒì°¨ ëª©ë¡ - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* journal-list2.html ê³ ìœ  ìŠ¤íƒ€ì¼ (journal.htmlê³¼ ê±°ì˜ ë™ì¼) */
        :root { /* ... (journal.htmlê³¼ ë™ì¼í•œ ë³€ìˆ˜ ì„¤ì •) ... */ }
        body { /* ... (journal.htmlê³¼ ë™ì¼í•œ body ìŠ¤íƒ€ì¼) ... */ }
        .container { /* ... */ }
        .page-header { /* ... */ }
        .topic-display-title { /* ... */ }
        .topic-stats-info { /* ... */ }
        .session-card-list { /* ... */ }
        .session-card { /* ... */ }
        .session-header { /* ... */ }
        .session-date { /* ... */ }
        .session-card h3 { /* ... */ }
        .session-summary { /* ... */ }
        .session-analysis-summary { /* ... */ }
        .session-analysis-summary h4 { /* ... */ }
        .session-analysis-summary p { /* ... */ }
        .analysis-view-button { /* ë§¤ íšŒê¸° ë¶„ì„ ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            display: inline-block;
            background-color: var(--primary-color); /* talk.htmlì˜ .action-buttonê³¼ ìœ ì‚¬í•˜ê²Œ */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 18px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9em;
            transition: background-color 0.2s;
            margin-top: 15px;
            cursor: pointer;
            --gnb-height: 56px;

        }
        .analysis-view-button:hover { background-color: var(--secondary-color); }
        .pagination { /* ... */ }
        .no-data-message { /* ... */ }
    </style>
</head>
<body>
      <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
          <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a> 
          <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a> 
          <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a> 
          <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a> 
        </div>
    </nav> 

    <main class="container">
        <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">ì´ 0íšŒ</span> | <span id="lastSessionDate">ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>

        <div class="session-card-list" id="sessionCardList">
            </div>

        <div class="pagination" id="paginationControls" style="display:none;">
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, limit, doc, getDoc, getCountFromServer, startAfter } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        const paginationControlsEl = document.getElementById('paginationControls');
        const pageTabTitleEl = document.querySelector('title');

        const urlParams = new URLSearchParams(window.location.search);
        const currentDisplayTopic = decodeURIComponent(urlParams.get('topic') || ''); 
        const userId = localStorage.getItem('cbtUserEmail');

        const ITEMS_PER_PAGE = 5; 
        let lastVisibleDocForPaging = null; 
        let currentPageNum = 1;
        let totalJournalDocsForTopic = 0; // ì´ ì£¼ì œì— ëŒ€í•œ ì´ ì €ë„ ìˆ˜

        // --- ì˜ˆì‹œ ë°ì´í„° í‘œì‹œ í•¨ìˆ˜ ---
        function displaySampleSessionsForTopic(topicName) {
            if (!sessionCardListEl || !topicTitleDisplayEl) return;
            sessionCardListEl.innerHTML = '';
            topicTitleDisplayEl.textContent = `"${topicName}" ì´ì•¼ê¸° ëª¨ìŒ (ì˜ˆì‹œ)`;
            if(pageTabTitleEl) pageTabTitleEl.textContent = `"${topicName}" ì´ì•¼ê¸° - LOZEE`;
            if(totalSessionCountEl) totalSessionCountEl.textContent = 'ì´ 3íšŒ (ì˜ˆì‹œ)';
            if(lastSessionDateEl) lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ì´ì•¼ê¸°: ${new Date().toLocaleDateString('ko-KR')}`;

            const sampleSessions = [
                { id: "sampleS1", journalId: "sampleJ1", createdAt: { toDate: () => new Date(Date.now() - 86400000 * 5) }, title: "ì´ ì£¼ì œì— ëŒ€í•œ ì²«ë²ˆì§¸ ì´ì•¼ê¸°", summary: "ì˜¤ëŠ˜ì€ ì´ ì£¼ì œì— ëŒ€í•´ ì´ëŸ°ì €ëŸ° ìƒê°ì„ í–ˆì–´ìš”. ì²˜ìŒì—ëŠ” ì¡°ê¸ˆ ë³µì¡í–ˆì§€ë§Œ...", detailedAnalysis: { overallSentiment: "neutral", keywords: ["ìƒê°", "ê³ ë¯¼"] }, sessionNumber: 3 },
                { id: "sampleS2", journalId: "sampleJ2", createdAt: { toDate: () => new Date(Date.now() - 86400000 * 2) }, title: "ë‘ë²ˆì§¸ë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸°", summary: "ì–´ì œ ì´ì–´ì„œ ìƒê°í•´ë³´ë‹ˆ, ì´ëŸ° ë°©ë²•ë„ ìˆì„ ê²ƒ ê°™ì•„ìš”. ë¡œì§€ë‘ ì´ì•¼ê¸°í•˜ë‹ˆ ì •ë¦¬ê°€ ë˜ë„¤ìš”...", detailedAnalysis: { overallSentiment: "positive", keywords: ["ë°©ë²•", "ì •ë¦¬"] }, sessionNumber: 2 },
                { id: "sampleS3", journalId: "sampleJ3", createdAt: { toDate: () => new Date() }, title: "ì˜¤ëŠ˜ì˜ ìƒê°ê³¼ ëŠë‚Œ", summary: "ë“œë””ì–´ ì´ ì£¼ì œì— ëŒ€í•´ ë§ˆìŒì´ ì¢€ í¸í•´ì¡Œì–´ìš”! ì•ìœ¼ë¡œë„ ë¡œì§€ë‘ ìì£¼ ì´ì•¼ê¸°í•´ì•¼ê² ì–´ìš”...", detailedAnalysis: { overallSentiment: "positive", keywords: ["í•´ê²°", "í¸ì•ˆí•¨"] }, sessionNumber: 1 }
            ];
            sampleSessions.forEach(session => {
                const card = createSessionCard(session, true); // isSample = true
                sessionCardListEl.appendChild(card);
            });
            if(paginationControlsEl) paginationControlsEl.style.display = 'none';
        }
        
        // --- íšŒì°¨ë³„ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ ---
        function createSessionCard(sessionData, isSample = false) {
            const card = document.createElement('div');
            card.className = 'session-card';

            const dateStr = sessionData.createdAt?.toDate ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
            // íšŒì°¨ë³„ ì œëª©: Firestoreì˜ title í•„ë“œ ì‚¬ìš©
            const sessionTitle = sessionData.title || `ë¡œì§€ì™€ì˜ ${sessionData.sessionNumber || '?'}ë²ˆì§¸ ì´ì•¼ê¸°`; 
            const summary = sessionData.summary ? sessionData.summary.substring(0, 800) : 'ìš”ì•½ ë‚´ìš©ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.'; 
            
            let lozeeAnalysisSummaryHTML = "<p>ë¡œì§€ê°€ ì—´ì‹¬íˆ ë¶„ì„í•˜ê³  ìˆì–´ìš”! 'ë¶„ì„ ë³´ê¸°'ë¥¼ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”. ğŸ˜Š</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = "";
                if(da.overallSentiment) tempSummary += `ì´ ë‚ ì˜ ëŒ€í™”ëŠ” ì „ë°˜ì ìœ¼ë¡œ '${da.overallSentiment}' ëŠë‚Œì´ì—ˆì–´ìš”. `;
                if(da.keywords && da.keywords.length > 0) tempSummary += `ì£¼ìš” ì´ì•¼ê¸° ì¡°ê°ë“¤ì€ '${da.keywords.slice(0,1).join(', ')}'ì˜€ë„¤ìš”. `; // í‚¤ì›Œë“œ 1ê°œë§Œ
                if (tempSummary) lozeeAnalysisSummaryHTML = `<p>${tempSummary}</p>`;
            }

            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                </div>
                <h3>${sessionTitle}</h3>
                <p class="session-summary">${summary}</p>
                <div class="session-analysis-summary">
                    <h4>ë¡œì§€ ìƒê° ì—¿ë³´ê¸° ğŸ§</h4>
                    ${lozeeAnalysisSummaryHTML}
                </div>
                <button class="analysis-view-button" data-journalid="${sessionData.id || sessionData.journalId || 'sample'}">ì´ ë‚ ì˜ ë¶„ì„ ìì„¸íˆ ë³´ê¸° ğŸ“Š</button>
            `;
            
            const analysisButton = card.querySelector('.analysis-view-button');
            if (analysisButton) {
                analysisButton.onclick = (e) => {
                    e.preventDefault();
                    const journalId = e.target.dataset.journalid;
                    if (isSample || journalId === 'sample') {
                        alert("ì´ê±´ ì˜ˆì‹œ ëŒ€í™”ì˜ˆìš”! ì‹¤ì œ ë¶„ì„ì„ ë³´ë ¤ë©´ ë¡œì§€ì™€ ë¨¼ì € ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”. ğŸ˜Š");
                    } else {
                        // analysis.htmlë¡œ ì´ë™ ì‹œ í•„ìš”í•œ ëª¨ë“  ë°ì´í„°ë¥¼ localStorageì— ì €ì¥
                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            results: sessionData.detailedAnalysis || {}, 
                            accumulatedDurationMinutes: sessionData.sessionDurationMinutes || 0, // ì´ ê°’ì€ journals ë¬¸ì„œì— ìˆì–´ì•¼ í•¨
                            journalId: journalId 
                        }));
                        window.location.href = `analysis.html?journalId=${journalId}`;
                    }
                };
            }
            return card;
        }

        // --- Firestore ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤ (fetchTopicHeaderStats, loadSessionsForTopicPage, updatePaginationUI - ì´ì „ê³¼ ë™ì¼) ---
        async function fetchTopicHeaderStats() { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) { /* ... ì´ì „ê³¼ ë™ì¼, ë‹¨ querySnapshot.empty && page === 1 ì¼ ë•Œ displaySampleSessionsForTopic(currentDisplayTopic) í˜¸ì¶œ ... */ }
        function updatePaginationUI(page) { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }


        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Journal Topic Detail Page: DOMContentLoaded");
            if (currentDisplayTopic && userId) {
                await fetchTopicHeaderStats(); 
                await loadSessionsForTopicPage(1); 
            } else {
                if(topicTitleDisplayEl) topicTitleDisplayEl.textContent = "ì„ íƒëœ ì£¼ì œ ì—†ìŒ";
                console.log("ì£¼ì œ ì •ë³´ ì—†ìŒ, ì˜ˆì‹œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                displaySampleSessionsForTopic("ì˜ˆì‹œ ì£¼ì œ"); 
            }
        });
    </script>
     <script src="./js/gnb.js" defer></script> 
</body>
</html>