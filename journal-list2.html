<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">ì£¼ì œë³„ ì´ì•¼ê¸° íšŒì°¨ ëª©ë¡ â€“ LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="gnb.css">
    <style>
        /* journal-list2.html ê³ ìœ  ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #6e8efb;
            --secondary-color: #5a7edf;
            --background-color: #f4f6f8;
            --text-color: #333333;
            --card-bg: #ffffff;
            --light-blue-bg: #eef2f7;
            --action-button-bg: #6078ea;
        }
        body {
            margin: 0;
            font-family: 'KoPub World Dotum', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            /* GNBë¡œ ì¸í•œ ìƒë‹¨ íŒ¨ë”©ì€ gnb.cssì—ì„œ bodyì— ì ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥ */
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .page-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .topic-display-title {
            color: var(--primary-color);
            font-size: 1.8em;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 8px;
        }
        .topic-stats-info {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 0;
        }
        .topic-stats-info span {
            margin: 0 10px;
            display: inline-block;
        }
        .session-card-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px; /* ì´ì–´ ë§í•˜ê¸° ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
        }
        .session-card-wide {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
            display: flex;
            flex-direction: column;
        }
        .session-card-wide:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
        }
        .session-card-wide .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .session-card-wide .session-date {
            font-size: 0.85em;
            color: #777;
        }
        .session-card-wide .session-meta { /* íšŒì°¨ í‘œì‹œ */
            font-size: 0.85em;
            color: var(--primary-color);
            font-weight: bold;
        }
        .session-card-wide h3.session-title { /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ìŠ¤íƒ€ì¼ ì¡°ì • */
            font-size: 1.15em;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        .session-card-wide h3.session-title:hover {
            color: var(--primary-color);
        }
        .session-card-wide .session-summary {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
            white-space: normal;
            word-break: keep-all;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: calc(0.9em * 1.5 * 3); /* ìµœì†Œ 3ì¤„ ë†’ì´ í™•ë³´ */
            /* ìš”ì•½ ë¶€ë¶„ ìì²´ëŠ” í´ë¦­ ì´ë²¤íŠ¸ê°€ í•„ìš” ì—†ì–´ ë³´ì„. ì œëª© í´ë¦­ìœ¼ë¡œ ëŒ€ì²´ */
        }
        .session-card-wide .session-summary.expanded {
            -webkit-line-clamp: unset;
            max-height: none;
        }
        .session-card-wide .more-summary-btn {
            font-size: 0.85em;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            display: block;
            margin-top: 5px;
            text-align: right;
        }
        .session-card-wide .session-analysis-summary {
            background-color: transparent;
            padding: 8px 0 0 0;
            font-size: 0.85em;
            margin-top: 8px;
            border: none;
        }
        .session-card-wide .session-analysis-summary h4 {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-bottom:3px;
            font-weight: bold;
        }
        .session-card-wide .session-analysis-summary p {
            margin:0;
            line-height:1.4;
            color: #666;
        }
        .session-card-wide .analysis-view-button {
            align-self: flex-end;
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 0.85em;
            background-color: var(--action-button-bg);
            color: white;
            border: none;
            border-radius: 18px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .session-card-wide .analysis-view-button:hover {
            background-color: var(--secondary-color);
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 1em;
            margin-top: 30px;
            padding-bottom:20px;
        }
        .pagination button { /* a íƒœê·¸ ëŒ€ì‹  button ì‚¬ìš© */
            text-decoration: none;
            color: var(--primary-color);
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            background-color: transparent;
            border: 1px solid var(--primary-color);
            cursor: pointer;
        }
        .pagination button:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        .pagination button.current { /* í˜„ì¬ í˜ì´ì§€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (í•„ìš”ì‹œ) */
            color: var(--text-color);
            background-color: #e0e0e0;
            border-color: #e0e0e0;
        }
        .pagination button:disabled {
            background-color: #eee;
            color: #aaa;
            border-color: #ddd;
            cursor: default;
        }
        .no-data-message {
            text-align: center;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 12px;
            color: #777;
            font-size: 1.1em;
        }
        .no-data-message h2 {
            color: var(--primary-color);
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .action-button { /* "ì´ì–´ ë§í•˜ê¸°", "ë” ë³´ê¸°" ë“± ê³µìš© ë²„íŠ¼ */
            display: inline-block;
            margin-top: 15px;
            background-color: var(--action-button-bg);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .action-button:hover {
            background-color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">â˜°</button>
        <div id="dropdown-menu">
            <a href="mypage.html">ğŸ¨ ë‚´ ì •ë³´ ë³´ê¸°</a>
            <a href="index.html">âœ¨ ìƒˆë¡œìš´ ì´ì•¼ê¸° ì‹œì‘!</a>
            <a href="analysis.html">ğŸ“Š ìš°ë¦¬ ì´ì•¼ê¸° ë¶„ì„</a>
            <a href="journal-list.html">ğŸ“– ì´ì•¼ê¸° ëª¨ìŒì§‘</a>
            <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">â“ ë¡œì§€ ì‚¬ìš© ì„¤ëª…ì„œ</a>
        </div>
    </nav>

    <main class="container" id="mainContainer">
        <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">ì´ 0íšŒ</span> |
                <span id="lastSessionDate">ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ</span>
            </div>
        </div>
        <div class="session-card-list" id="sessionCardList"></div>
        <div class="pagination" id="paginationControls"></div>
    </main>

    <script src="./js/gnb.js" defer></script>
    <script type="module">
        import { db } from './js/firebase-config.js';
        import {
            collection, query, where, getDocs, orderBy, limit,
            getCountFromServer, startAfter
        } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        import { counselingTopicsByAge } from './js/counseling_topics.js';

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const topicTitleDisplayEl   = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl   = document.getElementById('totalSessionCount');
        const lastSessionDateEl     = document.getElementById('lastSessionDate');
        const sessionCardListEl     = document.getElementById('sessionCardList');
        const paginationControlsEl  = document.getElementById('paginationControls');
        const pageTabTitleEl        = document.querySelector('title');

        // --- URL íŒŒë¼ë¯¸í„° ë° ì‚¬ìš©ì ì •ë³´ ---
        const urlParams          = new URLSearchParams(window.location.search);
        const topicKeyFromUrl    = decodeURIComponent(urlParams.get('topic') || '');
        const loggedInUserId     = localStorage.getItem('lozee_userId'); // UID ì‚¬ìš©
        const currentUserType    = localStorage.getItem('lozee_userType'); // 'directUser' ë˜ëŠ” 'caregiver'

        // --- í˜ì´ì§• ë³€ìˆ˜ ---
        const ITEMS_PER_PAGE         = 5;
        let lastVisibleDocForPaging  = null;
        let currentPageNum           = 1;
        let totalJournalDocsForTopic = 0;

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function findMainCategoryOfTopic(subTopicDisplayText, topicsData) {
            if (!subTopicDisplayText || !topicsData) return '';
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                if (!ageGroups) continue;
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    if (!mainTopicCategories) continue;
                    for (const mainTopicName in mainTopicCategories) {
                        const subTopicsArray = mainTopicCategories[mainTopicName];
                        if (Array.isArray(subTopicsArray)) {
                             const found = subTopicsArray.find(st => st.displayText === subTopicDisplayText);
                             if (found) return mainTopicName;
                        }
                    }
                }
            }
            return ''; // ëª» ì°¾ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë˜ëŠ” ê¸°ë³¸ê°’
        }

        function getDisplayNameOfTopic(key, topicsData) {
            if (!key || !topicsData) return key; // í‚¤ê°€ ì—†ê±°ë‚˜ ë°ì´í„° ì—†ìœ¼ë©´ í‚¤ ë°˜í™˜
            for (const userType in topicsData) {
                const ageGroups = topicsData[userType];
                if (!ageGroups) continue;
                for (const ageGroup in ageGroups) {
                    const mainTopicCategories = ageGroups[ageGroup];
                    if (!mainTopicCategories) continue;
                    for (const mainTopicName in mainTopicCategories) {
                        const subTopicsArray = mainTopicCategories[mainTopicName];
                        if (Array.isArray(subTopicsArray)) {
                            const found = subTopicsArray.find(st => st.displayText === key || st.value === key);
                            if (found) return found.displayText;
                        }
                    }
                }
            }
            return key; // ë§¤ì¹­ë˜ëŠ” ê²ƒì´ ì—†ìœ¼ë©´ í‚¤ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜
        }

        const topicDisplayName = getDisplayNameOfTopic(topicKeyFromUrl, counselingTopicsByAge);

        // --- ì„¸ì…˜ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ ---
        function createSessionCard(sessionData) {
            const card = document.createElement('div');
            card.className = 'session-card-wide';

            const dateStr = sessionData.createdAt?.toDate
                ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', {
                      year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                  })
                : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';

            // topicKeyFromUrlì€ URLì—ì„œ ì˜¨ ì„œë¸Œí† í”½ì˜ displayText (ë˜ëŠ” value)
            // sessionData.topicì€ ì €ë„ ì €ì¥ ì‹œ ì‚¬ìš©ëœ ì„œë¸Œí† í”½ì˜ displayText
            const currentSessionTopic = sessionData.topic || topicKeyFromUrl;
            const mainCategory = findMainCategoryOfTopic(currentSessionTopic, counselingTopicsByAge) || 'ì„ íƒí•œ ì£¼ì œ';
            const gptSummaryPreview = sessionData.summary ? sessionData.summary.split('\n')[0].substring(0, 50) + (sessionData.summary.length > 50 ? "..." : "") : 'ìš”ì•½...';

            const sessionTitle = sessionData.title && sessionData.title.trim()
                ? sessionData.title
                : `${mainCategory} â€“ ${gptSummaryPreview}`;

            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                    <span class="session-meta">${sessionData.sessionNumber || '?'}íšŒì°¨</span>
                </div>
                <h3 class="session-title" data-journalid="${sessionData.id}">${sessionTitle}</h3>`;

            const fullSummary = sessionData.summary || 'ìš”ì•½ ë‚´ìš©ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.';
            const summaryParagraph = document.createElement('p');
            summaryParagraph.className = 'session-summary collapsed';
            summaryParagraph.textContent = fullSummary;
            card.appendChild(summaryParagraph);

            if (fullSummary.length > 120) {
                const moreBtn = document.createElement('span');
                moreBtn.className = 'more-summary-btn';
                moreBtn.textContent = 'ë”ë³´ê¸°';
                moreBtn.onclick = (e) => {
                    e.stopPropagation();
                    summaryParagraph.classList.toggle('expanded');
                    moreBtn.textContent = summaryParagraph.classList.contains('expanded') ? 'ì ‘ê¸°' : 'ë”ë³´ê¸°';
                };
                card.appendChild(moreBtn);
            }

            let lozeeAnalysisSummaryHTML = "<p>ì´ë‚  ëŒ€í™”ì— ëŒ€í•œ ë¡œì§€ì˜ ìƒê°ì„ ë³´ë ¤ë©´ 'ë¶„ì„ ë³´ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”! ğŸ˜Š</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = '';
                if (da.overallSentiment) {
                    tempSummary += `ì´ë‚  ëŒ€í™”ëŠ” ì „ë°˜ì ìœ¼ë¡œ '${da.overallSentiment}' ëŠë‚Œì´ì—ˆì–´ìš”. `;
                }
                if (da.keywords && da.keywords.length > 0) {
                    tempSummary += `ì£¼ìš” í‚¤ì›Œë“œ: '${da.keywords.slice(0, 2).join(', ')}' ë“±. `;
                }
                if (tempSummary.trim()) {
                    lozeeAnalysisSummaryHTML = `<p>${tempSummary.trim()}</p>`;
                }
            }
            card.insertAdjacentHTML('beforeend', `
                <div class="session-analysis-summary">
                  <h4>âœ¨ ë¡œì§€ê°€ ì‚´í´ë³¸ ì´ì•¼ê¸° âœ¨</h4>
                  ${lozeeAnalysisSummaryHTML}
                </div>`);

            if (sessionData.detailedAnalysis) {
                const analysisBtn = document.createElement('button');
                analysisBtn.className = 'analysis-view-button';
                analysisBtn.textContent = 'ì´ ë‚ ì˜ ë¶„ì„ ìì„¸íˆ ë³´ê¸° ğŸ“Š';
                analysisBtn.dataset.journalid = sessionData.id;
                analysisBtn.onclick = (e) => {
                    e.preventDefault();
                    const journalId = e.currentTarget.dataset.journalid;
                    localStorage.setItem('lozee_selected_journal_id', journalId);
                    localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                        results: sessionData.detailedAnalysis || {},
                        accumulatedDurationMinutes: sessionData.sessionDurationMinutes || 0,
                        accumulatedUserCharCount: sessionData.userCharCountForThisSession || 0,
                        journalId: journalId,
                        journalTitle: sessionTitle, // ì—¬ê¸°ì„œ ì‚¬ìš©ëœ sessionTitle
                        journalDate: sessionData.createdAt?.toDate ? sessionData.createdAt.toDate().toISOString() : null,
                        journalSummaryFull: sessionData.summary
                    }));
                     // ë‚˜ì´ì— ë”°ë¼ ë‹¤ë¥¸ ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™
                    const ageForAnalysisRedirect = parseInt(localStorage.getItem('lozee_userAge'), 10) || 0;
                    if (ageForAnalysisRedirect >= 15 && currentUserType === 'directUser') {
                        window.location.href = `analysis_adult.html?journalId=${journalId}`;
                    } else {
                        window.location.href = `analysis.html?journalId=${journalId}`;
                    }
                };
                card.appendChild(analysisBtn);
            }

            const titleEl = card.querySelector('.session-title');
            if (titleEl) {
                titleEl.onclick = (e) => {
                    const journalId = e.currentTarget.dataset.journalid;
                    if (journalId) {
                        localStorage.setItem('lozee_selected_journal_id', journalId);
                         localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            results: sessionData.detailedAnalysis || {}, // journal.htmlì—ì„œ ì‚¬ìš© ê°€ëŠ¥
                            journalId: journalId,
                            journalTitle: sessionTitle, // ì—¬ê¸°ì„œ ì‚¬ìš©ëœ sessionTitle
                            journalDate: sessionData.createdAt?.toDate ? sessionData.createdAt.toDate().toISOString() : null,
                            journalSummaryFull: sessionData.summary
                        }));
                        window.location.href = `journal.html?journalId=${journalId}`;
                    }
                };
            }
            return card;
        }

        // --- í˜ì´ì§€ ìƒë‹¨ í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸ ---
        async function fetchTopicHeaderStats() {
            if (!topicKeyFromUrl || !loggedInUserId) return;
            try {
                let countBaseQuery = query(
                    collection(db, 'journals'),
                    where('userId', '==', loggedInUserId),
                    where('topic', '==', topicKeyFromUrl) // topicKeyFromUrlì€ ì„œë¸Œí† í”½ì˜ displayText
                );
                if (currentUserType === 'caregiver') {
                    countBaseQuery = query(countBaseQuery, where("entryType", "==", "standard"));
                }
                const snapshot = await getCountFromServer(countBaseQuery);
                totalJournalDocsForTopic = snapshot.data().count;

                if (totalSessionCountEl) totalSessionCountEl.textContent = `ì´ ${totalJournalDocsForTopic}íšŒ`;

                if (totalJournalDocsForTopic > 0) {
                    let lastDocBaseQuery = query(
                        collection(db, 'journals'),
                        where('userId', '==', loggedInUserId),
                        where('topic', '==', topicKeyFromUrl)
                    );
                    if (currentUserType === 'caregiver') {
                        lastDocBaseQuery = query(lastDocBaseQuery, where("entryType", "==", "standard"));
                    }
                    const lastDocQuery = query(lastDocBaseQuery, orderBy('createdAt', 'desc'), limit(1));
                    const lastSnapshot = await getDocs(lastDocQuery);
                    if (!lastSnapshot.empty) {
                        const lastData = lastSnapshot.docs[0].data();
                        const dateStr = lastData.createdAt?.toDate
                            ? lastData.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })
                            : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                        if (lastSessionDateEl) lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ${dateStr}`;
                    }
                } else {
                    if (lastSessionDateEl) lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
                }
            } catch (error) {
                console.error(`fetchTopicHeaderStats ì˜¤ë¥˜: ${error.message}`, error);
                if (totalSessionCountEl) totalSessionCountEl.textContent = `ì´ ?íšŒ`;
                if (lastSessionDateEl) lastSessionDateEl.textContent = `ë§ˆì§€ë§‰ ëŒ€í™”: ì •ë³´ ì—†ìŒ`;
            }
        }

        // --- ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ë° í‘œì‹œ ---
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) {
            if (!loggedInUserId || !topicKeyFromUrl) {
                console.warn('loadSessionsForTopicPage: loggedInUserId ë˜ëŠ” topicKeyFromUrl ì—†ìŒ.');
                sessionCardListEl.innerHTML = '<p class="no-data-message">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ì‚¬ìš©ì ì •ë³´ë‚˜ ì£¼ì œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }
            if (!sessionCardListEl || !topicTitleDisplayEl) {
                console.warn('loadSessionsForTopicPage: í•„ìˆ˜ DOM ìš”ì†Œ ì—†ìŒ.');
                return;
            }

            if (page === 1) {
                sessionCardListEl.innerHTML = '';
                lastVisibleDocForPaging = null;
                currentPageNum = 1;
            }

            if (topicTitleDisplayEl) topicTitleDisplayEl.textContent = `"${topicDisplayName}" ì´ì•¼ê¸° ëª¨ìŒ`;
            if (pageTabTitleEl) pageTabTitleEl.textContent = `"${topicDisplayName}" ì´ì•¼ê¸° â€“ LOZEE`;

            try {
                let q = query(
                    collection(db, 'journals'),
                    where('userId', '==', loggedInUserId),
                    where('topic', '==', topicKeyFromUrl) // topicKeyFromUrlì€ ì„œë¸Œí† í”½ì˜ displayText
                );

                if (currentUserType === 'caregiver') {
                    q = query(q, where("entryType", "==", "standard"));
                    console.log("journal-list2.html: ë³´í˜¸ì ìœ í˜• - ë³¸ì¸ì˜ 'standard' ì €ë„ë§Œ ë¡œë“œí•©ë‹ˆë‹¤.");
                }

                q = query(q, orderBy('createdAt', 'desc'), limit(ITEMS_PER_PAGE));

                if (page > 1 && lastDoc) {
                    q = query(q, startAfter(lastDoc));
                }

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty && page === 1) {
                    sessionCardListEl.innerHTML =
                        `<div class="no-data-message"><h2>â€œ${topicDisplayName}â€ ì£¼ì œë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸°ê°€ ì•„ì§ ì—†ì–´ìš”.</h2><p>ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ˜Š</p></div>`;
                    if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                    return;
                }

                querySnapshot.forEach((docSnap, index) => {
                    const sessionData = { id: docSnap.id, ...docSnap.data() };
                    sessionData.sessionNumber =
                        totalJournalDocsForTopic - ((page - 1) * ITEMS_PER_PAGE) - index;
                    const card = createSessionCard(sessionData);
                    sessionCardListEl.appendChild(card);
                });

                if (querySnapshot.docs.length > 0) {
                    lastVisibleDocForPaging = querySnapshot.docs[querySnapshot.docs.length - 1];
                }
                updatePaginationUI(currentPageNum);

            } catch (error) {
                console.error(`'${topicKeyFromUrl}' ì£¼ì œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error.message, error);
                let errorMsgHtml = '<p class="no-data-message">ì´ì•¼ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥';
                if (error.message && error.message.includes("index")) {
                    const firestoreIndexLink = error.message.substring(error.message.indexOf('https://console.firebase.google.com'));
                    if (firestoreIndexLink) {
                        errorMsgHtml += `<br><span style="font-size:0.8em;">í•„ìš”í•œ Firestore ìƒ‰ì¸ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="${firestoreIndexLink}" target="_blank">ì—¬ê¸°ì—ì„œ ìƒì„±</a>í•˜ì„¸ìš”.</span>`;
                    }
                }
                errorMsgHtml += '</p>';
                sessionCardListEl.innerHTML = errorMsgHtml;
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
            }
        }

        // --- í˜ì´ì§• UI ì—…ë°ì´íŠ¸ ---
        function updatePaginationUI(loadedPageNum) {
            if (!paginationControlsEl) return;
            if (totalJournalDocsForTopic <= loadedPageNum * ITEMS_PER_PAGE) {
                paginationControlsEl.style.display = 'none';
                return;
            }
            paginationControlsEl.style.display = 'flex';

            let loadMoreBtn = document.getElementById('loadMoreBtn');
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.className = 'action-button'; // ê³µìš© ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì‚¬ìš©
                paginationControlsEl.innerHTML = '';
                paginationControlsEl.appendChild(loadMoreBtn);
            }
            loadMoreBtn.textContent = 'ì´ì „ ì´ì•¼ê¸° ë” ë³´ê¸°';
            loadMoreBtn.disabled = false;
            loadMoreBtn.onclick = () => {
                currentPageNum++;
                loadSessionsForTopicPage(currentPageNum, lastVisibleDocForPaging);
            };
        }

        // --- í˜ì´ì§€ ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Journal Topic Detail Page (journal-list2.html): DOMContentLoaded');
            // UIDì™€ topicKeyFromUrl ìœ íš¨ì„± ê²€ì‚¬ ë¨¼ì € ìˆ˜í–‰
            if (!loggedInUserId || !topicKeyFromUrl) {
                if (topicTitleDisplayEl) topicTitleDisplayEl.textContent = 'ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.';
                if (sessionCardListEl) sessionCardListEl.innerHTML = '<p class="no-data-message">ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” ì£¼ì œ ì •ë³´ê°€ ì—†ì–´ ë‚´ìš©ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
                if (paginationControlsEl) paginationControlsEl.style.display = 'none';
                return; // í•„ìˆ˜ ì •ë³´ ì—†ìœ¼ë©´ ë” ì´ìƒ ì§„í–‰ ì•ˆ í•¨
            }

            // "ì´ ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸°" ë²„íŠ¼ ìƒì„±
            const pageHeaderEl = document.querySelector('.page-header');
            if (pageHeaderEl) { // pageHeaderElì´ í™•ì‹¤íˆ ì¡´ì¬í•  ë•Œë§Œ ë²„íŠ¼ ì¶”ê°€
                const continueTopicButton = document.createElement('button');
                continueTopicButton.className = 'action-button';
                continueTopicButton.style.display = 'block';
                continueTopicButton.style.margin = '10px auto 25px auto';
                continueTopicButton.style.fontSize = '1em';
                continueTopicButton.innerHTML = `"${topicDisplayName}" ì£¼ì œë¡œ ì´ì–´ ë§í•˜ê¸° ğŸ—£ï¸`;
                continueTopicButton.onclick = () => {
                    localStorage.setItem(
                        'lozee_talk_init_topic',
                        JSON.stringify({
                            type: 'continue_specific_topic',
                            details: topicKeyFromUrl, // ì´ ê°’ì€ counseling_topics.jsì˜ displayTextì™€ ì¼ì¹˜
                            prompt: `'${topicDisplayName}'ì— ëŒ€í•´ ì–´ë–¤ ì ì´ ë” ì´ì•¼ê¸°í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?`
                        })
                    );
                    window.location.href = 'talk.html';
                };
                pageHeaderEl.insertAdjacentElement('afterend', continueTopicButton);
            } else {
                console.warn("Page-header element not found, 'ì´ì–´ ë§í•˜ê¸°' button not added.");
            }

            await fetchTopicHeaderStats();
            await loadSessionsForTopicPage(1);
        });
    </script>
</body>
</html>