<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTopicTitle">주제별 이야기 회차 목록 - LOZEE</title>
    <link href="https://fonts.googleapis.com/css2?family=KoPub+World+Dotum:wght@400;700&display=swap" rel="stylesheet"/> 
    <link rel="stylesheet" href="gnb.css"> <style>
        /* journal-list2.html 고유 스타일 (journal.html과 거의 동일) */
        :root {
            /* ... (journal.html용 변수들) ... */
            --gnb-height: 56px; /* gnb.css의 값과 일치 또는 gnb.css 변수 사용 */
        }
        body { 
            /* padding-top: var(--gnb-height); */ /* gnb.css에서 body 스타일을 관리한다면 이 줄은 주석 처리 또는 삭제 */
            /* font-family:'KoPub World Dotum', sans-serif; */ /* gnb.css에서 관리 시 주석 처리 */
            margin:0;
            background-color: #f4f6f8;
            /* ... (나머지 journal.html body 스타일) ... */ }
        
        .page-header { 
    text-align: center; 
    margin-bottom: 25px; 
    padding: 20px;
    background-color: var(--card-bg, #ffffff); /* --card-bg 변수가 없다면 기본값 사용 */
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.topic-display-title { 
    color: var(--primary-color, #6e8efb); /* --primary-color 변수 사용 */
    font-size: 1.8em; 
    font-weight: 700; 
    margin-top:0; 
    margin-bottom: 8px; /* 간격 조절 */
}
.topic-stats-info { 
    font-size: 0.95em; /* 폰트 크기 약간 키움 */
    color: #555; 
    margin-bottom: 0px; 
}
.topic-stats-info span { 
    margin: 0 10px; 
    display: inline-block; /* 줄바꿈 방지 및 간격 유지 */
}

.session-card-list { 
    display: flex; 
    flex-direction: column; 
    gap: 20px; 
    margin-top:20px; /* page-header와의 간격 */
}
.session-card { 
    background-color: var(--card-bg, #ffffff); 
    border-radius: 12px; 
    padding: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    border-left: 5px solid var(--secondary-color, #5a7edf); /* 왼쪽에 포인트 색상 추가 */
}
.session-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 12px; /* 간격 조절 */
    border-bottom:1px dashed #e0e0e0; 
    padding-bottom:10px;
}
.session-date { 
    font-size: 0.9em; 
    color: #777; 
    font-weight:bold;
}
.session-card h3 { /* 회차별 제목 (로지 요약 제목) */
    font-size: 1.25em; 
    color: var(--secondary-color, #5a7edf); 
    margin-top: 0; 
    margin-bottom: 10px; /* 요약과의 간격 */
}
.session-summary { 
    font-size: 0.95em; 
    color: #444; /* 글자색 약간 진하게 */
    margin-bottom: 15px; 
    white-space: pre-wrap; 
    word-break:keep-all; 
    max-height: 150px; 
    overflow-y:auto; 
    padding-right:5px;
    border-left: 3px solid rgba(110,142,251,0.2); /* 내부 인용구 느낌의 테두리 (선택 사항) */
    padding-left: 10px;
    line-height: 1.7; /* 줄 간격 추가 */
}
.session-analysis-summary { 
    background-color: var(--explanation-bg-analysis, #eef2f7); /* analysis.html의 .module-explanation 배경색 활용 */
    padding: 12px 15px; /* 패딩 조정 */
    border-radius: 6px; 
    font-size: 0.9em; 
    margin-top: 15px;
    border: 1px solid #dbe4f0; /* 약간의 테두리 */
}
.session-analysis-summary h4 { 
    margin-top: 0; 
    font-size: 1em; 
    color: var(--primary-color, #6e8efb); /* 제목 색상 */
    margin-bottom:8px; /* 본문과의 간격 */
}
.session-analysis-summary p {
    margin:0; 
    line-height:1.5;
    color: #555; /* 본문 글자색 */
}
.analysis-view-button { /* 매 회기 분석 보기 버튼 스타일 */
    display: inline-block;
    background-color: var(--primary-color, #6e8efb);
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 18px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9em;
    transition: background-color 0.2s;
    margin-top: 15px;
    cursor: pointer;
}
.analysis-view-button:hover { 
    background-color: var(--secondary-color, #5a7edf); 
}
        
.pagination { /* 기존 스타일 유지 또는 필요시 수정 */
    display: flex; 
    justify-content: center; 
    gap: 12px; 
    font-size: 1em; 
    margin-top: 30px; 
    padding-bottom:20px;
}

.no-data-message { /* 데이터 없을 때 메시지 스타일 (기존과 유사) */
    text-align: center;
    padding: 30px;
    background-color: var(--card-bg, #ffffff);
    border-radius: 12px;
    color: #777;
    font-size: 1.1em;
}
.no-data-message h2 { /* 메시지 내 제목 스타일 */
    color: var(--primary-color, #6e8efb);
    font-size: 1.3em;
    margin-bottom: 10px;
}
 
        



        .analysis-view-button { /* 매 회기 분석 보기 버튼 스타일 */
            display: inline-block;
            background-color: var(--primary-color); /* talk.html의 .action-button과 유사하게 */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 18px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9em;
            transition: background-color 0.2s;
            margin-top: 15px;
            cursor: pointer;
            --gnb-height: 56px;

        }

    </style>
</head>
<body>
      <nav id="gnb">
        <div id="gnb-title">LOZEE</div>
        <button id="menu-toggle">☰</button>
        <div id="dropdown-menu">
          <a href="mypage.html">🎨 내 정보 보기</a> 
          <a href="index.html">✨ 새로운 이야기 시작!</a> 
          <a href="analysis.html">📊 우리 이야기 분석</a> 
          <a href="journal-list.html">📖 이야기 모음집</a> 
          <a href="https://www.notion.so/maenglionworld/lOZEE-1ebbcdc037cd80fa9c0ddef234121e84?pvs=4" target="_blank">❓ 로지 사용 설명서</a> 
        </div>
    </nav> 

    <main class="container">
        <div class="page-header">
            <h1 id="topicTitleDisplay" class="topic-display-title">주제 불러오는 중...</h1>
            <div class="topic-stats-info">
                <span id="totalSessionCount">총 0회</span> | <span id="lastSessionDate">마지막 대화: 정보 없음</span>
            </div>
        </div>

        <div class="session-card-list" id="sessionCardList">
            </div>

        <div class="pagination" id="paginationControls" style="display:none;">
            </div>
    </main>

    <script src="./js/gnb.js" defer></script> 
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, orderBy, limit, doc, getDoc, getCountFromServer, startAfter } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

        const topicTitleDisplayEl = document.getElementById('topicTitleDisplay');
        const totalSessionCountEl = document.getElementById('totalSessionCount');
        const lastSessionDateEl = document.getElementById('lastSessionDate');
        const sessionCardListEl = document.getElementById('sessionCardList');
        const paginationControlsEl = document.getElementById('paginationControls');
        const pageTabTitleEl = document.querySelector('title');

        const urlParams = new URLSearchParams(window.location.search);
        const currentDisplayTopic = decodeURIComponent(urlParams.get('topic') || ''); 
        const userId = localStorage.getItem('cbtUserEmail');

        const ITEMS_PER_PAGE = 5; 
        let lastVisibleDocForPaging = null; 
        let currentPageNum = 1;
        let totalJournalDocsForTopic = 0; // 이 주제에 대한 총 저널 수

        // --- 예시 데이터 표시 함수 ---
        function displaySampleSessionsForTopic(topicName) {
            if (!sessionCardListEl || !topicTitleDisplayEl) return;
            sessionCardListEl.innerHTML = '';
            topicTitleDisplayEl.textContent = `"${topicName}" 이야기 모음 (예시)`;
            if(pageTabTitleEl) pageTabTitleEl.textContent = `"${topicName}" 이야기 - LOZEE`;
            if(totalSessionCountEl) totalSessionCountEl.textContent = '총 3회 (예시)';
            if(lastSessionDateEl) lastSessionDateEl.textContent = `마지막 이야기: ${new Date().toLocaleDateString('ko-KR')}`;

            const sampleSessions = [
                { id: "sampleS1", journalId: "sampleJ1", createdAt: { toDate: () => new Date(Date.now() - 86400000 * 5) }, title: "이 주제에 대한 첫번째 이야기", summary: "오늘은 이 주제에 대해 이런저런 생각을 했어요. 처음에는 조금 복잡했지만...", detailedAnalysis: { overallSentiment: "neutral", keywords: ["생각", "고민"] }, sessionNumber: 3 },
                { id: "sampleS2", journalId: "sampleJ2", createdAt: { toDate: () => new Date(Date.now() - 86400000 * 2) }, title: "두번째로 나눈 이야기", summary: "어제 이어서 생각해보니, 이런 방법도 있을 것 같아요. 로지랑 이야기하니 정리가 되네요...", detailedAnalysis: { overallSentiment: "positive", keywords: ["방법", "정리"] }, sessionNumber: 2 },
                { id: "sampleS3", journalId: "sampleJ3", createdAt: { toDate: () => new Date() }, title: "오늘의 생각과 느낌", summary: "드디어 이 주제에 대해 마음이 좀 편해졌어요! 앞으로도 로지랑 자주 이야기해야겠어요...", detailedAnalysis: { overallSentiment: "positive", keywords: ["해결", "편안함"] }, sessionNumber: 1 }
            ];
            sampleSessions.forEach(session => {
                const card = createSessionCard(session, true); // isSample = true
                sessionCardListEl.appendChild(card);
            });
            if(paginationControlsEl) paginationControlsEl.style.display = 'none';
        }
        
        // --- 회차별 카드 생성 함수 ---
        function createSessionCard(sessionData, isSample = false) {
            const card = document.createElement('div');
            card.className = 'session-card';

            const dateStr = sessionData.createdAt?.toDate ? sessionData.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'}) : '날짜 정보 없음';
            // 회차별 제목: Firestore의 title 필드 사용
            const sessionTitle = sessionData.title || `로지와의 ${sessionData.sessionNumber || '?'}번째 이야기`; 
            const summary = sessionData.summary ? sessionData.summary.substring(0, 800) : '요약 내용이 준비되지 않았어요.'; 
            
            let lozeeAnalysisSummaryHTML = "<p>로지가 열심히 분석하고 있어요! '분석 보기'를 눌러 확인하세요. 😊</p>";
            if (sessionData.detailedAnalysis) {
                const da = sessionData.detailedAnalysis;
                let tempSummary = "";
                if(da.overallSentiment) tempSummary += `이 날의 대화는 전반적으로 '${da.overallSentiment}' 느낌이었어요. `;
                if(da.keywords && da.keywords.length > 0) tempSummary += `주요 이야기 조각들은 '${da.keywords.slice(0,1).join(', ')}'였네요. `;
                if (tempSummary) lozeeAnalysisSummaryHTML = `<p>${tempSummary}</p>`;
                else if (isSample) lozeeAnalysisSummaryHTML = "<p>로지가 네 이야기를 듣고 어떤 생각을 했는지 궁금하지 않니?</p>";
            }

            card.innerHTML = `
                <div class="session-header">
                    <span class="session-date">${dateStr}</span>
                </div>
                <h3>${sessionTitle}</h3>
                <p class="session-summary">${summary}</p>
                <div class="session-analysis-summary">
                    <h4>로지 생각 엿보기 🧐</h4>
                    ${lozeeAnalysisSummaryHTML}
                </div>
                <button class="analysis-view-button" data-journalid="${sessionData.id || sessionData.journalId || 'sample'}">이 날의 분석 자세히 보기 📊</button>
            `;
            
            const analysisButton = card.querySelector('.analysis-view-button');
            if (analysisButton) {
                analysisButton.onclick = (e) => {
                    e.preventDefault();
                    const journalId = e.target.dataset.journalid;
                    if (isSample || journalId === 'sample') {
                        alert("이건 예시 대화예요! 실제 분석을 보려면 로지와 먼저 이야기를 나눠보세요. 😊");
                    } else {
                       // talk.html에서 저장한 localStorage 키와 구조를 일치시켜야 함
                        localStorage.setItem('lozee_conversation_analysis', JSON.stringify({
                            results: sessionData.detailedAnalysis || {}, 
                            accumulatedDurationMinutes: sessionData.sessionDurationMinutes || 0, 
                            journalId: journalId, // Firestore 문서 ID 전달
                            // 필요시, 이 세션의 대화 시작 시간 등도 전달
                            startTime: sessionData.createdAt?.toDate ? sessionData.createdAt.toDate().getTime() : Date.now(),
                            analysisTime: Date.now() // 분석 페이지를 여는 시점을 분석 시간으로 간주
                        }));
                        window.location.href = `analysis.html?journalId=${journalId}`;
                    }
                };
            }
            return card;
        }

        // --- Firestore 데이터 로드 함수들 (fetchTopicHeaderStats, loadSessionsForTopicPage, updatePaginationUI - 이전과 동일) ---
  async function fetchTopicHeaderStats() {
            if (!userId || !currentDisplayTopic || !totalSessionCountEl || !lastSessionDateEl) {
                console.log("fetchTopicHeaderStats: 필수 정보 부족으로 통계 로드 스킵");
                return;
            }
            try {
                const topicStatRef = doc(db, `users/${userId}/topicStats`, currentDisplayTopic);
                const topicStatSnap = await getDoc(topicStatRef);
                if (topicStatSnap.exists()) {
                    const data = topicStatSnap.data();
                    totalJournalDocsForTopic = data.count || 0;
                    if(totalSessionCountEl) totalSessionCountEl.textContent = `총 ${totalJournalDocsForTopic}회 이야기`;
                    if(lastSessionDateEl && data.lastChattedAt?.toDate) {
                        lastSessionDateEl.textContent = `마지막 이야기: ${data.lastChattedAt.toDate().toLocaleDateString('ko-KR', {month: 'long', day: 'numeric'})}`;
                    }
                } else { 
                    console.log(`'${currentDisplayTopic}'에 대한 topicStats 문서 없음, journals에서 직접 카운트 시도.`);
                    const countQuery = query(collection(db, 'journals'), where('userId', '==', userId), where('topic', '==', currentDisplayTopic));
                    const snapshot = await getCountFromServer(countQuery);
                    totalJournalDocsForTopic = snapshot.data().count;
                    if(totalSessionCountEl) totalSessionCountEl.textContent = `총 ${totalJournalDocsForTopic}회 이야기`;
                    // 마지막 대화일은 첫 페이지 로드 시 알 수 있음 (만약 저널이 있다면)
                    if (totalJournalDocsForTopic === 0 && lastSessionDateEl) {
                        lastSessionDateEl.textContent = '마지막 이야기: 기록 없음';
                    }
                }
                updatePaginationUI(currentPageNum); 
            } catch (error) { 
                console.error("주제 통계 로드 중 오류:", error);
                if(totalSessionCountEl) totalSessionCountEl.textContent = '횟수 정보 오류';
                if(lastSessionDateEl) lastSessionDateEl.textContent = '날짜 정보 오류';
            }
        }
        
        async function loadSessionsForTopicPage(page = 1, lastDoc = null) {
            if (!userId || !currentDisplayTopic || !sessionCardListEl || !topicTitleDisplayEl) {
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>정보를 불러오는 데 필요한 값이 부족해요.</p>";
                return;
            }

            if(page === 1) {
                sessionCardListEl.innerHTML = ''; // 첫 페이지 로드 시에만 목록 비우기
                lastVisibleDocForPaging = null; 
                currentPageNum = 1; // 페이지 번호 초기화
            }
            
            if(topicTitleDisplayEl) topicTitleDisplayEl.textContent = `"${currentDisplayTopic}" 이야기 모음`;
            if(pageTabTitleEl) pageTabTitleEl.textContent = `"${currentDisplayTopic}" 이야기 - LOZEE`;
            
            try {
                let q = query(
                    collection(db, 'journals'), 
                    where('userId', '==', userId),
                    where('topic', '==', currentDisplayTopic), 
                    orderBy('createdAt', 'desc'),
                    limit(ITEMS_PER_PAGE)
                );
                if (page > 1 && lastDoc) {
                    q = query(q, startAfter(lastDoc));
                }
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty && page === 1) { 
                    console.log(`'${currentDisplayTopic}' 주제에 대한 실제 저널 없음, 예시 데이터를 표시합니다.`);
                    displaySampleSessionsForTopic(currentDisplayTopic); // 주제명 전달
                    return;
                }
                if (querySnapshot.empty && page > 1) {
                     console.log("더 이상 불러올 이야기가 없습니다.");
                     const loadMoreBtn = document.getElementById('loadMoreBtn');
                     if (loadMoreBtn) { loadMoreBtn.textContent = "모든 이야기를 다 봤어요! 🎉"; loadMoreBtn.disabled = true; }
                     return;
                }

                querySnapshot.forEach((docSnap, index) => {
                    const sessionData = {id: docSnap.id, ...docSnap.data()};
                    sessionData.sessionNumber = totalJournalDocsForTopic - ((page - 1) * ITEMS_PER_PAGE) - index;
                    const card = createSessionCard(sessionData);
                    sessionCardListEl.appendChild(card);
                });

                if (querySnapshot.docs.length > 0) {
                    lastVisibleDocForPaging = querySnapshot.docs[querySnapshot.docs.length - 1];
                }
                updatePaginationUI(page); // 현재 페이지 번호로 UI 업데이트

            } catch (error) {
                console.error(`'${currentDisplayTopic}' 주제의 세션 로드 중 오류:`, error);
                sessionCardListEl.innerHTML = '<p>이야기 기록을 불러오는 데 문제가 발생했어요. 😥</p>';
            }
        }
        
        function updatePaginationUI(loadedPageNum) { 
            if (!paginationControlsEl || totalJournalDocsForTopic <= ITEMS_PER_PAGE) {
                if(paginationControlsEl) paginationControlsEl.style.display = 'none';
                return;
            }
            if(paginationControlsEl) paginationControlsEl.style.display = 'flex';
            
            // "더 보기" 버튼 방식 유지
            if (loadedPageNum * ITEMS_PER_PAGE < totalJournalDocsForTopic) {
                let loadMoreBtn = document.getElementById('loadMoreBtn');
                if (!loadMoreBtn) { // 버튼이 없으면 새로 생성
                    loadMoreBtn = document.createElement('button');
                    loadMoreBtn.id = 'loadMoreBtn';
                    loadMoreBtn.className = 'action-button'; 
                    paginationControlsEl.innerHTML = ''; // 기존 내용 비우고 버튼만 추가
                    paginationControlsEl.appendChild(loadMoreBtn);
                }
                loadMoreBtn.textContent = '이전 이야기 더 보기';
                loadMoreBtn.disabled = false;
                loadMoreBtn.onclick = () => {
                    currentPageNum++; // 다음 페이지 번호로 업데이트
                    loadSessionsForTopicPage(currentPageNum, lastVisibleDocForPaging);
                };
            } else { // 더 이상 로드할 내용이 없으면 버튼 제거 또는 비활성화
                 paginationControlsEl.innerHTML = '<p style="color:#777; font-size:0.9em;">모든 이야기를 다 봤어요! 🎉</p>';
            }
        }


        // --- 페이지 로드 시 실행 ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Journal Detail Page (journal-list2.html): DOMContentLoaded");
            if (currentDisplayTopic && userId) {
                await fetchTopicHeaderStats(); 
                await loadSessionsForTopicPage(1); 
            } else {
                if(topicTitleDisplayEl) topicTitleDisplayEl.textContent = "선택된 주제 없음";
                if(sessionCardListEl) sessionCardListEl.innerHTML = "<p>표시할 주제가 선택되지 않았어요. '이야기 모음집'에서 주제를 선택해주세요.</p>";
                console.log("주제 정보 없음, 예시 데이터를 표시합니다.");
                displaySampleSessionsForTopic("예시 주제"); 
            }
        });
    </script>
     <script src="./js/gnb.js" defer></script> 
</body>
</html>